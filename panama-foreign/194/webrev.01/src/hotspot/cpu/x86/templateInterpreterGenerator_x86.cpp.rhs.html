<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Frames src/hotspot/cpu/x86/templateInterpreterGenerator_x86.cpp</title>
    <link rel="stylesheet" href="../../../../style.css" />
    <script type="text/javascript" src="../../../../navigation.js"></script>
  </head>
<body onkeypress="keypress(event);">
<a name="0"></a>
<hr />
<pre>   1 /*
<a name="1" id="anc1"></a><span class="line-modified">   2  * Copyright (c) 2003, 2020, Oracle and/or its affiliates. All rights reserved.</span>
   3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   4  *
   5  * This code is free software; you can redistribute it and/or modify it
   6  * under the terms of the GNU General Public License version 2 only, as
   7  * published by the Free Software Foundation.
   8  *
   9  * This code is distributed in the hope that it will be useful, but WITHOUT
  10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
  11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
  12  * version 2 for more details (a copy is included in the LICENSE file that
  13  * accompanied this code).
  14  *
  15  * You should have received a copy of the GNU General Public License version
  16  * 2 along with this work; if not, write to the Free Software Foundation,
  17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
  18  *
  19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
  20  * or visit www.oracle.com if you need additional information or have any
  21  * questions.
  22  *
  23  */
  24 
  25 #include &quot;precompiled.hpp&quot;
  26 #include &quot;asm/macroAssembler.hpp&quot;
  27 #include &quot;compiler/disassembler.hpp&quot;
  28 #include &quot;gc/shared/barrierSetAssembler.hpp&quot;
  29 #include &quot;interpreter/bytecodeHistogram.hpp&quot;
  30 #include &quot;interpreter/interp_masm.hpp&quot;
  31 #include &quot;interpreter/interpreter.hpp&quot;
  32 #include &quot;interpreter/interpreterRuntime.hpp&quot;
  33 #include &quot;interpreter/templateInterpreterGenerator.hpp&quot;
  34 #include &quot;interpreter/templateTable.hpp&quot;
  35 #include &quot;oops/arrayOop.hpp&quot;
  36 #include &quot;oops/methodData.hpp&quot;
  37 #include &quot;oops/method.hpp&quot;
  38 #include &quot;oops/oop.inline.hpp&quot;
  39 #include &quot;prims/jvmtiExport.hpp&quot;
  40 #include &quot;prims/jvmtiThreadState.hpp&quot;
  41 #include &quot;runtime/arguments.hpp&quot;
  42 #include &quot;runtime/deoptimization.hpp&quot;
  43 #include &quot;runtime/frame.inline.hpp&quot;
  44 #include &quot;runtime/sharedRuntime.hpp&quot;
  45 #include &quot;runtime/stubRoutines.hpp&quot;
  46 #include &quot;runtime/synchronizer.hpp&quot;
  47 #include &quot;runtime/timer.hpp&quot;
  48 #include &quot;runtime/vframeArray.hpp&quot;
  49 #include &quot;utilities/debug.hpp&quot;
  50 #include &quot;utilities/macros.hpp&quot;
  51 
  52 #define __ Disassembler::hook&lt;InterpreterMacroAssembler&gt;(__FILE__, __LINE__, _masm)-&gt;
  53 
  54 // Size of interpreter code.  Increase if too small.  Interpreter will
  55 // fail with a guarantee (&quot;not enough space for interpreter generation&quot;);
  56 // if too small.
  57 // Run with +PrintInterpreter to get the VM to print out the size.
  58 // Max size with JVMTI
  59 #ifdef AMD64
  60 int TemplateInterpreter::InterpreterCodeSize = JVMCI_ONLY(268) NOT_JVMCI(256) * 1024;
  61 #else
  62 int TemplateInterpreter::InterpreterCodeSize = 224 * 1024;
  63 #endif // AMD64
  64 
  65 // Global Register Names
  66 static const Register rbcp     = LP64_ONLY(r13) NOT_LP64(rsi);
  67 static const Register rlocals  = LP64_ONLY(r14) NOT_LP64(rdi);
  68 
  69 const int method_offset = frame::interpreter_frame_method_offset * wordSize;
  70 const int bcp_offset    = frame::interpreter_frame_bcp_offset    * wordSize;
  71 const int locals_offset = frame::interpreter_frame_locals_offset * wordSize;
  72 
  73 
  74 //-----------------------------------------------------------------------------
  75 
  76 address TemplateInterpreterGenerator::generate_StackOverflowError_handler() {
  77   address entry = __ pc();
  78 
  79 #ifdef ASSERT
  80   {
  81     Label L;
  82     __ lea(rax, Address(rbp,
  83                         frame::interpreter_frame_monitor_block_top_offset *
  84                         wordSize));
  85     __ cmpptr(rax, rsp); // rax = maximal rsp for current rbp (stack
  86                          // grows negative)
  87     __ jcc(Assembler::aboveEqual, L); // check if frame is complete
  88     __ stop (&quot;interpreter frame not set up&quot;);
  89     __ bind(L);
  90   }
  91 #endif // ASSERT
  92   // Restore bcp under the assumption that the current frame is still
  93   // interpreted
  94   __ restore_bcp();
  95 
  96   // expression stack must be empty before entering the VM if an
  97   // exception happened
  98   __ empty_expression_stack();
  99   // throw exception
 100   __ call_VM(noreg,
 101              CAST_FROM_FN_PTR(address,
 102                               InterpreterRuntime::throw_StackOverflowError));
 103   return entry;
 104 }
 105 
 106 address TemplateInterpreterGenerator::generate_ArrayIndexOutOfBounds_handler() {
 107   address entry = __ pc();
 108   // The expression stack must be empty before entering the VM if an
 109   // exception happened.
 110   __ empty_expression_stack();
 111 
 112   // Setup parameters.
 113   // ??? convention: expect aberrant index in register ebx/rbx.
 114   // Pass array to create more detailed exceptions.
 115   Register rarg = NOT_LP64(rax) LP64_ONLY(c_rarg1);
 116   __ call_VM(noreg,
 117              CAST_FROM_FN_PTR(address,
 118                               InterpreterRuntime::
 119                               throw_ArrayIndexOutOfBoundsException),
 120              rarg, rbx);
 121   return entry;
 122 }
 123 
 124 address TemplateInterpreterGenerator::generate_ClassCastException_handler() {
 125   address entry = __ pc();
 126 
 127   // object is at TOS
 128   Register rarg = NOT_LP64(rax) LP64_ONLY(c_rarg1);
 129   __ pop(rarg);
 130 
 131   // expression stack must be empty before entering the VM if an
 132   // exception happened
 133   __ empty_expression_stack();
 134 
 135   __ call_VM(noreg,
 136              CAST_FROM_FN_PTR(address,
 137                               InterpreterRuntime::
 138                               throw_ClassCastException),
 139              rarg);
 140   return entry;
 141 }
 142 
 143 address TemplateInterpreterGenerator::generate_exception_handler_common(
 144         const char* name, const char* message, bool pass_oop) {
 145   assert(!pass_oop || message == NULL, &quot;either oop or message but not both&quot;);
 146   address entry = __ pc();
 147 
 148   Register rarg = NOT_LP64(rax) LP64_ONLY(c_rarg1);
 149   Register rarg2 = NOT_LP64(rbx) LP64_ONLY(c_rarg2);
 150 
 151   if (pass_oop) {
 152     // object is at TOS
 153     __ pop(rarg2);
 154   }
 155   // expression stack must be empty before entering the VM if an
 156   // exception happened
 157   __ empty_expression_stack();
 158   // setup parameters
 159   __ lea(rarg, ExternalAddress((address)name));
 160   if (pass_oop) {
 161     __ call_VM(rax, CAST_FROM_FN_PTR(address,
 162                                      InterpreterRuntime::
 163                                      create_klass_exception),
 164                rarg, rarg2);
 165   } else {
 166     __ lea(rarg2, ExternalAddress((address)message));
 167     __ call_VM(rax,
 168                CAST_FROM_FN_PTR(address, InterpreterRuntime::create_exception),
 169                rarg, rarg2);
 170   }
 171   // throw exception
 172   __ jump(ExternalAddress(Interpreter::throw_exception_entry()));
 173   return entry;
 174 }
 175 
 176 address TemplateInterpreterGenerator::generate_return_entry_for(TosState state, int step, size_t index_size) {
 177   address entry = __ pc();
 178 
 179 #ifndef _LP64
 180 #ifdef COMPILER2
 181   // The FPU stack is clean if UseSSE &gt;= 2 but must be cleaned in other cases
 182   if ((state == ftos &amp;&amp; UseSSE &lt; 1) || (state == dtos &amp;&amp; UseSSE &lt; 2)) {
 183     for (int i = 1; i &lt; 8; i++) {
 184         __ ffree(i);
 185     }
 186   } else if (UseSSE &lt; 2) {
 187     __ empty_FPU_stack();
 188   }
 189 #endif // COMPILER2
 190   if ((state == ftos &amp;&amp; UseSSE &lt; 1) || (state == dtos &amp;&amp; UseSSE &lt; 2)) {
 191     __ MacroAssembler::verify_FPU(1, &quot;generate_return_entry_for compiled&quot;);
 192   } else {
 193     __ MacroAssembler::verify_FPU(0, &quot;generate_return_entry_for compiled&quot;);
 194   }
 195 
 196   if (state == ftos) {
 197     __ MacroAssembler::verify_FPU(UseSSE &gt;= 1 ? 0 : 1, &quot;generate_return_entry_for in interpreter&quot;);
 198   } else if (state == dtos) {
 199     __ MacroAssembler::verify_FPU(UseSSE &gt;= 2 ? 0 : 1, &quot;generate_return_entry_for in interpreter&quot;);
 200   }
 201 #endif // _LP64
 202 
 203   // Restore stack bottom in case i2c adjusted stack
 204   __ movptr(rsp, Address(rbp, frame::interpreter_frame_last_sp_offset * wordSize));
 205   // and NULL it as marker that esp is now tos until next java call
 206   __ movptr(Address(rbp, frame::interpreter_frame_last_sp_offset * wordSize), (int32_t)NULL_WORD);
 207 
 208   __ restore_bcp();
 209   __ restore_locals();
 210 
 211   if (state == atos) {
 212     Register mdp = rbx;
 213     Register tmp = rcx;
 214     __ profile_return_type(mdp, rax, tmp);
 215   }
 216 
 217   const Register cache = rbx;
 218   const Register index = rcx;
 219   __ get_cache_and_index_at_bcp(cache, index, 1, index_size);
 220 
 221   const Register flags = cache;
 222   __ movl(flags, Address(cache, index, Address::times_ptr, ConstantPoolCache::base_offset() + ConstantPoolCacheEntry::flags_offset()));
 223   __ andl(flags, ConstantPoolCacheEntry::parameter_size_mask);
 224   __ lea(rsp, Address(rsp, flags, Interpreter::stackElementScale()));
 225 
 226    const Register java_thread = NOT_LP64(rcx) LP64_ONLY(r15_thread);
 227    if (JvmtiExport::can_pop_frame()) {
 228      NOT_LP64(__ get_thread(java_thread));
 229      __ check_and_handle_popframe(java_thread);
 230    }
 231    if (JvmtiExport::can_force_early_return()) {
 232      NOT_LP64(__ get_thread(java_thread));
 233      __ check_and_handle_earlyret(java_thread);
 234    }
 235 
 236   __ dispatch_next(state, step);
 237 
 238   return entry;
 239 }
 240 
 241 
 242 address TemplateInterpreterGenerator::generate_deopt_entry_for(TosState state, int step, address continuation) {
 243   address entry = __ pc();
 244 
 245 #ifndef _LP64
 246   if (state == ftos) {
 247     __ MacroAssembler::verify_FPU(UseSSE &gt;= 1 ? 0 : 1, &quot;generate_deopt_entry_for in interpreter&quot;);
 248   } else if (state == dtos) {
 249     __ MacroAssembler::verify_FPU(UseSSE &gt;= 2 ? 0 : 1, &quot;generate_deopt_entry_for in interpreter&quot;);
 250   }
 251 #endif // _LP64
 252 
 253   // NULL last_sp until next java call
 254   __ movptr(Address(rbp, frame::interpreter_frame_last_sp_offset * wordSize), (int32_t)NULL_WORD);
 255   __ restore_bcp();
 256   __ restore_locals();
 257   const Register thread = NOT_LP64(rcx) LP64_ONLY(r15_thread);
 258   NOT_LP64(__ get_thread(thread));
 259 #if INCLUDE_JVMCI
 260   // Check if we need to take lock at entry of synchronized method.  This can
 261   // only occur on method entry so emit it only for vtos with step 0.
 262   if ((EnableJVMCI || UseAOT) &amp;&amp; state == vtos &amp;&amp; step == 0) {
 263     Label L;
 264     __ cmpb(Address(thread, JavaThread::pending_monitorenter_offset()), 0);
 265     __ jcc(Assembler::zero, L);
 266     // Clear flag.
 267     __ movb(Address(thread, JavaThread::pending_monitorenter_offset()), 0);
 268     // Satisfy calling convention for lock_method().
 269     __ get_method(rbx);
 270     // Take lock.
 271     lock_method();
 272     __ bind(L);
 273   } else {
 274 #ifdef ASSERT
 275     if (EnableJVMCI) {
 276       Label L;
 277       __ cmpb(Address(r15_thread, JavaThread::pending_monitorenter_offset()), 0);
 278       __ jcc(Assembler::zero, L);
 279       __ stop(&quot;unexpected pending monitor in deopt entry&quot;);
 280       __ bind(L);
 281     }
 282 #endif
 283   }
 284 #endif
 285   // handle exceptions
 286   {
 287     Label L;
 288     __ cmpptr(Address(thread, Thread::pending_exception_offset()), (int32_t) NULL_WORD);
 289     __ jcc(Assembler::zero, L);
 290     __ call_VM(noreg,
 291                CAST_FROM_FN_PTR(address,
 292                                 InterpreterRuntime::throw_pending_exception));
 293     __ should_not_reach_here();
 294     __ bind(L);
 295   }
 296   if (continuation == NULL) {
 297     __ dispatch_next(state, step);
 298   } else {
 299     __ jump_to_entry(continuation);
 300   }
 301   return entry;
 302 }
 303 
 304 address TemplateInterpreterGenerator::generate_result_handler_for(
 305         BasicType type) {
 306   address entry = __ pc();
 307   switch (type) {
 308   case T_BOOLEAN: __ c2bool(rax);            break;
 309 #ifndef _LP64
 310   case T_CHAR   : __ andptr(rax, 0xFFFF);    break;
 311 #else
 312   case T_CHAR   : __ movzwl(rax, rax);       break;
 313 #endif // _LP64
 314   case T_BYTE   : __ sign_extend_byte(rax);  break;
 315   case T_SHORT  : __ sign_extend_short(rax); break;
 316   case T_INT    : /* nothing to do */        break;
 317   case T_LONG   : /* nothing to do */        break;
 318   case T_VOID   : /* nothing to do */        break;
 319 #ifndef _LP64
 320   case T_DOUBLE :
 321   case T_FLOAT  :
 322     { const Register t = InterpreterRuntime::SignatureHandlerGenerator::temp();
 323       __ pop(t);                            // remove return address first
 324       // Must return a result for interpreter or compiler. In SSE
 325       // mode, results are returned in xmm0 and the FPU stack must
 326       // be empty.
 327       if (type == T_FLOAT &amp;&amp; UseSSE &gt;= 1) {
 328         // Load ST0
 329         __ fld_d(Address(rsp, 0));
 330         // Store as float and empty fpu stack
 331         __ fstp_s(Address(rsp, 0));
 332         // and reload
 333         __ movflt(xmm0, Address(rsp, 0));
 334       } else if (type == T_DOUBLE &amp;&amp; UseSSE &gt;= 2 ) {
 335         __ movdbl(xmm0, Address(rsp, 0));
 336       } else {
 337         // restore ST0
 338         __ fld_d(Address(rsp, 0));
 339       }
 340       // and pop the temp
 341       __ addptr(rsp, 2 * wordSize);
 342       __ push(t);                           // restore return address
 343     }
 344     break;
 345 #else
 346   case T_FLOAT  : /* nothing to do */        break;
 347   case T_DOUBLE : /* nothing to do */        break;
 348 #endif // _LP64
 349 
 350   case T_OBJECT :
 351     // retrieve result from frame
 352     __ movptr(rax, Address(rbp, frame::interpreter_frame_oop_temp_offset*wordSize));
 353     // and verify it
 354     __ verify_oop(rax);
 355     break;
 356   default       : ShouldNotReachHere();
 357   }
 358   __ ret(0);                                   // return from result handler
 359   return entry;
 360 }
 361 
 362 address TemplateInterpreterGenerator::generate_safept_entry_for(
 363         TosState state,
 364         address runtime_entry) {
 365   address entry = __ pc();
 366   __ push(state);
 367   __ call_VM(noreg, runtime_entry);
 368   __ dispatch_via(vtos, Interpreter::_normal_table.table_for(vtos));
 369   return entry;
 370 }
 371 
 372 
 373 
 374 // Helpers for commoning out cases in the various type of method entries.
 375 //
 376 
 377 
 378 // increment invocation count &amp; check for overflow
 379 //
 380 // Note: checking for negative value instead of overflow
 381 //       so we have a &#39;sticky&#39; overflow test
 382 //
 383 // rbx: method
 384 // rcx: invocation counter
 385 //
 386 void TemplateInterpreterGenerator::generate_counter_incr(
 387         Label* overflow,
 388         Label* profile_method,
 389         Label* profile_method_continue) {
 390   Label done;
 391   // Note: In tiered we increment either counters in Method* or in MDO depending if we&#39;re profiling or not.
 392   if (TieredCompilation) {
 393     int increment = InvocationCounter::count_increment;
 394     Label no_mdo;
 395     if (ProfileInterpreter) {
 396       // Are we profiling?
 397       __ movptr(rax, Address(rbx, Method::method_data_offset()));
 398       __ testptr(rax, rax);
 399       __ jccb(Assembler::zero, no_mdo);
 400       // Increment counter in the MDO
 401       const Address mdo_invocation_counter(rax, in_bytes(MethodData::invocation_counter_offset()) +
 402                                                 in_bytes(InvocationCounter::counter_offset()));
 403       const Address mask(rax, in_bytes(MethodData::invoke_mask_offset()));
 404       __ increment_mask_and_jump(mdo_invocation_counter, increment, mask, rcx, false, Assembler::zero, overflow);
 405       __ jmp(done);
 406     }
 407     __ bind(no_mdo);
 408     // Increment counter in MethodCounters
 409     const Address invocation_counter(rax,
 410                   MethodCounters::invocation_counter_offset() +
 411                   InvocationCounter::counter_offset());
 412     __ get_method_counters(rbx, rax, done);
 413     const Address mask(rax, in_bytes(MethodCounters::invoke_mask_offset()));
 414     __ increment_mask_and_jump(invocation_counter, increment, mask, rcx,
 415                                false, Assembler::zero, overflow);
 416     __ bind(done);
 417   } else { // not TieredCompilation
 418     const Address backedge_counter(rax,
 419                   MethodCounters::backedge_counter_offset() +
 420                   InvocationCounter::counter_offset());
 421     const Address invocation_counter(rax,
 422                   MethodCounters::invocation_counter_offset() +
 423                   InvocationCounter::counter_offset());
 424 
 425     __ get_method_counters(rbx, rax, done);
 426 
 427     if (ProfileInterpreter) {
 428       __ incrementl(Address(rax,
 429               MethodCounters::interpreter_invocation_counter_offset()));
 430     }
 431     // Update standard invocation counters
 432     __ movl(rcx, invocation_counter);
 433     __ incrementl(rcx, InvocationCounter::count_increment);
 434     __ movl(invocation_counter, rcx); // save invocation count
 435 
 436     __ movl(rax, backedge_counter);   // load backedge counter
 437     __ andl(rax, InvocationCounter::count_mask_value); // mask out the status bits
 438 
 439     __ addl(rcx, rax);                // add both counters
 440 
 441     // profile_method is non-null only for interpreted method so
 442     // profile_method != NULL == !native_call
 443 
 444     if (ProfileInterpreter &amp;&amp; profile_method != NULL) {
 445       // Test to see if we should create a method data oop
 446       __ movptr(rax, Address(rbx, Method::method_counters_offset()));
 447       __ cmp32(rcx, Address(rax, in_bytes(MethodCounters::interpreter_profile_limit_offset())));
 448       __ jcc(Assembler::less, *profile_method_continue);
 449 
 450       // if no method data exists, go to profile_method
 451       __ test_method_data_pointer(rax, *profile_method);
 452     }
 453 
 454     __ movptr(rax, Address(rbx, Method::method_counters_offset()));
 455     __ cmp32(rcx, Address(rax, in_bytes(MethodCounters::interpreter_invocation_limit_offset())));
 456     __ jcc(Assembler::aboveEqual, *overflow);
 457     __ bind(done);
 458   }
 459 }
 460 
 461 void TemplateInterpreterGenerator::generate_counter_overflow(Label&amp; do_continue) {
 462 
 463   // Asm interpreter on entry
 464   // r14/rdi - locals
 465   // r13/rsi - bcp
 466   // rbx - method
 467   // rdx - cpool --- DOES NOT APPEAR TO BE TRUE
 468   // rbp - interpreter frame
 469 
 470   // On return (i.e. jump to entry_point) [ back to invocation of interpreter ]
 471   // Everything as it was on entry
 472   // rdx is not restored. Doesn&#39;t appear to really be set.
 473 
 474   // InterpreterRuntime::frequency_counter_overflow takes two
 475   // arguments, the first (thread) is passed by call_VM, the second
 476   // indicates if the counter overflow occurs at a backwards branch
 477   // (NULL bcp).  We pass zero for it.  The call returns the address
 478   // of the verified entry point for the method or NULL if the
 479   // compilation did not complete (either went background or bailed
 480   // out).
 481   Register rarg = NOT_LP64(rax) LP64_ONLY(c_rarg1);
 482   __ movl(rarg, 0);
 483   __ call_VM(noreg,
 484              CAST_FROM_FN_PTR(address,
 485                               InterpreterRuntime::frequency_counter_overflow),
 486              rarg);
 487 
 488   __ movptr(rbx, Address(rbp, method_offset));   // restore Method*
 489   // Preserve invariant that r13/r14 contain bcp/locals of sender frame
 490   // and jump to the interpreted entry.
 491   __ jmp(do_continue, relocInfo::none);
 492 }
 493 
 494 // See if we&#39;ve got enough room on the stack for locals plus overhead below
 495 // JavaThread::stack_overflow_limit(). If not, throw a StackOverflowError
 496 // without going through the signal handler, i.e., reserved and yellow zones
 497 // will not be made usable. The shadow zone must suffice to handle the
 498 // overflow.
 499 // The expression stack grows down incrementally, so the normal guard
 500 // page mechanism will work for that.
 501 //
 502 // NOTE: Since the additional locals are also always pushed (wasn&#39;t
 503 // obvious in generate_fixed_frame) so the guard should work for them
 504 // too.
 505 //
 506 // Args:
 507 //      rdx: number of additional locals this frame needs (what we must check)
 508 //      rbx: Method*
 509 //
 510 // Kills:
 511 //      rax
 512 void TemplateInterpreterGenerator::generate_stack_overflow_check(void) {
 513 
 514   // monitor entry size: see picture of stack in frame_x86.hpp
 515   const int entry_size = frame::interpreter_frame_monitor_size() * wordSize;
 516 
 517   // total overhead size: entry_size + (saved rbp through expr stack
 518   // bottom).  be sure to change this if you add/subtract anything
 519   // to/from the overhead area
 520   const int overhead_size =
 521     -(frame::interpreter_frame_initial_sp_offset * wordSize) + entry_size;
 522 
 523   const int page_size = os::vm_page_size();
 524 
 525   Label after_frame_check;
 526 
 527   // see if the frame is greater than one page in size. If so,
 528   // then we need to verify there is enough stack space remaining
 529   // for the additional locals.
 530   __ cmpl(rdx, (page_size - overhead_size) / Interpreter::stackElementSize);
 531   __ jcc(Assembler::belowEqual, after_frame_check);
 532 
 533   // compute rsp as if this were going to be the last frame on
 534   // the stack before the red zone
 535 
 536   Label after_frame_check_pop;
 537   const Register thread = NOT_LP64(rsi) LP64_ONLY(r15_thread);
 538 #ifndef _LP64
 539   __ push(thread);
 540   __ get_thread(thread);
 541 #endif
 542 
 543   const Address stack_limit(thread, JavaThread::stack_overflow_limit_offset());
 544 
 545   // locals + overhead, in bytes
 546   __ mov(rax, rdx);
 547   __ shlptr(rax, Interpreter::logStackElementSize); // Convert parameter count to bytes.
 548   __ addptr(rax, overhead_size);
 549 
 550 #ifdef ASSERT
 551   Label limit_okay;
 552   // Verify that thread stack overflow limit is non-zero.
 553   __ cmpptr(stack_limit, (int32_t)NULL_WORD);
 554   __ jcc(Assembler::notEqual, limit_okay);
 555   __ stop(&quot;stack overflow limit is zero&quot;);
 556   __ bind(limit_okay);
 557 #endif
 558 
 559   // Add locals/frame size to stack limit.
 560   __ addptr(rax, stack_limit);
 561 
 562   // Check against the current stack bottom.
 563   __ cmpptr(rsp, rax);
 564 
 565   __ jcc(Assembler::above, after_frame_check_pop);
 566   NOT_LP64(__ pop(rsi));  // get saved bcp
 567 
 568   // Restore sender&#39;s sp as SP. This is necessary if the sender&#39;s
 569   // frame is an extended compiled frame (see gen_c2i_adapter())
 570   // and safer anyway in case of JSR292 adaptations.
 571 
 572   __ pop(rax); // return address must be moved if SP is changed
 573   __ mov(rsp, rbcp);
 574   __ push(rax);
 575 
 576   // Note: the restored frame is not necessarily interpreted.
 577   // Use the shared runtime version of the StackOverflowError.
 578   assert(StubRoutines::throw_StackOverflowError_entry() != NULL, &quot;stub not yet generated&quot;);
 579   __ jump(ExternalAddress(StubRoutines::throw_StackOverflowError_entry()));
 580   // all done with frame size check
 581   __ bind(after_frame_check_pop);
 582   NOT_LP64(__ pop(rsi));
 583 
 584   // all done with frame size check
 585   __ bind(after_frame_check);
 586 }
 587 
 588 // Allocate monitor and lock method (asm interpreter)
 589 //
 590 // Args:
 591 //      rbx: Method*
 592 //      r14/rdi: locals
 593 //
 594 // Kills:
 595 //      rax
 596 //      c_rarg0, c_rarg1, c_rarg2, c_rarg3, ...(param regs)
 597 //      rscratch1, rscratch2 (scratch regs)
 598 void TemplateInterpreterGenerator::lock_method() {
 599   // synchronize method
 600   const Address access_flags(rbx, Method::access_flags_offset());
 601   const Address monitor_block_top(
 602         rbp,
 603         frame::interpreter_frame_monitor_block_top_offset * wordSize);
 604   const int entry_size = frame::interpreter_frame_monitor_size() * wordSize;
 605 
 606 #ifdef ASSERT
 607   {
 608     Label L;
 609     __ movl(rax, access_flags);
 610     __ testl(rax, JVM_ACC_SYNCHRONIZED);
 611     __ jcc(Assembler::notZero, L);
 612     __ stop(&quot;method doesn&#39;t need synchronization&quot;);
 613     __ bind(L);
 614   }
 615 #endif // ASSERT
 616 
 617   // get synchronization object
 618   {
 619     Label done;
 620     __ movl(rax, access_flags);
 621     __ testl(rax, JVM_ACC_STATIC);
 622     // get receiver (assume this is frequent case)
 623     __ movptr(rax, Address(rlocals, Interpreter::local_offset_in_bytes(0)));
 624     __ jcc(Assembler::zero, done);
 625     __ load_mirror(rax, rbx);
 626 
 627 #ifdef ASSERT
 628     {
 629       Label L;
 630       __ testptr(rax, rax);
 631       __ jcc(Assembler::notZero, L);
 632       __ stop(&quot;synchronization object is NULL&quot;);
 633       __ bind(L);
 634     }
 635 #endif // ASSERT
 636 
 637     __ bind(done);
 638     __ resolve(IS_NOT_NULL, rax);
 639   }
 640 
 641   // add space for monitor &amp; lock
 642   __ subptr(rsp, entry_size); // add space for a monitor entry
 643   __ movptr(monitor_block_top, rsp);  // set new monitor block top
 644   // store object
 645   __ movptr(Address(rsp, BasicObjectLock::obj_offset_in_bytes()), rax);
 646   const Register lockreg = NOT_LP64(rdx) LP64_ONLY(c_rarg1);
 647   __ movptr(lockreg, rsp); // object address
 648   __ lock_object(lockreg);
 649 }
 650 
 651 // Generate a fixed interpreter frame. This is identical setup for
 652 // interpreted methods and for native methods hence the shared code.
 653 //
 654 // Args:
 655 //      rax: return address
 656 //      rbx: Method*
 657 //      r14/rdi: pointer to locals
 658 //      r13/rsi: sender sp
 659 //      rdx: cp cache
 660 void TemplateInterpreterGenerator::generate_fixed_frame(bool native_call) {
 661   // initialize fixed part of activation frame
 662   __ push(rax);        // save return address
 663   __ enter();          // save old &amp; set new rbp
 664   __ push(rbcp);        // set sender sp
 665   __ push((int)NULL_WORD); // leave last_sp as null
 666   __ movptr(rbcp, Address(rbx, Method::const_offset()));      // get ConstMethod*
 667   __ lea(rbcp, Address(rbcp, ConstMethod::codes_offset())); // get codebase
 668   __ push(rbx);        // save Method*
 669   // Get mirror and store it in the frame as GC root for this Method*
 670   __ load_mirror(rdx, rbx);
 671   __ push(rdx);
 672   if (ProfileInterpreter) {
 673     Label method_data_continue;
 674     __ movptr(rdx, Address(rbx, in_bytes(Method::method_data_offset())));
 675     __ testptr(rdx, rdx);
 676     __ jcc(Assembler::zero, method_data_continue);
 677     __ addptr(rdx, in_bytes(MethodData::data_offset()));
 678     __ bind(method_data_continue);
 679     __ push(rdx);      // set the mdp (method data pointer)
 680   } else {
 681     __ push(0);
 682   }
 683 
 684   __ movptr(rdx, Address(rbx, Method::const_offset()));
 685   __ movptr(rdx, Address(rdx, ConstMethod::constants_offset()));
 686   __ movptr(rdx, Address(rdx, ConstantPool::cache_offset_in_bytes()));
 687   __ push(rdx); // set constant pool cache
 688   __ push(rlocals); // set locals pointer
 689   if (native_call) {
 690     __ push(0); // no bcp
 691   } else {
 692     __ push(rbcp); // set bcp
 693   }
 694   __ push(0); // reserve word for pointer to expression stack bottom
 695   __ movptr(Address(rsp, 0), rsp); // set expression stack bottom
 696 }
 697 
 698 // End of helpers
 699 
 700 // Method entry for java.lang.ref.Reference.get.
 701 address TemplateInterpreterGenerator::generate_Reference_get_entry(void) {
 702   // Code: _aload_0, _getfield, _areturn
 703   // parameter size = 1
 704   //
 705   // The code that gets generated by this routine is split into 2 parts:
 706   //    1. The &quot;intrinsified&quot; code performing an ON_WEAK_OOP_REF load,
 707   //    2. The slow path - which is an expansion of the regular method entry.
 708   //
 709   // Notes:-
 710   // * An intrinsic is always executed, where an ON_WEAK_OOP_REF load is performed.
 711   // * We may jump to the slow path iff the receiver is null. If the
 712   //   Reference object is null then we no longer perform an ON_WEAK_OOP_REF load
 713   //   Thus we can use the regular method entry code to generate the NPE.
 714   //
 715   // rbx: Method*
 716 
 717   // r13: senderSP must preserve for slow path, set SP to it on fast path
 718 
 719   address entry = __ pc();
 720 
<a name="2" id="anc2"></a><span class="line-modified"> 721   const int referent_offset = java_lang_ref_Reference::referent_offset();</span>

 722 
 723   Label slow_path;
 724   // rbx: method
 725 
 726   // Check if local 0 != NULL
 727   // If the receiver is null then it is OK to jump to the slow path.
 728   __ movptr(rax, Address(rsp, wordSize));
 729 
 730   __ testptr(rax, rax);
 731   __ jcc(Assembler::zero, slow_path);
 732 
 733   // rax: local 0
 734   // rbx: method (but can be used as scratch now)
 735   // rdx: scratch
 736   // rdi: scratch
 737 
 738   // Preserve the sender sp in case the load barrier
 739   // calls the runtime
 740   NOT_LP64(__ push(rsi));
 741 
 742   // Load the value of the referent field.
 743   const Address field_address(rax, referent_offset);
 744   __ load_heap_oop(rax, field_address, /*tmp1*/ rbx, /*tmp_thread*/ rdx, ON_WEAK_OOP_REF);
 745 
 746   // _areturn
 747   const Register sender_sp = NOT_LP64(rsi) LP64_ONLY(r13);
 748   NOT_LP64(__ pop(rsi));      // get sender sp
 749   __ pop(rdi);                // get return address
 750   __ mov(rsp, sender_sp);     // set sp to sender sp
 751   __ jmp(rdi);
 752   __ ret(0);
 753 
 754   // generate a vanilla interpreter entry as the slow path
 755   __ bind(slow_path);
 756   __ jump_to_entry(Interpreter::entry_for_kind(Interpreter::zerolocals));
 757   return entry;
 758 }
 759 
 760 void TemplateInterpreterGenerator::bang_stack_shadow_pages(bool native_call) {
 761   // Quick &amp; dirty stack overflow checking: bang the stack &amp; handle trap.
 762   // Note that we do the banging after the frame is setup, since the exception
 763   // handling code expects to find a valid interpreter frame on the stack.
 764   // Doing the banging earlier fails if the caller frame is not an interpreter
 765   // frame.
 766   // (Also, the exception throwing code expects to unlock any synchronized
 767   // method receiever, so do the banging after locking the receiver.)
 768 
 769   // Bang each page in the shadow zone. We can&#39;t assume it&#39;s been done for
 770   // an interpreter frame with greater than a page of locals, so each page
 771   // needs to be checked.  Only true for non-native.
 772   if (UseStackBanging) {
 773     const int page_size = os::vm_page_size();
 774     const int n_shadow_pages = ((int)JavaThread::stack_shadow_zone_size()) / page_size;
 775     const int start_page = native_call ? n_shadow_pages : 1;
 776     for (int pages = start_page; pages &lt;= n_shadow_pages; pages++) {
 777       __ bang_stack_with_offset(pages*page_size);
 778     }
 779   }
 780 }
 781 
 782 // Interpreter stub for calling a native method. (asm interpreter)
 783 // This sets up a somewhat different looking stack for calling the
 784 // native method than the typical interpreter frame setup.
 785 address TemplateInterpreterGenerator::generate_native_entry(bool synchronized) {
 786   // determine code generation flags
 787   bool inc_counter  = UseCompiler || CountCompiledCalls || LogTouchedMethods;
 788 
 789   // rbx: Method*
 790   // rbcp: sender sp
 791 
 792   address entry_point = __ pc();
 793 
 794   const Address constMethod       (rbx, Method::const_offset());
 795   const Address access_flags      (rbx, Method::access_flags_offset());
 796   const Address size_of_parameters(rcx, ConstMethod::
 797                                         size_of_parameters_offset());
 798 
 799 
 800   // get parameter size (always needed)
 801   __ movptr(rcx, constMethod);
 802   __ load_unsigned_short(rcx, size_of_parameters);
 803 
 804   // native calls don&#39;t need the stack size check since they have no
 805   // expression stack and the arguments are already on the stack and
 806   // we only add a handful of words to the stack
 807 
 808   // rbx: Method*
 809   // rcx: size of parameters
 810   // rbcp: sender sp
 811   __ pop(rax);                                       // get return address
 812 
 813   // for natives the size of locals is zero
 814 
 815   // compute beginning of parameters
 816   __ lea(rlocals, Address(rsp, rcx, Interpreter::stackElementScale(), -wordSize));
 817 
 818   // add 2 zero-initialized slots for native calls
 819   // initialize result_handler slot
 820   __ push((int) NULL_WORD);
 821   // slot for oop temp
 822   // (static native method holder mirror/jni oop result)
 823   __ push((int) NULL_WORD);
 824 
 825   // initialize fixed part of activation frame
 826   generate_fixed_frame(true);
 827 
 828   // make sure method is native &amp; not abstract
 829 #ifdef ASSERT
 830   __ movl(rax, access_flags);
 831   {
 832     Label L;
 833     __ testl(rax, JVM_ACC_NATIVE);
 834     __ jcc(Assembler::notZero, L);
 835     __ stop(&quot;tried to execute non-native method as native&quot;);
 836     __ bind(L);
 837   }
 838   {
 839     Label L;
 840     __ testl(rax, JVM_ACC_ABSTRACT);
 841     __ jcc(Assembler::zero, L);
 842     __ stop(&quot;tried to execute abstract method in interpreter&quot;);
 843     __ bind(L);
 844   }
 845 #endif
 846 
 847   // Since at this point in the method invocation the exception handler
 848   // would try to exit the monitor of synchronized methods which hasn&#39;t
 849   // been entered yet, we set the thread local variable
 850   // _do_not_unlock_if_synchronized to true. The remove_activation will
 851   // check this flag.
 852 
 853   const Register thread1 = NOT_LP64(rax) LP64_ONLY(r15_thread);
 854   NOT_LP64(__ get_thread(thread1));
 855   const Address do_not_unlock_if_synchronized(thread1,
 856         in_bytes(JavaThread::do_not_unlock_if_synchronized_offset()));
 857   __ movbool(do_not_unlock_if_synchronized, true);
 858 
 859   // increment invocation count &amp; check for overflow
 860   Label invocation_counter_overflow;
 861   if (inc_counter) {
 862     generate_counter_incr(&amp;invocation_counter_overflow, NULL, NULL);
 863   }
 864 
 865   Label continue_after_compile;
 866   __ bind(continue_after_compile);
 867 
 868   bang_stack_shadow_pages(true);
 869 
 870   // reset the _do_not_unlock_if_synchronized flag
 871   NOT_LP64(__ get_thread(thread1));
 872   __ movbool(do_not_unlock_if_synchronized, false);
 873 
 874   // check for synchronized methods
 875   // Must happen AFTER invocation_counter check and stack overflow check,
 876   // so method is not locked if overflows.
 877   if (synchronized) {
 878     lock_method();
 879   } else {
 880     // no synchronization necessary
 881 #ifdef ASSERT
 882     {
 883       Label L;
 884       __ movl(rax, access_flags);
 885       __ testl(rax, JVM_ACC_SYNCHRONIZED);
 886       __ jcc(Assembler::zero, L);
 887       __ stop(&quot;method needs synchronization&quot;);
 888       __ bind(L);
 889     }
 890 #endif
 891   }
 892 
 893   // start execution
 894 #ifdef ASSERT
 895   {
 896     Label L;
 897     const Address monitor_block_top(rbp,
 898                  frame::interpreter_frame_monitor_block_top_offset * wordSize);
 899     __ movptr(rax, monitor_block_top);
 900     __ cmpptr(rax, rsp);
 901     __ jcc(Assembler::equal, L);
 902     __ stop(&quot;broken stack frame setup in interpreter&quot;);
 903     __ bind(L);
 904   }
 905 #endif
 906 
 907   // jvmti support
 908   __ notify_method_entry();
 909 
 910   // work registers
 911   const Register method = rbx;
 912   const Register thread = NOT_LP64(rdi) LP64_ONLY(r15_thread);
 913   const Register t      = NOT_LP64(rcx) LP64_ONLY(r11);
 914 
 915   // allocate space for parameters
 916   __ get_method(method);
 917   __ movptr(t, Address(method, Method::const_offset()));
 918   __ load_unsigned_short(t, Address(t, ConstMethod::size_of_parameters_offset()));
 919 
 920 #ifndef _LP64
 921   __ shlptr(t, Interpreter::logStackElementSize); // Convert parameter count to bytes.
 922   __ addptr(t, 2*wordSize);     // allocate two more slots for JNIEnv and possible mirror
 923   __ subptr(rsp, t);
 924   __ andptr(rsp, -(StackAlignmentInBytes)); // gcc needs 16 byte aligned stacks to do XMM intrinsics
 925 #else
 926   __ shll(t, Interpreter::logStackElementSize);
 927 
 928   __ subptr(rsp, t);
 929   __ subptr(rsp, frame::arg_reg_save_area_bytes); // windows
 930   __ andptr(rsp, -16); // must be 16 byte boundary (see amd64 ABI)
 931 #endif // _LP64
 932 
 933   // get signature handler
 934   {
 935     Label L;
 936     __ movptr(t, Address(method, Method::signature_handler_offset()));
 937     __ testptr(t, t);
 938     __ jcc(Assembler::notZero, L);
 939     __ call_VM(noreg,
 940                CAST_FROM_FN_PTR(address,
 941                                 InterpreterRuntime::prepare_native_call),
 942                method);
 943     __ get_method(method);
 944     __ movptr(t, Address(method, Method::signature_handler_offset()));
 945     __ bind(L);
 946   }
 947 
 948   // call signature handler
 949   assert(InterpreterRuntime::SignatureHandlerGenerator::from() == rlocals,
 950          &quot;adjust this code&quot;);
 951   assert(InterpreterRuntime::SignatureHandlerGenerator::to() == rsp,
 952          &quot;adjust this code&quot;);
 953   assert(InterpreterRuntime::SignatureHandlerGenerator::temp() == NOT_LP64(t) LP64_ONLY(rscratch1),
 954          &quot;adjust this code&quot;);
 955 
 956   // The generated handlers do not touch RBX (the method oop).
 957   // However, large signatures cannot be cached and are generated
 958   // each time here.  The slow-path generator can do a GC on return,
 959   // so we must reload it after the call.
 960   __ call(t);
 961   __ get_method(method);        // slow path can do a GC, reload RBX
 962 
 963 
 964   // result handler is in rax
 965   // set result handler
 966   __ movptr(Address(rbp,
 967                     (frame::interpreter_frame_result_handler_offset) * wordSize),
 968             rax);
 969 
 970   // pass mirror handle if static call
 971   {
 972     Label L;
 973     __ movl(t, Address(method, Method::access_flags_offset()));
 974     __ testl(t, JVM_ACC_STATIC);
 975     __ jcc(Assembler::zero, L);
 976     // get mirror
 977     __ load_mirror(t, method, rax);
 978     // copy mirror into activation frame
 979     __ movptr(Address(rbp, frame::interpreter_frame_oop_temp_offset * wordSize),
 980             t);
 981     // pass handle to mirror
 982 #ifndef _LP64
 983     __ lea(t, Address(rbp, frame::interpreter_frame_oop_temp_offset * wordSize));
 984     __ movptr(Address(rsp, wordSize), t);
 985 #else
 986     __ lea(c_rarg1,
 987            Address(rbp, frame::interpreter_frame_oop_temp_offset * wordSize));
 988 #endif // _LP64
 989     __ bind(L);
 990   }
 991 
 992   // get native function entry point
 993   {
 994     Label L;
 995     __ movptr(rax, Address(method, Method::native_function_offset()));
 996     ExternalAddress unsatisfied(SharedRuntime::native_method_throw_unsatisfied_link_error_entry());
 997     __ cmpptr(rax, unsatisfied.addr());
 998     __ jcc(Assembler::notEqual, L);
 999     __ call_VM(noreg,
1000                CAST_FROM_FN_PTR(address,
1001                                 InterpreterRuntime::prepare_native_call),
1002                method);
1003     __ get_method(method);
1004     __ movptr(rax, Address(method, Method::native_function_offset()));
1005     __ bind(L);
1006   }
1007 
1008   // pass JNIEnv
1009 #ifndef _LP64
1010    __ get_thread(thread);
1011    __ lea(t, Address(thread, JavaThread::jni_environment_offset()));
1012    __ movptr(Address(rsp, 0), t);
1013 
1014    // set_last_Java_frame_before_call
1015    // It is enough that the pc()
1016    // points into the right code segment. It does not have to be the correct return pc.
1017    __ set_last_Java_frame(thread, noreg, rbp, __ pc());
1018 #else
1019    __ lea(c_rarg0, Address(r15_thread, JavaThread::jni_environment_offset()));
1020 
1021    // It is enough that the pc() points into the right code
1022    // segment. It does not have to be the correct return pc.
1023    __ set_last_Java_frame(rsp, rbp, (address) __ pc());
1024 #endif // _LP64
1025 
1026   // change thread state
1027 #ifdef ASSERT
1028   {
1029     Label L;
1030     __ movl(t, Address(thread, JavaThread::thread_state_offset()));
1031     __ cmpl(t, _thread_in_Java);
1032     __ jcc(Assembler::equal, L);
1033     __ stop(&quot;Wrong thread state in native stub&quot;);
1034     __ bind(L);
1035   }
1036 #endif
1037 
1038   // Change state to native
1039 
1040   __ movl(Address(thread, JavaThread::thread_state_offset()),
1041           _thread_in_native);
1042 
1043   // Call the native method.
1044   __ call(rax);
1045   // 32: result potentially in rdx:rax or ST0
1046   // 64: result potentially in rax or xmm0
1047 
1048   // Verify or restore cpu control state after JNI call
1049   __ restore_cpu_control_state_after_jni();
1050 
1051   // NOTE: The order of these pushes is known to frame::interpreter_frame_result
1052   // in order to extract the result of a method call. If the order of these
1053   // pushes change or anything else is added to the stack then the code in
1054   // interpreter_frame_result must also change.
1055 
1056 #ifndef _LP64
1057   // save potential result in ST(0) &amp; rdx:rax
1058   // (if result handler is the T_FLOAT or T_DOUBLE handler, result must be in ST0 -
1059   // the check is necessary to avoid potential Intel FPU overflow problems by saving/restoring &#39;empty&#39; FPU registers)
1060   // It is safe to do this push because state is _thread_in_native and return address will be found
1061   // via _last_native_pc and not via _last_jave_sp
1062 
1063   // NOTE: the order of theses push(es) is known to frame::interpreter_frame_result.
1064   // If the order changes or anything else is added to the stack the code in
1065   // interpreter_frame_result will have to be changed.
1066 
1067   { Label L;
1068     Label push_double;
1069     ExternalAddress float_handler(AbstractInterpreter::result_handler(T_FLOAT));
1070     ExternalAddress double_handler(AbstractInterpreter::result_handler(T_DOUBLE));
1071     __ cmpptr(Address(rbp, (frame::interpreter_frame_oop_temp_offset + 1)*wordSize),
1072               float_handler.addr());
1073     __ jcc(Assembler::equal, push_double);
1074     __ cmpptr(Address(rbp, (frame::interpreter_frame_oop_temp_offset + 1)*wordSize),
1075               double_handler.addr());
1076     __ jcc(Assembler::notEqual, L);
1077     __ bind(push_double);
1078     __ push_d(); // FP values are returned using the FPU, so push FPU contents (even if UseSSE &gt; 0).
1079     __ bind(L);
1080   }
1081 #else
1082   __ push(dtos);
1083 #endif // _LP64
1084 
1085   __ push(ltos);
1086 
1087   // change thread state
1088   NOT_LP64(__ get_thread(thread));
1089   __ movl(Address(thread, JavaThread::thread_state_offset()),
1090           _thread_in_native_trans);
1091 
1092   // Force this write out before the read below
1093   __ membar(Assembler::Membar_mask_bits(
1094               Assembler::LoadLoad | Assembler::LoadStore |
1095               Assembler::StoreLoad | Assembler::StoreStore));
1096 
1097 #ifndef _LP64
1098   if (AlwaysRestoreFPU) {
1099     //  Make sure the control word is correct.
1100     __ fldcw(ExternalAddress(StubRoutines::addr_fpu_cntrl_wrd_std()));
1101   }
1102 #endif // _LP64
1103 
1104   // check for safepoint operation in progress and/or pending suspend requests
1105   {
1106     Label Continue;
1107     Label slow_path;
1108 
1109 #ifndef _LP64
1110     __ safepoint_poll(slow_path, thread, noreg);
1111 #else
1112     __ safepoint_poll(slow_path, r15_thread, rscratch1);
1113 #endif
1114 
1115     __ cmpl(Address(thread, JavaThread::suspend_flags_offset()), 0);
1116     __ jcc(Assembler::equal, Continue);
1117     __ bind(slow_path);
1118 
1119     // Don&#39;t use call_VM as it will see a possible pending exception
1120     // and forward it and never return here preventing us from
1121     // clearing _last_native_pc down below.  Also can&#39;t use
1122     // call_VM_leaf either as it will check to see if r13 &amp; r14 are
1123     // preserved and correspond to the bcp/locals pointers. So we do a
1124     // runtime call by hand.
1125     //
1126 #ifndef _LP64
1127     __ push(thread);
1128     __ call(RuntimeAddress(CAST_FROM_FN_PTR(address,
1129                                             JavaThread::check_special_condition_for_native_trans)));
1130     __ increment(rsp, wordSize);
1131     __ get_thread(thread);
1132 #else
1133     __ mov(c_rarg0, r15_thread);
1134     __ mov(r12, rsp); // remember sp (can only use r12 if not using call_VM)
1135     __ subptr(rsp, frame::arg_reg_save_area_bytes); // windows
1136     __ andptr(rsp, -16); // align stack as required by ABI
1137     __ call(RuntimeAddress(CAST_FROM_FN_PTR(address, JavaThread::check_special_condition_for_native_trans)));
1138     __ mov(rsp, r12); // restore sp
1139     __ reinit_heapbase();
1140 #endif // _LP64
1141     __ bind(Continue);
1142   }
1143 
1144   // change thread state
1145   __ movl(Address(thread, JavaThread::thread_state_offset()), _thread_in_Java);
1146 
1147   // reset_last_Java_frame
1148   __ reset_last_Java_frame(thread, true);
1149 
1150   if (CheckJNICalls) {
1151     // clear_pending_jni_exception_check
1152     __ movptr(Address(thread, JavaThread::pending_jni_exception_check_fn_offset()), NULL_WORD);
1153   }
1154 
1155   // reset handle block
1156   __ movptr(t, Address(thread, JavaThread::active_handles_offset()));
1157   __ movl(Address(t, JNIHandleBlock::top_offset_in_bytes()), (int32_t)NULL_WORD);
1158 
1159   // If result is an oop unbox and store it in frame where gc will see it
1160   // and result handler will pick it up
1161 
1162   {
1163     Label no_oop;
1164     __ lea(t, ExternalAddress(AbstractInterpreter::result_handler(T_OBJECT)));
1165     __ cmpptr(t, Address(rbp, frame::interpreter_frame_result_handler_offset*wordSize));
1166     __ jcc(Assembler::notEqual, no_oop);
1167     // retrieve result
1168     __ pop(ltos);
1169     // Unbox oop result, e.g. JNIHandles::resolve value.
1170     __ resolve_jobject(rax /* value */,
1171                        thread /* thread */,
1172                        t /* tmp */);
1173     __ movptr(Address(rbp, frame::interpreter_frame_oop_temp_offset*wordSize), rax);
1174     // keep stack depth as expected by pushing oop which will eventually be discarded
1175     __ push(ltos);
1176     __ bind(no_oop);
1177   }
1178 
1179 
1180   {
1181     Label no_reguard;
1182     __ cmpl(Address(thread, JavaThread::stack_guard_state_offset()),
1183             JavaThread::stack_guard_yellow_reserved_disabled);
1184     __ jcc(Assembler::notEqual, no_reguard);
1185 
1186     __ pusha(); // XXX only save smashed registers
1187 #ifndef _LP64
1188     __ call(RuntimeAddress(CAST_FROM_FN_PTR(address, SharedRuntime::reguard_yellow_pages)));
1189     __ popa();
1190 #else
1191     __ mov(r12, rsp); // remember sp (can only use r12 if not using call_VM)
1192     __ subptr(rsp, frame::arg_reg_save_area_bytes); // windows
1193     __ andptr(rsp, -16); // align stack as required by ABI
1194     __ call(RuntimeAddress(CAST_FROM_FN_PTR(address, SharedRuntime::reguard_yellow_pages)));
1195     __ mov(rsp, r12); // restore sp
1196     __ popa(); // XXX only restore smashed registers
1197     __ reinit_heapbase();
1198 #endif // _LP64
1199 
1200     __ bind(no_reguard);
1201   }
1202 
1203 
1204   // The method register is junk from after the thread_in_native transition
1205   // until here.  Also can&#39;t call_VM until the bcp has been
1206   // restored.  Need bcp for throwing exception below so get it now.
1207   __ get_method(method);
1208 
1209   // restore to have legal interpreter frame, i.e., bci == 0 &lt;=&gt; code_base()
1210   __ movptr(rbcp, Address(method, Method::const_offset()));   // get ConstMethod*
1211   __ lea(rbcp, Address(rbcp, ConstMethod::codes_offset()));    // get codebase
1212 
1213   // handle exceptions (exception handling will handle unlocking!)
1214   {
1215     Label L;
1216     __ cmpptr(Address(thread, Thread::pending_exception_offset()), (int32_t) NULL_WORD);
1217     __ jcc(Assembler::zero, L);
1218     // Note: At some point we may want to unify this with the code
1219     // used in call_VM_base(); i.e., we should use the
1220     // StubRoutines::forward_exception code. For now this doesn&#39;t work
1221     // here because the rsp is not correctly set at this point.
1222     __ MacroAssembler::call_VM(noreg,
1223                                CAST_FROM_FN_PTR(address,
1224                                InterpreterRuntime::throw_pending_exception));
1225     __ should_not_reach_here();
1226     __ bind(L);
1227   }
1228 
1229   // do unlocking if necessary
1230   {
1231     Label L;
1232     __ movl(t, Address(method, Method::access_flags_offset()));
1233     __ testl(t, JVM_ACC_SYNCHRONIZED);
1234     __ jcc(Assembler::zero, L);
1235     // the code below should be shared with interpreter macro
1236     // assembler implementation
1237     {
1238       Label unlock;
1239       // BasicObjectLock will be first in list, since this is a
1240       // synchronized method. However, need to check that the object
1241       // has not been unlocked by an explicit monitorexit bytecode.
1242       const Address monitor(rbp,
1243                             (intptr_t)(frame::interpreter_frame_initial_sp_offset *
1244                                        wordSize - (int)sizeof(BasicObjectLock)));
1245 
1246       const Register regmon = NOT_LP64(rdx) LP64_ONLY(c_rarg1);
1247 
1248       // monitor expect in c_rarg1 for slow unlock path
1249       __ lea(regmon, monitor); // address of first monitor
1250 
1251       __ movptr(t, Address(regmon, BasicObjectLock::obj_offset_in_bytes()));
1252       __ testptr(t, t);
1253       __ jcc(Assembler::notZero, unlock);
1254 
1255       // Entry already unlocked, need to throw exception
1256       __ MacroAssembler::call_VM(noreg,
1257                                  CAST_FROM_FN_PTR(address,
1258                    InterpreterRuntime::throw_illegal_monitor_state_exception));
1259       __ should_not_reach_here();
1260 
1261       __ bind(unlock);
1262       __ unlock_object(regmon);
1263     }
1264     __ bind(L);
1265   }
1266 
1267   // jvmti support
1268   // Note: This must happen _after_ handling/throwing any exceptions since
1269   //       the exception handler code notifies the runtime of method exits
1270   //       too. If this happens before, method entry/exit notifications are
1271   //       not properly paired (was bug - gri 11/22/99).
1272   __ notify_method_exit(vtos, InterpreterMacroAssembler::NotifyJVMTI);
1273 
1274   // restore potential result in edx:eax, call result handler to
1275   // restore potential result in ST0 &amp; handle result
1276 
1277   __ pop(ltos);
1278   LP64_ONLY( __ pop(dtos));
1279 
1280   __ movptr(t, Address(rbp,
1281                        (frame::interpreter_frame_result_handler_offset) * wordSize));
1282   __ call(t);
1283 
1284   // remove activation
1285   __ movptr(t, Address(rbp,
1286                        frame::interpreter_frame_sender_sp_offset *
1287                        wordSize)); // get sender sp
1288   __ leave();                                // remove frame anchor
1289   __ pop(rdi);                               // get return address
1290   __ mov(rsp, t);                            // set sp to sender sp
1291   __ jmp(rdi);
1292 
1293   if (inc_counter) {
1294     // Handle overflow of counter and compile method
1295     __ bind(invocation_counter_overflow);
1296     generate_counter_overflow(continue_after_compile);
1297   }
1298 
1299   return entry_point;
1300 }
1301 
1302 // Abstract method entry
1303 // Attempt to execute abstract method. Throw exception
1304 address TemplateInterpreterGenerator::generate_abstract_entry(void) {
1305 
1306   address entry_point = __ pc();
1307 
1308   // abstract method entry
1309 
1310   //  pop return address, reset last_sp to NULL
1311   __ empty_expression_stack();
1312   __ restore_bcp();      // rsi must be correct for exception handler   (was destroyed)
1313   __ restore_locals();   // make sure locals pointer is correct as well (was destroyed)
1314 
1315   // throw exception
1316   __ call_VM(noreg, CAST_FROM_FN_PTR(address, InterpreterRuntime::throw_AbstractMethodErrorWithMethod), rbx);
1317   // the call_VM checks for exception, so we should never return here.
1318   __ should_not_reach_here();
1319 
1320   return entry_point;
1321 }
1322 
1323 //
1324 // Generic interpreted method entry to (asm) interpreter
1325 //
1326 address TemplateInterpreterGenerator::generate_normal_entry(bool synchronized) {
1327   // determine code generation flags
1328   bool inc_counter  = UseCompiler || CountCompiledCalls || LogTouchedMethods;
1329 
1330   // ebx: Method*
1331   // rbcp: sender sp
1332   address entry_point = __ pc();
1333 
1334   const Address constMethod(rbx, Method::const_offset());
1335   const Address access_flags(rbx, Method::access_flags_offset());
1336   const Address size_of_parameters(rdx,
1337                                    ConstMethod::size_of_parameters_offset());
1338   const Address size_of_locals(rdx, ConstMethod::size_of_locals_offset());
1339 
1340 
1341   // get parameter size (always needed)
1342   __ movptr(rdx, constMethod);
1343   __ load_unsigned_short(rcx, size_of_parameters);
1344 
1345   // rbx: Method*
1346   // rcx: size of parameters
1347   // rbcp: sender_sp (could differ from sp+wordSize if we were called via c2i )
1348 
1349   __ load_unsigned_short(rdx, size_of_locals); // get size of locals in words
1350   __ subl(rdx, rcx); // rdx = no. of additional locals
1351 
1352   // YYY
1353 //   __ incrementl(rdx);
1354 //   __ andl(rdx, -2);
1355 
1356   // see if we&#39;ve got enough room on the stack for locals plus overhead.
1357   generate_stack_overflow_check();
1358 
1359   // get return address
1360   __ pop(rax);
1361 
1362   // compute beginning of parameters
1363   __ lea(rlocals, Address(rsp, rcx, Interpreter::stackElementScale(), -wordSize));
1364 
1365   // rdx - # of additional locals
1366   // allocate space for locals
1367   // explicitly initialize locals
1368   {
1369     Label exit, loop;
1370     __ testl(rdx, rdx);
1371     __ jcc(Assembler::lessEqual, exit); // do nothing if rdx &lt;= 0
1372     __ bind(loop);
1373     __ push((int) NULL_WORD); // initialize local variables
1374     __ decrementl(rdx); // until everything initialized
1375     __ jcc(Assembler::greater, loop);
1376     __ bind(exit);
1377   }
1378 
1379   // initialize fixed part of activation frame
1380   generate_fixed_frame(false);
1381 
1382   // make sure method is not native &amp; not abstract
1383 #ifdef ASSERT
1384   __ movl(rax, access_flags);
1385   {
1386     Label L;
1387     __ testl(rax, JVM_ACC_NATIVE);
1388     __ jcc(Assembler::zero, L);
1389     __ stop(&quot;tried to execute native method as non-native&quot;);
1390     __ bind(L);
1391   }
1392   {
1393     Label L;
1394     __ testl(rax, JVM_ACC_ABSTRACT);
1395     __ jcc(Assembler::zero, L);
1396     __ stop(&quot;tried to execute abstract method in interpreter&quot;);
1397     __ bind(L);
1398   }
1399 #endif
1400 
1401   // Since at this point in the method invocation the exception
1402   // handler would try to exit the monitor of synchronized methods
1403   // which hasn&#39;t been entered yet, we set the thread local variable
1404   // _do_not_unlock_if_synchronized to true. The remove_activation
1405   // will check this flag.
1406 
1407   const Register thread = NOT_LP64(rax) LP64_ONLY(r15_thread);
1408   NOT_LP64(__ get_thread(thread));
1409   const Address do_not_unlock_if_synchronized(thread,
1410         in_bytes(JavaThread::do_not_unlock_if_synchronized_offset()));
1411   __ movbool(do_not_unlock_if_synchronized, true);
1412 
1413   __ profile_parameters_type(rax, rcx, rdx);
1414   // increment invocation count &amp; check for overflow
1415   Label invocation_counter_overflow;
1416   Label profile_method;
1417   Label profile_method_continue;
1418   if (inc_counter) {
1419     generate_counter_incr(&amp;invocation_counter_overflow,
1420                           &amp;profile_method,
1421                           &amp;profile_method_continue);
1422     if (ProfileInterpreter) {
1423       __ bind(profile_method_continue);
1424     }
1425   }
1426 
1427   Label continue_after_compile;
1428   __ bind(continue_after_compile);
1429 
1430   // check for synchronized interpreted methods
1431   bang_stack_shadow_pages(false);
1432 
1433   // reset the _do_not_unlock_if_synchronized flag
1434   NOT_LP64(__ get_thread(thread));
1435   __ movbool(do_not_unlock_if_synchronized, false);
1436 
1437   // check for synchronized methods
1438   // Must happen AFTER invocation_counter check and stack overflow check,
1439   // so method is not locked if overflows.
1440   if (synchronized) {
1441     // Allocate monitor and lock method
1442     lock_method();
1443   } else {
1444     // no synchronization necessary
1445 #ifdef ASSERT
1446     {
1447       Label L;
1448       __ movl(rax, access_flags);
1449       __ testl(rax, JVM_ACC_SYNCHRONIZED);
1450       __ jcc(Assembler::zero, L);
1451       __ stop(&quot;method needs synchronization&quot;);
1452       __ bind(L);
1453     }
1454 #endif
1455   }
1456 
1457   // start execution
1458 #ifdef ASSERT
1459   {
1460     Label L;
1461      const Address monitor_block_top (rbp,
1462                  frame::interpreter_frame_monitor_block_top_offset * wordSize);
1463     __ movptr(rax, monitor_block_top);
1464     __ cmpptr(rax, rsp);
1465     __ jcc(Assembler::equal, L);
1466     __ stop(&quot;broken stack frame setup in interpreter&quot;);
1467     __ bind(L);
1468   }
1469 #endif
1470 
1471   // jvmti support
1472   __ notify_method_entry();
1473 
1474   __ dispatch_next(vtos);
1475 
1476   // invocation counter overflow
1477   if (inc_counter) {
1478     if (ProfileInterpreter) {
1479       // We have decided to profile this method in the interpreter
1480       __ bind(profile_method);
1481       __ call_VM(noreg, CAST_FROM_FN_PTR(address, InterpreterRuntime::profile_method));
1482       __ set_method_data_pointer_for_bcp();
1483       __ get_method(rbx);
1484       __ jmp(profile_method_continue);
1485     }
1486     // Handle overflow of counter and compile method
1487     __ bind(invocation_counter_overflow);
1488     generate_counter_overflow(continue_after_compile);
1489   }
1490 
1491   return entry_point;
1492 }
1493 
1494 //-----------------------------------------------------------------------------
1495 // Exceptions
1496 
1497 void TemplateInterpreterGenerator::generate_throw_exception() {
1498   // Entry point in previous activation (i.e., if the caller was
1499   // interpreted)
1500   Interpreter::_rethrow_exception_entry = __ pc();
1501   // Restore sp to interpreter_frame_last_sp even though we are going
1502   // to empty the expression stack for the exception processing.
1503   __ movptr(Address(rbp, frame::interpreter_frame_last_sp_offset * wordSize), (int32_t)NULL_WORD);
1504   // rax: exception
1505   // rdx: return address/pc that threw exception
1506   __ restore_bcp();    // r13/rsi points to call/send
1507   __ restore_locals();
1508   LP64_ONLY(__ reinit_heapbase());  // restore r12 as heapbase.
1509   // Entry point for exceptions thrown within interpreter code
1510   Interpreter::_throw_exception_entry = __ pc();
1511   // expression stack is undefined here
1512   // rax: exception
1513   // r13/rsi: exception bcp
1514   __ verify_oop(rax);
1515   Register rarg = NOT_LP64(rax) LP64_ONLY(c_rarg1);
1516   LP64_ONLY(__ mov(c_rarg1, rax));
1517 
1518   // expression stack must be empty before entering the VM in case of
1519   // an exception
1520   __ empty_expression_stack();
1521   // find exception handler address and preserve exception oop
1522   __ call_VM(rdx,
1523              CAST_FROM_FN_PTR(address,
1524                           InterpreterRuntime::exception_handler_for_exception),
1525              rarg);
1526   // rax: exception handler entry point
1527   // rdx: preserved exception oop
1528   // r13/rsi: bcp for exception handler
1529   __ push_ptr(rdx); // push exception which is now the only value on the stack
1530   __ jmp(rax); // jump to exception handler (may be _remove_activation_entry!)
1531 
1532   // If the exception is not handled in the current frame the frame is
1533   // removed and the exception is rethrown (i.e. exception
1534   // continuation is _rethrow_exception).
1535   //
1536   // Note: At this point the bci is still the bxi for the instruction
1537   // which caused the exception and the expression stack is
1538   // empty. Thus, for any VM calls at this point, GC will find a legal
1539   // oop map (with empty expression stack).
1540 
1541   // In current activation
1542   // tos: exception
1543   // esi: exception bcp
1544 
1545   //
1546   // JVMTI PopFrame support
1547   //
1548 
1549   Interpreter::_remove_activation_preserving_args_entry = __ pc();
1550   __ empty_expression_stack();
1551   // Set the popframe_processing bit in pending_popframe_condition
1552   // indicating that we are currently handling popframe, so that
1553   // call_VMs that may happen later do not trigger new popframe
1554   // handling cycles.
1555   const Register thread = NOT_LP64(rcx) LP64_ONLY(r15_thread);
1556   NOT_LP64(__ get_thread(thread));
1557   __ movl(rdx, Address(thread, JavaThread::popframe_condition_offset()));
1558   __ orl(rdx, JavaThread::popframe_processing_bit);
1559   __ movl(Address(thread, JavaThread::popframe_condition_offset()), rdx);
1560 
1561   {
1562     // Check to see whether we are returning to a deoptimized frame.
1563     // (The PopFrame call ensures that the caller of the popped frame is
1564     // either interpreted or compiled and deoptimizes it if compiled.)
1565     // In this case, we can&#39;t call dispatch_next() after the frame is
1566     // popped, but instead must save the incoming arguments and restore
1567     // them after deoptimization has occurred.
1568     //
1569     // Note that we don&#39;t compare the return PC against the
1570     // deoptimization blob&#39;s unpack entry because of the presence of
1571     // adapter frames in C2.
1572     Label caller_not_deoptimized;
1573     Register rarg = NOT_LP64(rdx) LP64_ONLY(c_rarg1);
1574     __ movptr(rarg, Address(rbp, frame::return_addr_offset * wordSize));
1575     __ super_call_VM_leaf(CAST_FROM_FN_PTR(address,
1576                                InterpreterRuntime::interpreter_contains), rarg);
1577     __ testl(rax, rax);
1578     __ jcc(Assembler::notZero, caller_not_deoptimized);
1579 
1580     // Compute size of arguments for saving when returning to
1581     // deoptimized caller
1582     __ get_method(rax);
1583     __ movptr(rax, Address(rax, Method::const_offset()));
1584     __ load_unsigned_short(rax, Address(rax, in_bytes(ConstMethod::
1585                                                 size_of_parameters_offset())));
1586     __ shll(rax, Interpreter::logStackElementSize);
1587     __ restore_locals();
1588     __ subptr(rlocals, rax);
1589     __ addptr(rlocals, wordSize);
1590     // Save these arguments
1591     NOT_LP64(__ get_thread(thread));
1592     __ super_call_VM_leaf(CAST_FROM_FN_PTR(address,
1593                                            Deoptimization::
1594                                            popframe_preserve_args),
1595                           thread, rax, rlocals);
1596 
1597     __ remove_activation(vtos, rdx,
1598                          /* throw_monitor_exception */ false,
1599                          /* install_monitor_exception */ false,
1600                          /* notify_jvmdi */ false);
1601 
1602     // Inform deoptimization that it is responsible for restoring
1603     // these arguments
1604     NOT_LP64(__ get_thread(thread));
1605     __ movl(Address(thread, JavaThread::popframe_condition_offset()),
1606             JavaThread::popframe_force_deopt_reexecution_bit);
1607 
1608     // Continue in deoptimization handler
1609     __ jmp(rdx);
1610 
1611     __ bind(caller_not_deoptimized);
1612   }
1613 
1614   __ remove_activation(vtos, rdx, /* rdx result (retaddr) is not used */
1615                        /* throw_monitor_exception */ false,
1616                        /* install_monitor_exception */ false,
1617                        /* notify_jvmdi */ false);
1618 
1619   // Finish with popframe handling
1620   // A previous I2C followed by a deoptimization might have moved the
1621   // outgoing arguments further up the stack. PopFrame expects the
1622   // mutations to those outgoing arguments to be preserved and other
1623   // constraints basically require this frame to look exactly as
1624   // though it had previously invoked an interpreted activation with
1625   // no space between the top of the expression stack (current
1626   // last_sp) and the top of stack. Rather than force deopt to
1627   // maintain this kind of invariant all the time we call a small
1628   // fixup routine to move the mutated arguments onto the top of our
1629   // expression stack if necessary.
1630 #ifndef _LP64
1631   __ mov(rax, rsp);
1632   __ movptr(rbx, Address(rbp, frame::interpreter_frame_last_sp_offset * wordSize));
1633   __ get_thread(thread);
1634   // PC must point into interpreter here
1635   __ set_last_Java_frame(thread, noreg, rbp, __ pc());
1636   __ super_call_VM_leaf(CAST_FROM_FN_PTR(address, InterpreterRuntime::popframe_move_outgoing_args), thread, rax, rbx);
1637   __ get_thread(thread);
1638 #else
1639   __ mov(c_rarg1, rsp);
1640   __ movptr(c_rarg2, Address(rbp, frame::interpreter_frame_last_sp_offset * wordSize));
1641   // PC must point into interpreter here
1642   __ set_last_Java_frame(noreg, rbp, __ pc());
1643   __ super_call_VM_leaf(CAST_FROM_FN_PTR(address, InterpreterRuntime::popframe_move_outgoing_args), r15_thread, c_rarg1, c_rarg2);
1644 #endif
1645   __ reset_last_Java_frame(thread, true);
1646 
1647   // Restore the last_sp and null it out
1648   __ movptr(rsp, Address(rbp, frame::interpreter_frame_last_sp_offset * wordSize));
1649   __ movptr(Address(rbp, frame::interpreter_frame_last_sp_offset * wordSize), (int32_t)NULL_WORD);
1650 
1651   __ restore_bcp();
1652   __ restore_locals();
1653   // The method data pointer was incremented already during
1654   // call profiling. We have to restore the mdp for the current bcp.
1655   if (ProfileInterpreter) {
1656     __ set_method_data_pointer_for_bcp();
1657   }
1658 
1659   // Clear the popframe condition flag
1660   NOT_LP64(__ get_thread(thread));
1661   __ movl(Address(thread, JavaThread::popframe_condition_offset()),
1662           JavaThread::popframe_inactive);
1663 
1664 #if INCLUDE_JVMTI
1665   {
1666     Label L_done;
1667     const Register local0 = rlocals;
1668 
1669     __ cmpb(Address(rbcp, 0), Bytecodes::_invokestatic);
1670     __ jcc(Assembler::notEqual, L_done);
1671 
1672     // The member name argument must be restored if _invokestatic is re-executed after a PopFrame call.
1673     // Detect such a case in the InterpreterRuntime function and return the member name argument, or NULL.
1674 
1675     __ get_method(rdx);
1676     __ movptr(rax, Address(local0, 0));
1677     __ call_VM(rax, CAST_FROM_FN_PTR(address, InterpreterRuntime::member_name_arg_or_null), rax, rdx, rbcp);
1678 
1679     __ testptr(rax, rax);
1680     __ jcc(Assembler::zero, L_done);
1681 
1682     __ movptr(Address(rbx, 0), rax);
1683     __ bind(L_done);
1684   }
1685 #endif // INCLUDE_JVMTI
1686 
1687   __ dispatch_next(vtos);
1688   // end of PopFrame support
1689 
1690   Interpreter::_remove_activation_entry = __ pc();
1691 
1692   // preserve exception over this code sequence
1693   __ pop_ptr(rax);
1694   NOT_LP64(__ get_thread(thread));
1695   __ movptr(Address(thread, JavaThread::vm_result_offset()), rax);
1696   // remove the activation (without doing throws on illegalMonitorExceptions)
1697   __ remove_activation(vtos, rdx, false, true, false);
1698   // restore exception
1699   NOT_LP64(__ get_thread(thread));
1700   __ get_vm_result(rax, thread);
1701 
1702   // In between activations - previous activation type unknown yet
1703   // compute continuation point - the continuation point expects the
1704   // following registers set up:
1705   //
1706   // rax: exception
1707   // rdx: return address/pc that threw exception
1708   // rsp: expression stack of caller
1709   // rbp: ebp of caller
1710   __ push(rax);                                  // save exception
1711   __ push(rdx);                                  // save return address
1712   __ super_call_VM_leaf(CAST_FROM_FN_PTR(address,
1713                           SharedRuntime::exception_handler_for_return_address),
1714                         thread, rdx);
1715   __ mov(rbx, rax);                              // save exception handler
1716   __ pop(rdx);                                   // restore return address
1717   __ pop(rax);                                   // restore exception
1718   // Note that an &quot;issuing PC&quot; is actually the next PC after the call
1719   __ jmp(rbx);                                   // jump to exception
1720                                                  // handler of caller
1721 }
1722 
1723 
1724 //
1725 // JVMTI ForceEarlyReturn support
1726 //
1727 address TemplateInterpreterGenerator::generate_earlyret_entry_for(TosState state) {
1728   address entry = __ pc();
1729 
1730   __ restore_bcp();
1731   __ restore_locals();
1732   __ empty_expression_stack();
1733   __ load_earlyret_value(state);  // 32 bits returns value in rdx, so don&#39;t reuse
1734 
1735   const Register thread = NOT_LP64(rcx) LP64_ONLY(r15_thread);
1736   NOT_LP64(__ get_thread(thread));
1737   __ movptr(rcx, Address(thread, JavaThread::jvmti_thread_state_offset()));
1738   Address cond_addr(rcx, JvmtiThreadState::earlyret_state_offset());
1739 
1740   // Clear the earlyret state
1741   __ movl(cond_addr, JvmtiThreadState::earlyret_inactive);
1742 
1743   __ remove_activation(state, rsi,
1744                        false, /* throw_monitor_exception */
1745                        false, /* install_monitor_exception */
1746                        true); /* notify_jvmdi */
1747   __ jmp(rsi);
1748 
1749   return entry;
1750 } // end of ForceEarlyReturn support
1751 
1752 
1753 //-----------------------------------------------------------------------------
1754 // Helper for vtos entry point generation
1755 
1756 void TemplateInterpreterGenerator::set_vtos_entry_points(Template* t,
1757                                                          address&amp; bep,
1758                                                          address&amp; cep,
1759                                                          address&amp; sep,
1760                                                          address&amp; aep,
1761                                                          address&amp; iep,
1762                                                          address&amp; lep,
1763                                                          address&amp; fep,
1764                                                          address&amp; dep,
1765                                                          address&amp; vep) {
1766   assert(t-&gt;is_valid() &amp;&amp; t-&gt;tos_in() == vtos, &quot;illegal template&quot;);
1767   Label L;
1768   aep = __ pc();     // atos entry point
1769       __ push_ptr();
1770       __ jmp(L);
1771 #ifndef _LP64
1772   fep = __ pc();     // ftos entry point
1773       __ push(ftos);
1774       __ jmp(L);
1775   dep = __ pc();     // dtos entry point
1776       __ push(dtos);
1777       __ jmp(L);
1778 #else
1779   fep = __ pc();     // ftos entry point
1780       __ push_f(xmm0);
1781       __ jmp(L);
1782   dep = __ pc();     // dtos entry point
1783       __ push_d(xmm0);
1784       __ jmp(L);
1785 #endif // _LP64
1786   lep = __ pc();     // ltos entry point
1787       __ push_l();
1788       __ jmp(L);
1789   bep = cep = sep = iep = __ pc();      // [bcsi]tos entry point
1790       __ push_i();
1791   vep = __ pc();    // vtos entry point
1792   __ bind(L);
1793   generate_and_dispatch(t);
1794 }
1795 
1796 //-----------------------------------------------------------------------------
1797 
1798 // Non-product code
1799 #ifndef PRODUCT
1800 
1801 address TemplateInterpreterGenerator::generate_trace_code(TosState state) {
1802   address entry = __ pc();
1803 
1804 #ifndef _LP64
1805   // prepare expression stack
1806   __ pop(rcx);          // pop return address so expression stack is &#39;pure&#39;
1807   __ push(state);       // save tosca
1808 
1809   // pass tosca registers as arguments &amp; call tracer
1810   __ call_VM(noreg, CAST_FROM_FN_PTR(address, InterpreterRuntime::trace_bytecode), rcx, rax, rdx);
1811   __ mov(rcx, rax);     // make sure return address is not destroyed by pop(state)
1812   __ pop(state);        // restore tosca
1813 
1814   // return
1815   __ jmp(rcx);
1816 #else
1817   __ push(state);
1818   __ push(c_rarg0);
1819   __ push(c_rarg1);
1820   __ push(c_rarg2);
1821   __ push(c_rarg3);
1822   __ mov(c_rarg2, rax);  // Pass itos
1823 #ifdef _WIN64
1824   __ movflt(xmm3, xmm0); // Pass ftos
1825 #endif
1826   __ call_VM(noreg,
1827              CAST_FROM_FN_PTR(address, InterpreterRuntime::trace_bytecode),
1828              c_rarg1, c_rarg2, c_rarg3);
1829   __ pop(c_rarg3);
1830   __ pop(c_rarg2);
1831   __ pop(c_rarg1);
1832   __ pop(c_rarg0);
1833   __ pop(state);
1834   __ ret(0);                                   // return from result handler
1835 #endif // _LP64
1836 
1837   return entry;
1838 }
1839 
1840 void TemplateInterpreterGenerator::count_bytecode() {
1841   __ incrementl(ExternalAddress((address) &amp;BytecodeCounter::_counter_value));
1842 }
1843 
1844 void TemplateInterpreterGenerator::histogram_bytecode(Template* t) {
1845   __ incrementl(ExternalAddress((address) &amp;BytecodeHistogram::_counters[t-&gt;bytecode()]));
1846 }
1847 
1848 void TemplateInterpreterGenerator::histogram_bytecode_pair(Template* t) {
1849   __ mov32(rbx, ExternalAddress((address) &amp;BytecodePairHistogram::_index));
1850   __ shrl(rbx, BytecodePairHistogram::log2_number_of_codes);
1851   __ orl(rbx,
1852          ((int) t-&gt;bytecode()) &lt;&lt;
1853          BytecodePairHistogram::log2_number_of_codes);
1854   __ mov32(ExternalAddress((address) &amp;BytecodePairHistogram::_index), rbx);
1855   __ lea(rscratch1, ExternalAddress((address) BytecodePairHistogram::_counters));
1856   __ incrementl(Address(rscratch1, rbx, Address::times_4));
1857 }
1858 
1859 
1860 void TemplateInterpreterGenerator::trace_bytecode(Template* t) {
1861   // Call a little run-time stub to avoid blow-up for each bytecode.
1862   // The run-time runtime saves the right registers, depending on
1863   // the tosca in-state for the given template.
1864 
1865   assert(Interpreter::trace_code(t-&gt;tos_in()) != NULL,
1866          &quot;entry must have been generated&quot;);
1867 #ifndef _LP64
1868   __ call(RuntimeAddress(Interpreter::trace_code(t-&gt;tos_in())));
1869 #else
1870   __ mov(r12, rsp); // remember sp (can only use r12 if not using call_VM)
1871   __ andptr(rsp, -16); // align stack as required by ABI
1872   __ call(RuntimeAddress(Interpreter::trace_code(t-&gt;tos_in())));
1873   __ mov(rsp, r12); // restore sp
1874   __ reinit_heapbase();
1875 #endif // _LP64
1876 }
1877 
1878 
1879 void TemplateInterpreterGenerator::stop_interpreter_at() {
1880   Label L;
1881   __ cmp32(ExternalAddress((address) &amp;BytecodeCounter::_counter_value),
1882            StopInterpreterAt);
1883   __ jcc(Assembler::notEqual, L);
1884   __ int3();
1885   __ bind(L);
1886 }
1887 #endif // !PRODUCT
<a name="3" id="anc3"></a><b style="font-size: large; color: red">--- EOF ---</b>
















































































</pre>
<input id="eof" value="3" type="hidden" />
</body>
</html>