<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Old src/hotspot/share/oops/method.cpp</title>
    <link rel="stylesheet" href="../../../../style.css" />
  </head>
  <body>
    <pre>
   1 /*
   2  * Copyright (c) 1997, 2020, Oracle and/or its affiliates. All rights reserved.
   3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   4  *
   5  * This code is free software; you can redistribute it and/or modify it
   6  * under the terms of the GNU General Public License version 2 only, as
   7  * published by the Free Software Foundation.
   8  *
   9  * This code is distributed in the hope that it will be useful, but WITHOUT
  10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
  11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
  12  * version 2 for more details (a copy is included in the LICENSE file that
  13  * accompanied this code).
  14  *
  15  * You should have received a copy of the GNU General Public License version
  16  * 2 along with this work; if not, write to the Free Software Foundation,
  17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
  18  *
  19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
  20  * or visit www.oracle.com if you need additional information or have any
  21  * questions.
  22  *
  23  */
  24 
  25 #include &quot;precompiled.hpp&quot;
  26 #include &quot;classfile/classLoaderDataGraph.hpp&quot;
  27 #include &quot;classfile/metadataOnStackMark.hpp&quot;
  28 #include &quot;classfile/symbolTable.hpp&quot;
  29 #include &quot;classfile/systemDictionary.hpp&quot;
  30 #include &quot;code/codeCache.hpp&quot;
  31 #include &quot;code/debugInfoRec.hpp&quot;
  32 #include &quot;compiler/compilationPolicy.hpp&quot;
  33 #include &quot;gc/shared/collectedHeap.inline.hpp&quot;
  34 #include &quot;interpreter/bytecodeStream.hpp&quot;
  35 #include &quot;interpreter/bytecodeTracer.hpp&quot;
  36 #include &quot;interpreter/bytecodes.hpp&quot;
  37 #include &quot;interpreter/interpreter.hpp&quot;
  38 #include &quot;interpreter/oopMapCache.hpp&quot;
  39 #include &quot;logging/log.hpp&quot;
  40 #include &quot;logging/logTag.hpp&quot;
  41 #include &quot;logging/logStream.hpp&quot;
  42 #include &quot;memory/allocation.inline.hpp&quot;
  43 #include &quot;memory/metadataFactory.hpp&quot;
  44 #include &quot;memory/metaspaceClosure.hpp&quot;
  45 #include &quot;memory/metaspaceShared.hpp&quot;
  46 #include &quot;memory/oopFactory.hpp&quot;
  47 #include &quot;memory/resourceArea.hpp&quot;
  48 #include &quot;memory/universe.hpp&quot;
  49 #include &quot;oops/constMethod.hpp&quot;
  50 #include &quot;oops/constantPool.hpp&quot;
  51 #include &quot;oops/method.inline.hpp&quot;
  52 #include &quot;oops/methodData.hpp&quot;
  53 #include &quot;oops/objArrayKlass.hpp&quot;
  54 #include &quot;oops/objArrayOop.inline.hpp&quot;
  55 #include &quot;oops/oop.inline.hpp&quot;
  56 #include &quot;oops/symbol.hpp&quot;
  57 #include &quot;prims/jvmtiExport.hpp&quot;
  58 #include &quot;prims/methodHandles.hpp&quot;
  59 #include &quot;prims/nativeLookup.hpp&quot;
  60 #include &quot;runtime/arguments.hpp&quot;
  61 #include &quot;runtime/atomic.hpp&quot;
  62 #include &quot;runtime/frame.inline.hpp&quot;
  63 #include &quot;runtime/handles.inline.hpp&quot;
  64 #include &quot;runtime/init.hpp&quot;
  65 #include &quot;runtime/orderAccess.hpp&quot;
  66 #include &quot;runtime/relocator.hpp&quot;
  67 #include &quot;runtime/safepointVerifiers.hpp&quot;
  68 #include &quot;runtime/sharedRuntime.hpp&quot;
  69 #include &quot;runtime/signature.hpp&quot;
  70 #include &quot;utilities/align.hpp&quot;
  71 #include &quot;utilities/quickSort.hpp&quot;
  72 #include &quot;utilities/vmError.hpp&quot;
  73 #include &quot;utilities/xmlstream.hpp&quot;
  74 
  75 // Implementation of Method
  76 
  77 Method* Method::allocate(ClassLoaderData* loader_data,
  78                          int byte_code_size,
  79                          AccessFlags access_flags,
  80                          InlineTableSizes* sizes,
  81                          ConstMethod::MethodType method_type,
  82                          TRAPS) {
  83   assert(!access_flags.is_native() || byte_code_size == 0,
  84          &quot;native methods should not contain byte codes&quot;);
  85   ConstMethod* cm = ConstMethod::allocate(loader_data,
  86                                           byte_code_size,
  87                                           sizes,
  88                                           method_type,
  89                                           CHECK_NULL);
  90   int size = Method::size(access_flags.is_native());
  91   return new (loader_data, size, MetaspaceObj::MethodType, THREAD) Method(cm, access_flags);
  92 }
  93 
  94 Method::Method(ConstMethod* xconst, AccessFlags access_flags) {
  95   NoSafepointVerifier no_safepoint;
  96   set_constMethod(xconst);
  97   set_access_flags(access_flags);
  98   set_intrinsic_id(vmIntrinsics::_none);
  99   set_force_inline(false);
 100   set_hidden(false);
 101   set_dont_inline(false);
 102   set_has_injected_profile(false);
 103   set_method_data(NULL);
 104   clear_method_counters();
 105   set_vtable_index(Method::garbage_vtable_index);
 106 
 107   // Fix and bury in Method*
 108   set_interpreter_entry(NULL); // sets i2i entry and from_int
 109   set_adapter_entry(NULL);
 110   Method::clear_code(); // from_c/from_i get set to c2i/i2i
 111 
 112   if (access_flags.is_native()) {
 113     clear_native_function();
 114     set_signature_handler(NULL);
 115   }
 116 
 117   NOT_PRODUCT(set_compiled_invocation_count(0);)
 118 }
 119 
 120 // Release Method*.  The nmethod will be gone when we get here because
 121 // we&#39;ve walked the code cache.
 122 void Method::deallocate_contents(ClassLoaderData* loader_data) {
 123   MetadataFactory::free_metadata(loader_data, constMethod());
 124   set_constMethod(NULL);
 125   MetadataFactory::free_metadata(loader_data, method_data());
 126   set_method_data(NULL);
 127   MetadataFactory::free_metadata(loader_data, method_counters());
 128   clear_method_counters();
 129   // The nmethod will be gone when we get here.
 130   if (code() != NULL) _code = NULL;
 131 }
 132 
 133 void Method::release_C_heap_structures() {
 134   if (method_data()) {
 135 #if INCLUDE_JVMCI
 136     FailedSpeculation::free_failed_speculations(method_data()-&gt;get_failed_speculations_address());
 137 #endif
 138     // Destroy MethodData
 139     method_data()-&gt;~MethodData();
 140   }
 141 }
 142 
 143 address Method::get_i2c_entry() {
 144   assert(adapter() != NULL, &quot;must have&quot;);
 145   return adapter()-&gt;get_i2c_entry();
 146 }
 147 
 148 address Method::get_c2i_entry() {
 149   assert(adapter() != NULL, &quot;must have&quot;);
 150   return adapter()-&gt;get_c2i_entry();
 151 }
 152 
 153 address Method::get_c2i_unverified_entry() {
 154   assert(adapter() != NULL, &quot;must have&quot;);
 155   return adapter()-&gt;get_c2i_unverified_entry();
 156 }
 157 
 158 address Method::get_c2i_no_clinit_check_entry() {
 159   assert(VM_Version::supports_fast_class_init_checks(), &quot;&quot;);
 160   assert(adapter() != NULL, &quot;must have&quot;);
 161   return adapter()-&gt;get_c2i_no_clinit_check_entry();
 162 }
 163 
 164 char* Method::name_and_sig_as_C_string() const {
 165   return name_and_sig_as_C_string(constants()-&gt;pool_holder(), name(), signature());
 166 }
 167 
 168 char* Method::name_and_sig_as_C_string(char* buf, int size) const {
 169   return name_and_sig_as_C_string(constants()-&gt;pool_holder(), name(), signature(), buf, size);
 170 }
 171 
 172 char* Method::name_and_sig_as_C_string(Klass* klass, Symbol* method_name, Symbol* signature) {
 173   const char* klass_name = klass-&gt;external_name();
 174   int klass_name_len  = (int)strlen(klass_name);
 175   int method_name_len = method_name-&gt;utf8_length();
 176   int len             = klass_name_len + 1 + method_name_len + signature-&gt;utf8_length();
 177   char* dest          = NEW_RESOURCE_ARRAY(char, len + 1);
 178   strcpy(dest, klass_name);
 179   dest[klass_name_len] = &#39;.&#39;;
 180   strcpy(&amp;dest[klass_name_len + 1], method_name-&gt;as_C_string());
 181   strcpy(&amp;dest[klass_name_len + 1 + method_name_len], signature-&gt;as_C_string());
 182   dest[len] = 0;
 183   return dest;
 184 }
 185 
 186 char* Method::name_and_sig_as_C_string(Klass* klass, Symbol* method_name, Symbol* signature, char* buf, int size) {
 187   Symbol* klass_name = klass-&gt;name();
 188   klass_name-&gt;as_klass_external_name(buf, size);
 189   int len = (int)strlen(buf);
 190 
 191   if (len &lt; size - 1) {
 192     buf[len++] = &#39;.&#39;;
 193 
 194     method_name-&gt;as_C_string(&amp;(buf[len]), size - len);
 195     len = (int)strlen(buf);
 196 
 197     signature-&gt;as_C_string(&amp;(buf[len]), size - len);
 198   }
 199 
 200   return buf;
 201 }
 202 
 203 const char* Method::external_name() const {
 204   return external_name(constants()-&gt;pool_holder(), name(), signature());
 205 }
 206 
 207 void Method::print_external_name(outputStream *os) const {
 208   print_external_name(os, constants()-&gt;pool_holder(), name(), signature());
 209 }
 210 
 211 const char* Method::external_name(Klass* klass, Symbol* method_name, Symbol* signature) {
 212   stringStream ss;
 213   print_external_name(&amp;ss, klass, method_name, signature);
 214   return ss.as_string();
 215 }
 216 
 217 void Method::print_external_name(outputStream *os, Klass* klass, Symbol* method_name, Symbol* signature) {
 218   signature-&gt;print_as_signature_external_return_type(os);
 219   os-&gt;print(&quot; %s.%s(&quot;, klass-&gt;external_name(), method_name-&gt;as_C_string());
 220   signature-&gt;print_as_signature_external_parameters(os);
 221   os-&gt;print(&quot;)&quot;);
 222 }
 223 
 224 int Method::fast_exception_handler_bci_for(const methodHandle&amp; mh, Klass* ex_klass, int throw_bci, TRAPS) {
 225   // exception table holds quadruple entries of the form (beg_bci, end_bci, handler_bci, klass_index)
 226   // access exception table
 227   ExceptionTable table(mh());
 228   int length = table.length();
 229   // iterate through all entries sequentially
 230   constantPoolHandle pool(THREAD, mh-&gt;constants());
 231   for (int i = 0; i &lt; length; i ++) {
 232     //reacquire the table in case a GC happened
 233     ExceptionTable table(mh());
 234     int beg_bci = table.start_pc(i);
 235     int end_bci = table.end_pc(i);
 236     assert(beg_bci &lt;= end_bci, &quot;inconsistent exception table&quot;);
 237     if (beg_bci &lt;= throw_bci &amp;&amp; throw_bci &lt; end_bci) {
 238       // exception handler bci range covers throw_bci =&gt; investigate further
 239       int handler_bci = table.handler_pc(i);
 240       int klass_index = table.catch_type_index(i);
 241       if (klass_index == 0) {
 242         return handler_bci;
 243       } else if (ex_klass == NULL) {
 244         return handler_bci;
 245       } else {
 246         // we know the exception class =&gt; get the constraint class
 247         // this may require loading of the constraint class; if verification
 248         // fails or some other exception occurs, return handler_bci
 249         Klass* k = pool-&gt;klass_at(klass_index, CHECK_(handler_bci));
 250         assert(k != NULL, &quot;klass not loaded&quot;);
 251         if (ex_klass-&gt;is_subtype_of(k)) {
 252           return handler_bci;
 253         }
 254       }
 255     }
 256   }
 257 
 258   return -1;
 259 }
 260 
 261 void Method::mask_for(int bci, InterpreterOopMap* mask) {
 262   methodHandle h_this(Thread::current(), this);
 263   // Only GC uses the OopMapCache during thread stack root scanning
 264   // any other uses generate an oopmap but do not save it in the cache.
 265   if (Universe::heap()-&gt;is_gc_active()) {
 266     method_holder()-&gt;mask_for(h_this, bci, mask);
 267   } else {
 268     OopMapCache::compute_one_oop_map(h_this, bci, mask);
 269   }
 270   return;
 271 }
 272 
 273 
 274 int Method::bci_from(address bcp) const {
 275   if (is_native() &amp;&amp; bcp == 0) {
 276     return 0;
 277   }
 278 #ifdef ASSERT
 279   {
 280     ResourceMark rm;
 281     assert(is_native() &amp;&amp; bcp == code_base() || contains(bcp) || VMError::is_error_reported(),
 282            &quot;bcp doesn&#39;t belong to this method: bcp: &quot; INTPTR_FORMAT &quot;, method: %s&quot;,
 283            p2i(bcp), name_and_sig_as_C_string());
 284   }
 285 #endif
 286   return bcp - code_base();
 287 }
 288 
 289 
 290 int Method::validate_bci(int bci) const {
 291   return (bci == 0 || bci &lt; code_size()) ? bci : -1;
 292 }
 293 
 294 // Return bci if it appears to be a valid bcp
 295 // Return -1 otherwise.
 296 // Used by profiling code, when invalid data is a possibility.
 297 // The caller is responsible for validating the Method* itself.
 298 int Method::validate_bci_from_bcp(address bcp) const {
 299   // keep bci as -1 if not a valid bci
 300   int bci = -1;
 301   if (bcp == 0 || bcp == code_base()) {
 302     // code_size() may return 0 and we allow 0 here
 303     // the method may be native
 304     bci = 0;
 305   } else if (contains(bcp)) {
 306     bci = bcp - code_base();
 307   }
 308   // Assert that if we have dodged any asserts, bci is negative.
 309   assert(bci == -1 || bci == bci_from(bcp_from(bci)), &quot;sane bci if &gt;=0&quot;);
 310   return bci;
 311 }
 312 
 313 address Method::bcp_from(int bci) const {
 314   assert((is_native() &amp;&amp; bci == 0) || (!is_native() &amp;&amp; 0 &lt;= bci &amp;&amp; bci &lt; code_size()),
 315          &quot;illegal bci: %d for %s method&quot;, bci, is_native() ? &quot;native&quot; : &quot;non-native&quot;);
 316   address bcp = code_base() + bci;
 317   assert(is_native() &amp;&amp; bcp == code_base() || contains(bcp), &quot;bcp doesn&#39;t belong to this method&quot;);
 318   return bcp;
 319 }
 320 
 321 address Method::bcp_from(address bcp) const {
 322   if (is_native() &amp;&amp; bcp == NULL) {
 323     return code_base();
 324   } else {
 325     return bcp;
 326   }
 327 }
 328 
 329 int Method::size(bool is_native) {
 330   // If native, then include pointers for native_function and signature_handler
 331   int extra_bytes = (is_native) ? 2*sizeof(address*) : 0;
 332   int extra_words = align_up(extra_bytes, BytesPerWord) / BytesPerWord;
 333   return align_metadata_size(header_size() + extra_words);
 334 }
 335 
 336 Symbol* Method::klass_name() const {
 337   return method_holder()-&gt;name();
 338 }
 339 
 340 void Method::metaspace_pointers_do(MetaspaceClosure* it) {
 341   log_trace(cds)(&quot;Iter(Method): %p&quot;, this);
 342 
 343   it-&gt;push(&amp;_constMethod);
 344   it-&gt;push(&amp;_method_data);
 345   it-&gt;push(&amp;_method_counters);
 346 
 347   Method* this_ptr = this;
 348   it-&gt;push_method_entry(&amp;this_ptr, (intptr_t*)&amp;_i2i_entry);
 349   it-&gt;push_method_entry(&amp;this_ptr, (intptr_t*)&amp;_from_compiled_entry);
 350   it-&gt;push_method_entry(&amp;this_ptr, (intptr_t*)&amp;_from_interpreted_entry);
 351 }
 352 
 353 // Attempt to return method oop to original state.  Clear any pointers
 354 // (to objects outside the shared spaces).  We won&#39;t be able to predict
 355 // where they should point in a new JVM.  Further initialize some
 356 // entries now in order allow them to be write protected later.
 357 
 358 void Method::remove_unshareable_info() {
 359   unlink_method();
 360 }
 361 
 362 void Method::set_vtable_index(int index) {
 363   if (is_shared() &amp;&amp; !MetaspaceShared::remapped_readwrite()) {
 364     // At runtime initialize_vtable is rerun as part of link_class_impl()
 365     // for a shared class loaded by the non-boot loader to obtain the loader
 366     // constraints based on the runtime classloaders&#39; context.
 367     return; // don&#39;t write into the shared class
 368   } else {
 369     _vtable_index = index;
 370   }
 371 }
 372 
 373 void Method::set_itable_index(int index) {
 374   if (is_shared() &amp;&amp; !MetaspaceShared::remapped_readwrite()) {
 375     // At runtime initialize_itable is rerun as part of link_class_impl()
 376     // for a shared class loaded by the non-boot loader to obtain the loader
 377     // constraints based on the runtime classloaders&#39; context. The dumptime
 378     // itable index should be the same as the runtime index.
 379     assert(_vtable_index == itable_index_max - index,
 380            &quot;archived itable index is different from runtime index&quot;);
 381     return; // donâ€™t write into the shared class
 382   } else {
 383     _vtable_index = itable_index_max - index;
 384   }
 385   assert(valid_itable_index(), &quot;&quot;);
 386 }
 387 
 388 // The RegisterNatives call being attempted tried to register with a method that
 389 // is not native.  Ask JVM TI what prefixes have been specified.  Then check
 390 // to see if the native method is now wrapped with the prefixes.  See the
 391 // SetNativeMethodPrefix(es) functions in the JVM TI Spec for details.
 392 static Method* find_prefixed_native(Klass* k, Symbol* name, Symbol* signature, TRAPS) {
 393 #if INCLUDE_JVMTI
 394   ResourceMark rm(THREAD);
 395   Method* method;
 396   int name_len = name-&gt;utf8_length();
 397   char* name_str = name-&gt;as_utf8();
 398   int prefix_count;
 399   char** prefixes = JvmtiExport::get_all_native_method_prefixes(&amp;prefix_count);
 400   for (int i = 0; i &lt; prefix_count; i++) {
 401     char* prefix = prefixes[i];
 402     int prefix_len = (int)strlen(prefix);
 403 
 404     // try adding this prefix to the method name and see if it matches another method name
 405     int trial_len = name_len + prefix_len;
 406     char* trial_name_str = NEW_RESOURCE_ARRAY(char, trial_len + 1);
 407     strcpy(trial_name_str, prefix);
 408     strcat(trial_name_str, name_str);
 409     TempNewSymbol trial_name = SymbolTable::probe(trial_name_str, trial_len);
 410     if (trial_name == NULL) {
 411       continue; // no such symbol, so this prefix wasn&#39;t used, try the next prefix
 412     }
 413     method = k-&gt;lookup_method(trial_name, signature);
 414     if (method == NULL) {
 415       continue; // signature doesn&#39;t match, try the next prefix
 416     }
 417     if (method-&gt;is_native()) {
 418       method-&gt;set_is_prefixed_native();
 419       return method; // wahoo, we found a prefixed version of the method, return it
 420     }
 421     // found as non-native, so prefix is good, add it, probably just need more prefixes
 422     name_len = trial_len;
 423     name_str = trial_name_str;
 424   }
 425 #endif // INCLUDE_JVMTI
 426   return NULL; // not found
 427 }
 428 
 429 bool Method::register_native(Klass* k, Symbol* name, Symbol* signature, address entry, TRAPS) {
 430   Method* method = k-&gt;lookup_method(name, signature);
 431   if (method == NULL) {
 432     ResourceMark rm(THREAD);
 433     stringStream st;
 434     st.print(&quot;Method &#39;&quot;);
 435     print_external_name(&amp;st, k, name, signature);
 436     st.print(&quot;&#39; name or signature does not match&quot;);
 437     THROW_MSG_(vmSymbols::java_lang_NoSuchMethodError(), st.as_string(), false);
 438   }
 439   if (!method-&gt;is_native()) {
 440     // trying to register to a non-native method, see if a JVM TI agent has added prefix(es)
 441     method = find_prefixed_native(k, name, signature, THREAD);
 442     if (method == NULL) {
 443       ResourceMark rm(THREAD);
 444       stringStream st;
 445       st.print(&quot;Method &#39;&quot;);
 446       print_external_name(&amp;st, k, name, signature);
 447       st.print(&quot;&#39; is not declared as native&quot;);
 448       THROW_MSG_(vmSymbols::java_lang_NoSuchMethodError(), st.as_string(), false);
 449     }
 450   }
 451 
 452   if (entry != NULL) {
 453     method-&gt;set_native_function(entry, native_bind_event_is_interesting);
 454   } else {
 455     method-&gt;clear_native_function();
 456   }
 457   if (log_is_enabled(Debug, jni, resolve)) {
 458     ResourceMark rm(THREAD);
 459     log_debug(jni, resolve)(&quot;[Registering JNI native method %s.%s]&quot;,
 460                             method-&gt;method_holder()-&gt;external_name(),
 461                             method-&gt;name()-&gt;as_C_string());
 462   }
 463   return true;
 464 }
 465 
 466 bool Method::was_executed_more_than(int n) {
 467   // Invocation counter is reset when the Method* is compiled.
 468   // If the method has compiled code we therefore assume it has
 469   // be excuted more than n times.
 470   if (is_accessor() || is_empty_method() || (code() != NULL)) {
 471     // interpreter doesn&#39;t bump invocation counter of trivial methods
 472     // compiler does not bump invocation counter of compiled methods
 473     return true;
 474   }
 475   else if ((method_counters() != NULL &amp;&amp;
 476             method_counters()-&gt;invocation_counter()-&gt;carry()) ||
 477            (method_data() != NULL &amp;&amp;
 478             method_data()-&gt;invocation_counter()-&gt;carry())) {
 479     // The carry bit is set when the counter overflows and causes
 480     // a compilation to occur.  We don&#39;t know how many times
 481     // the counter has been reset, so we simply assume it has
 482     // been executed more than n times.
 483     return true;
 484   } else {
 485     return invocation_count() &gt; n;
 486   }
 487 }
 488 
 489 void Method::print_invocation_count() {
 490   if (is_static()) tty-&gt;print(&quot;static &quot;);
 491   if (is_final()) tty-&gt;print(&quot;final &quot;);
 492   if (is_synchronized()) tty-&gt;print(&quot;synchronized &quot;);
 493   if (is_native()) tty-&gt;print(&quot;native &quot;);
 494   tty-&gt;print(&quot;%s::&quot;, method_holder()-&gt;external_name());
 495   name()-&gt;print_symbol_on(tty);
 496   signature()-&gt;print_symbol_on(tty);
 497 
 498   if (WizardMode) {
 499     // dump the size of the byte codes
 500     tty-&gt;print(&quot; {%d}&quot;, code_size());
 501   }
 502   tty-&gt;cr();
 503 
 504   tty-&gt;print_cr (&quot;  interpreter_invocation_count: %8d &quot;, interpreter_invocation_count());
 505   tty-&gt;print_cr (&quot;  invocation_counter:           %8d &quot;, invocation_count());
 506   tty-&gt;print_cr (&quot;  backedge_counter:             %8d &quot;, backedge_count());
 507 #ifndef PRODUCT
 508   if (CountCompiledCalls) {
 509     tty-&gt;print_cr (&quot;  compiled_invocation_count: %8d &quot;, compiled_invocation_count());
 510   }
 511 #endif
 512 }
 513 
 514 // Build a MethodData* object to hold information about this method
 515 // collected in the interpreter.
 516 void Method::build_interpreter_method_data(const methodHandle&amp; method, TRAPS) {
 517   // Do not profile the method if metaspace has hit an OOM previously
 518   // allocating profiling data. Callers clear pending exception so don&#39;t
 519   // add one here.
 520   if (ClassLoaderDataGraph::has_metaspace_oom()) {
 521     return;
 522   }
 523 
 524   // Grab a lock here to prevent multiple
 525   // MethodData*s from being created.
 526   MutexLocker ml(THREAD, MethodData_lock);
 527   if (method-&gt;method_data() == NULL) {
 528     ClassLoaderData* loader_data = method-&gt;method_holder()-&gt;class_loader_data();
 529     MethodData* method_data = MethodData::allocate(loader_data, method, THREAD);
 530     if (HAS_PENDING_EXCEPTION) {
 531       CompileBroker::log_metaspace_failure();
 532       ClassLoaderDataGraph::set_metaspace_oom(true);
 533       return;   // return the exception (which is cleared)
 534     }
 535 
 536     method-&gt;set_method_data(method_data);
 537     if (PrintMethodData &amp;&amp; (Verbose || WizardMode)) {
 538       ResourceMark rm(THREAD);
 539       tty-&gt;print(&quot;build_interpreter_method_data for &quot;);
 540       method-&gt;print_name(tty);
 541       tty-&gt;cr();
 542       // At the end of the run, the MDO, full of data, will be dumped.
 543     }
 544   }
 545 }
 546 
 547 MethodCounters* Method::build_method_counters(Method* m, TRAPS) {
 548   // Do not profile the method if metaspace has hit an OOM previously
 549   if (ClassLoaderDataGraph::has_metaspace_oom()) {
 550     return NULL;
 551   }
 552 
 553   methodHandle mh(THREAD, m);
 554   MethodCounters* counters = MethodCounters::allocate(mh, THREAD);
 555   if (HAS_PENDING_EXCEPTION) {
 556     CompileBroker::log_metaspace_failure();
 557     ClassLoaderDataGraph::set_metaspace_oom(true);
 558     return NULL;   // return the exception (which is cleared)
 559   }
 560   if (!mh-&gt;init_method_counters(counters)) {
 561     MetadataFactory::free_metadata(mh-&gt;method_holder()-&gt;class_loader_data(), counters);
 562   }
 563 
 564   if (LogTouchedMethods) {
 565     mh-&gt;log_touched(CHECK_NULL);
 566   }
 567 
 568   return mh-&gt;method_counters();
 569 }
 570 
 571 bool Method::init_method_counters(MethodCounters* counters) {
 572   // Try to install a pointer to MethodCounters, return true on success.
 573   return Atomic::replace_if_null(&amp;_method_counters, counters);
 574 }
 575 
 576 int Method::extra_stack_words() {
 577   // not an inline function, to avoid a header dependency on Interpreter
 578   return extra_stack_entries() * Interpreter::stackElementSize;
 579 }
 580 
 581 // Derive size of parameters, return type, and fingerprint,
 582 // all in one pass, which is run at load time.
 583 // We need the first two, and might as well grab the third.
 584 void Method::compute_from_signature(Symbol* sig) {
 585   // At this point, since we are scanning the signature,
 586   // we might as well compute the whole fingerprint.
 587   Fingerprinter fp(sig, is_static());
 588   set_size_of_parameters(fp.size_of_parameters());
 589   constMethod()-&gt;set_result_type(fp.return_type());
 590   constMethod()-&gt;set_fingerprint(fp.fingerprint());
 591 }
 592 
 593 bool Method::is_empty_method() const {
 594   return  code_size() == 1
 595       &amp;&amp; *code_base() == Bytecodes::_return;
 596 }
 597 
 598 bool Method::is_vanilla_constructor() const {
 599   // Returns true if this method is a vanilla constructor, i.e. an &quot;&lt;init&gt;&quot; &quot;()V&quot; method
 600   // which only calls the superclass vanilla constructor and possibly does stores of
 601   // zero constants to local fields:
 602   //
 603   //   aload_0
 604   //   invokespecial
 605   //   indexbyte1
 606   //   indexbyte2
 607   //
 608   // followed by an (optional) sequence of:
 609   //
 610   //   aload_0
 611   //   aconst_null / iconst_0 / fconst_0 / dconst_0
 612   //   putfield
 613   //   indexbyte1
 614   //   indexbyte2
 615   //
 616   // followed by:
 617   //
 618   //   return
 619 
 620   assert(name() == vmSymbols::object_initializer_name(),    &quot;Should only be called for default constructors&quot;);
 621   assert(signature() == vmSymbols::void_method_signature(), &quot;Should only be called for default constructors&quot;);
 622   int size = code_size();
 623   // Check if size match
 624   if (size == 0 || size % 5 != 0) return false;
 625   address cb = code_base();
 626   int last = size - 1;
 627   if (cb[0] != Bytecodes::_aload_0 || cb[1] != Bytecodes::_invokespecial || cb[last] != Bytecodes::_return) {
 628     // Does not call superclass default constructor
 629     return false;
 630   }
 631   // Check optional sequence
 632   for (int i = 4; i &lt; last; i += 5) {
 633     if (cb[i] != Bytecodes::_aload_0) return false;
 634     if (!Bytecodes::is_zero_const(Bytecodes::cast(cb[i+1]))) return false;
 635     if (cb[i+2] != Bytecodes::_putfield) return false;
 636   }
 637   return true;
 638 }
 639 
 640 
 641 bool Method::compute_has_loops_flag() {
 642   BytecodeStream bcs(methodHandle(Thread::current(), this));
 643   Bytecodes::Code bc;
 644 
 645   while ((bc = bcs.next()) &gt;= 0) {
 646     switch( bc ) {
 647       case Bytecodes::_ifeq:
 648       case Bytecodes::_ifnull:
 649       case Bytecodes::_iflt:
 650       case Bytecodes::_ifle:
 651       case Bytecodes::_ifne:
 652       case Bytecodes::_ifnonnull:
 653       case Bytecodes::_ifgt:
 654       case Bytecodes::_ifge:
 655       case Bytecodes::_if_icmpeq:
 656       case Bytecodes::_if_icmpne:
 657       case Bytecodes::_if_icmplt:
 658       case Bytecodes::_if_icmpgt:
 659       case Bytecodes::_if_icmple:
 660       case Bytecodes::_if_icmpge:
 661       case Bytecodes::_if_acmpeq:
 662       case Bytecodes::_if_acmpne:
 663       case Bytecodes::_goto:
 664       case Bytecodes::_jsr:
 665         if( bcs.dest() &lt; bcs.next_bci() ) _access_flags.set_has_loops();
 666         break;
 667 
 668       case Bytecodes::_goto_w:
 669       case Bytecodes::_jsr_w:
 670         if( bcs.dest_w() &lt; bcs.next_bci() ) _access_flags.set_has_loops();
 671         break;
 672 
 673       default:
 674         break;
 675     }
 676   }
 677   _access_flags.set_loops_flag_init();
 678   return _access_flags.has_loops();
 679 }
 680 
 681 bool Method::is_final_method(AccessFlags class_access_flags) const {
 682   // or &quot;does_not_require_vtable_entry&quot;
 683   // default method or overpass can occur, is not final (reuses vtable entry)
 684   // private methods in classes get vtable entries for backward class compatibility.
 685   if (is_overpass() || is_default_method())  return false;
 686   return is_final() || class_access_flags.is_final();
 687 }
 688 
 689 bool Method::is_final_method() const {
 690   return is_final_method(method_holder()-&gt;access_flags());
 691 }
 692 
 693 bool Method::is_default_method() const {
 694   if (method_holder() != NULL &amp;&amp;
 695       method_holder()-&gt;is_interface() &amp;&amp;
 696       !is_abstract() &amp;&amp; !is_private()) {
 697     return true;
 698   } else {
 699     return false;
 700   }
 701 }
 702 
 703 bool Method::can_be_statically_bound(AccessFlags class_access_flags) const {
 704   if (is_final_method(class_access_flags))  return true;
 705 #ifdef ASSERT
 706   ResourceMark rm;
 707   bool is_nonv = (vtable_index() == nonvirtual_vtable_index);
 708   if (class_access_flags.is_interface()) {
 709       assert(is_nonv == is_static() || is_nonv == is_private(),
 710              &quot;nonvirtual unexpected for non-static, non-private: %s&quot;,
 711              name_and_sig_as_C_string());
 712   }
 713 #endif
 714   assert(valid_vtable_index() || valid_itable_index(), &quot;method must be linked before we ask this question&quot;);
 715   return vtable_index() == nonvirtual_vtable_index;
 716 }
 717 
 718 bool Method::can_be_statically_bound() const {
 719   return can_be_statically_bound(method_holder()-&gt;access_flags());
 720 }
 721 
 722 bool Method::can_be_statically_bound(InstanceKlass* context) const {
 723   return (method_holder() == context) &amp;&amp; can_be_statically_bound();
 724 }
 725 
 726 bool Method::is_accessor() const {
 727   return is_getter() || is_setter();
 728 }
 729 
 730 bool Method::is_getter() const {
 731   if (code_size() != 5) return false;
 732   if (size_of_parameters() != 1) return false;
 733   if (java_code_at(0) != Bytecodes::_aload_0)  return false;
 734   if (java_code_at(1) != Bytecodes::_getfield) return false;
 735   switch (java_code_at(4)) {
 736     case Bytecodes::_ireturn:
 737     case Bytecodes::_lreturn:
 738     case Bytecodes::_freturn:
 739     case Bytecodes::_dreturn:
 740     case Bytecodes::_areturn:
 741       break;
 742     default:
 743       return false;
 744   }
 745   return true;
 746 }
 747 
 748 bool Method::is_setter() const {
 749   if (code_size() != 6) return false;
 750   if (java_code_at(0) != Bytecodes::_aload_0) return false;
 751   switch (java_code_at(1)) {
 752     case Bytecodes::_iload_1:
 753     case Bytecodes::_aload_1:
 754     case Bytecodes::_fload_1:
 755       if (size_of_parameters() != 2) return false;
 756       break;
 757     case Bytecodes::_dload_1:
 758     case Bytecodes::_lload_1:
 759       if (size_of_parameters() != 3) return false;
 760       break;
 761     default:
 762       return false;
 763   }
 764   if (java_code_at(2) != Bytecodes::_putfield) return false;
 765   if (java_code_at(5) != Bytecodes::_return)   return false;
 766   return true;
 767 }
 768 
 769 bool Method::is_constant_getter() const {
 770   int last_index = code_size() - 1;
 771   // Check if the first 1-3 bytecodes are a constant push
 772   // and the last bytecode is a return.
 773   return (2 &lt;= code_size() &amp;&amp; code_size() &lt;= 4 &amp;&amp;
 774           Bytecodes::is_const(java_code_at(0)) &amp;&amp;
 775           Bytecodes::length_for(java_code_at(0)) == last_index &amp;&amp;
 776           Bytecodes::is_return(java_code_at(last_index)));
 777 }
 778 
 779 bool Method::is_initializer() const {
 780   return is_object_initializer() || is_static_initializer();
 781 }
 782 
 783 bool Method::has_valid_initializer_flags() const {
 784   return (is_static() ||
 785           method_holder()-&gt;major_version() &lt; 51);
 786 }
 787 
 788 bool Method::is_static_initializer() const {
 789   // For classfiles version 51 or greater, ensure that the clinit method is
 790   // static.  Non-static methods with the name &quot;&lt;clinit&gt;&quot; are not static
 791   // initializers. (older classfiles exempted for backward compatibility)
 792   return name() == vmSymbols::class_initializer_name() &amp;&amp;
 793          has_valid_initializer_flags();
 794 }
 795 
 796 bool Method::is_object_initializer() const {
 797    return name() == vmSymbols::object_initializer_name();
 798 }
 799 
 800 bool Method::needs_clinit_barrier() const {
 801   return is_static() &amp;&amp; !method_holder()-&gt;is_initialized();
 802 }
 803 
 804 objArrayHandle Method::resolved_checked_exceptions_impl(Method* method, TRAPS) {
 805   int length = method-&gt;checked_exceptions_length();
 806   if (length == 0) {  // common case
 807     return objArrayHandle(THREAD, Universe::the_empty_class_klass_array());
 808   } else {
 809     methodHandle h_this(THREAD, method);
 810     objArrayOop m_oop = oopFactory::new_objArray(SystemDictionary::Class_klass(), length, CHECK_(objArrayHandle()));
 811     objArrayHandle mirrors (THREAD, m_oop);
 812     for (int i = 0; i &lt; length; i++) {
 813       CheckedExceptionElement* table = h_this-&gt;checked_exceptions_start(); // recompute on each iteration, not gc safe
 814       Klass* k = h_this-&gt;constants()-&gt;klass_at(table[i].class_cp_index, CHECK_(objArrayHandle()));
 815       if (log_is_enabled(Warning, exceptions) &amp;&amp;
 816           !k-&gt;is_subclass_of(SystemDictionary::Throwable_klass())) {
 817         ResourceMark rm(THREAD);
 818         log_warning(exceptions)(
 819           &quot;Class %s in throws clause of method %s is not a subtype of class java.lang.Throwable&quot;,
 820           k-&gt;external_name(), method-&gt;external_name());
 821       }
 822       mirrors-&gt;obj_at_put(i, k-&gt;java_mirror());
 823     }
 824     return mirrors;
 825   }
 826 };
 827 
 828 
 829 int Method::line_number_from_bci(int bci) const {
 830   int best_bci  =  0;
 831   int best_line = -1;
 832   if (bci == SynchronizationEntryBCI) bci = 0;
 833   if (0 &lt;= bci &amp;&amp; bci &lt; code_size() &amp;&amp; has_linenumber_table()) {
 834     // The line numbers are a short array of 2-tuples [start_pc, line_number].
 835     // Not necessarily sorted and not necessarily one-to-one.
 836     CompressedLineNumberReadStream stream(compressed_linenumber_table());
 837     while (stream.read_pair()) {
 838       if (stream.bci() == bci) {
 839         // perfect match
 840         return stream.line();
 841       } else {
 842         // update best_bci/line
 843         if (stream.bci() &lt; bci &amp;&amp; stream.bci() &gt;= best_bci) {
 844           best_bci  = stream.bci();
 845           best_line = stream.line();
 846         }
 847       }
 848     }
 849   }
 850   return best_line;
 851 }
 852 
 853 
 854 bool Method::is_klass_loaded_by_klass_index(int klass_index) const {
 855   if( constants()-&gt;tag_at(klass_index).is_unresolved_klass() ) {
 856     Thread *thread = Thread::current();
 857     Symbol* klass_name = constants()-&gt;klass_name_at(klass_index);
 858     Handle loader(thread, method_holder()-&gt;class_loader());
 859     Handle prot  (thread, method_holder()-&gt;protection_domain());
 860     return SystemDictionary::find(klass_name, loader, prot, thread) != NULL;
 861   } else {
 862     return true;
 863   }
 864 }
 865 
 866 
 867 bool Method::is_klass_loaded(int refinfo_index, bool must_be_resolved) const {
 868   int klass_index = constants()-&gt;klass_ref_index_at(refinfo_index);
 869   if (must_be_resolved) {
 870     // Make sure klass is resolved in constantpool.
 871     if (constants()-&gt;tag_at(klass_index).is_unresolved_klass()) return false;
 872   }
 873   return is_klass_loaded_by_klass_index(klass_index);
 874 }
 875 
 876 
 877 void Method::set_native_function(address function, bool post_event_flag) {
 878   assert(function != NULL, &quot;use clear_native_function to unregister natives&quot;);
 879   assert(!is_method_handle_intrinsic() || function == SharedRuntime::native_method_throw_unsatisfied_link_error_entry(), &quot;&quot;);
 880   address* native_function = native_function_addr();
 881 
 882   // We can see racers trying to place the same native function into place. Once
 883   // is plenty.
 884   address current = *native_function;
 885   if (current == function) return;
 886   if (post_event_flag &amp;&amp; JvmtiExport::should_post_native_method_bind() &amp;&amp;
 887       function != NULL) {
 888     // native_method_throw_unsatisfied_link_error_entry() should only
 889     // be passed when post_event_flag is false.
 890     assert(function !=
 891       SharedRuntime::native_method_throw_unsatisfied_link_error_entry(),
 892       &quot;post_event_flag mis-match&quot;);
 893 
 894     // post the bind event, and possible change the bind function
 895     JvmtiExport::post_native_method_bind(this, &amp;function);
 896   }
 897   *native_function = function;
 898   // This function can be called more than once. We must make sure that we always
 899   // use the latest registered method -&gt; check if a stub already has been generated.
 900   // If so, we have to make it not_entrant.
 901   CompiledMethod* nm = code(); // Put it into local variable to guard against concurrent updates
 902   if (nm != NULL) {
 903     nm-&gt;make_not_entrant();
 904   }
 905 }
 906 
 907 
 908 bool Method::has_native_function() const {
 909   if (is_method_handle_intrinsic())
 910     return false;  // special-cased in SharedRuntime::generate_native_wrapper
 911   address func = native_function();
 912   return (func != NULL &amp;&amp; func != SharedRuntime::native_method_throw_unsatisfied_link_error_entry());
 913 }
 914 
 915 
 916 void Method::clear_native_function() {
 917   // Note: is_method_handle_intrinsic() is allowed here.
 918   set_native_function(
 919     SharedRuntime::native_method_throw_unsatisfied_link_error_entry(),
 920     !native_bind_event_is_interesting);
 921   this-&gt;unlink_code();
 922 }
 923 
 924 
 925 void Method::set_signature_handler(address handler) {
 926   address* signature_handler =  signature_handler_addr();
 927   *signature_handler = handler;
 928 }
 929 
 930 
 931 void Method::print_made_not_compilable(int comp_level, bool is_osr, bool report, const char* reason) {
 932   assert(reason != NULL, &quot;must provide a reason&quot;);
 933   if (PrintCompilation &amp;&amp; report) {
 934     ttyLocker ttyl;
 935     tty-&gt;print(&quot;made not %scompilable on &quot;, is_osr ? &quot;OSR &quot; : &quot;&quot;);
 936     if (comp_level == CompLevel_all) {
 937       tty-&gt;print(&quot;all levels &quot;);
 938     } else {
 939       tty-&gt;print(&quot;level %d &quot;, comp_level);
 940     }
 941     this-&gt;print_short_name(tty);
 942     int size = this-&gt;code_size();
 943     if (size &gt; 0) {
 944       tty-&gt;print(&quot; (%d bytes)&quot;, size);
 945     }
 946     if (reason != NULL) {
 947       tty-&gt;print(&quot;   %s&quot;, reason);
 948     }
 949     tty-&gt;cr();
 950   }
 951   if ((TraceDeoptimization || LogCompilation) &amp;&amp; (xtty != NULL)) {
 952     ttyLocker ttyl;
 953     xtty-&gt;begin_elem(&quot;make_not_compilable thread=&#39;&quot; UINTX_FORMAT &quot;&#39; osr=&#39;%d&#39; level=&#39;%d&#39;&quot;,
 954                      os::current_thread_id(), is_osr, comp_level);
 955     if (reason != NULL) {
 956       xtty-&gt;print(&quot; reason=\&#39;%s\&#39;&quot;, reason);
 957     }
 958     xtty-&gt;method(this);
 959     xtty-&gt;stamp();
 960     xtty-&gt;end_elem();
 961   }
 962 }
 963 
 964 bool Method::is_always_compilable() const {
 965   // Generated adapters must be compiled
 966   if (is_method_handle_intrinsic() &amp;&amp; is_synthetic()) {
 967     assert(!is_not_c1_compilable(), &quot;sanity check&quot;);
 968     assert(!is_not_c2_compilable(), &quot;sanity check&quot;);
 969     return true;
 970   }
 971 
 972   return false;
 973 }
 974 
 975 bool Method::is_not_compilable(int comp_level) const {
 976   if (number_of_breakpoints() &gt; 0)
 977     return true;
 978   if (is_always_compilable())
 979     return false;
 980   if (comp_level == CompLevel_any)
 981     return is_not_c1_compilable() || is_not_c2_compilable();
 982   if (is_c1_compile(comp_level))
 983     return is_not_c1_compilable();
 984   if (is_c2_compile(comp_level))
 985     return is_not_c2_compilable();
 986   return false;
 987 }
 988 
 989 // call this when compiler finds that this method is not compilable
 990 void Method::set_not_compilable(const char* reason, int comp_level, bool report) {
 991   if (is_always_compilable()) {
 992     // Don&#39;t mark a method which should be always compilable
 993     return;
 994   }
 995   print_made_not_compilable(comp_level, /*is_osr*/ false, report, reason);
 996   if (comp_level == CompLevel_all) {
 997     set_not_c1_compilable();
 998     set_not_c2_compilable();
 999   } else {
1000     if (is_c1_compile(comp_level))
1001       set_not_c1_compilable();
1002     if (is_c2_compile(comp_level))
1003       set_not_c2_compilable();
1004   }
1005   assert(!CompilationPolicy::can_be_compiled(methodHandle(Thread::current(), this), comp_level), &quot;sanity check&quot;);
1006 }
1007 
1008 bool Method::is_not_osr_compilable(int comp_level) const {
1009   if (is_not_compilable(comp_level))
1010     return true;
1011   if (comp_level == CompLevel_any)
1012     return is_not_c1_osr_compilable() || is_not_c2_osr_compilable();
1013   if (is_c1_compile(comp_level))
1014     return is_not_c1_osr_compilable();
1015   if (is_c2_compile(comp_level))
1016     return is_not_c2_osr_compilable();
1017   return false;
1018 }
1019 
1020 void Method::set_not_osr_compilable(const char* reason, int comp_level, bool report) {
1021   print_made_not_compilable(comp_level, /*is_osr*/ true, report, reason);
1022   if (comp_level == CompLevel_all) {
1023     set_not_c1_osr_compilable();
1024     set_not_c2_osr_compilable();
1025   } else {
1026     if (is_c1_compile(comp_level))
1027       set_not_c1_osr_compilable();
1028     if (is_c2_compile(comp_level))
1029       set_not_c2_osr_compilable();
1030   }
1031   assert(!CompilationPolicy::can_be_osr_compiled(methodHandle(Thread::current(), this), comp_level), &quot;sanity check&quot;);
1032 }
1033 
1034 // Revert to using the interpreter and clear out the nmethod
1035 void Method::clear_code() {
1036   // this may be NULL if c2i adapters have not been made yet
1037   // Only should happen at allocate time.
1038   if (adapter() == NULL) {
1039     _from_compiled_entry    = NULL;
1040   } else {
1041     _from_compiled_entry    = adapter()-&gt;get_c2i_entry();
1042   }
1043   OrderAccess::storestore();
1044   _from_interpreted_entry = _i2i_entry;
1045   OrderAccess::storestore();
1046   _code = NULL;
1047 }
1048 
1049 void Method::unlink_code(CompiledMethod *compare) {
1050   MutexLocker ml(CompiledMethod_lock-&gt;owned_by_self() ? NULL : CompiledMethod_lock, Mutex::_no_safepoint_check_flag);
1051   // We need to check if either the _code or _from_compiled_code_entry_point
1052   // refer to this nmethod because there is a race in setting these two fields
1053   // in Method* as seen in bugid 4947125.
1054   // If the vep() points to the zombie nmethod, the memory for the nmethod
1055   // could be flushed and the compiler and vtable stubs could still call
1056   // through it.
1057   if (code() == compare ||
1058       from_compiled_entry() == compare-&gt;verified_entry_point()) {
1059     clear_code();
1060   }
1061 }
1062 
1063 void Method::unlink_code() {
1064   MutexLocker ml(CompiledMethod_lock-&gt;owned_by_self() ? NULL : CompiledMethod_lock, Mutex::_no_safepoint_check_flag);
1065   clear_code();
1066 }
1067 
1068 #if INCLUDE_CDS
1069 // Called by class data sharing to remove any entry points (which are not shared)
1070 void Method::unlink_method() {
1071   _code = NULL;
1072 
1073   Arguments::assert_is_dumping_archive();
1074   // Set the values to what they should be at run time. Note that
1075   // this Method can no longer be executed during dump time.
1076   _i2i_entry = Interpreter::entry_for_cds_method(methodHandle(Thread::current(), this));
1077   _from_interpreted_entry = _i2i_entry;
1078 
1079   if (DynamicDumpSharedSpaces) {
1080     assert(_from_compiled_entry != NULL, &quot;sanity&quot;);
1081   } else {
1082     // TODO: Simplify the adapter trampoline allocation for static archiving.
1083     //       Remove the use of CDSAdapterHandlerEntry.
1084     CDSAdapterHandlerEntry* cds_adapter = (CDSAdapterHandlerEntry*)adapter();
1085     constMethod()-&gt;set_adapter_trampoline(cds_adapter-&gt;get_adapter_trampoline());
1086     _from_compiled_entry = cds_adapter-&gt;get_c2i_entry_trampoline();
1087     assert(*((int*)_from_compiled_entry) == 0,
1088            &quot;must be NULL during dump time, to be initialized at run time&quot;);
1089   }
1090 
1091   if (is_native()) {
1092     *native_function_addr() = NULL;
1093     set_signature_handler(NULL);
1094   }
1095   NOT_PRODUCT(set_compiled_invocation_count(0);)
1096 
1097   set_method_data(NULL);
1098   clear_method_counters();
1099 }
1100 #endif
1101 
1102 /****************************************************************************
1103 // The following illustrates how the entries work for CDS shared Methods:
1104 //
1105 // Our goal is to delay writing into a shared Method until it&#39;s compiled.
1106 // Hence, we want to determine the initial values for _i2i_entry,
1107 // _from_interpreted_entry and _from_compiled_entry during CDS dump time.
1108 //
1109 // In this example, both Methods A and B have the _i2i_entry of &quot;zero_locals&quot;.
1110 // They also have similar signatures so that they will share the same
1111 // AdapterHandlerEntry.
1112 //
1113 // _adapter_trampoline points to a fixed location in the RW section of
1114 // the CDS archive. This location initially contains a NULL pointer. When the
1115 // first of method A or B is linked, an AdapterHandlerEntry is allocated
1116 // dynamically, and its c2i/i2c entries are generated.
1117 //
1118 // _i2i_entry and _from_interpreted_entry initially points to the same
1119 // (fixed) location in the CODE section of the CDS archive. This contains
1120 // an unconditional branch to the actual entry for &quot;zero_locals&quot;, which is
1121 // generated at run time and may be on an arbitrary address. Thus, the
1122 // unconditional branch is also generated at run time to jump to the correct
1123 // address.
1124 //
1125 // Similarly, _from_compiled_entry points to a fixed address in the CODE
1126 // section. This address has enough space for an unconditional branch
1127 // instruction, and is initially zero-filled. After the AdapterHandlerEntry is
1128 // initialized, and the address for the actual c2i_entry is known, we emit a
1129 // branch instruction here to branch to the actual c2i_entry.
1130 //
1131 // The effect of the extra branch on the i2i and c2i entries is negligible.
1132 //
1133 // The reason for putting _adapter_trampoline in RO is many shared Methods
1134 // share the same AdapterHandlerEntry, so we can save space in the RW section
1135 // by having the extra indirection.
1136 
1137 
1138 [Method A: RW]
1139   _constMethod ----&gt; [ConstMethod: RO]
1140                        _adapter_trampoline -----------+
1141                                                       |
1142   _i2i_entry              (same value as method B)    |
1143   _from_interpreted_entry (same value as method B)    |
1144   _from_compiled_entry    (same value as method B)    |
1145                                                       |
1146                                                       |
1147 [Method B: RW]                               +--------+
1148   _constMethod ----&gt; [ConstMethod: RO]       |
1149                        _adapter_trampoline --+---&gt;(AdapterHandlerEntry* ptr: RW)-+
1150                                                                                  |
1151                                                  +-------------------------------+
1152                                                  |
1153                                                  +----&gt; [AdapterHandlerEntry] (allocated at run time)
1154                                                               _fingerprint
1155                                                               _c2i_entry ---------------------------------+-&gt;[c2i entry..]
1156  _i2i_entry  -------------+                                   _i2c_entry ---------------+-&gt; [i2c entry..] |
1157  _from_interpreted_entry  |                                   _c2i_unverified_entry     |                 |
1158          |                |                                   _c2i_no_clinit_check_entry|                 |
1159          |                |  (_cds_entry_table: CODE)                                   |                 |
1160          |                +-&gt;[0]: jmp _entry_table[0] --&gt; (i2i_entry_for &quot;zero_locals&quot;) |                 |
1161          |                |                               (allocated at run time)       |                 |
1162          |                |  ...                           [asm code ...]               |                 |
1163          +-[not compiled]-+  [n]: jmp _entry_table[n]                                   |                 |
1164          |                                                                              |                 |
1165          |                                                                              |                 |
1166          +-[compiled]-------------------------------------------------------------------+                 |
1167                                                                                                           |
1168  _from_compiled_entry------------&gt;  (_c2i_entry_trampoline: CODE)                                         |
1169                                     [jmp c2i_entry] ------------------------------------------------------+
1170 
1171 ***/
1172 
1173 // Called when the method_holder is getting linked. Setup entrypoints so the method
1174 // is ready to be called from interpreter, compiler, and vtables.
1175 void Method::link_method(const methodHandle&amp; h_method, TRAPS) {
1176   // If the code cache is full, we may reenter this function for the
1177   // leftover methods that weren&#39;t linked.
1178   if (is_shared()) {
1179 #ifdef ASSERT
1180     address entry = Interpreter::entry_for_cds_method(h_method);
1181     assert(entry != NULL &amp;&amp; entry == _i2i_entry,
1182            &quot;should be correctly set during dump time&quot;);
1183 #endif
1184     if (adapter() != NULL) {
1185       return;
1186     }
1187     assert(entry == _from_interpreted_entry,
1188            &quot;should be correctly set during dump time&quot;);
1189   } else if (_i2i_entry != NULL) {
1190     return;
1191   }
1192   assert( _code == NULL, &quot;nothing compiled yet&quot; );
1193 
1194   // Setup interpreter entrypoint
1195   assert(this == h_method(), &quot;wrong h_method()&quot; );
1196 
1197   if (!is_shared()) {
1198     assert(adapter() == NULL, &quot;init&#39;d to NULL&quot;);
1199     address entry = Interpreter::entry_for_method(h_method);
1200     assert(entry != NULL, &quot;interpreter entry must be non-null&quot;);
1201     // Sets both _i2i_entry and _from_interpreted_entry
1202     set_interpreter_entry(entry);
1203   }
1204 
1205   // Don&#39;t overwrite already registered native entries.
1206   if (is_native() &amp;&amp; !has_native_function()) {
1207     set_native_function(
1208       SharedRuntime::native_method_throw_unsatisfied_link_error_entry(),
1209       !native_bind_event_is_interesting);
1210   }
1211 
1212   // Setup compiler entrypoint.  This is made eagerly, so we do not need
1213   // special handling of vtables.  An alternative is to make adapters more
1214   // lazily by calling make_adapter() from from_compiled_entry() for the
1215   // normal calls.  For vtable calls life gets more complicated.  When a
1216   // call-site goes mega-morphic we need adapters in all methods which can be
1217   // called from the vtable.  We need adapters on such methods that get loaded
1218   // later.  Ditto for mega-morphic itable calls.  If this proves to be a
1219   // problem we&#39;ll make these lazily later.
1220   (void) make_adapters(h_method, CHECK);
1221 
1222   // ONLY USE the h_method now as make_adapter may have blocked
1223 
1224 }
1225 
1226 address Method::make_adapters(const methodHandle&amp; mh, TRAPS) {
1227   // Adapters for compiled code are made eagerly here.  They are fairly
1228   // small (generally &lt; 100 bytes) and quick to make (and cached and shared)
1229   // so making them eagerly shouldn&#39;t be too expensive.
1230   AdapterHandlerEntry* adapter = AdapterHandlerLibrary::get_adapter(mh);
1231   if (adapter == NULL ) {
1232     if (!is_init_completed()) {
1233       // Don&#39;t throw exceptions during VM initialization because java.lang.* classes
1234       // might not have been initialized, causing problems when constructing the
1235       // Java exception object.
1236       vm_exit_during_initialization(&quot;Out of space in CodeCache for adapters&quot;);
1237     } else {
1238       THROW_MSG_NULL(vmSymbols::java_lang_VirtualMachineError(), &quot;Out of space in CodeCache for adapters&quot;);
1239     }
1240   }
1241 
1242   if (mh-&gt;is_shared()) {
1243     assert(mh-&gt;adapter() == adapter, &quot;must be&quot;);
1244     assert(mh-&gt;_from_compiled_entry != NULL, &quot;must be&quot;);
1245   } else {
1246     mh-&gt;set_adapter_entry(adapter);
1247     mh-&gt;_from_compiled_entry = adapter-&gt;get_c2i_entry();
1248   }
1249   return adapter-&gt;get_c2i_entry();
1250 }
1251 
1252 void Method::restore_unshareable_info(TRAPS) {
1253   assert(is_method() &amp;&amp; is_valid_method(this), &quot;ensure C++ vtable is restored&quot;);
1254 
1255   // Since restore_unshareable_info can be called more than once for a method, don&#39;t
1256   // redo any work.
1257   if (adapter() == NULL) {
1258     methodHandle mh(THREAD, this);
1259     link_method(mh, CHECK);
1260   }
1261 }
1262 
1263 address Method::from_compiled_entry_no_trampoline() const {
1264   CompiledMethod *code = Atomic::load_acquire(&amp;_code);
1265   if (code) {
1266     return code-&gt;verified_entry_point();
1267   } else {
1268     return adapter()-&gt;get_c2i_entry();
1269   }
1270 }
1271 
1272 // The verified_code_entry() must be called when a invoke is resolved
1273 // on this method.
1274 
1275 // It returns the compiled code entry point, after asserting not null.
1276 // This function is called after potential safepoints so that nmethod
1277 // or adapter that it points to is still live and valid.
1278 // This function must not hit a safepoint!
1279 address Method::verified_code_entry() {
1280   debug_only(NoSafepointVerifier nsv;)
1281   assert(_from_compiled_entry != NULL, &quot;must be set&quot;);
1282   return _from_compiled_entry;
1283 }
1284 
1285 // Check that if an nmethod ref exists, it has a backlink to this or no backlink at all
1286 // (could be racing a deopt).
1287 // Not inline to avoid circular ref.
1288 bool Method::check_code() const {
1289   // cached in a register or local.  There&#39;s a race on the value of the field.
1290   CompiledMethod *code = Atomic::load_acquire(&amp;_code);
1291   return code == NULL || (code-&gt;method() == NULL) || (code-&gt;method() == (Method*)this &amp;&amp; !code-&gt;is_osr_method());
1292 }
1293 
1294 // Install compiled code.  Instantly it can execute.
1295 void Method::set_code(const methodHandle&amp; mh, CompiledMethod *code) {
1296   assert_lock_strong(CompiledMethod_lock);
1297   assert( code, &quot;use clear_code to remove code&quot; );
1298   assert( mh-&gt;check_code(), &quot;&quot; );
1299 
1300   guarantee(mh-&gt;adapter() != NULL, &quot;Adapter blob must already exist!&quot;);
1301 
1302   // These writes must happen in this order, because the interpreter will
1303   // directly jump to from_interpreted_entry which jumps to an i2c adapter
1304   // which jumps to _from_compiled_entry.
1305   mh-&gt;_code = code;             // Assign before allowing compiled code to exec
1306 
1307   int comp_level = code-&gt;comp_level();
1308   // In theory there could be a race here. In practice it is unlikely
1309   // and not worth worrying about.
1310   if (comp_level &gt; mh-&gt;highest_comp_level()) {
1311     mh-&gt;set_highest_comp_level(comp_level);
1312   }
1313 
1314   OrderAccess::storestore();
1315   mh-&gt;_from_compiled_entry = code-&gt;verified_entry_point();
1316   OrderAccess::storestore();
1317   // Instantly compiled code can execute.
1318   if (!mh-&gt;is_method_handle_intrinsic())
1319     mh-&gt;_from_interpreted_entry = mh-&gt;get_i2c_entry();
1320 }
1321 
1322 
1323 bool Method::is_overridden_in(Klass* k) const {
1324   InstanceKlass* ik = InstanceKlass::cast(k);
1325 
1326   if (ik-&gt;is_interface()) return false;
1327 
1328   // If method is an interface, we skip it - except if it
1329   // is a miranda method
1330   if (method_holder()-&gt;is_interface()) {
1331     // Check that method is not a miranda method
1332     if (ik-&gt;lookup_method(name(), signature()) == NULL) {
1333       // No implementation exist - so miranda method
1334       return false;
1335     }
1336     return true;
1337   }
1338 
1339   assert(ik-&gt;is_subclass_of(method_holder()), &quot;should be subklass&quot;);
1340   if (!has_vtable_index()) {
1341     return false;
1342   } else {
1343     Method* vt_m = ik-&gt;method_at_vtable(vtable_index());
1344     return vt_m != this;
1345   }
1346 }
1347 
1348 
1349 // give advice about whether this Method* should be cached or not
1350 bool Method::should_not_be_cached() const {
1351   if (is_old()) {
1352     // This method has been redefined. It is either EMCP or obsolete
1353     // and we don&#39;t want to cache it because that would pin the method
1354     // down and prevent it from being collectible if and when it
1355     // finishes executing.
1356     return true;
1357   }
1358 
1359   // caching this method should be just fine
1360   return false;
1361 }
1362 
1363 
1364 /**
1365  *  Returns true if this is one of the specially treated methods for
1366  *  security related stack walks (like Reflection.getCallerClass).
1367  */
1368 bool Method::is_ignored_by_security_stack_walk() const {
1369   if (intrinsic_id() == vmIntrinsics::_invoke) {
1370     // This is Method.invoke() -- ignore it
1371     return true;
1372   }
1373   if (method_holder()-&gt;is_subclass_of(SystemDictionary::reflect_MethodAccessorImpl_klass())) {
1374     // This is an auxilary frame -- ignore it
1375     return true;
1376   }
1377   if (is_method_handle_intrinsic() || is_compiled_lambda_form()) {
1378     // This is an internal adapter frame for method handles -- ignore it
1379     return true;
1380   }
1381   return false;
1382 }
1383 
1384 
1385 // Constant pool structure for invoke methods:
1386 enum {
1387   _imcp_invoke_name = 1,        // utf8: &#39;invokeExact&#39;, etc.
1388   _imcp_invoke_signature,       // utf8: (variable Symbol*)
1389   _imcp_limit
1390 };
1391 
1392 // Test if this method is an MH adapter frame generated by Java code.
1393 // Cf. java/lang/invoke/InvokerBytecodeGenerator
1394 bool Method::is_compiled_lambda_form() const {
1395   return intrinsic_id() == vmIntrinsics::_compiledLambdaForm;
1396 }
1397 
1398 // Test if this method is an internal MH primitive method.
1399 bool Method::is_method_handle_intrinsic() const {
1400   vmIntrinsics::ID iid = intrinsic_id();
1401   return (MethodHandles::is_signature_polymorphic(iid) &amp;&amp;
1402           MethodHandles::is_signature_polymorphic_intrinsic(iid));
1403 }
1404 
1405 bool Method::has_member_arg() const {
1406   vmIntrinsics::ID iid = intrinsic_id();
1407   return (MethodHandles::is_signature_polymorphic(iid) &amp;&amp;
1408           MethodHandles::has_member_arg(iid));
1409 }
1410 
1411 // Make an instance of a signature-polymorphic internal MH primitive.
1412 methodHandle Method::make_method_handle_intrinsic(vmIntrinsics::ID iid,
1413                                                          Symbol* signature,
1414                                                          TRAPS) {
1415   ResourceMark rm(THREAD);
1416   methodHandle empty;
1417 
1418   InstanceKlass* holder = SystemDictionary::MethodHandle_klass();
1419   Symbol* name = MethodHandles::signature_polymorphic_intrinsic_name(iid);
1420   assert(iid == MethodHandles::signature_polymorphic_name_id(name), &quot;&quot;);
1421 
1422   log_info(methodhandles)(&quot;make_method_handle_intrinsic MH.%s%s&quot;, name-&gt;as_C_string(), signature-&gt;as_C_string());
1423 
1424   // invariant:   cp-&gt;symbol_at_put is preceded by a refcount increment (more usually a lookup)
1425   name-&gt;increment_refcount();
1426   signature-&gt;increment_refcount();
1427 
1428   int cp_length = _imcp_limit;
1429   ClassLoaderData* loader_data = holder-&gt;class_loader_data();
1430   constantPoolHandle cp;
1431   {
1432     ConstantPool* cp_oop = ConstantPool::allocate(loader_data, cp_length, CHECK_(empty));
1433     cp = constantPoolHandle(THREAD, cp_oop);
1434   }
1435   cp-&gt;copy_fields(holder-&gt;constants());
1436   cp-&gt;set_pool_holder(holder);
1437   cp-&gt;symbol_at_put(_imcp_invoke_name,       name);
1438   cp-&gt;symbol_at_put(_imcp_invoke_signature,  signature);
1439   cp-&gt;set_has_preresolution();
1440 
1441   // decide on access bits:  public or not?
1442   int flags_bits = (JVM_ACC_NATIVE | JVM_ACC_SYNTHETIC | JVM_ACC_FINAL);
1443   bool must_be_static = MethodHandles::is_signature_polymorphic_static(iid);
1444   if (must_be_static)  flags_bits |= JVM_ACC_STATIC;
1445   assert((flags_bits &amp; JVM_ACC_PUBLIC) == 0, &quot;do not expose these methods&quot;);
1446 
1447   methodHandle m;
1448   {
1449     InlineTableSizes sizes;
1450     Method* m_oop = Method::allocate(loader_data, 0,
1451                                      accessFlags_from(flags_bits), &amp;sizes,
1452                                      ConstMethod::NORMAL, CHECK_(empty));
1453     m = methodHandle(THREAD, m_oop);
1454   }
1455   m-&gt;set_constants(cp());
1456   m-&gt;set_name_index(_imcp_invoke_name);
1457   m-&gt;set_signature_index(_imcp_invoke_signature);
1458   assert(MethodHandles::is_signature_polymorphic_name(m-&gt;name()), &quot;&quot;);
1459   assert(m-&gt;signature() == signature, &quot;&quot;);
1460   m-&gt;compute_from_signature(signature);
1461   m-&gt;init_intrinsic_id();
1462   assert(m-&gt;is_method_handle_intrinsic(), &quot;&quot;);
1463 #ifdef ASSERT
1464   if (!MethodHandles::is_signature_polymorphic(m-&gt;intrinsic_id()))  m-&gt;print();
1465   assert(MethodHandles::is_signature_polymorphic(m-&gt;intrinsic_id()), &quot;must be an invoker&quot;);
1466   assert(m-&gt;intrinsic_id() == iid, &quot;correctly predicted iid&quot;);
1467 #endif //ASSERT
1468 
1469   // Finally, set up its entry points.
1470   assert(m-&gt;can_be_statically_bound(), &quot;&quot;);
1471   m-&gt;set_vtable_index(Method::nonvirtual_vtable_index);
1472   m-&gt;link_method(m, CHECK_(empty));
1473 
1474   if (log_is_enabled(Info, methodhandles) &amp;&amp; (Verbose || WizardMode)) {
1475     LogTarget(Info, methodhandles) lt;
1476     LogStream ls(lt);
1477     m-&gt;print_on(&amp;ls);
1478   }
1479 
1480   return m;
1481 }
1482 
1483 Klass* Method::check_non_bcp_klass(Klass* klass) {
1484   if (klass != NULL &amp;&amp; klass-&gt;class_loader() != NULL) {
1485     if (klass-&gt;is_objArray_klass())
1486       klass = ObjArrayKlass::cast(klass)-&gt;bottom_klass();
1487     return klass;
1488   }
1489   return NULL;
1490 }
1491 
1492 
1493 methodHandle Method::clone_with_new_data(const methodHandle&amp; m, u_char* new_code, int new_code_length,
1494                                                 u_char* new_compressed_linenumber_table, int new_compressed_linenumber_size, TRAPS) {
1495   // Code below does not work for native methods - they should never get rewritten anyway
1496   assert(!m-&gt;is_native(), &quot;cannot rewrite native methods&quot;);
1497   // Allocate new Method*
1498   AccessFlags flags = m-&gt;access_flags();
1499 
1500   ConstMethod* cm = m-&gt;constMethod();
1501   int checked_exceptions_len = cm-&gt;checked_exceptions_length();
1502   int localvariable_len = cm-&gt;localvariable_table_length();
1503   int exception_table_len = cm-&gt;exception_table_length();
1504   int method_parameters_len = cm-&gt;method_parameters_length();
1505   int method_annotations_len = cm-&gt;method_annotations_length();
1506   int parameter_annotations_len = cm-&gt;parameter_annotations_length();
1507   int type_annotations_len = cm-&gt;type_annotations_length();
1508   int default_annotations_len = cm-&gt;default_annotations_length();
1509 
1510   InlineTableSizes sizes(
1511       localvariable_len,
1512       new_compressed_linenumber_size,
1513       exception_table_len,
1514       checked_exceptions_len,
1515       method_parameters_len,
1516       cm-&gt;generic_signature_index(),
1517       method_annotations_len,
1518       parameter_annotations_len,
1519       type_annotations_len,
1520       default_annotations_len,
1521       0);
1522 
1523   ClassLoaderData* loader_data = m-&gt;method_holder()-&gt;class_loader_data();
1524   Method* newm_oop = Method::allocate(loader_data,
1525                                       new_code_length,
1526                                       flags,
1527                                       &amp;sizes,
1528                                       m-&gt;method_type(),
1529                                       CHECK_(methodHandle()));
1530   methodHandle newm (THREAD, newm_oop);
1531 
1532   // Create a shallow copy of Method part, but be careful to preserve the new ConstMethod*
1533   ConstMethod* newcm = newm-&gt;constMethod();
1534   int new_const_method_size = newm-&gt;constMethod()-&gt;size();
1535 
1536   // This works because the source and target are both Methods. Some compilers
1537   // (e.g., clang) complain that the target vtable pointer will be stomped,
1538   // so cast away newm()&#39;s and m()&#39;s Methodness.
1539   memcpy((void*)newm(), (void*)m(), sizeof(Method));
1540 
1541   // Create shallow copy of ConstMethod.
1542   memcpy(newcm, m-&gt;constMethod(), sizeof(ConstMethod));
1543 
1544   // Reset correct method/const method, method size, and parameter info
1545   newm-&gt;set_constMethod(newcm);
1546   newm-&gt;constMethod()-&gt;set_code_size(new_code_length);
1547   newm-&gt;constMethod()-&gt;set_constMethod_size(new_const_method_size);
1548   assert(newm-&gt;code_size() == new_code_length, &quot;check&quot;);
1549   assert(newm-&gt;method_parameters_length() == method_parameters_len, &quot;check&quot;);
1550   assert(newm-&gt;checked_exceptions_length() == checked_exceptions_len, &quot;check&quot;);
1551   assert(newm-&gt;exception_table_length() == exception_table_len, &quot;check&quot;);
1552   assert(newm-&gt;localvariable_table_length() == localvariable_len, &quot;check&quot;);
1553   // Copy new byte codes
1554   memcpy(newm-&gt;code_base(), new_code, new_code_length);
1555   // Copy line number table
1556   if (new_compressed_linenumber_size &gt; 0) {
1557     memcpy(newm-&gt;compressed_linenumber_table(),
1558            new_compressed_linenumber_table,
1559            new_compressed_linenumber_size);
1560   }
1561   // Copy method_parameters
1562   if (method_parameters_len &gt; 0) {
1563     memcpy(newm-&gt;method_parameters_start(),
1564            m-&gt;method_parameters_start(),
1565            method_parameters_len * sizeof(MethodParametersElement));
1566   }
1567   // Copy checked_exceptions
1568   if (checked_exceptions_len &gt; 0) {
1569     memcpy(newm-&gt;checked_exceptions_start(),
1570            m-&gt;checked_exceptions_start(),
1571            checked_exceptions_len * sizeof(CheckedExceptionElement));
1572   }
1573   // Copy exception table
1574   if (exception_table_len &gt; 0) {
1575     memcpy(newm-&gt;exception_table_start(),
1576            m-&gt;exception_table_start(),
1577            exception_table_len * sizeof(ExceptionTableElement));
1578   }
1579   // Copy local variable number table
1580   if (localvariable_len &gt; 0) {
1581     memcpy(newm-&gt;localvariable_table_start(),
1582            m-&gt;localvariable_table_start(),
1583            localvariable_len * sizeof(LocalVariableTableElement));
1584   }
1585   // Copy stackmap table
1586   if (m-&gt;has_stackmap_table()) {
1587     int code_attribute_length = m-&gt;stackmap_data()-&gt;length();
1588     Array&lt;u1&gt;* stackmap_data =
1589       MetadataFactory::new_array&lt;u1&gt;(loader_data, code_attribute_length, 0, CHECK_(methodHandle()));
1590     memcpy((void*)stackmap_data-&gt;adr_at(0),
1591            (void*)m-&gt;stackmap_data()-&gt;adr_at(0), code_attribute_length);
1592     newm-&gt;set_stackmap_data(stackmap_data);
1593   }
1594 
1595   // copy annotations over to new method
1596   newcm-&gt;copy_annotations_from(loader_data, cm, CHECK_(methodHandle()));
1597   return newm;
1598 }
1599 
1600 vmSymbols::SID Method::klass_id_for_intrinsics(const Klass* holder) {
1601   // if loader is not the default loader (i.e., != NULL), we can&#39;t know the intrinsics
1602   // because we are not loading from core libraries
1603   // exception: the AES intrinsics come from lib/ext/sunjce_provider.jar
1604   // which does not use the class default class loader so we check for its loader here
1605   const InstanceKlass* ik = InstanceKlass::cast(holder);
1606   if ((ik-&gt;class_loader() != NULL) &amp;&amp; !SystemDictionary::is_platform_class_loader(ik-&gt;class_loader())) {
1607     return vmSymbols::NO_SID;   // regardless of name, no intrinsics here
1608   }
1609 
1610   // see if the klass name is well-known:
1611   Symbol* klass_name = ik-&gt;name();
1612   return vmSymbols::find_sid(klass_name);
1613 }
1614 
1615 void Method::init_intrinsic_id() {
1616   assert(_intrinsic_id == vmIntrinsics::_none, &quot;do this just once&quot;);
1617   const uintptr_t max_id_uint = right_n_bits((int)(sizeof(_intrinsic_id) * BitsPerByte));
1618   assert((uintptr_t)vmIntrinsics::ID_LIMIT &lt;= max_id_uint, &quot;else fix size&quot;);
1619   assert(intrinsic_id_size_in_bytes() == sizeof(_intrinsic_id), &quot;&quot;);
1620 
1621   // the klass name is well-known:
1622   vmSymbols::SID klass_id = klass_id_for_intrinsics(method_holder());
1623   assert(klass_id != vmSymbols::NO_SID, &quot;caller responsibility&quot;);
1624 
1625   // ditto for method and signature:
1626   vmSymbols::SID  name_id = vmSymbols::find_sid(name());
1627   if (klass_id != vmSymbols::VM_SYMBOL_ENUM_NAME(java_lang_invoke_MethodHandle)
1628       &amp;&amp; klass_id != vmSymbols::VM_SYMBOL_ENUM_NAME(java_lang_invoke_VarHandle)
1629       &amp;&amp; name_id == vmSymbols::NO_SID) {
1630     return;
1631   }
1632   vmSymbols::SID   sig_id = vmSymbols::find_sid(signature());
1633   if (klass_id != vmSymbols::VM_SYMBOL_ENUM_NAME(java_lang_invoke_MethodHandle)
1634       &amp;&amp; klass_id != vmSymbols::VM_SYMBOL_ENUM_NAME(java_lang_invoke_VarHandle)
1635       &amp;&amp; sig_id == vmSymbols::NO_SID) {
1636     return;
1637   }
1638   jshort flags = access_flags().as_short();
1639 
1640   vmIntrinsics::ID id = vmIntrinsics::find_id(klass_id, name_id, sig_id, flags);
1641   if (id != vmIntrinsics::_none) {
1642     set_intrinsic_id(id);
1643     if (id == vmIntrinsics::_Class_cast) {
1644       // Even if the intrinsic is rejected, we want to inline this simple method.
1645       set_force_inline(true);
1646     }
1647     return;
1648   }
1649 
1650   // A few slightly irregular cases:
1651   switch (klass_id) {
1652   case vmSymbols::VM_SYMBOL_ENUM_NAME(java_lang_StrictMath):
1653     // Second chance: check in regular Math.
1654     switch (name_id) {
1655     case vmSymbols::VM_SYMBOL_ENUM_NAME(min_name):
1656     case vmSymbols::VM_SYMBOL_ENUM_NAME(max_name):
1657     case vmSymbols::VM_SYMBOL_ENUM_NAME(sqrt_name):
1658       // pretend it is the corresponding method in the non-strict class:
1659       klass_id = vmSymbols::VM_SYMBOL_ENUM_NAME(java_lang_Math);
1660       id = vmIntrinsics::find_id(klass_id, name_id, sig_id, flags);
1661       break;
1662     default:
1663       break;
1664     }
1665     break;
1666 
1667   // Signature-polymorphic methods: MethodHandle.invoke*, InvokeDynamic.*., VarHandle
1668   case vmSymbols::VM_SYMBOL_ENUM_NAME(java_lang_invoke_MethodHandle):
1669   case vmSymbols::VM_SYMBOL_ENUM_NAME(java_lang_invoke_VarHandle):
1670     if (!is_native())  break;
1671     id = MethodHandles::signature_polymorphic_name_id(method_holder(), name());
1672     if (is_static() != MethodHandles::is_signature_polymorphic_static(id))
1673       id = vmIntrinsics::_none;
1674     break;
1675 
1676   default:
1677     break;
1678   }
1679 
1680   if (id != vmIntrinsics::_none) {
1681     // Set up its iid.  It is an alias method.
1682     set_intrinsic_id(id);
1683     return;
1684   }
1685 }
1686 
1687 bool Method::load_signature_classes(const methodHandle&amp; m, TRAPS) {
1688   if (!THREAD-&gt;can_call_java()) {
1689     // There is nothing useful this routine can do from within the Compile thread.
1690     // Hopefully, the signature contains only well-known classes.
1691     // We could scan for this and return true/false, but the caller won&#39;t care.
1692     return false;
1693   }
1694   bool sig_is_loaded = true;
1695   ResourceMark rm(THREAD);
1696   for (ResolvingSignatureStream ss(m()); !ss.is_done(); ss.next()) {
1697     if (ss.is_reference()) {
1698       // load everything, including arrays &quot;[Lfoo;&quot;
1699       Klass* klass = ss.as_klass(SignatureStream::ReturnNull, THREAD);
1700       // We are loading classes eagerly. If a ClassNotFoundException or
1701       // a LinkageError was generated, be sure to ignore it.
1702       if (HAS_PENDING_EXCEPTION) {
1703         if (PENDING_EXCEPTION-&gt;is_a(SystemDictionary::ClassNotFoundException_klass()) ||
1704             PENDING_EXCEPTION-&gt;is_a(SystemDictionary::LinkageError_klass())) {
1705           CLEAR_PENDING_EXCEPTION;
1706         } else {
1707           return false;
1708         }
1709       }
1710       if( klass == NULL) { sig_is_loaded = false; }
1711     }
1712   }
1713   return sig_is_loaded;
1714 }
1715 
1716 bool Method::has_unloaded_classes_in_signature(const methodHandle&amp; m, TRAPS) {
1717   ResourceMark rm(THREAD);
1718   for(ResolvingSignatureStream ss(m()); !ss.is_done(); ss.next()) {
1719     if (ss.type() == T_OBJECT) {
1720       // Do not use ss.is_reference() here, since we don&#39;t care about
1721       // unloaded array component types.
1722       Klass* klass = ss.as_klass_if_loaded(THREAD);
1723       assert(!HAS_PENDING_EXCEPTION, &quot;as_klass_if_loaded contract&quot;);
1724       if (klass == NULL) return true;
1725     }
1726   }
1727   return false;
1728 }
1729 
1730 // Exposed so field engineers can debug VM
1731 void Method::print_short_name(outputStream* st) {
1732   ResourceMark rm;
1733 #ifdef PRODUCT
1734   st-&gt;print(&quot; %s::&quot;, method_holder()-&gt;external_name());
1735 #else
1736   st-&gt;print(&quot; %s::&quot;, method_holder()-&gt;internal_name());
1737 #endif
1738   name()-&gt;print_symbol_on(st);
1739   if (WizardMode) signature()-&gt;print_symbol_on(st);
1740   else if (MethodHandles::is_signature_polymorphic(intrinsic_id()))
1741     MethodHandles::print_as_basic_type_signature_on(st, signature());
1742 }
1743 
1744 // Comparer for sorting an object array containing
1745 // Method*s.
1746 static int method_comparator(Method* a, Method* b) {
1747   return a-&gt;name()-&gt;fast_compare(b-&gt;name());
1748 }
1749 
1750 // This is only done during class loading, so it is OK to assume method_idnum matches the methods() array
1751 // default_methods also uses this without the ordering for fast find_method
1752 void Method::sort_methods(Array&lt;Method*&gt;* methods, bool set_idnums, method_comparator_func func) {
1753   int length = methods-&gt;length();
1754   if (length &gt; 1) {
1755     if (func == NULL) {
1756       func = method_comparator;
1757     }
1758     {
1759       NoSafepointVerifier nsv;
1760       QuickSort::sort(methods-&gt;data(), length, func, /*idempotent=*/false);
1761     }
1762     // Reset method ordering
1763     if (set_idnums) {
1764       for (int i = 0; i &lt; length; i++) {
1765         Method* m = methods-&gt;at(i);
1766         m-&gt;set_method_idnum(i);
1767         m-&gt;set_orig_method_idnum(i);
1768       }
1769     }
1770   }
1771 }
1772 
1773 //-----------------------------------------------------------------------------------
1774 // Non-product code unless JVM/TI needs it
1775 
1776 #if !defined(PRODUCT) || INCLUDE_JVMTI
1777 class SignatureTypePrinter : public SignatureTypeNames {
1778  private:
1779   outputStream* _st;
1780   bool _use_separator;
1781 
1782   void type_name(const char* name) {
1783     if (_use_separator) _st-&gt;print(&quot;, &quot;);
1784     _st-&gt;print(&quot;%s&quot;, name);
1785     _use_separator = true;
1786   }
1787 
1788  public:
1789   SignatureTypePrinter(Symbol* signature, outputStream* st) : SignatureTypeNames(signature) {
1790     _st = st;
1791     _use_separator = false;
1792   }
1793 
1794   void print_parameters()              { _use_separator = false; do_parameters_on(this); }
1795   void print_returntype()              { _use_separator = false; do_type(return_type()); }
1796 };
1797 
1798 
1799 void Method::print_name(outputStream* st) {
1800   Thread *thread = Thread::current();
1801   ResourceMark rm(thread);
1802   st-&gt;print(&quot;%s &quot;, is_static() ? &quot;static&quot; : &quot;virtual&quot;);
1803   if (WizardMode) {
1804     st-&gt;print(&quot;%s.&quot;, method_holder()-&gt;internal_name());
1805     name()-&gt;print_symbol_on(st);
1806     signature()-&gt;print_symbol_on(st);
1807   } else {
1808     SignatureTypePrinter sig(signature(), st);
1809     sig.print_returntype();
1810     st-&gt;print(&quot; %s.&quot;, method_holder()-&gt;internal_name());
1811     name()-&gt;print_symbol_on(st);
1812     st-&gt;print(&quot;(&quot;);
1813     sig.print_parameters();
1814     st-&gt;print(&quot;)&quot;);
1815   }
1816 }
1817 #endif // !PRODUCT || INCLUDE_JVMTI
1818 
1819 
1820 void Method::print_codes_on(outputStream* st) const {
1821   print_codes_on(0, code_size(), st);
1822 }
1823 
1824 void Method::print_codes_on(int from, int to, outputStream* st) const {
1825   Thread *thread = Thread::current();
1826   ResourceMark rm(thread);
1827   methodHandle mh (thread, (Method*)this);
1828   BytecodeStream s(mh);
1829   s.set_interval(from, to);
1830   BytecodeTracer::set_closure(BytecodeTracer::std_closure());
1831   while (s.next() &gt;= 0) BytecodeTracer::trace(mh, s.bcp(), st);
1832 }
1833 
1834 CompressedLineNumberReadStream::CompressedLineNumberReadStream(u_char* buffer) : CompressedReadStream(buffer) {
1835   _bci = 0;
1836   _line = 0;
1837 };
1838 
1839 bool CompressedLineNumberReadStream::read_pair() {
1840   jubyte next = read_byte();
1841   // Check for terminator
1842   if (next == 0) return false;
1843   if (next == 0xFF) {
1844     // Escape character, regular compression used
1845     _bci  += read_signed_int();
1846     _line += read_signed_int();
1847   } else {
1848     // Single byte compression used
1849     _bci  += next &gt;&gt; 3;
1850     _line += next &amp; 0x7;
1851   }
1852   return true;
1853 }
1854 
1855 #if INCLUDE_JVMTI
1856 
1857 Bytecodes::Code Method::orig_bytecode_at(int bci) const {
1858   BreakpointInfo* bp = method_holder()-&gt;breakpoints();
1859   for (; bp != NULL; bp = bp-&gt;next()) {
1860     if (bp-&gt;match(this, bci)) {
1861       return bp-&gt;orig_bytecode();
1862     }
1863   }
1864   {
1865     ResourceMark rm;
1866     fatal(&quot;no original bytecode found in %s at bci %d&quot;, name_and_sig_as_C_string(), bci);
1867   }
1868   return Bytecodes::_shouldnotreachhere;
1869 }
1870 
1871 void Method::set_orig_bytecode_at(int bci, Bytecodes::Code code) {
1872   assert(code != Bytecodes::_breakpoint, &quot;cannot patch breakpoints this way&quot;);
1873   BreakpointInfo* bp = method_holder()-&gt;breakpoints();
1874   for (; bp != NULL; bp = bp-&gt;next()) {
1875     if (bp-&gt;match(this, bci)) {
1876       bp-&gt;set_orig_bytecode(code);
1877       // and continue, in case there is more than one
1878     }
1879   }
1880 }
1881 
1882 void Method::set_breakpoint(int bci) {
1883   InstanceKlass* ik = method_holder();
1884   BreakpointInfo *bp = new BreakpointInfo(this, bci);
1885   bp-&gt;set_next(ik-&gt;breakpoints());
1886   ik-&gt;set_breakpoints(bp);
1887   // do this last:
1888   bp-&gt;set(this);
1889 }
1890 
1891 static void clear_matches(Method* m, int bci) {
1892   InstanceKlass* ik = m-&gt;method_holder();
1893   BreakpointInfo* prev_bp = NULL;
1894   BreakpointInfo* next_bp;
1895   for (BreakpointInfo* bp = ik-&gt;breakpoints(); bp != NULL; bp = next_bp) {
1896     next_bp = bp-&gt;next();
1897     // bci value of -1 is used to delete all breakpoints in method m (ex: clear_all_breakpoint).
1898     if (bci &gt;= 0 ? bp-&gt;match(m, bci) : bp-&gt;match(m)) {
1899       // do this first:
1900       bp-&gt;clear(m);
1901       // unhook it
1902       if (prev_bp != NULL)
1903         prev_bp-&gt;set_next(next_bp);
1904       else
1905         ik-&gt;set_breakpoints(next_bp);
1906       delete bp;
1907       // When class is redefined JVMTI sets breakpoint in all versions of EMCP methods
1908       // at same location. So we have multiple matching (method_index and bci)
1909       // BreakpointInfo nodes in BreakpointInfo list. We should just delete one
1910       // breakpoint for clear_breakpoint request and keep all other method versions
1911       // BreakpointInfo for future clear_breakpoint request.
1912       // bcivalue of -1 is used to clear all breakpoints (see clear_all_breakpoints)
1913       // which is being called when class is unloaded. We delete all the Breakpoint
1914       // information for all versions of method. We may not correctly restore the original
1915       // bytecode in all method versions, but that is ok. Because the class is being unloaded
1916       // so these methods won&#39;t be used anymore.
1917       if (bci &gt;= 0) {
1918         break;
1919       }
1920     } else {
1921       // This one is a keeper.
1922       prev_bp = bp;
1923     }
1924   }
1925 }
1926 
1927 void Method::clear_breakpoint(int bci) {
1928   assert(bci &gt;= 0, &quot;&quot;);
1929   clear_matches(this, bci);
1930 }
1931 
1932 void Method::clear_all_breakpoints() {
1933   clear_matches(this, -1);
1934 }
1935 
1936 #endif // INCLUDE_JVMTI
1937 
1938 int Method::invocation_count() {
1939   MethodCounters *mcs = method_counters();
1940   if (TieredCompilation) {
1941     MethodData* const mdo = method_data();
1942     if (((mcs != NULL) ? mcs-&gt;invocation_counter()-&gt;carry() : false) ||
1943         ((mdo != NULL) ? mdo-&gt;invocation_counter()-&gt;carry() : false)) {
1944       return InvocationCounter::count_limit;
1945     } else {
1946       return ((mcs != NULL) ? mcs-&gt;invocation_counter()-&gt;count() : 0) +
1947              ((mdo != NULL) ? mdo-&gt;invocation_counter()-&gt;count() : 0);
1948     }
1949   } else {
1950     return (mcs == NULL) ? 0 : mcs-&gt;invocation_counter()-&gt;count();
1951   }
1952 }
1953 
1954 int Method::backedge_count() {
1955   MethodCounters *mcs = method_counters();
1956   if (TieredCompilation) {
1957     MethodData* const mdo = method_data();
1958     if (((mcs != NULL) ? mcs-&gt;backedge_counter()-&gt;carry() : false) ||
1959         ((mdo != NULL) ? mdo-&gt;backedge_counter()-&gt;carry() : false)) {
1960       return InvocationCounter::count_limit;
1961     } else {
1962       return ((mcs != NULL) ? mcs-&gt;backedge_counter()-&gt;count() : 0) +
1963              ((mdo != NULL) ? mdo-&gt;backedge_counter()-&gt;count() : 0);
1964     }
1965   } else {
1966     return (mcs == NULL) ? 0 : mcs-&gt;backedge_counter()-&gt;count();
1967   }
1968 }
1969 
1970 int Method::highest_comp_level() const {
1971   const MethodCounters* mcs = method_counters();
1972   if (mcs != NULL) {
1973     return mcs-&gt;highest_comp_level();
1974   } else {
1975     return CompLevel_none;
1976   }
1977 }
1978 
1979 int Method::highest_osr_comp_level() const {
1980   const MethodCounters* mcs = method_counters();
1981   if (mcs != NULL) {
1982     return mcs-&gt;highest_osr_comp_level();
1983   } else {
1984     return CompLevel_none;
1985   }
1986 }
1987 
1988 void Method::set_highest_comp_level(int level) {
1989   MethodCounters* mcs = method_counters();
1990   if (mcs != NULL) {
1991     mcs-&gt;set_highest_comp_level(level);
1992   }
1993 }
1994 
1995 void Method::set_highest_osr_comp_level(int level) {
1996   MethodCounters* mcs = method_counters();
1997   if (mcs != NULL) {
1998     mcs-&gt;set_highest_osr_comp_level(level);
1999   }
2000 }
2001 
2002 #if INCLUDE_JVMTI
2003 
2004 BreakpointInfo::BreakpointInfo(Method* m, int bci) {
2005   _bci = bci;
2006   _name_index = m-&gt;name_index();
2007   _signature_index = m-&gt;signature_index();
2008   _orig_bytecode = (Bytecodes::Code) *m-&gt;bcp_from(_bci);
2009   if (_orig_bytecode == Bytecodes::_breakpoint)
2010     _orig_bytecode = m-&gt;orig_bytecode_at(_bci);
2011   _next = NULL;
2012 }
2013 
2014 void BreakpointInfo::set(Method* method) {
2015 #ifdef ASSERT
2016   {
2017     Bytecodes::Code code = (Bytecodes::Code) *method-&gt;bcp_from(_bci);
2018     if (code == Bytecodes::_breakpoint)
2019       code = method-&gt;orig_bytecode_at(_bci);
2020     assert(orig_bytecode() == code, &quot;original bytecode must be the same&quot;);
2021   }
2022 #endif
2023   Thread *thread = Thread::current();
2024   *method-&gt;bcp_from(_bci) = Bytecodes::_breakpoint;
2025   method-&gt;incr_number_of_breakpoints(thread);
2026   {
2027     // Deoptimize all dependents on this method
2028     HandleMark hm(thread);
2029     methodHandle mh(thread, method);
2030     CodeCache::flush_dependents_on_method(mh);
2031   }
2032 }
2033 
2034 void BreakpointInfo::clear(Method* method) {
2035   *method-&gt;bcp_from(_bci) = orig_bytecode();
2036   assert(method-&gt;number_of_breakpoints() &gt; 0, &quot;must not go negative&quot;);
2037   method-&gt;decr_number_of_breakpoints(Thread::current());
2038 }
2039 
2040 #endif // INCLUDE_JVMTI
2041 
2042 // jmethodID handling
2043 
2044 // This is a block allocating object, sort of like JNIHandleBlock, only a
2045 // lot simpler.
2046 // It&#39;s allocated on the CHeap because once we allocate a jmethodID, we can
2047 // never get rid of it.
2048 
2049 static const int min_block_size = 8;
2050 
2051 class JNIMethodBlockNode : public CHeapObj&lt;mtClass&gt; {
2052   friend class JNIMethodBlock;
2053   Method**        _methods;
2054   int             _number_of_methods;
2055   int             _top;
2056   JNIMethodBlockNode* _next;
2057 
2058  public:
2059 
2060   JNIMethodBlockNode(int num_methods = min_block_size);
2061 
2062   ~JNIMethodBlockNode() { FREE_C_HEAP_ARRAY(Method*, _methods); }
2063 
2064   void ensure_methods(int num_addl_methods) {
2065     if (_top &lt; _number_of_methods) {
2066       num_addl_methods -= _number_of_methods - _top;
2067       if (num_addl_methods &lt;= 0) {
2068         return;
2069       }
2070     }
2071     if (_next == NULL) {
2072       _next = new JNIMethodBlockNode(MAX2(num_addl_methods, min_block_size));
2073     } else {
2074       _next-&gt;ensure_methods(num_addl_methods);
2075     }
2076   }
2077 };
2078 
2079 class JNIMethodBlock : public CHeapObj&lt;mtClass&gt; {
2080   JNIMethodBlockNode _head;
2081   JNIMethodBlockNode *_last_free;
2082  public:
2083   static Method* const _free_method;
2084 
2085   JNIMethodBlock(int initial_capacity = min_block_size)
2086       : _head(initial_capacity), _last_free(&amp;_head) {}
2087 
2088   void ensure_methods(int num_addl_methods) {
2089     _last_free-&gt;ensure_methods(num_addl_methods);
2090   }
2091 
2092   Method** add_method(Method* m) {
2093     for (JNIMethodBlockNode* b = _last_free; b != NULL; b = b-&gt;_next) {
2094       if (b-&gt;_top &lt; b-&gt;_number_of_methods) {
2095         // top points to the next free entry.
2096         int i = b-&gt;_top;
2097         b-&gt;_methods[i] = m;
2098         b-&gt;_top++;
2099         _last_free = b;
2100         return &amp;(b-&gt;_methods[i]);
2101       } else if (b-&gt;_top == b-&gt;_number_of_methods) {
2102         // if the next free entry ran off the block see if there&#39;s a free entry
2103         for (int i = 0; i &lt; b-&gt;_number_of_methods; i++) {
2104           if (b-&gt;_methods[i] == _free_method) {
2105             b-&gt;_methods[i] = m;
2106             _last_free = b;
2107             return &amp;(b-&gt;_methods[i]);
2108           }
2109         }
2110         // Only check each block once for frees.  They&#39;re very unlikely.
2111         // Increment top past the end of the block.
2112         b-&gt;_top++;
2113       }
2114       // need to allocate a next block.
2115       if (b-&gt;_next == NULL) {
2116         b-&gt;_next = _last_free = new JNIMethodBlockNode();
2117       }
2118     }
2119     guarantee(false, &quot;Should always allocate a free block&quot;);
2120     return NULL;
2121   }
2122 
2123   bool contains(Method** m) {
2124     if (m == NULL) return false;
2125     for (JNIMethodBlockNode* b = &amp;_head; b != NULL; b = b-&gt;_next) {
2126       if (b-&gt;_methods &lt;= m &amp;&amp; m &lt; b-&gt;_methods + b-&gt;_number_of_methods) {
2127         // This is a bit of extra checking, for two reasons.  One is
2128         // that contains() deals with pointers that are passed in by
2129         // JNI code, so making sure that the pointer is aligned
2130         // correctly is valuable.  The other is that &lt;= and &gt; are
2131         // technically not defined on pointers, so the if guard can
2132         // pass spuriously; no modern compiler is likely to make that
2133         // a problem, though (and if one did, the guard could also
2134         // fail spuriously, which would be bad).
2135         ptrdiff_t idx = m - b-&gt;_methods;
2136         if (b-&gt;_methods + idx == m) {
2137           return true;
2138         }
2139       }
2140     }
2141     return false;  // not found
2142   }
2143 
2144   // Doesn&#39;t really destroy it, just marks it as free so it can be reused.
2145   void destroy_method(Method** m) {
2146 #ifdef ASSERT
2147     assert(contains(m), &quot;should be a methodID&quot;);
2148 #endif // ASSERT
2149     *m = _free_method;
2150   }
2151 
2152   // During class unloading the methods are cleared, which is different
2153   // than freed.
2154   void clear_all_methods() {
2155     for (JNIMethodBlockNode* b = &amp;_head; b != NULL; b = b-&gt;_next) {
2156       for (int i = 0; i&lt; b-&gt;_number_of_methods; i++) {
2157         b-&gt;_methods[i] = NULL;
2158       }
2159     }
2160   }
2161 #ifndef PRODUCT
2162   int count_methods() {
2163     // count all allocated methods
2164     int count = 0;
2165     for (JNIMethodBlockNode* b = &amp;_head; b != NULL; b = b-&gt;_next) {
2166       for (int i = 0; i&lt; b-&gt;_number_of_methods; i++) {
2167         if (b-&gt;_methods[i] != _free_method) count++;
2168       }
2169     }
2170     return count;
2171   }
2172 #endif // PRODUCT
2173 };
2174 
2175 // Something that can&#39;t be mistaken for an address or a markWord
2176 Method* const JNIMethodBlock::_free_method = (Method*)55;
2177 
2178 JNIMethodBlockNode::JNIMethodBlockNode(int num_methods) : _top(0), _next(NULL) {
2179   _number_of_methods = MAX2(num_methods, min_block_size);
2180   _methods = NEW_C_HEAP_ARRAY(Method*, _number_of_methods, mtInternal);
2181   for (int i = 0; i &lt; _number_of_methods; i++) {
2182     _methods[i] = JNIMethodBlock::_free_method;
2183   }
2184 }
2185 
2186 void Method::ensure_jmethod_ids(ClassLoaderData* loader_data, int capacity) {
2187   ClassLoaderData* cld = loader_data;
2188   if (!SafepointSynchronize::is_at_safepoint()) {
2189     // Have to add jmethod_ids() to class loader data thread-safely.
2190     // Also have to add the method to the list safely, which the cld lock
2191     // protects as well.
2192     MutexLocker ml(cld-&gt;metaspace_lock(),  Mutex::_no_safepoint_check_flag);
2193     if (cld-&gt;jmethod_ids() == NULL) {
2194       cld-&gt;set_jmethod_ids(new JNIMethodBlock(capacity));
2195     } else {
2196       cld-&gt;jmethod_ids()-&gt;ensure_methods(capacity);
2197     }
2198   } else {
2199     // At safepoint, we are single threaded and can set this.
2200     if (cld-&gt;jmethod_ids() == NULL) {
2201       cld-&gt;set_jmethod_ids(new JNIMethodBlock(capacity));
2202     } else {
2203       cld-&gt;jmethod_ids()-&gt;ensure_methods(capacity);
2204     }
2205   }
2206 }
2207 
2208 // Add a method id to the jmethod_ids
2209 jmethodID Method::make_jmethod_id(ClassLoaderData* loader_data, Method* m) {
2210   ClassLoaderData* cld = loader_data;
2211 
2212   if (!SafepointSynchronize::is_at_safepoint()) {
2213     // Have to add jmethod_ids() to class loader data thread-safely.
2214     // Also have to add the method to the list safely, which the cld lock
2215     // protects as well.
2216     MutexLocker ml(cld-&gt;metaspace_lock(),  Mutex::_no_safepoint_check_flag);
2217     if (cld-&gt;jmethod_ids() == NULL) {
2218       cld-&gt;set_jmethod_ids(new JNIMethodBlock());
2219     }
2220     // jmethodID is a pointer to Method*
2221     return (jmethodID)cld-&gt;jmethod_ids()-&gt;add_method(m);
2222   } else {
2223     // At safepoint, we are single threaded and can set this.
2224     if (cld-&gt;jmethod_ids() == NULL) {
2225       cld-&gt;set_jmethod_ids(new JNIMethodBlock());
2226     }
2227     // jmethodID is a pointer to Method*
2228     return (jmethodID)cld-&gt;jmethod_ids()-&gt;add_method(m);
2229   }
2230 }
2231 
2232 jmethodID Method::jmethod_id() {
2233   methodHandle mh(Thread::current(), this);
2234   return method_holder()-&gt;get_jmethod_id(mh);
2235 }
2236 
2237 // Mark a jmethodID as free.  This is called when there is a data race in
2238 // InstanceKlass while creating the jmethodID cache.
2239 void Method::destroy_jmethod_id(ClassLoaderData* loader_data, jmethodID m) {
2240   ClassLoaderData* cld = loader_data;
2241   Method** ptr = (Method**)m;
2242   assert(cld-&gt;jmethod_ids() != NULL, &quot;should have method handles&quot;);
2243   cld-&gt;jmethod_ids()-&gt;destroy_method(ptr);
2244 }
2245 
2246 void Method::change_method_associated_with_jmethod_id(jmethodID jmid, Method* new_method) {
2247   // Can&#39;t assert the method_holder is the same because the new method has the
2248   // scratch method holder.
2249   assert(resolve_jmethod_id(jmid)-&gt;method_holder()-&gt;class_loader()
2250            == new_method-&gt;method_holder()-&gt;class_loader() ||
2251            new_method-&gt;method_holder()-&gt;class_loader() == NULL, // allow Unsafe substitution
2252          &quot;changing to a different class loader&quot;);
2253   // Just change the method in place, jmethodID pointer doesn&#39;t change.
2254   *((Method**)jmid) = new_method;
2255 }
2256 
2257 bool Method::is_method_id(jmethodID mid) {
2258   Method* m = resolve_jmethod_id(mid);
2259   assert(m != NULL, &quot;should be called with non-null method&quot;);
2260   InstanceKlass* ik = m-&gt;method_holder();
2261   ClassLoaderData* cld = ik-&gt;class_loader_data();
2262   if (cld-&gt;jmethod_ids() == NULL) return false;
2263   return (cld-&gt;jmethod_ids()-&gt;contains((Method**)mid));
2264 }
2265 
2266 Method* Method::checked_resolve_jmethod_id(jmethodID mid) {
2267   if (mid == NULL) return NULL;
2268   Method* o = resolve_jmethod_id(mid);
2269   if (o == NULL || o == JNIMethodBlock::_free_method || !((Metadata*)o)-&gt;is_method()) {
2270     return NULL;
2271   }
2272   return o;
2273 };
2274 
2275 void Method::set_on_stack(const bool value) {
2276   // Set both the method itself and its constant pool.  The constant pool
2277   // on stack means some method referring to it is also on the stack.
2278   constants()-&gt;set_on_stack(value);
2279 
2280   bool already_set = on_stack();
2281   _access_flags.set_on_stack(value);
2282   if (value &amp;&amp; !already_set) {
2283     MetadataOnStackMark::record(this);
2284   }
2285   assert(!value || !is_old() || is_obsolete() || is_running_emcp(),
2286          &quot;emcp methods cannot run after emcp bit is cleared&quot;);
2287 }
2288 
2289 // Called when the class loader is unloaded to make all methods weak.
2290 void Method::clear_jmethod_ids(ClassLoaderData* loader_data) {
2291   loader_data-&gt;jmethod_ids()-&gt;clear_all_methods();
2292 }
2293 
2294 bool Method::has_method_vptr(const void* ptr) {
2295   Method m;
2296   // This assumes that the vtbl pointer is the first word of a C++ object.
2297   return dereference_vptr(&amp;m) == dereference_vptr(ptr);
2298 }
2299 
2300 // Check that this pointer is valid by checking that the vtbl pointer matches
2301 bool Method::is_valid_method(const Method* m) {
2302   if (m == NULL) {
2303     return false;
2304   } else if ((intptr_t(m) &amp; (wordSize-1)) != 0) {
2305     // Quick sanity check on pointer.
2306     return false;
2307   } else if (m-&gt;is_shared()) {
2308     return MetaspaceShared::is_valid_shared_method(m);
2309   } else if (Metaspace::contains_non_shared(m)) {
2310     return has_method_vptr((const void*)m);
2311   } else {
2312     return false;
2313   }
2314 }
2315 
2316 #ifndef PRODUCT
2317 void Method::print_jmethod_ids(const ClassLoaderData* loader_data, outputStream* out) {
2318   out-&gt;print(&quot; jni_method_id count = %d&quot;, loader_data-&gt;jmethod_ids()-&gt;count_methods());
2319 }
2320 #endif // PRODUCT
2321 
2322 
2323 // Printing
2324 
2325 #ifndef PRODUCT
2326 
2327 void Method::print_on(outputStream* st) const {
2328   ResourceMark rm;
2329   assert(is_method(), &quot;must be method&quot;);
2330   st-&gt;print_cr(&quot;%s&quot;, internal_name());
2331   st-&gt;print_cr(&quot; - this oop:          &quot; INTPTR_FORMAT, p2i(this));
2332   st-&gt;print   (&quot; - method holder:     &quot;); method_holder()-&gt;print_value_on(st); st-&gt;cr();
2333   st-&gt;print   (&quot; - constants:         &quot; INTPTR_FORMAT &quot; &quot;, p2i(constants()));
2334   constants()-&gt;print_value_on(st); st-&gt;cr();
2335   st-&gt;print   (&quot; - access:            0x%x  &quot;, access_flags().as_int()); access_flags().print_on(st); st-&gt;cr();
2336   st-&gt;print   (&quot; - name:              &quot;);    name()-&gt;print_value_on(st); st-&gt;cr();
2337   st-&gt;print   (&quot; - signature:         &quot;);    signature()-&gt;print_value_on(st); st-&gt;cr();
2338   st-&gt;print_cr(&quot; - max stack:         %d&quot;,   max_stack());
2339   st-&gt;print_cr(&quot; - max locals:        %d&quot;,   max_locals());
2340   st-&gt;print_cr(&quot; - size of params:    %d&quot;,   size_of_parameters());
2341   st-&gt;print_cr(&quot; - method size:       %d&quot;,   method_size());
2342   if (intrinsic_id() != vmIntrinsics::_none)
2343     st-&gt;print_cr(&quot; - intrinsic id:      %d %s&quot;, intrinsic_id(), vmIntrinsics::name_at(intrinsic_id()));
2344   if (highest_comp_level() != CompLevel_none)
2345     st-&gt;print_cr(&quot; - highest level:     %d&quot;, highest_comp_level());
2346   st-&gt;print_cr(&quot; - vtable index:      %d&quot;,   _vtable_index);
2347   st-&gt;print_cr(&quot; - i2i entry:         &quot; INTPTR_FORMAT, p2i(interpreter_entry()));
2348   st-&gt;print(   &quot; - adapters:          &quot;);
2349   AdapterHandlerEntry* a = ((Method*)this)-&gt;adapter();
2350   if (a == NULL)
2351     st-&gt;print_cr(INTPTR_FORMAT, p2i(a));
2352   else
2353     a-&gt;print_adapter_on(st);
2354   st-&gt;print_cr(&quot; - compiled entry     &quot; INTPTR_FORMAT, p2i(from_compiled_entry()));
2355   st-&gt;print_cr(&quot; - code size:         %d&quot;,   code_size());
2356   if (code_size() != 0) {
2357     st-&gt;print_cr(&quot; - code start:        &quot; INTPTR_FORMAT, p2i(code_base()));
2358     st-&gt;print_cr(&quot; - code end (excl):   &quot; INTPTR_FORMAT, p2i(code_base() + code_size()));
2359   }
2360   if (method_data() != NULL) {
2361     st-&gt;print_cr(&quot; - method data:       &quot; INTPTR_FORMAT, p2i(method_data()));
2362   }
2363   st-&gt;print_cr(&quot; - checked ex length: %d&quot;,   checked_exceptions_length());
2364   if (checked_exceptions_length() &gt; 0) {
2365     CheckedExceptionElement* table = checked_exceptions_start();
2366     st-&gt;print_cr(&quot; - checked ex start:  &quot; INTPTR_FORMAT, p2i(table));
2367     if (Verbose) {
2368       for (int i = 0; i &lt; checked_exceptions_length(); i++) {
2369         st-&gt;print_cr(&quot;   - throws %s&quot;, constants()-&gt;printable_name_at(table[i].class_cp_index));
2370       }
2371     }
2372   }
2373   if (has_linenumber_table()) {
2374     u_char* table = compressed_linenumber_table();
2375     st-&gt;print_cr(&quot; - linenumber start:  &quot; INTPTR_FORMAT, p2i(table));
2376     if (Verbose) {
2377       CompressedLineNumberReadStream stream(table);
2378       while (stream.read_pair()) {
2379         st-&gt;print_cr(&quot;   - line %d: %d&quot;, stream.line(), stream.bci());
2380       }
2381     }
2382   }
2383   st-&gt;print_cr(&quot; - localvar length:   %d&quot;,   localvariable_table_length());
2384   if (localvariable_table_length() &gt; 0) {
2385     LocalVariableTableElement* table = localvariable_table_start();
2386     st-&gt;print_cr(&quot; - localvar start:    &quot; INTPTR_FORMAT, p2i(table));
2387     if (Verbose) {
2388       for (int i = 0; i &lt; localvariable_table_length(); i++) {
2389         int bci = table[i].start_bci;
2390         int len = table[i].length;
2391         const char* name = constants()-&gt;printable_name_at(table[i].name_cp_index);
2392         const char* desc = constants()-&gt;printable_name_at(table[i].descriptor_cp_index);
2393         int slot = table[i].slot;
2394         st-&gt;print_cr(&quot;   - %s %s bci=%d len=%d slot=%d&quot;, desc, name, bci, len, slot);
2395       }
2396     }
2397   }
2398   if (code() != NULL) {
2399     st-&gt;print   (&quot; - compiled code: &quot;);
2400     code()-&gt;print_value_on(st);
2401   }
2402   if (is_native()) {
2403     st-&gt;print_cr(&quot; - native function:   &quot; INTPTR_FORMAT, p2i(native_function()));
2404     st-&gt;print_cr(&quot; - signature handler: &quot; INTPTR_FORMAT, p2i(signature_handler()));
2405   }
2406 }
2407 
2408 void Method::print_linkage_flags(outputStream* st) {
2409   access_flags().print_on(st);
2410   if (is_default_method()) {
2411     st-&gt;print(&quot;default &quot;);
2412   }
2413   if (is_overpass()) {
2414     st-&gt;print(&quot;overpass &quot;);
2415   }
2416 }
2417 #endif //PRODUCT
2418 
2419 void Method::print_value_on(outputStream* st) const {
2420   assert(is_method(), &quot;must be method&quot;);
2421   st-&gt;print(&quot;%s&quot;, internal_name());
2422   print_address_on(st);
2423   st-&gt;print(&quot; &quot;);
2424   name()-&gt;print_value_on(st);
2425   st-&gt;print(&quot; &quot;);
2426   signature()-&gt;print_value_on(st);
2427   st-&gt;print(&quot; in &quot;);
2428   method_holder()-&gt;print_value_on(st);
2429   if (WizardMode) st-&gt;print(&quot;#%d&quot;, _vtable_index);
2430   if (WizardMode) st-&gt;print(&quot;[%d,%d]&quot;, size_of_parameters(), max_locals());
2431   if (WizardMode &amp;&amp; code() != NULL) st-&gt;print(&quot; ((nmethod*)%p)&quot;, code());
2432 }
2433 
2434 // LogTouchedMethods and PrintTouchedMethods
2435 
2436 // TouchedMethodRecord -- we can&#39;t use a HashtableEntry&lt;Method*&gt; because
2437 // the Method may be garbage collected. Let&#39;s roll our own hash table.
2438 class TouchedMethodRecord : CHeapObj&lt;mtTracing&gt; {
2439 public:
2440   // It&#39;s OK to store Symbols here because they will NOT be GC&#39;ed if
2441   // LogTouchedMethods is enabled.
2442   TouchedMethodRecord* _next;
2443   Symbol* _class_name;
2444   Symbol* _method_name;
2445   Symbol* _method_signature;
2446 };
2447 
2448 static const int TOUCHED_METHOD_TABLE_SIZE = 20011;
2449 static TouchedMethodRecord** _touched_method_table = NULL;
2450 
2451 void Method::log_touched(TRAPS) {
2452 
2453   const int table_size = TOUCHED_METHOD_TABLE_SIZE;
2454   Symbol* my_class = klass_name();
2455   Symbol* my_name  = name();
2456   Symbol* my_sig   = signature();
2457 
2458   unsigned int hash = my_class-&gt;identity_hash() +
2459                       my_name-&gt;identity_hash() +
2460                       my_sig-&gt;identity_hash();
2461   juint index = juint(hash) % table_size;
2462 
2463   MutexLocker ml(THREAD, TouchedMethodLog_lock);
2464   if (_touched_method_table == NULL) {
2465     _touched_method_table = NEW_C_HEAP_ARRAY2(TouchedMethodRecord*, table_size,
2466                                               mtTracing, CURRENT_PC);
2467     memset(_touched_method_table, 0, sizeof(TouchedMethodRecord*)*table_size);
2468   }
2469 
2470   TouchedMethodRecord* ptr = _touched_method_table[index];
2471   while (ptr) {
2472     if (ptr-&gt;_class_name       == my_class &amp;&amp;
2473         ptr-&gt;_method_name      == my_name &amp;&amp;
2474         ptr-&gt;_method_signature == my_sig) {
2475       return;
2476     }
2477     if (ptr-&gt;_next == NULL) break;
2478     ptr = ptr-&gt;_next;
2479   }
2480   TouchedMethodRecord* nptr = NEW_C_HEAP_OBJ(TouchedMethodRecord, mtTracing);
2481   my_class-&gt;increment_refcount();
2482   my_name-&gt;increment_refcount();
2483   my_sig-&gt;increment_refcount();
2484   nptr-&gt;_class_name         = my_class;
2485   nptr-&gt;_method_name        = my_name;
2486   nptr-&gt;_method_signature   = my_sig;
2487   nptr-&gt;_next               = NULL;
2488 
2489   if (ptr == NULL) {
2490     // first
2491     _touched_method_table[index] = nptr;
2492   } else {
2493     ptr-&gt;_next = nptr;
2494   }
2495 }
2496 
2497 void Method::print_touched_methods(outputStream* out) {
2498   MutexLocker ml(Thread::current()-&gt;is_VM_thread() ? NULL : TouchedMethodLog_lock);
2499   out-&gt;print_cr(&quot;# Method::print_touched_methods version 1&quot;);
2500   if (_touched_method_table) {
2501     for (int i = 0; i &lt; TOUCHED_METHOD_TABLE_SIZE; i++) {
2502       TouchedMethodRecord* ptr = _touched_method_table[i];
2503       while(ptr) {
2504         ptr-&gt;_class_name-&gt;print_symbol_on(out);       out-&gt;print(&quot;.&quot;);
2505         ptr-&gt;_method_name-&gt;print_symbol_on(out);      out-&gt;print(&quot;:&quot;);
2506         ptr-&gt;_method_signature-&gt;print_symbol_on(out); out-&gt;cr();
2507         ptr = ptr-&gt;_next;
2508       }
2509     }
2510   }
2511 }
2512 
2513 // Verification
2514 
2515 void Method::verify_on(outputStream* st) {
2516   guarantee(is_method(), &quot;object must be method&quot;);
2517   guarantee(constants()-&gt;is_constantPool(), &quot;should be constant pool&quot;);
2518   MethodData* md = method_data();
2519   guarantee(md == NULL ||
2520       md-&gt;is_methodData(), &quot;should be method data&quot;);
2521 }
    </pre>
  </body>
</html>