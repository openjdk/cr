<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Frames src/hotspot/share/compiler/compileBroker.cpp</title>
    <link rel="stylesheet" href="../../../../style.css" />
    <script type="text/javascript" src="../../../../navigation.js"></script>
  </head>
<body onkeypress="keypress(event);">
<a name="0"></a>
<hr />
<pre>   1 /*
   2  * Copyright (c) 1999, 2020, Oracle and/or its affiliates. All rights reserved.
   3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   4  *
   5  * This code is free software; you can redistribute it and/or modify it
   6  * under the terms of the GNU General Public License version 2 only, as
   7  * published by the Free Software Foundation.
   8  *
   9  * This code is distributed in the hope that it will be useful, but WITHOUT
  10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
  11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
  12  * version 2 for more details (a copy is included in the LICENSE file that
  13  * accompanied this code).
  14  *
  15  * You should have received a copy of the GNU General Public License version
  16  * 2 along with this work; if not, write to the Free Software Foundation,
  17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
  18  *
  19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
  20  * or visit www.oracle.com if you need additional information or have any
  21  * questions.
  22  *
  23  */
  24 
  25 #include &quot;precompiled.hpp&quot;
  26 #include &quot;jvm.h&quot;
  27 #include &quot;classfile/symbolTable.hpp&quot;
  28 #include &quot;classfile/systemDictionary.hpp&quot;
  29 #include &quot;classfile/vmSymbols.hpp&quot;
  30 #include &quot;code/codeCache.hpp&quot;
  31 #include &quot;code/codeHeapState.hpp&quot;
  32 #include &quot;code/dependencyContext.hpp&quot;
  33 #include &quot;compiler/compilationPolicy.hpp&quot;
  34 #include &quot;compiler/compileBroker.hpp&quot;
  35 #include &quot;compiler/compileLog.hpp&quot;
  36 #include &quot;compiler/compilerEvent.hpp&quot;
  37 #include &quot;compiler/compilerOracle.hpp&quot;
  38 #include &quot;compiler/directivesParser.hpp&quot;
  39 #include &quot;interpreter/linkResolver.hpp&quot;
  40 #include &quot;jfr/jfrEvents.hpp&quot;
  41 #include &quot;logging/log.hpp&quot;
  42 #include &quot;logging/logStream.hpp&quot;
  43 #include &quot;memory/allocation.inline.hpp&quot;
  44 #include &quot;memory/resourceArea.hpp&quot;
  45 #include &quot;memory/universe.hpp&quot;
  46 #include &quot;oops/methodData.hpp&quot;
  47 #include &quot;oops/method.inline.hpp&quot;
  48 #include &quot;oops/oop.inline.hpp&quot;
  49 #include &quot;prims/nativeLookup.hpp&quot;
  50 #include &quot;prims/whitebox.hpp&quot;
  51 #include &quot;runtime/arguments.hpp&quot;
  52 #include &quot;runtime/atomic.hpp&quot;
  53 #include &quot;runtime/handles.inline.hpp&quot;
  54 #include &quot;runtime/init.hpp&quot;
  55 #include &quot;runtime/interfaceSupport.inline.hpp&quot;
  56 #include &quot;runtime/javaCalls.hpp&quot;
  57 #include &quot;runtime/jniHandles.inline.hpp&quot;
  58 #include &quot;runtime/os.hpp&quot;
  59 #include &quot;runtime/safepointVerifiers.hpp&quot;
  60 #include &quot;runtime/sharedRuntime.hpp&quot;
  61 #include &quot;runtime/sweeper.hpp&quot;
  62 #include &quot;runtime/timerTrace.hpp&quot;
  63 #include &quot;runtime/vframe.inline.hpp&quot;
  64 #include &quot;utilities/debug.hpp&quot;
  65 #include &quot;utilities/dtrace.hpp&quot;
  66 #include &quot;utilities/events.hpp&quot;
  67 #include &quot;utilities/formatBuffer.hpp&quot;
  68 #include &quot;utilities/macros.hpp&quot;
  69 #ifdef COMPILER1
  70 #include &quot;c1/c1_Compiler.hpp&quot;
  71 #endif
  72 #if INCLUDE_JVMCI
  73 #include &quot;jvmci/jvmciEnv.hpp&quot;
  74 #include &quot;jvmci/jvmciRuntime.hpp&quot;
  75 #endif
  76 #ifdef COMPILER2
  77 #include &quot;opto/c2compiler.hpp&quot;
  78 #endif
  79 
  80 #ifdef DTRACE_ENABLED
  81 
  82 // Only bother with this argument setup if dtrace is available
  83 
  84 #define DTRACE_METHOD_COMPILE_BEGIN_PROBE(method, comp_name)             \
  85   {                                                                      \
  86     Symbol* klass_name = (method)-&gt;klass_name();                         \
  87     Symbol* name = (method)-&gt;name();                                     \
  88     Symbol* signature = (method)-&gt;signature();                           \
  89     HOTSPOT_METHOD_COMPILE_BEGIN(                                        \
  90       (char *) comp_name, strlen(comp_name),                             \
  91       (char *) klass_name-&gt;bytes(), klass_name-&gt;utf8_length(),           \
  92       (char *) name-&gt;bytes(), name-&gt;utf8_length(),                       \
  93       (char *) signature-&gt;bytes(), signature-&gt;utf8_length());            \
  94   }
  95 
  96 #define DTRACE_METHOD_COMPILE_END_PROBE(method, comp_name, success)      \
  97   {                                                                      \
  98     Symbol* klass_name = (method)-&gt;klass_name();                         \
  99     Symbol* name = (method)-&gt;name();                                     \
 100     Symbol* signature = (method)-&gt;signature();                           \
 101     HOTSPOT_METHOD_COMPILE_END(                                          \
 102       (char *) comp_name, strlen(comp_name),                             \
 103       (char *) klass_name-&gt;bytes(), klass_name-&gt;utf8_length(),           \
 104       (char *) name-&gt;bytes(), name-&gt;utf8_length(),                       \
 105       (char *) signature-&gt;bytes(), signature-&gt;utf8_length(), (success)); \
 106   }
 107 
 108 #else //  ndef DTRACE_ENABLED
 109 
 110 #define DTRACE_METHOD_COMPILE_BEGIN_PROBE(method, comp_name)
 111 #define DTRACE_METHOD_COMPILE_END_PROBE(method, comp_name, success)
 112 
 113 #endif // ndef DTRACE_ENABLED
 114 
 115 bool CompileBroker::_initialized = false;
 116 volatile bool CompileBroker::_should_block = false;
 117 volatile int  CompileBroker::_print_compilation_warning = 0;
 118 volatile jint CompileBroker::_should_compile_new_jobs = run_compilation;
 119 
 120 // The installed compiler(s)
 121 AbstractCompiler* CompileBroker::_compilers[2];
 122 
 123 // The maximum numbers of compiler threads to be determined during startup.
 124 int CompileBroker::_c1_count = 0;
 125 int CompileBroker::_c2_count = 0;
 126 
 127 // An array of compiler names as Java String objects
 128 jobject* CompileBroker::_compiler1_objects = NULL;
 129 jobject* CompileBroker::_compiler2_objects = NULL;
 130 
 131 CompileLog** CompileBroker::_compiler1_logs = NULL;
 132 CompileLog** CompileBroker::_compiler2_logs = NULL;
 133 
 134 // These counters are used to assign an unique ID to each compilation.
 135 volatile jint CompileBroker::_compilation_id     = 0;
 136 volatile jint CompileBroker::_osr_compilation_id = 0;
 137 
 138 // Performance counters
 139 PerfCounter* CompileBroker::_perf_total_compilation = NULL;
 140 PerfCounter* CompileBroker::_perf_osr_compilation = NULL;
 141 PerfCounter* CompileBroker::_perf_standard_compilation = NULL;
 142 
 143 PerfCounter* CompileBroker::_perf_total_bailout_count = NULL;
 144 PerfCounter* CompileBroker::_perf_total_invalidated_count = NULL;
 145 PerfCounter* CompileBroker::_perf_total_compile_count = NULL;
 146 PerfCounter* CompileBroker::_perf_total_osr_compile_count = NULL;
 147 PerfCounter* CompileBroker::_perf_total_standard_compile_count = NULL;
 148 
 149 PerfCounter* CompileBroker::_perf_sum_osr_bytes_compiled = NULL;
 150 PerfCounter* CompileBroker::_perf_sum_standard_bytes_compiled = NULL;
 151 PerfCounter* CompileBroker::_perf_sum_nmethod_size = NULL;
 152 PerfCounter* CompileBroker::_perf_sum_nmethod_code_size = NULL;
 153 
 154 PerfStringVariable* CompileBroker::_perf_last_method = NULL;
 155 PerfStringVariable* CompileBroker::_perf_last_failed_method = NULL;
 156 PerfStringVariable* CompileBroker::_perf_last_invalidated_method = NULL;
 157 PerfVariable*       CompileBroker::_perf_last_compile_type = NULL;
 158 PerfVariable*       CompileBroker::_perf_last_compile_size = NULL;
 159 PerfVariable*       CompileBroker::_perf_last_failed_type = NULL;
 160 PerfVariable*       CompileBroker::_perf_last_invalidated_type = NULL;
 161 
 162 // Timers and counters for generating statistics
 163 elapsedTimer CompileBroker::_t_total_compilation;
 164 elapsedTimer CompileBroker::_t_osr_compilation;
 165 elapsedTimer CompileBroker::_t_standard_compilation;
 166 elapsedTimer CompileBroker::_t_invalidated_compilation;
 167 elapsedTimer CompileBroker::_t_bailedout_compilation;
 168 
 169 int CompileBroker::_total_bailout_count            = 0;
 170 int CompileBroker::_total_invalidated_count        = 0;
 171 int CompileBroker::_total_compile_count            = 0;
 172 int CompileBroker::_total_osr_compile_count        = 0;
 173 int CompileBroker::_total_standard_compile_count   = 0;
 174 int CompileBroker::_total_compiler_stopped_count   = 0;
 175 int CompileBroker::_total_compiler_restarted_count = 0;
 176 
 177 int CompileBroker::_sum_osr_bytes_compiled         = 0;
 178 int CompileBroker::_sum_standard_bytes_compiled    = 0;
 179 int CompileBroker::_sum_nmethod_size               = 0;
 180 int CompileBroker::_sum_nmethod_code_size          = 0;
 181 
 182 long CompileBroker::_peak_compilation_time         = 0;
 183 
 184 CompileQueue* CompileBroker::_c2_compile_queue     = NULL;
 185 CompileQueue* CompileBroker::_c1_compile_queue     = NULL;
 186 
 187 
 188 
 189 class CompilationLog : public StringEventLog {
 190  public:
 191   CompilationLog() : StringEventLog(&quot;Compilation events&quot;, &quot;jit&quot;) {
 192   }
 193 
 194   void log_compile(JavaThread* thread, CompileTask* task) {
 195     StringLogMessage lm;
 196     stringStream sstr(lm.buffer(), lm.size());
 197     // msg.time_stamp().update_to(tty-&gt;time_stamp().ticks());
 198     task-&gt;print(&amp;sstr, NULL, true, false);
 199     log(thread, &quot;%s&quot;, (const char*)lm);
 200   }
 201 
 202   void log_nmethod(JavaThread* thread, nmethod* nm) {
 203     log(thread, &quot;nmethod %d%s &quot; INTPTR_FORMAT &quot; code [&quot; INTPTR_FORMAT &quot;, &quot; INTPTR_FORMAT &quot;]&quot;,
 204         nm-&gt;compile_id(), nm-&gt;is_osr_method() ? &quot;%&quot; : &quot;&quot;,
 205         p2i(nm), p2i(nm-&gt;code_begin()), p2i(nm-&gt;code_end()));
 206   }
 207 
 208   void log_failure(JavaThread* thread, CompileTask* task, const char* reason, const char* retry_message) {
 209     StringLogMessage lm;
 210     lm.print(&quot;%4d   COMPILE SKIPPED: %s&quot;, task-&gt;compile_id(), reason);
 211     if (retry_message != NULL) {
 212       lm.append(&quot; (%s)&quot;, retry_message);
 213     }
 214     lm.print(&quot;\n&quot;);
 215     log(thread, &quot;%s&quot;, (const char*)lm);
 216   }
 217 
 218   void log_metaspace_failure(const char* reason) {
 219     ResourceMark rm;
 220     StringLogMessage lm;
 221     lm.print(&quot;%4d   COMPILE PROFILING SKIPPED: %s&quot;, -1, reason);
 222     lm.print(&quot;\n&quot;);
 223     log(JavaThread::current(), &quot;%s&quot;, (const char*)lm);
 224   }
 225 };
 226 
 227 static CompilationLog* _compilation_log = NULL;
 228 
 229 bool compileBroker_init() {
 230   if (LogEvents) {
 231     _compilation_log = new CompilationLog();
 232   }
 233 
 234   // init directives stack, adding default directive
 235   DirectivesStack::init();
 236 
 237   if (DirectivesParser::has_file()) {
 238     return DirectivesParser::parse_from_flag();
 239   } else if (CompilerDirectivesPrint) {
 240     // Print default directive even when no other was added
 241     DirectivesStack::print(tty);
 242   }
 243 
 244   return true;
 245 }
 246 
 247 CompileTaskWrapper::CompileTaskWrapper(CompileTask* task) {
 248   CompilerThread* thread = CompilerThread::current();
 249   thread-&gt;set_task(task);
 250 #if INCLUDE_JVMCI
 251   if (task-&gt;is_blocking() &amp;&amp; CompileBroker::compiler(task-&gt;comp_level())-&gt;is_jvmci()) {
 252     task-&gt;set_jvmci_compiler_thread(thread);
 253   }
 254 #endif
 255   CompileLog*     log  = thread-&gt;log();
 256   if (log != NULL &amp;&amp; !task-&gt;is_unloaded())  task-&gt;log_task_start(log);
 257 }
 258 
 259 CompileTaskWrapper::~CompileTaskWrapper() {
 260   CompilerThread* thread = CompilerThread::current();
 261   CompileTask* task = thread-&gt;task();
 262   CompileLog*  log  = thread-&gt;log();
 263   if (log != NULL &amp;&amp; !task-&gt;is_unloaded())  task-&gt;log_task_done(log);
 264   thread-&gt;set_task(NULL);
 265   task-&gt;set_code_handle(NULL);
 266   thread-&gt;set_env(NULL);
 267   if (task-&gt;is_blocking()) {
 268     bool free_task = false;
 269     {
 270       MutexLocker notifier(thread, task-&gt;lock());
 271       task-&gt;mark_complete();
 272 #if INCLUDE_JVMCI
 273       if (CompileBroker::compiler(task-&gt;comp_level())-&gt;is_jvmci()) {
 274         if (!task-&gt;has_waiter()) {
 275           // The waiting thread timed out and thus did not free the task.
 276           free_task = true;
 277         }
 278         task-&gt;set_jvmci_compiler_thread(NULL);
 279       }
 280 #endif
 281       if (!free_task) {
 282         // Notify the waiting thread that the compilation has completed
 283         // so that it can free the task.
 284         task-&gt;lock()-&gt;notify_all();
 285       }
 286     }
 287     if (free_task) {
 288       // The task can only be freed once the task lock is released.
 289       CompileTask::free(task);
 290     }
 291   } else {
 292     task-&gt;mark_complete();
 293 
 294     // By convention, the compiling thread is responsible for
 295     // recycling a non-blocking CompileTask.
 296     CompileTask::free(task);
 297   }
 298 }
 299 
 300 /**
 301  * Check if a CompilerThread can be removed and update count if requested.
 302  */
 303 bool CompileBroker::can_remove(CompilerThread *ct, bool do_it) {
 304   assert(UseDynamicNumberOfCompilerThreads, &quot;or shouldn&#39;t be here&quot;);
 305   if (!ReduceNumberOfCompilerThreads) return false;
 306 
 307   AbstractCompiler *compiler = ct-&gt;compiler();
 308   int compiler_count = compiler-&gt;num_compiler_threads();
 309   bool c1 = compiler-&gt;is_c1();
 310 
 311   // Keep at least 1 compiler thread of each type.
 312   if (compiler_count &lt; 2) return false;
 313 
 314   // Keep thread alive for at least some time.
 315   if (ct-&gt;idle_time_millis() &lt; (c1 ? 500 : 100)) return false;
 316 
 317 #if INCLUDE_JVMCI
 318   if (compiler-&gt;is_jvmci()) {
 319     // Handles for JVMCI thread objects may get released concurrently.
 320     if (do_it) {
 321       assert(CompileThread_lock-&gt;owner() == ct, &quot;must be holding lock&quot;);
 322     } else {
 323       // Skip check if it&#39;s the last thread and let caller check again.
 324       return true;
 325     }
 326   }
 327 #endif
 328 
 329   // We only allow the last compiler thread of each type to get removed.
 330   jobject last_compiler = c1 ? compiler1_object(compiler_count - 1)
 331                              : compiler2_object(compiler_count - 1);
 332   if (ct-&gt;threadObj() == JNIHandles::resolve_non_null(last_compiler)) {
 333     if (do_it) {
 334       assert_locked_or_safepoint(CompileThread_lock); // Update must be consistent.
 335       compiler-&gt;set_num_compiler_threads(compiler_count - 1);
 336 #if INCLUDE_JVMCI
 337       if (compiler-&gt;is_jvmci()) {
 338         // Old j.l.Thread object can die when no longer referenced elsewhere.
 339         JNIHandles::destroy_global(compiler2_object(compiler_count - 1));
 340         _compiler2_objects[compiler_count - 1] = NULL;
 341       }
 342 #endif
 343     }
 344     return true;
 345   }
 346   return false;
 347 }
 348 
 349 /**
 350  * Add a CompileTask to a CompileQueue.
 351  */
 352 void CompileQueue::add(CompileTask* task) {
 353   assert(MethodCompileQueue_lock-&gt;owned_by_self(), &quot;must own lock&quot;);
 354 
 355   task-&gt;set_next(NULL);
 356   task-&gt;set_prev(NULL);
 357 
 358   if (_last == NULL) {
 359     // The compile queue is empty.
 360     assert(_first == NULL, &quot;queue is empty&quot;);
 361     _first = task;
 362     _last = task;
 363   } else {
 364     // Append the task to the queue.
 365     assert(_last-&gt;next() == NULL, &quot;not last&quot;);
 366     _last-&gt;set_next(task);
 367     task-&gt;set_prev(_last);
 368     _last = task;
 369   }
 370   ++_size;
 371 
 372   // Mark the method as being in the compile queue.
 373   task-&gt;method()-&gt;set_queued_for_compilation();
 374 
 375   if (CIPrintCompileQueue) {
 376     print_tty();
 377   }
 378 
 379   if (LogCompilation &amp;&amp; xtty != NULL) {
 380     task-&gt;log_task_queued();
 381   }
 382 
 383   // Notify CompilerThreads that a task is available.
 384   MethodCompileQueue_lock-&gt;notify_all();
 385 }
 386 
 387 /**
 388  * Empties compilation queue by putting all compilation tasks onto
 389  * a freelist. Furthermore, the method wakes up all threads that are
 390  * waiting on a compilation task to finish. This can happen if background
 391  * compilation is disabled.
 392  */
 393 void CompileQueue::free_all() {
 394   MutexLocker mu(MethodCompileQueue_lock);
 395   CompileTask* next = _first;
 396 
 397   // Iterate over all tasks in the compile queue
 398   while (next != NULL) {
 399     CompileTask* current = next;
 400     next = current-&gt;next();
 401     {
 402       // Wake up thread that blocks on the compile task.
 403       MutexLocker ct_lock(current-&gt;lock());
 404       current-&gt;lock()-&gt;notify();
 405     }
 406     // Put the task back on the freelist.
 407     CompileTask::free(current);
 408   }
 409   _first = NULL;
 410 
 411   // Wake up all threads that block on the queue.
 412   MethodCompileQueue_lock-&gt;notify_all();
 413 }
 414 
 415 /**
 416  * Get the next CompileTask from a CompileQueue
 417  */
 418 CompileTask* CompileQueue::get() {
 419   // save methods from RedefineClasses across safepoint
 420   // across MethodCompileQueue_lock below.
 421   methodHandle save_method;
 422   methodHandle save_hot_method;
 423 
 424   MonitorLocker locker(MethodCompileQueue_lock);
 425   // If _first is NULL we have no more compile jobs. There are two reasons for
 426   // having no compile jobs: First, we compiled everything we wanted. Second,
 427   // we ran out of code cache so compilation has been disabled. In the latter
 428   // case we perform code cache sweeps to free memory such that we can re-enable
 429   // compilation.
 430   while (_first == NULL) {
 431     // Exit loop if compilation is disabled forever
 432     if (CompileBroker::is_compilation_disabled_forever()) {
 433       return NULL;
 434     }
 435 
 436     // If there are no compilation tasks and we can compile new jobs
 437     // (i.e., there is enough free space in the code cache) there is
 438     // no need to invoke the sweeper. As a result, the hotness of methods
 439     // remains unchanged. This behavior is desired, since we want to keep
 440     // the stable state, i.e., we do not want to evict methods from the
 441     // code cache if it is unnecessary.
 442     // We need a timed wait here, since compiler threads can exit if compilation
 443     // is disabled forever. We use 5 seconds wait time; the exiting of compiler threads
 444     // is not critical and we do not want idle compiler threads to wake up too often.
 445     locker.wait(5*1000);
 446 
 447     if (UseDynamicNumberOfCompilerThreads &amp;&amp; _first == NULL) {
 448       // Still nothing to compile. Give caller a chance to stop this thread.
 449       if (CompileBroker::can_remove(CompilerThread::current(), false)) return NULL;
 450     }
 451   }
 452 
 453   if (CompileBroker::is_compilation_disabled_forever()) {
 454     return NULL;
 455   }
 456 
 457   CompileTask* task;
 458   {
 459     NoSafepointVerifier nsv;
 460     task = CompilationPolicy::policy()-&gt;select_task(this);
 461     if (task != NULL) {
 462       task = task-&gt;select_for_compilation();
 463     }
 464   }
 465 
 466   if (task != NULL) {
 467     // Save method pointers across unlock safepoint.  The task is removed from
 468     // the compilation queue, which is walked during RedefineClasses.
 469     Thread* thread = Thread::current();
 470     save_method = methodHandle(thread, task-&gt;method());
 471     save_hot_method = methodHandle(thread, task-&gt;hot_method());
 472 
 473     remove(task);
 474   }
 475   purge_stale_tasks(); // may temporarily release MCQ lock
 476   return task;
 477 }
 478 
 479 // Clean &amp; deallocate stale compile tasks.
 480 // Temporarily releases MethodCompileQueue lock.
 481 void CompileQueue::purge_stale_tasks() {
 482   assert(MethodCompileQueue_lock-&gt;owned_by_self(), &quot;must own lock&quot;);
 483   if (_first_stale != NULL) {
 484     // Stale tasks are purged when MCQ lock is released,
 485     // but _first_stale updates are protected by MCQ lock.
 486     // Once task processing starts and MCQ lock is released,
 487     // other compiler threads can reuse _first_stale.
 488     CompileTask* head = _first_stale;
 489     _first_stale = NULL;
 490     {
 491       MutexUnlocker ul(MethodCompileQueue_lock);
 492       for (CompileTask* task = head; task != NULL; ) {
 493         CompileTask* next_task = task-&gt;next();
 494         CompileTaskWrapper ctw(task); // Frees the task
 495         task-&gt;set_failure_reason(&quot;stale task&quot;);
 496         task = next_task;
 497       }
 498     }
 499   }
 500 }
 501 
 502 void CompileQueue::remove(CompileTask* task) {
 503   assert(MethodCompileQueue_lock-&gt;owned_by_self(), &quot;must own lock&quot;);
 504   if (task-&gt;prev() != NULL) {
 505     task-&gt;prev()-&gt;set_next(task-&gt;next());
 506   } else {
 507     // max is the first element
 508     assert(task == _first, &quot;Sanity&quot;);
 509     _first = task-&gt;next();
 510   }
 511 
 512   if (task-&gt;next() != NULL) {
 513     task-&gt;next()-&gt;set_prev(task-&gt;prev());
 514   } else {
 515     // max is the last element
 516     assert(task == _last, &quot;Sanity&quot;);
 517     _last = task-&gt;prev();
 518   }
 519   --_size;
 520 }
 521 
 522 void CompileQueue::remove_and_mark_stale(CompileTask* task) {
 523   assert(MethodCompileQueue_lock-&gt;owned_by_self(), &quot;must own lock&quot;);
 524   remove(task);
 525 
 526   // Enqueue the task for reclamation (should be done outside MCQ lock)
 527   task-&gt;set_next(_first_stale);
 528   task-&gt;set_prev(NULL);
 529   _first_stale = task;
 530 }
 531 
 532 // methods in the compile queue need to be marked as used on the stack
 533 // so that they don&#39;t get reclaimed by Redefine Classes
 534 void CompileQueue::mark_on_stack() {
 535   CompileTask* task = _first;
 536   while (task != NULL) {
 537     task-&gt;mark_on_stack();
 538     task = task-&gt;next();
 539   }
 540 }
 541 
 542 
 543 CompileQueue* CompileBroker::compile_queue(int comp_level) {
 544   if (is_c2_compile(comp_level)) return _c2_compile_queue;
 545   if (is_c1_compile(comp_level)) return _c1_compile_queue;
 546   return NULL;
 547 }
 548 
 549 void CompileBroker::print_compile_queues(outputStream* st) {
 550   st-&gt;print_cr(&quot;Current compiles: &quot;);
 551 
 552   char buf[2000];
 553   int buflen = sizeof(buf);
 554   Threads::print_threads_compiling(st, buf, buflen, /* short_form = */ true);
 555 
 556   st-&gt;cr();
 557   if (_c1_compile_queue != NULL) {
 558     _c1_compile_queue-&gt;print(st);
 559   }
 560   if (_c2_compile_queue != NULL) {
 561     _c2_compile_queue-&gt;print(st);
 562   }
 563 }
 564 
 565 void CompileQueue::print(outputStream* st) {
 566   assert_locked_or_safepoint(MethodCompileQueue_lock);
 567   st-&gt;print_cr(&quot;%s:&quot;, name());
 568   CompileTask* task = _first;
 569   if (task == NULL) {
 570     st-&gt;print_cr(&quot;Empty&quot;);
 571   } else {
 572     while (task != NULL) {
 573       task-&gt;print(st, NULL, true, true);
 574       task = task-&gt;next();
 575     }
 576   }
 577   st-&gt;cr();
 578 }
 579 
 580 void CompileQueue::print_tty() {
 581   ResourceMark rm;
 582   stringStream ss;
 583   // Dump the compile queue into a buffer before locking the tty
 584   print(&amp;ss);
 585   {
 586     ttyLocker ttyl;
 587     tty-&gt;print(&quot;%s&quot;, ss.as_string());
 588   }
 589 }
 590 
 591 CompilerCounters::CompilerCounters() {
 592   _current_method[0] = &#39;\0&#39;;
 593   _compile_type = CompileBroker::no_compile;
 594 }
 595 
 596 #if INCLUDE_JFR &amp;&amp; COMPILER2_OR_JVMCI
 597 // It appends new compiler phase names to growable array phase_names(a new CompilerPhaseType mapping
 598 // in compiler/compilerEvent.cpp) and registers it with its serializer.
 599 //
 600 // c2 uses explicit CompilerPhaseType idToPhase mapping in opto/phasetype.hpp,
 601 // so if c2 is used, it should be always registered first.
 602 // This function is called during vm initialization.
 603 void register_jfr_phasetype_serializer(CompilerType compiler_type) {
 604   ResourceMark rm;
 605   static bool first_registration = true;
 606   if (compiler_type == compiler_jvmci) {
 607     // register serializer, phases will be added later lazily.
 608     GrowableArray&lt;const char*&gt;* jvmci_phase_names = new GrowableArray&lt;const char*&gt;(1);
 609     jvmci_phase_names-&gt;append(&quot;NOT_A_PHASE_NAME&quot;);
 610     CompilerEvent::PhaseEvent::register_phases(jvmci_phase_names);
 611     first_registration = false;
 612 #ifdef COMPILER2
 613   } else if (compiler_type == compiler_c2) {
 614     assert(first_registration, &quot;invariant&quot;); // c2 must be registered first.
 615     GrowableArray&lt;const char*&gt;* c2_phase_names = new GrowableArray&lt;const char*&gt;(PHASE_NUM_TYPES);
 616     for (int i = 0; i &lt; PHASE_NUM_TYPES; i++) {
 617       c2_phase_names-&gt;append(CompilerPhaseTypeHelper::to_string((CompilerPhaseType)i));
 618     }
 619     CompilerEvent::PhaseEvent::register_phases(c2_phase_names);
 620     first_registration = false;
 621 #endif // COMPILER2
 622   }
 623 }
 624 #endif // INCLUDE_JFR &amp;&amp; COMPILER2_OR_JVMCI
 625 
 626 // ------------------------------------------------------------------
 627 // CompileBroker::compilation_init
 628 //
 629 // Initialize the Compilation object
 630 void CompileBroker::compilation_init_phase1(Thread* THREAD) {
 631   // No need to initialize compilation system if we do not use it.
 632   if (!UseCompiler) {
 633     return;
 634   }
 635   // Set the interface to the current compiler(s).
 636   _c1_count = CompilationPolicy::policy()-&gt;compiler_count(CompLevel_simple);
 637   _c2_count = CompilationPolicy::policy()-&gt;compiler_count(CompLevel_full_optimization);
 638 
 639 #if INCLUDE_JVMCI
 640   if (EnableJVMCI) {
 641     // This is creating a JVMCICompiler singleton.
 642     JVMCICompiler* jvmci = new JVMCICompiler();
 643 
 644     if (UseJVMCICompiler) {
 645       _compilers[1] = jvmci;
 646       if (FLAG_IS_DEFAULT(JVMCIThreads)) {
 647         if (BootstrapJVMCI) {
 648           // JVMCI will bootstrap so give it more threads
 649           _c2_count = MIN2(32, os::active_processor_count());
 650         }
 651       } else {
 652         _c2_count = JVMCIThreads;
 653       }
 654       if (FLAG_IS_DEFAULT(JVMCIHostThreads)) {
 655       } else {
 656         _c1_count = JVMCIHostThreads;
 657       }
 658     }
 659   }
 660 #endif // INCLUDE_JVMCI
 661 
 662 #ifdef COMPILER1
 663   if (_c1_count &gt; 0) {
 664     _compilers[0] = new Compiler();
 665   }
 666 #endif // COMPILER1
 667 
 668 #ifdef COMPILER2
 669   if (true JVMCI_ONLY( &amp;&amp; !UseJVMCICompiler)) {
 670     if (_c2_count &gt; 0) {
 671       _compilers[1] = new C2Compiler();
 672       // Register c2 first as c2 CompilerPhaseType idToPhase mapping is explicit.
 673       // idToPhase mapping for c2 is in opto/phasetype.hpp
 674       JFR_ONLY(register_jfr_phasetype_serializer(compiler_c2);)
 675     }
 676   }
 677 #endif // COMPILER2
 678 
 679 #if INCLUDE_JVMCI
 680    // Register after c2 registration.
 681    // JVMCI CompilerPhaseType idToPhase mapping is dynamic.
 682    if (EnableJVMCI) {
 683      JFR_ONLY(register_jfr_phasetype_serializer(compiler_jvmci);)
 684    }
 685 #endif // INCLUDE_JVMCI
 686 
 687   // Start the compiler thread(s) and the sweeper thread
 688   init_compiler_sweeper_threads();
 689   // totalTime performance counter is always created as it is required
 690   // by the implementation of java.lang.management.CompilationMBean.
 691   {
 692     // Ensure OOM leads to vm_exit_during_initialization.
 693     EXCEPTION_MARK;
 694     _perf_total_compilation =
 695                  PerfDataManager::create_counter(JAVA_CI, &quot;totalTime&quot;,
 696                                                  PerfData::U_Ticks, CHECK);
 697   }
 698 
 699   if (UsePerfData) {
 700 
 701     EXCEPTION_MARK;
 702 
 703     // create the jvmstat performance counters
 704     _perf_osr_compilation =
 705                  PerfDataManager::create_counter(SUN_CI, &quot;osrTime&quot;,
 706                                                  PerfData::U_Ticks, CHECK);
 707 
 708     _perf_standard_compilation =
 709                  PerfDataManager::create_counter(SUN_CI, &quot;standardTime&quot;,
 710                                                  PerfData::U_Ticks, CHECK);
 711 
 712     _perf_total_bailout_count =
 713                  PerfDataManager::create_counter(SUN_CI, &quot;totalBailouts&quot;,
 714                                                  PerfData::U_Events, CHECK);
 715 
 716     _perf_total_invalidated_count =
 717                  PerfDataManager::create_counter(SUN_CI, &quot;totalInvalidates&quot;,
 718                                                  PerfData::U_Events, CHECK);
 719 
 720     _perf_total_compile_count =
 721                  PerfDataManager::create_counter(SUN_CI, &quot;totalCompiles&quot;,
 722                                                  PerfData::U_Events, CHECK);
 723     _perf_total_osr_compile_count =
 724                  PerfDataManager::create_counter(SUN_CI, &quot;osrCompiles&quot;,
 725                                                  PerfData::U_Events, CHECK);
 726 
 727     _perf_total_standard_compile_count =
 728                  PerfDataManager::create_counter(SUN_CI, &quot;standardCompiles&quot;,
 729                                                  PerfData::U_Events, CHECK);
 730 
 731     _perf_sum_osr_bytes_compiled =
 732                  PerfDataManager::create_counter(SUN_CI, &quot;osrBytes&quot;,
 733                                                  PerfData::U_Bytes, CHECK);
 734 
 735     _perf_sum_standard_bytes_compiled =
 736                  PerfDataManager::create_counter(SUN_CI, &quot;standardBytes&quot;,
 737                                                  PerfData::U_Bytes, CHECK);
 738 
 739     _perf_sum_nmethod_size =
 740                  PerfDataManager::create_counter(SUN_CI, &quot;nmethodSize&quot;,
 741                                                  PerfData::U_Bytes, CHECK);
 742 
 743     _perf_sum_nmethod_code_size =
 744                  PerfDataManager::create_counter(SUN_CI, &quot;nmethodCodeSize&quot;,
 745                                                  PerfData::U_Bytes, CHECK);
 746 
 747     _perf_last_method =
 748                  PerfDataManager::create_string_variable(SUN_CI, &quot;lastMethod&quot;,
 749                                        CompilerCounters::cmname_buffer_length,
 750                                        &quot;&quot;, CHECK);
 751 
 752     _perf_last_failed_method =
 753             PerfDataManager::create_string_variable(SUN_CI, &quot;lastFailedMethod&quot;,
 754                                        CompilerCounters::cmname_buffer_length,
 755                                        &quot;&quot;, CHECK);
 756 
 757     _perf_last_invalidated_method =
 758         PerfDataManager::create_string_variable(SUN_CI, &quot;lastInvalidatedMethod&quot;,
 759                                      CompilerCounters::cmname_buffer_length,
 760                                      &quot;&quot;, CHECK);
 761 
 762     _perf_last_compile_type =
 763              PerfDataManager::create_variable(SUN_CI, &quot;lastType&quot;,
 764                                               PerfData::U_None,
 765                                               (jlong)CompileBroker::no_compile,
 766                                               CHECK);
 767 
 768     _perf_last_compile_size =
 769              PerfDataManager::create_variable(SUN_CI, &quot;lastSize&quot;,
 770                                               PerfData::U_Bytes,
 771                                               (jlong)CompileBroker::no_compile,
 772                                               CHECK);
 773 
 774 
 775     _perf_last_failed_type =
 776              PerfDataManager::create_variable(SUN_CI, &quot;lastFailedType&quot;,
 777                                               PerfData::U_None,
 778                                               (jlong)CompileBroker::no_compile,
 779                                               CHECK);
 780 
 781     _perf_last_invalidated_type =
 782          PerfDataManager::create_variable(SUN_CI, &quot;lastInvalidatedType&quot;,
 783                                           PerfData::U_None,
 784                                           (jlong)CompileBroker::no_compile,
 785                                           CHECK);
 786   }
 787 }
 788 
 789 // Completes compiler initialization. Compilation requests submitted
 790 // prior to this will be silently ignored.
 791 void CompileBroker::compilation_init_phase2() {
 792   _initialized = true;
 793 }
 794 
 795 Handle CompileBroker::create_thread_oop(const char* name, TRAPS) {
 796   Handle string = java_lang_String::create_from_str(name, CHECK_NH);
 797   Handle thread_group(THREAD, Universe::system_thread_group());
 798   return JavaCalls::construct_new_instance(
 799                        SystemDictionary::Thread_klass(),
 800                        vmSymbols::threadgroup_string_void_signature(),
 801                        thread_group,
 802                        string,
 803                        CHECK_NH);
 804 }
 805 
 806 
 807 JavaThread* CompileBroker::make_thread(jobject thread_handle, CompileQueue* queue, AbstractCompiler* comp, Thread* THREAD) {
 808   JavaThread* new_thread = NULL;
 809   {
 810     MutexLocker mu(THREAD, Threads_lock);
 811     if (comp != NULL) {
 812       if (!InjectCompilerCreationFailure || comp-&gt;num_compiler_threads() == 0) {
 813         CompilerCounters* counters = new CompilerCounters();
 814         new_thread = new CompilerThread(queue, counters);
 815       }
 816     } else {
 817       new_thread = new CodeCacheSweeperThread();
 818     }
 819     // At this point the new CompilerThread data-races with this startup
 820     // thread (which I believe is the primoridal thread and NOT the VM
 821     // thread).  This means Java bytecodes being executed at startup can
 822     // queue compile jobs which will run at whatever default priority the
 823     // newly created CompilerThread runs at.
 824 
 825 
 826     // At this point it may be possible that no osthread was created for the
 827     // JavaThread due to lack of memory. We would have to throw an exception
 828     // in that case. However, since this must work and we do not allow
 829     // exceptions anyway, check and abort if this fails. But first release the
 830     // lock.
 831 
 832     if (new_thread != NULL &amp;&amp; new_thread-&gt;osthread() != NULL) {
 833 
 834       java_lang_Thread::set_thread(JNIHandles::resolve_non_null(thread_handle), new_thread);
 835 
 836       // Note that this only sets the JavaThread _priority field, which by
 837       // definition is limited to Java priorities and not OS priorities.
 838       // The os-priority is set in the CompilerThread startup code itself
 839 
 840       java_lang_Thread::set_priority(JNIHandles::resolve_non_null(thread_handle), NearMaxPriority);
 841 
 842       // Note that we cannot call os::set_priority because it expects Java
 843       // priorities and we are *explicitly* using OS priorities so that it&#39;s
 844       // possible to set the compiler thread priority higher than any Java
 845       // thread.
 846 
 847       int native_prio = CompilerThreadPriority;
 848       if (native_prio == -1) {
 849         if (UseCriticalCompilerThreadPriority) {
 850           native_prio = os::java_to_os_priority[CriticalPriority];
 851         } else {
 852           native_prio = os::java_to_os_priority[NearMaxPriority];
 853         }
 854       }
 855       os::set_native_priority(new_thread, native_prio);
 856 
 857       java_lang_Thread::set_daemon(JNIHandles::resolve_non_null(thread_handle));
 858 
 859       new_thread-&gt;set_threadObj(JNIHandles::resolve_non_null(thread_handle));
 860       if (comp != NULL) {
 861         new_thread-&gt;as_CompilerThread()-&gt;set_compiler(comp);
 862       }
 863       Threads::add(new_thread);
 864       Thread::start(new_thread);
 865     }
 866   }
 867 
 868   // First release lock before aborting VM.
 869   if (new_thread == NULL || new_thread-&gt;osthread() == NULL) {
 870     if (UseDynamicNumberOfCompilerThreads &amp;&amp; comp != NULL &amp;&amp; comp-&gt;num_compiler_threads() &gt; 0) {
 871       if (new_thread != NULL) {
 872         new_thread-&gt;smr_delete();
 873       }
 874       return NULL;
 875     }
 876     vm_exit_during_initialization(&quot;java.lang.OutOfMemoryError&quot;,
 877                                   os::native_thread_creation_failed_msg());
 878   }
 879 
 880   // Let go of Threads_lock before yielding
 881   os::naked_yield(); // make sure that the compiler thread is started early (especially helpful on SOLARIS)
 882 
 883   return new_thread;
 884 }
 885 
 886 
 887 void CompileBroker::init_compiler_sweeper_threads() {
 888   NMethodSweeper::set_sweep_threshold_bytes(static_cast&lt;size_t&gt;(SweeperThreshold * ReservedCodeCacheSize / 100.0));
 889   log_info(codecache, sweep)(&quot;Sweeper threshold: &quot; SIZE_FORMAT &quot; bytes&quot;, NMethodSweeper::sweep_threshold_bytes());
 890 
 891   // Ensure any exceptions lead to vm_exit_during_initialization.
 892   EXCEPTION_MARK;
 893 #if !defined(ZERO)
 894   assert(_c2_count &gt; 0 || _c1_count &gt; 0, &quot;No compilers?&quot;);
 895 #endif // !ZERO
 896   // Initialize the compilation queue
 897   if (_c2_count &gt; 0) {
 898     const char* name = JVMCI_ONLY(UseJVMCICompiler ? &quot;JVMCI compile queue&quot; :) &quot;C2 compile queue&quot;;
 899     _c2_compile_queue  = new CompileQueue(name);
 900     _compiler2_objects = NEW_C_HEAP_ARRAY(jobject, _c2_count, mtCompiler);
 901     _compiler2_logs = NEW_C_HEAP_ARRAY(CompileLog*, _c2_count, mtCompiler);
 902   }
 903   if (_c1_count &gt; 0) {
 904     _c1_compile_queue  = new CompileQueue(&quot;C1 compile queue&quot;);
 905     _compiler1_objects = NEW_C_HEAP_ARRAY(jobject, _c1_count, mtCompiler);
 906     _compiler1_logs = NEW_C_HEAP_ARRAY(CompileLog*, _c1_count, mtCompiler);
 907   }
 908 
 909   char name_buffer[256];
 910 
 911   for (int i = 0; i &lt; _c2_count; i++) {
 912     jobject thread_handle = NULL;
 913     // Create all j.l.Thread objects for C1 and C2 threads here, but only one
 914     // for JVMCI compiler which can create further ones on demand.
 915     JVMCI_ONLY(if (!UseJVMCICompiler || !UseDynamicNumberOfCompilerThreads || i == 0) {)
 916     // Create a name for our thread.
 917     sprintf(name_buffer, &quot;%s CompilerThread%d&quot;, _compilers[1]-&gt;name(), i);
 918     Handle thread_oop = create_thread_oop(name_buffer, CHECK);
 919     thread_handle = JNIHandles::make_global(thread_oop);
 920     JVMCI_ONLY(})
 921     _compiler2_objects[i] = thread_handle;
 922     _compiler2_logs[i] = NULL;
 923 
 924     if (!UseDynamicNumberOfCompilerThreads || i == 0) {
 925       JavaThread *ct = make_thread(thread_handle, _c2_compile_queue, _compilers[1], THREAD);
 926       assert(ct != NULL, &quot;should have been handled for initial thread&quot;);
 927       _compilers[1]-&gt;set_num_compiler_threads(i + 1);
 928       if (TraceCompilerThreads) {
 929         ResourceMark rm;
 930         MutexLocker mu(Threads_lock);
 931         tty-&gt;print_cr(&quot;Added initial compiler thread %s&quot;, ct-&gt;get_thread_name());
 932       }
 933     }
 934   }
 935 
 936   for (int i = 0; i &lt; _c1_count; i++) {
 937     // Create a name for our thread.
 938     sprintf(name_buffer, &quot;C1 CompilerThread%d&quot;, i);
 939     Handle thread_oop = create_thread_oop(name_buffer, CHECK);
 940     jobject thread_handle = JNIHandles::make_global(thread_oop);
 941     _compiler1_objects[i] = thread_handle;
 942     _compiler1_logs[i] = NULL;
 943 
 944     if (!UseDynamicNumberOfCompilerThreads || i == 0) {
 945       JavaThread *ct = make_thread(thread_handle, _c1_compile_queue, _compilers[0], THREAD);
 946       assert(ct != NULL, &quot;should have been handled for initial thread&quot;);
 947       _compilers[0]-&gt;set_num_compiler_threads(i + 1);
 948       if (TraceCompilerThreads) {
 949         ResourceMark rm;
 950         MutexLocker mu(Threads_lock);
 951         tty-&gt;print_cr(&quot;Added initial compiler thread %s&quot;, ct-&gt;get_thread_name());
 952       }
 953     }
 954   }
 955 
 956   if (UsePerfData) {
 957     PerfDataManager::create_constant(SUN_CI, &quot;threads&quot;, PerfData::U_Bytes, _c1_count + _c2_count, CHECK);
 958   }
 959 
 960   if (MethodFlushing) {
 961     // Initialize the sweeper thread
 962     Handle thread_oop = create_thread_oop(&quot;Sweeper thread&quot;, CHECK);
 963     jobject thread_handle = JNIHandles::make_local(THREAD, thread_oop());
 964     make_thread(thread_handle, NULL, NULL, THREAD);
 965   }
 966 }
 967 
 968 void CompileBroker::possibly_add_compiler_threads(Thread* THREAD) {
 969 
 970   julong available_memory = os::available_memory();
 971   // If SegmentedCodeCache is off, both values refer to the single heap (with type CodeBlobType::All).
 972   size_t available_cc_np  = CodeCache::unallocated_capacity(CodeBlobType::MethodNonProfiled),
 973          available_cc_p   = CodeCache::unallocated_capacity(CodeBlobType::MethodProfiled);
 974 
 975   // Only do attempt to start additional threads if the lock is free.
 976   if (!CompileThread_lock-&gt;try_lock()) return;
 977 
 978   if (_c2_compile_queue != NULL) {
 979     int old_c2_count = _compilers[1]-&gt;num_compiler_threads();
 980     int new_c2_count = MIN4(_c2_count,
 981         _c2_compile_queue-&gt;size() / 2,
 982         (int)(available_memory / (200*M)),
 983         (int)(available_cc_np / (128*K)));
 984 
 985     for (int i = old_c2_count; i &lt; new_c2_count; i++) {
 986 #if INCLUDE_JVMCI
 987       if (UseJVMCICompiler) {
 988         // Native compiler threads as used in C1/C2 can reuse the j.l.Thread
 989         // objects as their existence is completely hidden from the rest of
 990         // the VM (and those compiler threads can&#39;t call Java code to do the
 991         // creation anyway). For JVMCI we have to create new j.l.Thread objects
 992         // as they are visible and we can see unexpected thread lifecycle
 993         // transitions if we bind them to new JavaThreads.
 994         if (!THREAD-&gt;can_call_java()) break;
 995         char name_buffer[256];
 996         sprintf(name_buffer, &quot;%s CompilerThread%d&quot;, _compilers[1]-&gt;name(), i);
 997         Handle thread_oop;
 998         {
 999           // We have to give up the lock temporarily for the Java calls.
1000           MutexUnlocker mu(CompileThread_lock);
1001           thread_oop = create_thread_oop(name_buffer, THREAD);
1002         }
1003         if (HAS_PENDING_EXCEPTION) {
1004           if (TraceCompilerThreads) {
1005             ResourceMark rm;
1006             tty-&gt;print_cr(&quot;JVMCI compiler thread creation failed:&quot;);
1007             PENDING_EXCEPTION-&gt;print();
1008           }
1009           CLEAR_PENDING_EXCEPTION;
1010           break;
1011         }
1012         // Check if another thread has beaten us during the Java calls.
1013         if (_compilers[1]-&gt;num_compiler_threads() != i) break;
1014         jobject thread_handle = JNIHandles::make_global(thread_oop);
1015         assert(compiler2_object(i) == NULL, &quot;Old one must be released!&quot;);
1016         _compiler2_objects[i] = thread_handle;
1017       }
1018 #endif
1019       JavaThread *ct = make_thread(compiler2_object(i), _c2_compile_queue, _compilers[1], THREAD);
1020       if (ct == NULL) break;
1021       _compilers[1]-&gt;set_num_compiler_threads(i + 1);
1022       if (TraceCompilerThreads) {
1023         ResourceMark rm;
1024         MutexLocker mu(Threads_lock);
1025         tty-&gt;print_cr(&quot;Added compiler thread %s (available memory: %dMB, available non-profiled code cache: %dMB)&quot;,
1026                       ct-&gt;get_thread_name(), (int)(available_memory/M), (int)(available_cc_np/M));
1027       }
1028     }
1029   }
1030 
1031   if (_c1_compile_queue != NULL) {
1032     int old_c1_count = _compilers[0]-&gt;num_compiler_threads();
1033     int new_c1_count = MIN4(_c1_count,
1034         _c1_compile_queue-&gt;size() / 4,
1035         (int)(available_memory / (100*M)),
1036         (int)(available_cc_p / (128*K)));
1037 
1038     for (int i = old_c1_count; i &lt; new_c1_count; i++) {
1039       JavaThread *ct = make_thread(compiler1_object(i), _c1_compile_queue, _compilers[0], THREAD);
1040       if (ct == NULL) break;
1041       _compilers[0]-&gt;set_num_compiler_threads(i + 1);
1042       if (TraceCompilerThreads) {
1043         ResourceMark rm;
1044         MutexLocker mu(Threads_lock);
1045         tty-&gt;print_cr(&quot;Added compiler thread %s (available memory: %dMB, available profiled code cache: %dMB)&quot;,
1046                       ct-&gt;get_thread_name(), (int)(available_memory/M), (int)(available_cc_p/M));
1047       }
1048     }
1049   }
1050 
1051   CompileThread_lock-&gt;unlock();
1052 }
1053 
1054 
1055 /**
1056  * Set the methods on the stack as on_stack so that redefine classes doesn&#39;t
1057  * reclaim them. This method is executed at a safepoint.
1058  */
1059 void CompileBroker::mark_on_stack() {
1060   assert(SafepointSynchronize::is_at_safepoint(), &quot;sanity check&quot;);
1061   // Since we are at a safepoint, we do not need a lock to access
1062   // the compile queues.
1063   if (_c2_compile_queue != NULL) {
1064     _c2_compile_queue-&gt;mark_on_stack();
1065   }
1066   if (_c1_compile_queue != NULL) {
1067     _c1_compile_queue-&gt;mark_on_stack();
1068   }
1069 }
1070 
1071 // ------------------------------------------------------------------
1072 // CompileBroker::compile_method
1073 //
1074 // Request compilation of a method.
1075 void CompileBroker::compile_method_base(const methodHandle&amp; method,
1076                                         int osr_bci,
1077                                         int comp_level,
1078                                         const methodHandle&amp; hot_method,
1079                                         int hot_count,
1080                                         CompileTask::CompileReason compile_reason,
1081                                         bool blocking,
1082                                         Thread* thread) {
1083   guarantee(!method-&gt;is_abstract(), &quot;cannot compile abstract methods&quot;);
1084   assert(method-&gt;method_holder()-&gt;is_instance_klass(),
1085          &quot;sanity check&quot;);
1086   assert(!method-&gt;method_holder()-&gt;is_not_initialized(),
1087          &quot;method holder must be initialized&quot;);
1088   assert(!method-&gt;is_method_handle_intrinsic(), &quot;do not enqueue these guys&quot;);
1089 
1090   if (CIPrintRequests) {
1091     tty-&gt;print(&quot;request: &quot;);
1092     method-&gt;print_short_name(tty);
1093     if (osr_bci != InvocationEntryBci) {
1094       tty-&gt;print(&quot; osr_bci: %d&quot;, osr_bci);
1095     }
1096     tty-&gt;print(&quot; level: %d comment: %s count: %d&quot;, comp_level, CompileTask::reason_name(compile_reason), hot_count);
1097     if (!hot_method.is_null()) {
1098       tty-&gt;print(&quot; hot: &quot;);
1099       if (hot_method() != method()) {
1100           hot_method-&gt;print_short_name(tty);
1101       } else {
1102         tty-&gt;print(&quot;yes&quot;);
1103       }
1104     }
1105     tty-&gt;cr();
1106   }
1107 
1108   // A request has been made for compilation.  Before we do any
1109   // real work, check to see if the method has been compiled
1110   // in the meantime with a definitive result.
1111   if (compilation_is_complete(method, osr_bci, comp_level)) {
1112     return;
1113   }
1114 
1115 #ifndef PRODUCT
1116   if (osr_bci != -1 &amp;&amp; !FLAG_IS_DEFAULT(OSROnlyBCI)) {
1117     if ((OSROnlyBCI &gt; 0) ? (OSROnlyBCI != osr_bci) : (-OSROnlyBCI == osr_bci)) {
1118       // Positive OSROnlyBCI means only compile that bci.  Negative means don&#39;t compile that BCI.
1119       return;
1120     }
1121   }
1122 #endif
1123 
1124   // If this method is already in the compile queue, then
1125   // we do not block the current thread.
1126   if (compilation_is_in_queue(method)) {
1127     // We may want to decay our counter a bit here to prevent
1128     // multiple denied requests for compilation.  This is an
1129     // open compilation policy issue. Note: The other possibility,
1130     // in the case that this is a blocking compile request, is to have
1131     // all subsequent blocking requesters wait for completion of
1132     // ongoing compiles. Note that in this case we&#39;ll need a protocol
1133     // for freeing the associated compile tasks. [Or we could have
1134     // a single static monitor on which all these waiters sleep.]
1135     return;
1136   }
1137 
1138   if (TieredCompilation) {
1139     // Tiered policy requires MethodCounters to exist before adding a method to
1140     // the queue. Create if we don&#39;t have them yet.
1141     method-&gt;get_method_counters(thread);
1142   }
1143 
1144   // Outputs from the following MutexLocker block:
1145   CompileTask* task     = NULL;
1146   CompileQueue* queue  = compile_queue(comp_level);
1147 
1148   // Acquire our lock.
1149   {
1150     MutexLocker locker(thread, MethodCompileQueue_lock);
1151 
1152     // Make sure the method has not slipped into the queues since
1153     // last we checked; note that those checks were &quot;fast bail-outs&quot;.
1154     // Here we need to be more careful, see 14012000 below.
1155     if (compilation_is_in_queue(method)) {
1156       return;
1157     }
1158 
1159     // We need to check again to see if the compilation has
1160     // completed.  A previous compilation may have registered
1161     // some result.
1162     if (compilation_is_complete(method, osr_bci, comp_level)) {
1163       return;
1164     }
1165 
1166     // We now know that this compilation is not pending, complete,
1167     // or prohibited.  Assign a compile_id to this compilation
1168     // and check to see if it is in our [Start..Stop) range.
1169     int compile_id = assign_compile_id(method, osr_bci);
1170     if (compile_id == 0) {
1171       // The compilation falls outside the allowed range.
1172       return;
1173     }
1174 
1175 #if INCLUDE_JVMCI
1176     if (UseJVMCICompiler &amp;&amp; blocking) {
1177       // Don&#39;t allow blocking compiles for requests triggered by JVMCI.
1178       if (thread-&gt;is_Compiler_thread()) {
1179         blocking = false;
1180       }
1181 
1182       if (!UseJVMCINativeLibrary) {
1183         // Don&#39;t allow blocking compiles if inside a class initializer or while performing class loading
1184         vframeStream vfst((JavaThread*) thread);
1185         for (; !vfst.at_end(); vfst.next()) {
<a name="1" id="anc1"></a><span class="line-modified">1186           if (vfst.method()-&gt;is_static_initializer() ||</span>
1187               (vfst.method()-&gt;method_holder()-&gt;is_subclass_of(SystemDictionary::ClassLoader_klass()) &amp;&amp;
1188                   vfst.method()-&gt;name() == vmSymbols::loadClass_name())) {
1189             blocking = false;
1190             break;
1191           }
1192         }
1193       }
1194 
1195       // Don&#39;t allow blocking compilation requests to JVMCI
1196       // if JVMCI itself is not yet initialized
1197       if (!JVMCI::is_compiler_initialized() &amp;&amp; compiler(comp_level)-&gt;is_jvmci()) {
1198         blocking = false;
1199       }
1200 
1201       // Don&#39;t allow blocking compilation requests if we are in JVMCIRuntime::shutdown
1202       // to avoid deadlock between compiler thread(s) and threads run at shutdown
1203       // such as the DestroyJavaVM thread.
1204       if (JVMCI::shutdown_called()) {
1205         blocking = false;
1206       }
1207     }
1208 #endif // INCLUDE_JVMCI
1209 
1210     // We will enter the compilation in the queue.
1211     // 14012000: Note that this sets the queued_for_compile bits in
1212     // the target method. We can now reason that a method cannot be
1213     // queued for compilation more than once, as follows:
1214     // Before a thread queues a task for compilation, it first acquires
1215     // the compile queue lock, then checks if the method&#39;s queued bits
1216     // are set or it has already been compiled. Thus there can not be two
1217     // instances of a compilation task for the same method on the
1218     // compilation queue. Consider now the case where the compilation
1219     // thread has already removed a task for that method from the queue
1220     // and is in the midst of compiling it. In this case, the
1221     // queued_for_compile bits must be set in the method (and these
1222     // will be visible to the current thread, since the bits were set
1223     // under protection of the compile queue lock, which we hold now.
1224     // When the compilation completes, the compiler thread first sets
1225     // the compilation result and then clears the queued_for_compile
1226     // bits. Neither of these actions are protected by a barrier (or done
1227     // under the protection of a lock), so the only guarantee we have
1228     // (on machines with TSO (Total Store Order)) is that these values
1229     // will update in that order. As a result, the only combinations of
1230     // these bits that the current thread will see are, in temporal order:
1231     // &lt;RESULT, QUEUE&gt; :
1232     //     &lt;0, 1&gt; : in compile queue, but not yet compiled
1233     //     &lt;1, 1&gt; : compiled but queue bit not cleared
1234     //     &lt;1, 0&gt; : compiled and queue bit cleared
1235     // Because we first check the queue bits then check the result bits,
1236     // we are assured that we cannot introduce a duplicate task.
1237     // Note that if we did the tests in the reverse order (i.e. check
1238     // result then check queued bit), we could get the result bit before
1239     // the compilation completed, and the queue bit after the compilation
1240     // completed, and end up introducing a &quot;duplicate&quot; (redundant) task.
1241     // In that case, the compiler thread should first check if a method
1242     // has already been compiled before trying to compile it.
1243     // NOTE: in the event that there are multiple compiler threads and
1244     // there is de-optimization/recompilation, things will get hairy,
1245     // and in that case it&#39;s best to protect both the testing (here) of
1246     // these bits, and their updating (here and elsewhere) under a
1247     // common lock.
1248     task = create_compile_task(queue,
1249                                compile_id, method,
1250                                osr_bci, comp_level,
1251                                hot_method, hot_count, compile_reason,
1252                                blocking);
1253   }
1254 
1255   if (blocking) {
1256     wait_for_completion(task);
1257   }
1258 }
1259 
1260 nmethod* CompileBroker::compile_method(const methodHandle&amp; method, int osr_bci,
1261                                        int comp_level,
1262                                        const methodHandle&amp; hot_method, int hot_count,
1263                                        CompileTask::CompileReason compile_reason,
1264                                        Thread* THREAD) {
1265   // Do nothing if compilebroker is not initalized or compiles are submitted on level none
1266   if (!_initialized || comp_level == CompLevel_none) {
1267     return NULL;
1268   }
1269 
1270   AbstractCompiler *comp = CompileBroker::compiler(comp_level);
1271   assert(comp != NULL, &quot;Ensure we have a compiler&quot;);
1272 
1273   DirectiveSet* directive = DirectivesStack::getMatchingDirective(method, comp);
1274   nmethod* nm = CompileBroker::compile_method(method, osr_bci, comp_level, hot_method, hot_count, compile_reason, directive, THREAD);
1275   DirectivesStack::release(directive);
1276   return nm;
1277 }
1278 
1279 nmethod* CompileBroker::compile_method(const methodHandle&amp; method, int osr_bci,
1280                                          int comp_level,
1281                                          const methodHandle&amp; hot_method, int hot_count,
1282                                          CompileTask::CompileReason compile_reason,
1283                                          DirectiveSet* directive,
1284                                          Thread* THREAD) {
1285 
1286   // make sure arguments make sense
1287   assert(method-&gt;method_holder()-&gt;is_instance_klass(), &quot;not an instance method&quot;);
1288   assert(osr_bci == InvocationEntryBci || (0 &lt;= osr_bci &amp;&amp; osr_bci &lt; method-&gt;code_size()), &quot;bci out of range&quot;);
1289   assert(!method-&gt;is_abstract() &amp;&amp; (osr_bci == InvocationEntryBci || !method-&gt;is_native()), &quot;cannot compile abstract/native methods&quot;);
1290   assert(!method-&gt;method_holder()-&gt;is_not_initialized(), &quot;method holder must be initialized&quot;);
1291   assert(!TieredCompilation || comp_level &lt;= TieredStopAtLevel, &quot;Invalid compilation level&quot;);
1292   // allow any levels for WhiteBox
1293   assert(WhiteBoxAPI || TieredCompilation || comp_level == CompLevel_highest_tier, &quot;only CompLevel_highest_tier must be used in non-tiered&quot;);
1294   // return quickly if possible
1295 
1296   // lock, make sure that the compilation
1297   // isn&#39;t prohibited in a straightforward way.
1298   AbstractCompiler* comp = CompileBroker::compiler(comp_level);
1299   if (comp == NULL || !comp-&gt;can_compile_method(method) ||
1300       compilation_is_prohibited(method, osr_bci, comp_level, directive-&gt;ExcludeOption)) {
1301     return NULL;
1302   }
1303 
1304 #if INCLUDE_JVMCI
1305   if (comp-&gt;is_jvmci() &amp;&amp; !JVMCI::can_initialize_JVMCI()) {
1306     return NULL;
1307   }
1308 #endif
1309 
1310   if (osr_bci == InvocationEntryBci) {
1311     // standard compilation
1312     CompiledMethod* method_code = method-&gt;code();
1313     if (method_code != NULL &amp;&amp; method_code-&gt;is_nmethod()) {
1314       if (compilation_is_complete(method, osr_bci, comp_level)) {
1315         return (nmethod*) method_code;
1316       }
1317     }
1318     if (method-&gt;is_not_compilable(comp_level)) {
1319       return NULL;
1320     }
1321   } else {
1322     // osr compilation
1323 #ifndef TIERED
1324     // seems like an assert of dubious value
1325     assert(comp_level == CompLevel_highest_tier,
1326            &quot;all OSR compiles are assumed to be at a single compilation level&quot;);
1327 #endif // TIERED
1328     // We accept a higher level osr method
1329     nmethod* nm = method-&gt;lookup_osr_nmethod_for(osr_bci, comp_level, false);
1330     if (nm != NULL) return nm;
1331     if (method-&gt;is_not_osr_compilable(comp_level)) return NULL;
1332   }
1333 
1334   assert(!HAS_PENDING_EXCEPTION, &quot;No exception should be present&quot;);
1335   // some prerequisites that are compiler specific
1336   if (comp-&gt;is_c2()) {
1337     method-&gt;constants()-&gt;resolve_string_constants(CHECK_AND_CLEAR_NULL);
1338     // Resolve all classes seen in the signature of the method
1339     // we are compiling.
1340     Method::load_signature_classes(method, CHECK_AND_CLEAR_NULL);
1341   }
1342 
1343   // If the method is native, do the lookup in the thread requesting
1344   // the compilation. Native lookups can load code, which is not
1345   // permitted during compilation.
1346   //
1347   // Note: A native method implies non-osr compilation which is
1348   //       checked with an assertion at the entry of this method.
1349   if (method-&gt;is_native() &amp;&amp; !method-&gt;is_method_handle_intrinsic()) {
1350     bool in_base_library;
1351     address adr = NativeLookup::lookup(method, in_base_library, THREAD);
1352     if (HAS_PENDING_EXCEPTION) {
1353       // In case of an exception looking up the method, we just forget
1354       // about it. The interpreter will kick-in and throw the exception.
1355       method-&gt;set_not_compilable(&quot;NativeLookup::lookup failed&quot;); // implies is_not_osr_compilable()
1356       CLEAR_PENDING_EXCEPTION;
1357       return NULL;
1358     }
1359     assert(method-&gt;has_native_function(), &quot;must have native code by now&quot;);
1360   }
1361 
1362   // RedefineClasses() has replaced this method; just return
1363   if (method-&gt;is_old()) {
1364     return NULL;
1365   }
1366 
1367   // JVMTI -- post_compile_event requires jmethod_id() that may require
1368   // a lock the compiling thread can not acquire. Prefetch it here.
1369   if (JvmtiExport::should_post_compiled_method_load()) {
1370     method-&gt;jmethod_id();
1371   }
1372 
1373   // do the compilation
1374   if (method-&gt;is_native()) {
1375     if (!PreferInterpreterNativeStubs || method-&gt;is_method_handle_intrinsic()) {
1376 #if defined(X86) &amp;&amp; !defined(ZERO)
1377       // The following native methods:
1378       //
1379       // java.lang.Float.intBitsToFloat
1380       // java.lang.Float.floatToRawIntBits
1381       // java.lang.Double.longBitsToDouble
1382       // java.lang.Double.doubleToRawLongBits
1383       //
1384       // are called through the interpreter even if interpreter native stubs
1385       // are not preferred (i.e., calling through adapter handlers is preferred).
1386       // The reason is that on x86_32 signaling NaNs (sNaNs) are not preserved
1387       // if the version of the methods from the native libraries is called.
1388       // As the interpreter and the C2-intrinsified version of the methods preserves
1389       // sNaNs, that would result in an inconsistent way of handling of sNaNs.
1390       if ((UseSSE &gt;= 1 &amp;&amp;
1391           (method-&gt;intrinsic_id() == vmIntrinsics::_intBitsToFloat ||
1392            method-&gt;intrinsic_id() == vmIntrinsics::_floatToRawIntBits)) ||
1393           (UseSSE &gt;= 2 &amp;&amp;
1394            (method-&gt;intrinsic_id() == vmIntrinsics::_longBitsToDouble ||
1395             method-&gt;intrinsic_id() == vmIntrinsics::_doubleToRawLongBits))) {
1396         return NULL;
1397       }
1398 #endif // X86 &amp;&amp; !ZERO
1399 
1400       // To properly handle the appendix argument for out-of-line calls we are using a small trampoline that
1401       // pops off the appendix argument and jumps to the target (see gen_special_dispatch in SharedRuntime).
1402       //
1403       // Since normal compiled-to-compiled calls are not able to handle such a thing we MUST generate an adapter
1404       // in this case.  If we can&#39;t generate one and use it we can not execute the out-of-line method handle calls.
1405       AdapterHandlerLibrary::create_native_wrapper(method);
1406     } else {
1407       return NULL;
1408     }
1409   } else {
1410     // If the compiler is shut off due to code cache getting full
1411     // fail out now so blocking compiles dont hang the java thread
1412     if (!should_compile_new_jobs()) {
1413       CompilationPolicy::policy()-&gt;delay_compilation(method());
1414       return NULL;
1415     }
1416     bool is_blocking = !directive-&gt;BackgroundCompilationOption || ReplayCompiles;
1417     compile_method_base(method, osr_bci, comp_level, hot_method, hot_count, compile_reason, is_blocking, THREAD);
1418   }
1419 
1420   // return requested nmethod
1421   // We accept a higher level osr method
1422   if (osr_bci == InvocationEntryBci) {
1423     CompiledMethod* code = method-&gt;code();
1424     if (code == NULL) {
1425       return (nmethod*) code;
1426     } else {
1427       return code-&gt;as_nmethod_or_null();
1428     }
1429   }
1430   return method-&gt;lookup_osr_nmethod_for(osr_bci, comp_level, false);
1431 }
1432 
1433 
1434 // ------------------------------------------------------------------
1435 // CompileBroker::compilation_is_complete
1436 //
1437 // See if compilation of this method is already complete.
1438 bool CompileBroker::compilation_is_complete(const methodHandle&amp; method,
1439                                             int                 osr_bci,
1440                                             int                 comp_level) {
1441   bool is_osr = (osr_bci != standard_entry_bci);
1442   if (is_osr) {
1443     if (method-&gt;is_not_osr_compilable(comp_level)) {
1444       return true;
1445     } else {
1446       nmethod* result = method-&gt;lookup_osr_nmethod_for(osr_bci, comp_level, true);
1447       return (result != NULL);
1448     }
1449   } else {
1450     if (method-&gt;is_not_compilable(comp_level)) {
1451       return true;
1452     } else {
1453       CompiledMethod* result = method-&gt;code();
1454       if (result == NULL) return false;
1455       return comp_level == result-&gt;comp_level();
1456     }
1457   }
1458 }
1459 
1460 
1461 /**
1462  * See if this compilation is already requested.
1463  *
1464  * Implementation note: there is only a single &quot;is in queue&quot; bit
1465  * for each method.  This means that the check below is overly
1466  * conservative in the sense that an osr compilation in the queue
1467  * will block a normal compilation from entering the queue (and vice
1468  * versa).  This can be remedied by a full queue search to disambiguate
1469  * cases.  If it is deemed profitable, this may be done.
1470  */
1471 bool CompileBroker::compilation_is_in_queue(const methodHandle&amp; method) {
1472   return method-&gt;queued_for_compilation();
1473 }
1474 
1475 // ------------------------------------------------------------------
1476 // CompileBroker::compilation_is_prohibited
1477 //
1478 // See if this compilation is not allowed.
1479 bool CompileBroker::compilation_is_prohibited(const methodHandle&amp; method, int osr_bci, int comp_level, bool excluded) {
1480   bool is_native = method-&gt;is_native();
1481   // Some compilers may not support the compilation of natives.
1482   AbstractCompiler *comp = compiler(comp_level);
1483   if (is_native &amp;&amp;
1484       (!CICompileNatives || comp == NULL || !comp-&gt;supports_native())) {
1485     method-&gt;set_not_compilable_quietly(&quot;native methods not supported&quot;, comp_level);
1486     return true;
1487   }
1488 
1489   bool is_osr = (osr_bci != standard_entry_bci);
1490   // Some compilers may not support on stack replacement.
1491   if (is_osr &amp;&amp;
1492       (!CICompileOSR || comp == NULL || !comp-&gt;supports_osr())) {
1493     method-&gt;set_not_osr_compilable(&quot;OSR not supported&quot;, comp_level);
1494     return true;
1495   }
1496 
1497   // The method may be explicitly excluded by the user.
1498   double scale;
1499   if (excluded || (CompilerOracle::has_option_value(method, &quot;CompileThresholdScaling&quot;, scale) &amp;&amp; scale == 0)) {
1500     bool quietly = CompilerOracle::should_exclude_quietly();
1501     if (PrintCompilation &amp;&amp; !quietly) {
1502       // This does not happen quietly...
1503       ResourceMark rm;
1504       tty-&gt;print(&quot;### Excluding %s:%s&quot;,
1505                  method-&gt;is_native() ? &quot;generation of native wrapper&quot; : &quot;compile&quot;,
1506                  (method-&gt;is_static() ? &quot; static&quot; : &quot;&quot;));
1507       method-&gt;print_short_name(tty);
1508       tty-&gt;cr();
1509     }
1510     method-&gt;set_not_compilable(&quot;excluded by CompileCommand&quot;, comp_level, !quietly);
1511   }
1512 
1513   return false;
1514 }
1515 
1516 /**
1517  * Generate serialized IDs for compilation requests. If certain debugging flags are used
1518  * and the ID is not within the specified range, the method is not compiled and 0 is returned.
1519  * The function also allows to generate separate compilation IDs for OSR compilations.
1520  */
1521 int CompileBroker::assign_compile_id(const methodHandle&amp; method, int osr_bci) {
1522 #ifdef ASSERT
1523   bool is_osr = (osr_bci != standard_entry_bci);
1524   int id;
1525   if (method-&gt;is_native()) {
1526     assert(!is_osr, &quot;can&#39;t be osr&quot;);
1527     // Adapters, native wrappers and method handle intrinsics
1528     // should be generated always.
1529     return Atomic::add(&amp;_compilation_id, 1);
1530   } else if (CICountOSR &amp;&amp; is_osr) {
1531     id = Atomic::add(&amp;_osr_compilation_id, 1);
1532     if (CIStartOSR &lt;= id &amp;&amp; id &lt; CIStopOSR) {
1533       return id;
1534     }
1535   } else {
1536     id = Atomic::add(&amp;_compilation_id, 1);
1537     if (CIStart &lt;= id &amp;&amp; id &lt; CIStop) {
1538       return id;
1539     }
1540   }
1541 
1542   // Method was not in the appropriate compilation range.
1543   method-&gt;set_not_compilable_quietly(&quot;Not in requested compile id range&quot;);
1544   return 0;
1545 #else
1546   // CICountOSR is a develop flag and set to &#39;false&#39; by default. In a product built,
1547   // only _compilation_id is incremented.
1548   return Atomic::add(&amp;_compilation_id, 1);
1549 #endif
1550 }
1551 
1552 // ------------------------------------------------------------------
1553 // CompileBroker::assign_compile_id_unlocked
1554 //
1555 // Public wrapper for assign_compile_id that acquires the needed locks
1556 uint CompileBroker::assign_compile_id_unlocked(Thread* thread, const methodHandle&amp; method, int osr_bci) {
1557   MutexLocker locker(thread, MethodCompileQueue_lock);
1558   return assign_compile_id(method, osr_bci);
1559 }
1560 
1561 // ------------------------------------------------------------------
1562 // CompileBroker::create_compile_task
1563 //
1564 // Create a CompileTask object representing the current request for
1565 // compilation.  Add this task to the queue.
1566 CompileTask* CompileBroker::create_compile_task(CompileQueue*       queue,
1567                                                 int                 compile_id,
1568                                                 const methodHandle&amp; method,
1569                                                 int                 osr_bci,
1570                                                 int                 comp_level,
1571                                                 const methodHandle&amp; hot_method,
1572                                                 int                 hot_count,
1573                                                 CompileTask::CompileReason compile_reason,
1574                                                 bool                blocking) {
1575   CompileTask* new_task = CompileTask::allocate();
1576   new_task-&gt;initialize(compile_id, method, osr_bci, comp_level,
1577                        hot_method, hot_count, compile_reason,
1578                        blocking);
1579   queue-&gt;add(new_task);
1580   return new_task;
1581 }
1582 
1583 #if INCLUDE_JVMCI
1584 // The number of milliseconds to wait before checking if
1585 // JVMCI compilation has made progress.
1586 static const long JVMCI_COMPILATION_PROGRESS_WAIT_TIMESLICE = 1000;
1587 
1588 // The number of JVMCI compilation progress checks that must fail
1589 // before unblocking a thread waiting for a blocking compilation.
1590 static const int JVMCI_COMPILATION_PROGRESS_WAIT_ATTEMPTS = 10;
1591 
1592 /**
1593  * Waits for a JVMCI compiler to complete a given task. This thread
1594  * waits until either the task completes or it sees no JVMCI compilation
1595  * progress for N consecutive milliseconds where N is
1596  * JVMCI_COMPILATION_PROGRESS_WAIT_TIMESLICE *
1597  * JVMCI_COMPILATION_PROGRESS_WAIT_ATTEMPTS.
1598  *
1599  * @return true if this thread needs to free/recycle the task
1600  */
1601 bool CompileBroker::wait_for_jvmci_completion(JVMCICompiler* jvmci, CompileTask* task, JavaThread* thread) {
1602   MonitorLocker ml(thread, task-&gt;lock());
1603   int progress_wait_attempts = 0;
1604   int methods_compiled = jvmci-&gt;methods_compiled();
1605   while (!task-&gt;is_complete() &amp;&amp; !is_compilation_disabled_forever() &amp;&amp;
1606          ml.wait(JVMCI_COMPILATION_PROGRESS_WAIT_TIMESLICE)) {
1607     CompilerThread* jvmci_compiler_thread = task-&gt;jvmci_compiler_thread();
1608 
1609     bool progress;
1610     if (jvmci_compiler_thread != NULL) {
1611       // If the JVMCI compiler thread is not blocked or suspended, we deem it to be making progress.
1612       progress = jvmci_compiler_thread-&gt;thread_state() != _thread_blocked &amp;&amp;
1613         !jvmci_compiler_thread-&gt;is_external_suspend();
1614     } else {
1615       // Still waiting on JVMCI compiler queue. This thread may be holding a lock
1616       // that all JVMCI compiler threads are blocked on. We use the counter for
1617       // successful JVMCI compilations to determine whether JVMCI compilation
1618       // is still making progress through the JVMCI compiler queue.
1619       progress = jvmci-&gt;methods_compiled() != methods_compiled;
1620     }
1621 
1622     if (!progress) {
1623       if (++progress_wait_attempts == JVMCI_COMPILATION_PROGRESS_WAIT_ATTEMPTS) {
1624         if (PrintCompilation) {
1625           task-&gt;print(tty, &quot;wait for blocking compilation timed out&quot;);
1626         }
1627         break;
1628       }
1629     } else {
1630       progress_wait_attempts = 0;
1631       if (jvmci_compiler_thread == NULL) {
1632         methods_compiled = jvmci-&gt;methods_compiled();
1633       }
1634     }
1635   }
1636   task-&gt;clear_waiter();
1637   return task-&gt;is_complete();
1638 }
1639 #endif
1640 
1641 /**
1642  *  Wait for the compilation task to complete.
1643  */
1644 void CompileBroker::wait_for_completion(CompileTask* task) {
1645   if (CIPrintCompileQueue) {
1646     ttyLocker ttyl;
1647     tty-&gt;print_cr(&quot;BLOCKING FOR COMPILE&quot;);
1648   }
1649 
1650   assert(task-&gt;is_blocking(), &quot;can only wait on blocking task&quot;);
1651 
1652   JavaThread* thread = JavaThread::current();
1653 
1654   methodHandle method(thread, task-&gt;method());
1655   bool free_task;
1656 #if INCLUDE_JVMCI
1657   AbstractCompiler* comp = compiler(task-&gt;comp_level());
1658   if (comp-&gt;is_jvmci() &amp;&amp; !task-&gt;should_wait_for_compilation()) {
1659     // It may return before compilation is completed.
1660     free_task = wait_for_jvmci_completion((JVMCICompiler*) comp, task, thread);
1661   } else
1662 #endif
1663   {
1664     MonitorLocker ml(thread, task-&gt;lock());
1665     free_task = true;
1666     while (!task-&gt;is_complete() &amp;&amp; !is_compilation_disabled_forever()) {
1667       ml.wait();
1668     }
1669   }
1670 
1671   if (free_task) {
1672     if (is_compilation_disabled_forever()) {
1673       CompileTask::free(task);
1674       return;
1675     }
1676 
1677     // It is harmless to check this status without the lock, because
1678     // completion is a stable property (until the task object is recycled).
1679     assert(task-&gt;is_complete(), &quot;Compilation should have completed&quot;);
1680     assert(task-&gt;code_handle() == NULL, &quot;must be reset&quot;);
1681 
1682     // By convention, the waiter is responsible for recycling a
1683     // blocking CompileTask. Since there is only one waiter ever
1684     // waiting on a CompileTask, we know that no one else will
1685     // be using this CompileTask; we can free it.
1686     CompileTask::free(task);
1687   }
1688 }
1689 
1690 /**
1691  * Initialize compiler thread(s) + compiler object(s). The postcondition
1692  * of this function is that the compiler runtimes are initialized and that
1693  * compiler threads can start compiling.
1694  */
1695 bool CompileBroker::init_compiler_runtime() {
1696   CompilerThread* thread = CompilerThread::current();
1697   AbstractCompiler* comp = thread-&gt;compiler();
1698   // Final sanity check - the compiler object must exist
1699   guarantee(comp != NULL, &quot;Compiler object must exist&quot;);
1700 
1701   {
1702     // Must switch to native to allocate ci_env
1703     ThreadToNativeFromVM ttn(thread);
1704     ciEnv ci_env((CompileTask*)NULL);
1705     // Cache Jvmti state
1706     ci_env.cache_jvmti_state();
1707     // Cache DTrace flags
1708     ci_env.cache_dtrace_flags();
1709 
1710     // Switch back to VM state to do compiler initialization
1711     ThreadInVMfromNative tv(thread);
1712     ResetNoHandleMark rnhm;
1713 
1714     // Perform per-thread and global initializations
1715     comp-&gt;initialize();
1716   }
1717 
1718   if (comp-&gt;is_failed()) {
1719     disable_compilation_forever();
1720     // If compiler initialization failed, no compiler thread that is specific to a
1721     // particular compiler runtime will ever start to compile methods.
1722     shutdown_compiler_runtime(comp, thread);
1723     return false;
1724   }
1725 
1726   // C1 specific check
1727   if (comp-&gt;is_c1() &amp;&amp; (thread-&gt;get_buffer_blob() == NULL)) {
1728     warning(&quot;Initialization of %s thread failed (no space to run compilers)&quot;, thread-&gt;name());
1729     return false;
1730   }
1731 
1732   return true;
1733 }
1734 
1735 /**
1736  * If C1 and/or C2 initialization failed, we shut down all compilation.
1737  * We do this to keep things simple. This can be changed if it ever turns
1738  * out to be a problem.
1739  */
1740 void CompileBroker::shutdown_compiler_runtime(AbstractCompiler* comp, CompilerThread* thread) {
1741   // Free buffer blob, if allocated
1742   if (thread-&gt;get_buffer_blob() != NULL) {
1743     MutexLocker mu(CodeCache_lock, Mutex::_no_safepoint_check_flag);
1744     CodeCache::free(thread-&gt;get_buffer_blob());
1745   }
1746 
1747   if (comp-&gt;should_perform_shutdown()) {
1748     // There are two reasons for shutting down the compiler
1749     // 1) compiler runtime initialization failed
1750     // 2) The code cache is full and the following flag is set: -XX:-UseCodeCacheFlushing
1751     warning(&quot;%s initialization failed. Shutting down all compilers&quot;, comp-&gt;name());
1752 
1753     // Only one thread per compiler runtime object enters here
1754     // Set state to shut down
1755     comp-&gt;set_shut_down();
1756 
1757     // Delete all queued compilation tasks to make compiler threads exit faster.
1758     if (_c1_compile_queue != NULL) {
1759       _c1_compile_queue-&gt;free_all();
1760     }
1761 
1762     if (_c2_compile_queue != NULL) {
1763       _c2_compile_queue-&gt;free_all();
1764     }
1765 
1766     // Set flags so that we continue execution with using interpreter only.
1767     UseCompiler    = false;
1768     UseInterpreter = true;
1769 
1770     // We could delete compiler runtimes also. However, there are references to
1771     // the compiler runtime(s) (e.g.,  nmethod::is_compiled_by_c1()) which then
1772     // fail. This can be done later if necessary.
1773   }
1774 }
1775 
1776 /**
1777  * Helper function to create new or reuse old CompileLog.
1778  */
1779 CompileLog* CompileBroker::get_log(CompilerThread* ct) {
1780   if (!LogCompilation) return NULL;
1781 
1782   AbstractCompiler *compiler = ct-&gt;compiler();
1783   bool c1 = compiler-&gt;is_c1();
1784   jobject* compiler_objects = c1 ? _compiler1_objects : _compiler2_objects;
1785   assert(compiler_objects != NULL, &quot;must be initialized at this point&quot;);
1786   CompileLog** logs = c1 ? _compiler1_logs : _compiler2_logs;
1787   assert(logs != NULL, &quot;must be initialized at this point&quot;);
1788   int count = c1 ? _c1_count : _c2_count;
1789 
1790   // Find Compiler number by its threadObj.
1791   oop compiler_obj = ct-&gt;threadObj();
1792   int compiler_number = 0;
1793   bool found = false;
1794   for (; compiler_number &lt; count; compiler_number++) {
1795     if (JNIHandles::resolve_non_null(compiler_objects[compiler_number]) == compiler_obj) {
1796       found = true;
1797       break;
1798     }
1799   }
1800   assert(found, &quot;Compiler must exist at this point&quot;);
1801 
1802   // Determine pointer for this thread&#39;s log.
1803   CompileLog** log_ptr = &amp;logs[compiler_number];
1804 
1805   // Return old one if it exists.
1806   CompileLog* log = *log_ptr;
1807   if (log != NULL) {
1808     ct-&gt;init_log(log);
1809     return log;
1810   }
1811 
1812   // Create a new one and remember it.
1813   init_compiler_thread_log();
1814   log = ct-&gt;log();
1815   *log_ptr = log;
1816   return log;
1817 }
1818 
1819 // ------------------------------------------------------------------
1820 // CompileBroker::compiler_thread_loop
1821 //
1822 // The main loop run by a CompilerThread.
1823 void CompileBroker::compiler_thread_loop() {
1824   CompilerThread* thread = CompilerThread::current();
1825   CompileQueue* queue = thread-&gt;queue();
1826   // For the thread that initializes the ciObjectFactory
1827   // this resource mark holds all the shared objects
1828   ResourceMark rm;
1829 
1830   // First thread to get here will initialize the compiler interface
1831 
1832   {
1833     ASSERT_IN_VM;
1834     MutexLocker only_one (thread, CompileThread_lock);
1835     if (!ciObjectFactory::is_initialized()) {
1836       ciObjectFactory::initialize();
1837     }
1838   }
1839 
1840   // Open a log.
1841   CompileLog* log = get_log(thread);
1842   if (log != NULL) {
1843     log-&gt;begin_elem(&quot;start_compile_thread name=&#39;%s&#39; thread=&#39;&quot; UINTX_FORMAT &quot;&#39; process=&#39;%d&#39;&quot;,
1844                     thread-&gt;name(),
1845                     os::current_thread_id(),
1846                     os::current_process_id());
1847     log-&gt;stamp();
1848     log-&gt;end_elem();
1849   }
1850 
1851   // If compiler thread/runtime initialization fails, exit the compiler thread
1852   if (!init_compiler_runtime()) {
1853     return;
1854   }
1855 
1856   thread-&gt;start_idle_timer();
1857 
1858   // Poll for new compilation tasks as long as the JVM runs. Compilation
1859   // should only be disabled if something went wrong while initializing the
1860   // compiler runtimes. This, in turn, should not happen. The only known case
1861   // when compiler runtime initialization fails is if there is not enough free
1862   // space in the code cache to generate the necessary stubs, etc.
1863   while (!is_compilation_disabled_forever()) {
1864     // We need this HandleMark to avoid leaking VM handles.
1865     HandleMark hm(thread);
1866 
1867     CompileTask* task = queue-&gt;get();
1868     if (task == NULL) {
1869       if (UseDynamicNumberOfCompilerThreads) {
1870         // Access compiler_count under lock to enforce consistency.
1871         MutexLocker only_one(CompileThread_lock);
1872         if (can_remove(thread, true)) {
1873           if (TraceCompilerThreads) {
1874             tty-&gt;print_cr(&quot;Removing compiler thread %s after &quot; JLONG_FORMAT &quot; ms idle time&quot;,
1875                           thread-&gt;name(), thread-&gt;idle_time_millis());
1876           }
1877           // Free buffer blob, if allocated
1878           if (thread-&gt;get_buffer_blob() != NULL) {
1879             MutexLocker mu(CodeCache_lock, Mutex::_no_safepoint_check_flag);
1880             CodeCache::free(thread-&gt;get_buffer_blob());
1881           }
1882           return; // Stop this thread.
1883         }
1884       }
1885     } else {
1886       // Assign the task to the current thread.  Mark this compilation
1887       // thread as active for the profiler.
1888       // CompileTaskWrapper also keeps the Method* from being deallocated if redefinition
1889       // occurs after fetching the compile task off the queue.
1890       CompileTaskWrapper ctw(task);
1891       nmethodLocker result_handle;  // (handle for the nmethod produced by this task)
1892       task-&gt;set_code_handle(&amp;result_handle);
1893       methodHandle method(thread, task-&gt;method());
1894 
1895       // Never compile a method if breakpoints are present in it
1896       if (method()-&gt;number_of_breakpoints() == 0) {
1897         // Compile the method.
1898         if ((UseCompiler || AlwaysCompileLoopMethods) &amp;&amp; CompileBroker::should_compile_new_jobs()) {
1899           invoke_compiler_on_method(task);
1900           thread-&gt;start_idle_timer();
1901         } else {
1902           // After compilation is disabled, remove remaining methods from queue
1903           method-&gt;clear_queued_for_compilation();
1904           task-&gt;set_failure_reason(&quot;compilation is disabled&quot;);
1905         }
1906       }
1907 
1908       if (UseDynamicNumberOfCompilerThreads) {
1909         possibly_add_compiler_threads(thread);
1910         assert(!thread-&gt;has_pending_exception(), &quot;should have been handled&quot;);
1911       }
1912     }
1913   }
1914 
1915   // Shut down compiler runtime
1916   shutdown_compiler_runtime(thread-&gt;compiler(), thread);
1917 }
1918 
1919 // ------------------------------------------------------------------
1920 // CompileBroker::init_compiler_thread_log
1921 //
1922 // Set up state required by +LogCompilation.
1923 void CompileBroker::init_compiler_thread_log() {
1924     CompilerThread* thread = CompilerThread::current();
1925     char  file_name[4*K];
1926     FILE* fp = NULL;
1927     intx thread_id = os::current_thread_id();
1928     for (int try_temp_dir = 1; try_temp_dir &gt;= 0; try_temp_dir--) {
1929       const char* dir = (try_temp_dir ? os::get_temp_directory() : NULL);
1930       if (dir == NULL) {
1931         jio_snprintf(file_name, sizeof(file_name), &quot;hs_c&quot; UINTX_FORMAT &quot;_pid%u.log&quot;,
1932                      thread_id, os::current_process_id());
1933       } else {
1934         jio_snprintf(file_name, sizeof(file_name),
1935                      &quot;%s%shs_c&quot; UINTX_FORMAT &quot;_pid%u.log&quot;, dir,
1936                      os::file_separator(), thread_id, os::current_process_id());
1937       }
1938 
1939       fp = fopen(file_name, &quot;wt&quot;);
1940       if (fp != NULL) {
1941         if (LogCompilation &amp;&amp; Verbose) {
1942           tty-&gt;print_cr(&quot;Opening compilation log %s&quot;, file_name);
1943         }
1944         CompileLog* log = new(ResourceObj::C_HEAP, mtCompiler) CompileLog(file_name, fp, thread_id);
1945         if (log == NULL) {
1946           fclose(fp);
1947           return;
1948         }
1949         thread-&gt;init_log(log);
1950 
1951         if (xtty != NULL) {
1952           ttyLocker ttyl;
1953           // Record any per thread log files
1954           xtty-&gt;elem(&quot;thread_logfile thread=&#39;&quot; INTX_FORMAT &quot;&#39; filename=&#39;%s&#39;&quot;, thread_id, file_name);
1955         }
1956         return;
1957       }
1958     }
1959     warning(&quot;Cannot open log file: %s&quot;, file_name);
1960 }
1961 
1962 void CompileBroker::log_metaspace_failure() {
1963   const char* message = &quot;some methods may not be compiled because metaspace &quot;
1964                         &quot;is out of memory&quot;;
1965   if (_compilation_log != NULL) {
1966     _compilation_log-&gt;log_metaspace_failure(message);
1967   }
1968   if (PrintCompilation) {
1969     tty-&gt;print_cr(&quot;COMPILE PROFILING SKIPPED: %s&quot;, message);
1970   }
1971 }
1972 
1973 
1974 // ------------------------------------------------------------------
1975 // CompileBroker::set_should_block
1976 //
1977 // Set _should_block.
1978 // Call this from the VM, with Threads_lock held and a safepoint requested.
1979 void CompileBroker::set_should_block() {
1980   assert(Threads_lock-&gt;owner() == Thread::current(), &quot;must have threads lock&quot;);
1981   assert(SafepointSynchronize::is_at_safepoint(), &quot;must be at a safepoint already&quot;);
1982 #ifndef PRODUCT
1983   if (PrintCompilation &amp;&amp; (Verbose || WizardMode))
1984     tty-&gt;print_cr(&quot;notifying compiler thread pool to block&quot;);
1985 #endif
1986   _should_block = true;
1987 }
1988 
1989 // ------------------------------------------------------------------
1990 // CompileBroker::maybe_block
1991 //
1992 // Call this from the compiler at convenient points, to poll for _should_block.
1993 void CompileBroker::maybe_block() {
1994   if (_should_block) {
1995 #ifndef PRODUCT
1996     if (PrintCompilation &amp;&amp; (Verbose || WizardMode))
1997       tty-&gt;print_cr(&quot;compiler thread &quot; INTPTR_FORMAT &quot; poll detects block request&quot;, p2i(Thread::current()));
1998 #endif
1999     ThreadInVMfromNative tivfn(JavaThread::current());
2000   }
2001 }
2002 
2003 // wrapper for CodeCache::print_summary()
2004 static void codecache_print(bool detailed)
2005 {
2006   ResourceMark rm;
2007   stringStream s;
2008   // Dump code cache  into a buffer before locking the tty,
2009   {
2010     MutexLocker mu(CodeCache_lock, Mutex::_no_safepoint_check_flag);
2011     CodeCache::print_summary(&amp;s, detailed);
2012   }
2013   ttyLocker ttyl;
2014   tty-&gt;print(&quot;%s&quot;, s.as_string());
2015 }
2016 
2017 // wrapper for CodeCache::print_summary() using outputStream
2018 static void codecache_print(outputStream* out, bool detailed) {
2019   ResourceMark rm;
2020   stringStream s;
2021 
2022   // Dump code cache into a buffer
2023   {
2024     MutexLocker mu(CodeCache_lock, Mutex::_no_safepoint_check_flag);
2025     CodeCache::print_summary(&amp;s, detailed);
2026   }
2027 
2028   char* remaining_log = s.as_string();
2029   while (*remaining_log != &#39;\0&#39;) {
2030     char* eol = strchr(remaining_log, &#39;\n&#39;);
2031     if (eol == NULL) {
2032       out-&gt;print_cr(&quot;%s&quot;, remaining_log);
2033       remaining_log = remaining_log + strlen(remaining_log);
2034     } else {
2035       *eol = &#39;\0&#39;;
2036       out-&gt;print_cr(&quot;%s&quot;, remaining_log);
2037       remaining_log = eol + 1;
2038     }
2039   }
2040 }
2041 
2042 void CompileBroker::post_compile(CompilerThread* thread, CompileTask* task, bool success, ciEnv* ci_env,
2043                                  int compilable, const char* failure_reason) {
2044   if (success) {
2045     task-&gt;mark_success();
2046     if (ci_env != NULL) {
2047       task-&gt;set_num_inlined_bytecodes(ci_env-&gt;num_inlined_bytecodes());
2048     }
2049     if (_compilation_log != NULL) {
2050       nmethod* code = task-&gt;code();
2051       if (code != NULL) {
2052         _compilation_log-&gt;log_nmethod(thread, code);
2053       }
2054     }
2055   } else if (AbortVMOnCompilationFailure) {
2056     if (compilable == ciEnv::MethodCompilable_not_at_tier) {
2057       fatal(&quot;Not compilable at tier %d: %s&quot;, task-&gt;comp_level(), failure_reason);
2058     }
2059     if (compilable == ciEnv::MethodCompilable_never) {
2060       fatal(&quot;Never compilable: %s&quot;, failure_reason);
2061     }
2062   }
2063   // simulate crash during compilation
2064   assert(task-&gt;compile_id() != CICrashAt, &quot;just as planned&quot;);
2065 }
2066 
2067 static void post_compilation_event(EventCompilation&amp; event, CompileTask* task) {
2068   assert(task != NULL, &quot;invariant&quot;);
2069   CompilerEvent::CompilationEvent::post(event,
2070                                         task-&gt;compile_id(),
2071                                         task-&gt;compiler()-&gt;type(),
2072                                         task-&gt;method(),
2073                                         task-&gt;comp_level(),
2074                                         task-&gt;is_success(),
2075                                         task-&gt;osr_bci() != CompileBroker::standard_entry_bci,
2076                                         (task-&gt;code() == NULL) ? 0 : task-&gt;code()-&gt;total_size(),
2077                                         task-&gt;num_inlined_bytecodes());
2078 }
2079 
2080 int DirectivesStack::_depth = 0;
2081 CompilerDirectives* DirectivesStack::_top = NULL;
2082 CompilerDirectives* DirectivesStack::_bottom = NULL;
2083 
2084 // ------------------------------------------------------------------
2085 // CompileBroker::invoke_compiler_on_method
2086 //
2087 // Compile a method.
2088 //
2089 void CompileBroker::invoke_compiler_on_method(CompileTask* task) {
2090   task-&gt;print_ul();
2091   if (PrintCompilation) {
2092     ResourceMark rm;
2093     task-&gt;print_tty();
2094   }
2095   elapsedTimer time;
2096 
2097   CompilerThread* thread = CompilerThread::current();
2098   ResourceMark rm(thread);
2099 
2100   if (LogEvents) {
2101     _compilation_log-&gt;log_compile(thread, task);
2102   }
2103 
2104   // Common flags.
2105   uint compile_id = task-&gt;compile_id();
2106   int osr_bci = task-&gt;osr_bci();
2107   bool is_osr = (osr_bci != standard_entry_bci);
2108   bool should_log = (thread-&gt;log() != NULL);
2109   bool should_break = false;
2110   const int task_level = task-&gt;comp_level();
2111   AbstractCompiler* comp = task-&gt;compiler();
2112 
2113   DirectiveSet* directive;
2114   {
2115     // create the handle inside it&#39;s own block so it can&#39;t
2116     // accidentally be referenced once the thread transitions to
2117     // native.  The NoHandleMark before the transition should catch
2118     // any cases where this occurs in the future.
2119     methodHandle method(thread, task-&gt;method());
2120     assert(!method-&gt;is_native(), &quot;no longer compile natives&quot;);
2121 
2122     // Look up matching directives
2123     directive = DirectivesStack::getMatchingDirective(method, comp);
2124 
2125     // Update compile information when using perfdata.
2126     if (UsePerfData) {
2127       update_compile_perf_data(thread, method, is_osr);
2128     }
2129 
2130     DTRACE_METHOD_COMPILE_BEGIN_PROBE(method, compiler_name(task_level));
2131   }
2132 
2133   should_break = directive-&gt;BreakAtExecuteOption || task-&gt;check_break_at_flags();
2134   if (should_log &amp;&amp; !directive-&gt;LogOption) {
2135     should_log = false;
2136   }
2137 
2138   // Allocate a new set of JNI handles.
2139   push_jni_handle_block();
2140   Method* target_handle = task-&gt;method();
2141   int compilable = ciEnv::MethodCompilable;
2142   const char* failure_reason = NULL;
2143   bool failure_reason_on_C_heap = false;
2144   const char* retry_message = NULL;
2145 
2146 #if INCLUDE_JVMCI
2147   if (UseJVMCICompiler &amp;&amp; comp != NULL &amp;&amp; comp-&gt;is_jvmci()) {
2148     JVMCICompiler* jvmci = (JVMCICompiler*) comp;
2149 
2150     TraceTime t1(&quot;compilation&quot;, &amp;time);
2151     EventCompilation event;
2152 
2153     // Skip redefined methods
2154     if (target_handle-&gt;is_old()) {
2155       failure_reason = &quot;redefined method&quot;;
2156       retry_message = &quot;not retryable&quot;;
2157       compilable = ciEnv::MethodCompilable_never;
2158     } else {
2159       JVMCICompileState compile_state(task);
2160       JVMCIEnv env(thread, &amp;compile_state, __FILE__, __LINE__);
2161       methodHandle method(thread, target_handle);
2162       env.runtime()-&gt;compile_method(&amp;env, jvmci, method, osr_bci);
2163 
2164       failure_reason = compile_state.failure_reason();
2165       failure_reason_on_C_heap = compile_state.failure_reason_on_C_heap();
2166       if (!compile_state.retryable()) {
2167         retry_message = &quot;not retryable&quot;;
2168         compilable = ciEnv::MethodCompilable_not_at_tier;
2169       }
2170       if (task-&gt;code() == NULL) {
2171         assert(failure_reason != NULL, &quot;must specify failure_reason&quot;);
2172       }
2173     }
2174     post_compile(thread, task, task-&gt;code() != NULL, NULL, compilable, failure_reason);
2175     if (event.should_commit()) {
2176       post_compilation_event(event, task);
2177     }
2178 
2179   } else
2180 #endif // INCLUDE_JVMCI
2181   {
2182     NoHandleMark  nhm;
2183     ThreadToNativeFromVM ttn(thread);
2184 
2185     ciEnv ci_env(task);
2186     if (should_break) {
2187       ci_env.set_break_at_compile(true);
2188     }
2189     if (should_log) {
2190       ci_env.set_log(thread-&gt;log());
2191     }
2192     assert(thread-&gt;env() == &amp;ci_env, &quot;set by ci_env&quot;);
2193     // The thread-env() field is cleared in ~CompileTaskWrapper.
2194 
2195     // Cache Jvmti state
2196     ci_env.cache_jvmti_state();
2197 
2198     // Cache DTrace flags
2199     ci_env.cache_dtrace_flags();
2200 
2201     ciMethod* target = ci_env.get_method_from_handle(target_handle);
2202 
2203     TraceTime t1(&quot;compilation&quot;, &amp;time);
2204     EventCompilation event;
2205 
2206     if (comp == NULL) {
2207       ci_env.record_method_not_compilable(&quot;no compiler&quot;, !TieredCompilation);
2208     } else {
2209       if (WhiteBoxAPI &amp;&amp; WhiteBox::compilation_locked) {
2210         MonitorLocker locker(Compilation_lock, Mutex::_no_safepoint_check_flag);
2211         while (WhiteBox::compilation_locked) {
2212           locker.wait();
2213         }
2214       }
2215       comp-&gt;compile_method(&amp;ci_env, target, osr_bci, directive);
2216     }
2217 
2218     if (!ci_env.failing() &amp;&amp; task-&gt;code() == NULL) {
2219       //assert(false, &quot;compiler should always document failure&quot;);
2220       // The compiler elected, without comment, not to register a result.
2221       // Do not attempt further compilations of this method.
2222       ci_env.record_method_not_compilable(&quot;compile failed&quot;, !TieredCompilation);
2223     }
2224 
2225     // Copy this bit to the enclosing block:
2226     compilable = ci_env.compilable();
2227 
2228     if (ci_env.failing()) {
2229       failure_reason = ci_env.failure_reason();
2230       retry_message = ci_env.retry_message();
2231       ci_env.report_failure(failure_reason);
2232     }
2233 
2234     post_compile(thread, task, !ci_env.failing(), &amp;ci_env, compilable, failure_reason);
2235     if (event.should_commit()) {
2236       post_compilation_event(event, task);
2237     }
2238   }
2239   // Remove the JNI handle block after the ciEnv destructor has run in
2240   // the previous block.
2241   pop_jni_handle_block();
2242 
2243   if (failure_reason != NULL) {
2244     task-&gt;set_failure_reason(failure_reason, failure_reason_on_C_heap);
2245     if (_compilation_log != NULL) {
2246       _compilation_log-&gt;log_failure(thread, task, failure_reason, retry_message);
2247     }
2248     if (PrintCompilation) {
2249       FormatBufferResource msg = retry_message != NULL ?
2250         FormatBufferResource(&quot;COMPILE SKIPPED: %s (%s)&quot;, failure_reason, retry_message) :
2251         FormatBufferResource(&quot;COMPILE SKIPPED: %s&quot;,      failure_reason);
2252       task-&gt;print(tty, msg);
2253     }
2254   }
2255 
2256   methodHandle method(thread, task-&gt;method());
2257 
2258   DTRACE_METHOD_COMPILE_END_PROBE(method, compiler_name(task_level), task-&gt;is_success());
2259 
2260   collect_statistics(thread, time, task);
2261 
2262   nmethod* nm = task-&gt;code();
2263   if (nm != NULL) {
2264     nm-&gt;maybe_print_nmethod(directive);
2265   }
2266   DirectivesStack::release(directive);
2267 
2268   if (PrintCompilation &amp;&amp; PrintCompilation2) {
2269     tty-&gt;print(&quot;%7d &quot;, (int) tty-&gt;time_stamp().milliseconds());  // print timestamp
2270     tty-&gt;print(&quot;%4d &quot;, compile_id);    // print compilation number
2271     tty-&gt;print(&quot;%s &quot;, (is_osr ? &quot;%&quot; : &quot; &quot;));
2272     if (task-&gt;code() != NULL) {
2273       tty-&gt;print(&quot;size: %d(%d) &quot;, task-&gt;code()-&gt;total_size(), task-&gt;code()-&gt;insts_size());
2274     }
2275     tty-&gt;print_cr(&quot;time: %d inlined: %d bytes&quot;, (int)time.milliseconds(), task-&gt;num_inlined_bytecodes());
2276   }
2277 
2278   Log(compilation, codecache) log;
2279   if (log.is_debug()) {
2280     LogStream ls(log.debug());
2281     codecache_print(&amp;ls, /* detailed= */ false);
2282   }
2283   if (PrintCodeCacheOnCompilation) {
2284     codecache_print(/* detailed= */ false);
2285   }
2286   // Disable compilation, if required.
2287   switch (compilable) {
2288   case ciEnv::MethodCompilable_never:
2289     if (is_osr)
2290       method-&gt;set_not_osr_compilable_quietly(&quot;MethodCompilable_never&quot;);
2291     else
2292       method-&gt;set_not_compilable_quietly(&quot;MethodCompilable_never&quot;);
2293     break;
2294   case ciEnv::MethodCompilable_not_at_tier:
2295     if (is_osr)
2296       method-&gt;set_not_osr_compilable_quietly(&quot;MethodCompilable_not_at_tier&quot;, task_level);
2297     else
2298       method-&gt;set_not_compilable_quietly(&quot;MethodCompilable_not_at_tier&quot;, task_level);
2299     break;
2300   }
2301 
2302   // Note that the queued_for_compilation bits are cleared without
2303   // protection of a mutex. [They were set by the requester thread,
2304   // when adding the task to the compile queue -- at which time the
2305   // compile queue lock was held. Subsequently, we acquired the compile
2306   // queue lock to get this task off the compile queue; thus (to belabour
2307   // the point somewhat) our clearing of the bits must be occurring
2308   // only after the setting of the bits. See also 14012000 above.
2309   method-&gt;clear_queued_for_compilation();
2310 }
2311 
2312 /**
2313  * The CodeCache is full. Print warning and disable compilation.
2314  * Schedule code cache cleaning so compilation can continue later.
2315  * This function needs to be called only from CodeCache::allocate(),
2316  * since we currently handle a full code cache uniformly.
2317  */
2318 void CompileBroker::handle_full_code_cache(int code_blob_type) {
2319   UseInterpreter = true;
2320   if (UseCompiler || AlwaysCompileLoopMethods ) {
2321     if (xtty != NULL) {
2322       ResourceMark rm;
2323       stringStream s;
2324       // Dump code cache state into a buffer before locking the tty,
2325       // because log_state() will use locks causing lock conflicts.
2326       CodeCache::log_state(&amp;s);
2327       // Lock to prevent tearing
2328       ttyLocker ttyl;
2329       xtty-&gt;begin_elem(&quot;code_cache_full&quot;);
2330       xtty-&gt;print(&quot;%s&quot;, s.as_string());
2331       xtty-&gt;stamp();
2332       xtty-&gt;end_elem();
2333     }
2334 
2335 #ifndef PRODUCT
2336     if (ExitOnFullCodeCache) {
2337       codecache_print(/* detailed= */ true);
2338       before_exit(JavaThread::current());
2339       exit_globals(); // will delete tty
2340       vm_direct_exit(1);
2341     }
2342 #endif
2343     if (UseCodeCacheFlushing) {
2344       // Since code cache is full, immediately stop new compiles
2345       if (CompileBroker::set_should_compile_new_jobs(CompileBroker::stop_compilation)) {
2346         NMethodSweeper::log_sweep(&quot;disable_compiler&quot;);
2347       }
2348     } else {
2349       disable_compilation_forever();
2350     }
2351 
2352     CodeCache::report_codemem_full(code_blob_type, should_print_compiler_warning());
2353   }
2354 }
2355 
2356 // ------------------------------------------------------------------
2357 // CompileBroker::update_compile_perf_data
2358 //
2359 // Record this compilation for debugging purposes.
2360 void CompileBroker::update_compile_perf_data(CompilerThread* thread, const methodHandle&amp; method, bool is_osr) {
2361   ResourceMark rm;
2362   char* method_name = method-&gt;name()-&gt;as_C_string();
2363   char current_method[CompilerCounters::cmname_buffer_length];
2364   size_t maxLen = CompilerCounters::cmname_buffer_length;
2365 
2366   const char* class_name = method-&gt;method_holder()-&gt;name()-&gt;as_C_string();
2367 
2368   size_t s1len = strlen(class_name);
2369   size_t s2len = strlen(method_name);
2370 
2371   // check if we need to truncate the string
2372   if (s1len + s2len + 2 &gt; maxLen) {
2373 
2374     // the strategy is to lop off the leading characters of the
2375     // class name and the trailing characters of the method name.
2376 
2377     if (s2len + 2 &gt; maxLen) {
2378       // lop of the entire class name string, let snprintf handle
2379       // truncation of the method name.
2380       class_name += s1len; // null string
2381     }
2382     else {
2383       // lop off the extra characters from the front of the class name
2384       class_name += ((s1len + s2len + 2) - maxLen);
2385     }
2386   }
2387 
2388   jio_snprintf(current_method, maxLen, &quot;%s %s&quot;, class_name, method_name);
2389 
2390   int last_compile_type = normal_compile;
2391   if (CICountOSR &amp;&amp; is_osr) {
2392     last_compile_type = osr_compile;
2393   }
2394 
2395   CompilerCounters* counters = thread-&gt;counters();
2396   counters-&gt;set_current_method(current_method);
2397   counters-&gt;set_compile_type((jlong) last_compile_type);
2398 }
2399 
2400 // ------------------------------------------------------------------
2401 // CompileBroker::push_jni_handle_block
2402 //
2403 // Push on a new block of JNI handles.
2404 void CompileBroker::push_jni_handle_block() {
2405   JavaThread* thread = JavaThread::current();
2406 
2407   // Allocate a new block for JNI handles.
2408   // Inlined code from jni_PushLocalFrame()
2409   JNIHandleBlock* java_handles = thread-&gt;active_handles();
2410   JNIHandleBlock* compile_handles = JNIHandleBlock::allocate_block(thread);
2411   assert(compile_handles != NULL &amp;&amp; java_handles != NULL, &quot;should not be NULL&quot;);
2412   compile_handles-&gt;set_pop_frame_link(java_handles);  // make sure java handles get gc&#39;d.
2413   thread-&gt;set_active_handles(compile_handles);
2414 }
2415 
2416 
2417 // ------------------------------------------------------------------
2418 // CompileBroker::pop_jni_handle_block
2419 //
2420 // Pop off the current block of JNI handles.
2421 void CompileBroker::pop_jni_handle_block() {
2422   JavaThread* thread = JavaThread::current();
2423 
2424   // Release our JNI handle block
2425   JNIHandleBlock* compile_handles = thread-&gt;active_handles();
2426   JNIHandleBlock* java_handles = compile_handles-&gt;pop_frame_link();
2427   thread-&gt;set_active_handles(java_handles);
2428   compile_handles-&gt;set_pop_frame_link(NULL);
2429   JNIHandleBlock::release_block(compile_handles, thread); // may block
2430 }
2431 
2432 // ------------------------------------------------------------------
2433 // CompileBroker::collect_statistics
2434 //
2435 // Collect statistics about the compilation.
2436 
2437 void CompileBroker::collect_statistics(CompilerThread* thread, elapsedTimer time, CompileTask* task) {
2438   bool success = task-&gt;is_success();
2439   methodHandle method (thread, task-&gt;method());
2440   uint compile_id = task-&gt;compile_id();
2441   bool is_osr = (task-&gt;osr_bci() != standard_entry_bci);
2442   nmethod* code = task-&gt;code();
2443   CompilerCounters* counters = thread-&gt;counters();
2444 
2445   assert(code == NULL || code-&gt;is_locked_by_vm(), &quot;will survive the MutexLocker&quot;);
2446   MutexLocker locker(CompileStatistics_lock);
2447 
2448   // _perf variables are production performance counters which are
2449   // updated regardless of the setting of the CITime and CITimeEach flags
2450   //
2451 
2452   // account all time, including bailouts and failures in this counter;
2453   // C1 and C2 counters are counting both successful and unsuccessful compiles
2454   _t_total_compilation.add(time);
2455 
2456   if (!success) {
2457     _total_bailout_count++;
2458     if (UsePerfData) {
2459       _perf_last_failed_method-&gt;set_value(counters-&gt;current_method());
2460       _perf_last_failed_type-&gt;set_value(counters-&gt;compile_type());
2461       _perf_total_bailout_count-&gt;inc();
2462     }
2463     _t_bailedout_compilation.add(time);
2464   } else if (code == NULL) {
2465     if (UsePerfData) {
2466       _perf_last_invalidated_method-&gt;set_value(counters-&gt;current_method());
2467       _perf_last_invalidated_type-&gt;set_value(counters-&gt;compile_type());
2468       _perf_total_invalidated_count-&gt;inc();
2469     }
2470     _total_invalidated_count++;
2471     _t_invalidated_compilation.add(time);
2472   } else {
2473     // Compilation succeeded
2474 
2475     // update compilation ticks - used by the implementation of
2476     // java.lang.management.CompilationMBean
2477     _perf_total_compilation-&gt;inc(time.ticks());
2478     _peak_compilation_time = time.milliseconds() &gt; _peak_compilation_time ? time.milliseconds() : _peak_compilation_time;
2479 
2480     if (CITime) {
2481       int bytes_compiled = method-&gt;code_size() + task-&gt;num_inlined_bytecodes();
2482       if (is_osr) {
2483         _t_osr_compilation.add(time);
2484         _sum_osr_bytes_compiled += bytes_compiled;
2485       } else {
2486         _t_standard_compilation.add(time);
2487         _sum_standard_bytes_compiled += method-&gt;code_size() + task-&gt;num_inlined_bytecodes();
2488       }
2489 
2490 #if INCLUDE_JVMCI
2491       AbstractCompiler* comp = compiler(task-&gt;comp_level());
2492       if (comp) {
2493         CompilerStatistics* stats = comp-&gt;stats();
2494         if (stats) {
2495           if (is_osr) {
2496             stats-&gt;_osr.update(time, bytes_compiled);
2497           } else {
2498             stats-&gt;_standard.update(time, bytes_compiled);
2499           }
2500           stats-&gt;_nmethods_size += code-&gt;total_size();
2501           stats-&gt;_nmethods_code_size += code-&gt;insts_size();
2502         } else { // if (!stats)
2503           assert(false, &quot;Compiler statistics object must exist&quot;);
2504         }
2505       } else { // if (!comp)
2506         assert(false, &quot;Compiler object must exist&quot;);
2507       }
2508 #endif // INCLUDE_JVMCI
2509     }
2510 
2511     if (UsePerfData) {
2512       // save the name of the last method compiled
2513       _perf_last_method-&gt;set_value(counters-&gt;current_method());
2514       _perf_last_compile_type-&gt;set_value(counters-&gt;compile_type());
2515       _perf_last_compile_size-&gt;set_value(method-&gt;code_size() +
2516                                          task-&gt;num_inlined_bytecodes());
2517       if (is_osr) {
2518         _perf_osr_compilation-&gt;inc(time.ticks());
2519         _perf_sum_osr_bytes_compiled-&gt;inc(method-&gt;code_size() + task-&gt;num_inlined_bytecodes());
2520       } else {
2521         _perf_standard_compilation-&gt;inc(time.ticks());
2522         _perf_sum_standard_bytes_compiled-&gt;inc(method-&gt;code_size() + task-&gt;num_inlined_bytecodes());
2523       }
2524     }
2525 
2526     if (CITimeEach) {
2527       float bytes_per_sec = 1.0 * (method-&gt;code_size() + task-&gt;num_inlined_bytecodes()) / time.seconds();
2528       tty-&gt;print_cr(&quot;%3d   seconds: %f bytes/sec : %f (bytes %d + %d inlined)&quot;,
2529                     compile_id, time.seconds(), bytes_per_sec, method-&gt;code_size(), task-&gt;num_inlined_bytecodes());
2530     }
2531 
2532     // Collect counts of successful compilations
2533     _sum_nmethod_size      += code-&gt;total_size();
2534     _sum_nmethod_code_size += code-&gt;insts_size();
2535     _total_compile_count++;
2536 
2537     if (UsePerfData) {
2538       _perf_sum_nmethod_size-&gt;inc(     code-&gt;total_size());
2539       _perf_sum_nmethod_code_size-&gt;inc(code-&gt;insts_size());
2540       _perf_total_compile_count-&gt;inc();
2541     }
2542 
2543     if (is_osr) {
2544       if (UsePerfData) _perf_total_osr_compile_count-&gt;inc();
2545       _total_osr_compile_count++;
2546     } else {
2547       if (UsePerfData) _perf_total_standard_compile_count-&gt;inc();
2548       _total_standard_compile_count++;
2549     }
2550   }
2551   // set the current method for the thread to null
2552   if (UsePerfData) counters-&gt;set_current_method(&quot;&quot;);
2553 }
2554 
2555 const char* CompileBroker::compiler_name(int comp_level) {
2556   AbstractCompiler *comp = CompileBroker::compiler(comp_level);
2557   if (comp == NULL) {
2558     return &quot;no compiler&quot;;
2559   } else {
2560     return (comp-&gt;name());
2561   }
2562 }
2563 
2564 #if INCLUDE_JVMCI
2565 void CompileBroker::print_times(AbstractCompiler* comp) {
2566   CompilerStatistics* stats = comp-&gt;stats();
2567   if (stats) {
2568     tty-&gt;print_cr(&quot;  %s {speed: %d bytes/s; standard: %6.3f s, %d bytes, %d methods; osr: %6.3f s, %d bytes, %d methods; nmethods_size: %d bytes; nmethods_code_size: %d bytes}&quot;,
2569                 comp-&gt;name(), stats-&gt;bytes_per_second(),
2570                 stats-&gt;_standard._time.seconds(), stats-&gt;_standard._bytes, stats-&gt;_standard._count,
2571                 stats-&gt;_osr._time.seconds(), stats-&gt;_osr._bytes, stats-&gt;_osr._count,
2572                 stats-&gt;_nmethods_size, stats-&gt;_nmethods_code_size);
2573   } else { // if (!stats)
2574     assert(false, &quot;Compiler statistics object must exist&quot;);
2575   }
2576   comp-&gt;print_timers();
2577 }
2578 #endif // INCLUDE_JVMCI
2579 
2580 void CompileBroker::print_times(bool per_compiler, bool aggregate) {
2581 #if INCLUDE_JVMCI
2582   elapsedTimer standard_compilation;
2583   elapsedTimer total_compilation;
2584   elapsedTimer osr_compilation;
2585 
2586   int standard_bytes_compiled = 0;
2587   int osr_bytes_compiled = 0;
2588 
2589   int standard_compile_count = 0;
2590   int osr_compile_count = 0;
2591   int total_compile_count = 0;
2592 
2593   int nmethods_size = 0;
2594   int nmethods_code_size = 0;
2595   bool printedHeader = false;
2596 
2597   for (unsigned int i = 0; i &lt; sizeof(_compilers) / sizeof(AbstractCompiler*); i++) {
2598     AbstractCompiler* comp = _compilers[i];
2599     if (comp != NULL) {
2600       if (per_compiler &amp;&amp; aggregate &amp;&amp; !printedHeader) {
2601         printedHeader = true;
2602         tty-&gt;cr();
2603         tty-&gt;print_cr(&quot;Individual compiler times (for compiled methods only)&quot;);
2604         tty-&gt;print_cr(&quot;------------------------------------------------&quot;);
2605         tty-&gt;cr();
2606       }
2607       CompilerStatistics* stats = comp-&gt;stats();
2608 
2609       if (stats) {
2610         standard_compilation.add(stats-&gt;_standard._time);
2611         osr_compilation.add(stats-&gt;_osr._time);
2612 
2613         standard_bytes_compiled += stats-&gt;_standard._bytes;
2614         osr_bytes_compiled += stats-&gt;_osr._bytes;
2615 
2616         standard_compile_count += stats-&gt;_standard._count;
2617         osr_compile_count += stats-&gt;_osr._count;
2618 
2619         nmethods_size += stats-&gt;_nmethods_size;
2620         nmethods_code_size += stats-&gt;_nmethods_code_size;
2621       } else { // if (!stats)
2622         assert(false, &quot;Compiler statistics object must exist&quot;);
2623       }
2624 
2625       if (per_compiler) {
2626         print_times(comp);
2627       }
2628     }
2629   }
2630   total_compile_count = osr_compile_count + standard_compile_count;
2631   total_compilation.add(osr_compilation);
2632   total_compilation.add(standard_compilation);
2633 
2634   // In hosted mode, print the JVMCI compiler specific counters manually.
2635   if (!UseJVMCICompiler) {
2636     JVMCICompiler::print_compilation_timers();
2637   }
2638 #else // INCLUDE_JVMCI
2639   elapsedTimer standard_compilation = CompileBroker::_t_standard_compilation;
2640   elapsedTimer osr_compilation = CompileBroker::_t_osr_compilation;
2641   elapsedTimer total_compilation = CompileBroker::_t_total_compilation;
2642 
2643   int standard_bytes_compiled = CompileBroker::_sum_standard_bytes_compiled;
2644   int osr_bytes_compiled = CompileBroker::_sum_osr_bytes_compiled;
2645 
2646   int standard_compile_count = CompileBroker::_total_standard_compile_count;
2647   int osr_compile_count = CompileBroker::_total_osr_compile_count;
2648   int total_compile_count = CompileBroker::_total_compile_count;
2649 
2650   int nmethods_size = CompileBroker::_sum_nmethod_code_size;
2651   int nmethods_code_size = CompileBroker::_sum_nmethod_size;
2652 #endif // INCLUDE_JVMCI
2653 
2654   if (!aggregate) {
2655     return;
2656   }
2657   tty-&gt;cr();
2658   tty-&gt;print_cr(&quot;Accumulated compiler times&quot;);
2659   tty-&gt;print_cr(&quot;----------------------------------------------------------&quot;);
2660                //0000000000111111111122222222223333333333444444444455555555556666666666
2661                //0123456789012345678901234567890123456789012345678901234567890123456789
2662   tty-&gt;print_cr(&quot;  Total compilation time   : %7.3f s&quot;, total_compilation.seconds());
2663   tty-&gt;print_cr(&quot;    Standard compilation   : %7.3f s, Average : %2.3f s&quot;,
2664                 standard_compilation.seconds(),
2665                 standard_compilation.seconds() / standard_compile_count);
2666   tty-&gt;print_cr(&quot;    Bailed out compilation : %7.3f s, Average : %2.3f s&quot;,
2667                 CompileBroker::_t_bailedout_compilation.seconds(),
2668                 CompileBroker::_t_bailedout_compilation.seconds() / CompileBroker::_total_bailout_count);
2669   tty-&gt;print_cr(&quot;    On stack replacement   : %7.3f s, Average : %2.3f s&quot;,
2670                 osr_compilation.seconds(),
2671                 osr_compilation.seconds() / osr_compile_count);
2672   tty-&gt;print_cr(&quot;    Invalidated            : %7.3f s, Average : %2.3f s&quot;,
2673                 CompileBroker::_t_invalidated_compilation.seconds(),
2674                 CompileBroker::_t_invalidated_compilation.seconds() / CompileBroker::_total_invalidated_count);
2675 
2676   AbstractCompiler *comp = compiler(CompLevel_simple);
2677   if (comp != NULL) {
2678     tty-&gt;cr();
2679     comp-&gt;print_timers();
2680   }
2681   comp = compiler(CompLevel_full_optimization);
2682   if (comp != NULL) {
2683     tty-&gt;cr();
2684     comp-&gt;print_timers();
2685   }
2686   tty-&gt;cr();
2687   tty-&gt;print_cr(&quot;  Total compiled methods    : %8d methods&quot;, total_compile_count);
2688   tty-&gt;print_cr(&quot;    Standard compilation    : %8d methods&quot;, standard_compile_count);
2689   tty-&gt;print_cr(&quot;    On stack replacement    : %8d methods&quot;, osr_compile_count);
2690   int tcb = osr_bytes_compiled + standard_bytes_compiled;
2691   tty-&gt;print_cr(&quot;  Total compiled bytecodes  : %8d bytes&quot;, tcb);
2692   tty-&gt;print_cr(&quot;    Standard compilation    : %8d bytes&quot;, standard_bytes_compiled);
2693   tty-&gt;print_cr(&quot;    On stack replacement    : %8d bytes&quot;, osr_bytes_compiled);
2694   double tcs = total_compilation.seconds();
2695   int bps = tcs == 0.0 ? 0 : (int)(tcb / tcs);
2696   tty-&gt;print_cr(&quot;  Average compilation speed : %8d bytes/s&quot;, bps);
2697   tty-&gt;cr();
2698   tty-&gt;print_cr(&quot;  nmethod code size         : %8d bytes&quot;, nmethods_code_size);
2699   tty-&gt;print_cr(&quot;  nmethod total size        : %8d bytes&quot;, nmethods_size);
2700 }
2701 
2702 // Print general/accumulated JIT information.
2703 void CompileBroker::print_info(outputStream *out) {
2704   if (out == NULL) out = tty;
2705   out-&gt;cr();
2706   out-&gt;print_cr(&quot;======================&quot;);
2707   out-&gt;print_cr(&quot;   General JIT info   &quot;);
2708   out-&gt;print_cr(&quot;======================&quot;);
2709   out-&gt;cr();
2710   out-&gt;print_cr(&quot;            JIT is : %7s&quot;,     should_compile_new_jobs() ? &quot;on&quot; : &quot;off&quot;);
2711   out-&gt;print_cr(&quot;  Compiler threads : %7d&quot;,     (int)CICompilerCount);
2712   out-&gt;cr();
2713   out-&gt;print_cr(&quot;CodeCache overview&quot;);
2714   out-&gt;print_cr(&quot;--------------------------------------------------------&quot;);
2715   out-&gt;cr();
2716   out-&gt;print_cr(&quot;         Reserved size : &quot; SIZE_FORMAT_W(7) &quot; KB&quot;, CodeCache::max_capacity() / K);
2717   out-&gt;print_cr(&quot;        Committed size : &quot; SIZE_FORMAT_W(7) &quot; KB&quot;, CodeCache::capacity() / K);
2718   out-&gt;print_cr(&quot;  Unallocated capacity : &quot; SIZE_FORMAT_W(7) &quot; KB&quot;, CodeCache::unallocated_capacity() / K);
2719   out-&gt;cr();
2720 
2721   out-&gt;cr();
2722   out-&gt;print_cr(&quot;CodeCache cleaning overview&quot;);
2723   out-&gt;print_cr(&quot;--------------------------------------------------------&quot;);
2724   out-&gt;cr();
2725   NMethodSweeper::print(out);
2726   out-&gt;print_cr(&quot;--------------------------------------------------------&quot;);
2727   out-&gt;cr();
2728 }
2729 
2730 // Note: tty_lock must not be held upon entry to this function.
2731 //       Print functions called from herein do &quot;micro-locking&quot; on tty_lock.
2732 //       That&#39;s a tradeoff which keeps together important blocks of output.
2733 //       At the same time, continuous tty_lock hold time is kept in check,
2734 //       preventing concurrently printing threads from stalling a long time.
2735 void CompileBroker::print_heapinfo(outputStream* out, const char* function, size_t granularity) {
2736   TimeStamp ts_total;
2737   TimeStamp ts_global;
2738   TimeStamp ts;
2739 
2740   bool allFun = !strcmp(function, &quot;all&quot;);
2741   bool aggregate = !strcmp(function, &quot;aggregate&quot;) || !strcmp(function, &quot;analyze&quot;) || allFun;
2742   bool usedSpace = !strcmp(function, &quot;UsedSpace&quot;) || allFun;
2743   bool freeSpace = !strcmp(function, &quot;FreeSpace&quot;) || allFun;
2744   bool methodCount = !strcmp(function, &quot;MethodCount&quot;) || allFun;
2745   bool methodSpace = !strcmp(function, &quot;MethodSpace&quot;) || allFun;
2746   bool methodAge = !strcmp(function, &quot;MethodAge&quot;) || allFun;
2747   bool methodNames = !strcmp(function, &quot;MethodNames&quot;) || allFun;
2748   bool discard = !strcmp(function, &quot;discard&quot;) || allFun;
2749 
2750   if (out == NULL) {
2751     out = tty;
2752   }
2753 
2754   if (!(aggregate || usedSpace || freeSpace || methodCount || methodSpace || methodAge || methodNames || discard)) {
2755     out-&gt;print_cr(&quot;\n__ CodeHeapStateAnalytics: Function %s is not supported&quot;, function);
2756     out-&gt;cr();
2757     return;
2758   }
2759 
2760   ts_total.update(); // record starting point
2761 
2762   if (aggregate) {
2763     print_info(out);
2764   }
2765 
2766   // We hold the CodeHeapStateAnalytics_lock all the time, from here until we leave this function.
2767   // That prevents another thread from destroying our view on the CodeHeap.
2768   // When we request individual parts of the analysis via the jcmd interface, it is possible
2769   // that in between another thread (another jcmd user or the vm running into CodeCache OOM)
2770   // updated the aggregated data. That&#39;s a tolerable tradeoff because we can&#39;t hold a lock
2771   // across user interaction.
2772   // Acquire this lock before acquiring the CodeCache_lock.
2773   // CodeHeapStateAnalytics_lock could be held by a concurrent thread for a long time,
2774   // leading to an unnecessarily long hold time of the CodeCache_lock.
2775   ts.update(); // record starting point
2776   MutexLocker mu1(CodeHeapStateAnalytics_lock, Mutex::_no_safepoint_check_flag);
2777   out-&gt;print_cr(&quot;\n__ CodeHeapStateAnalytics lock wait took %10.3f seconds _________\n&quot;, ts.seconds());
2778 
2779   // If we serve an &quot;allFun&quot; call, it is beneficial to hold the CodeCache_lock
2780   // for the entire duration of aggregation and printing. That makes sure
2781   // we see a consistent picture and do not run into issues caused by
2782   // the CodeHeap being altered concurrently.
2783   Mutex* global_lock   = allFun ? CodeCache_lock : NULL;
2784   Mutex* function_lock = allFun ? NULL : CodeCache_lock;
2785   ts_global.update(); // record starting point
2786   MutexLocker mu2(global_lock, Mutex::_no_safepoint_check_flag);
2787   if (global_lock != NULL) {
2788     out-&gt;print_cr(&quot;\n__ CodeCache (global) lock wait took %10.3f seconds _________\n&quot;, ts_global.seconds());
2789     ts_global.update(); // record starting point
2790   }
2791 
2792   if (aggregate) {
2793     ts.update(); // record starting point
2794     MutexLocker mu3(function_lock, Mutex::_no_safepoint_check_flag);
2795     if (function_lock != NULL) {
2796       out-&gt;print_cr(&quot;\n__ CodeCache (function) lock wait took %10.3f seconds _________\n&quot;, ts.seconds());
2797     }
2798 
2799     ts.update(); // record starting point
2800     CodeCache::aggregate(out, granularity);
2801     if (function_lock != NULL) {
2802       out-&gt;print_cr(&quot;\n__ CodeCache (function) lock hold took %10.3f seconds _________\n&quot;, ts.seconds());
2803     }
2804   }
2805 
2806   if (usedSpace) CodeCache::print_usedSpace(out);
2807   if (freeSpace) CodeCache::print_freeSpace(out);
2808   if (methodCount) CodeCache::print_count(out);
2809   if (methodSpace) CodeCache::print_space(out);
2810   if (methodAge) CodeCache::print_age(out);
2811   if (methodNames) {
2812     // print_names() has shown to be sensitive to concurrent CodeHeap modifications.
2813     // Therefore, request  the CodeCache_lock before calling...
2814     MutexLocker mu3(function_lock, Mutex::_no_safepoint_check_flag);
2815     CodeCache::print_names(out);
2816   }
2817   if (discard) CodeCache::discard(out);
2818 
2819   if (global_lock != NULL) {
2820     out-&gt;print_cr(&quot;\n__ CodeCache (global) lock hold took %10.3f seconds _________\n&quot;, ts_global.seconds());
2821   }
2822   out-&gt;print_cr(&quot;\n__ CodeHeapStateAnalytics total duration %10.3f seconds _________\n&quot;, ts_total.seconds());
2823 }
<a name="2" id="anc2"></a><b style="font-size: large; color: red">--- EOF ---</b>
















































































</pre>
<input id="eof" value="2" type="hidden" />
</body>
</html>