<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Frames bots/mlbridge/src/test/java/org/openjdk/skara/bots/mlbridge/MailingListBridgeBotTests.java</title>
    <link rel="stylesheet" href="../../../../../../../../../../style.css" />
    <script type="text/javascript" src="../../../../../../../../../../navigation.js"></script>
  </head>
<body onkeypress="keypress(event);">
<a name="0"></a>
<hr />
<pre>   1 /*
   2  * Copyright (c) 2019, Oracle and/or its affiliates. All rights reserved.
   3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   4  *
   5  * This code is free software; you can redistribute it and/or modify it
   6  * under the terms of the GNU General Public License version 2 only, as
   7  * published by the Free Software Foundation.
   8  *
   9  * This code is distributed in the hope that it will be useful, but WITHOUT
  10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
  11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
  12  * version 2 for more details (a copy is included in the LICENSE file that
  13  * accompanied this code).
  14  *
  15  * You should have received a copy of the GNU General Public License version
  16  * 2 along with this work; if not, write to the Free Software Foundation,
  17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
  18  *
  19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
  20  * or visit www.oracle.com if you need additional information or have any
  21  * questions.
  22  */
  23 package org.openjdk.skara.bots.mlbridge;
  24 
  25 import org.openjdk.skara.email.EmailAddress;
  26 import org.openjdk.skara.forge.*;
  27 import org.openjdk.skara.issuetracker.Issue;
  28 import org.openjdk.skara.network.URIBuilder;
  29 import org.openjdk.skara.mailinglist.MailingListServerFactory;
  30 import org.openjdk.skara.test.*;
  31 import org.openjdk.skara.vcs.Repository;
  32 
  33 import org.junit.jupiter.api.*;
  34 
  35 import java.io.IOException;
  36 import java.nio.charset.StandardCharsets;
  37 import java.nio.file.*;
  38 import java.time.*;
  39 import java.util.*;
  40 import java.util.logging.Logger;
  41 import java.util.regex.Pattern;
  42 import java.util.stream.Collectors;
  43 
  44 import static org.junit.jupiter.api.Assertions.*;
  45 
  46 class MailingListBridgeBotTests {
  47     private final Logger log = Logger.getLogger(&quot;org.openjdk.skara.bots.mlbridge.test&quot;);
  48 
  49     private Optional&lt;String&gt; archiveContents(Path archive) {
  50         try {
  51             var mbox = Files.find(archive, 50, (path, attrs) -&gt; path.toString().endsWith(&quot;.mbox&quot;)).findAny();
  52             if (mbox.isEmpty()) {
  53                 return Optional.empty();
  54             }
  55             return Optional.of(Files.readString(mbox.get(), StandardCharsets.UTF_8));
  56         } catch (IOException e) {
  57             return Optional.empty();
  58         }
  59 
  60     }
  61 
  62     private boolean archiveContains(Path archive, String text) {
  63         return archiveContainsCount(archive, text) &gt; 0;
  64     }
  65 
  66     private int archiveContainsCount(Path archive, String text) {
  67         var lines = archiveContents(archive);
  68         if (lines.isEmpty()) {
  69             return 0;
  70         }
  71         var pattern = Pattern.compile(text);
  72         int count = 0;
  73         for (var line : lines.get().split(&quot;\\R&quot;)) {
  74             var matcher = pattern.matcher(line);
  75             if (matcher.find()) {
  76                 count++;
  77             }
  78         }
  79         return count;
  80     }
  81 
  82     private boolean webrevContains(Path webrev, String text) {
  83         try {
  84             var index = Files.find(webrev, 5, (path, attrs) -&gt; path.toString().endsWith(&quot;index.html&quot;)).findAny();
  85             if (index.isEmpty()) {
  86                 return false;
  87             }
  88             var lines = Files.readString(index.get(), StandardCharsets.UTF_8);
  89             return lines.contains(text);
  90         } catch (IOException e) {
  91             return false;
  92         }
  93     }
  94 
  95     private long countSubstrings(String string, String substring) {
  96         return Pattern.compile(substring).matcher(string).results().count();
  97     }
  98 
  99     private String noreplyAddress(HostedRepository repository) {
 100         return &quot;test+&quot; + repository.forge().currentUser().id() + &quot;+&quot; +
 101                 repository.forge().currentUser().userName() +
 102                 &quot;@openjdk.java.net&quot;;
 103     }
 104 
 105     @Test
 106     void simpleArchive(TestInfo testInfo) throws IOException {
 107         try (var credentials = new HostCredentials(testInfo);
 108              var tempFolder = new TemporaryDirectory();
 109              var archiveFolder = new TemporaryDirectory();
 110              var webrevFolder = new TemporaryDirectory();
 111              var listServer = new TestMailmanServer();
 112              var webrevServer = new TestWebrevServer()) {
 113             var author = credentials.getHostedRepository();
 114             var archive = credentials.getHostedRepository();
 115             var ignored = credentials.getHostedRepository();
 116             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
 117             var censusBuilder = credentials.getCensusBuilder()
 118                                            .addAuthor(author.forge().currentUser().id());
 119             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
 120             var mlBot = MailingListBridgeBot.newBuilder()
 121                                             .from(from)
 122                                             .repo(author)
 123                                             .archive(archive)
 124                                             .censusRepo(censusBuilder.build())
 125                                             .list(listAddress)
 126                                             .ignoredUsers(Set.of(ignored.forge().currentUser().userName()))
 127                                             .ignoredComments(Set.of())
 128                                             .listArchive(listServer.getArchive())
 129                                             .smtpServer(listServer.getSMTP())
 130                                             .webrevStorageRepository(archive)
 131                                             .webrevStorageRef(&quot;webrev&quot;)
 132                                             .webrevStorageBase(Path.of(&quot;test&quot;))
 133                                             .webrevStorageBaseUri(webrevServer.uri())
 134                                             .readyLabels(Set.of(&quot;rfr&quot;))
 135                                             .readyComments(Map.of(ignored.forge().currentUser().userName(), Pattern.compile(&quot;ready&quot;)))
 136                                             .issueTracker(URIBuilder.base(&quot;http://issues.test/browse/&quot;).build())
 137                                             .headers(Map.of(&quot;Extra1&quot;, &quot;val1&quot;, &quot;Extra2&quot;, &quot;val2&quot;))
 138                                             .sendInterval(Duration.ZERO)
 139                                             .build();
 140 
 141             // Populate the projects repository
 142             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType());
 143             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
 144             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
 145             localRepo.push(masterHash, archive.url(), &quot;webrev&quot;, true);
 146 
 147             // Make a change with a corresponding PR
 148             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;A simple change&quot;,
 149                                                                &quot;Change msg\n\nWith several lines&quot;);
 150             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
 151             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;1234: This is a pull request&quot;);
 152             pr.setBody(&quot;This should not be ready&quot;);
 153 
 154             // Run an archive pass
 155             TestBotRunner.runPeriodicItems(mlBot);
 156 
 157             // A PR that isn&#39;t ready for review should not be archived
 158             Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);
 159             assertFalse(archiveContains(archiveFolder.path(), &quot;This is a pull request&quot;));
 160 
 161             // Flag it as ready for review
 162             pr.setBody(&quot;This should now be ready&quot;);
 163             pr.addLabel(&quot;rfr&quot;);
 164 
 165             // Run another archive pass
 166             TestBotRunner.runPeriodicItems(mlBot);
 167 
 168             // But it should still not be archived
 169             Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);
 170             assertFalse(archiveContains(archiveFolder.path(), &quot;This is a pull request&quot;));
 171 
 172             // Now post a general comment - not a ready marker
 173             var ignoredPr = ignored.pullRequest(pr.id());
 174             ignoredPr.addComment(&quot;hello there&quot;);
 175 
 176             // Run another archive pass
 177             TestBotRunner.runPeriodicItems(mlBot);
 178 
 179             // It should still not be archived
 180             Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);
 181             assertFalse(archiveContains(archiveFolder.path(), &quot;This is a pull request&quot;));
 182 
 183             // Now post a ready comment
 184             ignoredPr.addComment(&quot;ready&quot;);
 185 
 186             // Run another archive pass
 187             TestBotRunner.runPeriodicItems(mlBot);
 188 
 189             // The archive should now contain an entry
 190             Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);
 191             assertTrue(archiveContains(archiveFolder.path(), &quot;This is a pull request&quot;));
 192             assertTrue(archiveContains(archiveFolder.path(), &quot;This should now be ready&quot;));
 193             assertTrue(archiveContains(archiveFolder.path(), &quot;Patch:&quot;));
 194             assertTrue(archiveContains(archiveFolder.path(), &quot;Changes:&quot;));
 195             assertTrue(archiveContains(archiveFolder.path(), &quot;Webrev:&quot;));
 196             assertTrue(archiveContains(archiveFolder.path(), webrevServer.uri().toString()));
 197             assertTrue(archiveContains(archiveFolder.path(), &quot;webrev.00&quot;));
 198             assertTrue(archiveContains(archiveFolder.path(), &quot;Issue:&quot;));
 199             assertTrue(archiveContains(archiveFolder.path(), &quot;http://issues.test/browse/TSTPRJ-1234&quot;));
 200             assertTrue(archiveContains(archiveFolder.path(), &quot;Fetch:&quot;));
 201             assertTrue(archiveContains(archiveFolder.path(), &quot;^ - Change msg&quot;));
 202             assertFalse(archiveContains(archiveFolder.path(), &quot;With several lines&quot;));
 203 
 204             // The mailing list as well
 205             listServer.processIncoming();
 206             var mailmanServer = MailingListServerFactory.createMailmanServer(listServer.getArchive(), listServer.getSMTP(), Duration.ZERO);
 207             var mailmanList = mailmanServer.getList(listAddress.address());
 208             var conversations = mailmanList.conversations(Duration.ofDays(1));
 209             assertEquals(1, conversations.size());
 210             var mail = conversations.get(0).first();
 211             assertEquals(&quot;RFR: 1234: This is a pull request&quot;, mail.subject());
 212             assertEquals(pr.author().fullName(), mail.author().fullName().orElseThrow());
 213             assertEquals(noreplyAddress(archive), mail.author().address());
 214             assertEquals(listAddress, mail.sender());
 215             assertEquals(&quot;val1&quot;, mail.headerValue(&quot;Extra1&quot;));
 216             assertEquals(&quot;val2&quot;, mail.headerValue(&quot;Extra2&quot;));
 217 
 218             // And there should be a webrev
 219             Repository.materialize(webrevFolder.path(), archive.url(), &quot;webrev&quot;);
 220             assertTrue(webrevContains(webrevFolder.path(), &quot;1 lines changed&quot;));
 221             var comments = pr.comments();
 222             var webrevComments = comments.stream()
 223                                          .filter(comment -&gt; comment.author().equals(author.forge().currentUser()))
 224                                          .filter(comment -&gt; comment.body().contains(&quot;webrev&quot;))
 225                                          .filter(comment -&gt; comment.body().contains(editHash.hex()))
 226                                          .collect(Collectors.toList());
 227             assertEquals(1, webrevComments.size());
 228 
 229             // Add a comment
 230             pr.addComment(&quot;This is a comment :smile:&quot;);
 231 
 232             // Add a comment from an ignored user as well
 233             ignoredPr.addComment(&quot;Don&#39;t mind me&quot;);
 234 
 235             // Run another archive pass
 236             TestBotRunner.runPeriodicItems(mlBot);
 237 
 238             // The archive should now contain the comment, but not the ignored one
 239             Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);
 240             assertTrue(archiveContains(archiveFolder.path(), &quot;This is a comment&quot;));
 241             assertTrue(archiveContains(archiveFolder.path(), &quot;&gt; This should now be ready&quot;));
 242             assertFalse(archiveContains(archiveFolder.path(), &quot;Don&#39;t mind me&quot;));
 243 
 244             listServer.processIncoming();
 245             conversations = mailmanList.conversations(Duration.ofDays(1));
 246             assertEquals(1, conversations.size());
 247             assertEquals(2, conversations.get(0).allMessages().size());
 248 
 249             // Remove the rfr flag and post another comment
 250             pr.addLabel(&quot;rfr&quot;);
 251             pr.addComment(&quot;This is another comment&quot;);
 252 
 253             // Run another archive pass
 254             TestBotRunner.runPeriodicItems(mlBot);
 255 
 256             // The archive should contain the additional comment
 257             Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);
 258             assertTrue(archiveContains(archiveFolder.path(), &quot;This is another comment&quot;));
 259             assertTrue(archiveContains(archiveFolder.path(), &quot;&gt;&gt; This should now be ready&quot;));
 260 
 261             listServer.processIncoming();
 262             conversations = mailmanList.conversations(Duration.ofDays(1));
 263             assertEquals(1, conversations.size());
 264             assertEquals(3, conversations.get(0).allMessages().size());
 265             for (var newMail : conversations.get(0).allMessages()) {
 266                 assertEquals(noreplyAddress(archive), newMail.author().address());
 267                 assertEquals(listAddress, newMail.sender());
 268             }
 269             assertTrue(conversations.get(0).allMessages().get(2).body().contains(&quot;This is a comment ðŸ˜„&quot;));
 270         }
 271     }
 272 
 273     @Test
 274     void archiveIntegrated(TestInfo testInfo) throws IOException {
 275         try (var credentials = new HostCredentials(testInfo);
 276              var tempFolder = new TemporaryDirectory();
 277              var archiveFolder = new TemporaryDirectory();
 278              var webrevFolder = new TemporaryDirectory();
 279              var listServer = new TestMailmanServer();
 280              var webrevServer = new TestWebrevServer()) {
 281             var author = credentials.getHostedRepository();
 282             var archive = credentials.getHostedRepository();
 283             var ignored = credentials.getHostedRepository();
 284             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
 285             var censusBuilder = credentials.getCensusBuilder()
 286                                            .addAuthor(author.forge().currentUser().id());
 287             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
 288             var mlBot = MailingListBridgeBot.newBuilder()
 289                                             .from(from)
 290                                             .repo(author)
 291                                             .archive(archive)
 292                                             .censusRepo(censusBuilder.build())
 293                                             .list(listAddress)
 294                                             .ignoredUsers(Set.of(ignored.forge().currentUser().userName()))
 295                                             .listArchive(listServer.getArchive())
 296                                             .smtpServer(listServer.getSMTP())
 297                                             .webrevStorageRepository(archive)
 298                                             .webrevStorageRef(&quot;webrev&quot;)
 299                                             .webrevStorageBase(Path.of(&quot;test&quot;))
 300                                             .webrevStorageBaseUri(webrevServer.uri())
 301                                             .issueTracker(URIBuilder.base(&quot;http://issues.test/browse/&quot;).build())
 302                                             .build();
 303 
 304             // Populate the projects repository
 305             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType());
 306             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
 307             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
 308             localRepo.push(masterHash, archive.url(), &quot;webrev&quot;, true);
 309 
 310             // Make a change with a corresponding PR
 311             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;A simple change&quot;,
 312                                                                &quot;Change msg\n\nWith several lines&quot;);
 313             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
 314             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;1234: This is a pull request&quot;);
 315             pr.setBody(&quot;This is now ready&quot;);
 316             pr.addLabel(&quot;rfr&quot;);
 317 
 318             // Run an archive pass
 319             TestBotRunner.runPeriodicItems(mlBot);
 320             TestBotRunner.runPeriodicItems(mlBot);
 321 
 322             // There should be an RFR thread
 323             Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);
 324             assertTrue(archiveContains(archiveFolder.path(), &quot;Subject: RFR: 1234: This is a pull request&quot;));
 325 
<a name="1" id="anc1"></a>


 326             // Now it has been integrated
 327             var ignoredPr = ignored.pullRequest(pr.id());
 328             ignoredPr.setBody(&quot;This has been integrated&quot;);
 329             ignoredPr.addLabel(&quot;integrated&quot;);
 330             ignoredPr.addComment(&quot;Pushed as commit &quot; + editHash + &quot;.&quot;);
 331             ignoredPr.setState(Issue.State.CLOSED);
 332 
 333             // Run another archive pass
 334             TestBotRunner.runPeriodicItems(mlBot);
 335 
 336             // The archive should now contain another entry
 337             Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);
<a name="2" id="anc2"></a>
 338             assertTrue(archiveContains(archiveFolder.path(), &quot;Subject: Integrated: 1234: This is a pull request&quot;));
 339             assertFalse(archiveContains(archiveFolder.path(), &quot;\\[Closed\\]&quot;));
 340         }
 341     }
 342 
 343     @Test
 344     void archiveLegacyIntegrated(TestInfo testInfo) throws IOException {
 345         try (var credentials = new HostCredentials(testInfo);
 346              var tempFolder = new TemporaryDirectory();
 347              var archiveFolder = new TemporaryDirectory();
 348              var webrevFolder = new TemporaryDirectory();
 349              var listServer = new TestMailmanServer();
 350              var webrevServer = new TestWebrevServer()) {
 351             var author = credentials.getHostedRepository();
 352             var archive = credentials.getHostedRepository();
 353             var ignored = credentials.getHostedRepository();
 354             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
 355             var censusBuilder = credentials.getCensusBuilder()
 356                     .addAuthor(author.forge().currentUser().id());
 357             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
 358             var mlBot = MailingListBridgeBot.newBuilder()
 359                     .from(from)
 360                     .repo(author)
 361                     .archive(archive)
 362                     .censusRepo(censusBuilder.build())
 363                     .list(listAddress)
 364                     .ignoredUsers(Set.of(ignored.forge().currentUser().userName()))
 365                     .listArchive(listServer.getArchive())
 366                     .smtpServer(listServer.getSMTP())
 367                     .webrevStorageRepository(archive)
 368                     .webrevStorageRef(&quot;webrev&quot;)
 369                     .webrevStorageBase(Path.of(&quot;test&quot;))
 370                     .webrevStorageBaseUri(webrevServer.uri())
 371                     .issueTracker(URIBuilder.base(&quot;http://issues.test/browse/&quot;).build())
 372                     .build();
 373 
 374             // Populate the projects repository
 375             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType());
 376             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
 377             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
 378             localRepo.push(masterHash, archive.url(), &quot;webrev&quot;, true);
 379 
 380             // Make a change with a corresponding PR with a date in the past
 381             var editFile = tempFolder.path().resolve(&quot;change.txt&quot;);
 382             Files.writeString(editFile, &quot;A simple change&quot;);
 383             localRepo.add(editFile);
 384             var commitDate = ZonedDateTime.of(2020, 3, 12, 0, 0, 0, 0, ZoneId.of(&quot;UTC&quot;));
 385             var editHash = localRepo.commit(&quot;An old change&quot;, &quot;duke&quot;, &quot;duke@openjdk.org&quot;, commitDate,
 386                              &quot;duke&quot;, &quot;duke@openjdk.org&quot;, commitDate);
 387             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
 388             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;1234: This is a pull request&quot;);
 389             pr.setBody(&quot;This is now ready&quot;);
 390             pr.addLabel(&quot;rfr&quot;);
 391 
 392             // Run an archive pass
 393             TestBotRunner.runPeriodicItems(mlBot);
 394             TestBotRunner.runPeriodicItems(mlBot);
 395 
 396             // There should be an RFR thread
 397             Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);
 398             assertTrue(archiveContains(archiveFolder.path(), &quot;Subject: RFR: 1234: This is a pull request&quot;));
 399 
 400             // Now it has been integrated
 401             var ignoredPr = ignored.pullRequest(pr.id());
 402             ignoredPr.setBody(&quot;This has been integrated&quot;);
 403             ignoredPr.addLabel(&quot;integrated&quot;);
 404             ignoredPr.addComment(&quot;Pushed as commit &quot; + editHash + &quot;.&quot;);
 405             ignoredPr.setState(Issue.State.CLOSED);
 406 
 407             // Run another archive pass
 408             TestBotRunner.runPeriodicItems(mlBot);
 409 
 410             // The archive should not contain another entry
 411             Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);
 412             assertFalse(archiveContains(archiveFolder.path(), &quot;\\[Integrated\\]&quot;));
 413             assertFalse(archiveContains(archiveFolder.path(), &quot;\\[Closed\\]&quot;));
 414         }
 415     }
 416 
 417     @Test
 418     void archiveDirectToIntegrated(TestInfo testInfo) throws IOException {
 419         try (var credentials = new HostCredentials(testInfo);
 420              var tempFolder = new TemporaryDirectory();
 421              var archiveFolder = new TemporaryDirectory();
 422              var webrevFolder = new TemporaryDirectory();
 423              var listServer = new TestMailmanServer();
 424              var webrevServer = new TestWebrevServer()) {
 425             var author = credentials.getHostedRepository();
 426             var archive = credentials.getHostedRepository();
 427             var ignored = credentials.getHostedRepository();
 428             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
 429             var censusBuilder = credentials.getCensusBuilder()
 430                                            .addAuthor(author.forge().currentUser().id());
 431             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
 432             var mlBot = MailingListBridgeBot.newBuilder()
 433                                             .from(from)
 434                                             .repo(author)
 435                                             .archive(archive)
 436                                             .censusRepo(censusBuilder.build())
 437                                             .list(listAddress)
 438                                             .ignoredUsers(Set.of(ignored.forge().currentUser().userName()))
 439                                             .listArchive(listServer.getArchive())
 440                                             .smtpServer(listServer.getSMTP())
 441                                             .webrevStorageRepository(archive)
 442                                             .webrevStorageRef(&quot;webrev&quot;)
 443                                             .webrevStorageBase(Path.of(&quot;test&quot;))
 444                                             .webrevStorageBaseUri(webrevServer.uri())
 445                                             .issueTracker(URIBuilder.base(&quot;http://issues.test/browse/&quot;).build())
 446                                             .build();
 447 
 448             // Populate the projects repository
 449             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType());
 450             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
 451             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
 452             localRepo.push(masterHash, archive.url(), &quot;webrev&quot;, true);
 453 
 454             // Make a change with a corresponding PR
 455             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;A simple change&quot;,
 456                                                                &quot;Change msg\n\nWith several lines&quot;);
 457             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
 458             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;1234: This is a pull request&quot;);
 459             pr.setBody(&quot;This should not be ready&quot;);
 460             pr.setState(Issue.State.CLOSED);
 461 
 462             // Run an archive pass
 463             TestBotRunner.runPeriodicItems(mlBot);
 464             TestBotRunner.runPeriodicItems(mlBot);
 465 
 466             // A PR that isn&#39;t ready for review should not be archived
 467             Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);
 468             assertFalse(archiveContains(archiveFolder.path(), &quot;This is a pull request&quot;));
 469 
 470             // Now it has been integrated
 471             var ignoredPr = ignored.pullRequest(pr.id());
 472             ignoredPr.setBody(&quot;This has already been integrated&quot;);
 473             ignoredPr.addLabel(&quot;integrated&quot;);
 474             ignoredPr.addComment(&quot;Pushed as commit &quot; + editHash + &quot;.&quot;);
 475 
 476             // Run another archive pass
 477             TestBotRunner.runPeriodicItems(mlBot);
 478 
 479             // The archive should now contain an entry
 480             Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);
 481             assertTrue(archiveContains(archiveFolder.path(), &quot;Subject: Integrated: 1234: This is a pull request&quot;));
 482 
 483             var updatedHash = CheckableRepository.appendAndCommit(localRepo, &quot;Another change&quot;);
 484             localRepo.push(updatedHash, author.url(), &quot;edit&quot;);
 485 
 486             // Run another archive pass
 487             TestBotRunner.runPeriodicItems(mlBot);
 488 
 489             // The archive should now contain another entry
 490             Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);
 491             assertTrue(archiveContains(archiveFolder.path(), &quot;Subject: Re: Integrated: 1234: This is a pull request \\[v2\\]&quot;));
 492             assertFalse(archiveContains(archiveFolder.path(), &quot;Withdrawn&quot;));
 493         }
 494     }
 495 
 496     @Test
 497     void archiveIntegratedRetainPrefix(TestInfo testInfo) throws IOException {
 498         try (var credentials = new HostCredentials(testInfo);
 499              var tempFolder = new TemporaryDirectory();
 500              var archiveFolder = new TemporaryDirectory();
 501              var webrevFolder = new TemporaryDirectory();
 502              var listServer = new TestMailmanServer();
 503              var webrevServer = new TestWebrevServer()) {
 504             var author = credentials.getHostedRepository();
 505             var archive = credentials.getHostedRepository();
 506             var ignored = credentials.getHostedRepository();
 507             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
 508             var censusBuilder = credentials.getCensusBuilder()
 509                                            .addAuthor(author.forge().currentUser().id());
 510             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
 511             var mlBot = MailingListBridgeBot.newBuilder()
 512                                             .from(from)
 513                                             .repo(author)
 514                                             .archive(archive)
 515                                             .censusRepo(censusBuilder.build())
 516                                             .list(listAddress)
 517                                             .ignoredUsers(Set.of(ignored.forge().currentUser().userName()))
 518                                             .listArchive(listServer.getArchive())
 519                                             .smtpServer(listServer.getSMTP())
 520                                             .webrevStorageRepository(archive)
 521                                             .webrevStorageRef(&quot;webrev&quot;)
 522                                             .webrevStorageBase(Path.of(&quot;test&quot;))
 523                                             .webrevStorageBaseUri(webrevServer.uri())
 524                                             .readyLabels(Set.of(&quot;rfr&quot;))
 525                                             .issueTracker(URIBuilder.base(&quot;http://issues.test/browse/&quot;).build())
 526                                             .build();
 527 
 528             // Populate the projects repository
 529             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType());
 530             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
 531             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
 532             localRepo.push(masterHash, archive.url(), &quot;webrev&quot;, true);
 533 
 534             // Make a change with a corresponding PR
 535             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;A simple change&quot;,
 536                                                                &quot;Change msg\n\nWith several lines&quot;);
 537             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
 538             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;1234: This is a pull request&quot;);
 539             pr.setBody(&quot;This should be ready&quot;);
 540 
 541             // Run an archive pass
 542             TestBotRunner.runPeriodicItems(mlBot);
 543             TestBotRunner.runPeriodicItems(mlBot);
 544 
 545             // A PR that isn&#39;t ready for review should not be archived
 546             Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);
 547             assertFalse(archiveContains(archiveFolder.path(), &quot;This is a pull request&quot;));
 548 
 549             // Flag it as ready for review
 550             pr.addLabel(&quot;rfr&quot;);
 551 
 552             // Run another archive pass
 553             TestBotRunner.runPeriodicItems(mlBot);
 554 
 555             // The archive should now contain an entry
 556             Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);
 557             assertTrue(archiveContains(archiveFolder.path(), &quot;Subject: RFR: 1234: This is a pull request&quot;));
 558 
 559             // Close it and then push another change
 560             pr.setState(Issue.State.CLOSED);
 561             var updatedHash = CheckableRepository.appendAndCommit(localRepo, &quot;Another change&quot;);
 562             localRepo.push(updatedHash, author.url(), &quot;edit&quot;);
 563 
 564             // Run another archive pass
 565             TestBotRunner.runPeriodicItems(mlBot);
 566 
 567             // The archive should now contain another entry - should retain the RFR thread prefix
 568             Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);
 569             assertTrue(archiveContains(archiveFolder.path(), &quot;Subject: Re: RFR: 1234: This is a pull request \\[v2\\]&quot;));
 570         }
 571     }
 572 
 573     @Test
 574     void archiveClosed(TestInfo testInfo) throws IOException {
 575         try (var credentials = new HostCredentials(testInfo);
 576              var tempFolder = new TemporaryDirectory();
 577              var archiveFolder = new TemporaryDirectory();
 578              var webrevFolder = new TemporaryDirectory();
 579              var listServer = new TestMailmanServer();
 580              var webrevServer = new TestWebrevServer()) {
 581             var author = credentials.getHostedRepository();
 582             var archive = credentials.getHostedRepository();
 583             var ignored = credentials.getHostedRepository();
 584             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
 585             var censusBuilder = credentials.getCensusBuilder()
 586                                            .addAuthor(author.forge().currentUser().id());
 587             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
 588             var mlBot = MailingListBridgeBot.newBuilder()
 589                                             .from(from)
 590                                             .repo(author)
 591                                             .archive(archive)
 592                                             .censusRepo(censusBuilder.build())
 593                                             .list(listAddress)
 594                                             .ignoredUsers(Set.of(ignored.forge().currentUser().userName()))
 595                                             .listArchive(listServer.getArchive())
 596                                             .smtpServer(listServer.getSMTP())
 597                                             .webrevStorageRepository(archive)
 598                                             .webrevStorageRef(&quot;webrev&quot;)
 599                                             .webrevStorageBase(Path.of(&quot;test&quot;))
 600                                             .webrevStorageBaseUri(webrevServer.uri())
 601                                             .readyLabels(Set.of(&quot;rfr&quot;))
 602                                             .issueTracker(URIBuilder.base(&quot;http://issues.test/browse/&quot;).build())
 603                                             .build();
 604 
 605             // Populate the projects repository
 606             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType());
 607             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
 608             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
 609             localRepo.push(masterHash, archive.url(), &quot;webrev&quot;, true);
 610 
 611             // Make a change with a corresponding PR
 612             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;A simple change&quot;,
 613                                                                &quot;Change msg\n\nWith several lines&quot;);
 614             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
 615             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;1234: This is a pull request&quot;);
 616             pr.setBody(&quot;This should be ready&quot;);
 617 
 618             // Run an archive pass
 619             TestBotRunner.runPeriodicItems(mlBot);
 620             TestBotRunner.runPeriodicItems(mlBot);
 621 
 622             // A PR that isn&#39;t ready for review should not be archived
 623             Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);
 624             assertFalse(archiveContains(archiveFolder.path(), &quot;This is a pull request&quot;));
 625 
 626             // Flag it as ready for review
 627             pr.addLabel(&quot;rfr&quot;);
 628 
 629             // Run another archive pass
 630             TestBotRunner.runPeriodicItems(mlBot);
 631 
 632             // The archive should now contain an entry
 633             Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);
 634             assertTrue(archiveContains(archiveFolder.path(), &quot;Subject: RFR: 1234: This is a pull request&quot;));
 635 
 636             // Close it
 637             pr.setState(Issue.State.CLOSED);
 638 
 639             // Run another archive pass
 640             TestBotRunner.runPeriodicItems(mlBot);
 641 
 642             // The archive should now contain another entry - should say that it is closed
 643             Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);
 644             assertEquals(1, archiveContainsCount(archiveFolder.path(), &quot;Subject: Withdrawn: 1234: This is a pull request&quot;));
 645 
 646             pr.addComment(&quot;Fair enough&quot;);
 647 
 648             // Run another archive pass - only a single close notice should have been posted
 649             TestBotRunner.runPeriodicItems(mlBot);
 650             Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);
 651             assertEquals(1, archiveContainsCount(archiveFolder.path(), &quot;Subject: Withdrawn: 1234: This is a pull request&quot;));
 652             assertEquals(1, archiveContainsCount(archiveFolder.path(), &quot;Subject: Re: RFR: 1234: This is a pull request&quot;));
 653         }
 654     }
 655 
 656     @Test
 657     void archiveFailedAutoMerge(TestInfo testInfo) throws IOException {
 658         try (var credentials = new HostCredentials(testInfo);
 659              var tempFolder = new TemporaryDirectory();
 660              var archiveFolder = new TemporaryDirectory();
 661              var webrevFolder = new TemporaryDirectory();
 662              var listServer = new TestMailmanServer();
 663              var webrevServer = new TestWebrevServer()) {
 664             var author = credentials.getHostedRepository();
 665             var archive = credentials.getHostedRepository();
 666             var ignored = credentials.getHostedRepository();
 667             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
 668             var censusBuilder = credentials.getCensusBuilder()
 669                                            .addAuthor(author.forge().currentUser().id());
 670             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
 671             var mlBot = MailingListBridgeBot.newBuilder()
 672                                             .from(from)
 673                                             .repo(author)
 674                                             .archive(archive)
 675                                             .censusRepo(censusBuilder.build())
 676                                             .list(listAddress)
 677                                             .ignoredUsers(Set.of(ignored.forge().currentUser().userName()))
 678                                             .listArchive(listServer.getArchive())
 679                                             .smtpServer(listServer.getSMTP())
 680                                             .webrevStorageRepository(archive)
 681                                             .webrevStorageRef(&quot;webrev&quot;)
 682                                             .webrevStorageBase(Path.of(&quot;test&quot;))
 683                                             .webrevStorageBaseUri(webrevServer.uri())
 684                                             .issueTracker(URIBuilder.base(&quot;http://issues.test/browse/&quot;).build())
 685                                             .build();
 686 
 687             // Populate the projects repository
 688             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType());
 689             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
 690             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
 691             localRepo.push(masterHash, archive.url(), &quot;webrev&quot;, true);
 692 
 693             // Make a change with a corresponding PR
 694             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;A simple change&quot;,
 695                                                                &quot;Change msg\n\nWith several lines&quot;);
 696             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
 697             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;Cannot automatically merge&quot;);
 698             pr.setBody(&quot;This is an automated merge PR&quot;);
 699             pr.addLabel(&quot;failed-auto-merge&quot;);
 700 
 701             // Run an archive pass
 702             TestBotRunner.runPeriodicItems(mlBot);
 703             TestBotRunner.runPeriodicItems(mlBot);
 704 
 705             // The archive should contain an entry
 706             Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);
 707             assertTrue(archiveContains(archiveFolder.path(), &quot;Subject: RFR: Cannot automatically merge&quot;));
 708         }
 709     }
 710 
 711     @Test
 712     void reviewComment(TestInfo testInfo) throws IOException {
 713         try (var credentials = new HostCredentials(testInfo);
 714              var tempFolder = new TemporaryDirectory();
 715              var archiveFolder = new TemporaryDirectory();
 716              var listServer = new TestMailmanServer();
 717              var webrevServer = new TestWebrevServer()) {
 718             var author = credentials.getHostedRepository();
 719             var archive = credentials.getHostedRepository();
 720             var ignored = credentials.getHostedRepository();
 721             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
 722             var censusBuilder = credentials.getCensusBuilder()
 723                                            .addAuthor(author.forge().currentUser().id());
 724             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
 725             var mlBot = MailingListBridgeBot.newBuilder()
 726                                             .from(from)
 727                                             .repo(author)
 728                                             .archive(archive)
 729                                             .censusRepo(censusBuilder.build())
 730                                             .list(listAddress)
 731                                             .ignoredUsers(Set.of(ignored.forge().currentUser().userName()))
 732                                             .listArchive(listServer.getArchive())
 733                                             .smtpServer(listServer.getSMTP())
 734                                             .webrevStorageRepository(archive)
 735                                             .webrevStorageRef(&quot;webrev&quot;)
 736                                             .webrevStorageBase(Path.of(&quot;test&quot;))
 737                                             .webrevStorageBaseUri(webrevServer.uri())
 738                                             .issueTracker(URIBuilder.base(&quot;http://issues.test/browse/&quot;).build())
 739                                             .build();
 740 
 741             // Populate the projects repository
 742             var reviewFile = Path.of(&quot;reviewfile.txt&quot;);
 743             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType(), reviewFile);
 744             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
 745             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
 746             localRepo.push(masterHash, archive.url(), &quot;webrev&quot;, true);
 747 
 748             // Make a change with a corresponding PR
 749             var editHash = CheckableRepository.appendAndCommit(localRepo);
 750             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
 751             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
 752             pr.setBody(&quot;This is now ready&quot;);
 753             TestBotRunner.runPeriodicItems(mlBot);
 754             listServer.processIncoming();
 755 
 756             // And make a file specific comment
 757             var currentMaster = localRepo.resolve(&quot;master&quot;).orElseThrow();
 758             var comment = pr.addReviewComment(masterHash, editHash, reviewFile.toString(), 2, &quot;Review comment&quot;);
 759 
 760             // Add one from an ignored user as well
 761             var ignoredPr = ignored.pullRequest(pr.id());
 762             ignoredPr.addReviewComment(masterHash, editHash, reviewFile.toString(), 2, &quot;Don&#39;t mind me&quot;);
 763 
 764             // Process comments
 765             TestBotRunner.runPeriodicItems(mlBot);
 766             listServer.processIncoming();
 767 
 768             // The archive should now contain an entry
 769             Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);
 770             assertTrue(archiveContains(archiveFolder.path(), &quot;This is a pull request&quot;));
 771             assertTrue(archiveContains(archiveFolder.path(), &quot;This is now ready&quot;));
 772             assertTrue(archiveContains(archiveFolder.path(), &quot;Review comment&quot;));
 773             assertTrue(archiveContains(archiveFolder.path(), &quot;&gt; This is now ready&quot;));
 774             assertTrue(archiveContains(archiveFolder.path(), reviewFile.toString()));
 775             assertFalse(archiveContains(archiveFolder.path(), &quot;Don&#39;t mind me&quot;));
 776 
 777             // The mailing list as well
 778             var mailmanServer = MailingListServerFactory.createMailmanServer(listServer.getArchive(), listServer.getSMTP(), Duration.ZERO);
 779             var mailmanList = mailmanServer.getList(listAddress.address());
 780             var conversations = mailmanList.conversations(Duration.ofDays(1));
 781             assertEquals(1, conversations.size());
 782             var mail = conversations.get(0).first();
 783             assertEquals(&quot;RFR: This is a pull request&quot;, mail.subject());
 784 
 785             // Comment on the comment
 786             pr.addReviewCommentReply(comment, &quot;This is a review reply&quot;);
 787             TestBotRunner.runPeriodicItems(mlBot);
 788             listServer.processIncoming();
 789 
 790             // The archive should contain the additional comment (but no quoted footers)
 791             Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);
 792             assertTrue(archiveContains(archiveFolder.path(), &quot;This is a review reply&quot;));
 793             assertTrue(archiveContains(archiveFolder.path(), &quot;&gt;&gt; This is now ready&quot;));
 794             assertFalse(archiveContains(archiveFolder.path(), &quot;^&gt; PR:&quot;));
 795 
 796             // As well as the mailing list
 797             conversations = mailmanList.conversations(Duration.ofDays(1));
 798             assertEquals(1, conversations.size());
 799             assertEquals(3, conversations.get(0).allMessages().size());
 800             for (var newMail : conversations.get(0).allMessages()) {
 801                 assertEquals(noreplyAddress(archive), newMail.author().address());
 802                 assertEquals(listAddress, newMail.sender());
 803             }
 804         }
 805     }
 806 
 807     @Test
 808     void combineComments(TestInfo testInfo) throws IOException {
 809         try (var credentials = new HostCredentials(testInfo);
 810              var tempFolder = new TemporaryDirectory();
 811              var archiveFolder = new TemporaryDirectory();
 812              var listServer = new TestMailmanServer();
 813              var webrevServer = new TestWebrevServer()) {
 814             var author = credentials.getHostedRepository();
 815             var archive = credentials.getHostedRepository();
 816             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
 817             var censusBuilder = credentials.getCensusBuilder()
 818                                            .addAuthor(author.forge().currentUser().id());
 819             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
 820             var mlBot = MailingListBridgeBot.newBuilder()
 821                                             .from(from)
 822                                             .repo(author)
 823                                             .archive(archive)
 824                                             .censusRepo(censusBuilder.build())
 825                                             .list(listAddress)
 826                                             .listArchive(listServer.getArchive())
 827                                             .smtpServer(listServer.getSMTP())
 828                                             .webrevStorageRepository(archive)
 829                                             .webrevStorageRef(&quot;webrev&quot;)
 830                                             .webrevStorageBase(Path.of(&quot;test&quot;))
 831                                             .webrevStorageBaseUri(webrevServer.uri())
 832                                             .issueTracker(URIBuilder.base(&quot;http://issues.test/browse/&quot;).build())
 833                                             .build();
 834 
 835             // Populate the projects repository
 836             var reviewFile = Path.of(&quot;reviewfile.txt&quot;);
 837             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType(), reviewFile);
 838             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
 839             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
 840             localRepo.push(masterHash, archive.url(), &quot;webrev&quot;, true);
 841 
 842             // Make a change with a corresponding PR
 843             var editHash = CheckableRepository.appendAndCommit(localRepo);
 844             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
 845             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
 846             pr.setBody(&quot;This is now ready&quot;);
 847             pr.addComment(&quot;Avoid combining&quot;);
 848 
 849             TestBotRunner.runPeriodicItems(mlBot);
 850             listServer.processIncoming();
 851             listServer.processIncoming();
 852 
 853             // Make several file specific comments
 854             var first = pr.addReviewComment(masterHash, editHash, reviewFile.toString(), 2, &quot;Review comment&quot;);
 855             var second = pr.addReviewComment(masterHash, editHash, reviewFile.toString(), 2, &quot;Another review comment&quot;);
 856             pr.addReviewComment(masterHash, editHash, reviewFile.toString(), 2, &quot;Further review comment&quot;);
 857             pr.addReviewComment(masterHash, editHash, reviewFile.toString(), 2, &quot;Final review comment&quot;);
 858             TestBotRunner.runPeriodicItems(mlBot);
 859             listServer.processIncoming();
 860 
 861             // The archive should contain a combined entry
 862             Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);
 863             assertEquals(2, archiveContainsCount(archiveFolder.path(), &quot;^On.*wrote:&quot;));
 864 
 865             // As well as the mailing list
 866             var mailmanServer = MailingListServerFactory.createMailmanServer(listServer.getArchive(), listServer.getSMTP(), Duration.ZERO);
 867             var mailmanList = mailmanServer.getList(listAddress.address());
 868             var conversations = mailmanList.conversations(Duration.ofDays(1));
 869             assertEquals(1, conversations.size());
 870             var mail = conversations.get(0).first();
 871             assertEquals(&quot;RFR: This is a pull request&quot;, mail.subject());
 872             assertEquals(3, conversations.get(0).allMessages().size());
 873 
 874             var commentReply = conversations.get(0).replies(mail).get(0);
 875             assertEquals(2, commentReply.body().split(&quot;^On.*wrote:&quot;).length);
 876             assertTrue(commentReply.body().contains(&quot;Avoid combining\n\n&quot;), commentReply.body());
 877 
 878             var reviewReply = conversations.get(0).replies(mail).get(1);
 879             assertEquals(2, reviewReply.body().split(&quot;^On.*wrote:&quot;).length);
 880             assertEquals(2, reviewReply.body().split(&quot;&gt; This is now ready&quot;).length, reviewReply.body());
 881             assertEquals(&quot;RFR: This is a pull request&quot;, reviewReply.subject());
 882             assertTrue(reviewReply.body().contains(&quot;Review comment\n\n&quot;), reviewReply.body());
 883             assertTrue(reviewReply.body().contains(&quot;Another review comment&quot;), reviewReply.body());
 884 
 885             // Now reply to the first and second (collapsed) comment
 886             pr.addReviewCommentReply(first, &quot;I agree&quot;);
 887             pr.addReviewCommentReply(second, &quot;Not with this one though&quot;);
 888             TestBotRunner.runPeriodicItems(mlBot);
 889             listServer.processIncoming();
 890 
 891             // The archive should contain a new entry
 892             Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);
 893             assertEquals(3, archiveContainsCount(archiveFolder.path(), &quot;^On.*wrote:&quot;));
 894 
 895             // The combined review comments should only appear unquoted once
 896             assertEquals(1, archiveContainsCount(archiveFolder.path(), &quot;^Another review comment&quot;));
 897         }
 898     }
 899 
 900     @Test
 901     void commentThreading(TestInfo testInfo) throws IOException {
 902         try (var credentials = new HostCredentials(testInfo);
 903              var tempFolder = new TemporaryDirectory();
 904              var archiveFolder = new TemporaryDirectory();
 905              var listServer = new TestMailmanServer();
 906              var webrevServer = new TestWebrevServer()) {
 907             var author = credentials.getHostedRepository();
 908             var reviewer = credentials.getHostedRepository();
 909             var archive = credentials.getHostedRepository();
 910             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
 911             var censusBuilder = credentials.getCensusBuilder()
 912                                            .addReviewer(reviewer.forge().currentUser().id())
 913                                            .addAuthor(author.forge().currentUser().id());
 914             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
 915             var mlBot = MailingListBridgeBot.newBuilder()
 916                                             .from(from)
 917                                             .repo(author)
 918                                             .archive(archive)
 919                                             .censusRepo(censusBuilder.build())
 920                                             .list(listAddress)
 921                                             .listArchive(listServer.getArchive())
 922                                             .smtpServer(listServer.getSMTP())
 923                                             .webrevStorageRepository(archive)
 924                                             .webrevStorageRef(&quot;webrev&quot;)
 925                                             .webrevStorageBase(Path.of(&quot;test&quot;))
 926                                             .webrevStorageBaseUri(webrevServer.uri())
 927                                             .issueTracker(URIBuilder.base(&quot;http://issues.test/browse/&quot;).build())
 928                                             .build();
 929 
 930             // Populate the projects repository
 931             var reviewFile = Path.of(&quot;reviewfile.txt&quot;);
 932             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType(), reviewFile);
 933             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
 934             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
 935             localRepo.push(masterHash, archive.url(), &quot;webrev&quot;, true);
 936 
 937             // Make a change with a corresponding PR
 938             var editHash = CheckableRepository.appendAndCommit(localRepo);
 939             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
 940             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
 941             pr.setBody(&quot;This is now ready&quot;);
 942             TestBotRunner.runPeriodicItems(mlBot);
 943             listServer.processIncoming();
 944 
 945             // Make a file specific comment
 946             var reviewPr = reviewer.pullRequest(pr.id());
 947             var comment1 = reviewPr.addReviewComment(masterHash, editHash, reviewFile.toString(), 2, &quot;Review comment&quot;);
 948             pr.addReviewCommentReply(comment1, &quot;I agree&quot;);
 949             reviewPr.addReviewCommentReply(comment1, &quot;Great&quot;);
 950             TestBotRunner.runPeriodicItems(mlBot);
 951             listServer.processIncoming();
 952             listServer.processIncoming();
 953             listServer.processIncoming();
 954 
 955             // And a second one by ourselves
 956             var comment2 = pr.addReviewComment(masterHash, editHash, reviewFile.toString(), 2, &quot;Another review comment&quot;);
 957             reviewPr.addReviewCommentReply(comment2, &quot;Sounds good&quot;);
 958             pr.addReviewCommentReply(comment2, &quot;Thanks&quot;);
 959             TestBotRunner.runPeriodicItems(mlBot);
 960             listServer.processIncoming();
 961             listServer.processIncoming();
 962             listServer.processIncoming();
 963 
 964             // Finally some approvals and another comment
 965             pr.addReview(Review.Verdict.APPROVED, &quot;Nice&quot;);
 966             reviewPr.addReviewComment(masterHash, editHash, reviewFile.toString(), 2, &quot;The final review comment&quot;);
 967             reviewPr.addReview(Review.Verdict.APPROVED, &quot;Looks fine&quot;);
 968             reviewPr.addReviewCommentReply(comment2, &quot;You are welcome&quot;);
 969             TestBotRunner.runPeriodicItems(mlBot);
 970             listServer.processIncoming();
 971             listServer.processIncoming();
 972             listServer.processIncoming();
 973 
 974             // Sanity check the archive
 975             Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);
 976             assertEquals(9, archiveContainsCount(archiveFolder.path(), &quot;^On.*wrote:&quot;));
 977 
 978             // File specific comments should appear after the approval
 979             var archiveText = archiveContents(archiveFolder.path()).orElseThrow();
 980             assertTrue(archiveText.indexOf(&quot;Looks fine&quot;) &lt; archiveText.indexOf(&quot;The final review comment&quot;));
 981 
 982             // Check the mailing list
 983             var mailmanServer = MailingListServerFactory.createMailmanServer(listServer.getArchive(), listServer.getSMTP(), Duration.ZERO);
 984             var mailmanList = mailmanServer.getList(listAddress.address());
 985             var conversations = mailmanList.conversations(Duration.ofDays(1));
 986             assertEquals(1, conversations.size());
 987             var mail = conversations.get(0).first();
 988             assertEquals(&quot;RFR: This is a pull request&quot;, mail.subject());
 989             assertEquals(10, conversations.get(0).allMessages().size());
 990 
 991             // There should be four separate threads
 992             var thread1 = conversations.get(0).replies(mail).get(0);
 993             assertEquals(2, thread1.body().split(&quot;^On.*wrote:&quot;).length);
 994             assertEquals(2, thread1.body().split(&quot;&gt; This is now ready&quot;).length, thread1.body());
 995             assertEquals(&quot;RFR: This is a pull request&quot;, thread1.subject());
 996             assertTrue(thread1.body().contains(&quot;Review comment\n\n&quot;), thread1.body());
 997             assertFalse(thread1.body().contains(&quot;Another review comment&quot;), thread1.body());
 998             var thread1reply1 = conversations.get(0).replies(thread1).get(0);
 999             assertTrue(thread1reply1.body().contains(&quot;I agree&quot;));
1000             assertEquals(noreplyAddress(archive), thread1reply1.author().address());
1001             assertEquals(archive.forge().currentUser().fullName(), thread1reply1.author().fullName().orElseThrow());
1002             var thread1reply2 = conversations.get(0).replies(thread1reply1).get(0);
1003             assertTrue(thread1reply2.body().contains(&quot;Great&quot;));
1004             assertEquals(&quot;integrationreviewer1@openjdk.java.net&quot;, thread1reply2.author().address());
1005             assertEquals(&quot;Generated Reviewer 1&quot;, thread1reply2.author().fullName().orElseThrow());
1006 
1007             var thread2 = conversations.get(0).replies(mail).get(1);
1008             assertEquals(2, thread2.body().split(&quot;^On.*wrote:&quot;).length);
1009             assertEquals(2, thread2.body().split(&quot;&gt; This is now ready&quot;).length, thread2.body());
1010             assertEquals(&quot;RFR: This is a pull request&quot;, thread2.subject());
1011             assertFalse(thread2.body().contains(&quot;Review comment\n\n&quot;), thread2.body());
1012             assertTrue(thread2.body().contains(&quot;Another review comment&quot;), thread2.body());
1013             var thread2reply1 = conversations.get(0).replies(thread2).get(0);
1014             assertTrue(thread2reply1.body().contains(&quot;Sounds good&quot;));
1015             var thread2reply2 = conversations.get(0).replies(thread2reply1).get(0);
1016             assertTrue(thread2reply2.body().contains(&quot;Thanks&quot;));
1017 
1018             var replies = conversations.get(0).replies(mail);
1019             var thread3 = replies.get(2);
1020             assertEquals(&quot;RFR: This is a pull request&quot;, thread3.subject());
1021             var thread4 = replies.get(3);
1022             assertEquals(&quot;RFR: This is a pull request&quot;, thread4.subject());
1023             assertTrue(thread4.body().contains(&quot;Looks fine&quot;));
1024             assertTrue(thread4.body().contains(&quot;The final review comment&quot;));
1025             assertTrue(thread4.body().contains(&quot;Marked as reviewed by integrationreviewer1 (Reviewer)&quot;));
1026         }
1027     }
1028 
1029     @Test
1030     void commentThreadingSeparated(TestInfo testInfo) throws IOException {
1031         try (var credentials = new HostCredentials(testInfo);
1032              var tempFolder = new TemporaryDirectory();
1033              var archiveFolder = new TemporaryDirectory();
1034              var listServer = new TestMailmanServer();
1035              var webrevServer = new TestWebrevServer()) {
1036             var author = credentials.getHostedRepository();
1037             var reviewer = credentials.getHostedRepository();
1038             var archive = credentials.getHostedRepository();
1039             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
1040             var censusBuilder = credentials.getCensusBuilder()
1041                                            .addReviewer(reviewer.forge().currentUser().id())
1042                                            .addAuthor(author.forge().currentUser().id());
1043             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
1044             var mlBot = MailingListBridgeBot.newBuilder()
1045                                             .from(from)
1046                                             .repo(author)
1047                                             .archive(archive)
1048                                             .censusRepo(censusBuilder.build())
1049                                             .list(listAddress)
1050                                             .listArchive(listServer.getArchive())
1051                                             .smtpServer(listServer.getSMTP())
1052                                             .webrevStorageRepository(archive)
1053                                             .webrevStorageRef(&quot;webrev&quot;)
1054                                             .webrevStorageBase(Path.of(&quot;test&quot;))
1055                                             .webrevStorageBaseUri(webrevServer.uri())
1056                                             .issueTracker(URIBuilder.base(&quot;http://issues.test/browse/&quot;).build())
1057                                             .build();
1058 
1059             // Populate the projects repository
1060             var reviewFile = Path.of(&quot;reviewfile.txt&quot;);
1061             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType(), reviewFile);
1062             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
1063             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
1064             localRepo.push(masterHash, archive.url(), &quot;webrev&quot;, true);
1065 
1066             // Make a change with a corresponding PR
1067             var editHash = CheckableRepository.appendAndCommit(localRepo);
1068             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
1069             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
1070             pr.setBody(&quot;This is now ready&quot;);
1071             TestBotRunner.runPeriodicItems(mlBot);
1072             listServer.processIncoming();
1073 
1074             // Make two file specific comments
1075             var reviewPr = reviewer.pullRequest(pr.id());
1076             var comment1 = reviewPr.addReviewComment(masterHash, editHash, reviewFile.toString(), 2, &quot;Review comment&quot;);
1077             var comment2 = reviewPr.addReviewComment(masterHash, editHash, reviewFile.toString(), 2, &quot;Another review comment&quot;);
1078             TestBotRunner.runPeriodicItems(mlBot);
1079             listServer.processIncoming();
1080 
1081             pr.addReviewCommentReply(comment1, &quot;I agree&quot;);
1082             pr.addReviewCommentReply(comment2, &quot;I don&#39;t agree&quot;);
1083             TestBotRunner.runPeriodicItems(mlBot);
1084             listServer.processIncoming();
1085 
1086             // Sanity check the archive
1087             Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);
1088             assertEquals(2, archiveContainsCount(archiveFolder.path(), &quot;^On.*wrote:&quot;));
1089         }
1090     }
1091 
1092     @Test
1093     void commentWithMention(TestInfo testInfo) throws IOException {
1094         try (var credentials = new HostCredentials(testInfo);
1095              var tempFolder = new TemporaryDirectory();
1096              var archiveFolder = new TemporaryDirectory();
1097              var listServer = new TestMailmanServer();
1098              var webrevServer = new TestWebrevServer()) {
1099             var author = credentials.getHostedRepository();
1100             var reviewer = credentials.getHostedRepository();
1101             var archive = credentials.getHostedRepository();
1102             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
1103             var censusBuilder = credentials.getCensusBuilder()
1104                                            .addReviewer(reviewer.forge().currentUser().id())
1105                                            .addAuthor(author.forge().currentUser().id());
1106             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
1107             var mlBot = MailingListBridgeBot.newBuilder()
1108                                             .from(from)
1109                                             .repo(author)
1110                                             .archive(archive)
1111                                             .censusRepo(censusBuilder.build())
1112                                             .list(listAddress)
1113                                             .listArchive(listServer.getArchive())
1114                                             .smtpServer(listServer.getSMTP())
1115                                             .webrevStorageRepository(archive)
1116                                             .webrevStorageRef(&quot;webrev&quot;)
1117                                             .webrevStorageBase(Path.of(&quot;test&quot;))
1118                                             .webrevStorageBaseUri(webrevServer.uri())
1119                                             .issueTracker(URIBuilder.base(&quot;http://issues.test/browse/&quot;).build())
1120                                             .build();
1121 
1122             // Populate the projects repository
1123             var reviewFile = Path.of(&quot;reviewfile.txt&quot;);
1124             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType(), reviewFile);
1125             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
1126             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
1127             localRepo.push(masterHash, archive.url(), &quot;webrev&quot;, true);
1128 
1129             // Make a change with a corresponding PR
1130             var editHash = CheckableRepository.appendAndCommit(localRepo);
1131             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
1132             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
1133             pr.setBody(&quot;This is now ready&quot;);
1134             TestBotRunner.runPeriodicItems(mlBot);
1135             listServer.processIncoming();
1136 
1137             // Make two comments from different authors
1138             var reviewPr = reviewer.pullRequest(pr.id());
1139             reviewPr.addComment(&quot;First comment&quot;);
1140             pr.addComment(&quot;Second comment&quot;);
1141 
1142             TestBotRunner.runPeriodicItems(mlBot);
1143             listServer.processIncoming();
1144 
1145             pr.addComment(&quot;@&quot; + reviewer.forge().currentUser().userName() + &quot; reply to first&quot;);
1146             TestBotRunner.runPeriodicItems(mlBot);
1147             listServer.processIncoming();
1148 
1149             // The first comment should be quoted more often than the second
1150             Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);
1151             assertEquals(3, archiveContainsCount(archiveFolder.path(), &quot;First comment&quot;));
1152             assertEquals(1, archiveContainsCount(archiveFolder.path(), &quot;Second comment&quot;));
1153         }
1154     }
1155 
1156     @Test
1157     void reviewCommentWithMention(TestInfo testInfo) throws IOException {
1158         try (var credentials = new HostCredentials(testInfo);
1159              var tempFolder = new TemporaryDirectory();
1160              var archiveFolder = new TemporaryDirectory();
1161              var listServer = new TestMailmanServer();
1162              var webrevServer = new TestWebrevServer()) {
1163             var author = credentials.getHostedRepository();
1164             var reviewer = credentials.getHostedRepository();
1165             var archive = credentials.getHostedRepository();
1166             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
1167             var censusBuilder = credentials.getCensusBuilder()
1168                                            .addReviewer(reviewer.forge().currentUser().id())
1169                                            .addAuthor(author.forge().currentUser().id());
1170             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
1171             var mlBot = MailingListBridgeBot.newBuilder()
1172                                             .from(from)
1173                                             .repo(author)
1174                                             .archive(archive)
1175                                             .censusRepo(censusBuilder.build())
1176                                             .list(listAddress)
1177                                             .listArchive(listServer.getArchive())
1178                                             .smtpServer(listServer.getSMTP())
1179                                             .webrevStorageRepository(archive)
1180                                             .webrevStorageRef(&quot;webrev&quot;)
1181                                             .webrevStorageBase(Path.of(&quot;test&quot;))
1182                                             .webrevStorageBaseUri(webrevServer.uri())
1183                                             .issueTracker(URIBuilder.base(&quot;http://issues.test/browse/&quot;).build())
1184                                             .build();
1185 
1186             // Populate the projects repository
1187             var reviewFile = Path.of(&quot;reviewfile.txt&quot;);
1188             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType(), reviewFile);
1189             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
1190             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
1191             localRepo.push(masterHash, archive.url(), &quot;webrev&quot;, true);
1192 
1193             // Make a change with a corresponding PR
1194             var editHash = CheckableRepository.appendAndCommit(localRepo);
1195             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
1196             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
1197             pr.setBody(&quot;This is now ready&quot;);
1198             TestBotRunner.runPeriodicItems(mlBot);
1199             listServer.processIncoming();
1200 
1201             // Make two review comments from different authors
1202             var reviewPr = reviewer.pullRequest(pr.id());
1203             var comment = reviewPr.addReviewComment(masterHash, editHash, reviewFile.toString(), 2, &quot;Review comment&quot;);
1204             reviewPr.addReviewCommentReply(comment, &quot;First review comment&quot;);
1205             pr.addReviewCommentReply(comment, &quot;Second review comment&quot;);
1206 
1207             TestBotRunner.runPeriodicItems(mlBot);
1208             listServer.processIncoming();
1209 
1210             pr.addReviewCommentReply(comment, &quot;@&quot; + reviewer.forge().currentUser().userName() + &quot; reply to first&quot;);
1211             TestBotRunner.runPeriodicItems(mlBot);
1212             listServer.processIncoming();
1213 
1214             // The first comment should be quoted more often than the second
1215             Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);
1216             assertEquals(3, archiveContainsCount(archiveFolder.path(), &quot;First review comment&quot;));
1217             assertEquals(1, archiveContainsCount(archiveFolder.path(), &quot;Second review comment&quot;));
1218         }
1219     }
1220 
1221     @Test
1222     void commentWithQuote(TestInfo testInfo) throws IOException {
1223         try (var credentials = new HostCredentials(testInfo);
1224              var tempFolder = new TemporaryDirectory();
1225              var archiveFolder = new TemporaryDirectory();
1226              var listServer = new TestMailmanServer();
1227              var webrevServer = new TestWebrevServer()) {
1228             var author = credentials.getHostedRepository();
1229             var reviewer = credentials.getHostedRepository();
1230             var archive = credentials.getHostedRepository();
1231             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
1232             var censusBuilder = credentials.getCensusBuilder()
1233                                            .addReviewer(reviewer.forge().currentUser().id())
1234                                            .addAuthor(author.forge().currentUser().id());
1235             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
1236             var mlBot = MailingListBridgeBot.newBuilder()
1237                                             .from(from)
1238                                             .repo(author)
1239                                             .archive(archive)
1240                                             .censusRepo(censusBuilder.build())
1241                                             .list(listAddress)
1242                                             .listArchive(listServer.getArchive())
1243                                             .smtpServer(listServer.getSMTP())
1244                                             .webrevStorageRepository(archive)
1245                                             .webrevStorageRef(&quot;webrev&quot;)
1246                                             .webrevStorageBase(Path.of(&quot;test&quot;))
1247                                             .webrevStorageBaseUri(webrevServer.uri())
1248                                             .issueTracker(URIBuilder.base(&quot;http://issues.test/browse/&quot;).build())
1249                                             .build();
1250 
1251             // Populate the projects repository
1252             var reviewFile = Path.of(&quot;reviewfile.txt&quot;);
1253             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType(), reviewFile);
1254             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
1255             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
1256             localRepo.push(masterHash, archive.url(), &quot;webrev&quot;, true);
1257 
1258             // Make a change with a corresponding PR
1259             var editHash = CheckableRepository.appendAndCommit(localRepo);
1260             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
1261             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
1262             pr.setBody(&quot;This is now ready&quot;);
1263             TestBotRunner.runPeriodicItems(mlBot);
1264             listServer.processIncoming();
1265 
1266             // Make two comments from different authors
1267             var reviewPr = reviewer.pullRequest(pr.id());
1268             reviewPr.addComment(&quot;First comment\nsecond line&quot;);
1269             pr.addComment(&quot;Second comment\nfourth line&quot;);
1270 
1271             TestBotRunner.runPeriodicItems(mlBot);
1272             listServer.processIncoming();
1273 
1274             pr.addComment(&quot;&gt;First comm\n\nreply to first&quot;);
1275             TestBotRunner.runPeriodicItems(mlBot);
1276             listServer.processIncoming();
1277 
1278             // The first comment should be quoted more often than the second
1279             Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);
1280             assertEquals(2, archiveContainsCount(archiveFolder.path(), &quot;First comment&quot;));
1281             assertEquals(3, archiveContainsCount(archiveFolder.path(), &quot;First comm&quot;));
1282             assertEquals(1, archiveContainsCount(archiveFolder.path(), &quot;Second comment&quot;));
1283         }
1284     }
1285 
1286     @Test
1287     void reviewContext(TestInfo testInfo) throws IOException {
1288         try (var credentials = new HostCredentials(testInfo);
1289              var tempFolder = new TemporaryDirectory();
1290              var archiveFolder = new TemporaryDirectory();
1291              var listServer = new TestMailmanServer();
1292              var webrevServer = new TestWebrevServer()) {
1293             var author = credentials.getHostedRepository();
1294             var archive = credentials.getHostedRepository();
1295             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
1296             var censusBuilder = credentials.getCensusBuilder()
1297                                            .addAuthor(author.forge().currentUser().id());
1298             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
1299             var mlBot = MailingListBridgeBot.newBuilder()
1300                                             .from(from)
1301                                             .repo(author)
1302                                             .archive(archive)
1303                                             .censusRepo(censusBuilder.build())
1304                                             .list(listAddress)
1305                                             .listArchive(listServer.getArchive())
1306                                             .smtpServer(listServer.getSMTP())
1307                                             .webrevStorageRepository(archive)
1308                                             .webrevStorageRef(&quot;webrev&quot;)
1309                                             .webrevStorageBase(Path.of(&quot;test&quot;))
1310                                             .webrevStorageBaseUri(webrevServer.uri())
1311                                             .issueTracker(URIBuilder.base(&quot;http://issues.test/browse/&quot;).build())
1312                                             .build();
1313 
1314             // Populate the projects repository
1315             var reviewFile = Path.of(&quot;reviewfile.txt&quot;);
1316             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType(), reviewFile);
1317             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
1318             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
1319             localRepo.push(masterHash, archive.url(), &quot;webrev&quot;, true);
1320 
1321             // Make a change with a corresponding PR
1322             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;Line 1\nLine 2\nLine 3\nLine 4&quot;);
1323             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
1324             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
1325             pr.setBody(&quot;This is now ready&quot;);
1326             TestBotRunner.runPeriodicItems(mlBot);
1327             listServer.processIncoming();
1328 
1329             // Make a file specific comment
1330             pr.addReviewComment(masterHash, editHash, reviewFile.toString(), 2, &quot;Review comment&quot;);
1331 
1332             TestBotRunner.runPeriodicItems(mlBot);
1333             listServer.processIncoming();
1334 
1335             // The archive should only contain context around line 2
1336             Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);
1337             assertTrue(archiveContains(archiveFolder.path(), &quot;^&gt; 2: Line 1$&quot;));
1338             assertTrue(archiveContains(archiveFolder.path(), &quot;^&gt; 3: Line 2$&quot;));
1339             assertFalse(archiveContains(archiveFolder.path(), &quot;^&gt; 4: Line 3$&quot;));
1340         }
1341     }
1342 
1343     @Test
1344     void multipleReviewContexts(TestInfo testInfo) throws IOException {
1345         try (var credentials = new HostCredentials(testInfo);
1346              var tempFolder = new TemporaryDirectory();
1347              var archiveFolder = new TemporaryDirectory();
1348              var listServer = new TestMailmanServer();
1349              var webrevServer = new TestWebrevServer()) {
1350             var author = credentials.getHostedRepository();
1351             var archive = credentials.getHostedRepository();
1352             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
1353             var censusBuilder = credentials.getCensusBuilder()
1354                                            .addAuthor(author.forge().currentUser().id());
1355             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
1356             var mlBot = MailingListBridgeBot.newBuilder()
1357                                             .from(from)
1358                                             .repo(author)
1359                                             .archive(archive)
1360                                             .censusRepo(censusBuilder.build())
1361                                             .list(listAddress)
1362                                             .listArchive(listServer.getArchive())
1363                                             .smtpServer(listServer.getSMTP())
1364                                             .webrevStorageRepository(archive)
1365                                             .webrevStorageRef(&quot;webrev&quot;)
1366                                             .webrevStorageBase(Path.of(&quot;test&quot;))
1367                                             .webrevStorageBaseUri(webrevServer.uri())
1368                                             .issueTracker(URIBuilder.base(&quot;http://issues.test/browse/&quot;).build())
1369                                             .build();
1370 
1371             // Populate the projects repository
1372             var reviewFile = Path.of(&quot;reviewfile.txt&quot;);
1373             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType(), reviewFile);
1374             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
1375             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
1376             localRepo.push(masterHash, archive.url(), &quot;webrev&quot;, true);
1377             var initialHash = CheckableRepository.appendAndCommit(localRepo,
1378                                                                   &quot;Line 0.1\nLine 0.2\nLine 0.3\nLine 0.4\n&quot; +
1379                                                                           &quot;Line 1\nLine 2\nLine 3\nLine 4\n&quot; +
1380                                                                           &quot;Line 5\nLine 6\nLine 7\nLine 8\n&quot; +
1381                                                                           &quot;Line 8.1\nLine 8.2\nLine 8.3\nLine 8.4\n&quot; +
1382                                                                           &quot;Line 9\nLine 10\nLine 11\nLine 12\n&quot; +
1383                                                                           &quot;Line 13\nLine 14\nLine 15\nLine 16\n&quot;);
1384             localRepo.push(initialHash, author.url(), &quot;master&quot;);
1385 
1386             // Make a change with a corresponding PR
1387             var current = Files.readString(localRepo.root().resolve(reviewFile), StandardCharsets.UTF_8);
1388             var updated = current.replaceAll(&quot;Line 2&quot;, &quot;Line 2 edit\nLine 2.5&quot;);
1389             updated = updated.replaceAll(&quot;Line 13&quot;, &quot;Line 12.5\nLine 13 edit&quot;);
1390             Files.writeString(localRepo.root().resolve(reviewFile), updated, StandardCharsets.UTF_8);
1391             var editHash = CheckableRepository.appendAndCommit(localRepo);
1392             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
1393             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
1394             pr.setBody(&quot;This is now ready&quot;);
1395             TestBotRunner.runPeriodicItems(mlBot);
1396             listServer.processIncoming();
1397 
1398             // Make file specific comments
1399             pr.addReviewComment(masterHash, editHash, reviewFile.toString(), 7, &quot;Review comment&quot;);
1400             pr.addReviewComment(masterHash, editHash, reviewFile.toString(), 24, &quot;Another review comment&quot;);
1401 
1402             TestBotRunner.runPeriodicItems(mlBot);
1403             listServer.processIncoming();
1404 
1405             // The archive should only contain context around line 2 and 20
1406             Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);
1407             assertTrue(archiveContains(archiveFolder.path(), &quot;reviewfile.txt line 7&quot;));
1408             assertTrue(archiveContains(archiveFolder.path(), &quot;^&gt; 6: Line 1$&quot;));
1409             assertTrue(archiveContains(archiveFolder.path(), &quot;^&gt; 7: Line 2 edit$&quot;));
1410             assertFalse(archiveContains(archiveFolder.path(), &quot;Line 3&quot;));
1411 
1412             assertTrue(archiveContains(archiveFolder.path(), &quot;reviewfile.txt line 24&quot;));
1413             assertTrue(archiveContains(archiveFolder.path(), &quot;^&gt; 23: Line 12.5$&quot;));
1414             assertTrue(archiveContains(archiveFolder.path(), &quot;^&gt; 24: Line 13 edit$&quot;));
1415             assertFalse(archiveContains(archiveFolder.path(), &quot;^Line 15&quot;));
1416         }
1417     }
1418 
1419     @Test
1420     void filterComments(TestInfo testInfo) throws IOException {
1421         try (var credentials = new HostCredentials(testInfo);
1422              var tempFolder = new TemporaryDirectory();
1423              var archiveFolder = new TemporaryDirectory();
1424              var listServer = new TestMailmanServer();
1425              var webrevServer = new TestWebrevServer()) {
1426             var author = credentials.getHostedRepository();
1427             var archive = credentials.getHostedRepository();
1428             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
1429             var censusBuilder = credentials.getCensusBuilder()
1430                                            .addAuthor(author.forge().currentUser().id());
1431             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
1432             var mlBot = MailingListBridgeBot.newBuilder()
1433                                             .from(from)
1434                                             .repo(author)
1435                                             .archive(archive)
1436                                             .censusRepo(censusBuilder.build())
1437                                             .list(listAddress)
1438                                             .listArchive(listServer.getArchive())
1439                                             .smtpServer(listServer.getSMTP())
1440                                             .webrevStorageRepository(archive)
1441                                             .webrevStorageRef(&quot;webrev&quot;)
1442                                             .webrevStorageBase(Path.of(&quot;test&quot;))
1443                                             .webrevStorageBaseUri(webrevServer.uri())
1444                                             .issueTracker(URIBuilder.base(&quot;http://issues.test/browse/&quot;).build())
1445                                             .build();
1446 
1447             // Populate the projects repository
1448             var reviewFile = Path.of(&quot;reviewfile.txt&quot;);
1449             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType(), reviewFile);
1450             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
1451             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
1452             localRepo.push(masterHash, archive.url(), &quot;webrev&quot;, true);
1453 
1454             // Make a change with a corresponding PR
1455             var editHash = CheckableRepository.appendAndCommit(localRepo);
1456             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
1457             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
1458             pr.setBody(&quot;This is now ready\n&lt;!-- this is a comment --&gt;\nAnd this is not\n&quot; +
1459                                &quot;&lt;!-- Anything below this marker will be hidden --&gt;\nStatus stuff&quot;);
1460 
1461             // Make a bunch of comments
1462             pr.addComment(&quot;Plain comment\n&lt;!-- this is a comment --&gt;&quot;);
1463             pr.addReviewComment(masterHash, editHash, reviewFile.toString(), 2, &quot;Review comment &lt;!-- this is a comment --&gt;\n&quot;);
1464             pr.addComment(&quot;/integrate stuff&quot;);
1465             TestBotRunner.runPeriodicItems(mlBot);
1466 
1467             // Run an archive pass
1468             TestBotRunner.runPeriodicItems(mlBot);
1469 
1470             // The archive should not contain the comment
1471             Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);
1472             assertTrue(archiveContains(archiveFolder.path(), &quot;This is now ready&quot;));
1473             assertFalse(archiveContains(archiveFolder.path(), &quot;this is a comment&quot;));
1474             assertFalse(archiveContains(archiveFolder.path(), &quot;Status stuff&quot;));
1475             assertTrue(archiveContains(archiveFolder.path(), &quot;And this is not&quot;));
1476             assertFalse(archiveContains(archiveFolder.path(), &quot;&lt;!--&quot;));
1477             assertFalse(archiveContains(archiveFolder.path(), &quot;--&gt;&quot;));
1478             assertTrue(archiveContains(archiveFolder.path(), &quot;Plain comment&quot;));
1479             assertTrue(archiveContains(archiveFolder.path(), &quot;Review comment&quot;));
1480             assertFalse(archiveContains(archiveFolder.path(), &quot;/integrate&quot;));
1481         }
1482     }
1483 
1484     @Test
1485     void incrementalChanges(TestInfo testInfo) throws IOException {
1486         try (var credentials = new HostCredentials(testInfo);
1487              var tempFolder = new TemporaryDirectory();
1488              var archiveFolder = new TemporaryDirectory();
1489              var listServer = new TestMailmanServer();
1490              var webrevServer = new TestWebrevServer()) {
1491             var author = credentials.getHostedRepository();
1492             var archive = credentials.getHostedRepository();
1493             var commenter = credentials.getHostedRepository();
1494             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
1495             var censusBuilder = credentials.getCensusBuilder()
1496                                            .addAuthor(author.forge().currentUser().id());
1497             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
1498             var mlBot = MailingListBridgeBot.newBuilder()
1499                                             .from(from)
1500                                             .repo(author)
1501                                             .archive(archive)
1502                                             .censusRepo(censusBuilder.build())
1503                                             .list(listAddress)
1504                                             .listArchive(listServer.getArchive())
1505                                             .smtpServer(listServer.getSMTP())
1506                                             .webrevStorageRepository(archive)
1507                                             .webrevStorageRef(&quot;webrev&quot;)
1508                                             .webrevStorageBase(Path.of(&quot;test&quot;))
1509                                             .webrevStorageBaseUri(webrevServer.uri())
1510                                             .issueTracker(URIBuilder.base(&quot;http://issues.test/browse/&quot;).build())
1511                                             .build();
1512 
1513             // Populate the projects repository
1514             var reviewFile = Path.of(&quot;reviewfile.txt&quot;);
1515             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType(), reviewFile);
1516             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
1517             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
1518             localRepo.push(masterHash, archive.url(), &quot;webrev&quot;, true);
1519 
1520             // Make a change with a corresponding PR
1521             var editHash = CheckableRepository.appendAndCommit(localRepo);
1522             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
1523             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
1524             pr.setBody(&quot;This is now ready&quot;);
1525 
1526             // Run an archive pass
1527             TestBotRunner.runPeriodicItems(mlBot);
1528             listServer.processIncoming();
1529 
1530             var nextHash = CheckableRepository.appendAndCommit(localRepo, &quot;Yet one more line&quot;, &quot;Fixing&quot;);
1531             localRepo.push(nextHash, author.url(), &quot;edit&quot;);
1532 
1533             // Make sure that the push registered
1534             var lastHeadHash = pr.headHash();
1535             var refreshCount = 0;
1536             do {
1537                 pr = author.pullRequest(pr.id());
1538                 if (refreshCount++ &gt; 100) {
1539                     fail(&quot;The PR did not update after the new push&quot;);
1540                 }
1541             } while (pr.headHash().equals(lastHeadHash));
1542 
1543             // Run another archive pass
1544             TestBotRunner.runPeriodicItems(mlBot);
1545             TestBotRunner.runPeriodicItems(mlBot);
1546             TestBotRunner.runPeriodicItems(mlBot);
1547             listServer.processIncoming();
1548 
1549             // The archive should reference the updated push
1550             Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);
1551             assertTrue(archiveContains(archiveFolder.path(), &quot;has updated the pull request incrementally&quot;));
1552             assertTrue(archiveContains(archiveFolder.path(), &quot;full.*/&quot; + pr.id() + &quot;/webrev.01&quot;));
1553             assertTrue(archiveContains(archiveFolder.path(), &quot;inc.*/&quot; + pr.id() + &quot;/webrev.00-01&quot;));
1554             assertTrue(archiveContains(archiveFolder.path(), &quot;Patch&quot;));
1555             assertTrue(archiveContains(archiveFolder.path(), &quot;Fetch&quot;));
1556             assertTrue(archiveContains(archiveFolder.path(), &quot;Fixing&quot;));
1557 
1558             // The webrev comment should be updated
1559             var comments = pr.comments();
1560             var webrevComments = comments.stream()
1561                                          .filter(comment -&gt; comment.author().equals(author.forge().currentUser()))
1562                                          .filter(comment -&gt; comment.body().contains(&quot;webrev&quot;))
1563                                          .filter(comment -&gt; comment.body().contains(&quot;Full&quot;))
1564                                          .filter(comment -&gt; comment.body().contains(&quot;Incremental&quot;))
1565                                          .filter(comment -&gt; comment.body().contains(nextHash.hex()))
1566                                          .filter(comment -&gt; comment.body().contains(editHash.hex()))
1567                                          .collect(Collectors.toList());
1568             assertEquals(1, webrevComments.size());
1569 
1570             // Check that sender address is set properly
1571             var mailmanServer = MailingListServerFactory.createMailmanServer(listServer.getArchive(), listServer.getSMTP(), Duration.ZERO);
1572             var mailmanList = mailmanServer.getList(listAddress.address());
1573             var conversations = mailmanList.conversations(Duration.ofDays(1));
1574             assertEquals(1, conversations.size());
1575             for (var newMail : conversations.get(0).allMessages()) {
1576                 assertEquals(noreplyAddress(archive), newMail.author().address());
1577                 assertEquals(listAddress, newMail.sender());
1578             }
1579 
1580             // Add a comment
1581             var commenterPr = commenter.pullRequest(pr.id());
1582             commenterPr.addReviewComment(masterHash, nextHash, reviewFile.toString(), 2, &quot;Review comment&quot;);
1583             TestBotRunner.runPeriodicItems(mlBot);
1584             listServer.processIncoming();
1585 
1586             // Ensure that additional updates are only reported once
1587             for (int i = 0; i &lt; 3; ++i) {
1588                 var anotherHash = CheckableRepository.appendAndCommit(localRepo, &quot;Another line&quot;, &quot;Fixing&quot;);
1589                 localRepo.push(anotherHash, author.url(), &quot;edit&quot;);
1590 
1591                 // Make sure that the push registered
1592                 lastHeadHash = pr.headHash();
1593                 refreshCount = 0;
1594                 do {
1595                     pr = author.pullRequest(pr.id());
1596                     if (refreshCount++ &gt; 100) {
1597                         fail(&quot;The PR did not update after the new push&quot;);
1598                     }
1599                 } while (pr.headHash().equals(lastHeadHash));
1600 
1601                 TestBotRunner.runPeriodicItems(mlBot);
1602                 TestBotRunner.runPeriodicItems(mlBot);
1603                 listServer.processIncoming();
1604             }
1605             var updatedConversations = mailmanList.conversations(Duration.ofDays(1));
1606             assertEquals(1, updatedConversations.size());
1607             var conversation = updatedConversations.get(0);
1608             assertEquals(6, conversation.allMessages().size());
1609             assertEquals(&quot;RFR: This is a pull request [v2]&quot;, conversation.allMessages().get(1).subject());
1610             assertEquals(&quot;RFR: This is a pull request [v2]&quot;, conversation.allMessages().get(2).subject(), conversation.allMessages().get(2).toString());
1611             assertEquals(&quot;RFR: This is a pull request [v5]&quot;, conversation.allMessages().get(5).subject());
1612         }
1613     }
1614 
1615     @Test
1616     void rebased(TestInfo testInfo) throws IOException {
1617         try (var credentials = new HostCredentials(testInfo);
1618              var tempFolder = new TemporaryDirectory();
1619              var archiveFolder = new TemporaryDirectory();
1620              var listServer = new TestMailmanServer();
1621              var webrevServer = new TestWebrevServer()) {
1622             var author = credentials.getHostedRepository();
1623             var archive = credentials.getHostedRepository();
1624             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
1625             var censusBuilder = credentials.getCensusBuilder()
1626                                            .addAuthor(author.forge().currentUser().id());
1627             var sender = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
1628             var mlBot = MailingListBridgeBot.newBuilder()
1629                                             .from(sender)
1630                                             .repo(author)
1631                                             .archive(archive)
1632                                             .censusRepo(censusBuilder.build())
1633                                             .list(listAddress)
1634                                             .listArchive(listServer.getArchive())
1635                                             .smtpServer(listServer.getSMTP())
1636                                             .webrevStorageRepository(archive)
1637                                             .webrevStorageRef(&quot;webrev&quot;)
1638                                             .webrevStorageBase(Path.of(&quot;test&quot;))
1639                                             .webrevStorageBaseUri(webrevServer.uri())
1640                                             .issueTracker(URIBuilder.base(&quot;http://issues.test/browse/&quot;).build())
1641                                             .build();
1642 
1643             // Populate the projects repository
1644             var reviewFile = Path.of(&quot;reviewfile.txt&quot;);
1645             var localRepo = CheckableRepository.init(tempFolder.path().resolve(&quot;first&quot;), author.repositoryType(), reviewFile);
1646             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
1647             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
1648             localRepo.push(masterHash, archive.url(), &quot;webrev&quot;, true);
1649 
1650             // Make a change with a corresponding PR
1651             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;A line&quot;, &quot;Original msg&quot;);
1652             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
1653             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
1654             pr.setBody(&quot;This is now ready&quot;);
1655 
1656             // Run an archive pass
1657             TestBotRunner.runPeriodicItems(mlBot);
1658             listServer.processIncoming();
1659 
1660             var newLocalRepo = Repository.materialize(tempFolder.path().resolve(&quot;second&quot;), author.url(), &quot;master&quot;);
1661             var newEditHash = CheckableRepository.appendAndCommit(newLocalRepo, &quot;Another line&quot;, &quot;Replaced msg&quot;);
1662             newLocalRepo.push(newEditHash, author.url(), &quot;edit&quot;, true);
1663 
1664             // Make sure that the push registered
1665             var lastHeadHash = pr.headHash();
1666             var refreshCount = 0;
1667             do {
1668                 pr = author.pullRequest(pr.id());
1669                 if (refreshCount++ &gt; 100) {
1670                     fail(&quot;The PR did not update after the new push&quot;);
1671                 }
1672             } while (pr.headHash().equals(lastHeadHash));
1673 
1674             // Run another archive pass
1675             TestBotRunner.runPeriodicItems(mlBot);
1676             listServer.processIncoming();
1677 
1678             // The archive should reference the rebased push
1679             Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);
1680             assertTrue(archiveContains(archiveFolder.path(), &quot;has updated the pull request with a new target base&quot;));
1681             assertTrue(archiveContains(archiveFolder.path(), pr.id() + &quot;/webrev.01&quot;));
1682             assertFalse(archiveContains(archiveFolder.path(), &quot;Incremental&quot;));
1683             assertTrue(archiveContains(archiveFolder.path(), &quot;Patch&quot;));
1684             assertTrue(archiveContains(archiveFolder.path(), &quot;Fetch&quot;));
1685             assertTrue(archiveContains(archiveFolder.path(), &quot;Original msg&quot;));
1686             assertTrue(archiveContains(archiveFolder.path(), &quot;Replaced msg&quot;));
1687 
1688             // The webrev comment should be updated
1689             var comments = pr.comments();
1690             var webrevComments = comments.stream()
1691                                          .filter(comment -&gt; comment.author().equals(author.forge().currentUser()))
1692                                          .filter(comment -&gt; comment.body().contains(&quot;webrev&quot;))
1693                                          .filter(comment -&gt; comment.body().contains(newEditHash.hex()))
1694                                          .collect(Collectors.toList());
1695             assertEquals(1, webrevComments.size());
1696 
1697             // Check that sender address is set properly
1698             var mailmanServer = MailingListServerFactory.createMailmanServer(listServer.getArchive(), listServer.getSMTP(), Duration.ZERO);
1699             var mailmanList = mailmanServer.getList(listAddress.address());
1700             var conversations = mailmanList.conversations(Duration.ofDays(1));
1701             assertEquals(1, conversations.size());
1702             for (var newMail : conversations.get(0).allMessages()) {
1703                 assertEquals(noreplyAddress(archive), newMail.author().address());
1704                 assertEquals(listAddress, newMail.sender());
1705                 assertFalse(newMail.hasHeader(&quot;PR-Head-Hash&quot;));
1706             }
1707             assertEquals(&quot;RFR: This is a pull request [v2]&quot;, conversations.get(0).allMessages().get(1).subject());
1708         }
1709     }
1710 
1711     @Test
1712     void incrementalAfterRebase(TestInfo testInfo) throws IOException {
1713         try (var credentials = new HostCredentials(testInfo);
1714              var tempFolder = new TemporaryDirectory();
1715              var archiveFolder = new TemporaryDirectory();
1716              var listServer = new TestMailmanServer();
1717              var webrevServer = new TestWebrevServer()) {
1718             var author = credentials.getHostedRepository();
1719             var archive = credentials.getHostedRepository();
1720             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
1721             var censusBuilder = credentials.getCensusBuilder()
1722                                            .addAuthor(author.forge().currentUser().id());
1723             var sender = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
1724             var mlBot = MailingListBridgeBot.newBuilder()
1725                                             .from(sender)
1726                                             .repo(author)
1727                                             .archive(archive)
1728                                             .archiveRef(&quot;archive&quot;)
1729                                             .censusRepo(censusBuilder.build())
1730                                             .list(listAddress)
1731                                             .listArchive(listServer.getArchive())
1732                                             .smtpServer(listServer.getSMTP())
1733                                             .webrevStorageRepository(archive)
1734                                             .webrevStorageRef(&quot;webrev&quot;)
1735                                             .webrevStorageBase(Path.of(&quot;test&quot;))
1736                                             .webrevStorageBaseUri(webrevServer.uri())
1737                                             .issueTracker(URIBuilder.base(&quot;http://issues.test/browse/&quot;).build())
1738                                             .build();
1739 
1740             // Populate the projects repository
1741             var reviewFile = Path.of(&quot;reviewfile.txt&quot;);
1742             var localRepo = CheckableRepository.init(tempFolder.path().resolve(&quot;first&quot;), author.repositoryType(), reviewFile);
1743             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
1744             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
1745             localRepo.push(masterHash, archive.url(), &quot;webrev&quot;, true);
1746             localRepo.push(masterHash, archive.url(), &quot;archive&quot;, true);
1747 
1748             // Make a change with a corresponding PR
1749             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;A line&quot;, &quot;Original msg&quot;);
1750             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
1751             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
1752             pr.setBody(&quot;This is now ready&quot;);
1753 
1754             // Run an archive pass
1755             TestBotRunner.runPeriodicItems(mlBot);
1756             listServer.processIncoming();
1757 
1758             // Push more stuff to master
1759             localRepo.checkout(masterHash, true);
1760             var unrelatedFile = localRepo.root().resolve(&quot;unrelated.txt&quot;);
1761             Files.writeString(unrelatedFile, &quot;Other things happens in master&quot;);
1762             localRepo.add(unrelatedFile);
1763             var newMasterHash = localRepo.commit(&quot;Unrelated change&quot;, &quot;duke&quot;, &quot;duke@openjdk.org&quot;);
1764             localRepo.push(newMasterHash, author.url(), &quot;master&quot;);
1765 
1766             // And more stuff to the pr branch
1767             localRepo.checkout(editHash, true);
1768             CheckableRepository.appendAndCommit(localRepo, &quot;Another line&quot;, &quot;More updates&quot;);
1769 
1770             // Merge master
1771             localRepo.merge(newMasterHash);
1772             var newEditHash = localRepo.commit(&quot;Latest changes from master&quot;, &quot;duke&quot;, &quot;duke@openjdk.org&quot;);
1773             localRepo.push(newEditHash, author.url(), &quot;edit&quot;);
1774 
1775             // Make sure that the push registered
1776             var lastHeadHash = pr.headHash();
1777             var refreshCount = 0;
1778             do {
1779                 pr = author.pullRequest(pr.id());
1780                 if (refreshCount++ &gt; 100) {
1781                     fail(&quot;The PR did not update after the new push&quot;);
1782                 }
1783             } while (pr.headHash().equals(lastHeadHash));
1784 
1785             // Run another archive pass
1786             TestBotRunner.runPeriodicItems(mlBot);
1787             listServer.processIncoming();
1788 
1789             // The archive should reference the rebased push
1790             Repository.materialize(archiveFolder.path(), archive.url(), &quot;archive&quot;);
1791             assertTrue(archiveContains(archiveFolder.path(), &quot;has updated the pull request with a new target base&quot;));
1792             assertTrue(archiveContains(archiveFolder.path(), &quot;excludes&quot;));
1793             assertTrue(archiveContains(archiveFolder.path(), pr.id() + &quot;/webrev.01&quot;));
1794             assertTrue(archiveContains(archiveFolder.path(), pr.id() + &quot;/webrev.00-01&quot;));
1795             assertTrue(archiveContains(archiveFolder.path(), &quot;Original msg&quot;));
1796             assertTrue(archiveContains(archiveFolder.path(), &quot;More updates&quot;));
1797         }
1798     }
1799 
1800     @Test
1801     void mergeWebrev(TestInfo testInfo) throws IOException {
1802         try (var credentials = new HostCredentials(testInfo);
1803              var tempFolder = new TemporaryDirectory();
1804              var archiveFolder = new TemporaryDirectory();
1805              var listServer = new TestMailmanServer();
1806              var webrevServer = new TestWebrevServer()) {
1807             var author = credentials.getHostedRepository();
1808             var archive = credentials.getHostedRepository();
1809             var commenter = credentials.getHostedRepository();
1810             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
1811             var censusBuilder = credentials.getCensusBuilder()
1812                                            .addAuthor(author.forge().currentUser().id());
1813             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
1814             var mlBot = MailingListBridgeBot.newBuilder()
1815                                             .from(from)
1816                                             .repo(author)
1817                                             .archive(archive)
1818                                             .archiveRef(&quot;archive&quot;)
1819                                             .censusRepo(censusBuilder.build())
1820                                             .list(listAddress)
1821                                             .listArchive(listServer.getArchive())
1822                                             .smtpServer(listServer.getSMTP())
1823                                             .webrevStorageRepository(archive)
1824                                             .webrevStorageRef(&quot;webrev&quot;)
1825                                             .webrevStorageBase(Path.of(&quot;test&quot;))
1826                                             .webrevStorageBaseUri(webrevServer.uri())
1827                                             .issueTracker(URIBuilder.base(&quot;http://issues.test/browse/&quot;).build())
1828                                             .build();
1829 
1830             // Populate the projects repository
1831             var reviewFile = Path.of(&quot;reviewfile.txt&quot;);
1832             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType(), reviewFile);
1833             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
1834             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
1835             localRepo.push(masterHash, archive.url(), &quot;archive&quot;, true);
1836             localRepo.push(masterHash, archive.url(), &quot;webrev&quot;, true);
1837 
1838             // Create a diverging branch
1839             var editOnlyFile = Path.of(&quot;editonly.txt&quot;);
1840             Files.writeString(localRepo.root().resolve(editOnlyFile), &quot;Only added in the edit&quot;);
1841             localRepo.add(editOnlyFile);
1842             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;Edited&quot;);
1843             localRepo.push(editHash, author.url(), &quot;edit&quot;);
1844 
1845             // Make conflicting changes in the target
1846             localRepo.checkout(masterHash, true);
1847             var masterOnlyFile = Path.of(&quot;masteronly.txt&quot;);
1848             Files.writeString(localRepo.root().resolve(masterOnlyFile), &quot;Only added in master&quot;);
1849             localRepo.add(masterOnlyFile);
1850             var updatedMasterHash = CheckableRepository.appendAndCommit(localRepo, &quot;Master change&quot;);
1851             localRepo.push(updatedMasterHash, author.url(), &quot;master&quot;);
1852 
1853             // Perform the merge - resolve conflicts in our favor
1854             localRepo.merge(editHash, &quot;ours&quot;);
1855             localRepo.commit(&quot;Merged edit&quot;, &quot;duke&quot;, &quot;duke@openjdk.java.net&quot;);
1856             var mergeOnlyFile = Path.of(&quot;mergeonly.txt&quot;);
1857             Files.writeString(localRepo.root().resolve(mergeOnlyFile), &quot;Only added in the merge&quot;);
1858             localRepo.add(mergeOnlyFile);
1859             Files.writeString(localRepo.root().resolve(reviewFile), &quot;Overwriting the conflict resolution&quot;);
1860             localRepo.add(reviewFile);
1861             var appendedCommit = localRepo.amend(&quot;Updated merge commit&quot;, &quot;duke&quot;, &quot;duke@openjdk.java.net&quot;);
1862             localRepo.push(appendedCommit, author.url(), &quot;merge_of_edit&quot;, true);
1863 
1864             // Make a merge PR
1865             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;merge_of_edit&quot;, &quot;Merge edit&quot;);
1866             pr.setBody(&quot;This is now ready&quot;);
1867 
1868             // Run an archive pass
1869             TestBotRunner.runPeriodicItems(mlBot);
1870             listServer.processIncoming();
1871 
1872             // The archive should contain a merge style webrev
1873             Repository.materialize(archiveFolder.path(), archive.url(), &quot;archive&quot;);
1874             assertTrue(archiveContains(archiveFolder.path(), &quot;The webrevs contain the adjustments done while merging with regards to each parent branch:&quot;));
1875             assertTrue(archiveContains(archiveFolder.path(), pr.id() + &quot;/webrev.00.0&quot;));
1876             assertTrue(archiveContains(archiveFolder.path(), &quot;3 lines in 2 files changed: 1 ins; 1 del; 1 mod&quot;));
1877 
1878             // The PR should contain a webrev comment
1879             assertEquals(1, pr.comments().size());
1880             var webrevComment = pr.comments().get(0);
1881             assertTrue(webrevComment.body().contains(&quot;Merge target&quot;));
1882             assertTrue(webrevComment.body().contains(&quot;Merge source&quot;));
1883         }
1884     }
1885 
1886     @Test
1887     void mergeWebrevConflict(TestInfo testInfo) throws IOException {
1888         try (var credentials = new HostCredentials(testInfo);
1889              var tempFolder = new TemporaryDirectory();
1890              var archiveFolder = new TemporaryDirectory();
1891              var listServer = new TestMailmanServer();
1892              var webrevServer = new TestWebrevServer()) {
1893             var author = credentials.getHostedRepository();
1894             var archive = credentials.getHostedRepository();
1895             var commenter = credentials.getHostedRepository();
1896             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
1897             var censusBuilder = credentials.getCensusBuilder()
1898                                            .addAuthor(author.forge().currentUser().id());
1899             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
1900             var mlBot = MailingListBridgeBot.newBuilder()
1901                                             .from(from)
1902                                             .repo(author)
1903                                             .archive(archive)
1904                                             .archiveRef(&quot;archive&quot;)
1905                                             .censusRepo(censusBuilder.build())
1906                                             .list(listAddress)
1907                                             .listArchive(listServer.getArchive())
1908                                             .smtpServer(listServer.getSMTP())
1909                                             .webrevStorageRepository(archive)
1910                                             .webrevStorageRef(&quot;webrev&quot;)
1911                                             .webrevStorageBase(Path.of(&quot;test&quot;))
1912                                             .webrevStorageBaseUri(webrevServer.uri())
1913                                             .issueTracker(URIBuilder.base(&quot;http://issues.test/browse/&quot;).build())
1914                                             .build();
1915 
1916             // Populate the projects repository
1917             var reviewFile = Path.of(&quot;reviewfile.txt&quot;);
1918             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType(), reviewFile);
1919             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
1920             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
1921             localRepo.push(masterHash, archive.url(), &quot;archive&quot;, true);
1922             localRepo.push(masterHash, archive.url(), &quot;webrev&quot;, true);
1923 
1924             // Create a merge
1925             var editOnlyFile = Path.of(&quot;editonly.txt&quot;);
1926             Files.writeString(localRepo.root().resolve(editOnlyFile), &quot;Only added in the edit&quot;);
1927             localRepo.add(editOnlyFile);
1928             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;Edited&quot;);
1929             localRepo.checkout(masterHash, true);
1930             var masterOnlyFile = Path.of(&quot;masteronly.txt&quot;);
1931             Files.writeString(localRepo.root().resolve(masterOnlyFile), &quot;Only added in master&quot;);
1932             localRepo.add(masterOnlyFile);
1933             var updatedMasterHash = CheckableRepository.appendAndCommit(localRepo, &quot;Master change&quot;);
1934             localRepo.push(updatedMasterHash, author.url(), &quot;master&quot;);
1935             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
1936 
1937             // Make a merge PR
1938             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;Merge edit&quot;);
1939             pr.setBody(&quot;This is now ready&quot;);
1940 
1941             // Run an archive pass
1942             TestBotRunner.runPeriodicItems(mlBot);
1943             listServer.processIncoming();
1944 
1945             // The archive should contain a merge style webrev
1946             Repository.materialize(archiveFolder.path(), archive.url(), &quot;archive&quot;);
1947             assertTrue(archiveContains(archiveFolder.path(), &quot;The webrev contains the conflicts with master:&quot;));
1948             assertTrue(archiveContains(archiveFolder.path(), pr.id() + &quot;/webrev.00.conflicts&quot;));
1949             assertTrue(archiveContains(archiveFolder.path(), &quot;2 lines in 2 files changed: 2 ins; 0 del; 0 mod&quot;));
1950 
1951             // The PR should contain a webrev comment
1952             assertEquals(1, pr.comments().size());
1953             var webrevComment = pr.comments().get(0);
1954             assertTrue(webrevComment.body().contains(&quot;Merge conflicts&quot;));
1955         }
1956     }
1957 
1958     @Test
1959     void mergeWebrevNoConflict(TestInfo testInfo) throws IOException {
1960         try (var credentials = new HostCredentials(testInfo);
1961              var tempFolder = new TemporaryDirectory();
1962              var archiveFolder = new TemporaryDirectory();
1963              var listServer = new TestMailmanServer();
1964              var webrevServer = new TestWebrevServer()) {
1965             var author = credentials.getHostedRepository();
1966             var archive = credentials.getHostedRepository();
1967             var commenter = credentials.getHostedRepository();
1968             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
1969             var censusBuilder = credentials.getCensusBuilder()
1970                                            .addAuthor(author.forge().currentUser().id());
1971             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
1972             var mlBot = MailingListBridgeBot.newBuilder()
1973                                             .from(from)
1974                                             .repo(author)
1975                                             .archive(archive)
1976                                             .archiveRef(&quot;archive&quot;)
1977                                             .censusRepo(censusBuilder.build())
1978                                             .list(listAddress)
1979                                             .listArchive(listServer.getArchive())
1980                                             .smtpServer(listServer.getSMTP())
1981                                             .webrevStorageRepository(archive)
1982                                             .webrevStorageRef(&quot;webrev&quot;)
1983                                             .webrevStorageBase(Path.of(&quot;test&quot;))
1984                                             .webrevStorageBaseUri(webrevServer.uri())
1985                                             .issueTracker(URIBuilder.base(&quot;http://issues.test/browse/&quot;).build())
1986                                             .build();
1987 
1988             // Populate the projects repository
1989             var reviewFile = Path.of(&quot;reviewfile.txt&quot;);
1990             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType(), reviewFile);
1991             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
1992             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
1993             localRepo.push(masterHash, archive.url(), &quot;archive&quot;, true);
1994             localRepo.push(masterHash, archive.url(), &quot;webrev&quot;, true);
1995 
1996             // Create a merge
1997             var editOnlyFile = Path.of(&quot;editonly.txt&quot;);
1998             Files.writeString(localRepo.root().resolve(editOnlyFile), &quot;Only added in the edit&quot;);
1999             localRepo.add(editOnlyFile);
2000             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;Edited&quot;, &quot;Commit in edit branch&quot;);
2001             localRepo.checkout(masterHash, true);
2002             var masterOnlyFile = Path.of(&quot;masteronly.txt&quot;);
2003             Files.writeString(localRepo.root().resolve(masterOnlyFile), &quot;Only added in master&quot;);
2004             localRepo.add(masterOnlyFile);
2005             var updatedMasterHash = localRepo.commit(&quot;Only added in master&quot;, &quot;duke&quot;, &quot;duke@openjdk.java.net&quot;);
2006             localRepo.push(updatedMasterHash, author.url(), &quot;master&quot;);
2007             localRepo.merge(editHash);
2008             var mergeCommit = localRepo.commit(&quot;Merged edit&quot;, &quot;duke&quot;, &quot;duke@openjdk.java.net&quot;);
2009             localRepo.push(mergeCommit, author.url(), &quot;edit&quot;, true);
2010 
2011             // Make a merge PR
2012             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;Merge edit&quot;);
2013             pr.setBody(&quot;This is now ready&quot;);
2014 
2015             // Run an archive pass
2016             TestBotRunner.runPeriodicItems(mlBot);
2017             listServer.processIncoming();
2018 
2019             // The archive should contain a merge style webrev
2020             Repository.materialize(archiveFolder.path(), archive.url(), &quot;archive&quot;);
2021             assertTrue(archiveContains(archiveFolder.path(), &quot;so no merge-specific webrevs have been generated&quot;));
2022 
2023             // The PR should not contain a webrev comment
2024             assertEquals(0, pr.comments().size());
2025         }
2026     }
2027 
2028     @Test
2029     void skipAddingExistingWebrev(TestInfo testInfo) throws IOException {
2030         try (var credentials = new HostCredentials(testInfo);
2031              var tempFolder = new TemporaryDirectory();
2032              var archiveFolder = new TemporaryDirectory();
2033              var webrevFolder = new TemporaryDirectory();
2034              var listServer = new TestMailmanServer();
2035              var webrevServer = new TestWebrevServer()) {
2036             var author = credentials.getHostedRepository();
2037             var archive = credentials.getHostedRepository();
2038             var ignored = credentials.getHostedRepository();
2039             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
2040             var censusBuilder = credentials.getCensusBuilder()
2041                                            .addAuthor(author.forge().currentUser().id());
2042             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
2043             var mlBot = MailingListBridgeBot.newBuilder()
2044                                             .from(from)
2045                                             .repo(author)
2046                                             .archive(archive)
2047                                             .censusRepo(censusBuilder.build())
2048                                             .list(listAddress)
2049                                             .ignoredUsers(Set.of(ignored.forge().currentUser().userName()))
2050                                             .listArchive(listServer.getArchive())
2051                                             .smtpServer(listServer.getSMTP())
2052                                             .webrevStorageRepository(archive)
2053                                             .webrevStorageRef(&quot;webrev&quot;)
2054                                             .webrevStorageBase(Path.of(&quot;test&quot;))
2055                                             .webrevStorageBaseUri(webrevServer.uri())
2056                                             .issueTracker(URIBuilder.base(&quot;http://issues.test/browse/&quot;).build())
2057                                             .build();
2058 
2059             // Populate the projects repository
2060             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType());
2061             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
2062             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
2063             localRepo.push(masterHash, archive.url(), &quot;webrev&quot;, true);
2064 
2065             // Make a change with a corresponding PR
2066             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;A simple change&quot;,
2067                                                                &quot;Change msg\n\nWith several lines&quot;);
2068             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
2069             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
2070 
2071             // Flag it as ready for review
2072             pr.setBody(&quot;This should now be ready&quot;);
2073 
2074             // Run an archive pass
2075             TestBotRunner.runPeriodicItems(mlBot);
2076 
2077             // The archive should now contain an entry
2078             var archiveRepo = Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);
2079             assertTrue(archiveContains(archiveFolder.path(), editHash.abbreviate()));
2080 
2081             // And there should be a webrev comment
2082             var comments = pr.comments();
2083             var webrevComments = comments.stream()
2084                                          .filter(comment -&gt; comment.author().equals(author.forge().currentUser()))
2085                                          .filter(comment -&gt; comment.body().contains(&quot;webrev&quot;))
2086                                          .filter(comment -&gt; comment.body().contains(editHash.hex()))
2087                                          .collect(Collectors.toList());
2088             assertEquals(1, webrevComments.size());
2089             assertEquals(1, countSubstrings(webrevComments.get(0).body(), &quot;webrev.00&quot;));
2090 
2091             // Pretend the archive didn&#39;t work out
2092             archiveRepo.push(masterHash, archive.url(), &quot;master&quot;, true);
2093 
2094             // Run another archive pass
2095             TestBotRunner.runPeriodicItems(mlBot);
2096 
2097             // The webrev comment should not contain duplicate entries
2098             comments = pr.comments();
2099             webrevComments = comments.stream()
2100                                      .filter(comment -&gt; comment.author().equals(author.forge().currentUser()))
2101                                      .filter(comment -&gt; comment.body().contains(&quot;webrev&quot;))
2102                                      .filter(comment -&gt; comment.body().contains(editHash.hex()))
2103                                      .collect(Collectors.toList());
2104             assertEquals(1, webrevComments.size());
2105             assertEquals(1, countSubstrings(webrevComments.get(0).body(), &quot;webrev.00&quot;));
2106         }
2107     }
2108 
2109     @Test
2110     void notifyReviewVerdicts(TestInfo testInfo) throws IOException {
2111         try (var credentials = new HostCredentials(testInfo);
2112              var tempFolder = new TemporaryDirectory();
2113              var archiveFolder = new TemporaryDirectory();
2114              var listServer = new TestMailmanServer();
2115              var webrevServer = new TestWebrevServer()) {
2116             var author = credentials.getHostedRepository();
2117             var archive = credentials.getHostedRepository();
2118             var reviewer = credentials.getHostedRepository();
2119             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
2120             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
2121             var censusBuilder = credentials.getCensusBuilder()
2122                                            .addReviewer(reviewer.forge().currentUser().id())
2123                                            .addAuthor(author.forge().currentUser().id());
2124             var mlBot = MailingListBridgeBot.newBuilder()
2125                                             .from(from)
2126                                             .repo(author)
2127                                             .archive(archive)
2128                                             .censusRepo(censusBuilder.build())
2129                                             .list(listAddress)
2130                                             .listArchive(listServer.getArchive())
2131                                             .smtpServer(listServer.getSMTP())
2132                                             .webrevStorageRepository(archive)
2133                                             .webrevStorageRef(&quot;webrev&quot;)
2134                                             .webrevStorageBase(Path.of(&quot;test&quot;))
2135                                             .webrevStorageBaseUri(webrevServer.uri())
2136                                             .issueTracker(URIBuilder.base(&quot;http://issues.test/browse/&quot;).build())
2137                                             .build();
2138 
2139             // Populate the projects repository
2140             var reviewFile = Path.of(&quot;reviewfile.txt&quot;);
2141             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType(), reviewFile);
2142             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
2143             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
2144             localRepo.push(masterHash, archive.url(), &quot;webrev&quot;, true);
2145 
2146             // Make a change with a corresponding PR
2147             var editHash = CheckableRepository.appendAndCommit(localRepo);
2148             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
2149             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
2150             pr.setBody(&quot;This is now ready&quot;);
2151 
2152             // Run an archive pass
2153             TestBotRunner.runPeriodicItems(mlBot);
2154 
2155             // First unapprove it
2156             var reviewedPr = reviewer.pullRequest(pr.id());
2157             reviewedPr.addReview(Review.Verdict.DISAPPROVED, &quot;Reason 1&quot;);
2158             TestBotRunner.runPeriodicItems(mlBot);
2159             TestBotRunner.runPeriodicItems(mlBot);
2160             TestBotRunner.runPeriodicItems(mlBot);
2161 
2162             // The archive should contain a note
2163             Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);
2164             assertEquals(1, archiveContainsCount(archiveFolder.path(), &quot;Changes requested by &quot;));
2165             assertEquals(1, archiveContainsCount(archiveFolder.path(), &quot; by integrationreviewer1&quot;));
2166             if (author.forge().supportsReviewBody()) {
2167                 assertEquals(1, archiveContainsCount(archiveFolder.path(), &quot;Reason 1&quot;));
2168             }
2169 
2170             // Then approve it
2171             reviewedPr.addReview(Review.Verdict.APPROVED, &quot;Reason 2&quot;);
2172             TestBotRunner.runPeriodicItems(mlBot);
2173             TestBotRunner.runPeriodicItems(mlBot);
2174             TestBotRunner.runPeriodicItems(mlBot);
2175 
2176             // The archive should contain another note
2177             Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);
2178             assertEquals(1, archiveContainsCount(archiveFolder.path(), &quot;Marked as reviewed by &quot;));
2179             if (author.forge().supportsReviewBody()) {
2180                 assertEquals(1, archiveContainsCount(archiveFolder.path(), &quot;Reason 2&quot;));
2181             }
2182             assertEquals(2, archiveContainsCount(archiveFolder.path(), &quot;Re: RFR:&quot;));
2183 
2184             // Yet another change
2185             reviewedPr.addReview(Review.Verdict.DISAPPROVED, &quot;Reason 3&quot;);
2186             TestBotRunner.runPeriodicItems(mlBot);
2187             TestBotRunner.runPeriodicItems(mlBot);
2188             TestBotRunner.runPeriodicItems(mlBot);
2189 
2190             // The archive should contain another note
2191             Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);
2192             assertEquals(2, archiveContainsCount(archiveFolder.path(), &quot;Changes requested by &quot;));
2193             if (author.forge().supportsReviewBody()) {
2194                 assertEquals(1, archiveContainsCount(archiveFolder.path(), &quot;Reason 3&quot;));
2195             }
2196         }
2197     }
2198 
2199     @Test
2200     void ignoreComments(TestInfo testInfo) throws IOException {
2201         try (var credentials = new HostCredentials(testInfo);
2202              var tempFolder = new TemporaryDirectory();
2203              var archiveFolder = new TemporaryDirectory();
2204              var listServer = new TestMailmanServer();
2205              var webrevServer = new TestWebrevServer()) {
2206             var author = credentials.getHostedRepository();
2207             var ignored = credentials.getHostedRepository();
2208             var archive = credentials.getHostedRepository();
2209             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
2210             var censusBuilder = credentials.getCensusBuilder()
2211                                            .addAuthor(author.forge().currentUser().id());
2212             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
2213             var mlBot = MailingListBridgeBot.newBuilder()
2214                                             .from(from)
2215                                             .repo(author)
2216                                             .archive(archive)
2217                                             .censusRepo(censusBuilder.build())
2218                                             .list(listAddress)
2219                                             .ignoredUsers(Set.of(ignored.forge().currentUser().userName()))
2220                                             .ignoredComments(Set.of(Pattern.compile(&quot;ignore this comment&quot;, Pattern.MULTILINE | Pattern.DOTALL)))
2221                                             .listArchive(listServer.getArchive())
2222                                             .smtpServer(listServer.getSMTP())
2223                                             .webrevStorageRepository(archive)
2224                                             .webrevStorageRef(&quot;webrev&quot;)
2225                                             .webrevStorageBase(Path.of(&quot;test&quot;))
2226                                             .webrevStorageBaseUri(webrevServer.uri())
2227                                             .issueTracker(URIBuilder.base(&quot;http://issues.test/browse/&quot;).build())
2228                                             .build();
2229 
2230             // Populate the projects repository
2231             var reviewFile = Path.of(&quot;reviewfile.txt&quot;);
2232             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType(), reviewFile);
2233             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
2234             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
2235             localRepo.push(masterHash, archive.url(), &quot;webrev&quot;, true);
2236 
2237             // Make a change with a corresponding PR
2238             var editHash = CheckableRepository.appendAndCommit(localRepo);
2239             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
2240             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
2241             pr.setBody(&quot;This is now ready&quot;);
2242 
2243             // Make a bunch of comments
2244             pr.addComment(&quot;Plain comment&quot;);
2245             pr.addComment(&quot;ignore this comment&quot;);
2246             pr.addComment(&quot;I think it is time to\nignore this comment!&quot;);
2247             pr.addReviewComment(masterHash, editHash, reviewFile.toString(), 2, &quot;Review ignore this comment&quot;);
2248 
2249             var ignoredPR = ignored.pullRequest(pr.id());
2250             ignoredPR.addComment(&quot;Don&#39;t mind me&quot;);
2251 
2252             TestBotRunner.runPeriodicItems(mlBot);
2253             TestBotRunner.runPeriodicItems(mlBot);
2254 
2255             // The archive should not contain the ignored comments
2256             Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);
2257             assertTrue(archiveContains(archiveFolder.path(), &quot;This is now ready&quot;));
2258             assertFalse(archiveContains(archiveFolder.path(), &quot;ignore this comment&quot;));
2259             assertFalse(archiveContains(archiveFolder.path(), &quot;it is time to&quot;));
2260             assertFalse(archiveContains(archiveFolder.path(), &quot;Don&#39;t mind me&quot;));
2261             assertFalse(archiveContains(archiveFolder.path(), &quot;Review ignore&quot;));
2262         }
2263     }
2264 
2265     @Test
2266     void replyToEmptyReview(TestInfo testInfo) throws IOException {
2267         try (var credentials = new HostCredentials(testInfo);
2268              var tempFolder = new TemporaryDirectory();
2269              var archiveFolder = new TemporaryDirectory();
2270              var listServer = new TestMailmanServer();
2271              var webrevServer = new TestWebrevServer()) {
2272             var author = credentials.getHostedRepository();
2273             var reviewer = credentials.getHostedRepository();
2274             var archive = credentials.getHostedRepository();
2275             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
2276             var censusBuilder = credentials.getCensusBuilder()
2277                                            .addReviewer(reviewer.forge().currentUser().id())
2278                                            .addAuthor(author.forge().currentUser().id());
2279             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
2280             var mlBot = MailingListBridgeBot.newBuilder()
2281                                             .from(from)
2282                                             .repo(author)
2283                                             .archive(archive)
2284                                             .censusRepo(censusBuilder.build())
2285                                             .list(listAddress)
2286                                             .listArchive(listServer.getArchive())
2287                                             .smtpServer(listServer.getSMTP())
2288                                             .webrevStorageRepository(archive)
2289                                             .webrevStorageRef(&quot;webrev&quot;)
2290                                             .webrevStorageBase(Path.of(&quot;test&quot;))
2291                                             .webrevStorageBaseUri(webrevServer.uri())
2292                                             .issueTracker(URIBuilder.base(&quot;http://issues.test/browse/&quot;).build())
2293                                             .build();
2294 
2295             // Populate the projects repository
2296             var reviewFile = Path.of(&quot;reviewfile.txt&quot;);
2297             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType(), reviewFile);
2298             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
2299             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
2300             localRepo.push(masterHash, archive.url(), &quot;webrev&quot;, true);
2301 
2302             // Make a change with a corresponding PR
2303             var editHash = CheckableRepository.appendAndCommit(localRepo);
2304             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
2305             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
2306             pr.setBody(&quot;This is now ready&quot;);
2307             TestBotRunner.runPeriodicItems(mlBot);
2308             listServer.processIncoming();
2309 
2310             // Make an empty approval
2311             var reviewPr = reviewer.pullRequest(pr.id());
2312             reviewPr.addReview(Review.Verdict.APPROVED, &quot;&quot;);
2313             TestBotRunner.runPeriodicItems(mlBot);
2314             listServer.processIncoming();
2315 
2316             pr.addComment(&quot;Thanks for the review!&quot;);
2317             TestBotRunner.runPeriodicItems(mlBot);
2318             listServer.processIncoming();
2319 
2320             // The approval text should be included in the quote
2321             Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);
2322             assertEquals(1, archiveContainsCount(archiveFolder.path(), &quot;^&gt; Marked as reviewed&quot;));
2323         }
2324     }
2325 
2326     @Test
2327     void cooldown(TestInfo testInfo) throws IOException {
2328         try (var credentials = new HostCredentials(testInfo);
2329              var tempFolder = new TemporaryDirectory();
2330              var archiveFolder = new TemporaryDirectory();
2331              var listServer = new TestMailmanServer();
2332              var webrevServer = new TestWebrevServer()) {
2333             var bot = credentials.getHostedRepository();
2334             var author = credentials.getHostedRepository();
2335             var archive = credentials.getHostedRepository();
2336             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
2337             var censusBuilder = credentials.getCensusBuilder()
2338                                            .addAuthor(author.forge().currentUser().id());
2339             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
2340             var mlBotBuilder = MailingListBridgeBot.newBuilder()
2341                                                    .from(from)
2342                                                    .repo(bot)
2343                                                    .ignoredUsers(Set.of(bot.forge().currentUser().userName()))
2344                                                    .archive(archive)
2345                                                    .censusRepo(censusBuilder.build())
2346                                                    .list(listAddress)
2347                                                    .listArchive(listServer.getArchive())
2348                                                    .smtpServer(listServer.getSMTP())
2349                                                    .webrevStorageRepository(archive)
2350                                                    .webrevStorageRef(&quot;webrev&quot;)
2351                                                    .webrevStorageBase(Path.of(&quot;test&quot;))
2352                                                    .webrevStorageBaseUri(webrevServer.uri())
2353                                                    .issueTracker(URIBuilder.base(&quot;http://issues.test/browse/&quot;).build());
2354 
2355             // Populate the projects repository
2356             var reviewFile = Path.of(&quot;reviewfile.txt&quot;);
2357             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType(), reviewFile);
2358             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
2359             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
2360             localRepo.push(masterHash, archive.url(), &quot;webrev&quot;, true);
2361 
2362             // Make a change with a corresponding PR
2363             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;Line 1\nLine 2\nLine 3\nLine 4&quot;);
2364             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
2365             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
2366             pr.setBody(&quot;This is now ready&quot;);
2367 
2368             var mlBot = mlBotBuilder.build();
2369             var mlBotWithCooldown = mlBotBuilder.cooldown(Duration.ofDays(1)).build();
2370 
2371             TestBotRunner.runPeriodicItems(mlBot);
2372             listServer.processIncoming();
2373 
2374             // Make a comment
2375             pr.addComment(&quot;Looks good&quot;);
2376 
2377             // Bot with cooldown configured should not bridge the comment
2378             TestBotRunner.runPeriodicItems(mlBotWithCooldown);
2379             assertThrows(RuntimeException.class, () -&gt; listServer.processIncoming(Duration.ofMillis(1)));
2380 
2381             // But without, it should
2382             TestBotRunner.runPeriodicItems(mlBot);
2383             listServer.processIncoming();
2384 
2385             // Check the archive
2386             Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);
2387             assertTrue(archiveContains(archiveFolder.path(), &quot;Looks good&quot;));
2388         }
2389     }
2390 
2391     @Test
2392     void cooldownNewRevision(TestInfo testInfo) throws IOException {
2393         try (var credentials = new HostCredentials(testInfo);
2394              var tempFolder = new TemporaryDirectory();
2395              var archiveFolder = new TemporaryDirectory();
2396              var listServer = new TestMailmanServer();
2397              var webrevServer = new TestWebrevServer()) {
2398             var bot = credentials.getHostedRepository();
2399             var author = credentials.getHostedRepository();
2400             var archive = credentials.getHostedRepository();
2401             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
2402             var censusBuilder = credentials.getCensusBuilder()
2403                                            .addAuthor(author.forge().currentUser().id());
2404             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
2405             var mlBotBuilder = MailingListBridgeBot.newBuilder()
2406                                                    .from(from)
2407                                                    .repo(bot)
2408                                                    .ignoredUsers(Set.of(bot.forge().currentUser().userName()))
2409                                                    .archive(archive)
2410                                                    .censusRepo(censusBuilder.build())
2411                                                    .list(listAddress)
2412                                                    .listArchive(listServer.getArchive())
2413                                                    .smtpServer(listServer.getSMTP())
2414                                                    .webrevStorageRepository(archive)
2415                                                    .webrevStorageRef(&quot;webrev&quot;)
2416                                                    .webrevStorageBase(Path.of(&quot;test&quot;))
2417                                                    .webrevStorageBaseUri(webrevServer.uri())
2418                                                    .issueTracker(URIBuilder.base(&quot;http://issues.test/browse/&quot;).build());
2419 
2420             // Populate the projects repository
2421             var reviewFile = Path.of(&quot;reviewfile.txt&quot;);
2422             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType(), reviewFile);
2423             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
2424             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
2425             localRepo.push(masterHash, archive.url(), &quot;webrev&quot;, true);
2426 
2427             // Make a change with a corresponding PR
2428             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;Line 1\nLine 2\nLine 3\nLine 4&quot;);
2429             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
2430             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
2431             pr.setBody(&quot;This is now ready&quot;);
2432 
2433             var mlBot = mlBotBuilder.build();
2434             var mlBotWithCooldown = mlBotBuilder.cooldown(Duration.ofDays(1)).build();
2435 
2436             TestBotRunner.runPeriodicItems(mlBot);
2437             listServer.processIncoming();
2438 
2439             // Commit another revision
2440             var updatedHash = CheckableRepository.appendAndCommit(localRepo, &quot;More stuff&quot;);
2441             localRepo.push(updatedHash, author.url(), &quot;edit&quot;);
2442 
2443             // Bot with cooldown configured should not create a new webrev
2444             TestBotRunner.runPeriodicItems(mlBotWithCooldown);
2445             assertThrows(RuntimeException.class, () -&gt; listServer.processIncoming(Duration.ofMillis(1)));
2446 
2447             // But without, it should
2448             TestBotRunner.runPeriodicItems(mlBot);
2449             listServer.processIncoming();
2450 
2451             // Check the archive
2452             Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);
2453             assertTrue(archiveContains(archiveFolder.path(), &quot;webrev.01&quot;));
2454         }
2455     }
2456 
2457     @Test
2458     void retryAfterCooldown(TestInfo testInfo) throws IOException, InterruptedException {
2459         try (var credentials = new HostCredentials(testInfo);
2460              var tempFolder = new TemporaryDirectory();
2461              var archiveFolder = new TemporaryDirectory();
2462              var listServer = new TestMailmanServer();
2463              var webrevServer = new TestWebrevServer()) {
2464             var bot = credentials.getHostedRepository();
2465             var author = credentials.getHostedRepository();
2466             var archive = credentials.getHostedRepository();
2467             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
2468             var censusBuilder = credentials.getCensusBuilder()
2469                                            .addAuthor(author.forge().currentUser().id());
2470             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
2471             var cooldown = Duration.ofMillis(500);
2472             var mlBotBuilder = MailingListBridgeBot.newBuilder()
2473                                                    .from(from)
2474                                                    .repo(bot)
2475                                                    .ignoredUsers(Set.of(bot.forge().currentUser().userName()))
2476                                                    .archive(archive)
2477                                                    .censusRepo(censusBuilder.build())
2478                                                    .list(listAddress)
2479                                                    .listArchive(listServer.getArchive())
2480                                                    .smtpServer(listServer.getSMTP())
2481                                                    .webrevStorageRepository(archive)
2482                                                    .webrevStorageRef(&quot;webrev&quot;)
2483                                                    .webrevStorageBase(Path.of(&quot;test&quot;))
2484                                                    .webrevStorageBaseUri(webrevServer.uri())
2485                                                    .issueTracker(URIBuilder.base(&quot;http://issues.test/browse/&quot;).build());
2486 
2487             // Populate the projects repository
2488             var reviewFile = Path.of(&quot;reviewfile.txt&quot;);
2489             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType(), reviewFile);
2490             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
2491             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
2492             localRepo.push(masterHash, archive.url(), &quot;webrev&quot;, true);
2493 
2494             // Make a change with a corresponding PR
2495             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;Line 1\nLine 2\nLine 3\nLine 4&quot;);
2496             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
2497             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
2498             pr.setBody(&quot;This is now ready&quot;);
2499 
2500             var mlBot = mlBotBuilder.cooldown(cooldown).build();
2501             Thread.sleep(cooldown.toMillis());
2502             TestBotRunner.runPeriodicItems(mlBot);
2503             listServer.processIncoming();
2504 
2505             // Make a comment and run the check within the cooldown period
2506             int counter;
2507             boolean noMailReceived = false;
2508             for (counter = 1; counter &lt; 10; ++counter) {
2509                 var start = Instant.now();
2510                 pr.addComment(&quot;Looks good - &quot; + counter + &quot; -&quot;);
2511 
2512                 // The bot should not bridge the comment due to cooldown
2513                 TestBotRunner.runPeriodicItems(mlBot);
2514                 try {
2515                     noMailReceived = false;
2516                     listServer.processIncoming(Duration.ofMillis(1));
2517                 } catch (RuntimeException e) {
2518                     noMailReceived = true;
2519                 }
2520                 var elapsed = Duration.between(start, Instant.now());
2521                 if (elapsed.compareTo(cooldown) &lt; 0) {
2522                     break;
2523                 } else {
2524                     log.info(&quot;Didn&#39;t do the test in time - retrying (elapsed: &quot; + elapsed + &quot; required: &quot; + cooldown + &quot;)&quot;);
2525                     // Ensure that the cooldown expires
2526                     Thread.sleep(cooldown.toMillis());
2527                     // If no mail was received, we have to flush it out
2528                     if (noMailReceived) {
2529                         TestBotRunner.runPeriodicItems(mlBot);
2530                         listServer.processIncoming();
2531                     }
2532                     cooldown = cooldown.multipliedBy(2);
2533                     mlBot = mlBotBuilder.cooldown(cooldown).build();
2534                 }
2535             }
2536             assertTrue(noMailReceived);
2537 
2538             // But after the cooldown period has passed, it should
2539             Thread.sleep(cooldown.toMillis());
2540             TestBotRunner.runPeriodicItems(mlBot);
2541             listServer.processIncoming();
2542 
2543             // Check the archive
2544             Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);
2545             assertTrue(archiveContains(archiveFolder.path(), &quot;Looks good - &quot; + counter + &quot; -&quot;));
2546         }
2547     }
2548 
2549     @Test
2550     void branchPrefix(TestInfo testInfo) throws IOException {
2551         try (var credentials = new HostCredentials(testInfo);
2552              var tempFolder = new TemporaryDirectory();
2553              var archiveFolder = new TemporaryDirectory();
2554              var listServer = new TestMailmanServer();
2555              var webrevServer = new TestWebrevServer()) {
2556             var author = credentials.getHostedRepository();
2557             var archive = credentials.getHostedRepository();
2558             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
2559             var censusBuilder = credentials.getCensusBuilder()
2560                                            .addAuthor(author.forge().currentUser().id());
2561             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
2562             var mlBot = MailingListBridgeBot.newBuilder()
2563                                             .from(from)
2564                                             .repo(author)
2565                                             .archive(archive)
2566                                             .censusRepo(censusBuilder.build())
2567                                             .list(listAddress)
2568                                             .listArchive(listServer.getArchive())
2569                                             .smtpServer(listServer.getSMTP())
2570                                             .webrevStorageRepository(archive)
2571                                             .webrevStorageRef(&quot;webrev&quot;)
2572                                             .webrevStorageBase(Path.of(&quot;test&quot;))
2573                                             .webrevStorageBaseUri(webrevServer.uri())
2574                                             .issueTracker(URIBuilder.base(&quot;http://issues.test/browse/&quot;).build())
2575                                             .branchInSubject(Pattern.compile(&quot;.*&quot;))
2576                                             .build();
2577 
2578             // Populate the projects repository
2579             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType());
2580             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
2581             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
2582             localRepo.push(masterHash, archive.url(), &quot;webrev&quot;, true);
2583 
2584             // Make a change with a corresponding PR
2585             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;A simple change&quot;,
2586                                                                &quot;Change msg\n\nWith several lines&quot;);
2587             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
2588             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;1234: This is a pull request&quot;);
2589             pr.setBody(&quot;This is a PR&quot;);
2590 
2591             // Run an archive pass
2592             TestBotRunner.runPeriodicItems(mlBot);
2593             listServer.processIncoming();
2594 
2595             pr.addComment(&quot;Looks good!&quot;);
2596             TestBotRunner.runPeriodicItems(mlBot);
2597             listServer.processIncoming();
2598 
2599             // Check the archive
2600             Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);
2601             assertTrue(archiveContains(archiveFolder.path(), &quot;Subject: \\[master\\] RFR: &quot;));
2602             assertTrue(archiveContains(archiveFolder.path(), &quot;Subject: Re: \\[master\\] RFR: &quot;));
2603         }
2604     }
2605 
2606     @Test
2607     void repoPrefix(TestInfo testInfo) throws IOException {
2608         try (var credentials = new HostCredentials(testInfo);
2609              var tempFolder = new TemporaryDirectory();
2610              var archiveFolder = new TemporaryDirectory();
2611              var listServer = new TestMailmanServer();
2612              var webrevServer = new TestWebrevServer()) {
2613             var author = credentials.getHostedRepository();
2614             var archive = credentials.getHostedRepository();
2615             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
2616             var censusBuilder = credentials.getCensusBuilder()
2617                                            .addAuthor(author.forge().currentUser().id());
2618             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
2619             var mlBot = MailingListBridgeBot.newBuilder()
2620                                             .from(from)
2621                                             .repo(author)
2622                                             .archive(archive)
2623                                             .censusRepo(censusBuilder.build())
2624                                             .list(listAddress)
2625                                             .listArchive(listServer.getArchive())
2626                                             .smtpServer(listServer.getSMTP())
2627                                             .webrevStorageRepository(archive)
2628                                             .webrevStorageRef(&quot;webrev&quot;)
2629                                             .webrevStorageBase(Path.of(&quot;test&quot;))
2630                                             .webrevStorageBaseUri(webrevServer.uri())
2631                                             .issueTracker(URIBuilder.base(&quot;http://issues.test/browse/&quot;).build())
2632                                             .repoInSubject(true)
2633                                             .build();
2634 
2635             // Populate the projects repository
2636             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType());
2637             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
2638             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
2639             localRepo.push(masterHash, archive.url(), &quot;webrev&quot;, true);
2640 
2641             // Make a change with a corresponding PR
2642             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;A simple change&quot;,
2643                                                                &quot;Change msg\n\nWith several lines&quot;);
2644             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
2645             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;1234: This is a pull request&quot;);
2646             pr.setBody(&quot;This is a PR&quot;);
2647 
2648             // Run an archive pass
2649             TestBotRunner.runPeriodicItems(mlBot);
2650             listServer.processIncoming();
2651 
2652             pr.addComment(&quot;Looks good!&quot;);
2653             TestBotRunner.runPeriodicItems(mlBot);
2654             listServer.processIncoming();
2655 
2656             // Check the archive
2657             Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);
2658             assertTrue(archiveContains(archiveFolder.path(), &quot;Subject: \\[&quot; + pr.repository().name() + &quot;\\] RFR: &quot;));
2659             assertTrue(archiveContains(archiveFolder.path(), &quot;Subject: Re: \\[&quot; + pr.repository().name() + &quot;\\] RFR: &quot;));
2660         }
2661     }
2662 
2663     @Test
2664     void repoAndBranchPrefix(TestInfo testInfo) throws IOException {
2665         try (var credentials = new HostCredentials(testInfo);
2666              var tempFolder = new TemporaryDirectory();
2667              var archiveFolder = new TemporaryDirectory();
2668              var listServer = new TestMailmanServer();
2669              var webrevServer = new TestWebrevServer()) {
2670             var author = credentials.getHostedRepository();
2671             var archive = credentials.getHostedRepository();
2672             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
2673             var censusBuilder = credentials.getCensusBuilder()
2674                                            .addAuthor(author.forge().currentUser().id());
2675             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
2676             var mlBot = MailingListBridgeBot.newBuilder()
2677                                             .from(from)
2678                                             .repo(author)
2679                                             .archive(archive)
2680                                             .censusRepo(censusBuilder.build())
2681                                             .list(listAddress)
2682                                             .listArchive(listServer.getArchive())
2683                                             .smtpServer(listServer.getSMTP())
2684                                             .webrevStorageRepository(archive)
2685                                             .webrevStorageRef(&quot;webrev&quot;)
2686                                             .webrevStorageBase(Path.of(&quot;test&quot;))
2687                                             .webrevStorageBaseUri(webrevServer.uri())
2688                                             .issueTracker(URIBuilder.base(&quot;http://issues.test/browse/&quot;).build())
2689                                             .repoInSubject(true)
2690                                             .branchInSubject(Pattern.compile(&quot;.*&quot;))
2691                                             .build();
2692 
2693             // Populate the projects repository
2694             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType());
2695             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
2696             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
2697             localRepo.push(masterHash, archive.url(), &quot;webrev&quot;, true);
2698 
2699             // Make a change with a corresponding PR
2700             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;A simple change&quot;,
2701                                                                &quot;Change msg\n\nWith several lines&quot;);
2702             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
2703             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;1234: This is a pull request&quot;);
2704             pr.setBody(&quot;This is a PR&quot;);
2705 
2706             // Run an archive pass
2707             TestBotRunner.runPeriodicItems(mlBot);
2708             listServer.processIncoming();
2709 
2710             pr.addComment(&quot;Looks good!&quot;);
2711             TestBotRunner.runPeriodicItems(mlBot);
2712             listServer.processIncoming();
2713 
2714             // Check the archive
2715             Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);
2716             assertTrue(archiveContains(archiveFolder.path(), &quot;Subject: \\[&quot; + pr.repository().name() + &quot;:master\\] RFR: &quot;));
2717             assertTrue(archiveContains(archiveFolder.path(), &quot;Subject: Re: \\[&quot; + pr.repository().name() + &quot;:master\\] RFR: &quot;));
2718         }
2719     }
2720 
2721     @Test
2722     void retryNewRevisionAfterCooldown(TestInfo testInfo) throws IOException, InterruptedException {
2723         try (var credentials = new HostCredentials(testInfo);
2724              var tempFolder = new TemporaryDirectory();
2725              var archiveFolder = new TemporaryDirectory();
2726              var listServer = new TestMailmanServer();
2727              var webrevServer = new TestWebrevServer()) {
2728             var bot = credentials.getHostedRepository();
2729             var author = credentials.getHostedRepository();
2730             var archive = credentials.getHostedRepository();
2731             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
2732             var censusBuilder = credentials.getCensusBuilder()
2733                                            .addAuthor(author.forge().currentUser().id());
2734             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
2735             var cooldown = Duration.ofMillis(500);
2736             var mlBotBuilder = MailingListBridgeBot.newBuilder()
2737                                                    .from(from)
2738                                                    .repo(bot)
2739                                                    .ignoredUsers(Set.of(bot.forge().currentUser().userName()))
2740                                                    .archive(archive)
2741                                                    .censusRepo(censusBuilder.build())
2742                                                    .list(listAddress)
2743                                                    .listArchive(listServer.getArchive())
2744                                                    .smtpServer(listServer.getSMTP())
2745                                                    .webrevStorageRepository(archive)
2746                                                    .webrevStorageRef(&quot;webrev&quot;)
2747                                                    .webrevStorageBase(Path.of(&quot;test&quot;))
2748                                                    .webrevStorageBaseUri(webrevServer.uri())
2749                                                    .issueTracker(URIBuilder.base(&quot;http://issues.test/browse/&quot;).build());
2750 
2751             // Populate the projects repository
2752             var reviewFile = Path.of(&quot;reviewfile.txt&quot;);
2753             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType(), reviewFile);
2754             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
2755             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
2756             localRepo.push(masterHash, archive.url(), &quot;webrev&quot;, true);
2757 
2758             // Make a change with a corresponding PR
2759             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;Line 1\nLine 2\nLine 3\nLine 4&quot;);
2760             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
2761             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
2762             pr.setBody(&quot;This is now ready&quot;);
2763 
2764             var mlBot = mlBotBuilder.cooldown(cooldown).build();
2765             Thread.sleep(cooldown.toMillis());
2766             TestBotRunner.runPeriodicItems(mlBot);
2767             listServer.processIncoming();
2768 
2769             // Make a new revision and run the check within the cooldown period
2770             int counter;
2771             boolean noMailReceived = false;
2772             for (counter = 1; counter &lt; 10; ++counter) {
2773                 var start = Instant.now();
2774                 var revHash = CheckableRepository.appendAndCommit(localRepo, &quot;more stuff&quot;, &quot;Update number - &quot; + counter + &quot; -&quot;);
2775                 localRepo.push(revHash, author.url(), &quot;edit&quot;);
2776 
2777                 // The bot should not bridge the new revision due to cooldown
2778                 TestBotRunner.runPeriodicItems(mlBot);
2779                 try {
2780                     noMailReceived = false;
2781                     listServer.processIncoming(Duration.ofMillis(1));
2782                 } catch (RuntimeException e) {
2783                     noMailReceived = true;
2784                 }
2785                 var elapsed = Duration.between(start, Instant.now());
2786                 if (elapsed.compareTo(cooldown) &lt; 0) {
2787                     break;
2788                 } else {
2789                     log.info(&quot;Didn&#39;t do the test in time - retrying (elapsed: &quot; + elapsed + &quot; required: &quot; + cooldown + &quot;)&quot;);
2790                     // Ensure that the cooldown expires
2791                     Thread.sleep(cooldown.toMillis());
2792                     // If no mail was received, we have to flush it out
2793                     if (noMailReceived) {
2794                         TestBotRunner.runPeriodicItems(mlBot);
2795                         listServer.processIncoming();
2796                     }
2797                     cooldown = cooldown.multipliedBy(2);
2798                     mlBot = mlBotBuilder.cooldown(cooldown).build();
2799                 }
2800             }
2801             assertTrue(noMailReceived);
2802 
2803             // But after the cooldown period has passed, it should
2804             Thread.sleep(cooldown.toMillis());
2805             TestBotRunner.runPeriodicItems(mlBot);
2806             listServer.processIncoming();
2807 
2808             // Check the archive
2809             Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);
2810             assertTrue(archiveContains(archiveFolder.path(), &quot;Update number - &quot; + counter + &quot; -&quot;));
2811         }
2812     }
2813 }
<a name="3" id="anc3"></a><b style="font-size: large; color: red">--- EOF ---</b>
















































































</pre>
<input id="eof" value="3" type="hidden" />
</body>
</html>