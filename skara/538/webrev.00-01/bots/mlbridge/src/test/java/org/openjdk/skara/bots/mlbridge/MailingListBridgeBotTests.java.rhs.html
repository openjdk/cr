<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Frames bots/mlbridge/src/test/java/org/openjdk/skara/bots/mlbridge/MailingListBridgeBotTests.java</title>
    <link rel="stylesheet" href="../../../../../../../../../../style.css" />
    <script type="text/javascript" src="../../../../../../../../../../navigation.js"></script>
  </head>
<body onkeypress="keypress(event);">
<a name="0"></a>
<hr />
<pre>   1 /*
   2  * Copyright (c) 2019, Oracle and/or its affiliates. All rights reserved.
   3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   4  *
   5  * This code is free software; you can redistribute it and/or modify it
   6  * under the terms of the GNU General Public License version 2 only, as
   7  * published by the Free Software Foundation.
   8  *
   9  * This code is distributed in the hope that it will be useful, but WITHOUT
  10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
  11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
  12  * version 2 for more details (a copy is included in the LICENSE file that
  13  * accompanied this code).
  14  *
  15  * You should have received a copy of the GNU General Public License version
  16  * 2 along with this work; if not, write to the Free Software Foundation,
  17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
  18  *
  19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
  20  * or visit www.oracle.com if you need additional information or have any
  21  * questions.
  22  */
  23 package org.openjdk.skara.bots.mlbridge;
  24 
  25 import org.openjdk.skara.email.EmailAddress;
  26 import org.openjdk.skara.forge.*;
  27 import org.openjdk.skara.issuetracker.Issue;
  28 import org.openjdk.skara.network.URIBuilder;
  29 import org.openjdk.skara.mailinglist.MailingListServerFactory;
  30 import org.openjdk.skara.test.*;
  31 import org.openjdk.skara.vcs.Repository;
  32 
  33 import org.junit.jupiter.api.*;
  34 
  35 import java.io.IOException;
  36 import java.nio.charset.StandardCharsets;
  37 import java.nio.file.*;
  38 import java.time.*;
  39 import java.util.*;
  40 import java.util.logging.Logger;
  41 import java.util.regex.Pattern;
  42 import java.util.stream.Collectors;
  43 
  44 import static org.junit.jupiter.api.Assertions.*;
  45 
  46 class MailingListBridgeBotTests {
  47     private final Logger log = Logger.getLogger(&quot;org.openjdk.skara.bots.mlbridge.test&quot;);
  48 
  49     private Optional&lt;String&gt; archiveContents(Path archive) {
  50         try {
  51             var mbox = Files.find(archive, 50, (path, attrs) -&gt; path.toString().endsWith(&quot;.mbox&quot;)).findAny();
  52             if (mbox.isEmpty()) {
  53                 return Optional.empty();
  54             }
  55             return Optional.of(Files.readString(mbox.get(), StandardCharsets.UTF_8));
  56         } catch (IOException e) {
  57             return Optional.empty();
  58         }
  59 
  60     }
  61 
  62     private boolean archiveContains(Path archive, String text) {
  63         return archiveContainsCount(archive, text) &gt; 0;
  64     }
  65 
  66     private int archiveContainsCount(Path archive, String text) {
  67         var lines = archiveContents(archive);
  68         if (lines.isEmpty()) {
  69             return 0;
  70         }
  71         var pattern = Pattern.compile(text);
  72         int count = 0;
  73         for (var line : lines.get().split(&quot;\\R&quot;)) {
  74             var matcher = pattern.matcher(line);
  75             if (matcher.find()) {
  76                 count++;
  77             }
  78         }
  79         return count;
  80     }
  81 
  82     private boolean webrevContains(Path webrev, String text) {
  83         try {
  84             var index = Files.find(webrev, 5, (path, attrs) -&gt; path.toString().endsWith(&quot;index.html&quot;)).findAny();
  85             if (index.isEmpty()) {
  86                 return false;
  87             }
  88             var lines = Files.readString(index.get(), StandardCharsets.UTF_8);
  89             return lines.contains(text);
  90         } catch (IOException e) {
  91             return false;
  92         }
  93     }
  94 
  95     private long countSubstrings(String string, String substring) {
  96         return Pattern.compile(substring).matcher(string).results().count();
  97     }
  98 
  99     private String noreplyAddress(HostedRepository repository) {
 100         return &quot;test+&quot; + repository.forge().currentUser().id() + &quot;+&quot; +
 101                 repository.forge().currentUser().userName() +
 102                 &quot;@openjdk.java.net&quot;;
 103     }
 104 
 105     @Test
 106     void simpleArchive(TestInfo testInfo) throws IOException {
 107         try (var credentials = new HostCredentials(testInfo);
 108              var tempFolder = new TemporaryDirectory();
 109              var archiveFolder = new TemporaryDirectory();
 110              var webrevFolder = new TemporaryDirectory();
 111              var listServer = new TestMailmanServer();
 112              var webrevServer = new TestWebrevServer()) {
 113             var author = credentials.getHostedRepository();
 114             var archive = credentials.getHostedRepository();
 115             var ignored = credentials.getHostedRepository();
 116             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
 117             var censusBuilder = credentials.getCensusBuilder()
 118                                            .addAuthor(author.forge().currentUser().id());
 119             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
 120             var mlBot = MailingListBridgeBot.newBuilder()
 121                                             .from(from)
 122                                             .repo(author)
 123                                             .archive(archive)
 124                                             .censusRepo(censusBuilder.build())
 125                                             .list(listAddress)
 126                                             .ignoredUsers(Set.of(ignored.forge().currentUser().userName()))
 127                                             .ignoredComments(Set.of())
 128                                             .listArchive(listServer.getArchive())
 129                                             .smtpServer(listServer.getSMTP())
 130                                             .webrevStorageRepository(archive)
 131                                             .webrevStorageRef(&quot;webrev&quot;)
 132                                             .webrevStorageBase(Path.of(&quot;test&quot;))
 133                                             .webrevStorageBaseUri(webrevServer.uri())
 134                                             .readyLabels(Set.of(&quot;rfr&quot;))
 135                                             .readyComments(Map.of(ignored.forge().currentUser().userName(), Pattern.compile(&quot;ready&quot;)))
 136                                             .issueTracker(URIBuilder.base(&quot;http://issues.test/browse/&quot;).build())
 137                                             .headers(Map.of(&quot;Extra1&quot;, &quot;val1&quot;, &quot;Extra2&quot;, &quot;val2&quot;))
 138                                             .sendInterval(Duration.ZERO)
 139                                             .build();
 140 
 141             // Populate the projects repository
 142             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType());
 143             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
 144             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
 145             localRepo.push(masterHash, archive.url(), &quot;webrev&quot;, true);
 146 
 147             // Make a change with a corresponding PR
 148             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;A simple change&quot;,
 149                                                                &quot;Change msg\n\nWith several lines&quot;);
 150             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
 151             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;1234: This is a pull request&quot;);
 152             pr.setBody(&quot;This should not be ready&quot;);
 153 
 154             // Run an archive pass
 155             TestBotRunner.runPeriodicItems(mlBot);
 156 
 157             // A PR that isn&#39;t ready for review should not be archived
 158             Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);
 159             assertFalse(archiveContains(archiveFolder.path(), &quot;This is a pull request&quot;));
 160 
 161             // Flag it as ready for review
 162             pr.setBody(&quot;This should now be ready&quot;);
 163             pr.addLabel(&quot;rfr&quot;);
 164 
 165             // Run another archive pass
 166             TestBotRunner.runPeriodicItems(mlBot);
 167 
 168             // But it should still not be archived
 169             Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);
 170             assertFalse(archiveContains(archiveFolder.path(), &quot;This is a pull request&quot;));
 171 
 172             // Now post a general comment - not a ready marker
 173             var ignoredPr = ignored.pullRequest(pr.id());
 174             ignoredPr.addComment(&quot;hello there&quot;);
 175 
 176             // Run another archive pass
 177             TestBotRunner.runPeriodicItems(mlBot);
 178 
 179             // It should still not be archived
 180             Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);
 181             assertFalse(archiveContains(archiveFolder.path(), &quot;This is a pull request&quot;));
 182 
 183             // Now post a ready comment
 184             ignoredPr.addComment(&quot;ready&quot;);
 185 
 186             // Run another archive pass
 187             TestBotRunner.runPeriodicItems(mlBot);
 188 
 189             // The archive should now contain an entry
 190             Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);
 191             assertTrue(archiveContains(archiveFolder.path(), &quot;This is a pull request&quot;));
 192             assertTrue(archiveContains(archiveFolder.path(), &quot;This should now be ready&quot;));
 193             assertTrue(archiveContains(archiveFolder.path(), &quot;Patch:&quot;));
 194             assertTrue(archiveContains(archiveFolder.path(), &quot;Changes:&quot;));
 195             assertTrue(archiveContains(archiveFolder.path(), &quot;Webrev:&quot;));
 196             assertTrue(archiveContains(archiveFolder.path(), webrevServer.uri().toString()));
 197             assertTrue(archiveContains(archiveFolder.path(), &quot;webrev.00&quot;));
 198             assertTrue(archiveContains(archiveFolder.path(), &quot;Issue:&quot;));
 199             assertTrue(archiveContains(archiveFolder.path(), &quot;http://issues.test/browse/TSTPRJ-1234&quot;));
 200             assertTrue(archiveContains(archiveFolder.path(), &quot;Fetch:&quot;));
 201             assertTrue(archiveContains(archiveFolder.path(), &quot;^ - Change msg&quot;));
 202             assertFalse(archiveContains(archiveFolder.path(), &quot;With several lines&quot;));
 203 
 204             // The mailing list as well
 205             listServer.processIncoming();
 206             var mailmanServer = MailingListServerFactory.createMailmanServer(listServer.getArchive(), listServer.getSMTP(), Duration.ZERO);
 207             var mailmanList = mailmanServer.getList(listAddress.address());
 208             var conversations = mailmanList.conversations(Duration.ofDays(1));
 209             assertEquals(1, conversations.size());
 210             var mail = conversations.get(0).first();
 211             assertEquals(&quot;RFR: 1234: This is a pull request&quot;, mail.subject());
 212             assertEquals(pr.author().fullName(), mail.author().fullName().orElseThrow());
 213             assertEquals(noreplyAddress(archive), mail.author().address());
 214             assertEquals(listAddress, mail.sender());
 215             assertEquals(&quot;val1&quot;, mail.headerValue(&quot;Extra1&quot;));
 216             assertEquals(&quot;val2&quot;, mail.headerValue(&quot;Extra2&quot;));
 217 
 218             // And there should be a webrev
 219             Repository.materialize(webrevFolder.path(), archive.url(), &quot;webrev&quot;);
 220             assertTrue(webrevContains(webrevFolder.path(), &quot;1 lines changed&quot;));
 221             var comments = pr.comments();
 222             var webrevComments = comments.stream()
 223                                          .filter(comment -&gt; comment.author().equals(author.forge().currentUser()))
 224                                          .filter(comment -&gt; comment.body().contains(&quot;webrev&quot;))
 225                                          .filter(comment -&gt; comment.body().contains(editHash.hex()))
 226                                          .collect(Collectors.toList());
 227             assertEquals(1, webrevComments.size());
 228 
 229             // Add a comment
 230             pr.addComment(&quot;This is a comment :smile:&quot;);
 231 
 232             // Add a comment from an ignored user as well
 233             ignoredPr.addComment(&quot;Don&#39;t mind me&quot;);
 234 
 235             // Run another archive pass
 236             TestBotRunner.runPeriodicItems(mlBot);
 237 
 238             // The archive should now contain the comment, but not the ignored one
 239             Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);
 240             assertTrue(archiveContains(archiveFolder.path(), &quot;This is a comment&quot;));
 241             assertTrue(archiveContains(archiveFolder.path(), &quot;&gt; This should now be ready&quot;));
 242             assertFalse(archiveContains(archiveFolder.path(), &quot;Don&#39;t mind me&quot;));
 243 
 244             listServer.processIncoming();
 245             conversations = mailmanList.conversations(Duration.ofDays(1));
 246             assertEquals(1, conversations.size());
 247             assertEquals(2, conversations.get(0).allMessages().size());
 248 
 249             // Remove the rfr flag and post another comment
 250             pr.addLabel(&quot;rfr&quot;);
 251             pr.addComment(&quot;This is another comment&quot;);
 252 
 253             // Run another archive pass
 254             TestBotRunner.runPeriodicItems(mlBot);
 255 
 256             // The archive should contain the additional comment
 257             Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);
 258             assertTrue(archiveContains(archiveFolder.path(), &quot;This is another comment&quot;));
 259             assertTrue(archiveContains(archiveFolder.path(), &quot;&gt;&gt; This should now be ready&quot;));
 260 
 261             listServer.processIncoming();
 262             conversations = mailmanList.conversations(Duration.ofDays(1));
 263             assertEquals(1, conversations.size());
 264             assertEquals(3, conversations.get(0).allMessages().size());
 265             for (var newMail : conversations.get(0).allMessages()) {
 266                 assertEquals(noreplyAddress(archive), newMail.author().address());
 267                 assertEquals(listAddress, newMail.sender());
 268             }
 269             assertTrue(conversations.get(0).allMessages().get(2).body().contains(&quot;This is a comment ðŸ˜„&quot;));
 270         }
 271     }
 272 
 273     @Test
 274     void archiveIntegrated(TestInfo testInfo) throws IOException {
 275         try (var credentials = new HostCredentials(testInfo);
 276              var tempFolder = new TemporaryDirectory();
 277              var archiveFolder = new TemporaryDirectory();
 278              var webrevFolder = new TemporaryDirectory();
 279              var listServer = new TestMailmanServer();
 280              var webrevServer = new TestWebrevServer()) {
 281             var author = credentials.getHostedRepository();
 282             var archive = credentials.getHostedRepository();
 283             var ignored = credentials.getHostedRepository();
 284             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
 285             var censusBuilder = credentials.getCensusBuilder()
 286                                            .addAuthor(author.forge().currentUser().id());
 287             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
 288             var mlBot = MailingListBridgeBot.newBuilder()
 289                                             .from(from)
 290                                             .repo(author)
 291                                             .archive(archive)
 292                                             .censusRepo(censusBuilder.build())
 293                                             .list(listAddress)
 294                                             .ignoredUsers(Set.of(ignored.forge().currentUser().userName()))
 295                                             .listArchive(listServer.getArchive())
 296                                             .smtpServer(listServer.getSMTP())
 297                                             .webrevStorageRepository(archive)
 298                                             .webrevStorageRef(&quot;webrev&quot;)
 299                                             .webrevStorageBase(Path.of(&quot;test&quot;))
 300                                             .webrevStorageBaseUri(webrevServer.uri())
 301                                             .issueTracker(URIBuilder.base(&quot;http://issues.test/browse/&quot;).build())
 302                                             .build();
 303 
 304             // Populate the projects repository
 305             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType());
 306             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
 307             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
 308             localRepo.push(masterHash, archive.url(), &quot;webrev&quot;, true);
 309 
 310             // Make a change with a corresponding PR
 311             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;A simple change&quot;,
 312                                                                &quot;Change msg\n\nWith several lines&quot;);
 313             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
 314             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;1234: This is a pull request&quot;);
 315             pr.setBody(&quot;This should not be ready&quot;);
 316             pr.setState(Issue.State.CLOSED);
 317 
 318             // Run an archive pass
 319             TestBotRunner.runPeriodicItems(mlBot);
 320             TestBotRunner.runPeriodicItems(mlBot);
 321 
 322             // A PR that isn&#39;t ready for review should not be archived
 323             Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);
 324             assertFalse(archiveContains(archiveFolder.path(), &quot;This is a pull request&quot;));
 325 
 326             // Flag it as ready for review
 327             pr.setBody(&quot;This has already been integrated&quot;);
 328             pr.addLabel(&quot;integrated&quot;);
 329 
 330             // Run another archive pass
 331             TestBotRunner.runPeriodicItems(mlBot);
 332 
 333             // The archive should now contain an entry
 334             Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);
 335             assertTrue(archiveContains(archiveFolder.path(), &quot;Subject: FYI: 1234: This is a pull request&quot;));
 336 
 337             var updatedHash = CheckableRepository.appendAndCommit(localRepo, &quot;Another change&quot;);
 338             localRepo.push(updatedHash, author.url(), &quot;edit&quot;);
 339 
 340             // Run another archive pass
 341             TestBotRunner.runPeriodicItems(mlBot);
 342 
 343             // The archive should now contain another entry
 344             Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);
 345             assertTrue(archiveContains(archiveFolder.path(), &quot;Subject: Re: \\[Rev 01\\] FYI: 1234: This is a pull request&quot;));
 346         }
 347     }
 348 
 349     @Test
 350     void archiveIntegratedRetainPrefix(TestInfo testInfo) throws IOException {
 351         try (var credentials = new HostCredentials(testInfo);
 352              var tempFolder = new TemporaryDirectory();
 353              var archiveFolder = new TemporaryDirectory();
 354              var webrevFolder = new TemporaryDirectory();
 355              var listServer = new TestMailmanServer();
 356              var webrevServer = new TestWebrevServer()) {
 357             var author = credentials.getHostedRepository();
 358             var archive = credentials.getHostedRepository();
 359             var ignored = credentials.getHostedRepository();
 360             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
 361             var censusBuilder = credentials.getCensusBuilder()
 362                                            .addAuthor(author.forge().currentUser().id());
 363             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
 364             var mlBot = MailingListBridgeBot.newBuilder()
 365                                             .from(from)
 366                                             .repo(author)
 367                                             .archive(archive)
 368                                             .censusRepo(censusBuilder.build())
 369                                             .list(listAddress)
 370                                             .ignoredUsers(Set.of(ignored.forge().currentUser().userName()))
 371                                             .listArchive(listServer.getArchive())
 372                                             .smtpServer(listServer.getSMTP())
 373                                             .webrevStorageRepository(archive)
 374                                             .webrevStorageRef(&quot;webrev&quot;)
 375                                             .webrevStorageBase(Path.of(&quot;test&quot;))
 376                                             .webrevStorageBaseUri(webrevServer.uri())
<a name="1" id="anc1"></a><span class="line-added"> 377                                             .readyLabels(Set.of(&quot;rfr&quot;))</span>
 378                                             .issueTracker(URIBuilder.base(&quot;http://issues.test/browse/&quot;).build())
 379                                             .build();
 380 
 381             // Populate the projects repository
 382             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType());
 383             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
 384             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
 385             localRepo.push(masterHash, archive.url(), &quot;webrev&quot;, true);
 386 
 387             // Make a change with a corresponding PR
 388             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;A simple change&quot;,
 389                                                                &quot;Change msg\n\nWith several lines&quot;);
 390             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
 391             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;1234: This is a pull request&quot;);
 392             pr.setBody(&quot;This should be ready&quot;);
 393 
 394             // Run an archive pass
 395             TestBotRunner.runPeriodicItems(mlBot);
 396             TestBotRunner.runPeriodicItems(mlBot);
 397 
 398             // A PR that isn&#39;t ready for review should not be archived
 399             Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);
 400             assertFalse(archiveContains(archiveFolder.path(), &quot;This is a pull request&quot;));
 401 
 402             // Flag it as ready for review
 403             pr.addLabel(&quot;rfr&quot;);
 404 
 405             // Run another archive pass
 406             TestBotRunner.runPeriodicItems(mlBot);
 407 
 408             // The archive should now contain an entry
 409             Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);
 410             assertTrue(archiveContains(archiveFolder.path(), &quot;Subject: RFR: 1234: This is a pull request&quot;));
 411 
 412             // Close it and then push another change
 413             pr.setState(Issue.State.CLOSED);
 414             var updatedHash = CheckableRepository.appendAndCommit(localRepo, &quot;Another change&quot;);
 415             localRepo.push(updatedHash, author.url(), &quot;edit&quot;);
 416 
 417             // Run another archive pass
 418             TestBotRunner.runPeriodicItems(mlBot);
 419 
 420             // The archive should now contain another entry - should retain the RFR thread prefix
 421             Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);
 422             assertTrue(archiveContains(archiveFolder.path(), &quot;Subject: Re: \\[Rev 01\\] RFR: 1234: This is a pull request&quot;));
 423         }
 424     }
 425 
 426     @Test
 427     void reviewComment(TestInfo testInfo) throws IOException {
 428         try (var credentials = new HostCredentials(testInfo);
 429              var tempFolder = new TemporaryDirectory();
 430              var archiveFolder = new TemporaryDirectory();
 431              var listServer = new TestMailmanServer();
 432              var webrevServer = new TestWebrevServer()) {
 433             var author = credentials.getHostedRepository();
 434             var archive = credentials.getHostedRepository();
 435             var ignored = credentials.getHostedRepository();
 436             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
 437             var censusBuilder = credentials.getCensusBuilder()
 438                                            .addAuthor(author.forge().currentUser().id());
 439             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
 440             var mlBot = MailingListBridgeBot.newBuilder()
 441                                             .from(from)
 442                                             .repo(author)
 443                                             .archive(archive)
 444                                             .censusRepo(censusBuilder.build())
 445                                             .list(listAddress)
 446                                             .ignoredUsers(Set.of(ignored.forge().currentUser().userName()))
 447                                             .listArchive(listServer.getArchive())
 448                                             .smtpServer(listServer.getSMTP())
 449                                             .webrevStorageRepository(archive)
 450                                             .webrevStorageRef(&quot;webrev&quot;)
 451                                             .webrevStorageBase(Path.of(&quot;test&quot;))
 452                                             .webrevStorageBaseUri(webrevServer.uri())
 453                                             .issueTracker(URIBuilder.base(&quot;http://issues.test/browse/&quot;).build())
 454                                             .build();
 455 
 456             // Populate the projects repository
 457             var reviewFile = Path.of(&quot;reviewfile.txt&quot;);
 458             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType(), reviewFile);
 459             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
 460             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
 461             localRepo.push(masterHash, archive.url(), &quot;webrev&quot;, true);
 462 
 463             // Make a change with a corresponding PR
 464             var editHash = CheckableRepository.appendAndCommit(localRepo);
 465             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
 466             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
 467             pr.setBody(&quot;This is now ready&quot;);
 468             TestBotRunner.runPeriodicItems(mlBot);
 469             listServer.processIncoming();
 470 
 471             // And make a file specific comment
 472             var currentMaster = localRepo.resolve(&quot;master&quot;).orElseThrow();
 473             var comment = pr.addReviewComment(masterHash, editHash, reviewFile.toString(), 2, &quot;Review comment&quot;);
 474 
 475             // Add one from an ignored user as well
 476             var ignoredPr = ignored.pullRequest(pr.id());
 477             ignoredPr.addReviewComment(masterHash, editHash, reviewFile.toString(), 2, &quot;Don&#39;t mind me&quot;);
 478 
 479             // Process comments
 480             TestBotRunner.runPeriodicItems(mlBot);
 481             listServer.processIncoming();
 482 
 483             // The archive should now contain an entry
 484             Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);
 485             assertTrue(archiveContains(archiveFolder.path(), &quot;This is a pull request&quot;));
 486             assertTrue(archiveContains(archiveFolder.path(), &quot;This is now ready&quot;));
 487             assertTrue(archiveContains(archiveFolder.path(), &quot;Review comment&quot;));
 488             assertTrue(archiveContains(archiveFolder.path(), &quot;&gt; This is now ready&quot;));
 489             assertTrue(archiveContains(archiveFolder.path(), reviewFile.toString()));
 490             assertFalse(archiveContains(archiveFolder.path(), &quot;Don&#39;t mind me&quot;));
 491 
 492             // The mailing list as well
 493             var mailmanServer = MailingListServerFactory.createMailmanServer(listServer.getArchive(), listServer.getSMTP(), Duration.ZERO);
 494             var mailmanList = mailmanServer.getList(listAddress.address());
 495             var conversations = mailmanList.conversations(Duration.ofDays(1));
 496             assertEquals(1, conversations.size());
 497             var mail = conversations.get(0).first();
 498             assertEquals(&quot;RFR: This is a pull request&quot;, mail.subject());
 499 
 500             // Comment on the comment
 501             pr.addReviewCommentReply(comment, &quot;This is a review reply&quot;);
 502             TestBotRunner.runPeriodicItems(mlBot);
 503             listServer.processIncoming();
 504 
 505             // The archive should contain the additional comment (but no quoted footers)
 506             Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);
 507             assertTrue(archiveContains(archiveFolder.path(), &quot;This is a review reply&quot;));
 508             assertTrue(archiveContains(archiveFolder.path(), &quot;&gt;&gt; This is now ready&quot;));
 509             assertFalse(archiveContains(archiveFolder.path(), &quot;^&gt; PR:&quot;));
 510 
 511             // As well as the mailing list
 512             conversations = mailmanList.conversations(Duration.ofDays(1));
 513             assertEquals(1, conversations.size());
 514             assertEquals(3, conversations.get(0).allMessages().size());
 515             for (var newMail : conversations.get(0).allMessages()) {
 516                 assertEquals(noreplyAddress(archive), newMail.author().address());
 517                 assertEquals(listAddress, newMail.sender());
 518             }
 519         }
 520     }
 521 
 522     @Test
 523     void combineComments(TestInfo testInfo) throws IOException {
 524         try (var credentials = new HostCredentials(testInfo);
 525              var tempFolder = new TemporaryDirectory();
 526              var archiveFolder = new TemporaryDirectory();
 527              var listServer = new TestMailmanServer();
 528              var webrevServer = new TestWebrevServer()) {
 529             var author = credentials.getHostedRepository();
 530             var archive = credentials.getHostedRepository();
 531             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
 532             var censusBuilder = credentials.getCensusBuilder()
 533                                            .addAuthor(author.forge().currentUser().id());
 534             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
 535             var mlBot = MailingListBridgeBot.newBuilder()
 536                                             .from(from)
 537                                             .repo(author)
 538                                             .archive(archive)
 539                                             .censusRepo(censusBuilder.build())
 540                                             .list(listAddress)
 541                                             .listArchive(listServer.getArchive())
 542                                             .smtpServer(listServer.getSMTP())
 543                                             .webrevStorageRepository(archive)
 544                                             .webrevStorageRef(&quot;webrev&quot;)
 545                                             .webrevStorageBase(Path.of(&quot;test&quot;))
 546                                             .webrevStorageBaseUri(webrevServer.uri())
 547                                             .issueTracker(URIBuilder.base(&quot;http://issues.test/browse/&quot;).build())
 548                                             .build();
 549 
 550             // Populate the projects repository
 551             var reviewFile = Path.of(&quot;reviewfile.txt&quot;);
 552             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType(), reviewFile);
 553             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
 554             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
 555             localRepo.push(masterHash, archive.url(), &quot;webrev&quot;, true);
 556 
 557             // Make a change with a corresponding PR
 558             var editHash = CheckableRepository.appendAndCommit(localRepo);
 559             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
 560             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
 561             pr.setBody(&quot;This is now ready&quot;);
 562             pr.addComment(&quot;Avoid combining&quot;);
 563 
 564             TestBotRunner.runPeriodicItems(mlBot);
 565             listServer.processIncoming();
 566             listServer.processIncoming();
 567 
 568             // Make several file specific comments
 569             var first = pr.addReviewComment(masterHash, editHash, reviewFile.toString(), 2, &quot;Review comment&quot;);
 570             var second = pr.addReviewComment(masterHash, editHash, reviewFile.toString(), 2, &quot;Another review comment&quot;);
 571             pr.addReviewComment(masterHash, editHash, reviewFile.toString(), 2, &quot;Further review comment&quot;);
 572             pr.addReviewComment(masterHash, editHash, reviewFile.toString(), 2, &quot;Final review comment&quot;);
 573             TestBotRunner.runPeriodicItems(mlBot);
 574             listServer.processIncoming();
 575 
 576             // The archive should contain a combined entry
 577             Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);
 578             assertEquals(2, archiveContainsCount(archiveFolder.path(), &quot;^On.*wrote:&quot;));
 579 
 580             // As well as the mailing list
 581             var mailmanServer = MailingListServerFactory.createMailmanServer(listServer.getArchive(), listServer.getSMTP(), Duration.ZERO);
 582             var mailmanList = mailmanServer.getList(listAddress.address());
 583             var conversations = mailmanList.conversations(Duration.ofDays(1));
 584             assertEquals(1, conversations.size());
 585             var mail = conversations.get(0).first();
 586             assertEquals(&quot;RFR: This is a pull request&quot;, mail.subject());
 587             assertEquals(3, conversations.get(0).allMessages().size());
 588 
 589             var commentReply = conversations.get(0).replies(mail).get(0);
 590             assertEquals(2, commentReply.body().split(&quot;^On.*wrote:&quot;).length);
 591             assertTrue(commentReply.body().contains(&quot;Avoid combining\n\n&quot;), commentReply.body());
 592 
 593             var reviewReply = conversations.get(0).replies(mail).get(1);
 594             assertEquals(2, reviewReply.body().split(&quot;^On.*wrote:&quot;).length);
 595             assertEquals(2, reviewReply.body().split(&quot;&gt; This is now ready&quot;).length, reviewReply.body());
 596             assertEquals(&quot;RFR: This is a pull request&quot;, reviewReply.subject());
 597             assertTrue(reviewReply.body().contains(&quot;Review comment\n\n&quot;), reviewReply.body());
 598             assertTrue(reviewReply.body().contains(&quot;Another review comment&quot;), reviewReply.body());
 599 
 600             // Now reply to the first and second (collapsed) comment
 601             pr.addReviewCommentReply(first, &quot;I agree&quot;);
 602             pr.addReviewCommentReply(second, &quot;Not with this one though&quot;);
 603             TestBotRunner.runPeriodicItems(mlBot);
 604             listServer.processIncoming();
 605 
 606             // The archive should contain a new entry
 607             Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);
 608             assertEquals(3, archiveContainsCount(archiveFolder.path(), &quot;^On.*wrote:&quot;));
 609 
 610             // The combined review comments should only appear unquoted once
 611             assertEquals(1, archiveContainsCount(archiveFolder.path(), &quot;^Another review comment&quot;));
 612         }
 613     }
 614 
 615     @Test
 616     void commentThreading(TestInfo testInfo) throws IOException {
 617         try (var credentials = new HostCredentials(testInfo);
 618              var tempFolder = new TemporaryDirectory();
 619              var archiveFolder = new TemporaryDirectory();
 620              var listServer = new TestMailmanServer();
 621              var webrevServer = new TestWebrevServer()) {
 622             var author = credentials.getHostedRepository();
 623             var reviewer = credentials.getHostedRepository();
 624             var archive = credentials.getHostedRepository();
 625             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
 626             var censusBuilder = credentials.getCensusBuilder()
 627                                            .addReviewer(reviewer.forge().currentUser().id())
 628                                            .addAuthor(author.forge().currentUser().id());
 629             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
 630             var mlBot = MailingListBridgeBot.newBuilder()
 631                                             .from(from)
 632                                             .repo(author)
 633                                             .archive(archive)
 634                                             .censusRepo(censusBuilder.build())
 635                                             .list(listAddress)
 636                                             .listArchive(listServer.getArchive())
 637                                             .smtpServer(listServer.getSMTP())
 638                                             .webrevStorageRepository(archive)
 639                                             .webrevStorageRef(&quot;webrev&quot;)
 640                                             .webrevStorageBase(Path.of(&quot;test&quot;))
 641                                             .webrevStorageBaseUri(webrevServer.uri())
 642                                             .issueTracker(URIBuilder.base(&quot;http://issues.test/browse/&quot;).build())
 643                                             .build();
 644 
 645             // Populate the projects repository
 646             var reviewFile = Path.of(&quot;reviewfile.txt&quot;);
 647             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType(), reviewFile);
 648             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
 649             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
 650             localRepo.push(masterHash, archive.url(), &quot;webrev&quot;, true);
 651 
 652             // Make a change with a corresponding PR
 653             var editHash = CheckableRepository.appendAndCommit(localRepo);
 654             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
 655             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
 656             pr.setBody(&quot;This is now ready&quot;);
 657             TestBotRunner.runPeriodicItems(mlBot);
 658             listServer.processIncoming();
 659 
 660             // Make a file specific comment
 661             var reviewPr = reviewer.pullRequest(pr.id());
 662             var comment1 = reviewPr.addReviewComment(masterHash, editHash, reviewFile.toString(), 2, &quot;Review comment&quot;);
 663             pr.addReviewCommentReply(comment1, &quot;I agree&quot;);
 664             reviewPr.addReviewCommentReply(comment1, &quot;Great&quot;);
 665             TestBotRunner.runPeriodicItems(mlBot);
 666             listServer.processIncoming();
 667             listServer.processIncoming();
 668             listServer.processIncoming();
 669 
 670             // And a second one by ourselves
 671             var comment2 = pr.addReviewComment(masterHash, editHash, reviewFile.toString(), 2, &quot;Another review comment&quot;);
 672             reviewPr.addReviewCommentReply(comment2, &quot;Sounds good&quot;);
 673             pr.addReviewCommentReply(comment2, &quot;Thanks&quot;);
 674             TestBotRunner.runPeriodicItems(mlBot);
 675             listServer.processIncoming();
 676             listServer.processIncoming();
 677             listServer.processIncoming();
 678 
 679             // Finally some approvals and another comment
 680             pr.addReview(Review.Verdict.APPROVED, &quot;Nice&quot;);
 681             reviewPr.addReviewComment(masterHash, editHash, reviewFile.toString(), 2, &quot;The final review comment&quot;);
 682             reviewPr.addReview(Review.Verdict.APPROVED, &quot;Looks fine&quot;);
 683             reviewPr.addReviewCommentReply(comment2, &quot;You are welcome&quot;);
 684             TestBotRunner.runPeriodicItems(mlBot);
 685             listServer.processIncoming();
 686             listServer.processIncoming();
 687             listServer.processIncoming();
 688 
 689             // Sanity check the archive
 690             Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);
 691             assertEquals(9, archiveContainsCount(archiveFolder.path(), &quot;^On.*wrote:&quot;));
 692 
 693             // File specific comments should appear after the approval
 694             var archiveText = archiveContents(archiveFolder.path()).orElseThrow();
 695             assertTrue(archiveText.indexOf(&quot;Looks fine&quot;) &lt; archiveText.indexOf(&quot;The final review comment&quot;));
 696 
 697             // Check the mailing list
 698             var mailmanServer = MailingListServerFactory.createMailmanServer(listServer.getArchive(), listServer.getSMTP(), Duration.ZERO);
 699             var mailmanList = mailmanServer.getList(listAddress.address());
 700             var conversations = mailmanList.conversations(Duration.ofDays(1));
 701             assertEquals(1, conversations.size());
 702             var mail = conversations.get(0).first();
 703             assertEquals(&quot;RFR: This is a pull request&quot;, mail.subject());
 704             assertEquals(10, conversations.get(0).allMessages().size());
 705 
 706             // There should be four separate threads
 707             var thread1 = conversations.get(0).replies(mail).get(0);
 708             assertEquals(2, thread1.body().split(&quot;^On.*wrote:&quot;).length);
 709             assertEquals(2, thread1.body().split(&quot;&gt; This is now ready&quot;).length, thread1.body());
 710             assertEquals(&quot;RFR: This is a pull request&quot;, thread1.subject());
 711             assertTrue(thread1.body().contains(&quot;Review comment\n\n&quot;), thread1.body());
 712             assertFalse(thread1.body().contains(&quot;Another review comment&quot;), thread1.body());
 713             var thread1reply1 = conversations.get(0).replies(thread1).get(0);
 714             assertTrue(thread1reply1.body().contains(&quot;I agree&quot;));
 715             assertEquals(noreplyAddress(archive), thread1reply1.author().address());
 716             assertEquals(archive.forge().currentUser().fullName(), thread1reply1.author().fullName().orElseThrow());
 717             var thread1reply2 = conversations.get(0).replies(thread1reply1).get(0);
 718             assertTrue(thread1reply2.body().contains(&quot;Great&quot;));
 719             assertEquals(&quot;integrationreviewer1@openjdk.java.net&quot;, thread1reply2.author().address());
 720             assertEquals(&quot;Generated Reviewer 1&quot;, thread1reply2.author().fullName().orElseThrow());
 721 
 722             var thread2 = conversations.get(0).replies(mail).get(1);
 723             assertEquals(2, thread2.body().split(&quot;^On.*wrote:&quot;).length);
 724             assertEquals(2, thread2.body().split(&quot;&gt; This is now ready&quot;).length, thread2.body());
 725             assertEquals(&quot;RFR: This is a pull request&quot;, thread2.subject());
 726             assertFalse(thread2.body().contains(&quot;Review comment\n\n&quot;), thread2.body());
 727             assertTrue(thread2.body().contains(&quot;Another review comment&quot;), thread2.body());
 728             var thread2reply1 = conversations.get(0).replies(thread2).get(0);
 729             assertTrue(thread2reply1.body().contains(&quot;Sounds good&quot;));
 730             var thread2reply2 = conversations.get(0).replies(thread2reply1).get(0);
 731             assertTrue(thread2reply2.body().contains(&quot;Thanks&quot;));
 732 
 733             var replies = conversations.get(0).replies(mail);
 734             var thread3 = replies.get(2);
 735             assertEquals(&quot;RFR: This is a pull request&quot;, thread3.subject());
 736             var thread4 = replies.get(3);
 737             assertEquals(&quot;RFR: This is a pull request&quot;, thread4.subject());
 738             assertTrue(thread4.body().contains(&quot;Looks fine&quot;));
 739             assertTrue(thread4.body().contains(&quot;The final review comment&quot;));
 740             assertTrue(thread4.body().contains(&quot;Marked as reviewed by integrationreviewer1 (Reviewer)&quot;));
 741         }
 742     }
 743 
 744     @Test
 745     void commentThreadingSeparated(TestInfo testInfo) throws IOException {
 746         try (var credentials = new HostCredentials(testInfo);
 747              var tempFolder = new TemporaryDirectory();
 748              var archiveFolder = new TemporaryDirectory();
 749              var listServer = new TestMailmanServer();
 750              var webrevServer = new TestWebrevServer()) {
 751             var author = credentials.getHostedRepository();
 752             var reviewer = credentials.getHostedRepository();
 753             var archive = credentials.getHostedRepository();
 754             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
 755             var censusBuilder = credentials.getCensusBuilder()
 756                                            .addReviewer(reviewer.forge().currentUser().id())
 757                                            .addAuthor(author.forge().currentUser().id());
 758             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
 759             var mlBot = MailingListBridgeBot.newBuilder()
 760                                             .from(from)
 761                                             .repo(author)
 762                                             .archive(archive)
 763                                             .censusRepo(censusBuilder.build())
 764                                             .list(listAddress)
 765                                             .listArchive(listServer.getArchive())
 766                                             .smtpServer(listServer.getSMTP())
 767                                             .webrevStorageRepository(archive)
 768                                             .webrevStorageRef(&quot;webrev&quot;)
 769                                             .webrevStorageBase(Path.of(&quot;test&quot;))
 770                                             .webrevStorageBaseUri(webrevServer.uri())
 771                                             .issueTracker(URIBuilder.base(&quot;http://issues.test/browse/&quot;).build())
 772                                             .build();
 773 
 774             // Populate the projects repository
 775             var reviewFile = Path.of(&quot;reviewfile.txt&quot;);
 776             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType(), reviewFile);
 777             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
 778             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
 779             localRepo.push(masterHash, archive.url(), &quot;webrev&quot;, true);
 780 
 781             // Make a change with a corresponding PR
 782             var editHash = CheckableRepository.appendAndCommit(localRepo);
 783             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
 784             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
 785             pr.setBody(&quot;This is now ready&quot;);
 786             TestBotRunner.runPeriodicItems(mlBot);
 787             listServer.processIncoming();
 788 
 789             // Make two file specific comments
 790             var reviewPr = reviewer.pullRequest(pr.id());
 791             var comment1 = reviewPr.addReviewComment(masterHash, editHash, reviewFile.toString(), 2, &quot;Review comment&quot;);
 792             var comment2 = reviewPr.addReviewComment(masterHash, editHash, reviewFile.toString(), 2, &quot;Another review comment&quot;);
 793             TestBotRunner.runPeriodicItems(mlBot);
 794             listServer.processIncoming();
 795 
 796             pr.addReviewCommentReply(comment1, &quot;I agree&quot;);
 797             pr.addReviewCommentReply(comment2, &quot;I don&#39;t agree&quot;);
 798             TestBotRunner.runPeriodicItems(mlBot);
 799             listServer.processIncoming();
 800 
 801             // Sanity check the archive
 802             Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);
 803             assertEquals(2, archiveContainsCount(archiveFolder.path(), &quot;^On.*wrote:&quot;));
 804         }
 805     }
 806 
 807     @Test
 808     void commentWithMention(TestInfo testInfo) throws IOException {
 809         try (var credentials = new HostCredentials(testInfo);
 810              var tempFolder = new TemporaryDirectory();
 811              var archiveFolder = new TemporaryDirectory();
 812              var listServer = new TestMailmanServer();
 813              var webrevServer = new TestWebrevServer()) {
 814             var author = credentials.getHostedRepository();
 815             var reviewer = credentials.getHostedRepository();
 816             var archive = credentials.getHostedRepository();
 817             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
 818             var censusBuilder = credentials.getCensusBuilder()
 819                                            .addReviewer(reviewer.forge().currentUser().id())
 820                                            .addAuthor(author.forge().currentUser().id());
 821             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
 822             var mlBot = MailingListBridgeBot.newBuilder()
 823                                             .from(from)
 824                                             .repo(author)
 825                                             .archive(archive)
 826                                             .censusRepo(censusBuilder.build())
 827                                             .list(listAddress)
 828                                             .listArchive(listServer.getArchive())
 829                                             .smtpServer(listServer.getSMTP())
 830                                             .webrevStorageRepository(archive)
 831                                             .webrevStorageRef(&quot;webrev&quot;)
 832                                             .webrevStorageBase(Path.of(&quot;test&quot;))
 833                                             .webrevStorageBaseUri(webrevServer.uri())
 834                                             .issueTracker(URIBuilder.base(&quot;http://issues.test/browse/&quot;).build())
 835                                             .build();
 836 
 837             // Populate the projects repository
 838             var reviewFile = Path.of(&quot;reviewfile.txt&quot;);
 839             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType(), reviewFile);
 840             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
 841             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
 842             localRepo.push(masterHash, archive.url(), &quot;webrev&quot;, true);
 843 
 844             // Make a change with a corresponding PR
 845             var editHash = CheckableRepository.appendAndCommit(localRepo);
 846             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
 847             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
 848             pr.setBody(&quot;This is now ready&quot;);
 849             TestBotRunner.runPeriodicItems(mlBot);
 850             listServer.processIncoming();
 851 
 852             // Make two comments from different authors
 853             var reviewPr = reviewer.pullRequest(pr.id());
 854             reviewPr.addComment(&quot;First comment&quot;);
 855             pr.addComment(&quot;Second comment&quot;);
 856 
 857             TestBotRunner.runPeriodicItems(mlBot);
 858             listServer.processIncoming();
 859 
 860             pr.addComment(&quot;@&quot; + reviewer.forge().currentUser().userName() + &quot; reply to first&quot;);
 861             TestBotRunner.runPeriodicItems(mlBot);
 862             listServer.processIncoming();
 863 
 864             // The first comment should be quoted more often than the second
 865             Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);
 866             assertEquals(3, archiveContainsCount(archiveFolder.path(), &quot;First comment&quot;));
 867             assertEquals(1, archiveContainsCount(archiveFolder.path(), &quot;Second comment&quot;));
 868         }
 869     }
 870 
 871     @Test
 872     void reviewCommentWithMention(TestInfo testInfo) throws IOException {
 873         try (var credentials = new HostCredentials(testInfo);
 874              var tempFolder = new TemporaryDirectory();
 875              var archiveFolder = new TemporaryDirectory();
 876              var listServer = new TestMailmanServer();
 877              var webrevServer = new TestWebrevServer()) {
 878             var author = credentials.getHostedRepository();
 879             var reviewer = credentials.getHostedRepository();
 880             var archive = credentials.getHostedRepository();
 881             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
 882             var censusBuilder = credentials.getCensusBuilder()
 883                                            .addReviewer(reviewer.forge().currentUser().id())
 884                                            .addAuthor(author.forge().currentUser().id());
 885             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
 886             var mlBot = MailingListBridgeBot.newBuilder()
 887                                             .from(from)
 888                                             .repo(author)
 889                                             .archive(archive)
 890                                             .censusRepo(censusBuilder.build())
 891                                             .list(listAddress)
 892                                             .listArchive(listServer.getArchive())
 893                                             .smtpServer(listServer.getSMTP())
 894                                             .webrevStorageRepository(archive)
 895                                             .webrevStorageRef(&quot;webrev&quot;)
 896                                             .webrevStorageBase(Path.of(&quot;test&quot;))
 897                                             .webrevStorageBaseUri(webrevServer.uri())
 898                                             .issueTracker(URIBuilder.base(&quot;http://issues.test/browse/&quot;).build())
 899                                             .build();
 900 
 901             // Populate the projects repository
 902             var reviewFile = Path.of(&quot;reviewfile.txt&quot;);
 903             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType(), reviewFile);
 904             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
 905             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
 906             localRepo.push(masterHash, archive.url(), &quot;webrev&quot;, true);
 907 
 908             // Make a change with a corresponding PR
 909             var editHash = CheckableRepository.appendAndCommit(localRepo);
 910             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
 911             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
 912             pr.setBody(&quot;This is now ready&quot;);
 913             TestBotRunner.runPeriodicItems(mlBot);
 914             listServer.processIncoming();
 915 
 916             // Make two review comments from different authors
 917             var reviewPr = reviewer.pullRequest(pr.id());
 918             var comment = reviewPr.addReviewComment(masterHash, editHash, reviewFile.toString(), 2, &quot;Review comment&quot;);
 919             reviewPr.addReviewCommentReply(comment, &quot;First review comment&quot;);
 920             pr.addReviewCommentReply(comment, &quot;Second review comment&quot;);
 921 
 922             TestBotRunner.runPeriodicItems(mlBot);
 923             listServer.processIncoming();
 924 
 925             pr.addReviewCommentReply(comment, &quot;@&quot; + reviewer.forge().currentUser().userName() + &quot; reply to first&quot;);
 926             TestBotRunner.runPeriodicItems(mlBot);
 927             listServer.processIncoming();
 928 
 929             // The first comment should be quoted more often than the second
 930             Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);
 931             assertEquals(3, archiveContainsCount(archiveFolder.path(), &quot;First review comment&quot;));
 932             assertEquals(1, archiveContainsCount(archiveFolder.path(), &quot;Second review comment&quot;));
 933         }
 934     }
 935 
 936     @Test
 937     void commentWithQuote(TestInfo testInfo) throws IOException {
 938         try (var credentials = new HostCredentials(testInfo);
 939              var tempFolder = new TemporaryDirectory();
 940              var archiveFolder = new TemporaryDirectory();
 941              var listServer = new TestMailmanServer();
 942              var webrevServer = new TestWebrevServer()) {
 943             var author = credentials.getHostedRepository();
 944             var reviewer = credentials.getHostedRepository();
 945             var archive = credentials.getHostedRepository();
 946             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
 947             var censusBuilder = credentials.getCensusBuilder()
 948                                            .addReviewer(reviewer.forge().currentUser().id())
 949                                            .addAuthor(author.forge().currentUser().id());
 950             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
 951             var mlBot = MailingListBridgeBot.newBuilder()
 952                                             .from(from)
 953                                             .repo(author)
 954                                             .archive(archive)
 955                                             .censusRepo(censusBuilder.build())
 956                                             .list(listAddress)
 957                                             .listArchive(listServer.getArchive())
 958                                             .smtpServer(listServer.getSMTP())
 959                                             .webrevStorageRepository(archive)
 960                                             .webrevStorageRef(&quot;webrev&quot;)
 961                                             .webrevStorageBase(Path.of(&quot;test&quot;))
 962                                             .webrevStorageBaseUri(webrevServer.uri())
 963                                             .issueTracker(URIBuilder.base(&quot;http://issues.test/browse/&quot;).build())
 964                                             .build();
 965 
 966             // Populate the projects repository
 967             var reviewFile = Path.of(&quot;reviewfile.txt&quot;);
 968             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType(), reviewFile);
 969             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
 970             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
 971             localRepo.push(masterHash, archive.url(), &quot;webrev&quot;, true);
 972 
 973             // Make a change with a corresponding PR
 974             var editHash = CheckableRepository.appendAndCommit(localRepo);
 975             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
 976             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
 977             pr.setBody(&quot;This is now ready&quot;);
 978             TestBotRunner.runPeriodicItems(mlBot);
 979             listServer.processIncoming();
 980 
 981             // Make two comments from different authors
 982             var reviewPr = reviewer.pullRequest(pr.id());
 983             reviewPr.addComment(&quot;First comment\nsecond line&quot;);
 984             pr.addComment(&quot;Second comment\nfourth line&quot;);
 985 
 986             TestBotRunner.runPeriodicItems(mlBot);
 987             listServer.processIncoming();
 988 
 989             pr.addComment(&quot;&gt;First comm\n\nreply to first&quot;);
 990             TestBotRunner.runPeriodicItems(mlBot);
 991             listServer.processIncoming();
 992 
 993             // The first comment should be quoted more often than the second
 994             Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);
 995             assertEquals(2, archiveContainsCount(archiveFolder.path(), &quot;First comment&quot;));
 996             assertEquals(3, archiveContainsCount(archiveFolder.path(), &quot;First comm&quot;));
 997             assertEquals(1, archiveContainsCount(archiveFolder.path(), &quot;Second comment&quot;));
 998         }
 999     }
1000 
1001     @Test
1002     void reviewContext(TestInfo testInfo) throws IOException {
1003         try (var credentials = new HostCredentials(testInfo);
1004              var tempFolder = new TemporaryDirectory();
1005              var archiveFolder = new TemporaryDirectory();
1006              var listServer = new TestMailmanServer();
1007              var webrevServer = new TestWebrevServer()) {
1008             var author = credentials.getHostedRepository();
1009             var archive = credentials.getHostedRepository();
1010             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
1011             var censusBuilder = credentials.getCensusBuilder()
1012                                            .addAuthor(author.forge().currentUser().id());
1013             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
1014             var mlBot = MailingListBridgeBot.newBuilder()
1015                                             .from(from)
1016                                             .repo(author)
1017                                             .archive(archive)
1018                                             .censusRepo(censusBuilder.build())
1019                                             .list(listAddress)
1020                                             .listArchive(listServer.getArchive())
1021                                             .smtpServer(listServer.getSMTP())
1022                                             .webrevStorageRepository(archive)
1023                                             .webrevStorageRef(&quot;webrev&quot;)
1024                                             .webrevStorageBase(Path.of(&quot;test&quot;))
1025                                             .webrevStorageBaseUri(webrevServer.uri())
1026                                             .issueTracker(URIBuilder.base(&quot;http://issues.test/browse/&quot;).build())
1027                                             .build();
1028 
1029             // Populate the projects repository
1030             var reviewFile = Path.of(&quot;reviewfile.txt&quot;);
1031             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType(), reviewFile);
1032             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
1033             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
1034             localRepo.push(masterHash, archive.url(), &quot;webrev&quot;, true);
1035 
1036             // Make a change with a corresponding PR
1037             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;Line 1\nLine 2\nLine 3\nLine 4&quot;);
1038             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
1039             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
1040             pr.setBody(&quot;This is now ready&quot;);
1041             TestBotRunner.runPeriodicItems(mlBot);
1042             listServer.processIncoming();
1043 
1044             // Make a file specific comment
1045             pr.addReviewComment(masterHash, editHash, reviewFile.toString(), 2, &quot;Review comment&quot;);
1046 
1047             TestBotRunner.runPeriodicItems(mlBot);
1048             listServer.processIncoming();
1049 
1050             // The archive should only contain context around line 2
1051             Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);
1052             assertTrue(archiveContains(archiveFolder.path(), &quot;^&gt; 2: Line 1$&quot;));
1053             assertTrue(archiveContains(archiveFolder.path(), &quot;^&gt; 3: Line 2$&quot;));
1054             assertFalse(archiveContains(archiveFolder.path(), &quot;^&gt; 4: Line 3$&quot;));
1055         }
1056     }
1057 
1058     @Test
1059     void multipleReviewContexts(TestInfo testInfo) throws IOException {
1060         try (var credentials = new HostCredentials(testInfo);
1061              var tempFolder = new TemporaryDirectory();
1062              var archiveFolder = new TemporaryDirectory();
1063              var listServer = new TestMailmanServer();
1064              var webrevServer = new TestWebrevServer()) {
1065             var author = credentials.getHostedRepository();
1066             var archive = credentials.getHostedRepository();
1067             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
1068             var censusBuilder = credentials.getCensusBuilder()
1069                                            .addAuthor(author.forge().currentUser().id());
1070             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
1071             var mlBot = MailingListBridgeBot.newBuilder()
1072                                             .from(from)
1073                                             .repo(author)
1074                                             .archive(archive)
1075                                             .censusRepo(censusBuilder.build())
1076                                             .list(listAddress)
1077                                             .listArchive(listServer.getArchive())
1078                                             .smtpServer(listServer.getSMTP())
1079                                             .webrevStorageRepository(archive)
1080                                             .webrevStorageRef(&quot;webrev&quot;)
1081                                             .webrevStorageBase(Path.of(&quot;test&quot;))
1082                                             .webrevStorageBaseUri(webrevServer.uri())
1083                                             .issueTracker(URIBuilder.base(&quot;http://issues.test/browse/&quot;).build())
1084                                             .build();
1085 
1086             // Populate the projects repository
1087             var reviewFile = Path.of(&quot;reviewfile.txt&quot;);
1088             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType(), reviewFile);
1089             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
1090             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
1091             localRepo.push(masterHash, archive.url(), &quot;webrev&quot;, true);
1092             var initialHash = CheckableRepository.appendAndCommit(localRepo,
1093                                                                   &quot;Line 0.1\nLine 0.2\nLine 0.3\nLine 0.4\n&quot; +
1094                                                                           &quot;Line 1\nLine 2\nLine 3\nLine 4\n&quot; +
1095                                                                           &quot;Line 5\nLine 6\nLine 7\nLine 8\n&quot; +
1096                                                                           &quot;Line 8.1\nLine 8.2\nLine 8.3\nLine 8.4\n&quot; +
1097                                                                           &quot;Line 9\nLine 10\nLine 11\nLine 12\n&quot; +
1098                                                                           &quot;Line 13\nLine 14\nLine 15\nLine 16\n&quot;);
1099             localRepo.push(initialHash, author.url(), &quot;master&quot;);
1100 
1101             // Make a change with a corresponding PR
1102             var current = Files.readString(localRepo.root().resolve(reviewFile), StandardCharsets.UTF_8);
1103             var updated = current.replaceAll(&quot;Line 2&quot;, &quot;Line 2 edit\nLine 2.5&quot;);
1104             updated = updated.replaceAll(&quot;Line 13&quot;, &quot;Line 12.5\nLine 13 edit&quot;);
1105             Files.writeString(localRepo.root().resolve(reviewFile), updated, StandardCharsets.UTF_8);
1106             var editHash = CheckableRepository.appendAndCommit(localRepo);
1107             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
1108             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
1109             pr.setBody(&quot;This is now ready&quot;);
1110             TestBotRunner.runPeriodicItems(mlBot);
1111             listServer.processIncoming();
1112 
1113             // Make file specific comments
1114             pr.addReviewComment(masterHash, editHash, reviewFile.toString(), 7, &quot;Review comment&quot;);
1115             pr.addReviewComment(masterHash, editHash, reviewFile.toString(), 24, &quot;Another review comment&quot;);
1116 
1117             TestBotRunner.runPeriodicItems(mlBot);
1118             listServer.processIncoming();
1119 
1120             // The archive should only contain context around line 2 and 20
1121             Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);
1122             assertTrue(archiveContains(archiveFolder.path(), &quot;reviewfile.txt line 7&quot;));
1123             assertTrue(archiveContains(archiveFolder.path(), &quot;^&gt; 6: Line 1$&quot;));
1124             assertTrue(archiveContains(archiveFolder.path(), &quot;^&gt; 7: Line 2 edit$&quot;));
1125             assertFalse(archiveContains(archiveFolder.path(), &quot;Line 3&quot;));
1126 
1127             assertTrue(archiveContains(archiveFolder.path(), &quot;reviewfile.txt line 24&quot;));
1128             assertTrue(archiveContains(archiveFolder.path(), &quot;^&gt; 23: Line 12.5$&quot;));
1129             assertTrue(archiveContains(archiveFolder.path(), &quot;^&gt; 24: Line 13 edit$&quot;));
1130             assertFalse(archiveContains(archiveFolder.path(), &quot;^Line 15&quot;));
1131         }
1132     }
1133 
1134     @Test
1135     void filterComments(TestInfo testInfo) throws IOException {
1136         try (var credentials = new HostCredentials(testInfo);
1137              var tempFolder = new TemporaryDirectory();
1138              var archiveFolder = new TemporaryDirectory();
1139              var listServer = new TestMailmanServer();
1140              var webrevServer = new TestWebrevServer()) {
1141             var author = credentials.getHostedRepository();
1142             var archive = credentials.getHostedRepository();
1143             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
1144             var censusBuilder = credentials.getCensusBuilder()
1145                                            .addAuthor(author.forge().currentUser().id());
1146             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
1147             var mlBot = MailingListBridgeBot.newBuilder()
1148                                             .from(from)
1149                                             .repo(author)
1150                                             .archive(archive)
1151                                             .censusRepo(censusBuilder.build())
1152                                             .list(listAddress)
1153                                             .listArchive(listServer.getArchive())
1154                                             .smtpServer(listServer.getSMTP())
1155                                             .webrevStorageRepository(archive)
1156                                             .webrevStorageRef(&quot;webrev&quot;)
1157                                             .webrevStorageBase(Path.of(&quot;test&quot;))
1158                                             .webrevStorageBaseUri(webrevServer.uri())
1159                                             .issueTracker(URIBuilder.base(&quot;http://issues.test/browse/&quot;).build())
1160                                             .build();
1161 
1162             // Populate the projects repository
1163             var reviewFile = Path.of(&quot;reviewfile.txt&quot;);
1164             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType(), reviewFile);
1165             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
1166             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
1167             localRepo.push(masterHash, archive.url(), &quot;webrev&quot;, true);
1168 
1169             // Make a change with a corresponding PR
1170             var editHash = CheckableRepository.appendAndCommit(localRepo);
1171             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
1172             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
1173             pr.setBody(&quot;This is now ready\n&lt;!-- this is a comment --&gt;\nAnd this is not\n&quot; +
1174                                &quot;&lt;!-- Anything below this marker will be hidden --&gt;\nStatus stuff&quot;);
1175 
1176             // Make a bunch of comments
1177             pr.addComment(&quot;Plain comment\n&lt;!-- this is a comment --&gt;&quot;);
1178             pr.addReviewComment(masterHash, editHash, reviewFile.toString(), 2, &quot;Review comment &lt;!-- this is a comment --&gt;\n&quot;);
1179             pr.addComment(&quot;/integrate stuff&quot;);
1180             TestBotRunner.runPeriodicItems(mlBot);
1181 
1182             // Run an archive pass
1183             TestBotRunner.runPeriodicItems(mlBot);
1184 
1185             // The archive should not contain the comment
1186             Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);
1187             assertTrue(archiveContains(archiveFolder.path(), &quot;This is now ready&quot;));
1188             assertFalse(archiveContains(archiveFolder.path(), &quot;this is a comment&quot;));
1189             assertFalse(archiveContains(archiveFolder.path(), &quot;Status stuff&quot;));
1190             assertTrue(archiveContains(archiveFolder.path(), &quot;And this is not&quot;));
1191             assertFalse(archiveContains(archiveFolder.path(), &quot;&lt;!--&quot;));
1192             assertFalse(archiveContains(archiveFolder.path(), &quot;--&gt;&quot;));
1193             assertTrue(archiveContains(archiveFolder.path(), &quot;Plain comment&quot;));
1194             assertTrue(archiveContains(archiveFolder.path(), &quot;Review comment&quot;));
1195             assertFalse(archiveContains(archiveFolder.path(), &quot;/integrate&quot;));
1196         }
1197     }
1198 
1199     @Test
1200     void incrementalChanges(TestInfo testInfo) throws IOException {
1201         try (var credentials = new HostCredentials(testInfo);
1202              var tempFolder = new TemporaryDirectory();
1203              var archiveFolder = new TemporaryDirectory();
1204              var listServer = new TestMailmanServer();
1205              var webrevServer = new TestWebrevServer()) {
1206             var author = credentials.getHostedRepository();
1207             var archive = credentials.getHostedRepository();
1208             var commenter = credentials.getHostedRepository();
1209             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
1210             var censusBuilder = credentials.getCensusBuilder()
1211                                            .addAuthor(author.forge().currentUser().id());
1212             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
1213             var mlBot = MailingListBridgeBot.newBuilder()
1214                                             .from(from)
1215                                             .repo(author)
1216                                             .archive(archive)
1217                                             .censusRepo(censusBuilder.build())
1218                                             .list(listAddress)
1219                                             .listArchive(listServer.getArchive())
1220                                             .smtpServer(listServer.getSMTP())
1221                                             .webrevStorageRepository(archive)
1222                                             .webrevStorageRef(&quot;webrev&quot;)
1223                                             .webrevStorageBase(Path.of(&quot;test&quot;))
1224                                             .webrevStorageBaseUri(webrevServer.uri())
1225                                             .issueTracker(URIBuilder.base(&quot;http://issues.test/browse/&quot;).build())
1226                                             .build();
1227 
1228             // Populate the projects repository
1229             var reviewFile = Path.of(&quot;reviewfile.txt&quot;);
1230             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType(), reviewFile);
1231             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
1232             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
1233             localRepo.push(masterHash, archive.url(), &quot;webrev&quot;, true);
1234 
1235             // Make a change with a corresponding PR
1236             var editHash = CheckableRepository.appendAndCommit(localRepo);
1237             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
1238             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
1239             pr.setBody(&quot;This is now ready&quot;);
1240 
1241             // Run an archive pass
1242             TestBotRunner.runPeriodicItems(mlBot);
1243             listServer.processIncoming();
1244 
1245             var nextHash = CheckableRepository.appendAndCommit(localRepo, &quot;Yet one more line&quot;, &quot;Fixing&quot;);
1246             localRepo.push(nextHash, author.url(), &quot;edit&quot;);
1247 
1248             // Make sure that the push registered
1249             var lastHeadHash = pr.headHash();
1250             var refreshCount = 0;
1251             do {
1252                 pr = author.pullRequest(pr.id());
1253                 if (refreshCount++ &gt; 100) {
1254                     fail(&quot;The PR did not update after the new push&quot;);
1255                 }
1256             } while (pr.headHash().equals(lastHeadHash));
1257 
1258             // Run another archive pass
1259             TestBotRunner.runPeriodicItems(mlBot);
1260             TestBotRunner.runPeriodicItems(mlBot);
1261             TestBotRunner.runPeriodicItems(mlBot);
1262             listServer.processIncoming();
1263 
1264             // The archive should reference the updated push
1265             Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);
1266             assertTrue(archiveContains(archiveFolder.path(), &quot;has updated the pull request incrementally&quot;));
1267             assertTrue(archiveContains(archiveFolder.path(), &quot;full.*/&quot; + pr.id() + &quot;/webrev.01&quot;));
1268             assertTrue(archiveContains(archiveFolder.path(), &quot;inc.*/&quot; + pr.id() + &quot;/webrev.00-01&quot;));
1269             assertTrue(archiveContains(archiveFolder.path(), &quot;Patch&quot;));
1270             assertTrue(archiveContains(archiveFolder.path(), &quot;Fetch&quot;));
1271             assertTrue(archiveContains(archiveFolder.path(), &quot;Fixing&quot;));
1272 
1273             // The webrev comment should be updated
1274             var comments = pr.comments();
1275             var webrevComments = comments.stream()
1276                                          .filter(comment -&gt; comment.author().equals(author.forge().currentUser()))
1277                                          .filter(comment -&gt; comment.body().contains(&quot;webrev&quot;))
1278                                          .filter(comment -&gt; comment.body().contains(&quot;Full&quot;))
1279                                          .filter(comment -&gt; comment.body().contains(&quot;Incremental&quot;))
1280                                          .filter(comment -&gt; comment.body().contains(nextHash.hex()))
1281                                          .filter(comment -&gt; comment.body().contains(editHash.hex()))
1282                                          .collect(Collectors.toList());
1283             assertEquals(1, webrevComments.size());
1284 
1285             // Check that sender address is set properly
1286             var mailmanServer = MailingListServerFactory.createMailmanServer(listServer.getArchive(), listServer.getSMTP(), Duration.ZERO);
1287             var mailmanList = mailmanServer.getList(listAddress.address());
1288             var conversations = mailmanList.conversations(Duration.ofDays(1));
1289             assertEquals(1, conversations.size());
1290             for (var newMail : conversations.get(0).allMessages()) {
1291                 assertEquals(noreplyAddress(archive), newMail.author().address());
1292                 assertEquals(listAddress, newMail.sender());
1293             }
1294 
1295             // Add a comment
1296             var commenterPr = commenter.pullRequest(pr.id());
1297             commenterPr.addReviewComment(masterHash, nextHash, reviewFile.toString(), 2, &quot;Review comment&quot;);
1298             TestBotRunner.runPeriodicItems(mlBot);
1299             listServer.processIncoming();
1300 
1301             // Ensure that additional updates are only reported once
1302             for (int i = 0; i &lt; 3; ++i) {
1303                 var anotherHash = CheckableRepository.appendAndCommit(localRepo, &quot;Another line&quot;, &quot;Fixing&quot;);
1304                 localRepo.push(anotherHash, author.url(), &quot;edit&quot;);
1305 
1306                 // Make sure that the push registered
1307                 lastHeadHash = pr.headHash();
1308                 refreshCount = 0;
1309                 do {
1310                     pr = author.pullRequest(pr.id());
1311                     if (refreshCount++ &gt; 100) {
1312                         fail(&quot;The PR did not update after the new push&quot;);
1313                     }
1314                 } while (pr.headHash().equals(lastHeadHash));
1315 
1316                 TestBotRunner.runPeriodicItems(mlBot);
1317                 TestBotRunner.runPeriodicItems(mlBot);
1318                 listServer.processIncoming();
1319             }
1320             var updatedConversations = mailmanList.conversations(Duration.ofDays(1));
1321             assertEquals(1, updatedConversations.size());
1322             var conversation = updatedConversations.get(0);
1323             assertEquals(6, conversation.allMessages().size());
1324             assertEquals(&quot;[Rev 01] RFR: This is a pull request&quot;, conversation.allMessages().get(1).subject());
1325             assertEquals(&quot;[Rev 01] RFR: This is a pull request&quot;, conversation.allMessages().get(2).subject(), conversation.allMessages().get(2).toString());
1326             assertEquals(&quot;[Rev 04] RFR: This is a pull request&quot;, conversation.allMessages().get(5).subject());
1327         }
1328     }
1329 
1330     @Test
1331     void rebased(TestInfo testInfo) throws IOException {
1332         try (var credentials = new HostCredentials(testInfo);
1333              var tempFolder = new TemporaryDirectory();
1334              var archiveFolder = new TemporaryDirectory();
1335              var listServer = new TestMailmanServer();
1336              var webrevServer = new TestWebrevServer()) {
1337             var author = credentials.getHostedRepository();
1338             var archive = credentials.getHostedRepository();
1339             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
1340             var censusBuilder = credentials.getCensusBuilder()
1341                                            .addAuthor(author.forge().currentUser().id());
1342             var sender = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
1343             var mlBot = MailingListBridgeBot.newBuilder()
1344                                             .from(sender)
1345                                             .repo(author)
1346                                             .archive(archive)
1347                                             .censusRepo(censusBuilder.build())
1348                                             .list(listAddress)
1349                                             .listArchive(listServer.getArchive())
1350                                             .smtpServer(listServer.getSMTP())
1351                                             .webrevStorageRepository(archive)
1352                                             .webrevStorageRef(&quot;webrev&quot;)
1353                                             .webrevStorageBase(Path.of(&quot;test&quot;))
1354                                             .webrevStorageBaseUri(webrevServer.uri())
1355                                             .issueTracker(URIBuilder.base(&quot;http://issues.test/browse/&quot;).build())
1356                                             .build();
1357 
1358             // Populate the projects repository
1359             var reviewFile = Path.of(&quot;reviewfile.txt&quot;);
1360             var localRepo = CheckableRepository.init(tempFolder.path().resolve(&quot;first&quot;), author.repositoryType(), reviewFile);
1361             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
1362             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
1363             localRepo.push(masterHash, archive.url(), &quot;webrev&quot;, true);
1364 
1365             // Make a change with a corresponding PR
1366             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;A line&quot;, &quot;Original msg&quot;);
1367             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
1368             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
1369             pr.setBody(&quot;This is now ready&quot;);
1370 
1371             // Run an archive pass
1372             TestBotRunner.runPeriodicItems(mlBot);
1373             listServer.processIncoming();
1374 
1375             var newLocalRepo = Repository.materialize(tempFolder.path().resolve(&quot;second&quot;), author.url(), &quot;master&quot;);
1376             var newEditHash = CheckableRepository.appendAndCommit(newLocalRepo, &quot;Another line&quot;, &quot;Replaced msg&quot;);
1377             newLocalRepo.push(newEditHash, author.url(), &quot;edit&quot;, true);
1378 
1379             // Make sure that the push registered
1380             var lastHeadHash = pr.headHash();
1381             var refreshCount = 0;
1382             do {
1383                 pr = author.pullRequest(pr.id());
1384                 if (refreshCount++ &gt; 100) {
1385                     fail(&quot;The PR did not update after the new push&quot;);
1386                 }
1387             } while (pr.headHash().equals(lastHeadHash));
1388 
1389             // Run another archive pass
1390             TestBotRunner.runPeriodicItems(mlBot);
1391             listServer.processIncoming();
1392 
1393             // The archive should reference the rebased push
1394             Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);
1395             assertTrue(archiveContains(archiveFolder.path(), &quot;has updated the pull request with a new target base&quot;));
1396             assertTrue(archiveContains(archiveFolder.path(), pr.id() + &quot;/webrev.01&quot;));
1397             assertFalse(archiveContains(archiveFolder.path(), &quot;Incremental&quot;));
1398             assertTrue(archiveContains(archiveFolder.path(), &quot;Patch&quot;));
1399             assertTrue(archiveContains(archiveFolder.path(), &quot;Fetch&quot;));
1400             assertTrue(archiveContains(archiveFolder.path(), &quot;Original msg&quot;));
1401             assertTrue(archiveContains(archiveFolder.path(), &quot;Replaced msg&quot;));
1402 
1403             // The webrev comment should be updated
1404             var comments = pr.comments();
1405             var webrevComments = comments.stream()
1406                                          .filter(comment -&gt; comment.author().equals(author.forge().currentUser()))
1407                                          .filter(comment -&gt; comment.body().contains(&quot;webrev&quot;))
1408                                          .filter(comment -&gt; comment.body().contains(newEditHash.hex()))
1409                                          .collect(Collectors.toList());
1410             assertEquals(1, webrevComments.size());
1411 
1412             // Check that sender address is set properly
1413             var mailmanServer = MailingListServerFactory.createMailmanServer(listServer.getArchive(), listServer.getSMTP(), Duration.ZERO);
1414             var mailmanList = mailmanServer.getList(listAddress.address());
1415             var conversations = mailmanList.conversations(Duration.ofDays(1));
1416             assertEquals(1, conversations.size());
1417             for (var newMail : conversations.get(0).allMessages()) {
1418                 assertEquals(noreplyAddress(archive), newMail.author().address());
1419                 assertEquals(listAddress, newMail.sender());
1420                 assertFalse(newMail.hasHeader(&quot;PR-Head-Hash&quot;));
1421             }
1422             assertEquals(&quot;[Rev 01] RFR: This is a pull request&quot;, conversations.get(0).allMessages().get(1).subject());
1423         }
1424     }
1425 
1426     @Test
1427     void incrementalAfterRebase(TestInfo testInfo) throws IOException {
1428         try (var credentials = new HostCredentials(testInfo);
1429              var tempFolder = new TemporaryDirectory();
1430              var archiveFolder = new TemporaryDirectory();
1431              var listServer = new TestMailmanServer();
1432              var webrevServer = new TestWebrevServer()) {
1433             var author = credentials.getHostedRepository();
1434             var archive = credentials.getHostedRepository();
1435             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
1436             var censusBuilder = credentials.getCensusBuilder()
1437                                            .addAuthor(author.forge().currentUser().id());
1438             var sender = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
1439             var mlBot = MailingListBridgeBot.newBuilder()
1440                                             .from(sender)
1441                                             .repo(author)
1442                                             .archive(archive)
1443                                             .archiveRef(&quot;archive&quot;)
1444                                             .censusRepo(censusBuilder.build())
1445                                             .list(listAddress)
1446                                             .listArchive(listServer.getArchive())
1447                                             .smtpServer(listServer.getSMTP())
1448                                             .webrevStorageRepository(archive)
1449                                             .webrevStorageRef(&quot;webrev&quot;)
1450                                             .webrevStorageBase(Path.of(&quot;test&quot;))
1451                                             .webrevStorageBaseUri(webrevServer.uri())
1452                                             .issueTracker(URIBuilder.base(&quot;http://issues.test/browse/&quot;).build())
1453                                             .build();
1454 
1455             // Populate the projects repository
1456             var reviewFile = Path.of(&quot;reviewfile.txt&quot;);
1457             var localRepo = CheckableRepository.init(tempFolder.path().resolve(&quot;first&quot;), author.repositoryType(), reviewFile);
1458             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
1459             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
1460             localRepo.push(masterHash, archive.url(), &quot;webrev&quot;, true);
1461             localRepo.push(masterHash, archive.url(), &quot;archive&quot;, true);
1462 
1463             // Make a change with a corresponding PR
1464             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;A line&quot;, &quot;Original msg&quot;);
1465             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
1466             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
1467             pr.setBody(&quot;This is now ready&quot;);
1468 
1469             // Run an archive pass
1470             TestBotRunner.runPeriodicItems(mlBot);
1471             listServer.processIncoming();
1472 
1473             // Push more stuff to master
1474             localRepo.checkout(masterHash, true);
1475             var unrelatedFile = localRepo.root().resolve(&quot;unrelated.txt&quot;);
1476             Files.writeString(unrelatedFile, &quot;Other things happens in master&quot;);
1477             localRepo.add(unrelatedFile);
1478             var newMasterHash = localRepo.commit(&quot;Unrelated change&quot;, &quot;duke&quot;, &quot;duke@openjdk.org&quot;);
1479             localRepo.push(newMasterHash, author.url(), &quot;master&quot;);
1480 
1481             // And more stuff to the pr branch
1482             localRepo.checkout(editHash, true);
1483             CheckableRepository.appendAndCommit(localRepo, &quot;Another line&quot;, &quot;More updates&quot;);
1484 
1485             // Merge master
1486             localRepo.merge(newMasterHash);
1487             var newEditHash = localRepo.commit(&quot;Latest changes from master&quot;, &quot;duke&quot;, &quot;duke@openjdk.org&quot;);
1488             localRepo.push(newEditHash, author.url(), &quot;edit&quot;);
1489 
1490             // Make sure that the push registered
1491             var lastHeadHash = pr.headHash();
1492             var refreshCount = 0;
1493             do {
1494                 pr = author.pullRequest(pr.id());
1495                 if (refreshCount++ &gt; 100) {
1496                     fail(&quot;The PR did not update after the new push&quot;);
1497                 }
1498             } while (pr.headHash().equals(lastHeadHash));
1499 
1500             // Run another archive pass
1501             TestBotRunner.runPeriodicItems(mlBot);
1502             listServer.processIncoming();
1503 
1504             // The archive should reference the rebased push
1505             Repository.materialize(archiveFolder.path(), archive.url(), &quot;archive&quot;);
1506             assertTrue(archiveContains(archiveFolder.path(), &quot;has updated the pull request with a new target base&quot;));
1507             assertTrue(archiveContains(archiveFolder.path(), &quot;excludes&quot;));
1508             assertTrue(archiveContains(archiveFolder.path(), pr.id() + &quot;/webrev.01&quot;));
1509             assertTrue(archiveContains(archiveFolder.path(), pr.id() + &quot;/webrev.00-01&quot;));
1510             assertTrue(archiveContains(archiveFolder.path(), &quot;Original msg&quot;));
1511             assertTrue(archiveContains(archiveFolder.path(), &quot;More updates&quot;));
1512         }
1513     }
1514 
1515     @Test
1516     void mergeWebrev(TestInfo testInfo) throws IOException {
1517         try (var credentials = new HostCredentials(testInfo);
1518              var tempFolder = new TemporaryDirectory();
1519              var archiveFolder = new TemporaryDirectory();
1520              var listServer = new TestMailmanServer();
1521              var webrevServer = new TestWebrevServer()) {
1522             var author = credentials.getHostedRepository();
1523             var archive = credentials.getHostedRepository();
1524             var commenter = credentials.getHostedRepository();
1525             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
1526             var censusBuilder = credentials.getCensusBuilder()
1527                                            .addAuthor(author.forge().currentUser().id());
1528             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
1529             var mlBot = MailingListBridgeBot.newBuilder()
1530                                             .from(from)
1531                                             .repo(author)
1532                                             .archive(archive)
1533                                             .archiveRef(&quot;archive&quot;)
1534                                             .censusRepo(censusBuilder.build())
1535                                             .list(listAddress)
1536                                             .listArchive(listServer.getArchive())
1537                                             .smtpServer(listServer.getSMTP())
1538                                             .webrevStorageRepository(archive)
1539                                             .webrevStorageRef(&quot;webrev&quot;)
1540                                             .webrevStorageBase(Path.of(&quot;test&quot;))
1541                                             .webrevStorageBaseUri(webrevServer.uri())
1542                                             .issueTracker(URIBuilder.base(&quot;http://issues.test/browse/&quot;).build())
1543                                             .build();
1544 
1545             // Populate the projects repository
1546             var reviewFile = Path.of(&quot;reviewfile.txt&quot;);
1547             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType(), reviewFile);
1548             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
1549             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
1550             localRepo.push(masterHash, archive.url(), &quot;archive&quot;, true);
1551             localRepo.push(masterHash, archive.url(), &quot;webrev&quot;, true);
1552 
1553             // Create a merge
1554             var editOnlyFile = Path.of(&quot;editonly.txt&quot;);
1555             Files.writeString(localRepo.root().resolve(editOnlyFile), &quot;Only added in the edit&quot;);
1556             localRepo.add(editOnlyFile);
1557             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;Edited&quot;);
1558             localRepo.checkout(masterHash, true);
1559             var masterOnlyFile = Path.of(&quot;masteronly.txt&quot;);
1560             Files.writeString(localRepo.root().resolve(masterOnlyFile), &quot;Only added in master&quot;);
1561             localRepo.add(masterOnlyFile);
1562             var updatedMasterHash = CheckableRepository.appendAndCommit(localRepo, &quot;Master change&quot;);
1563             localRepo.push(updatedMasterHash, author.url(), &quot;master&quot;);
1564             localRepo.merge(editHash, &quot;ours&quot;);
1565             var mergeCommit = localRepo.commit(&quot;Merged edit&quot;, &quot;duke&quot;, &quot;duke@openjdk.java.net&quot;);
1566             var mergeOnlyFile = Path.of(&quot;mergeonly.txt&quot;);
1567             Files.writeString(localRepo.root().resolve(mergeOnlyFile), &quot;Only added in the merge&quot;);
1568             localRepo.add(mergeOnlyFile);
1569             Files.writeString(localRepo.root().resolve(reviewFile), &quot;Overwriting the conflict resolution&quot;);
1570             localRepo.add(reviewFile);
1571             var appendedCommit = localRepo.amend(&quot;Updated merge commit&quot;, &quot;duke&quot;, &quot;duke@openjdk.java.net&quot;);
1572             localRepo.push(appendedCommit, author.url(), &quot;edit&quot;, true);
1573 
1574             // Make a merge PR
1575             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;Merge edit&quot;);
1576             pr.setBody(&quot;This is now ready&quot;);
1577 
1578             // Run an archive pass
1579             TestBotRunner.runPeriodicItems(mlBot);
1580             listServer.processIncoming();
1581 
1582             // The archive should contain a merge style webrev
1583             Repository.materialize(archiveFolder.path(), archive.url(), &quot;archive&quot;);
1584             assertTrue(archiveContains(archiveFolder.path(), &quot;webrevs contain only the adjustments&quot;));
1585             assertTrue(archiveContains(archiveFolder.path(), pr.id() + &quot;/webrev.00.0&quot;));
1586             assertTrue(archiveContains(archiveFolder.path(), &quot;3 lines in 2 files changed: 1 ins; 1 del; 1 mod&quot;));
1587 
1588             // The PR should contain a webrev comment
1589             assertEquals(1, pr.comments().size());
1590             var webrevComment = pr.comments().get(0);
1591             assertTrue(webrevComment.body().contains(&quot;Merge target&quot;));
1592             assertTrue(webrevComment.body().contains(&quot;Merge source&quot;));
1593         }
1594     }
1595 
1596     @Test
1597     void skipAddingExistingWebrev(TestInfo testInfo) throws IOException {
1598         try (var credentials = new HostCredentials(testInfo);
1599              var tempFolder = new TemporaryDirectory();
1600              var archiveFolder = new TemporaryDirectory();
1601              var webrevFolder = new TemporaryDirectory();
1602              var listServer = new TestMailmanServer();
1603              var webrevServer = new TestWebrevServer()) {
1604             var author = credentials.getHostedRepository();
1605             var archive = credentials.getHostedRepository();
1606             var ignored = credentials.getHostedRepository();
1607             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
1608             var censusBuilder = credentials.getCensusBuilder()
1609                                            .addAuthor(author.forge().currentUser().id());
1610             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
1611             var mlBot = MailingListBridgeBot.newBuilder()
1612                                             .from(from)
1613                                             .repo(author)
1614                                             .archive(archive)
1615                                             .censusRepo(censusBuilder.build())
1616                                             .list(listAddress)
1617                                             .ignoredUsers(Set.of(ignored.forge().currentUser().userName()))
1618                                             .listArchive(listServer.getArchive())
1619                                             .smtpServer(listServer.getSMTP())
1620                                             .webrevStorageRepository(archive)
1621                                             .webrevStorageRef(&quot;webrev&quot;)
1622                                             .webrevStorageBase(Path.of(&quot;test&quot;))
1623                                             .webrevStorageBaseUri(webrevServer.uri())
1624                                             .issueTracker(URIBuilder.base(&quot;http://issues.test/browse/&quot;).build())
1625                                             .build();
1626 
1627             // Populate the projects repository
1628             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType());
1629             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
1630             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
1631             localRepo.push(masterHash, archive.url(), &quot;webrev&quot;, true);
1632 
1633             // Make a change with a corresponding PR
1634             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;A simple change&quot;,
1635                                                                &quot;Change msg\n\nWith several lines&quot;);
1636             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
1637             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
1638 
1639             // Flag it as ready for review
1640             pr.setBody(&quot;This should now be ready&quot;);
1641 
1642             // Run an archive pass
1643             TestBotRunner.runPeriodicItems(mlBot);
1644 
1645             // The archive should now contain an entry
1646             var archiveRepo = Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);
1647             assertTrue(archiveContains(archiveFolder.path(), editHash.abbreviate()));
1648 
1649             // And there should be a webrev comment
1650             var comments = pr.comments();
1651             var webrevComments = comments.stream()
1652                                          .filter(comment -&gt; comment.author().equals(author.forge().currentUser()))
1653                                          .filter(comment -&gt; comment.body().contains(&quot;webrev&quot;))
1654                                          .filter(comment -&gt; comment.body().contains(editHash.hex()))
1655                                          .collect(Collectors.toList());
1656             assertEquals(1, webrevComments.size());
1657             assertEquals(1, countSubstrings(webrevComments.get(0).body(), &quot;webrev.00&quot;));
1658 
1659             // Pretend the archive didn&#39;t work out
1660             archiveRepo.push(masterHash, archive.url(), &quot;master&quot;, true);
1661 
1662             // Run another archive pass
1663             TestBotRunner.runPeriodicItems(mlBot);
1664 
1665             // The webrev comment should not contain duplicate entries
1666             comments = pr.comments();
1667             webrevComments = comments.stream()
1668                                      .filter(comment -&gt; comment.author().equals(author.forge().currentUser()))
1669                                      .filter(comment -&gt; comment.body().contains(&quot;webrev&quot;))
1670                                      .filter(comment -&gt; comment.body().contains(editHash.hex()))
1671                                      .collect(Collectors.toList());
1672             assertEquals(1, webrevComments.size());
1673             assertEquals(1, countSubstrings(webrevComments.get(0).body(), &quot;webrev.00&quot;));
1674         }
1675     }
1676 
1677     @Test
1678     void notifyReviewVerdicts(TestInfo testInfo) throws IOException {
1679         try (var credentials = new HostCredentials(testInfo);
1680              var tempFolder = new TemporaryDirectory();
1681              var archiveFolder = new TemporaryDirectory();
1682              var listServer = new TestMailmanServer();
1683              var webrevServer = new TestWebrevServer()) {
1684             var author = credentials.getHostedRepository();
1685             var archive = credentials.getHostedRepository();
1686             var reviewer = credentials.getHostedRepository();
1687             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
1688             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
1689             var censusBuilder = credentials.getCensusBuilder()
1690                                            .addReviewer(reviewer.forge().currentUser().id())
1691                                            .addAuthor(author.forge().currentUser().id());
1692             var mlBot = MailingListBridgeBot.newBuilder()
1693                                             .from(from)
1694                                             .repo(author)
1695                                             .archive(archive)
1696                                             .censusRepo(censusBuilder.build())
1697                                             .list(listAddress)
1698                                             .listArchive(listServer.getArchive())
1699                                             .smtpServer(listServer.getSMTP())
1700                                             .webrevStorageRepository(archive)
1701                                             .webrevStorageRef(&quot;webrev&quot;)
1702                                             .webrevStorageBase(Path.of(&quot;test&quot;))
1703                                             .webrevStorageBaseUri(webrevServer.uri())
1704                                             .issueTracker(URIBuilder.base(&quot;http://issues.test/browse/&quot;).build())
1705                                             .build();
1706 
1707             // Populate the projects repository
1708             var reviewFile = Path.of(&quot;reviewfile.txt&quot;);
1709             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType(), reviewFile);
1710             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
1711             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
1712             localRepo.push(masterHash, archive.url(), &quot;webrev&quot;, true);
1713 
1714             // Make a change with a corresponding PR
1715             var editHash = CheckableRepository.appendAndCommit(localRepo);
1716             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
1717             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
1718             pr.setBody(&quot;This is now ready&quot;);
1719 
1720             // Run an archive pass
1721             TestBotRunner.runPeriodicItems(mlBot);
1722 
1723             // First unapprove it
1724             var reviewedPr = reviewer.pullRequest(pr.id());
1725             reviewedPr.addReview(Review.Verdict.DISAPPROVED, &quot;Reason 1&quot;);
1726             TestBotRunner.runPeriodicItems(mlBot);
1727             TestBotRunner.runPeriodicItems(mlBot);
1728             TestBotRunner.runPeriodicItems(mlBot);
1729 
1730             // The archive should contain a note
1731             Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);
1732             assertEquals(1, archiveContainsCount(archiveFolder.path(), &quot;Changes requested by &quot;));
1733             assertEquals(1, archiveContainsCount(archiveFolder.path(), &quot; by integrationreviewer1&quot;));
1734             if (author.forge().supportsReviewBody()) {
1735                 assertEquals(1, archiveContainsCount(archiveFolder.path(), &quot;Reason 1&quot;));
1736             }
1737 
1738             // Then approve it
1739             reviewedPr.addReview(Review.Verdict.APPROVED, &quot;Reason 2&quot;);
1740             TestBotRunner.runPeriodicItems(mlBot);
1741             TestBotRunner.runPeriodicItems(mlBot);
1742             TestBotRunner.runPeriodicItems(mlBot);
1743 
1744             // The archive should contain another note
1745             Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);
1746             assertEquals(1, archiveContainsCount(archiveFolder.path(), &quot;Marked as reviewed by &quot;));
1747             if (author.forge().supportsReviewBody()) {
1748                 assertEquals(1, archiveContainsCount(archiveFolder.path(), &quot;Reason 2&quot;));
1749             }
1750             assertEquals(2, archiveContainsCount(archiveFolder.path(), &quot;Re: RFR:&quot;));
1751 
1752             // Yet another change
1753             reviewedPr.addReview(Review.Verdict.DISAPPROVED, &quot;Reason 3&quot;);
1754             TestBotRunner.runPeriodicItems(mlBot);
1755             TestBotRunner.runPeriodicItems(mlBot);
1756             TestBotRunner.runPeriodicItems(mlBot);
1757 
1758             // The archive should contain another note
1759             Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);
1760             assertEquals(2, archiveContainsCount(archiveFolder.path(), &quot;Changes requested by &quot;));
1761             if (author.forge().supportsReviewBody()) {
1762                 assertEquals(1, archiveContainsCount(archiveFolder.path(), &quot;Reason 3&quot;));
1763             }
1764         }
1765     }
1766 
1767     @Test
1768     void ignoreComments(TestInfo testInfo) throws IOException {
1769         try (var credentials = new HostCredentials(testInfo);
1770              var tempFolder = new TemporaryDirectory();
1771              var archiveFolder = new TemporaryDirectory();
1772              var listServer = new TestMailmanServer();
1773              var webrevServer = new TestWebrevServer()) {
1774             var author = credentials.getHostedRepository();
1775             var ignored = credentials.getHostedRepository();
1776             var archive = credentials.getHostedRepository();
1777             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
1778             var censusBuilder = credentials.getCensusBuilder()
1779                                            .addAuthor(author.forge().currentUser().id());
1780             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
1781             var mlBot = MailingListBridgeBot.newBuilder()
1782                                             .from(from)
1783                                             .repo(author)
1784                                             .archive(archive)
1785                                             .censusRepo(censusBuilder.build())
1786                                             .list(listAddress)
1787                                             .ignoredUsers(Set.of(ignored.forge().currentUser().userName()))
1788                                             .ignoredComments(Set.of(Pattern.compile(&quot;ignore this comment&quot;, Pattern.MULTILINE | Pattern.DOTALL)))
1789                                             .listArchive(listServer.getArchive())
1790                                             .smtpServer(listServer.getSMTP())
1791                                             .webrevStorageRepository(archive)
1792                                             .webrevStorageRef(&quot;webrev&quot;)
1793                                             .webrevStorageBase(Path.of(&quot;test&quot;))
1794                                             .webrevStorageBaseUri(webrevServer.uri())
1795                                             .issueTracker(URIBuilder.base(&quot;http://issues.test/browse/&quot;).build())
1796                                             .build();
1797 
1798             // Populate the projects repository
1799             var reviewFile = Path.of(&quot;reviewfile.txt&quot;);
1800             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType(), reviewFile);
1801             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
1802             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
1803             localRepo.push(masterHash, archive.url(), &quot;webrev&quot;, true);
1804 
1805             // Make a change with a corresponding PR
1806             var editHash = CheckableRepository.appendAndCommit(localRepo);
1807             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
1808             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
1809             pr.setBody(&quot;This is now ready&quot;);
1810 
1811             // Make a bunch of comments
1812             pr.addComment(&quot;Plain comment&quot;);
1813             pr.addComment(&quot;ignore this comment&quot;);
1814             pr.addComment(&quot;I think it is time to\nignore this comment!&quot;);
1815             pr.addReviewComment(masterHash, editHash, reviewFile.toString(), 2, &quot;Review ignore this comment&quot;);
1816 
1817             var ignoredPR = ignored.pullRequest(pr.id());
1818             ignoredPR.addComment(&quot;Don&#39;t mind me&quot;);
1819 
1820             TestBotRunner.runPeriodicItems(mlBot);
1821             TestBotRunner.runPeriodicItems(mlBot);
1822 
1823             // The archive should not contain the ignored comments
1824             Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);
1825             assertTrue(archiveContains(archiveFolder.path(), &quot;This is now ready&quot;));
1826             assertFalse(archiveContains(archiveFolder.path(), &quot;ignore this comment&quot;));
1827             assertFalse(archiveContains(archiveFolder.path(), &quot;it is time to&quot;));
1828             assertFalse(archiveContains(archiveFolder.path(), &quot;Don&#39;t mind me&quot;));
1829             assertFalse(archiveContains(archiveFolder.path(), &quot;Review ignore&quot;));
1830         }
1831     }
1832 
1833     @Test
1834     void replyToEmptyReview(TestInfo testInfo) throws IOException {
1835         try (var credentials = new HostCredentials(testInfo);
1836              var tempFolder = new TemporaryDirectory();
1837              var archiveFolder = new TemporaryDirectory();
1838              var listServer = new TestMailmanServer();
1839              var webrevServer = new TestWebrevServer()) {
1840             var author = credentials.getHostedRepository();
1841             var reviewer = credentials.getHostedRepository();
1842             var archive = credentials.getHostedRepository();
1843             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
1844             var censusBuilder = credentials.getCensusBuilder()
1845                                            .addReviewer(reviewer.forge().currentUser().id())
1846                                            .addAuthor(author.forge().currentUser().id());
1847             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
1848             var mlBot = MailingListBridgeBot.newBuilder()
1849                                             .from(from)
1850                                             .repo(author)
1851                                             .archive(archive)
1852                                             .censusRepo(censusBuilder.build())
1853                                             .list(listAddress)
1854                                             .listArchive(listServer.getArchive())
1855                                             .smtpServer(listServer.getSMTP())
1856                                             .webrevStorageRepository(archive)
1857                                             .webrevStorageRef(&quot;webrev&quot;)
1858                                             .webrevStorageBase(Path.of(&quot;test&quot;))
1859                                             .webrevStorageBaseUri(webrevServer.uri())
1860                                             .issueTracker(URIBuilder.base(&quot;http://issues.test/browse/&quot;).build())
1861                                             .build();
1862 
1863             // Populate the projects repository
1864             var reviewFile = Path.of(&quot;reviewfile.txt&quot;);
1865             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType(), reviewFile);
1866             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
1867             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
1868             localRepo.push(masterHash, archive.url(), &quot;webrev&quot;, true);
1869 
1870             // Make a change with a corresponding PR
1871             var editHash = CheckableRepository.appendAndCommit(localRepo);
1872             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
1873             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
1874             pr.setBody(&quot;This is now ready&quot;);
1875             TestBotRunner.runPeriodicItems(mlBot);
1876             listServer.processIncoming();
1877 
1878             // Make an empty approval
1879             var reviewPr = reviewer.pullRequest(pr.id());
1880             reviewPr.addReview(Review.Verdict.APPROVED, &quot;&quot;);
1881             TestBotRunner.runPeriodicItems(mlBot);
1882             listServer.processIncoming();
1883 
1884             pr.addComment(&quot;Thanks for the review!&quot;);
1885             TestBotRunner.runPeriodicItems(mlBot);
1886             listServer.processIncoming();
1887 
1888             // The approval text should be included in the quote
1889             Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);
1890             assertEquals(1, archiveContainsCount(archiveFolder.path(), &quot;^&gt; Marked as reviewed&quot;));
1891         }
1892     }
1893 
1894     @Test
1895     void cooldown(TestInfo testInfo) throws IOException {
1896         try (var credentials = new HostCredentials(testInfo);
1897              var tempFolder = new TemporaryDirectory();
1898              var archiveFolder = new TemporaryDirectory();
1899              var listServer = new TestMailmanServer();
1900              var webrevServer = new TestWebrevServer()) {
1901             var bot = credentials.getHostedRepository();
1902             var author = credentials.getHostedRepository();
1903             var archive = credentials.getHostedRepository();
1904             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
1905             var censusBuilder = credentials.getCensusBuilder()
1906                                            .addAuthor(author.forge().currentUser().id());
1907             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
1908             var mlBotBuilder = MailingListBridgeBot.newBuilder()
1909                                                    .from(from)
1910                                                    .repo(bot)
1911                                                    .ignoredUsers(Set.of(bot.forge().currentUser().userName()))
1912                                                    .archive(archive)
1913                                                    .censusRepo(censusBuilder.build())
1914                                                    .list(listAddress)
1915                                                    .listArchive(listServer.getArchive())
1916                                                    .smtpServer(listServer.getSMTP())
1917                                                    .webrevStorageRepository(archive)
1918                                                    .webrevStorageRef(&quot;webrev&quot;)
1919                                                    .webrevStorageBase(Path.of(&quot;test&quot;))
1920                                                    .webrevStorageBaseUri(webrevServer.uri())
1921                                                    .issueTracker(URIBuilder.base(&quot;http://issues.test/browse/&quot;).build());
1922 
1923             // Populate the projects repository
1924             var reviewFile = Path.of(&quot;reviewfile.txt&quot;);
1925             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType(), reviewFile);
1926             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
1927             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
1928             localRepo.push(masterHash, archive.url(), &quot;webrev&quot;, true);
1929 
1930             // Make a change with a corresponding PR
1931             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;Line 1\nLine 2\nLine 3\nLine 4&quot;);
1932             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
1933             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
1934             pr.setBody(&quot;This is now ready&quot;);
1935 
1936             var mlBot = mlBotBuilder.build();
1937             var mlBotWithCooldown = mlBotBuilder.cooldown(Duration.ofDays(1)).build();
1938 
1939             TestBotRunner.runPeriodicItems(mlBot);
1940             listServer.processIncoming();
1941 
1942             // Make a comment
1943             pr.addComment(&quot;Looks good&quot;);
1944 
1945             // Bot with cooldown configured should not bridge the comment
1946             TestBotRunner.runPeriodicItems(mlBotWithCooldown);
1947             assertThrows(RuntimeException.class, () -&gt; listServer.processIncoming(Duration.ofMillis(1)));
1948 
1949             // But without, it should
1950             TestBotRunner.runPeriodicItems(mlBot);
1951             listServer.processIncoming();
1952 
1953             // Check the archive
1954             Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);
1955             assertTrue(archiveContains(archiveFolder.path(), &quot;Looks good&quot;));
1956         }
1957     }
1958 
1959     @Test
1960     void cooldownNewRevision(TestInfo testInfo) throws IOException {
1961         try (var credentials = new HostCredentials(testInfo);
1962              var tempFolder = new TemporaryDirectory();
1963              var archiveFolder = new TemporaryDirectory();
1964              var listServer = new TestMailmanServer();
1965              var webrevServer = new TestWebrevServer()) {
1966             var bot = credentials.getHostedRepository();
1967             var author = credentials.getHostedRepository();
1968             var archive = credentials.getHostedRepository();
1969             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
1970             var censusBuilder = credentials.getCensusBuilder()
1971                                            .addAuthor(author.forge().currentUser().id());
1972             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
1973             var mlBotBuilder = MailingListBridgeBot.newBuilder()
1974                                                    .from(from)
1975                                                    .repo(bot)
1976                                                    .ignoredUsers(Set.of(bot.forge().currentUser().userName()))
1977                                                    .archive(archive)
1978                                                    .censusRepo(censusBuilder.build())
1979                                                    .list(listAddress)
1980                                                    .listArchive(listServer.getArchive())
1981                                                    .smtpServer(listServer.getSMTP())
1982                                                    .webrevStorageRepository(archive)
1983                                                    .webrevStorageRef(&quot;webrev&quot;)
1984                                                    .webrevStorageBase(Path.of(&quot;test&quot;))
1985                                                    .webrevStorageBaseUri(webrevServer.uri())
1986                                                    .issueTracker(URIBuilder.base(&quot;http://issues.test/browse/&quot;).build());
1987 
1988             // Populate the projects repository
1989             var reviewFile = Path.of(&quot;reviewfile.txt&quot;);
1990             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType(), reviewFile);
1991             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
1992             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
1993             localRepo.push(masterHash, archive.url(), &quot;webrev&quot;, true);
1994 
1995             // Make a change with a corresponding PR
1996             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;Line 1\nLine 2\nLine 3\nLine 4&quot;);
1997             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
1998             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
1999             pr.setBody(&quot;This is now ready&quot;);
2000 
2001             var mlBot = mlBotBuilder.build();
2002             var mlBotWithCooldown = mlBotBuilder.cooldown(Duration.ofDays(1)).build();
2003 
2004             TestBotRunner.runPeriodicItems(mlBot);
2005             listServer.processIncoming();
2006 
2007             // Commit another revision
2008             var updatedHash = CheckableRepository.appendAndCommit(localRepo, &quot;More stuff&quot;);
2009             localRepo.push(updatedHash, author.url(), &quot;edit&quot;);
2010 
2011             // Bot with cooldown configured should not create a new webrev
2012             TestBotRunner.runPeriodicItems(mlBotWithCooldown);
2013             assertThrows(RuntimeException.class, () -&gt; listServer.processIncoming(Duration.ofMillis(1)));
2014 
2015             // But without, it should
2016             TestBotRunner.runPeriodicItems(mlBot);
2017             listServer.processIncoming();
2018 
2019             // Check the archive
2020             Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);
2021             assertTrue(archiveContains(archiveFolder.path(), &quot;webrev.01&quot;));
2022         }
2023     }
2024 
2025     @Test
2026     void retryAfterCooldown(TestInfo testInfo) throws IOException, InterruptedException {
2027         try (var credentials = new HostCredentials(testInfo);
2028              var tempFolder = new TemporaryDirectory();
2029              var archiveFolder = new TemporaryDirectory();
2030              var listServer = new TestMailmanServer();
2031              var webrevServer = new TestWebrevServer()) {
2032             var bot = credentials.getHostedRepository();
2033             var author = credentials.getHostedRepository();
2034             var archive = credentials.getHostedRepository();
2035             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
2036             var censusBuilder = credentials.getCensusBuilder()
2037                                            .addAuthor(author.forge().currentUser().id());
2038             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
2039             var cooldown = Duration.ofMillis(500);
2040             var mlBotBuilder = MailingListBridgeBot.newBuilder()
2041                                                    .from(from)
2042                                                    .repo(bot)
2043                                                    .ignoredUsers(Set.of(bot.forge().currentUser().userName()))
2044                                                    .archive(archive)
2045                                                    .censusRepo(censusBuilder.build())
2046                                                    .list(listAddress)
2047                                                    .listArchive(listServer.getArchive())
2048                                                    .smtpServer(listServer.getSMTP())
2049                                                    .webrevStorageRepository(archive)
2050                                                    .webrevStorageRef(&quot;webrev&quot;)
2051                                                    .webrevStorageBase(Path.of(&quot;test&quot;))
2052                                                    .webrevStorageBaseUri(webrevServer.uri())
2053                                                    .issueTracker(URIBuilder.base(&quot;http://issues.test/browse/&quot;).build());
2054 
2055             // Populate the projects repository
2056             var reviewFile = Path.of(&quot;reviewfile.txt&quot;);
2057             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType(), reviewFile);
2058             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
2059             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
2060             localRepo.push(masterHash, archive.url(), &quot;webrev&quot;, true);
2061 
2062             // Make a change with a corresponding PR
2063             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;Line 1\nLine 2\nLine 3\nLine 4&quot;);
2064             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
2065             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
2066             pr.setBody(&quot;This is now ready&quot;);
2067 
2068             var mlBot = mlBotBuilder.cooldown(cooldown).build();
2069             Thread.sleep(cooldown.toMillis());
2070             TestBotRunner.runPeriodicItems(mlBot);
2071             listServer.processIncoming();
2072 
2073             // Make a comment and run the check within the cooldown period
2074             int counter;
2075             boolean noMailReceived = false;
2076             for (counter = 1; counter &lt; 10; ++counter) {
2077                 var start = Instant.now();
2078                 pr.addComment(&quot;Looks good - &quot; + counter + &quot; -&quot;);
2079 
2080                 // The bot should not bridge the comment due to cooldown
2081                 TestBotRunner.runPeriodicItems(mlBot);
2082                 try {
2083                     noMailReceived = false;
2084                     listServer.processIncoming(Duration.ofMillis(1));
2085                 } catch (RuntimeException e) {
2086                     noMailReceived = true;
2087                 }
2088                 var elapsed = Duration.between(start, Instant.now());
2089                 if (elapsed.compareTo(cooldown) &lt; 0) {
2090                     break;
2091                 } else {
2092                     log.info(&quot;Didn&#39;t do the test in time - retrying (elapsed: &quot; + elapsed + &quot; required: &quot; + cooldown + &quot;)&quot;);
2093                     // Ensure that the cooldown expires
2094                     Thread.sleep(cooldown.toMillis());
2095                     // If no mail was received, we have to flush it out
2096                     if (noMailReceived) {
2097                         TestBotRunner.runPeriodicItems(mlBot);
2098                         listServer.processIncoming();
2099                     }
2100                     cooldown = cooldown.multipliedBy(2);
2101                     mlBot = mlBotBuilder.cooldown(cooldown).build();
2102                 }
2103             }
2104             assertTrue(noMailReceived);
2105 
2106             // But after the cooldown period has passed, it should
2107             Thread.sleep(cooldown.toMillis());
2108             TestBotRunner.runPeriodicItems(mlBot);
2109             listServer.processIncoming();
2110 
2111             // Check the archive
2112             Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);
2113             assertTrue(archiveContains(archiveFolder.path(), &quot;Looks good - &quot; + counter + &quot; -&quot;));
2114         }
2115     }
2116 
2117     @Test
2118     void branchPrefix(TestInfo testInfo) throws IOException {
2119         try (var credentials = new HostCredentials(testInfo);
2120              var tempFolder = new TemporaryDirectory();
2121              var archiveFolder = new TemporaryDirectory();
2122              var listServer = new TestMailmanServer();
2123              var webrevServer = new TestWebrevServer()) {
2124             var author = credentials.getHostedRepository();
2125             var archive = credentials.getHostedRepository();
2126             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
2127             var censusBuilder = credentials.getCensusBuilder()
2128                                            .addAuthor(author.forge().currentUser().id());
2129             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
2130             var mlBot = MailingListBridgeBot.newBuilder()
2131                                             .from(from)
2132                                             .repo(author)
2133                                             .archive(archive)
2134                                             .censusRepo(censusBuilder.build())
2135                                             .list(listAddress)
2136                                             .listArchive(listServer.getArchive())
2137                                             .smtpServer(listServer.getSMTP())
2138                                             .webrevStorageRepository(archive)
2139                                             .webrevStorageRef(&quot;webrev&quot;)
2140                                             .webrevStorageBase(Path.of(&quot;test&quot;))
2141                                             .webrevStorageBaseUri(webrevServer.uri())
2142                                             .issueTracker(URIBuilder.base(&quot;http://issues.test/browse/&quot;).build())
2143                                             .branchInSubject(Pattern.compile(&quot;.*&quot;))
2144                                             .build();
2145 
2146             // Populate the projects repository
2147             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType());
2148             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
2149             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
2150             localRepo.push(masterHash, archive.url(), &quot;webrev&quot;, true);
2151 
2152             // Make a change with a corresponding PR
2153             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;A simple change&quot;,
2154                                                                &quot;Change msg\n\nWith several lines&quot;);
2155             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
2156             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;1234: This is a pull request&quot;);
2157             pr.setBody(&quot;This is a PR&quot;);
2158 
2159             // Run an archive pass
2160             TestBotRunner.runPeriodicItems(mlBot);
2161             listServer.processIncoming();
2162 
2163             pr.addComment(&quot;Looks good!&quot;);
2164             TestBotRunner.runPeriodicItems(mlBot);
2165             listServer.processIncoming();
2166 
2167             // Check the archive
2168             Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);
2169             assertTrue(archiveContains(archiveFolder.path(), &quot;Subject: \\[master\\] RFR: &quot;));
2170             assertTrue(archiveContains(archiveFolder.path(), &quot;Subject: Re: \\[master\\] RFR: &quot;));
2171         }
2172     }
2173 
2174     @Test
2175     void repoPrefix(TestInfo testInfo) throws IOException {
2176         try (var credentials = new HostCredentials(testInfo);
2177              var tempFolder = new TemporaryDirectory();
2178              var archiveFolder = new TemporaryDirectory();
2179              var listServer = new TestMailmanServer();
2180              var webrevServer = new TestWebrevServer()) {
2181             var author = credentials.getHostedRepository();
2182             var archive = credentials.getHostedRepository();
2183             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
2184             var censusBuilder = credentials.getCensusBuilder()
2185                                            .addAuthor(author.forge().currentUser().id());
2186             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
2187             var mlBot = MailingListBridgeBot.newBuilder()
2188                                             .from(from)
2189                                             .repo(author)
2190                                             .archive(archive)
2191                                             .censusRepo(censusBuilder.build())
2192                                             .list(listAddress)
2193                                             .listArchive(listServer.getArchive())
2194                                             .smtpServer(listServer.getSMTP())
2195                                             .webrevStorageRepository(archive)
2196                                             .webrevStorageRef(&quot;webrev&quot;)
2197                                             .webrevStorageBase(Path.of(&quot;test&quot;))
2198                                             .webrevStorageBaseUri(webrevServer.uri())
2199                                             .issueTracker(URIBuilder.base(&quot;http://issues.test/browse/&quot;).build())
2200                                             .repoInSubject(true)
2201                                             .build();
2202 
2203             // Populate the projects repository
2204             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType());
2205             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
2206             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
2207             localRepo.push(masterHash, archive.url(), &quot;webrev&quot;, true);
2208 
2209             // Make a change with a corresponding PR
2210             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;A simple change&quot;,
2211                                                                &quot;Change msg\n\nWith several lines&quot;);
2212             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
2213             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;1234: This is a pull request&quot;);
2214             pr.setBody(&quot;This is a PR&quot;);
2215 
2216             // Run an archive pass
2217             TestBotRunner.runPeriodicItems(mlBot);
2218             listServer.processIncoming();
2219 
2220             pr.addComment(&quot;Looks good!&quot;);
2221             TestBotRunner.runPeriodicItems(mlBot);
2222             listServer.processIncoming();
2223 
2224             // Check the archive
2225             Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);
2226             assertTrue(archiveContains(archiveFolder.path(), &quot;Subject: \\[&quot; + pr.repository().name() + &quot;\\] RFR: &quot;));
2227             assertTrue(archiveContains(archiveFolder.path(), &quot;Subject: Re: \\[&quot; + pr.repository().name() + &quot;\\] RFR: &quot;));
2228         }
2229     }
2230 
2231     @Test
2232     void repoAndBranchPrefix(TestInfo testInfo) throws IOException {
2233         try (var credentials = new HostCredentials(testInfo);
2234              var tempFolder = new TemporaryDirectory();
2235              var archiveFolder = new TemporaryDirectory();
2236              var listServer = new TestMailmanServer();
2237              var webrevServer = new TestWebrevServer()) {
2238             var author = credentials.getHostedRepository();
2239             var archive = credentials.getHostedRepository();
2240             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
2241             var censusBuilder = credentials.getCensusBuilder()
2242                                            .addAuthor(author.forge().currentUser().id());
2243             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
2244             var mlBot = MailingListBridgeBot.newBuilder()
2245                                             .from(from)
2246                                             .repo(author)
2247                                             .archive(archive)
2248                                             .censusRepo(censusBuilder.build())
2249                                             .list(listAddress)
2250                                             .listArchive(listServer.getArchive())
2251                                             .smtpServer(listServer.getSMTP())
2252                                             .webrevStorageRepository(archive)
2253                                             .webrevStorageRef(&quot;webrev&quot;)
2254                                             .webrevStorageBase(Path.of(&quot;test&quot;))
2255                                             .webrevStorageBaseUri(webrevServer.uri())
2256                                             .issueTracker(URIBuilder.base(&quot;http://issues.test/browse/&quot;).build())
2257                                             .repoInSubject(true)
2258                                             .branchInSubject(Pattern.compile(&quot;.*&quot;))
2259                                             .build();
2260 
2261             // Populate the projects repository
2262             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType());
2263             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
2264             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
2265             localRepo.push(masterHash, archive.url(), &quot;webrev&quot;, true);
2266 
2267             // Make a change with a corresponding PR
2268             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;A simple change&quot;,
2269                                                                &quot;Change msg\n\nWith several lines&quot;);
2270             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
2271             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;1234: This is a pull request&quot;);
2272             pr.setBody(&quot;This is a PR&quot;);
2273 
2274             // Run an archive pass
2275             TestBotRunner.runPeriodicItems(mlBot);
2276             listServer.processIncoming();
2277 
2278             pr.addComment(&quot;Looks good!&quot;);
2279             TestBotRunner.runPeriodicItems(mlBot);
2280             listServer.processIncoming();
2281 
2282             // Check the archive
2283             Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);
2284             assertTrue(archiveContains(archiveFolder.path(), &quot;Subject: \\[&quot; + pr.repository().name() + &quot;:master\\] RFR: &quot;));
2285             assertTrue(archiveContains(archiveFolder.path(), &quot;Subject: Re: \\[&quot; + pr.repository().name() + &quot;:master\\] RFR: &quot;));
2286         }
2287     }
2288 
2289     @Test
2290     void retryNewRevisionAfterCooldown(TestInfo testInfo) throws IOException, InterruptedException {
2291         try (var credentials = new HostCredentials(testInfo);
2292              var tempFolder = new TemporaryDirectory();
2293              var archiveFolder = new TemporaryDirectory();
2294              var listServer = new TestMailmanServer();
2295              var webrevServer = new TestWebrevServer()) {
2296             var bot = credentials.getHostedRepository();
2297             var author = credentials.getHostedRepository();
2298             var archive = credentials.getHostedRepository();
2299             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
2300             var censusBuilder = credentials.getCensusBuilder()
2301                                            .addAuthor(author.forge().currentUser().id());
2302             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
2303             var cooldown = Duration.ofMillis(500);
2304             var mlBotBuilder = MailingListBridgeBot.newBuilder()
2305                                                    .from(from)
2306                                                    .repo(bot)
2307                                                    .ignoredUsers(Set.of(bot.forge().currentUser().userName()))
2308                                                    .archive(archive)
2309                                                    .censusRepo(censusBuilder.build())
2310                                                    .list(listAddress)
2311                                                    .listArchive(listServer.getArchive())
2312                                                    .smtpServer(listServer.getSMTP())
2313                                                    .webrevStorageRepository(archive)
2314                                                    .webrevStorageRef(&quot;webrev&quot;)
2315                                                    .webrevStorageBase(Path.of(&quot;test&quot;))
2316                                                    .webrevStorageBaseUri(webrevServer.uri())
2317                                                    .issueTracker(URIBuilder.base(&quot;http://issues.test/browse/&quot;).build());
2318 
2319             // Populate the projects repository
2320             var reviewFile = Path.of(&quot;reviewfile.txt&quot;);
2321             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType(), reviewFile);
2322             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
2323             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
2324             localRepo.push(masterHash, archive.url(), &quot;webrev&quot;, true);
2325 
2326             // Make a change with a corresponding PR
2327             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;Line 1\nLine 2\nLine 3\nLine 4&quot;);
2328             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
2329             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
2330             pr.setBody(&quot;This is now ready&quot;);
2331 
2332             var mlBot = mlBotBuilder.cooldown(cooldown).build();
2333             Thread.sleep(cooldown.toMillis());
2334             TestBotRunner.runPeriodicItems(mlBot);
2335             listServer.processIncoming();
2336 
2337             // Make a new revision and run the check within the cooldown period
2338             int counter;
2339             boolean noMailReceived = false;
2340             for (counter = 1; counter &lt; 10; ++counter) {
2341                 var start = Instant.now();
2342                 var revHash = CheckableRepository.appendAndCommit(localRepo, &quot;more stuff&quot;, &quot;Update number - &quot; + counter + &quot; -&quot;);
2343                 localRepo.push(revHash, author.url(), &quot;edit&quot;);
2344 
2345                 // The bot should not bridge the new revision due to cooldown
2346                 TestBotRunner.runPeriodicItems(mlBot);
2347                 try {
2348                     noMailReceived = false;
2349                     listServer.processIncoming(Duration.ofMillis(1));
2350                 } catch (RuntimeException e) {
2351                     noMailReceived = true;
2352                 }
2353                 var elapsed = Duration.between(start, Instant.now());
2354                 if (elapsed.compareTo(cooldown) &lt; 0) {
2355                     break;
2356                 } else {
2357                     log.info(&quot;Didn&#39;t do the test in time - retrying (elapsed: &quot; + elapsed + &quot; required: &quot; + cooldown + &quot;)&quot;);
2358                     // Ensure that the cooldown expires
2359                     Thread.sleep(cooldown.toMillis());
2360                     // If no mail was received, we have to flush it out
2361                     if (noMailReceived) {
2362                         TestBotRunner.runPeriodicItems(mlBot);
2363                         listServer.processIncoming();
2364                     }
2365                     cooldown = cooldown.multipliedBy(2);
2366                     mlBot = mlBotBuilder.cooldown(cooldown).build();
2367                 }
2368             }
2369             assertTrue(noMailReceived);
2370 
2371             // But after the cooldown period has passed, it should
2372             Thread.sleep(cooldown.toMillis());
2373             TestBotRunner.runPeriodicItems(mlBot);
2374             listServer.processIncoming();
2375 
2376             // Check the archive
2377             Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);
2378             assertTrue(archiveContains(archiveFolder.path(), &quot;Update number - &quot; + counter + &quot; -&quot;));
2379         }
2380     }
2381 }
<a name="2" id="anc2"></a><b style="font-size: large; color: red">--- EOF ---</b>
















































































</pre>
<input id="eof" value="2" type="hidden" />
</body>
</html>