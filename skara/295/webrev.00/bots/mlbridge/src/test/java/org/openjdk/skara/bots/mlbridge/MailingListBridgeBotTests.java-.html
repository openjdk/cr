<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Old bots/mlbridge/src/test/java/org/openjdk/skara/bots/mlbridge/MailingListBridgeBotTests.java</title>
    <link rel="stylesheet" href="../../../../../../../../../../style.css" />
  </head>
  <body>
    <pre>
   1 /*
   2  * Copyright (c) 2019, Oracle and/or its affiliates. All rights reserved.
   3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   4  *
   5  * This code is free software; you can redistribute it and/or modify it
   6  * under the terms of the GNU General Public License version 2 only, as
   7  * published by the Free Software Foundation.
   8  *
   9  * This code is distributed in the hope that it will be useful, but WITHOUT
  10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
  11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
  12  * version 2 for more details (a copy is included in the LICENSE file that
  13  * accompanied this code).
  14  *
  15  * You should have received a copy of the GNU General Public License version
  16  * 2 along with this work; if not, write to the Free Software Foundation,
  17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
  18  *
  19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
  20  * or visit www.oracle.com if you need additional information or have any
  21  * questions.
  22  */
  23 package org.openjdk.skara.bots.mlbridge;
  24 
  25 import org.openjdk.skara.email.EmailAddress;
  26 import org.openjdk.skara.forge.*;
  27 import org.openjdk.skara.network.URIBuilder;
  28 import org.openjdk.skara.mailinglist.MailingListServerFactory;
  29 import org.openjdk.skara.test.*;
  30 import org.openjdk.skara.vcs.Repository;
  31 
  32 import org.junit.jupiter.api.*;
  33 
  34 import java.io.IOException;
  35 import java.nio.charset.StandardCharsets;
  36 import java.nio.file.*;
  37 import java.time.Duration;
  38 import java.util.*;
  39 import java.util.regex.Pattern;
  40 import java.util.stream.Collectors;
  41 
  42 import static org.junit.jupiter.api.Assertions.*;
  43 
  44 class MailingListBridgeBotTests {
  45     private Optional&lt;String&gt; archiveContents(Path archive) {
  46         try {
  47             var mbox = Files.find(archive, 50, (path, attrs) -&gt; path.toString().endsWith(&quot;.mbox&quot;)).findAny();
  48             if (mbox.isEmpty()) {
  49                 return Optional.empty();
  50             }
  51             return Optional.of(Files.readString(mbox.get(), StandardCharsets.UTF_8));
  52         } catch (IOException e) {
  53             return Optional.empty();
  54         }
  55 
  56     }
  57 
  58     private boolean archiveContains(Path archive, String text) {
  59         return archiveContainsCount(archive, text) &gt; 0;
  60     }
  61 
  62     private int archiveContainsCount(Path archive, String text) {
  63         var lines = archiveContents(archive);
  64         if (lines.isEmpty()) {
  65             return 0;
  66         }
  67         var pattern = Pattern.compile(text);
  68         int count = 0;
  69         for (var line : lines.get().split(&quot;\\R&quot;)) {
  70             var matcher = pattern.matcher(line);
  71             if (matcher.find()) {
  72                 count++;
  73             }
  74         }
  75         return count;
  76     }
  77 
  78     private boolean webrevContains(Path webrev, String text) {
  79         try {
  80             var index = Files.find(webrev, 5, (path, attrs) -&gt; path.toString().endsWith(&quot;index.html&quot;)).findAny();
  81             if (index.isEmpty()) {
  82                 return false;
  83             }
  84             var lines = Files.readString(index.get(), StandardCharsets.UTF_8);
  85             return lines.contains(text);
  86         } catch (IOException e) {
  87             return false;
  88         }
  89     }
  90 
  91     private long countSubstrings(String string, String substring) {
  92         return Pattern.compile(substring).matcher(string).results().count();
  93     }
  94 
  95     private String noreplyAddress(HostedRepository repository) {
  96         return &quot;test+&quot; + repository.forge().currentUser().id() + &quot;+&quot; +
  97                 repository.forge().currentUser().userName() +
  98                 &quot;@openjdk.java.net&quot;;
  99     }
 100 
 101     @Test
 102     void simpleArchive(TestInfo testInfo) throws IOException {
 103         try (var credentials = new HostCredentials(testInfo);
 104              var tempFolder = new TemporaryDirectory();
 105              var archiveFolder = new TemporaryDirectory();
 106              var webrevFolder = new TemporaryDirectory();
 107              var listServer = new TestMailmanServer()) {
 108             var author = credentials.getHostedRepository();
 109             var archive = credentials.getHostedRepository();
 110             var ignored = credentials.getHostedRepository();
 111             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
 112             var censusBuilder = credentials.getCensusBuilder()
 113                                            .addAuthor(author.forge().currentUser().id());
 114             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
 115             var mlBot = new MailingListBridgeBot(from, author, archive, &quot;master&quot;,
 116                                                  censusBuilder.build(), &quot;master&quot;, listAddress,
 117                                                  Set.of(ignored.forge().currentUser().userName()),
 118                                                  Set.of(),
 119                                                  listServer.getArchive(), listServer.getSMTP(),
 120                                                  archive, &quot;webrev&quot;, Path.of(&quot;test&quot;),
 121                                                  URIBuilder.base(&quot;http://www.test.test/&quot;).build(),
 122                                                  Set.of(&quot;rfr&quot;), Map.of(ignored.forge().currentUser().userName(),
 123                                                                        Pattern.compile(&quot;ready&quot;)),
 124                                                  URIBuilder.base(&quot;http://issues.test/browse/&quot;).build(),
 125                                                  Map.of(&quot;Extra1&quot;, &quot;val1&quot;, &quot;Extra2&quot;, &quot;val2&quot;),
 126                                                  Duration.ZERO);
 127 
 128             // Populate the projects repository
 129             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType());
 130             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
 131             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
 132             localRepo.push(masterHash, archive.url(), &quot;webrev&quot;, true);
 133 
 134             // Make a change with a corresponding PR
 135             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;A simple change&quot;,
 136                                                                &quot;Change msg\n\nWith several lines&quot;);
 137             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
 138             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;1234: This is a pull request&quot;);
 139             pr.setBody(&quot;This should not be ready&quot;);
 140 
 141             // Run an archive pass
 142             TestBotRunner.runPeriodicItems(mlBot);
 143 
 144             // A PR that isn&#39;t ready for review should not be archived
 145             Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);
 146             assertFalse(archiveContains(archiveFolder.path(), &quot;This is a pull request&quot;));
 147 
 148             // Flag it as ready for review
 149             pr.setBody(&quot;This should now be ready&quot;);
 150             pr.addLabel(&quot;rfr&quot;);
 151 
 152             // Run another archive pass
 153             TestBotRunner.runPeriodicItems(mlBot);
 154 
 155             // But it should still not be archived
 156             Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);
 157             assertFalse(archiveContains(archiveFolder.path(), &quot;This is a pull request&quot;));
 158 
 159             // Now post a general comment - not a ready marker
 160             var ignoredPr = ignored.pullRequest(pr.id());
 161             ignoredPr.addComment(&quot;hello there&quot;);
 162 
 163             // Run another archive pass
 164             TestBotRunner.runPeriodicItems(mlBot);
 165 
 166             // It should still not be archived
 167             Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);
 168             assertFalse(archiveContains(archiveFolder.path(), &quot;This is a pull request&quot;));
 169 
 170             // Now post a ready comment
 171             ignoredPr.addComment(&quot;ready&quot;);
 172 
 173             // Run another archive pass
 174             TestBotRunner.runPeriodicItems(mlBot);
 175 
 176             // The archive should now contain an entry
 177             Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);
 178             assertTrue(archiveContains(archiveFolder.path(), &quot;This is a pull request&quot;));
 179             assertTrue(archiveContains(archiveFolder.path(), &quot;This should now be ready&quot;));
 180             assertTrue(archiveContains(archiveFolder.path(), &quot;Patch:&quot;));
 181             assertTrue(archiveContains(archiveFolder.path(), &quot;Changes:&quot;));
 182             assertTrue(archiveContains(archiveFolder.path(), &quot;Webrev:&quot;));
 183             assertTrue(archiveContains(archiveFolder.path(), &quot;http://www.test.test/&quot;));
 184             assertTrue(archiveContains(archiveFolder.path(), &quot;webrev.00&quot;));
 185             assertTrue(archiveContains(archiveFolder.path(), &quot;Issue:&quot;));
 186             assertTrue(archiveContains(archiveFolder.path(), &quot;http://issues.test/browse/TSTPRJ-1234&quot;));
 187             assertTrue(archiveContains(archiveFolder.path(), &quot;Fetch:&quot;));
 188             assertTrue(archiveContains(archiveFolder.path(), &quot;^ - &quot; + editHash.abbreviate() + &quot;: Change msg&quot;));
 189             assertFalse(archiveContains(archiveFolder.path(), &quot;With several lines&quot;));
 190 
 191             // The mailing list as well
 192             listServer.processIncoming();
 193             var mailmanServer = MailingListServerFactory.createMailmanServer(listServer.getArchive(), listServer.getSMTP(), Duration.ZERO);
 194             var mailmanList = mailmanServer.getList(listAddress.address());
 195             var conversations = mailmanList.conversations(Duration.ofDays(1));
 196             assertEquals(1, conversations.size());
 197             var mail = conversations.get(0).first();
 198             assertEquals(&quot;RFR: 1234: This is a pull request&quot;, mail.subject());
 199             assertEquals(pr.author().fullName(), mail.author().fullName().orElseThrow());
 200             assertEquals(noreplyAddress(archive), mail.author().address());
 201             assertEquals(listAddress, mail.sender());
 202             assertEquals(&quot;val1&quot;, mail.headerValue(&quot;Extra1&quot;));
 203             assertEquals(&quot;val2&quot;, mail.headerValue(&quot;Extra2&quot;));
 204 
 205             // And there should be a webrev
 206             Repository.materialize(webrevFolder.path(), archive.url(), &quot;webrev&quot;);
 207             assertTrue(webrevContains(webrevFolder.path(), &quot;1 lines changed&quot;));
 208             var comments = pr.comments();
 209             var webrevComments = comments.stream()
 210                                          .filter(comment -&gt; comment.author().equals(author.forge().currentUser()))
 211                                          .filter(comment -&gt; comment.body().contains(&quot;webrev&quot;))
 212                                          .filter(comment -&gt; comment.body().contains(editHash.hex()))
 213                                          .collect(Collectors.toList());
 214             assertEquals(1, webrevComments.size());
 215 
 216             // Add a comment
 217             pr.addComment(&quot;This is a comment :smile:&quot;);
 218 
 219             // Add a comment from an ignored user as well
 220             ignoredPr.addComment(&quot;Don&#39;t mind me&quot;);
 221 
 222             // Run another archive pass
 223             TestBotRunner.runPeriodicItems(mlBot);
 224 
 225             // The archive should now contain the comment, but not the ignored one
 226             Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);
 227             assertTrue(archiveContains(archiveFolder.path(), &quot;This is a comment&quot;));
 228             assertTrue(archiveContains(archiveFolder.path(), &quot;&gt; This should now be ready&quot;));
 229             assertFalse(archiveContains(archiveFolder.path(), &quot;Don&#39;t mind me&quot;));
 230 
 231             listServer.processIncoming();
 232             conversations = mailmanList.conversations(Duration.ofDays(1));
 233             assertEquals(1, conversations.size());
 234             assertEquals(2, conversations.get(0).allMessages().size());
 235 
 236             // Remove the rfr flag and post another comment
 237             pr.addLabel(&quot;rfr&quot;);
 238             pr.addComment(&quot;This is another comment&quot;);
 239 
 240             // Run another archive pass
 241             TestBotRunner.runPeriodicItems(mlBot);
 242 
 243             // The archive should contain the additional comment
 244             Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);
 245             assertTrue(archiveContains(archiveFolder.path(), &quot;This is another comment&quot;));
 246             assertTrue(archiveContains(archiveFolder.path(), &quot;&gt;&gt; This should now be ready&quot;));
 247 
 248             listServer.processIncoming();
 249             conversations = mailmanList.conversations(Duration.ofDays(1));
 250             assertEquals(1, conversations.size());
 251             assertEquals(3, conversations.get(0).allMessages().size());
 252             for (var newMail : conversations.get(0).allMessages()) {
 253                 assertEquals(noreplyAddress(archive), newMail.author().address());
 254                 assertEquals(listAddress, newMail.sender());
 255             }
 256             assertTrue(conversations.get(0).allMessages().get(2).body().contains(&quot;This is a comment ðŸ˜„&quot;));
 257         }
 258     }
 259 
 260     @Test
 261     void reviewComment(TestInfo testInfo) throws IOException {
 262         try (var credentials = new HostCredentials(testInfo);
 263              var tempFolder = new TemporaryDirectory();
 264              var archiveFolder = new TemporaryDirectory();
 265              var listServer = new TestMailmanServer()) {
 266             var author = credentials.getHostedRepository();
 267             var archive = credentials.getHostedRepository();
 268             var ignored = credentials.getHostedRepository();
 269             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
 270             var censusBuilder = credentials.getCensusBuilder()
 271                                            .addAuthor(author.forge().currentUser().id());
 272             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
 273             var mlBot = new MailingListBridgeBot(from, author, archive, &quot;master&quot;,
 274                                                  censusBuilder.build(), &quot;master&quot;, listAddress,
 275                                                  Set.of(ignored.forge().currentUser().userName()),
 276                                                  Set.of(),
 277                                                  listServer.getArchive(), listServer.getSMTP(),
 278                                                  archive, &quot;webrev&quot;, Path.of(&quot;test&quot;),
 279                                                  URIBuilder.base(&quot;http://www.test.test/&quot;).build(),
 280                                                  Set.of(), Map.of(),
 281                                                  URIBuilder.base(&quot;http://issues.test/browse/&quot;).build(),
 282                                                  Map.of(), Duration.ZERO);
 283 
 284             // Populate the projects repository
 285             var reviewFile = Path.of(&quot;reviewfile.txt&quot;);
 286             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType(), reviewFile);
 287             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
 288             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
 289             localRepo.push(masterHash, archive.url(), &quot;webrev&quot;, true);
 290 
 291             // Make a change with a corresponding PR
 292             var editHash = CheckableRepository.appendAndCommit(localRepo);
 293             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
 294             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
 295             pr.setBody(&quot;This is now ready&quot;);
 296             TestBotRunner.runPeriodicItems(mlBot);
 297             listServer.processIncoming();
 298 
 299             // And make a file specific comment
 300             var currentMaster = localRepo.resolve(&quot;master&quot;).orElseThrow();
 301             var comment = pr.addReviewComment(masterHash, editHash, reviewFile.toString(), 2, &quot;Review comment&quot;);
 302 
 303             // Add one from an ignored user as well
 304             var ignoredPr = ignored.pullRequest(pr.id());
 305             ignoredPr.addReviewComment(masterHash, editHash, reviewFile.toString(), 2, &quot;Don&#39;t mind me&quot;);
 306 
 307             // Process comments
 308             TestBotRunner.runPeriodicItems(mlBot);
 309             listServer.processIncoming();
 310 
 311             // The archive should now contain an entry
 312             Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);
 313             assertTrue(archiveContains(archiveFolder.path(), &quot;This is a pull request&quot;));
 314             assertTrue(archiveContains(archiveFolder.path(), &quot;This is now ready&quot;));
 315             assertTrue(archiveContains(archiveFolder.path(), &quot;Review comment&quot;));
 316             assertTrue(archiveContains(archiveFolder.path(), &quot;&gt; This is now ready&quot;));
 317             assertTrue(archiveContains(archiveFolder.path(), reviewFile.toString()));
 318             assertFalse(archiveContains(archiveFolder.path(), &quot;Don&#39;t mind me&quot;));
 319 
 320             // The mailing list as well
 321             var mailmanServer = MailingListServerFactory.createMailmanServer(listServer.getArchive(), listServer.getSMTP(), Duration.ZERO);
 322             var mailmanList = mailmanServer.getList(listAddress.address());
 323             var conversations = mailmanList.conversations(Duration.ofDays(1));
 324             assertEquals(1, conversations.size());
 325             var mail = conversations.get(0).first();
 326             assertEquals(&quot;RFR: This is a pull request&quot;, mail.subject());
 327 
 328             // Comment on the comment
 329             pr.addReviewCommentReply(comment, &quot;This is a review reply&quot;);
 330             TestBotRunner.runPeriodicItems(mlBot);
 331             listServer.processIncoming();
 332 
 333             // The archive should contain the additional comment (but no quoted footers)
 334             Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);
 335             assertTrue(archiveContains(archiveFolder.path(), &quot;This is a review reply&quot;));
 336             assertTrue(archiveContains(archiveFolder.path(), &quot;&gt;&gt; This is now ready&quot;));
 337             assertFalse(archiveContains(archiveFolder.path(), &quot;^&gt; PR:&quot;));
 338 
 339             // As well as the mailing list
 340             conversations = mailmanList.conversations(Duration.ofDays(1));
 341             assertEquals(1, conversations.size());
 342             assertEquals(3, conversations.get(0).allMessages().size());
 343             for (var newMail : conversations.get(0).allMessages()) {
 344                 assertEquals(noreplyAddress(archive), newMail.author().address());
 345                 assertEquals(listAddress, newMail.sender());
 346             }
 347         }
 348     }
 349 
 350     @Test
 351     void combineComments(TestInfo testInfo) throws IOException {
 352         try (var credentials = new HostCredentials(testInfo);
 353              var tempFolder = new TemporaryDirectory();
 354              var archiveFolder = new TemporaryDirectory();
 355              var listServer = new TestMailmanServer()) {
 356             var author = credentials.getHostedRepository();
 357             var archive = credentials.getHostedRepository();
 358             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
 359             var censusBuilder = credentials.getCensusBuilder()
 360                                            .addAuthor(author.forge().currentUser().id());
 361             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
 362             var mlBot = new MailingListBridgeBot(from, author, archive, &quot;master&quot;,
 363                                                  censusBuilder.build(), &quot;master&quot;,
 364                                                  listAddress, Set.of(), Set.of(),
 365                                                  listServer.getArchive(),
 366                                                  listServer.getSMTP(),
 367                                                  archive, &quot;webrev&quot;, Path.of(&quot;test&quot;),
 368                                                  URIBuilder.base(&quot;http://www.test.test/&quot;).build(),
 369                                                  Set.of(), Map.of(),
 370                                                  URIBuilder.base(&quot;http://issues.test/browse/&quot;).build(),
 371                                                  Map.of(), Duration.ZERO);
 372 
 373             // Populate the projects repository
 374             var reviewFile = Path.of(&quot;reviewfile.txt&quot;);
 375             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType(), reviewFile);
 376             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
 377             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
 378             localRepo.push(masterHash, archive.url(), &quot;webrev&quot;, true);
 379 
 380             // Make a change with a corresponding PR
 381             var editHash = CheckableRepository.appendAndCommit(localRepo);
 382             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
 383             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
 384             pr.setBody(&quot;This is now ready&quot;);
 385             pr.addComment(&quot;Avoid combining&quot;);
 386 
 387             TestBotRunner.runPeriodicItems(mlBot);
 388             listServer.processIncoming();
 389             listServer.processIncoming();
 390 
 391             // Make several file specific comments
 392             var first = pr.addReviewComment(masterHash, editHash, reviewFile.toString(), 2, &quot;Review comment&quot;);
 393             pr.addReviewComment(masterHash, editHash, reviewFile.toString(), 2, &quot;Another review comment&quot;);
 394             pr.addReviewComment(masterHash, editHash, reviewFile.toString(), 2, &quot;Further review comment&quot;);
 395             pr.addReviewComment(masterHash, editHash, reviewFile.toString(), 2, &quot;Final review comment&quot;);
 396             TestBotRunner.runPeriodicItems(mlBot);
 397             listServer.processIncoming();
 398 
 399             // The archive should contain a combined entry
 400             Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);
 401             assertEquals(2, archiveContainsCount(archiveFolder.path(), &quot;^On.*wrote:&quot;));
 402 
 403             // As well as the mailing list
 404             var mailmanServer = MailingListServerFactory.createMailmanServer(listServer.getArchive(), listServer.getSMTP(), Duration.ZERO);
 405             var mailmanList = mailmanServer.getList(listAddress.address());
 406             var conversations = mailmanList.conversations(Duration.ofDays(1));
 407             assertEquals(1, conversations.size());
 408             var mail = conversations.get(0).first();
 409             assertEquals(&quot;RFR: This is a pull request&quot;, mail.subject());
 410             assertEquals(3, conversations.get(0).allMessages().size());
 411 
 412             var commentReply = conversations.get(0).replies(mail).get(0);
 413             assertEquals(2, commentReply.body().split(&quot;^On.*wrote:&quot;).length);
 414             assertTrue(commentReply.body().contains(&quot;Avoid combining\n\n&quot;), commentReply.body());
 415 
 416             var reviewReply = conversations.get(0).replies(mail).get(1);
 417             assertEquals(2, reviewReply.body().split(&quot;^On.*wrote:&quot;).length);
 418             assertEquals(2, reviewReply.body().split(&quot;&gt; This is now ready&quot;).length, reviewReply.body());
 419             assertEquals(&quot;Re: RFR: This is a pull request&quot;, reviewReply.subject());
 420             assertTrue(reviewReply.body().contains(&quot;Review comment\n\n&quot;), reviewReply.body());
 421             assertTrue(reviewReply.body().contains(&quot;Another review comment&quot;), reviewReply.body());
 422 
 423             // Now reply to the first (collapsed) comment
 424             pr.addReviewCommentReply(first, &quot;I agree&quot;);
 425             TestBotRunner.runPeriodicItems(mlBot);
 426             listServer.processIncoming();
 427 
 428             // The archive should contain a new entry
 429             Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);
 430             assertEquals(3, archiveContainsCount(archiveFolder.path(), &quot;^On.*wrote:&quot;));
 431 
 432             // The combined review comments should only appear unquoted once
 433             assertEquals(1, archiveContainsCount(archiveFolder.path(), &quot;^Another review comment&quot;));
 434         }
 435     }
 436 
 437     @Test
 438     void commentThreading(TestInfo testInfo) throws IOException {
 439         try (var credentials = new HostCredentials(testInfo);
 440              var tempFolder = new TemporaryDirectory();
 441              var archiveFolder = new TemporaryDirectory();
 442              var listServer = new TestMailmanServer()) {
 443             var author = credentials.getHostedRepository();
 444             var reviewer = credentials.getHostedRepository();
 445             var archive = credentials.getHostedRepository();
 446             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
 447             var censusBuilder = credentials.getCensusBuilder()
 448                                            .addReviewer(reviewer.forge().currentUser().id())
 449                                            .addAuthor(author.forge().currentUser().id());
 450             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
 451             var mlBot = new MailingListBridgeBot(from, author, archive, &quot;master&quot;,
 452                                                  censusBuilder.build(), &quot;master&quot;,
 453                                                  listAddress, Set.of(), Set.of(),
 454                                                  listServer.getArchive(),
 455                                                  listServer.getSMTP(),
 456                                                  archive, &quot;webrev&quot;, Path.of(&quot;test&quot;),
 457                                                  URIBuilder.base(&quot;http://www.test.test/&quot;).build(),
 458                                                  Set.of(), Map.of(),
 459                                                  URIBuilder.base(&quot;http://issues.test/browse/&quot;).build(),
 460                                                  Map.of(), Duration.ZERO);
 461 
 462             // Populate the projects repository
 463             var reviewFile = Path.of(&quot;reviewfile.txt&quot;);
 464             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType(), reviewFile);
 465             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
 466             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
 467             localRepo.push(masterHash, archive.url(), &quot;webrev&quot;, true);
 468 
 469             // Make a change with a corresponding PR
 470             var editHash = CheckableRepository.appendAndCommit(localRepo);
 471             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
 472             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
 473             pr.setBody(&quot;This is now ready&quot;);
 474             TestBotRunner.runPeriodicItems(mlBot);
 475             listServer.processIncoming();
 476 
 477             // Make a file specific comment
 478             var reviewPr = reviewer.pullRequest(pr.id());
 479             var comment1 = reviewPr.addReviewComment(masterHash, editHash, reviewFile.toString(), 2, &quot;Review comment&quot;);
 480             pr.addReviewCommentReply(comment1, &quot;I agree&quot;);
 481             reviewPr.addReviewCommentReply(comment1, &quot;Great&quot;);
 482             TestBotRunner.runPeriodicItems(mlBot);
 483             listServer.processIncoming();
 484             listServer.processIncoming();
 485             listServer.processIncoming();
 486 
 487             // And a second one by ourselves
 488             var comment2 = pr.addReviewComment(masterHash, editHash, reviewFile.toString(), 2, &quot;Another review comment&quot;);
 489             reviewPr.addReviewCommentReply(comment2, &quot;Sounds good&quot;);
 490             pr.addReviewCommentReply(comment2, &quot;Thanks&quot;);
 491             TestBotRunner.runPeriodicItems(mlBot);
 492             listServer.processIncoming();
 493             listServer.processIncoming();
 494             listServer.processIncoming();
 495 
 496             // Finally some approvals and another comment
 497             pr.addReview(Review.Verdict.APPROVED, &quot;Nice&quot;);
 498             reviewPr.addReviewComment(masterHash, editHash, reviewFile.toString(), 2, &quot;The final review comment&quot;);
 499             reviewPr.addReview(Review.Verdict.APPROVED, &quot;Looks fine&quot;);
 500             reviewPr.addReviewCommentReply(comment2, &quot;You are welcome&quot;);
 501             TestBotRunner.runPeriodicItems(mlBot);
 502             listServer.processIncoming();
 503             listServer.processIncoming();
 504             listServer.processIncoming();
 505 
 506             // Sanity check the archive
 507             Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);
 508             assertEquals(9, archiveContainsCount(archiveFolder.path(), &quot;^On.*wrote:&quot;));
 509 
 510             // File specific comments should appear after the approval
 511             var archiveText = archiveContents(archiveFolder.path()).orElseThrow();
 512             assertTrue(archiveText.indexOf(&quot;Looks fine&quot;) &lt; archiveText.indexOf(&quot;The final review comment&quot;));
 513 
 514             // Check the mailing list
 515             var mailmanServer = MailingListServerFactory.createMailmanServer(listServer.getArchive(), listServer.getSMTP(), Duration.ZERO);
 516             var mailmanList = mailmanServer.getList(listAddress.address());
 517             var conversations = mailmanList.conversations(Duration.ofDays(1));
 518             assertEquals(1, conversations.size());
 519             var mail = conversations.get(0).first();
 520             assertEquals(&quot;RFR: This is a pull request&quot;, mail.subject());
 521             assertEquals(10, conversations.get(0).allMessages().size());
 522 
 523             // There should be four separate threads
 524             var thread1 = conversations.get(0).replies(mail).get(0);
 525             assertEquals(2, thread1.body().split(&quot;^On.*wrote:&quot;).length);
 526             assertEquals(2, thread1.body().split(&quot;&gt; This is now ready&quot;).length, thread1.body());
 527             assertEquals(&quot;Re: RFR: This is a pull request&quot;, thread1.subject());
 528             assertTrue(thread1.body().contains(&quot;Review comment\n\n&quot;), thread1.body());
 529             assertFalse(thread1.body().contains(&quot;Another review comment&quot;), thread1.body());
 530             var thread1reply1 = conversations.get(0).replies(thread1).get(0);
 531             assertTrue(thread1reply1.body().contains(&quot;I agree&quot;));
 532             assertEquals(noreplyAddress(archive), thread1reply1.author().address());
 533             assertEquals(archive.forge().currentUser().fullName(), thread1reply1.author().fullName().orElseThrow());
 534             var thread1reply2 = conversations.get(0).replies(thread1reply1).get(0);
 535             assertTrue(thread1reply2.body().contains(&quot;Great&quot;));
 536             assertEquals(&quot;integrationreviewer1@openjdk.java.net&quot;, thread1reply2.author().address());
 537             assertEquals(&quot;Generated Reviewer 1&quot;, thread1reply2.author().fullName().orElseThrow());
 538 
 539             var thread2 = conversations.get(0).replies(mail).get(1);
 540             assertEquals(2, thread2.body().split(&quot;^On.*wrote:&quot;).length);
 541             assertEquals(2, thread2.body().split(&quot;&gt; This is now ready&quot;).length, thread2.body());
 542             assertEquals(&quot;Re: RFR: This is a pull request&quot;, thread2.subject());
 543             assertFalse(thread2.body().contains(&quot;Review comment\n\n&quot;), thread2.body());
 544             assertTrue(thread2.body().contains(&quot;Another review comment&quot;), thread2.body());
 545             var thread2reply1 = conversations.get(0).replies(thread2).get(0);
 546             assertTrue(thread2reply1.body().contains(&quot;Sounds good&quot;));
 547             var thread2reply2 = conversations.get(0).replies(thread2reply1).get(0);
 548             assertTrue(thread2reply2.body().contains(&quot;Thanks&quot;));
 549 
 550             var replies = conversations.get(0).replies(mail);
 551             var thread3 = replies.get(2);
 552             assertEquals(&quot;Re: RFR: This is a pull request&quot;, thread3.subject());
 553             var thread4 = replies.get(3);
 554             assertEquals(&quot;Re: RFR: This is a pull request&quot;, thread4.subject());
 555             assertTrue(thread4.body().contains(&quot;Looks fine&quot;));
 556             assertTrue(thread4.body().contains(&quot;The final review comment&quot;));
 557             assertTrue(thread4.body().contains(&quot;Marked as reviewed by integrationreviewer1 (Reviewer)&quot;));
 558         }
 559     }
 560 
 561     @Test
 562     void commentThreadingSeparated(TestInfo testInfo) throws IOException {
 563         try (var credentials = new HostCredentials(testInfo);
 564              var tempFolder = new TemporaryDirectory();
 565              var archiveFolder = new TemporaryDirectory();
 566              var listServer = new TestMailmanServer()) {
 567             var author = credentials.getHostedRepository();
 568             var reviewer = credentials.getHostedRepository();
 569             var archive = credentials.getHostedRepository();
 570             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
 571             var censusBuilder = credentials.getCensusBuilder()
 572                                            .addReviewer(reviewer.forge().currentUser().id())
 573                                            .addAuthor(author.forge().currentUser().id());
 574             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
 575             var mlBot = new MailingListBridgeBot(from, author, archive, &quot;master&quot;, censusBuilder.build(), &quot;master&quot;,
 576                                                  listAddress, Set.of(), Set.of(),
 577                                                  listServer.getArchive(),
 578                                                  listServer.getSMTP(),
 579                                                  archive, &quot;webrev&quot;, Path.of(&quot;test&quot;),
 580                                                  URIBuilder.base(&quot;http://www.test.test/&quot;).build(),
 581                                                  Set.of(), Map.of(),
 582                                                  URIBuilder.base(&quot;http://issues.test/browse/&quot;).build(),
 583                                                  Map.of(), Duration.ZERO);
 584 
 585             // Populate the projects repository
 586             var reviewFile = Path.of(&quot;reviewfile.txt&quot;);
 587             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType(), reviewFile);
 588             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
 589             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
 590             localRepo.push(masterHash, archive.url(), &quot;webrev&quot;, true);
 591 
 592             // Make a change with a corresponding PR
 593             var editHash = CheckableRepository.appendAndCommit(localRepo);
 594             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
 595             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
 596             pr.setBody(&quot;This is now ready&quot;);
 597             TestBotRunner.runPeriodicItems(mlBot);
 598             listServer.processIncoming();
 599 
 600             // Make two file specific comments
 601             var reviewPr = reviewer.pullRequest(pr.id());
 602             var comment1 = reviewPr.addReviewComment(masterHash, editHash, reviewFile.toString(), 2, &quot;Review comment&quot;);
 603             var comment2 = reviewPr.addReviewComment(masterHash, editHash, reviewFile.toString(), 2, &quot;Another review comment&quot;);
 604             TestBotRunner.runPeriodicItems(mlBot);
 605             listServer.processIncoming();
 606 
 607             pr.addReviewCommentReply(comment1, &quot;I agree&quot;);
 608             pr.addReviewCommentReply(comment2, &quot;I don&#39;t agree&quot;);
 609             TestBotRunner.runPeriodicItems(mlBot);
 610             listServer.processIncoming();
 611 
 612             // Sanity check the archive
 613             Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);
 614             assertEquals(3, archiveContainsCount(archiveFolder.path(), &quot;^On.*wrote:&quot;));
 615         }
 616     }
 617 
 618     @Test
 619     void reviewContext(TestInfo testInfo) throws IOException {
 620         try (var credentials = new HostCredentials(testInfo);
 621              var tempFolder = new TemporaryDirectory();
 622              var archiveFolder = new TemporaryDirectory();
 623              var listServer = new TestMailmanServer()) {
 624             var author = credentials.getHostedRepository();
 625             var archive = credentials.getHostedRepository();
 626             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
 627             var censusBuilder = credentials.getCensusBuilder()
 628                                            .addAuthor(author.forge().currentUser().id());
 629             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
 630             var mlBot = new MailingListBridgeBot(from, author, archive, &quot;master&quot;,
 631                                                  censusBuilder.build(), &quot;master&quot;,
 632                                                  listAddress, Set.of(), Set.of(),
 633                                                  listServer.getArchive(),
 634                                                  listServer.getSMTP(),
 635                                                  archive, &quot;webrev&quot;, Path.of(&quot;test&quot;),
 636                                                  URIBuilder.base(&quot;http://www.test.test/&quot;).build(),
 637                                                  Set.of(), Map.of(),
 638                                                  URIBuilder.base(&quot;http://issues.test/browse/&quot;).build(),
 639                                                  Map.of(), Duration.ZERO);
 640 
 641             // Populate the projects repository
 642             var reviewFile = Path.of(&quot;reviewfile.txt&quot;);
 643             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType(), reviewFile);
 644             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
 645             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
 646             localRepo.push(masterHash, archive.url(), &quot;webrev&quot;, true);
 647 
 648             // Make a change with a corresponding PR
 649             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;Line 1\nLine 2\nLine 3\nLine 4&quot;);
 650             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
 651             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
 652             pr.setBody(&quot;This is now ready&quot;);
 653             TestBotRunner.runPeriodicItems(mlBot);
 654             listServer.processIncoming();
 655 
 656             // Make a file specific comment
 657             pr.addReviewComment(masterHash, editHash, reviewFile.toString(), 2, &quot;Review comment&quot;);
 658 
 659             TestBotRunner.runPeriodicItems(mlBot);
 660             listServer.processIncoming();
 661 
 662             // The archive should only contain context around line 2
 663             Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);
 664             assertTrue(archiveContains(archiveFolder.path(), &quot;^&gt; 2: Line 1$&quot;));
 665             assertTrue(archiveContains(archiveFolder.path(), &quot;^&gt; 3: Line 2$&quot;));
 666             assertFalse(archiveContains(archiveFolder.path(), &quot;^&gt; 4: Line 3$&quot;));
 667         }
 668     }
 669 
 670     @Test
 671     void multipleReviewContexts(TestInfo testInfo) throws IOException {
 672         try (var credentials = new HostCredentials(testInfo);
 673              var tempFolder = new TemporaryDirectory();
 674              var archiveFolder = new TemporaryDirectory();
 675              var listServer = new TestMailmanServer()) {
 676             var author = credentials.getHostedRepository();
 677             var archive = credentials.getHostedRepository();
 678             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
 679             var censusBuilder = credentials.getCensusBuilder()
 680                                            .addAuthor(author.forge().currentUser().id());
 681             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
 682             var mlBot = new MailingListBridgeBot(from, author, archive, &quot;master&quot;,
 683                                                  censusBuilder.build(), &quot;master&quot;,
 684                                                  listAddress, Set.of(), Set.of(),
 685                                                  listServer.getArchive(),
 686                                                  listServer.getSMTP(),
 687                                                  archive, &quot;webrev&quot;, Path.of(&quot;test&quot;),
 688                                                  URIBuilder.base(&quot;http://www.test.test/&quot;).build(),
 689                                                  Set.of(), Map.of(),
 690                                                  URIBuilder.base(&quot;http://issues.test/browse/&quot;).build(),
 691                                                  Map.of(), Duration.ZERO);
 692 
 693             // Populate the projects repository
 694             var reviewFile = Path.of(&quot;reviewfile.txt&quot;);
 695             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType(), reviewFile);
 696             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
 697             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
 698             localRepo.push(masterHash, archive.url(), &quot;webrev&quot;, true);
 699             var initialHash = CheckableRepository.appendAndCommit(localRepo,
 700                                                                   &quot;Line 0.1\nLine 0.2\nLine 0.3\nLine 0.4\n&quot; +
 701                                                                           &quot;Line 1\nLine 2\nLine 3\nLine 4\n&quot; +
 702                                                                           &quot;Line 5\nLine 6\nLine 7\nLine 8\n&quot; +
 703                                                                           &quot;Line 8.1\nLine 8.2\nLine 8.3\nLine 8.4\n&quot; +
 704                                                                           &quot;Line 9\nLine 10\nLine 11\nLine 12\n&quot; +
 705                                                                           &quot;Line 13\nLine 14\nLine 15\nLine 16\n&quot;);
 706             localRepo.push(initialHash, author.url(), &quot;master&quot;);
 707 
 708             // Make a change with a corresponding PR
 709             var current = Files.readString(localRepo.root().resolve(reviewFile), StandardCharsets.UTF_8);
 710             var updated = current.replaceAll(&quot;Line 2&quot;, &quot;Line 2 edit\nLine 2.5&quot;);
 711             updated = updated.replaceAll(&quot;Line 13&quot;, &quot;Line 12.5\nLine 13 edit&quot;);
 712             Files.writeString(localRepo.root().resolve(reviewFile), updated, StandardCharsets.UTF_8);
 713             var editHash = CheckableRepository.appendAndCommit(localRepo);
 714             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
 715             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
 716             pr.setBody(&quot;This is now ready&quot;);
 717             TestBotRunner.runPeriodicItems(mlBot);
 718             listServer.processIncoming();
 719 
 720             // Make file specific comments
 721             pr.addReviewComment(masterHash, editHash, reviewFile.toString(), 7, &quot;Review comment&quot;);
 722             pr.addReviewComment(masterHash, editHash, reviewFile.toString(), 24, &quot;Another review comment&quot;);
 723 
 724             TestBotRunner.runPeriodicItems(mlBot);
 725             listServer.processIncoming();
 726 
 727             // The archive should only contain context around line 2 and 20
 728             Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);
 729             assertTrue(archiveContains(archiveFolder.path(), &quot;reviewfile.txt line 7&quot;));
 730             assertTrue(archiveContains(archiveFolder.path(), &quot;^&gt; 6: Line 1$&quot;));
 731             assertTrue(archiveContains(archiveFolder.path(), &quot;^&gt; 7: Line 2 edit$&quot;));
 732             assertFalse(archiveContains(archiveFolder.path(), &quot;Line 3&quot;));
 733 
 734             assertTrue(archiveContains(archiveFolder.path(), &quot;reviewfile.txt line 24&quot;));
 735             assertTrue(archiveContains(archiveFolder.path(), &quot;^&gt; 23: Line 12.5$&quot;));
 736             assertTrue(archiveContains(archiveFolder.path(), &quot;^&gt; 24: Line 13 edit$&quot;));
 737             assertFalse(archiveContains(archiveFolder.path(), &quot;^Line 15&quot;));
 738         }
 739     }
 740 
 741     @Test
 742     void filterComments(TestInfo testInfo) throws IOException {
 743         try (var credentials = new HostCredentials(testInfo);
 744              var tempFolder = new TemporaryDirectory();
 745              var archiveFolder = new TemporaryDirectory();
 746              var listServer = new TestMailmanServer()) {
 747             var author = credentials.getHostedRepository();
 748             var archive = credentials.getHostedRepository();
 749             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
 750             var censusBuilder = credentials.getCensusBuilder()
 751                                            .addAuthor(author.forge().currentUser().id());
 752             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
 753             var mlBot = new MailingListBridgeBot(from, author, archive, &quot;master&quot;,
 754                                                  censusBuilder.build(), &quot;master&quot;,
 755                                                  listAddress, Set.of(), Set.of(),
 756                                                  listServer.getArchive(), listServer.getSMTP(),
 757                                                  archive, &quot;webrev&quot;, Path.of(&quot;test&quot;),
 758                                                  URIBuilder.base(&quot;http://www.test.test/&quot;).build(),
 759                                                  Set.of(), Map.of(),
 760                                                  URIBuilder.base(&quot;http://issues.test/browse/&quot;).build(),
 761                                                  Map.of(), Duration.ZERO);
 762 
 763             // Populate the projects repository
 764             var reviewFile = Path.of(&quot;reviewfile.txt&quot;);
 765             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType(), reviewFile);
 766             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
 767             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
 768             localRepo.push(masterHash, archive.url(), &quot;webrev&quot;, true);
 769 
 770             // Make a change with a corresponding PR
 771             var editHash = CheckableRepository.appendAndCommit(localRepo);
 772             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
 773             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
 774             pr.setBody(&quot;This is now ready\n&lt;!-- this is a comment --&gt;\nAnd this is not\n&quot; +
 775                                &quot;&lt;!-- Anything below this marker will be hidden --&gt;\nStatus stuff&quot;);
 776 
 777             // Make a bunch of comments
 778             pr.addComment(&quot;Plain comment\n&lt;!-- this is a comment --&gt;&quot;);
 779             pr.addReviewComment(masterHash, editHash, reviewFile.toString(), 2, &quot;Review comment &lt;!-- this is a comment --&gt;\n&quot;);
 780             pr.addComment(&quot;/integrate stuff&quot;);
 781             TestBotRunner.runPeriodicItems(mlBot);
 782 
 783             // Run an archive pass
 784             TestBotRunner.runPeriodicItems(mlBot);
 785 
 786             // The archive should not contain the comment
 787             Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);
 788             assertTrue(archiveContains(archiveFolder.path(), &quot;This is now ready&quot;));
 789             assertFalse(archiveContains(archiveFolder.path(), &quot;this is a comment&quot;));
 790             assertFalse(archiveContains(archiveFolder.path(), &quot;Status stuff&quot;));
 791             assertTrue(archiveContains(archiveFolder.path(), &quot;And this is not&quot;));
 792             assertFalse(archiveContains(archiveFolder.path(), &quot;&lt;!--&quot;));
 793             assertFalse(archiveContains(archiveFolder.path(), &quot;--&gt;&quot;));
 794             assertTrue(archiveContains(archiveFolder.path(), &quot;Plain comment&quot;));
 795             assertTrue(archiveContains(archiveFolder.path(), &quot;Review comment&quot;));
 796             assertFalse(archiveContains(archiveFolder.path(), &quot;/integrate&quot;));
 797         }
 798     }
 799 
 800     @Test
 801     void incrementalChanges(TestInfo testInfo) throws IOException {
 802         try (var credentials = new HostCredentials(testInfo);
 803              var tempFolder = new TemporaryDirectory();
 804              var archiveFolder = new TemporaryDirectory();
 805              var listServer = new TestMailmanServer()) {
 806             var author = credentials.getHostedRepository();
 807             var archive = credentials.getHostedRepository();
 808             var commenter = credentials.getHostedRepository();
 809             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
 810             var censusBuilder = credentials.getCensusBuilder()
 811                                            .addAuthor(author.forge().currentUser().id());
 812             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
 813             var mlBot = new MailingListBridgeBot(from, author, archive, &quot;master&quot;,
 814                                                  censusBuilder.build(), &quot;master&quot;,
 815                                                  listAddress, Set.of(), Set.of(),
 816                                                  listServer.getArchive(), listServer.getSMTP(),
 817                                                  archive, &quot;webrev&quot;, Path.of(&quot;test&quot;),
 818                                                  URIBuilder.base(&quot;http://www.test.test/&quot;).build(),
 819                                                  Set.of(), Map.of(),
 820                                                  URIBuilder.base(&quot;http://issues.test/browse/&quot;).build(),
 821                                                  Map.of(), Duration.ZERO);
 822 
 823             // Populate the projects repository
 824             var reviewFile = Path.of(&quot;reviewfile.txt&quot;);
 825             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType(), reviewFile);
 826             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
 827             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
 828             localRepo.push(masterHash, archive.url(), &quot;webrev&quot;, true);
 829 
 830             // Make a change with a corresponding PR
 831             var editHash = CheckableRepository.appendAndCommit(localRepo);
 832             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
 833             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
 834             pr.setBody(&quot;This is now ready&quot;);
 835 
 836             // Run an archive pass
 837             TestBotRunner.runPeriodicItems(mlBot);
 838             listServer.processIncoming();
 839 
 840             var nextHash = CheckableRepository.appendAndCommit(localRepo, &quot;Yet one more line&quot;, &quot;Fixing&quot;);
 841             localRepo.push(nextHash, author.url(), &quot;edit&quot;);
 842 
 843             // Make sure that the push registered
 844             var lastHeadHash = pr.headHash();
 845             var refreshCount = 0;
 846             do {
 847                 pr = author.pullRequest(pr.id());
 848                 if (refreshCount++ &gt; 100) {
 849                     fail(&quot;The PR did not update after the new push&quot;);
 850                 }
 851             } while (pr.headHash().equals(lastHeadHash));
 852 
 853             // Run another archive pass
 854             TestBotRunner.runPeriodicItems(mlBot);
 855             TestBotRunner.runPeriodicItems(mlBot);
 856             TestBotRunner.runPeriodicItems(mlBot);
 857             listServer.processIncoming();
 858 
 859             // The archive should reference the updated push
 860             Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);
 861             assertTrue(archiveContains(archiveFolder.path(), &quot;1 additional commit&quot;));
 862             assertTrue(archiveContains(archiveFolder.path(), &quot;full.*/&quot; + pr.id() + &quot;/webrev.01&quot;));
 863             assertTrue(archiveContains(archiveFolder.path(), &quot;inc.*/&quot; + pr.id() + &quot;/webrev.00-01&quot;));
 864             assertTrue(archiveContains(archiveFolder.path(), &quot;Patch&quot;));
 865             assertTrue(archiveContains(archiveFolder.path(), &quot;Fetch&quot;));
 866             assertTrue(archiveContains(archiveFolder.path(), &quot;Fixing&quot;));
 867 
 868             // The webrev comment should be updated
 869             var comments = pr.comments();
 870             var webrevComments = comments.stream()
 871                                          .filter(comment -&gt; comment.author().equals(author.forge().currentUser()))
 872                                          .filter(comment -&gt; comment.body().contains(&quot;webrev&quot;))
 873                                          .filter(comment -&gt; comment.body().contains(nextHash.hex()))
 874                                          .filter(comment -&gt; comment.body().contains(editHash.hex()))
 875                                          .collect(Collectors.toList());
 876             assertEquals(1, webrevComments.size());
 877 
 878             // Check that sender address is set properly
 879             var mailmanServer = MailingListServerFactory.createMailmanServer(listServer.getArchive(), listServer.getSMTP(), Duration.ZERO);
 880             var mailmanList = mailmanServer.getList(listAddress.address());
 881             var conversations = mailmanList.conversations(Duration.ofDays(1));
 882             assertEquals(1, conversations.size());
 883             for (var newMail : conversations.get(0).allMessages()) {
 884                 assertEquals(noreplyAddress(archive), newMail.author().address());
 885                 assertEquals(listAddress, newMail.sender());
 886             }
 887 
 888             // Add a comment
 889             var commenterPr = commenter.pullRequest(pr.id());
 890             commenterPr.addReviewComment(masterHash, nextHash, reviewFile.toString(), 2, &quot;Review comment&quot;);
 891             TestBotRunner.runPeriodicItems(mlBot);
 892             listServer.processIncoming();
 893 
 894             // Ensure that additional updates are only reported once
 895             for (int i = 0; i &lt; 3; ++i) {
 896                 var anotherHash = CheckableRepository.appendAndCommit(localRepo, &quot;Another line&quot;, &quot;Fixing&quot;);
 897                 localRepo.push(anotherHash, author.url(), &quot;edit&quot;);
 898 
 899                 // Make sure that the push registered
 900                 lastHeadHash = pr.headHash();
 901                 refreshCount = 0;
 902                 do {
 903                     pr = author.pullRequest(pr.id());
 904                     if (refreshCount++ &gt; 100) {
 905                         fail(&quot;The PR did not update after the new push&quot;);
 906                     }
 907                 } while (pr.headHash().equals(lastHeadHash));
 908 
 909                 TestBotRunner.runPeriodicItems(mlBot);
 910                 TestBotRunner.runPeriodicItems(mlBot);
 911                 listServer.processIncoming();
 912             }
 913             var updatedConversations = mailmanList.conversations(Duration.ofDays(1));
 914             assertEquals(1, updatedConversations.size());
 915             var conversation = updatedConversations.get(0);
 916             assertEquals(6, conversation.allMessages().size());
 917             assertEquals(&quot;Re: [Rev 01] RFR: This is a pull request&quot;, conversation.allMessages().get(1).subject());
 918             assertEquals(&quot;Re: [Rev 01] RFR: This is a pull request&quot;, conversation.allMessages().get(2).subject(), conversation.allMessages().get(2).toString());
 919             assertEquals(&quot;Re: [Rev 04] RFR: This is a pull request&quot;, conversation.allMessages().get(5).subject());
 920         }
 921     }
 922 
 923     @Test
 924     void rebased(TestInfo testInfo) throws IOException {
 925         try (var credentials = new HostCredentials(testInfo);
 926              var tempFolder = new TemporaryDirectory();
 927              var archiveFolder = new TemporaryDirectory();
 928              var listServer = new TestMailmanServer()) {
 929             var author = credentials.getHostedRepository();
 930             var archive = credentials.getHostedRepository();
 931             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
 932             var censusBuilder = credentials.getCensusBuilder()
 933                                            .addAuthor(author.forge().currentUser().id());
 934             var sender = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
 935             var mlBot = new MailingListBridgeBot(sender, author, archive, &quot;master&quot;,
 936                                                  censusBuilder.build(), &quot;master&quot;,
 937                                                  listAddress, Set.of(), Set.of(),
 938                                                  listServer.getArchive(), listServer.getSMTP(),
 939                                                  archive, &quot;webrev&quot;, Path.of(&quot;test&quot;),
 940                                                  URIBuilder.base(&quot;http://www.test.test/&quot;).build(),
 941                                                  Set.of(), Map.of(),
 942                                                  URIBuilder.base(&quot;http://issues.test/browse/&quot;).build(),
 943                                                  Map.of(), Duration.ZERO);
 944 
 945             // Populate the projects repository
 946             var reviewFile = Path.of(&quot;reviewfile.txt&quot;);
 947             var localRepo = CheckableRepository.init(tempFolder.path().resolve(&quot;first&quot;), author.repositoryType(), reviewFile);
 948             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
 949             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
 950             localRepo.push(masterHash, archive.url(), &quot;webrev&quot;, true);
 951 
 952             // Make a change with a corresponding PR
 953             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;A line&quot;, &quot;Original msg&quot;);
 954             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
 955             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
 956             pr.setBody(&quot;This is now ready&quot;);
 957 
 958             // Run an archive pass
 959             TestBotRunner.runPeriodicItems(mlBot);
 960             listServer.processIncoming();
 961 
 962             var newLocalRepo = Repository.materialize(tempFolder.path().resolve(&quot;second&quot;), author.url(), &quot;master&quot;);
 963             var newEditHash = CheckableRepository.appendAndCommit(newLocalRepo, &quot;Another line&quot;, &quot;Replaced msg&quot;);
 964             newLocalRepo.push(newEditHash, author.url(), &quot;edit&quot;, true);
 965 
 966             // Make sure that the push registered
 967             var lastHeadHash = pr.headHash();
 968             var refreshCount = 0;
 969             do {
 970                 pr = author.pullRequest(pr.id());
 971                 if (refreshCount++ &gt; 100) {
 972                     fail(&quot;The PR did not update after the new push&quot;);
 973                 }
 974             } while (pr.headHash().equals(lastHeadHash));
 975 
 976             // Run another archive pass
 977             TestBotRunner.runPeriodicItems(mlBot);
 978             listServer.processIncoming();
 979 
 980             // The archive should reference the rebased push
 981             Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);
 982             assertTrue(archiveContains(archiveFolder.path(), &quot;updated with a new target base&quot;));
 983             assertTrue(archiveContains(archiveFolder.path(), pr.id() + &quot;/webrev.01&quot;));
 984             assertFalse(archiveContains(archiveFolder.path(), &quot;Incremental&quot;));
 985             assertTrue(archiveContains(archiveFolder.path(), &quot;Patch&quot;));
 986             assertTrue(archiveContains(archiveFolder.path(), &quot;Fetch&quot;));
 987             assertTrue(archiveContains(archiveFolder.path(), &quot;Original msg&quot;));
 988             assertTrue(archiveContains(archiveFolder.path(), &quot;Replaced msg&quot;));
 989 
 990             // The webrev comment should be updated
 991             var comments = pr.comments();
 992             var webrevComments = comments.stream()
 993                                          .filter(comment -&gt; comment.author().equals(author.forge().currentUser()))
 994                                          .filter(comment -&gt; comment.body().contains(&quot;webrev&quot;))
 995                                          .filter(comment -&gt; comment.body().contains(newEditHash.hex()))
 996                                          .collect(Collectors.toList());
 997             assertEquals(1, webrevComments.size());
 998 
 999             // Check that sender address is set properly
1000             var mailmanServer = MailingListServerFactory.createMailmanServer(listServer.getArchive(), listServer.getSMTP(), Duration.ZERO);
1001             var mailmanList = mailmanServer.getList(listAddress.address());
1002             var conversations = mailmanList.conversations(Duration.ofDays(1));
1003             assertEquals(1, conversations.size());
1004             for (var newMail : conversations.get(0).allMessages()) {
1005                 assertEquals(noreplyAddress(archive), newMail.author().address());
1006                 assertEquals(listAddress, newMail.sender());
1007                 assertFalse(newMail.hasHeader(&quot;PR-Head-Hash&quot;));
1008             }
1009             assertEquals(&quot;Re: [Rev 01] RFR: This is a pull request&quot;, conversations.get(0).allMessages().get(1).subject());
1010         }
1011     }
1012 
1013     @Test
1014     void skipAddingExistingWebrev(TestInfo testInfo) throws IOException {
1015         try (var credentials = new HostCredentials(testInfo);
1016              var tempFolder = new TemporaryDirectory();
1017              var archiveFolder = new TemporaryDirectory();
1018              var webrevFolder = new TemporaryDirectory();
1019              var listServer = new TestMailmanServer()) {
1020             var author = credentials.getHostedRepository();
1021             var archive = credentials.getHostedRepository();
1022             var ignored = credentials.getHostedRepository();
1023             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
1024             var censusBuilder = credentials.getCensusBuilder()
1025                                            .addAuthor(author.forge().currentUser().id());
1026             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
1027             var mlBot = new MailingListBridgeBot(from, author, archive, &quot;master&quot;,
1028                                                  censusBuilder.build(), &quot;master&quot;,
1029                                                  listAddress,
1030                                                  Set.of(ignored.forge().currentUser().userName()),
1031                                                  Set.of(),
1032                                                  listServer.getArchive(), listServer.getSMTP(),
1033                                                  archive, &quot;webrev&quot;, Path.of(&quot;test&quot;),
1034                                                  URIBuilder.base(&quot;http://www.test.test/&quot;).build(),
1035                                                  Set.of(), Map.of(),
1036                                                  URIBuilder.base(&quot;http://issues.test/browse/&quot;).build(),
1037                                                  Map.of(), Duration.ZERO);
1038 
1039             // Populate the projects repository
1040             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType());
1041             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
1042             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
1043             localRepo.push(masterHash, archive.url(), &quot;webrev&quot;, true);
1044 
1045             // Make a change with a corresponding PR
1046             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;A simple change&quot;,
1047                                                                &quot;Change msg\n\nWith several lines&quot;);
1048             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
1049             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
1050 
1051             // Flag it as ready for review
1052             pr.setBody(&quot;This should now be ready&quot;);
1053 
1054             // Run an archive pass
1055             TestBotRunner.runPeriodicItems(mlBot);
1056 
1057             // The archive should now contain an entry
1058             var archiveRepo = Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);
1059             assertTrue(archiveContains(archiveFolder.path(), editHash.abbreviate()));
1060 
1061             // And there should be a webrev comment
1062             var comments = pr.comments();
1063             var webrevComments = comments.stream()
1064                                          .filter(comment -&gt; comment.author().equals(author.forge().currentUser()))
1065                                          .filter(comment -&gt; comment.body().contains(&quot;webrev&quot;))
1066                                          .filter(comment -&gt; comment.body().contains(editHash.hex()))
1067                                          .collect(Collectors.toList());
1068             assertEquals(1, webrevComments.size());
1069             assertEquals(1, countSubstrings(webrevComments.get(0).body(), &quot;webrev.00&quot;));
1070 
1071             // Pretend the archive didn&#39;t work out
1072             archiveRepo.push(masterHash, archive.url(), &quot;master&quot;, true);
1073 
1074             // Run another archive pass
1075             TestBotRunner.runPeriodicItems(mlBot);
1076 
1077             // The webrev comment should not contain duplicate entries
1078             comments = pr.comments();
1079             webrevComments = comments.stream()
1080                                          .filter(comment -&gt; comment.author().equals(author.forge().currentUser()))
1081                                          .filter(comment -&gt; comment.body().contains(&quot;webrev&quot;))
1082                                          .filter(comment -&gt; comment.body().contains(editHash.hex()))
1083                                          .collect(Collectors.toList());
1084             assertEquals(1, webrevComments.size());
1085             assertEquals(1, countSubstrings(webrevComments.get(0).body(), &quot;webrev.00&quot;));
1086         }
1087     }
1088 
1089     @Test
1090     void notifyReviewVerdicts(TestInfo testInfo) throws IOException {
1091         try (var credentials = new HostCredentials(testInfo);
1092              var tempFolder = new TemporaryDirectory();
1093              var archiveFolder = new TemporaryDirectory();
1094              var listServer = new TestMailmanServer()) {
1095             var author = credentials.getHostedRepository();
1096             var archive = credentials.getHostedRepository();
1097             var reviewer = credentials.getHostedRepository();
1098             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
1099             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
1100             var censusBuilder = credentials.getCensusBuilder()
1101                                            .addReviewer(reviewer.forge().currentUser().id())
1102                                            .addAuthor(author.forge().currentUser().id());
1103             var mlBot = new MailingListBridgeBot(from, author, archive, &quot;master&quot;,
1104                                                  censusBuilder.build(), &quot;master&quot;,
1105                                                  listAddress, Set.of(), Set.of(),
1106                                                  listServer.getArchive(), listServer.getSMTP(),
1107                                                  archive, &quot;webrev&quot;, Path.of(&quot;test&quot;),
1108                                                  URIBuilder.base(&quot;http://www.test.test/&quot;).build(),
1109                                                  Set.of(), Map.of(),
1110                                                  URIBuilder.base(&quot;http://issues.test/browse/&quot;).build(),
1111                                                  Map.of(), Duration.ZERO);
1112 
1113             // Populate the projects repository
1114             var reviewFile = Path.of(&quot;reviewfile.txt&quot;);
1115             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType(), reviewFile);
1116             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
1117             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
1118             localRepo.push(masterHash, archive.url(), &quot;webrev&quot;, true);
1119 
1120             // Make a change with a corresponding PR
1121             var editHash = CheckableRepository.appendAndCommit(localRepo);
1122             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
1123             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
1124             pr.setBody(&quot;This is now ready&quot;);
1125 
1126             // Run an archive pass
1127             TestBotRunner.runPeriodicItems(mlBot);
1128 
1129             // First unapprove it
1130             var reviewedPr = reviewer.pullRequest(pr.id());
1131             reviewedPr.addReview(Review.Verdict.DISAPPROVED, &quot;Reason 1&quot;);
1132             TestBotRunner.runPeriodicItems(mlBot);
1133             TestBotRunner.runPeriodicItems(mlBot);
1134             TestBotRunner.runPeriodicItems(mlBot);
1135 
1136             // The archive should contain a note
1137             Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);
1138             assertEquals(1, archiveContainsCount(archiveFolder.path(), &quot;Changes requested by &quot;));
1139             assertEquals(1, archiveContainsCount(archiveFolder.path(), &quot; by integrationreviewer1&quot;));
1140             if (author.forge().supportsReviewBody()) {
1141                 assertEquals(1, archiveContainsCount(archiveFolder.path(), &quot;Reason 1&quot;));
1142             }
1143 
1144             // Then approve it
1145             reviewedPr.addReview(Review.Verdict.APPROVED, &quot;Reason 2&quot;);
1146             TestBotRunner.runPeriodicItems(mlBot);
1147             TestBotRunner.runPeriodicItems(mlBot);
1148             TestBotRunner.runPeriodicItems(mlBot);
1149 
1150             // The archive should contain another note
1151             Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);
1152             assertEquals(1, archiveContainsCount(archiveFolder.path(), &quot;Marked as reviewed by &quot;));
1153             if (author.forge().supportsReviewBody()) {
1154                 assertEquals(1, archiveContainsCount(archiveFolder.path(), &quot;Reason 2&quot;));
1155             }
1156             assertEquals(2, archiveContainsCount(archiveFolder.path(), &quot;Re: RFR:&quot;));
1157 
1158             // Yet another change
1159             reviewedPr.addReview(Review.Verdict.DISAPPROVED, &quot;Reason 3&quot;);
1160             TestBotRunner.runPeriodicItems(mlBot);
1161             TestBotRunner.runPeriodicItems(mlBot);
1162             TestBotRunner.runPeriodicItems(mlBot);
1163 
1164             // The archive should contain another note
1165             Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);
1166             assertEquals(2, archiveContainsCount(archiveFolder.path(), &quot;Changes requested by &quot;));
1167             if (author.forge().supportsReviewBody()) {
1168                 assertEquals(1, archiveContainsCount(archiveFolder.path(), &quot;Reason 3&quot;));
1169             }
1170         }
1171     }
1172 
1173     @Test
1174     void ignoreComments(TestInfo testInfo) throws IOException {
1175         try (var credentials = new HostCredentials(testInfo);
1176              var tempFolder = new TemporaryDirectory();
1177              var archiveFolder = new TemporaryDirectory();
1178              var listServer = new TestMailmanServer()) {
1179             var author = credentials.getHostedRepository();
1180             var ignored = credentials.getHostedRepository();
1181             var archive = credentials.getHostedRepository();
1182             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
1183             var censusBuilder = credentials.getCensusBuilder()
1184                                            .addAuthor(author.forge().currentUser().id());
1185             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
1186             var mlBot = new MailingListBridgeBot(from, author, archive, &quot;master&quot;,
1187                                                  censusBuilder.build(), &quot;master&quot;,
1188                                                  listAddress,
1189                                                  Set.of(ignored.forge().currentUser().userName()),
1190                                                  Set.of(Pattern.compile(&quot;ignore this comment&quot;, Pattern.MULTILINE | Pattern.DOTALL)),
1191                                                  listServer.getArchive(), listServer.getSMTP(),
1192                                                  archive, &quot;webrev&quot;, Path.of(&quot;test&quot;),
1193                                                  URIBuilder.base(&quot;http://www.test.test/&quot;).build(),
1194                                                  Set.of(), Map.of(),
1195                                                  URIBuilder.base(&quot;http://issues.test/browse/&quot;).build(),
1196                                                  Map.of(), Duration.ZERO);
1197 
1198             // Populate the projects repository
1199             var reviewFile = Path.of(&quot;reviewfile.txt&quot;);
1200             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType(), reviewFile);
1201             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
1202             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
1203             localRepo.push(masterHash, archive.url(), &quot;webrev&quot;, true);
1204 
1205             // Make a change with a corresponding PR
1206             var editHash = CheckableRepository.appendAndCommit(localRepo);
1207             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
1208             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
1209             pr.setBody(&quot;This is now ready&quot;);
1210 
1211             // Make a bunch of comments
1212             pr.addComment(&quot;Plain comment&quot;);
1213             pr.addComment(&quot;ignore this comment&quot;);
1214             pr.addComment(&quot;I think it is time to\nignore this comment!&quot;);
1215             pr.addReviewComment(masterHash, editHash, reviewFile.toString(), 2, &quot;Review ignore this comment&quot;);
1216 
1217             var ignoredPR = ignored.pullRequest(pr.id());
1218             ignoredPR.addComment(&quot;Don&#39;t mind me&quot;);
1219 
1220             TestBotRunner.runPeriodicItems(mlBot);
1221             TestBotRunner.runPeriodicItems(mlBot);
1222 
1223             // The archive should not contain the ignored comments
1224             Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);
1225             assertTrue(archiveContains(archiveFolder.path(), &quot;This is now ready&quot;));
1226             assertFalse(archiveContains(archiveFolder.path(), &quot;ignore this comment&quot;));
1227             assertFalse(archiveContains(archiveFolder.path(), &quot;it is time to&quot;));
1228             assertFalse(archiveContains(archiveFolder.path(), &quot;Don&#39;t mind me&quot;));
1229             assertFalse(archiveContains(archiveFolder.path(), &quot;Review ignore&quot;));
1230         }
1231     }
1232 }
    </pre>
  </body>
</html>