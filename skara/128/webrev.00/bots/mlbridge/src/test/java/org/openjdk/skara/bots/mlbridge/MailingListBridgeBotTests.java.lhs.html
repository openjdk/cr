<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Frames bots/mlbridge/src/test/java/org/openjdk/skara/bots/mlbridge/MailingListBridgeBotTests.java</title>
    <link rel="stylesheet" href="../../../../../../../../../../style.css" />
    <script type="text/javascript" src="../../../../../../../../../../navigation.js"></script>
  </head>
<body onkeypress="keypress(event);">
<a name="0"></a>
<hr />
<pre>   1 /*
   2  * Copyright (c) 2019, Oracle and/or its affiliates. All rights reserved.
   3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   4  *
   5  * This code is free software; you can redistribute it and/or modify it
   6  * under the terms of the GNU General Public License version 2 only, as
   7  * published by the Free Software Foundation.
   8  *
   9  * This code is distributed in the hope that it will be useful, but WITHOUT
  10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
  11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
  12  * version 2 for more details (a copy is included in the LICENSE file that
  13  * accompanied this code).
  14  *
  15  * You should have received a copy of the GNU General Public License version
  16  * 2 along with this work; if not, write to the Free Software Foundation,
  17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
  18  *
  19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
  20  * or visit www.oracle.com if you need additional information or have any
  21  * questions.
  22  */
  23 package org.openjdk.skara.bots.mlbridge;
  24 
  25 import org.openjdk.skara.email.EmailAddress;
  26 import org.openjdk.skara.host.*;
  27 import org.openjdk.skara.host.network.URIBuilder;
  28 import org.openjdk.skara.mailinglist.MailingListServerFactory;
  29 import org.openjdk.skara.test.*;
  30 import org.openjdk.skara.vcs.Repository;
  31 
  32 import org.junit.jupiter.api.*;
  33 
  34 import java.io.IOException;
  35 import java.nio.charset.StandardCharsets;
  36 import java.nio.file.*;
  37 import java.time.Duration;
  38 import java.util.*;
  39 import java.util.regex.Pattern;
  40 import java.util.stream.Collectors;
  41 
  42 import static org.junit.jupiter.api.Assertions.*;
  43 
  44 class MailingListBridgeBotTests {
  45     private boolean archiveContains(Path archive, String text) {
  46         return archiveContainsCount(archive, text) &gt; 0;
  47     }
  48 
  49     private int archiveContainsCount(Path archive, String text) {
  50         try {
  51             var mbox = Files.find(archive, 50, (path, attrs) -&gt; path.toString().endsWith(&quot;.mbox&quot;)).findAny();
  52             if (mbox.isEmpty()) {
  53                 return 0;
  54             }
  55             var lines = Files.readString(mbox.get(), StandardCharsets.UTF_8);
  56             var pattern = Pattern.compile(text);
  57             int count = 0;
  58             for (var line : lines.split(&quot;\\R&quot;)) {
  59                 var matcher = pattern.matcher(line);
  60                 if (matcher.find()) {
  61                     count++;
  62                 }
  63             }
  64             return count;
  65         } catch (IOException e) {
  66             return 0;
  67         }
  68     }
  69 
  70     private boolean webrevContains(Path webrev, String text) {
  71         try {
  72             var index = Files.find(webrev, 5, (path, attrs) -&gt; path.toString().endsWith(&quot;index.html&quot;)).findAny();
  73             if (index.isEmpty()) {
  74                 return false;
  75             }
  76             var lines = Files.readString(index.get(), StandardCharsets.UTF_8);
  77             return lines.contains(text);
  78         } catch (IOException e) {
  79             return false;
  80         }
  81     }
  82 
  83     private long countSubstrings(String string, String substring) {
  84         return Pattern.compile(substring).matcher(string).results().count();
  85     }
  86 
  87     private String noreplyAddress(HostedRepository repository) {
  88         return repository.host().getCurrentUserDetails().id() + &quot;+&quot; +
  89                 repository.host().getCurrentUserDetails().userName() +
  90                 &quot;@users.noreply.test&quot;;
  91     }
  92 
  93     @Test
  94     void simpleArchive(TestInfo testInfo) throws IOException {
  95         try (var credentials = new HostCredentials(testInfo);
  96              var tempFolder = new TemporaryDirectory();
  97              var archiveFolder = new TemporaryDirectory();
  98              var webrevFolder = new TemporaryDirectory();
  99              var listServer = new TestMailmanServer()) {
 100             var author = credentials.getHostedRepository();
 101             var archive = credentials.getHostedRepository();
 102             var ignored = credentials.getHostedRepository();
 103             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
 104             var censusBuilder = credentials.getCensusBuilder()
 105                                            .addAuthor(author.host().getCurrentUserDetails().id());
 106             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
 107             var mlBot = new MailingListBridgeBot(from, author, archive, censusBuilder.build(), &quot;master&quot;, listAddress,
 108                                                  Set.of(ignored.host().getCurrentUserDetails().userName()),
 109                                                  Set.of(),
 110                                                  listServer.getArchive(), listServer.getSMTP(),
 111                                                  archive, &quot;webrev&quot;, Path.of(&quot;test&quot;),
 112                                                  URIBuilder.base(&quot;http://www.test.test/&quot;).build(),
 113                                                  Set.of(&quot;rfr&quot;), Map.of(ignored.host().getCurrentUserDetails().userName(),
 114                                                                        Pattern.compile(&quot;ready&quot;)));
 115 
 116             // Populate the projects repository
 117             var localRepo = CheckableRepository.init(tempFolder.path(), author.getRepositoryType());
 118             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
 119             localRepo.push(masterHash, author.getUrl(), &quot;master&quot;, true);
 120             localRepo.push(masterHash, archive.getUrl(), &quot;webrev&quot;, true);
 121 
 122             // Make a change with a corresponding PR
 123             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;A simple change&quot;,
 124                                                                &quot;Change msg\n\nWith several lines&quot;);
 125             localRepo.push(editHash, author.getUrl(), &quot;edit&quot;, true);
 126             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
 127             pr.setBody(&quot;This should not be ready&quot;);
 128 
 129             // Run an archive pass
 130             TestBotRunner.runPeriodicItems(mlBot);
 131 
 132             // A PR that isn&#39;t ready for review should not be archived
 133             Repository.materialize(archiveFolder.path(), archive.getUrl(), &quot;master&quot;);
 134             assertFalse(archiveContains(archiveFolder.path(), &quot;This is a pull request&quot;));
 135 
 136             // Flag it as ready for review
 137             pr.setBody(&quot;This should now be ready&quot;);
 138             pr.addLabel(&quot;rfr&quot;);
 139 
 140             // Run another archive pass
 141             TestBotRunner.runPeriodicItems(mlBot);
 142 
 143             // But it should still not be archived
 144             Repository.materialize(archiveFolder.path(), archive.getUrl(), &quot;master&quot;);
 145             assertFalse(archiveContains(archiveFolder.path(), &quot;This is a pull request&quot;));
 146 
 147             // Now post a general comment - not a ready marker
 148             var ignoredPr = ignored.getPullRequest(pr.getId());
 149             ignoredPr.addComment(&quot;hello there&quot;);
 150 
 151             // Run another archive pass
 152             TestBotRunner.runPeriodicItems(mlBot);
 153 
 154             // It should still not be archived
 155             Repository.materialize(archiveFolder.path(), archive.getUrl(), &quot;master&quot;);
 156             assertFalse(archiveContains(archiveFolder.path(), &quot;This is a pull request&quot;));
 157 
 158             // Now post a ready comment
 159             ignoredPr.addComment(&quot;ready&quot;);
 160 
 161             // Run another archive pass
 162             TestBotRunner.runPeriodicItems(mlBot);
 163 
 164             // The archive should now contain an entry
 165             Repository.materialize(archiveFolder.path(), archive.getUrl(), &quot;master&quot;);
 166             assertTrue(archiveContains(archiveFolder.path(), &quot;This is a pull request&quot;));
 167             assertTrue(archiveContains(archiveFolder.path(), &quot;This should now be ready&quot;));
 168             assertTrue(archiveContains(archiveFolder.path(), &quot;Patch:&quot;));
 169             assertTrue(archiveContains(archiveFolder.path(), &quot;Pull request:&quot;));
 170             assertTrue(archiveContains(archiveFolder.path(), &quot;Webrev:&quot;));
 171             assertTrue(archiveContains(archiveFolder.path(), &quot;http://www.test.test/&quot;));
 172             assertTrue(archiveContains(archiveFolder.path(), &quot;webrev.00&quot;));
 173             assertTrue(archiveContains(archiveFolder.path(), &quot;Fetch command:&quot;));
 174             assertTrue(archiveContains(archiveFolder.path(), &quot;^ - &quot; + editHash.abbreviate() + &quot;:\tChange msg&quot;));
 175             assertTrue(archiveContains(archiveFolder.path(), &quot;^\t\t\tWith several lines&quot;));
 176 
 177             // The mailing list as well
 178             listServer.processIncoming();
 179             var mailmanServer = MailingListServerFactory.createMailmanServer(listServer.getArchive(), listServer.getSMTP());
 180             var mailmanList = mailmanServer.getList(listAddress.address());
 181             var conversations = mailmanList.conversations(Duration.ofDays(1));
 182             assertEquals(1, conversations.size());
 183             var mail = conversations.get(0).first();
 184             assertEquals(&quot;RFR: This is a pull request&quot;, mail.subject());
 185             assertEquals(pr.getAuthor().fullName(), mail.author().fullName().orElseThrow());
 186             assertEquals(noreplyAddress(archive), mail.author().address());
 187             assertEquals(from, mail.sender());
 188 
 189             // And there should be a webrev
 190             Repository.materialize(webrevFolder.path(), archive.getUrl(), &quot;webrev&quot;);
 191             assertTrue(webrevContains(webrevFolder.path(), &quot;1 lines changed&quot;));
 192             var comments = pr.getComments();
 193             var webrevComments = comments.stream()
 194                                          .filter(comment -&gt; comment.author().equals(author.host().getCurrentUserDetails()))
 195                                          .filter(comment -&gt; comment.body().contains(&quot;webrev&quot;))
 196                                          .filter(comment -&gt; comment.body().contains(editHash.hex()))
 197                                          .collect(Collectors.toList());
 198             assertEquals(1, webrevComments.size());
 199 
 200             // Add a comment
 201             pr.addComment(&quot;This is a comment :smile:&quot;);
 202 
 203             // Add a comment from an ignored user as well
 204             ignoredPr.addComment(&quot;Don&#39;t mind me&quot;);
 205 
 206             // Run another archive pass
 207             TestBotRunner.runPeriodicItems(mlBot);
 208 
 209             // The archive should now contain the comment, but not the ignored one
 210             Repository.materialize(archiveFolder.path(), archive.getUrl(), &quot;master&quot;);
 211             assertTrue(archiveContains(archiveFolder.path(), &quot;This is a comment&quot;));
 212             assertTrue(archiveContains(archiveFolder.path(), &quot;&gt; This should now be ready&quot;));
 213             assertFalse(archiveContains(archiveFolder.path(), &quot;Don&#39;t mind me&quot;));
 214 
 215             listServer.processIncoming();
 216             conversations = mailmanList.conversations(Duration.ofDays(1));
 217             assertEquals(1, conversations.size());
 218             assertEquals(2, conversations.get(0).allMessages().size());
 219 
 220             // Remove the rfr flag and post another comment
 221             pr.addLabel(&quot;rfr&quot;);
 222             pr.addComment(&quot;This is another comment&quot;);
 223 
 224             // Run another archive pass
 225             TestBotRunner.runPeriodicItems(mlBot);
 226 
 227             // The archive should contain the additional comment
 228             Repository.materialize(archiveFolder.path(), archive.getUrl(), &quot;master&quot;);
 229             assertTrue(archiveContains(archiveFolder.path(), &quot;This is another comment&quot;));
 230             assertTrue(archiveContains(archiveFolder.path(), &quot;&gt;&gt; This should now be ready&quot;));
 231 
 232             listServer.processIncoming();
 233             conversations = mailmanList.conversations(Duration.ofDays(1));
 234             assertEquals(1, conversations.size());
 235             assertEquals(3, conversations.get(0).allMessages().size());
 236             for (var newMail : conversations.get(0).allMessages()) {
 237                 assertEquals(noreplyAddress(archive), newMail.author().address());
 238                 assertEquals(from, newMail.sender());
 239             }
 240             assertTrue(conversations.get(0).allMessages().get(2).body().contains(&quot;This is a comment ðŸ˜„&quot;));
 241         }
 242     }
 243 
 244     @Test
 245     void reviewComment(TestInfo testInfo) throws IOException {
 246         try (var credentials = new HostCredentials(testInfo);
 247              var tempFolder = new TemporaryDirectory();
 248              var archiveFolder = new TemporaryDirectory();
 249              var listServer = new TestMailmanServer()) {
 250             var author = credentials.getHostedRepository();
 251             var archive = credentials.getHostedRepository();
 252             var ignored = credentials.getHostedRepository();
 253             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
 254             var censusBuilder = credentials.getCensusBuilder()
 255                                            .addAuthor(author.host().getCurrentUserDetails().id());
 256             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
 257             var mlBot = new MailingListBridgeBot(from, author, archive, censusBuilder.build(), &quot;master&quot;, listAddress,
 258                                                  Set.of(ignored.host().getCurrentUserDetails().userName()),
 259                                                  Set.of(),
 260                                                  listServer.getArchive(), listServer.getSMTP(),
 261                                                  archive, &quot;webrev&quot;, Path.of(&quot;test&quot;),
 262                                                  URIBuilder.base(&quot;http://www.test.test/&quot;).build(),
 263                                                  Set.of(), Map.of());
 264 
 265             // Populate the projects repository
 266             var reviewFile = Path.of(&quot;reviewfile.txt&quot;);
 267             var localRepo = CheckableRepository.init(tempFolder.path(), author.getRepositoryType(), reviewFile);
 268             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
 269             localRepo.push(masterHash, author.getUrl(), &quot;master&quot;, true);
 270             localRepo.push(masterHash, archive.getUrl(), &quot;webrev&quot;, true);
 271 
 272             // Make a change with a corresponding PR
 273             var editHash = CheckableRepository.appendAndCommit(localRepo);
 274             localRepo.push(editHash, author.getUrl(), &quot;edit&quot;, true);
 275             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
 276             pr.setBody(&quot;This is now ready&quot;);
 277             TestBotRunner.runPeriodicItems(mlBot);
 278             listServer.processIncoming();
 279 
 280             // And make a file specific comment
 281             var currentMaster = localRepo.resolve(&quot;master&quot;).orElseThrow();
 282             var comment = pr.addReviewComment(masterHash, editHash, reviewFile.toString(), 2, &quot;Review comment&quot;);
 283 
 284             // Add one from an ignored user as well
 285             var ignoredPr = ignored.getPullRequest(pr.getId());
 286             ignoredPr.addReviewComment(masterHash, editHash, reviewFile.toString(), 2, &quot;Don&#39;t mind me&quot;);
 287 
 288             // Process comments
 289             TestBotRunner.runPeriodicItems(mlBot);
 290             listServer.processIncoming();
 291 
 292             // The archive should now contain an entry
 293             Repository.materialize(archiveFolder.path(), archive.getUrl(), &quot;master&quot;);
 294             assertTrue(archiveContains(archiveFolder.path(), &quot;This is a pull request&quot;));
 295             assertTrue(archiveContains(archiveFolder.path(), &quot;This is now ready&quot;));
 296             assertTrue(archiveContains(archiveFolder.path(), &quot;Review comment&quot;));
 297             assertTrue(archiveContains(archiveFolder.path(), &quot;&gt; This is now ready&quot;));
 298             assertTrue(archiveContains(archiveFolder.path(), reviewFile.toString()));
 299             assertFalse(archiveContains(archiveFolder.path(), &quot;Don&#39;t mind me&quot;));
 300 
 301             // The mailing list as well
 302             var mailmanServer = MailingListServerFactory.createMailmanServer(listServer.getArchive(), listServer.getSMTP());
 303             var mailmanList = mailmanServer.getList(listAddress.address());
 304             var conversations = mailmanList.conversations(Duration.ofDays(1));
 305             assertEquals(1, conversations.size());
 306             var mail = conversations.get(0).first();
 307             assertEquals(&quot;RFR: This is a pull request&quot;, mail.subject());
 308 
 309             // Comment on the comment
 310             pr.addReviewCommentReply(comment, &quot;This is a review reply&quot;);
 311             TestBotRunner.runPeriodicItems(mlBot);
 312             listServer.processIncoming();
 313 
 314             // The archive should contain the additional comment
 315             Repository.materialize(archiveFolder.path(), archive.getUrl(), &quot;master&quot;);
 316             assertTrue(archiveContains(archiveFolder.path(), &quot;This is a review reply&quot;));
 317             assertTrue(archiveContains(archiveFolder.path(), &quot;&gt;&gt; This is now ready&quot;));
 318 
 319             // As well as the mailing list
 320             conversations = mailmanList.conversations(Duration.ofDays(1));
 321             assertEquals(1, conversations.size());
 322             assertEquals(3, conversations.get(0).allMessages().size());
 323             for (var newMail : conversations.get(0).allMessages()) {
 324                 assertEquals(noreplyAddress(archive), newMail.author().address());
 325                 assertEquals(from, newMail.sender());
 326             }
 327         }
 328     }
 329 
 330     @Test
 331     void combineComments(TestInfo testInfo) throws IOException {
 332         try (var credentials = new HostCredentials(testInfo);
 333              var tempFolder = new TemporaryDirectory();
 334              var archiveFolder = new TemporaryDirectory();
 335              var listServer = new TestMailmanServer()) {
 336             var author = credentials.getHostedRepository();
 337             var archive = credentials.getHostedRepository();
 338             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
 339             var censusBuilder = credentials.getCensusBuilder()
 340                                            .addAuthor(author.host().getCurrentUserDetails().id());
 341             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
 342             var mlBot = new MailingListBridgeBot(from, author, archive, censusBuilder.build(), &quot;master&quot;,
 343                                                  listAddress, Set.of(), Set.of(),
 344                                                  listServer.getArchive(),
 345                                                  listServer.getSMTP(),
 346                                                  archive, &quot;webrev&quot;, Path.of(&quot;test&quot;),
 347                                                  URIBuilder.base(&quot;http://www.test.test/&quot;).build(),
 348                                                  Set.of(), Map.of());
 349 
 350             // Populate the projects repository
 351             var reviewFile = Path.of(&quot;reviewfile.txt&quot;);
 352             var localRepo = CheckableRepository.init(tempFolder.path(), author.getRepositoryType(), reviewFile);
 353             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
 354             localRepo.push(masterHash, author.getUrl(), &quot;master&quot;, true);
 355             localRepo.push(masterHash, archive.getUrl(), &quot;webrev&quot;, true);
 356 
 357             // Make a change with a corresponding PR
 358             var editHash = CheckableRepository.appendAndCommit(localRepo);
 359             localRepo.push(editHash, author.getUrl(), &quot;edit&quot;, true);
 360             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
 361             pr.setBody(&quot;This is now ready&quot;);
<a name="1" id="anc1"></a>

 362             TestBotRunner.runPeriodicItems(mlBot);
 363             listServer.processIncoming();
<a name="2" id="anc2"></a>
 364 
 365             // Make two file specific comments
 366             pr.addReviewComment(masterHash, editHash, reviewFile.toString(), 2, &quot;Review comment&quot;);
 367             pr.addReviewComment(masterHash, editHash, reviewFile.toString(), 2, &quot;Another review comment&quot;);
 368             TestBotRunner.runPeriodicItems(mlBot);
 369             listServer.processIncoming();
 370 
 371             // The archive should contain a combined entry
 372             Repository.materialize(archiveFolder.path(), archive.getUrl(), &quot;master&quot;);
<a name="3" id="anc3"></a><span class="line-modified"> 373             assertEquals(1, archiveContainsCount(archiveFolder.path(), &quot;^On.*wrote:&quot;));</span>
 374 
 375             // As well as the mailing list
 376             var mailmanServer = MailingListServerFactory.createMailmanServer(listServer.getArchive(), listServer.getSMTP());
 377             var mailmanList = mailmanServer.getList(listAddress.address());
 378             var conversations = mailmanList.conversations(Duration.ofDays(1));
 379             assertEquals(1, conversations.size());
 380             var mail = conversations.get(0).first();
 381             assertEquals(&quot;RFR: This is a pull request&quot;, mail.subject());
<a name="4" id="anc4"></a><span class="line-modified"> 382             assertEquals(2, conversations.get(0).allMessages().size());</span>




 383 
<a name="5" id="anc5"></a><span class="line-modified"> 384             var reply = conversations.get(0).replies(mail).get(0);</span>
<span class="line-modified"> 385             assertEquals(2, reply.body().split(&quot;^On.*wrote:&quot;).length);</span>
<span class="line-modified"> 386             assertEquals(2, reply.body().split(&quot;&gt; This is now ready&quot;).length, reply.body());</span>
<span class="line-modified"> 387             assertEquals(&quot;Re: RFR: This is a pull request&quot;, reply.subject());</span>
<span class="line-modified"> 388             assertTrue(reply.body().contains(&quot;Review comment\n\n&quot;), reply.body());</span>
<span class="line-modified"> 389             assertTrue(reply.body().contains(&quot;Another review comment&quot;), reply.body());</span>
 390         }
 391     }
 392 
 393     @Test
 394     void commentThreading(TestInfo testInfo) throws IOException {
 395         try (var credentials = new HostCredentials(testInfo);
 396              var tempFolder = new TemporaryDirectory();
 397              var archiveFolder = new TemporaryDirectory();
 398              var listServer = new TestMailmanServer()) {
 399             var author = credentials.getHostedRepository();
 400             var reviewer = credentials.getHostedRepository();
 401             var archive = credentials.getHostedRepository();
 402             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
 403             var censusBuilder = credentials.getCensusBuilder()
 404                                            .addReviewer(reviewer.host().getCurrentUserDetails().id())
 405                                            .addAuthor(author.host().getCurrentUserDetails().id());
 406             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
 407             var mlBot = new MailingListBridgeBot(from, author, archive, censusBuilder.build(), &quot;master&quot;,
 408                                                  listAddress, Set.of(), Set.of(),
 409                                                  listServer.getArchive(),
 410                                                  listServer.getSMTP(),
 411                                                  archive, &quot;webrev&quot;, Path.of(&quot;test&quot;),
 412                                                  URIBuilder.base(&quot;http://www.test.test/&quot;).build(),
 413                                                  Set.of(), Map.of());
 414 
 415             // Populate the projects repository
 416             var reviewFile = Path.of(&quot;reviewfile.txt&quot;);
 417             var localRepo = CheckableRepository.init(tempFolder.path(), author.getRepositoryType(), reviewFile);
 418             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
 419             localRepo.push(masterHash, author.getUrl(), &quot;master&quot;, true);
 420             localRepo.push(masterHash, archive.getUrl(), &quot;webrev&quot;, true);
 421 
 422             // Make a change with a corresponding PR
 423             var editHash = CheckableRepository.appendAndCommit(localRepo);
 424             localRepo.push(editHash, author.getUrl(), &quot;edit&quot;, true);
 425             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
 426             pr.setBody(&quot;This is now ready&quot;);
 427             TestBotRunner.runPeriodicItems(mlBot);
 428             listServer.processIncoming();
 429 
 430             // Make a file specific comment
 431             var reviewPr = reviewer.getPullRequest(pr.getId());
 432             var comment1 = reviewPr.addReviewComment(masterHash, editHash, reviewFile.toString(), 2, &quot;Review comment&quot;);
 433             pr.addReviewCommentReply(comment1, &quot;I agree&quot;);
 434             reviewPr.addReviewCommentReply(comment1, &quot;Great&quot;);
 435             TestBotRunner.runPeriodicItems(mlBot);
 436             listServer.processIncoming();
 437             listServer.processIncoming();
 438             listServer.processIncoming();
 439 
 440             // And a second one by ourselves
 441             var comment2 = pr.addReviewComment(masterHash, editHash, reviewFile.toString(), 2, &quot;Another review comment&quot;);
 442             reviewPr.addReviewCommentReply(comment2, &quot;Sounds good&quot;);
 443             pr.addReviewCommentReply(comment2, &quot;Thanks&quot;);
 444             TestBotRunner.runPeriodicItems(mlBot);
 445             listServer.processIncoming();
 446             listServer.processIncoming();
 447             listServer.processIncoming();
 448 
<a name="6" id="anc6"></a>






 449             // Sanity check the archive
 450             Repository.materialize(archiveFolder.path(), archive.getUrl(), &quot;master&quot;);
<a name="7" id="anc7"></a><span class="line-modified"> 451             assertEquals(6, archiveContainsCount(archiveFolder.path(), &quot;^On.*wrote:&quot;));</span>
 452 
 453             // Check the mailing list
 454             var mailmanServer = MailingListServerFactory.createMailmanServer(listServer.getArchive(), listServer.getSMTP());
 455             var mailmanList = mailmanServer.getList(listAddress.address());
 456             var conversations = mailmanList.conversations(Duration.ofDays(1));
 457             assertEquals(1, conversations.size());
 458             var mail = conversations.get(0).first();
 459             assertEquals(&quot;RFR: This is a pull request&quot;, mail.subject());
<a name="8" id="anc8"></a><span class="line-modified"> 460             assertEquals(7, conversations.get(0).allMessages().size());</span>
 461 
<a name="9" id="anc9"></a><span class="line-modified"> 462             // There should be two separate threads</span>
 463             var thread1 = conversations.get(0).replies(mail).get(0);
 464             assertEquals(2, thread1.body().split(&quot;^On.*wrote:&quot;).length);
 465             assertEquals(2, thread1.body().split(&quot;&gt; This is now ready&quot;).length, thread1.body());
 466             assertEquals(&quot;Re: RFR: This is a pull request&quot;, thread1.subject());
 467             assertTrue(thread1.body().contains(&quot;Review comment\n\n&quot;), thread1.body());
 468             assertFalse(thread1.body().contains(&quot;Another review comment&quot;), thread1.body());
 469             var thread1reply1 = conversations.get(0).replies(thread1).get(0);
 470             assertTrue(thread1reply1.body().contains(&quot;I agree&quot;));
 471             assertEquals(noreplyAddress(archive), thread1reply1.author().address());
 472             assertEquals(archive.host().getCurrentUserDetails().fullName(), thread1reply1.author().fullName().orElseThrow());
 473             var thread1reply2 = conversations.get(0).replies(thread1reply1).get(0);
 474             assertTrue(thread1reply2.body().contains(&quot;Great&quot;));
 475             assertEquals(&quot;integrationreviewer1@openjdk.java.net&quot;, thread1reply2.author().address());
 476             assertEquals(&quot;Generated Reviewer 1&quot;, thread1reply2.author().fullName().orElseThrow());
 477 
 478             var thread2 = conversations.get(0).replies(mail).get(1);
 479             assertEquals(2, thread2.body().split(&quot;^On.*wrote:&quot;).length);
 480             assertEquals(2, thread2.body().split(&quot;&gt; This is now ready&quot;).length, thread2.body());
 481             assertEquals(&quot;Re: RFR: This is a pull request&quot;, thread2.subject());
 482             assertFalse(thread2.body().contains(&quot;Review comment\n\n&quot;), thread2.body());
 483             assertTrue(thread2.body().contains(&quot;Another review comment&quot;), thread2.body());
 484             var thread2reply1 = conversations.get(0).replies(thread2).get(0);
 485             assertTrue(thread2reply1.body().contains(&quot;Sounds good&quot;));
 486             var thread2reply2 = conversations.get(0).replies(thread2reply1).get(0);
 487             assertTrue(thread2reply2.body().contains(&quot;Thanks&quot;));
<a name="10" id="anc10"></a>




 488         }
 489     }
 490 
 491     @Test
 492     void reviewContext(TestInfo testInfo) throws IOException {
 493         try (var credentials = new HostCredentials(testInfo);
 494              var tempFolder = new TemporaryDirectory();
 495              var archiveFolder = new TemporaryDirectory();
 496              var listServer = new TestMailmanServer()) {
 497             var author = credentials.getHostedRepository();
 498             var archive = credentials.getHostedRepository();
 499             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
 500             var censusBuilder = credentials.getCensusBuilder()
 501                                            .addAuthor(author.host().getCurrentUserDetails().id());
 502             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
 503             var mlBot = new MailingListBridgeBot(from, author, archive, censusBuilder.build(), &quot;master&quot;,
 504                                                  listAddress, Set.of(), Set.of(),
 505                                                  listServer.getArchive(),
 506                                                  listServer.getSMTP(),
 507                                                  archive, &quot;webrev&quot;, Path.of(&quot;test&quot;),
 508                                                  URIBuilder.base(&quot;http://www.test.test/&quot;).build(),
 509                                                  Set.of(), Map.of());
 510 
 511             // Populate the projects repository
 512             var reviewFile = Path.of(&quot;reviewfile.txt&quot;);
 513             var localRepo = CheckableRepository.init(tempFolder.path(), author.getRepositoryType(), reviewFile);
 514             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
 515             localRepo.push(masterHash, author.getUrl(), &quot;master&quot;, true);
 516             localRepo.push(masterHash, archive.getUrl(), &quot;webrev&quot;, true);
 517 
 518             // Make a change with a corresponding PR
 519             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;Line 1\nLine 2\nLine 3\nLine 4&quot;);
 520             localRepo.push(editHash, author.getUrl(), &quot;edit&quot;, true);
 521             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
 522             pr.setBody(&quot;This is now ready&quot;);
 523             TestBotRunner.runPeriodicItems(mlBot);
 524             listServer.processIncoming();
 525 
 526             // Make a file specific comment
 527             pr.addReviewComment(masterHash, editHash, reviewFile.toString(), 2, &quot;Review comment&quot;);
 528 
 529             TestBotRunner.runPeriodicItems(mlBot);
 530             listServer.processIncoming();
 531 
 532             // The archive should only contain context around line 2
 533             Repository.materialize(archiveFolder.path(), archive.getUrl(), &quot;master&quot;);
 534             assertTrue(archiveContains(archiveFolder.path(), &quot;^&gt; 2: Line 1$&quot;));
 535             assertTrue(archiveContains(archiveFolder.path(), &quot;^&gt; 3: Line 2$&quot;));
 536             assertFalse(archiveContains(archiveFolder.path(), &quot;^&gt; 4: Line 3$&quot;));
 537         }
 538     }
 539 
 540     @Test
 541     void multipleReviewContexts(TestInfo testInfo) throws IOException {
 542         try (var credentials = new HostCredentials(testInfo);
 543              var tempFolder = new TemporaryDirectory();
 544              var archiveFolder = new TemporaryDirectory();
 545              var listServer = new TestMailmanServer()) {
 546             var author = credentials.getHostedRepository();
 547             var archive = credentials.getHostedRepository();
 548             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
 549             var censusBuilder = credentials.getCensusBuilder()
 550                                            .addAuthor(author.host().getCurrentUserDetails().id());
 551             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
 552             var mlBot = new MailingListBridgeBot(from, author, archive, censusBuilder.build(), &quot;master&quot;,
 553                                                  listAddress, Set.of(), Set.of(),
 554                                                  listServer.getArchive(),
 555                                                  listServer.getSMTP(),
 556                                                  archive, &quot;webrev&quot;, Path.of(&quot;test&quot;),
 557                                                  URIBuilder.base(&quot;http://www.test.test/&quot;).build(),
 558                                                  Set.of(), Map.of());
 559 
 560             // Populate the projects repository
 561             var reviewFile = Path.of(&quot;reviewfile.txt&quot;);
 562             var localRepo = CheckableRepository.init(tempFolder.path(), author.getRepositoryType(), reviewFile);
 563             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
 564             localRepo.push(masterHash, author.getUrl(), &quot;master&quot;, true);
 565             localRepo.push(masterHash, archive.getUrl(), &quot;webrev&quot;, true);
 566             var initialHash = CheckableRepository.appendAndCommit(localRepo,
 567                                                                   &quot;Line 0.1\nLine 0.2\nLine 0.3\nLine 0.4\n&quot; +
 568                                                                           &quot;Line 1\nLine 2\nLine 3\nLine 4\n&quot; +
 569                                                                           &quot;Line 5\nLine 6\nLine 7\nLine 8\n&quot; +
 570                                                                           &quot;Line 8.1\nLine 8.2\nLine 8.3\nLine 8.4\n&quot; +
 571                                                                           &quot;Line 9\nLine 10\nLine 11\nLine 12\n&quot; +
 572                                                                           &quot;Line 13\nLine 14\nLine 15\nLine 16\n&quot;);
 573             localRepo.push(initialHash, author.getUrl(), &quot;master&quot;);
 574 
 575             // Make a change with a corresponding PR
 576             var current = Files.readString(localRepo.root().resolve(reviewFile), StandardCharsets.UTF_8);
 577             var updated = current.replaceAll(&quot;Line 2&quot;, &quot;Line 2 edit\nLine 2.5&quot;);
 578             updated = updated.replaceAll(&quot;Line 13&quot;, &quot;Line 12.5\nLine 13 edit&quot;);
 579             Files.writeString(localRepo.root().resolve(reviewFile), updated, StandardCharsets.UTF_8);
 580             var editHash = CheckableRepository.appendAndCommit(localRepo);
 581             localRepo.push(editHash, author.getUrl(), &quot;edit&quot;, true);
 582             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
 583             pr.setBody(&quot;This is now ready&quot;);
 584             TestBotRunner.runPeriodicItems(mlBot);
 585             listServer.processIncoming();
 586 
 587             // Make file specific comments
 588             pr.addReviewComment(masterHash, editHash, reviewFile.toString(), 7, &quot;Review comment&quot;);
 589             pr.addReviewComment(masterHash, editHash, reviewFile.toString(), 24, &quot;Another review comment&quot;);
 590 
 591             TestBotRunner.runPeriodicItems(mlBot);
 592             listServer.processIncoming();
 593 
 594             // The archive should only contain context around line 2 and 20
 595             Repository.materialize(archiveFolder.path(), archive.getUrl(), &quot;master&quot;);
 596             assertTrue(archiveContains(archiveFolder.path(), &quot;reviewfile.txt line 7&quot;));
 597             assertTrue(archiveContains(archiveFolder.path(), &quot;^&gt; 6: Line 1$&quot;));
 598             assertTrue(archiveContains(archiveFolder.path(), &quot;^&gt; 7: Line 2 edit$&quot;));
 599             assertFalse(archiveContains(archiveFolder.path(), &quot;Line 3&quot;));
 600 
 601             assertTrue(archiveContains(archiveFolder.path(), &quot;reviewfile.txt line 24&quot;));
 602             assertTrue(archiveContains(archiveFolder.path(), &quot;^&gt; 23: Line 12.5$&quot;));
 603             assertTrue(archiveContains(archiveFolder.path(), &quot;^&gt; 24: Line 13 edit$&quot;));
 604             assertFalse(archiveContains(archiveFolder.path(), &quot;^Line 15&quot;));
 605         }
 606     }
 607 
 608     @Test
 609     void filterComments(TestInfo testInfo) throws IOException {
 610         try (var credentials = new HostCredentials(testInfo);
 611              var tempFolder = new TemporaryDirectory();
 612              var archiveFolder = new TemporaryDirectory();
 613              var listServer = new TestMailmanServer()) {
 614             var author = credentials.getHostedRepository();
 615             var archive = credentials.getHostedRepository();
 616             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
 617             var censusBuilder = credentials.getCensusBuilder()
 618                                            .addAuthor(author.host().getCurrentUserDetails().id());
 619             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
 620             var mlBot = new MailingListBridgeBot(from, author, archive, censusBuilder.build(), &quot;master&quot;,
 621                                                  listAddress, Set.of(), Set.of(),
 622                                                  listServer.getArchive(), listServer.getSMTP(),
 623                                                  archive, &quot;webrev&quot;, Path.of(&quot;test&quot;),
 624                                                  URIBuilder.base(&quot;http://www.test.test/&quot;).build(),
 625                                                  Set.of(), Map.of());
 626 
 627             // Populate the projects repository
 628             var reviewFile = Path.of(&quot;reviewfile.txt&quot;);
 629             var localRepo = CheckableRepository.init(tempFolder.path(), author.getRepositoryType(), reviewFile);
 630             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
 631             localRepo.push(masterHash, author.getUrl(), &quot;master&quot;, true);
 632             localRepo.push(masterHash, archive.getUrl(), &quot;webrev&quot;, true);
 633 
 634             // Make a change with a corresponding PR
 635             var editHash = CheckableRepository.appendAndCommit(localRepo);
 636             localRepo.push(editHash, author.getUrl(), &quot;edit&quot;, true);
 637             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
 638             pr.setBody(&quot;This is now ready\n&lt;!-- this is a comment --&gt;\nAnd this is not\n&quot; +
 639                                &quot;&lt;!-- Anything below this marker will be hidden --&gt;\nStatus stuff&quot;);
 640 
 641             // Make a bunch of comments
 642             pr.addComment(&quot;Plain comment\n&lt;!-- this is a comment --&gt;&quot;);
 643             pr.addReviewComment(masterHash, editHash, reviewFile.toString(), 2, &quot;Review comment &lt;!-- this is a comment --&gt;\n&quot;);
 644             pr.addComment(&quot;/integrate stuff&quot;);
 645             TestBotRunner.runPeriodicItems(mlBot);
 646 
 647             // Run an archive pass
 648             TestBotRunner.runPeriodicItems(mlBot);
 649 
 650             // The archive should not contain the comment
 651             Repository.materialize(archiveFolder.path(), archive.getUrl(), &quot;master&quot;);
 652             assertTrue(archiveContains(archiveFolder.path(), &quot;This is now ready&quot;));
 653             assertFalse(archiveContains(archiveFolder.path(), &quot;this is a comment&quot;));
 654             assertFalse(archiveContains(archiveFolder.path(), &quot;Status stuff&quot;));
 655             assertTrue(archiveContains(archiveFolder.path(), &quot;And this is not&quot;));
 656             assertFalse(archiveContains(archiveFolder.path(), &quot;&lt;!--&quot;));
 657             assertFalse(archiveContains(archiveFolder.path(), &quot;--&gt;&quot;));
 658             assertTrue(archiveContains(archiveFolder.path(), &quot;Plain comment&quot;));
 659             assertTrue(archiveContains(archiveFolder.path(), &quot;Review comment&quot;));
 660             assertFalse(archiveContains(archiveFolder.path(), &quot;/integrate&quot;));
 661         }
 662     }
 663 
 664     @Test
 665     void incrementalChanges(TestInfo testInfo) throws IOException {
 666         try (var credentials = new HostCredentials(testInfo);
 667              var tempFolder = new TemporaryDirectory();
 668              var archiveFolder = new TemporaryDirectory();
 669              var listServer = new TestMailmanServer()) {
 670             var author = credentials.getHostedRepository();
 671             var archive = credentials.getHostedRepository();
 672             var commenter = credentials.getHostedRepository();
 673             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
 674             var censusBuilder = credentials.getCensusBuilder()
 675                                            .addAuthor(author.host().getCurrentUserDetails().id());
 676             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
 677             var mlBot = new MailingListBridgeBot(from, author, archive, censusBuilder.build(), &quot;master&quot;,
 678                                                  listAddress, Set.of(), Set.of(),
 679                                                  listServer.getArchive(), listServer.getSMTP(),
 680                                                  archive, &quot;webrev&quot;, Path.of(&quot;test&quot;),
 681                                                  URIBuilder.base(&quot;http://www.test.test/&quot;).build(),
 682                                                  Set.of(), Map.of());
 683 
 684             // Populate the projects repository
 685             var reviewFile = Path.of(&quot;reviewfile.txt&quot;);
 686             var localRepo = CheckableRepository.init(tempFolder.path(), author.getRepositoryType(), reviewFile);
 687             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
 688             localRepo.push(masterHash, author.getUrl(), &quot;master&quot;, true);
 689             localRepo.push(masterHash, archive.getUrl(), &quot;webrev&quot;, true);
 690 
 691             // Make a change with a corresponding PR
 692             var editHash = CheckableRepository.appendAndCommit(localRepo);
 693             localRepo.push(editHash, author.getUrl(), &quot;edit&quot;, true);
 694             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
 695             pr.setBody(&quot;This is now ready&quot;);
 696 
 697             // Run an archive pass
 698             TestBotRunner.runPeriodicItems(mlBot);
 699             listServer.processIncoming();
 700 
 701             var nextHash = CheckableRepository.appendAndCommit(localRepo, &quot;Yet one more line&quot;, &quot;Fixing&quot;);
 702             localRepo.push(nextHash, author.getUrl(), &quot;edit&quot;);
 703 
 704             // Make sure that the push registered
 705             var lastHeadHash = pr.getHeadHash();
 706             var refreshCount = 0;
 707             do {
 708                 pr = author.getPullRequest(pr.getId());
 709                 if (refreshCount++ &gt; 100) {
 710                     fail(&quot;The PR did not update after the new push&quot;);
 711                 }
 712             } while (pr.getHeadHash().equals(lastHeadHash));
 713 
 714             // Run another archive pass
 715             TestBotRunner.runPeriodicItems(mlBot);
 716             TestBotRunner.runPeriodicItems(mlBot);
 717             TestBotRunner.runPeriodicItems(mlBot);
 718             listServer.processIncoming();
 719 
 720             // The archive should reference the updated push
 721             Repository.materialize(archiveFolder.path(), archive.getUrl(), &quot;master&quot;);
 722             assertTrue(archiveContains(archiveFolder.path(), &quot;additional changes&quot;));
 723             assertTrue(archiveContains(archiveFolder.path(), &quot;full.*/&quot; + pr.getId() + &quot;/webrev.01&quot;));
 724             assertTrue(archiveContains(archiveFolder.path(), &quot;inc.*/&quot; + pr.getId() + &quot;/webrev.00-01&quot;));
 725             assertTrue(archiveContains(archiveFolder.path(), &quot;Updated full patch&quot;));
 726             assertTrue(archiveContains(archiveFolder.path(), &quot;Fetch&quot;));
 727             assertTrue(archiveContains(archiveFolder.path(), &quot;Fixing&quot;));
 728 
 729             // The webrev comment should be updated
 730             var comments = pr.getComments();
 731             var webrevComments = comments.stream()
 732                                          .filter(comment -&gt; comment.author().equals(author.host().getCurrentUserDetails()))
 733                                          .filter(comment -&gt; comment.body().contains(&quot;webrev&quot;))
 734                                          .filter(comment -&gt; comment.body().contains(nextHash.hex()))
 735                                          .filter(comment -&gt; comment.body().contains(editHash.hex()))
 736                                          .collect(Collectors.toList());
 737             assertEquals(1, webrevComments.size());
 738 
 739             // Check that sender address is set properly
 740             var mailmanServer = MailingListServerFactory.createMailmanServer(listServer.getArchive(), listServer.getSMTP());
 741             var mailmanList = mailmanServer.getList(listAddress.address());
 742             var conversations = mailmanList.conversations(Duration.ofDays(1));
 743             assertEquals(1, conversations.size());
 744             for (var newMail : conversations.get(0).allMessages()) {
 745                 assertEquals(noreplyAddress(archive), newMail.author().address());
 746                 assertEquals(from, newMail.sender());
 747             }
 748 
 749             // Add a comment
 750             var commenterPr = commenter.getPullRequest(pr.getId());
 751             commenterPr.addReviewComment(masterHash, nextHash, reviewFile.toString(), 2, &quot;Review comment&quot;);
 752             TestBotRunner.runPeriodicItems(mlBot);
 753             listServer.processIncoming();
 754 
 755             // Ensure that additional updates are only reported once
 756             for (int i = 0; i &lt; 3; ++i) {
 757                 var anotherHash = CheckableRepository.appendAndCommit(localRepo, &quot;Another line&quot;, &quot;Fixing&quot;);
 758                 localRepo.push(anotherHash, author.getUrl(), &quot;edit&quot;);
 759 
 760                 // Make sure that the push registered
 761                 lastHeadHash = pr.getHeadHash();
 762                 refreshCount = 0;
 763                 do {
 764                     pr = author.getPullRequest(pr.getId());
 765                     if (refreshCount++ &gt; 100) {
 766                         fail(&quot;The PR did not update after the new push&quot;);
 767                     }
 768                 } while (pr.getHeadHash().equals(lastHeadHash));
 769 
 770                 TestBotRunner.runPeriodicItems(mlBot);
 771                 TestBotRunner.runPeriodicItems(mlBot);
 772                 listServer.processIncoming();
 773             }
 774             var updatedConversations = mailmanList.conversations(Duration.ofDays(1));
 775             assertEquals(1, updatedConversations.size());
 776             var conversation = updatedConversations.get(0);
 777             assertEquals(6, conversation.allMessages().size());
 778             assertEquals(&quot;Re: 01: Fixing&quot;, conversation.allMessages().get(1).subject());
 779             assertEquals(&quot;Re: 01: Fixing&quot;, conversation.allMessages().get(2).subject());
 780             assertEquals(&quot;Re: 04: Fixing&quot;, conversation.allMessages().get(5).subject());
 781         }
 782     }
 783 
 784     @Test
 785     void rebased(TestInfo testInfo) throws IOException {
 786         try (var credentials = new HostCredentials(testInfo);
 787              var tempFolder = new TemporaryDirectory();
 788              var archiveFolder = new TemporaryDirectory();
 789              var listServer = new TestMailmanServer()) {
 790             var author = credentials.getHostedRepository();
 791             var archive = credentials.getHostedRepository();
 792             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
 793             var censusBuilder = credentials.getCensusBuilder()
 794                                            .addAuthor(author.host().getCurrentUserDetails().id());
 795             var sender = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
 796             var mlBot = new MailingListBridgeBot(sender, author, archive, censusBuilder.build(), &quot;master&quot;,
 797                                                  listAddress, Set.of(), Set.of(),
 798                                                  listServer.getArchive(), listServer.getSMTP(),
 799                                                  archive, &quot;webrev&quot;, Path.of(&quot;test&quot;),
 800                                                  URIBuilder.base(&quot;http://www.test.test/&quot;).build(),
 801                                                  Set.of(), Map.of());
 802 
 803             // Populate the projects repository
 804             var reviewFile = Path.of(&quot;reviewfile.txt&quot;);
 805             var localRepo = CheckableRepository.init(tempFolder.path().resolve(&quot;first&quot;), author.getRepositoryType(), reviewFile);
 806             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
 807             localRepo.push(masterHash, author.getUrl(), &quot;master&quot;, true);
 808             localRepo.push(masterHash, archive.getUrl(), &quot;webrev&quot;, true);
 809 
 810             // Make a change with a corresponding PR
 811             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;A line&quot;, &quot;Original msg&quot;);
 812             localRepo.push(editHash, author.getUrl(), &quot;edit&quot;, true);
 813             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
 814             pr.setBody(&quot;This is now ready&quot;);
 815 
 816             // Run an archive pass
 817             TestBotRunner.runPeriodicItems(mlBot);
 818             listServer.processIncoming();
 819 
 820             var newLocalRepo = Repository.materialize(tempFolder.path().resolve(&quot;second&quot;), author.getUrl(), &quot;master&quot;);
 821             var newEditHash = CheckableRepository.appendAndCommit(newLocalRepo, &quot;Another line&quot;, &quot;Replaced msg&quot;);
 822             newLocalRepo.push(newEditHash, author.getUrl(), &quot;edit&quot;, true);
 823 
 824             // Make sure that the push registered
 825             var lastHeadHash = pr.getHeadHash();
 826             var refreshCount = 0;
 827             do {
 828                 pr = author.getPullRequest(pr.getId());
 829                 if (refreshCount++ &gt; 100) {
 830                     fail(&quot;The PR did not update after the new push&quot;);
 831                 }
 832             } while (pr.getHeadHash().equals(lastHeadHash));
 833 
 834             // Run another archive pass
 835             TestBotRunner.runPeriodicItems(mlBot);
 836             listServer.processIncoming();
 837 
 838             // The archive should reference the rebased push
 839             Repository.materialize(archiveFolder.path(), archive.getUrl(), &quot;master&quot;);
 840             assertTrue(archiveContains(archiveFolder.path(), &quot;complete new set of changes&quot;));
 841             assertTrue(archiveContains(archiveFolder.path(), pr.getId() + &quot;/webrev.01&quot;));
 842             assertFalse(archiveContains(archiveFolder.path(), &quot;Incremental&quot;));
 843             assertTrue(archiveContains(archiveFolder.path(), &quot;Updated full patch&quot;));
 844             assertTrue(archiveContains(archiveFolder.path(), &quot;Fetch&quot;));
 845             assertTrue(archiveContains(archiveFolder.path(), &quot;Original msg&quot;));
 846             assertTrue(archiveContains(archiveFolder.path(), &quot;Replaced msg&quot;));
 847 
 848             // The webrev comment should be updated
 849             var comments = pr.getComments();
 850             var webrevComments = comments.stream()
 851                                          .filter(comment -&gt; comment.author().equals(author.host().getCurrentUserDetails()))
 852                                          .filter(comment -&gt; comment.body().contains(&quot;webrev&quot;))
 853                                          .filter(comment -&gt; comment.body().contains(newEditHash.hex()))
 854                                          .collect(Collectors.toList());
 855             assertEquals(1, webrevComments.size());
 856 
 857             // Check that sender address is set properly
 858             var mailmanServer = MailingListServerFactory.createMailmanServer(listServer.getArchive(), listServer.getSMTP());
 859             var mailmanList = mailmanServer.getList(listAddress.address());
 860             var conversations = mailmanList.conversations(Duration.ofDays(1));
 861             assertEquals(1, conversations.size());
 862             for (var newMail : conversations.get(0).allMessages()) {
 863                 assertEquals(noreplyAddress(archive), newMail.author().address());
 864                 assertEquals(sender, newMail.sender());
 865             }
 866             assertEquals(&quot;Re: 01: Replaced msg&quot;, conversations.get(0).allMessages().get(1).subject());
 867         }
 868     }
 869 
 870     @Test
 871     void skipAddingExistingWebrev(TestInfo testInfo) throws IOException {
 872         try (var credentials = new HostCredentials(testInfo);
 873              var tempFolder = new TemporaryDirectory();
 874              var archiveFolder = new TemporaryDirectory();
 875              var webrevFolder = new TemporaryDirectory();
 876              var listServer = new TestMailmanServer()) {
 877             var author = credentials.getHostedRepository();
 878             var archive = credentials.getHostedRepository();
 879             var ignored = credentials.getHostedRepository();
 880             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
 881             var censusBuilder = credentials.getCensusBuilder()
 882                                            .addAuthor(author.host().getCurrentUserDetails().id());
 883             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
 884             var mlBot = new MailingListBridgeBot(from, author, archive, censusBuilder.build(), &quot;master&quot;,
 885                                                  listAddress,
 886                                                  Set.of(ignored.host().getCurrentUserDetails().userName()),
 887                                                  Set.of(),
 888                                                  listServer.getArchive(), listServer.getSMTP(),
 889                                                  archive, &quot;webrev&quot;, Path.of(&quot;test&quot;),
 890                                                  URIBuilder.base(&quot;http://www.test.test/&quot;).build(),
 891                                                  Set.of(), Map.of());
 892 
 893             // Populate the projects repository
 894             var localRepo = CheckableRepository.init(tempFolder.path(), author.getRepositoryType());
 895             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
 896             localRepo.push(masterHash, author.getUrl(), &quot;master&quot;, true);
 897             localRepo.push(masterHash, archive.getUrl(), &quot;webrev&quot;, true);
 898 
 899             // Make a change with a corresponding PR
 900             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;A simple change&quot;,
 901                                                                &quot;Change msg\n\nWith several lines&quot;);
 902             localRepo.push(editHash, author.getUrl(), &quot;edit&quot;, true);
 903             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
 904 
 905             // Flag it as ready for review
 906             pr.setBody(&quot;This should now be ready&quot;);
 907 
 908             // Run an archive pass
 909             TestBotRunner.runPeriodicItems(mlBot);
 910 
 911             // The archive should now contain an entry
 912             var archiveRepo = Repository.materialize(archiveFolder.path(), archive.getUrl(), &quot;master&quot;);
 913             assertTrue(archiveContains(archiveFolder.path(), editHash.abbreviate()));
 914 
 915             // And there should be a webrev comment
 916             var comments = pr.getComments();
 917             var webrevComments = comments.stream()
 918                                          .filter(comment -&gt; comment.author().equals(author.host().getCurrentUserDetails()))
 919                                          .filter(comment -&gt; comment.body().contains(&quot;webrev&quot;))
 920                                          .filter(comment -&gt; comment.body().contains(editHash.hex()))
 921                                          .collect(Collectors.toList());
 922             assertEquals(1, webrevComments.size());
 923             assertEquals(1, countSubstrings(webrevComments.get(0).body(), &quot;webrev.00&quot;));
 924 
 925             // Pretend the archive didn&#39;t work out
 926             archiveRepo.push(masterHash, archive.getUrl(), &quot;master&quot;, true);
 927 
 928             // Run another archive pass
 929             TestBotRunner.runPeriodicItems(mlBot);
 930 
 931             // The webrev comment should not contain duplicate entries
 932             comments = pr.getComments();
 933             webrevComments = comments.stream()
 934                                          .filter(comment -&gt; comment.author().equals(author.host().getCurrentUserDetails()))
 935                                          .filter(comment -&gt; comment.body().contains(&quot;webrev&quot;))
 936                                          .filter(comment -&gt; comment.body().contains(editHash.hex()))
 937                                          .collect(Collectors.toList());
 938             assertEquals(1, webrevComments.size());
 939             assertEquals(1, countSubstrings(webrevComments.get(0).body(), &quot;webrev.00&quot;));
 940         }
 941     }
 942 
 943     @Test
 944     void notifyReviewVerdicts(TestInfo testInfo) throws IOException {
 945         try (var credentials = new HostCredentials(testInfo);
 946              var tempFolder = new TemporaryDirectory();
 947              var archiveFolder = new TemporaryDirectory();
 948              var listServer = new TestMailmanServer()) {
 949             var author = credentials.getHostedRepository();
 950             var archive = credentials.getHostedRepository();
 951             var reviewer = credentials.getHostedRepository();
 952             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
 953             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
 954             var censusBuilder = credentials.getCensusBuilder()
 955                                            .addReviewer(reviewer.host().getCurrentUserDetails().id())
 956                                            .addAuthor(author.host().getCurrentUserDetails().id());
 957             var mlBot = new MailingListBridgeBot(from, author, archive, censusBuilder.build(), &quot;master&quot;,
 958                                                  listAddress, Set.of(), Set.of(),
 959                                                  listServer.getArchive(), listServer.getSMTP(),
 960                                                  archive, &quot;webrev&quot;, Path.of(&quot;test&quot;),
 961                                                  URIBuilder.base(&quot;http://www.test.test/&quot;).build(),
 962                                                  Set.of(), Map.of());
 963 
 964             // Populate the projects repository
 965             var reviewFile = Path.of(&quot;reviewfile.txt&quot;);
 966             var localRepo = CheckableRepository.init(tempFolder.path(), author.getRepositoryType(), reviewFile);
 967             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
 968             localRepo.push(masterHash, author.getUrl(), &quot;master&quot;, true);
 969             localRepo.push(masterHash, archive.getUrl(), &quot;webrev&quot;, true);
 970 
 971             // Make a change with a corresponding PR
 972             var editHash = CheckableRepository.appendAndCommit(localRepo);
 973             localRepo.push(editHash, author.getUrl(), &quot;edit&quot;, true);
 974             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
 975             pr.setBody(&quot;This is now ready&quot;);
 976 
 977             // Run an archive pass
 978             TestBotRunner.runPeriodicItems(mlBot);
 979 
 980             // First unapprove it
 981             var reviewedPr = reviewer.getPullRequest(pr.getId());
 982             reviewedPr.addReview(Review.Verdict.DISAPPROVED, &quot;Reason 1&quot;);
 983             TestBotRunner.runPeriodicItems(mlBot);
 984             TestBotRunner.runPeriodicItems(mlBot);
 985             TestBotRunner.runPeriodicItems(mlBot);
 986 
 987             // The archive should contain a note
 988             Repository.materialize(archiveFolder.path(), archive.getUrl(), &quot;master&quot;);
 989             assertEquals(1, archiveContainsCount(archiveFolder.path(), &quot;Review status set to Disapproved&quot;));
 990             assertEquals(1, archiveContainsCount(archiveFolder.path(), &quot; by integrationreviewer1&quot;));
 991             if (author.host().supportsReviewBody()) {
 992                 assertEquals(1, archiveContainsCount(archiveFolder.path(), &quot;Reason 1&quot;));
 993             }
 994 
 995             // Then approve it
 996             reviewedPr.addReview(Review.Verdict.APPROVED, &quot;Reason 2&quot;);
 997             TestBotRunner.runPeriodicItems(mlBot);
 998             TestBotRunner.runPeriodicItems(mlBot);
 999             TestBotRunner.runPeriodicItems(mlBot);
1000 
1001             // The archive should contain another note
1002             Repository.materialize(archiveFolder.path(), archive.getUrl(), &quot;master&quot;);
1003             assertEquals(1, archiveContainsCount(archiveFolder.path(), &quot;Review status set to Approved&quot;));
1004             if (author.host().supportsReviewBody()) {
1005                 assertEquals(1, archiveContainsCount(archiveFolder.path(), &quot;Reason 2&quot;));
1006             }
<a name="11" id="anc11"></a><span class="line-modified">1007             assertEquals(1, archiveContainsCount(archiveFolder.path(), &quot;This PR has been marked as Reviewed by integrationreviewer1.&quot;));</span>
1008 
1009             // Yet another change
1010             reviewedPr.addReview(Review.Verdict.DISAPPROVED, &quot;Reason 3&quot;);
1011             TestBotRunner.runPeriodicItems(mlBot);
1012             TestBotRunner.runPeriodicItems(mlBot);
1013             TestBotRunner.runPeriodicItems(mlBot);
1014 
1015             // The archive should contain another note
1016             Repository.materialize(archiveFolder.path(), archive.getUrl(), &quot;master&quot;);
1017             assertEquals(2, archiveContainsCount(archiveFolder.path(), &quot;Review status set to Disapproved&quot;));
1018             if (author.host().supportsReviewBody()) {
1019                 assertEquals(1, archiveContainsCount(archiveFolder.path(), &quot;Reason 3&quot;));
1020             }
1021         }
1022     }
1023 
1024     @Test
1025     void ignoreComments(TestInfo testInfo) throws IOException {
1026         try (var credentials = new HostCredentials(testInfo);
1027              var tempFolder = new TemporaryDirectory();
1028              var archiveFolder = new TemporaryDirectory();
1029              var listServer = new TestMailmanServer()) {
1030             var author = credentials.getHostedRepository();
1031             var ignored = credentials.getHostedRepository();
1032             var archive = credentials.getHostedRepository();
1033             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
1034             var censusBuilder = credentials.getCensusBuilder()
1035                                            .addAuthor(author.host().getCurrentUserDetails().id());
1036             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
1037             var mlBot = new MailingListBridgeBot(from, author, archive, censusBuilder.build(), &quot;master&quot;,
1038                                                  listAddress,
1039                                                  Set.of(ignored.host().getCurrentUserDetails().userName()),
1040                                                  Set.of(Pattern.compile(&quot;ignore this comment&quot;, Pattern.MULTILINE | Pattern.DOTALL)),
1041                                                  listServer.getArchive(), listServer.getSMTP(),
1042                                                  archive, &quot;webrev&quot;, Path.of(&quot;test&quot;),
1043                                                  URIBuilder.base(&quot;http://www.test.test/&quot;).build(),
1044                                                  Set.of(), Map.of());
1045 
1046             // Populate the projects repository
1047             var reviewFile = Path.of(&quot;reviewfile.txt&quot;);
1048             var localRepo = CheckableRepository.init(tempFolder.path(), author.getRepositoryType(), reviewFile);
1049             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
1050             localRepo.push(masterHash, author.getUrl(), &quot;master&quot;, true);
1051             localRepo.push(masterHash, archive.getUrl(), &quot;webrev&quot;, true);
1052 
1053             // Make a change with a corresponding PR
1054             var editHash = CheckableRepository.appendAndCommit(localRepo);
1055             localRepo.push(editHash, author.getUrl(), &quot;edit&quot;, true);
1056             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
1057             pr.setBody(&quot;This is now ready&quot;);
1058 
1059             // Make a bunch of comments
1060             pr.addComment(&quot;Plain comment&quot;);
1061             pr.addComment(&quot;ignore this comment&quot;);
1062             pr.addComment(&quot;I think it is time to\nignore this comment!&quot;);
1063             pr.addReviewComment(masterHash, editHash, reviewFile.toString(), 2, &quot;Review ignore this comment&quot;);
1064 
1065             var ignoredPR = ignored.getPullRequest(pr.getId());
1066             ignoredPR.addComment(&quot;Don&#39;t mind me&quot;);
1067 
1068             TestBotRunner.runPeriodicItems(mlBot);
1069             TestBotRunner.runPeriodicItems(mlBot);
1070 
1071             // The archive should not contain the ignored comments
1072             Repository.materialize(archiveFolder.path(), archive.getUrl(), &quot;master&quot;);
1073             assertTrue(archiveContains(archiveFolder.path(), &quot;This is now ready&quot;));
1074             assertFalse(archiveContains(archiveFolder.path(), &quot;ignore this comment&quot;));
1075             assertFalse(archiveContains(archiveFolder.path(), &quot;it is time to&quot;));
1076             assertFalse(archiveContains(archiveFolder.path(), &quot;Don&#39;t mind me&quot;));
1077             assertFalse(archiveContains(archiveFolder.path(), &quot;Review ignore&quot;));
1078         }
1079     }
1080 }
<a name="12" id="anc12"></a><b style="font-size: large; color: red">--- EOF ---</b>
















































































</pre>
<input id="eof" value="12" type="hidden" />
</body>
</html>