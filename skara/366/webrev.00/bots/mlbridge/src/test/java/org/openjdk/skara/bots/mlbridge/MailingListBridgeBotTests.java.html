<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>New bots/mlbridge/src/test/java/org/openjdk/skara/bots/mlbridge/MailingListBridgeBotTests.java</title>
    <link rel="stylesheet" href="../../../../../../../../../../style.css" />
  </head>
  <body>
    <pre>
   1 /*
   2  * Copyright (c) 2019, Oracle and/or its affiliates. All rights reserved.
   3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   4  *
   5  * This code is free software; you can redistribute it and/or modify it
   6  * under the terms of the GNU General Public License version 2 only, as
   7  * published by the Free Software Foundation.
   8  *
   9  * This code is distributed in the hope that it will be useful, but WITHOUT
  10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
  11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
  12  * version 2 for more details (a copy is included in the LICENSE file that
  13  * accompanied this code).
  14  *
  15  * You should have received a copy of the GNU General Public License version
  16  * 2 along with this work; if not, write to the Free Software Foundation,
  17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
  18  *
  19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
  20  * or visit www.oracle.com if you need additional information or have any
  21  * questions.
  22  */
  23 package org.openjdk.skara.bots.mlbridge;
  24 
  25 import org.openjdk.skara.email.EmailAddress;
  26 import org.openjdk.skara.forge.*;
  27 import org.openjdk.skara.network.URIBuilder;
  28 import org.openjdk.skara.mailinglist.MailingListServerFactory;
  29 import org.openjdk.skara.test.*;
  30 import org.openjdk.skara.vcs.Repository;
  31 
  32 import org.junit.jupiter.api.*;
  33 
  34 import java.io.IOException;
  35 import java.nio.charset.StandardCharsets;
  36 import java.nio.file.*;
  37 import java.time.Duration;
  38 import java.util.*;
  39 import java.util.regex.Pattern;
  40 import java.util.stream.Collectors;
  41 
  42 import static org.junit.jupiter.api.Assertions.*;
  43 
  44 class MailingListBridgeBotTests {
  45     private Optional&lt;String&gt; archiveContents(Path archive) {
  46         try {
  47             var mbox = Files.find(archive, 50, (path, attrs) -&gt; path.toString().endsWith(&quot;.mbox&quot;)).findAny();
  48             if (mbox.isEmpty()) {
  49                 return Optional.empty();
  50             }
  51             return Optional.of(Files.readString(mbox.get(), StandardCharsets.UTF_8));
  52         } catch (IOException e) {
  53             return Optional.empty();
  54         }
  55 
  56     }
  57 
  58     private boolean archiveContains(Path archive, String text) {
  59         return archiveContainsCount(archive, text) &gt; 0;
  60     }
  61 
  62     private int archiveContainsCount(Path archive, String text) {
  63         var lines = archiveContents(archive);
  64         if (lines.isEmpty()) {
  65             return 0;
  66         }
  67         var pattern = Pattern.compile(text);
  68         int count = 0;
  69         for (var line : lines.get().split(&quot;\\R&quot;)) {
  70             var matcher = pattern.matcher(line);
  71             if (matcher.find()) {
  72                 count++;
  73             }
  74         }
  75         return count;
  76     }
  77 
  78     private boolean webrevContains(Path webrev, String text) {
  79         try {
  80             var index = Files.find(webrev, 5, (path, attrs) -&gt; path.toString().endsWith(&quot;index.html&quot;)).findAny();
  81             if (index.isEmpty()) {
  82                 return false;
  83             }
  84             var lines = Files.readString(index.get(), StandardCharsets.UTF_8);
  85             return lines.contains(text);
  86         } catch (IOException e) {
  87             return false;
  88         }
  89     }
  90 
  91     private long countSubstrings(String string, String substring) {
  92         return Pattern.compile(substring).matcher(string).results().count();
  93     }
  94 
  95     private String noreplyAddress(HostedRepository repository) {
  96         return &quot;test+&quot; + repository.forge().currentUser().id() + &quot;+&quot; +
  97                 repository.forge().currentUser().userName() +
  98                 &quot;@openjdk.java.net&quot;;
  99     }
 100 
 101     @Test
 102     void simpleArchive(TestInfo testInfo) throws IOException {
 103         try (var credentials = new HostCredentials(testInfo);
 104              var tempFolder = new TemporaryDirectory();
 105              var archiveFolder = new TemporaryDirectory();
 106              var webrevFolder = new TemporaryDirectory();
 107              var listServer = new TestMailmanServer();
 108              var webrevServer = new TestWebrevServer()) {
 109             var author = credentials.getHostedRepository();
 110             var archive = credentials.getHostedRepository();
 111             var ignored = credentials.getHostedRepository();
 112             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
 113             var censusBuilder = credentials.getCensusBuilder()
 114                                            .addAuthor(author.forge().currentUser().id());
 115             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
 116             var mlBot = new MailingListBridgeBot(from, author, archive, &quot;master&quot;,
 117                                                  censusBuilder.build(), &quot;master&quot;, listAddress,
 118                                                  Set.of(ignored.forge().currentUser().userName()),
 119                                                  Set.of(),
 120                                                  listServer.getArchive(), listServer.getSMTP(),
 121                                                  archive, &quot;webrev&quot;, Path.of(&quot;test&quot;),
 122                                                  webrevServer.uri(),
 123                                                  Set.of(&quot;rfr&quot;), Map.of(ignored.forge().currentUser().userName(),
 124                                                                        Pattern.compile(&quot;ready&quot;)),
 125                                                  URIBuilder.base(&quot;http://issues.test/browse/&quot;).build(),
 126                                                  Map.of(&quot;Extra1&quot;, &quot;val1&quot;, &quot;Extra2&quot;, &quot;val2&quot;),
 127                                                  Duration.ZERO);
 128 
 129             // Populate the projects repository
 130             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType());
 131             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
 132             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
 133             localRepo.push(masterHash, archive.url(), &quot;webrev&quot;, true);
 134 
 135             // Make a change with a corresponding PR
 136             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;A simple change&quot;,
 137                                                                &quot;Change msg\n\nWith several lines&quot;);
 138             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
 139             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;1234: This is a pull request&quot;);
 140             pr.setBody(&quot;This should not be ready&quot;);
 141 
 142             // Run an archive pass
 143             TestBotRunner.runPeriodicItems(mlBot);
 144 
 145             // A PR that isn&#39;t ready for review should not be archived
 146             Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);
 147             assertFalse(archiveContains(archiveFolder.path(), &quot;This is a pull request&quot;));
 148 
 149             // Flag it as ready for review
 150             pr.setBody(&quot;This should now be ready&quot;);
 151             pr.addLabel(&quot;rfr&quot;);
 152 
 153             // Run another archive pass
 154             TestBotRunner.runPeriodicItems(mlBot);
 155 
 156             // But it should still not be archived
 157             Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);
 158             assertFalse(archiveContains(archiveFolder.path(), &quot;This is a pull request&quot;));
 159 
 160             // Now post a general comment - not a ready marker
 161             var ignoredPr = ignored.pullRequest(pr.id());
 162             ignoredPr.addComment(&quot;hello there&quot;);
 163 
 164             // Run another archive pass
 165             TestBotRunner.runPeriodicItems(mlBot);
 166 
 167             // It should still not be archived
 168             Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);
 169             assertFalse(archiveContains(archiveFolder.path(), &quot;This is a pull request&quot;));
 170 
 171             // Now post a ready comment
 172             ignoredPr.addComment(&quot;ready&quot;);
 173 
 174             // Run another archive pass
 175             TestBotRunner.runPeriodicItems(mlBot);
 176 
 177             // The archive should now contain an entry
 178             Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);
 179             assertTrue(archiveContains(archiveFolder.path(), &quot;This is a pull request&quot;));
 180             assertTrue(archiveContains(archiveFolder.path(), &quot;This should now be ready&quot;));
 181             assertTrue(archiveContains(archiveFolder.path(), &quot;Patch:&quot;));
 182             assertTrue(archiveContains(archiveFolder.path(), &quot;Changes:&quot;));
 183             assertTrue(archiveContains(archiveFolder.path(), &quot;Webrev:&quot;));
 184             assertTrue(archiveContains(archiveFolder.path(), webrevServer.uri().toString()));
 185             assertTrue(archiveContains(archiveFolder.path(), &quot;webrev.00&quot;));
 186             assertTrue(archiveContains(archiveFolder.path(), &quot;Issue:&quot;));
 187             assertTrue(archiveContains(archiveFolder.path(), &quot;http://issues.test/browse/TSTPRJ-1234&quot;));
 188             assertTrue(archiveContains(archiveFolder.path(), &quot;Fetch:&quot;));
 189             assertTrue(archiveContains(archiveFolder.path(), &quot;^ - &quot; + editHash.abbreviate() + &quot;: Change msg&quot;));
 190             assertFalse(archiveContains(archiveFolder.path(), &quot;With several lines&quot;));
 191 
 192             // The mailing list as well
 193             listServer.processIncoming();
 194             var mailmanServer = MailingListServerFactory.createMailmanServer(listServer.getArchive(), listServer.getSMTP(), Duration.ZERO);
 195             var mailmanList = mailmanServer.getList(listAddress.address());
 196             var conversations = mailmanList.conversations(Duration.ofDays(1));
 197             assertEquals(1, conversations.size());
 198             var mail = conversations.get(0).first();
 199             assertEquals(&quot;RFR: 1234: This is a pull request&quot;, mail.subject());
 200             assertEquals(pr.author().fullName(), mail.author().fullName().orElseThrow());
 201             assertEquals(noreplyAddress(archive), mail.author().address());
 202             assertEquals(listAddress, mail.sender());
 203             assertEquals(&quot;val1&quot;, mail.headerValue(&quot;Extra1&quot;));
 204             assertEquals(&quot;val2&quot;, mail.headerValue(&quot;Extra2&quot;));
 205 
 206             // And there should be a webrev
 207             Repository.materialize(webrevFolder.path(), archive.url(), &quot;webrev&quot;);
 208             assertTrue(webrevContains(webrevFolder.path(), &quot;1 lines changed&quot;));
 209             var comments = pr.comments();
 210             var webrevComments = comments.stream()
 211                                          .filter(comment -&gt; comment.author().equals(author.forge().currentUser()))
 212                                          .filter(comment -&gt; comment.body().contains(&quot;webrev&quot;))
 213                                          .filter(comment -&gt; comment.body().contains(editHash.hex()))
 214                                          .collect(Collectors.toList());
 215             assertEquals(1, webrevComments.size());
 216 
 217             // Add a comment
 218             pr.addComment(&quot;This is a comment :smile:&quot;);
 219 
 220             // Add a comment from an ignored user as well
 221             ignoredPr.addComment(&quot;Don&#39;t mind me&quot;);
 222 
 223             // Run another archive pass
 224             TestBotRunner.runPeriodicItems(mlBot);
 225 
 226             // The archive should now contain the comment, but not the ignored one
 227             Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);
 228             assertTrue(archiveContains(archiveFolder.path(), &quot;This is a comment&quot;));
 229             assertTrue(archiveContains(archiveFolder.path(), &quot;&gt; This should now be ready&quot;));
 230             assertFalse(archiveContains(archiveFolder.path(), &quot;Don&#39;t mind me&quot;));
 231 
 232             listServer.processIncoming();
 233             conversations = mailmanList.conversations(Duration.ofDays(1));
 234             assertEquals(1, conversations.size());
 235             assertEquals(2, conversations.get(0).allMessages().size());
 236 
 237             // Remove the rfr flag and post another comment
 238             pr.addLabel(&quot;rfr&quot;);
 239             pr.addComment(&quot;This is another comment&quot;);
 240 
 241             // Run another archive pass
 242             TestBotRunner.runPeriodicItems(mlBot);
 243 
 244             // The archive should contain the additional comment
 245             Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);
 246             assertTrue(archiveContains(archiveFolder.path(), &quot;This is another comment&quot;));
 247             assertTrue(archiveContains(archiveFolder.path(), &quot;&gt;&gt; This should now be ready&quot;));
 248 
 249             listServer.processIncoming();
 250             conversations = mailmanList.conversations(Duration.ofDays(1));
 251             assertEquals(1, conversations.size());
 252             assertEquals(3, conversations.get(0).allMessages().size());
 253             for (var newMail : conversations.get(0).allMessages()) {
 254                 assertEquals(noreplyAddress(archive), newMail.author().address());
 255                 assertEquals(listAddress, newMail.sender());
 256             }
 257             assertTrue(conversations.get(0).allMessages().get(2).body().contains(&quot;This is a comment ðŸ˜„&quot;));
 258         }
 259     }
 260 
 261     @Test
 262     void reviewComment(TestInfo testInfo) throws IOException {
 263         try (var credentials = new HostCredentials(testInfo);
 264              var tempFolder = new TemporaryDirectory();
 265              var archiveFolder = new TemporaryDirectory();
 266              var listServer = new TestMailmanServer();
 267              var webrevServer = new TestWebrevServer()) {
 268             var author = credentials.getHostedRepository();
 269             var archive = credentials.getHostedRepository();
 270             var ignored = credentials.getHostedRepository();
 271             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
 272             var censusBuilder = credentials.getCensusBuilder()
 273                                            .addAuthor(author.forge().currentUser().id());
 274             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
 275             var mlBot = new MailingListBridgeBot(from, author, archive, &quot;master&quot;,
 276                                                  censusBuilder.build(), &quot;master&quot;, listAddress,
 277                                                  Set.of(ignored.forge().currentUser().userName()),
 278                                                  Set.of(),
 279                                                  listServer.getArchive(), listServer.getSMTP(),
 280                                                  archive, &quot;webrev&quot;, Path.of(&quot;test&quot;),
 281                                                  webrevServer.uri(),
 282                                                  Set.of(), Map.of(),
 283                                                  URIBuilder.base(&quot;http://issues.test/browse/&quot;).build(),
 284                                                  Map.of(), Duration.ZERO);
 285 
 286             // Populate the projects repository
 287             var reviewFile = Path.of(&quot;reviewfile.txt&quot;);
 288             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType(), reviewFile);
 289             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
 290             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
 291             localRepo.push(masterHash, archive.url(), &quot;webrev&quot;, true);
 292 
 293             // Make a change with a corresponding PR
 294             var editHash = CheckableRepository.appendAndCommit(localRepo);
 295             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
 296             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
 297             pr.setBody(&quot;This is now ready&quot;);
 298             TestBotRunner.runPeriodicItems(mlBot);
 299             listServer.processIncoming();
 300 
 301             // And make a file specific comment
 302             var currentMaster = localRepo.resolve(&quot;master&quot;).orElseThrow();
 303             var comment = pr.addReviewComment(masterHash, editHash, reviewFile.toString(), 2, &quot;Review comment&quot;);
 304 
 305             // Add one from an ignored user as well
 306             var ignoredPr = ignored.pullRequest(pr.id());
 307             ignoredPr.addReviewComment(masterHash, editHash, reviewFile.toString(), 2, &quot;Don&#39;t mind me&quot;);
 308 
 309             // Process comments
 310             TestBotRunner.runPeriodicItems(mlBot);
 311             listServer.processIncoming();
 312 
 313             // The archive should now contain an entry
 314             Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);
 315             assertTrue(archiveContains(archiveFolder.path(), &quot;This is a pull request&quot;));
 316             assertTrue(archiveContains(archiveFolder.path(), &quot;This is now ready&quot;));
 317             assertTrue(archiveContains(archiveFolder.path(), &quot;Review comment&quot;));
 318             assertTrue(archiveContains(archiveFolder.path(), &quot;&gt; This is now ready&quot;));
 319             assertTrue(archiveContains(archiveFolder.path(), reviewFile.toString()));
 320             assertFalse(archiveContains(archiveFolder.path(), &quot;Don&#39;t mind me&quot;));
 321 
 322             // The mailing list as well
 323             var mailmanServer = MailingListServerFactory.createMailmanServer(listServer.getArchive(), listServer.getSMTP(), Duration.ZERO);
 324             var mailmanList = mailmanServer.getList(listAddress.address());
 325             var conversations = mailmanList.conversations(Duration.ofDays(1));
 326             assertEquals(1, conversations.size());
 327             var mail = conversations.get(0).first();
 328             assertEquals(&quot;RFR: This is a pull request&quot;, mail.subject());
 329 
 330             // Comment on the comment
 331             pr.addReviewCommentReply(comment, &quot;This is a review reply&quot;);
 332             TestBotRunner.runPeriodicItems(mlBot);
 333             listServer.processIncoming();
 334 
 335             // The archive should contain the additional comment (but no quoted footers)
 336             Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);
 337             assertTrue(archiveContains(archiveFolder.path(), &quot;This is a review reply&quot;));
 338             assertTrue(archiveContains(archiveFolder.path(), &quot;&gt;&gt; This is now ready&quot;));
 339             assertFalse(archiveContains(archiveFolder.path(), &quot;^&gt; PR:&quot;));
 340 
 341             // As well as the mailing list
 342             conversations = mailmanList.conversations(Duration.ofDays(1));
 343             assertEquals(1, conversations.size());
 344             assertEquals(3, conversations.get(0).allMessages().size());
 345             for (var newMail : conversations.get(0).allMessages()) {
 346                 assertEquals(noreplyAddress(archive), newMail.author().address());
 347                 assertEquals(listAddress, newMail.sender());
 348             }
 349         }
 350     }
 351 
 352     @Test
 353     void combineComments(TestInfo testInfo) throws IOException {
 354         try (var credentials = new HostCredentials(testInfo);
 355              var tempFolder = new TemporaryDirectory();
 356              var archiveFolder = new TemporaryDirectory();
 357              var listServer = new TestMailmanServer();
 358              var webrevServer = new TestWebrevServer()) {
 359             var author = credentials.getHostedRepository();
 360             var archive = credentials.getHostedRepository();
 361             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
 362             var censusBuilder = credentials.getCensusBuilder()
 363                                            .addAuthor(author.forge().currentUser().id());
 364             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
 365             var mlBot = new MailingListBridgeBot(from, author, archive, &quot;master&quot;,
 366                                                  censusBuilder.build(), &quot;master&quot;,
 367                                                  listAddress, Set.of(), Set.of(),
 368                                                  listServer.getArchive(),
 369                                                  listServer.getSMTP(),
 370                                                  archive, &quot;webrev&quot;, Path.of(&quot;test&quot;),
 371                                                  webrevServer.uri(),
 372                                                  Set.of(), Map.of(),
 373                                                  URIBuilder.base(&quot;http://issues.test/browse/&quot;).build(),
 374                                                  Map.of(), Duration.ZERO);
 375 
 376             // Populate the projects repository
 377             var reviewFile = Path.of(&quot;reviewfile.txt&quot;);
 378             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType(), reviewFile);
 379             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
 380             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
 381             localRepo.push(masterHash, archive.url(), &quot;webrev&quot;, true);
 382 
 383             // Make a change with a corresponding PR
 384             var editHash = CheckableRepository.appendAndCommit(localRepo);
 385             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
 386             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
 387             pr.setBody(&quot;This is now ready&quot;);
 388             pr.addComment(&quot;Avoid combining&quot;);
 389 
 390             TestBotRunner.runPeriodicItems(mlBot);
 391             listServer.processIncoming();
 392             listServer.processIncoming();
 393 
 394             // Make several file specific comments
 395             var first = pr.addReviewComment(masterHash, editHash, reviewFile.toString(), 2, &quot;Review comment&quot;);
 396             pr.addReviewComment(masterHash, editHash, reviewFile.toString(), 2, &quot;Another review comment&quot;);
 397             pr.addReviewComment(masterHash, editHash, reviewFile.toString(), 2, &quot;Further review comment&quot;);
 398             pr.addReviewComment(masterHash, editHash, reviewFile.toString(), 2, &quot;Final review comment&quot;);
 399             TestBotRunner.runPeriodicItems(mlBot);
 400             listServer.processIncoming();
 401 
 402             // The archive should contain a combined entry
 403             Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);
 404             assertEquals(2, archiveContainsCount(archiveFolder.path(), &quot;^On.*wrote:&quot;));
 405 
 406             // As well as the mailing list
 407             var mailmanServer = MailingListServerFactory.createMailmanServer(listServer.getArchive(), listServer.getSMTP(), Duration.ZERO);
 408             var mailmanList = mailmanServer.getList(listAddress.address());
 409             var conversations = mailmanList.conversations(Duration.ofDays(1));
 410             assertEquals(1, conversations.size());
 411             var mail = conversations.get(0).first();
 412             assertEquals(&quot;RFR: This is a pull request&quot;, mail.subject());
 413             assertEquals(3, conversations.get(0).allMessages().size());
 414 
 415             var commentReply = conversations.get(0).replies(mail).get(0);
 416             assertEquals(2, commentReply.body().split(&quot;^On.*wrote:&quot;).length);
 417             assertTrue(commentReply.body().contains(&quot;Avoid combining\n\n&quot;), commentReply.body());
 418 
 419             var reviewReply = conversations.get(0).replies(mail).get(1);
 420             assertEquals(2, reviewReply.body().split(&quot;^On.*wrote:&quot;).length);
 421             assertEquals(2, reviewReply.body().split(&quot;&gt; This is now ready&quot;).length, reviewReply.body());
 422             assertEquals(&quot;Re: RFR: This is a pull request&quot;, reviewReply.subject());
 423             assertTrue(reviewReply.body().contains(&quot;Review comment\n\n&quot;), reviewReply.body());
 424             assertTrue(reviewReply.body().contains(&quot;Another review comment&quot;), reviewReply.body());
 425 
 426             // Now reply to the first (collapsed) comment
 427             pr.addReviewCommentReply(first, &quot;I agree&quot;);
 428             TestBotRunner.runPeriodicItems(mlBot);
 429             listServer.processIncoming();
 430 
 431             // The archive should contain a new entry
 432             Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);
 433             assertEquals(3, archiveContainsCount(archiveFolder.path(), &quot;^On.*wrote:&quot;));
 434 
 435             // The combined review comments should only appear unquoted once
 436             assertEquals(1, archiveContainsCount(archiveFolder.path(), &quot;^Another review comment&quot;));
 437         }
 438     }
 439 
 440     @Test
 441     void commentThreading(TestInfo testInfo) throws IOException {
 442         try (var credentials = new HostCredentials(testInfo);
 443              var tempFolder = new TemporaryDirectory();
 444              var archiveFolder = new TemporaryDirectory();
 445              var listServer = new TestMailmanServer();
 446              var webrevServer = new TestWebrevServer()) {
 447             var author = credentials.getHostedRepository();
 448             var reviewer = credentials.getHostedRepository();
 449             var archive = credentials.getHostedRepository();
 450             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
 451             var censusBuilder = credentials.getCensusBuilder()
 452                                            .addReviewer(reviewer.forge().currentUser().id())
 453                                            .addAuthor(author.forge().currentUser().id());
 454             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
 455             var mlBot = new MailingListBridgeBot(from, author, archive, &quot;master&quot;,
 456                                                  censusBuilder.build(), &quot;master&quot;,
 457                                                  listAddress, Set.of(), Set.of(),
 458                                                  listServer.getArchive(),
 459                                                  listServer.getSMTP(),
 460                                                  archive, &quot;webrev&quot;, Path.of(&quot;test&quot;),
 461                                                  webrevServer.uri(),
 462                                                  Set.of(), Map.of(),
 463                                                  URIBuilder.base(&quot;http://issues.test/browse/&quot;).build(),
 464                                                  Map.of(), Duration.ZERO);
 465 
 466             // Populate the projects repository
 467             var reviewFile = Path.of(&quot;reviewfile.txt&quot;);
 468             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType(), reviewFile);
 469             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
 470             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
 471             localRepo.push(masterHash, archive.url(), &quot;webrev&quot;, true);
 472 
 473             // Make a change with a corresponding PR
 474             var editHash = CheckableRepository.appendAndCommit(localRepo);
 475             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
 476             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
 477             pr.setBody(&quot;This is now ready&quot;);
 478             TestBotRunner.runPeriodicItems(mlBot);
 479             listServer.processIncoming();
 480 
 481             // Make a file specific comment
 482             var reviewPr = reviewer.pullRequest(pr.id());
 483             var comment1 = reviewPr.addReviewComment(masterHash, editHash, reviewFile.toString(), 2, &quot;Review comment&quot;);
 484             pr.addReviewCommentReply(comment1, &quot;I agree&quot;);
 485             reviewPr.addReviewCommentReply(comment1, &quot;Great&quot;);
 486             TestBotRunner.runPeriodicItems(mlBot);
 487             listServer.processIncoming();
 488             listServer.processIncoming();
 489             listServer.processIncoming();
 490 
 491             // And a second one by ourselves
 492             var comment2 = pr.addReviewComment(masterHash, editHash, reviewFile.toString(), 2, &quot;Another review comment&quot;);
 493             reviewPr.addReviewCommentReply(comment2, &quot;Sounds good&quot;);
 494             pr.addReviewCommentReply(comment2, &quot;Thanks&quot;);
 495             TestBotRunner.runPeriodicItems(mlBot);
 496             listServer.processIncoming();
 497             listServer.processIncoming();
 498             listServer.processIncoming();
 499 
 500             // Finally some approvals and another comment
 501             pr.addReview(Review.Verdict.APPROVED, &quot;Nice&quot;);
 502             reviewPr.addReviewComment(masterHash, editHash, reviewFile.toString(), 2, &quot;The final review comment&quot;);
 503             reviewPr.addReview(Review.Verdict.APPROVED, &quot;Looks fine&quot;);
 504             reviewPr.addReviewCommentReply(comment2, &quot;You are welcome&quot;);
 505             TestBotRunner.runPeriodicItems(mlBot);
 506             listServer.processIncoming();
 507             listServer.processIncoming();
 508             listServer.processIncoming();
 509 
 510             // Sanity check the archive
 511             Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);
 512             assertEquals(9, archiveContainsCount(archiveFolder.path(), &quot;^On.*wrote:&quot;));
 513 
 514             // File specific comments should appear after the approval
 515             var archiveText = archiveContents(archiveFolder.path()).orElseThrow();
 516             assertTrue(archiveText.indexOf(&quot;Looks fine&quot;) &lt; archiveText.indexOf(&quot;The final review comment&quot;));
 517 
 518             // Check the mailing list
 519             var mailmanServer = MailingListServerFactory.createMailmanServer(listServer.getArchive(), listServer.getSMTP(), Duration.ZERO);
 520             var mailmanList = mailmanServer.getList(listAddress.address());
 521             var conversations = mailmanList.conversations(Duration.ofDays(1));
 522             assertEquals(1, conversations.size());
 523             var mail = conversations.get(0).first();
 524             assertEquals(&quot;RFR: This is a pull request&quot;, mail.subject());
 525             assertEquals(10, conversations.get(0).allMessages().size());
 526 
 527             // There should be four separate threads
 528             var thread1 = conversations.get(0).replies(mail).get(0);
 529             assertEquals(2, thread1.body().split(&quot;^On.*wrote:&quot;).length);
 530             assertEquals(2, thread1.body().split(&quot;&gt; This is now ready&quot;).length, thread1.body());
 531             assertEquals(&quot;Re: RFR: This is a pull request&quot;, thread1.subject());
 532             assertTrue(thread1.body().contains(&quot;Review comment\n\n&quot;), thread1.body());
 533             assertFalse(thread1.body().contains(&quot;Another review comment&quot;), thread1.body());
 534             var thread1reply1 = conversations.get(0).replies(thread1).get(0);
 535             assertTrue(thread1reply1.body().contains(&quot;I agree&quot;));
 536             assertEquals(noreplyAddress(archive), thread1reply1.author().address());
 537             assertEquals(archive.forge().currentUser().fullName(), thread1reply1.author().fullName().orElseThrow());
 538             var thread1reply2 = conversations.get(0).replies(thread1reply1).get(0);
 539             assertTrue(thread1reply2.body().contains(&quot;Great&quot;));
 540             assertEquals(&quot;integrationreviewer1@openjdk.java.net&quot;, thread1reply2.author().address());
 541             assertEquals(&quot;Generated Reviewer 1&quot;, thread1reply2.author().fullName().orElseThrow());
 542 
 543             var thread2 = conversations.get(0).replies(mail).get(1);
 544             assertEquals(2, thread2.body().split(&quot;^On.*wrote:&quot;).length);
 545             assertEquals(2, thread2.body().split(&quot;&gt; This is now ready&quot;).length, thread2.body());
 546             assertEquals(&quot;Re: RFR: This is a pull request&quot;, thread2.subject());
 547             assertFalse(thread2.body().contains(&quot;Review comment\n\n&quot;), thread2.body());
 548             assertTrue(thread2.body().contains(&quot;Another review comment&quot;), thread2.body());
 549             var thread2reply1 = conversations.get(0).replies(thread2).get(0);
 550             assertTrue(thread2reply1.body().contains(&quot;Sounds good&quot;));
 551             var thread2reply2 = conversations.get(0).replies(thread2reply1).get(0);
 552             assertTrue(thread2reply2.body().contains(&quot;Thanks&quot;));
 553 
 554             var replies = conversations.get(0).replies(mail);
 555             var thread3 = replies.get(2);
 556             assertEquals(&quot;Re: RFR: This is a pull request&quot;, thread3.subject());
 557             var thread4 = replies.get(3);
 558             assertEquals(&quot;Re: RFR: This is a pull request&quot;, thread4.subject());
 559             assertTrue(thread4.body().contains(&quot;Looks fine&quot;));
 560             assertTrue(thread4.body().contains(&quot;The final review comment&quot;));
 561             assertTrue(thread4.body().contains(&quot;Marked as reviewed by integrationreviewer1 (Reviewer)&quot;));
 562         }
 563     }
 564 
 565     @Test
 566     void commentThreadingSeparated(TestInfo testInfo) throws IOException {
 567         try (var credentials = new HostCredentials(testInfo);
 568              var tempFolder = new TemporaryDirectory();
 569              var archiveFolder = new TemporaryDirectory();
 570              var listServer = new TestMailmanServer();
 571              var webrevServer = new TestWebrevServer()) {
 572             var author = credentials.getHostedRepository();
 573             var reviewer = credentials.getHostedRepository();
 574             var archive = credentials.getHostedRepository();
 575             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
 576             var censusBuilder = credentials.getCensusBuilder()
 577                                            .addReviewer(reviewer.forge().currentUser().id())
 578                                            .addAuthor(author.forge().currentUser().id());
 579             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
 580             var mlBot = new MailingListBridgeBot(from, author, archive, &quot;master&quot;, censusBuilder.build(), &quot;master&quot;,
 581                                                  listAddress, Set.of(), Set.of(),
 582                                                  listServer.getArchive(),
 583                                                  listServer.getSMTP(),
 584                                                  archive, &quot;webrev&quot;, Path.of(&quot;test&quot;),
 585                                                  webrevServer.uri(),
 586                                                  Set.of(), Map.of(),
 587                                                  URIBuilder.base(&quot;http://issues.test/browse/&quot;).build(),
 588                                                  Map.of(), Duration.ZERO);
 589 
 590             // Populate the projects repository
 591             var reviewFile = Path.of(&quot;reviewfile.txt&quot;);
 592             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType(), reviewFile);
 593             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
 594             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
 595             localRepo.push(masterHash, archive.url(), &quot;webrev&quot;, true);
 596 
 597             // Make a change with a corresponding PR
 598             var editHash = CheckableRepository.appendAndCommit(localRepo);
 599             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
 600             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
 601             pr.setBody(&quot;This is now ready&quot;);
 602             TestBotRunner.runPeriodicItems(mlBot);
 603             listServer.processIncoming();
 604 
 605             // Make two file specific comments
 606             var reviewPr = reviewer.pullRequest(pr.id());
 607             var comment1 = reviewPr.addReviewComment(masterHash, editHash, reviewFile.toString(), 2, &quot;Review comment&quot;);
 608             var comment2 = reviewPr.addReviewComment(masterHash, editHash, reviewFile.toString(), 2, &quot;Another review comment&quot;);
 609             TestBotRunner.runPeriodicItems(mlBot);
 610             listServer.processIncoming();
 611 
 612             pr.addReviewCommentReply(comment1, &quot;I agree&quot;);
 613             pr.addReviewCommentReply(comment2, &quot;I don&#39;t agree&quot;);
 614             TestBotRunner.runPeriodicItems(mlBot);
 615             listServer.processIncoming();
 616 
 617             // Sanity check the archive
 618             Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);
 619             assertEquals(3, archiveContainsCount(archiveFolder.path(), &quot;^On.*wrote:&quot;));
 620         }
 621     }
 622 
 623     @Test
 624     void reviewContext(TestInfo testInfo) throws IOException {
 625         try (var credentials = new HostCredentials(testInfo);
 626              var tempFolder = new TemporaryDirectory();
 627              var archiveFolder = new TemporaryDirectory();
 628              var listServer = new TestMailmanServer();
 629              var webrevServer = new TestWebrevServer()) {
 630             var author = credentials.getHostedRepository();
 631             var archive = credentials.getHostedRepository();
 632             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
 633             var censusBuilder = credentials.getCensusBuilder()
 634                                            .addAuthor(author.forge().currentUser().id());
 635             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
 636             var mlBot = new MailingListBridgeBot(from, author, archive, &quot;master&quot;,
 637                                                  censusBuilder.build(), &quot;master&quot;,
 638                                                  listAddress, Set.of(), Set.of(),
 639                                                  listServer.getArchive(),
 640                                                  listServer.getSMTP(),
 641                                                  archive, &quot;webrev&quot;, Path.of(&quot;test&quot;),
 642                                                  webrevServer.uri(),
 643                                                  Set.of(), Map.of(),
 644                                                  URIBuilder.base(&quot;http://issues.test/browse/&quot;).build(),
 645                                                  Map.of(), Duration.ZERO);
 646 
 647             // Populate the projects repository
 648             var reviewFile = Path.of(&quot;reviewfile.txt&quot;);
 649             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType(), reviewFile);
 650             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
 651             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
 652             localRepo.push(masterHash, archive.url(), &quot;webrev&quot;, true);
 653 
 654             // Make a change with a corresponding PR
 655             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;Line 1\nLine 2\nLine 3\nLine 4&quot;);
 656             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
 657             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
 658             pr.setBody(&quot;This is now ready&quot;);
 659             TestBotRunner.runPeriodicItems(mlBot);
 660             listServer.processIncoming();
 661 
 662             // Make a file specific comment
 663             pr.addReviewComment(masterHash, editHash, reviewFile.toString(), 2, &quot;Review comment&quot;);
 664 
 665             TestBotRunner.runPeriodicItems(mlBot);
 666             listServer.processIncoming();
 667 
 668             // The archive should only contain context around line 2
 669             Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);
 670             assertTrue(archiveContains(archiveFolder.path(), &quot;^&gt; 2: Line 1$&quot;));
 671             assertTrue(archiveContains(archiveFolder.path(), &quot;^&gt; 3: Line 2$&quot;));
 672             assertFalse(archiveContains(archiveFolder.path(), &quot;^&gt; 4: Line 3$&quot;));
 673         }
 674     }
 675 
 676     @Test
 677     void multipleReviewContexts(TestInfo testInfo) throws IOException {
 678         try (var credentials = new HostCredentials(testInfo);
 679              var tempFolder = new TemporaryDirectory();
 680              var archiveFolder = new TemporaryDirectory();
 681              var listServer = new TestMailmanServer();
 682              var webrevServer = new TestWebrevServer()) {
 683             var author = credentials.getHostedRepository();
 684             var archive = credentials.getHostedRepository();
 685             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
 686             var censusBuilder = credentials.getCensusBuilder()
 687                                            .addAuthor(author.forge().currentUser().id());
 688             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
 689             var mlBot = new MailingListBridgeBot(from, author, archive, &quot;master&quot;,
 690                                                  censusBuilder.build(), &quot;master&quot;,
 691                                                  listAddress, Set.of(), Set.of(),
 692                                                  listServer.getArchive(),
 693                                                  listServer.getSMTP(),
 694                                                  archive, &quot;webrev&quot;, Path.of(&quot;test&quot;),
 695                                                  webrevServer.uri(),
 696                                                  Set.of(), Map.of(),
 697                                                  URIBuilder.base(&quot;http://issues.test/browse/&quot;).build(),
 698                                                  Map.of(), Duration.ZERO);
 699 
 700             // Populate the projects repository
 701             var reviewFile = Path.of(&quot;reviewfile.txt&quot;);
 702             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType(), reviewFile);
 703             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
 704             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
 705             localRepo.push(masterHash, archive.url(), &quot;webrev&quot;, true);
 706             var initialHash = CheckableRepository.appendAndCommit(localRepo,
 707                                                                   &quot;Line 0.1\nLine 0.2\nLine 0.3\nLine 0.4\n&quot; +
 708                                                                           &quot;Line 1\nLine 2\nLine 3\nLine 4\n&quot; +
 709                                                                           &quot;Line 5\nLine 6\nLine 7\nLine 8\n&quot; +
 710                                                                           &quot;Line 8.1\nLine 8.2\nLine 8.3\nLine 8.4\n&quot; +
 711                                                                           &quot;Line 9\nLine 10\nLine 11\nLine 12\n&quot; +
 712                                                                           &quot;Line 13\nLine 14\nLine 15\nLine 16\n&quot;);
 713             localRepo.push(initialHash, author.url(), &quot;master&quot;);
 714 
 715             // Make a change with a corresponding PR
 716             var current = Files.readString(localRepo.root().resolve(reviewFile), StandardCharsets.UTF_8);
 717             var updated = current.replaceAll(&quot;Line 2&quot;, &quot;Line 2 edit\nLine 2.5&quot;);
 718             updated = updated.replaceAll(&quot;Line 13&quot;, &quot;Line 12.5\nLine 13 edit&quot;);
 719             Files.writeString(localRepo.root().resolve(reviewFile), updated, StandardCharsets.UTF_8);
 720             var editHash = CheckableRepository.appendAndCommit(localRepo);
 721             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
 722             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
 723             pr.setBody(&quot;This is now ready&quot;);
 724             TestBotRunner.runPeriodicItems(mlBot);
 725             listServer.processIncoming();
 726 
 727             // Make file specific comments
 728             pr.addReviewComment(masterHash, editHash, reviewFile.toString(), 7, &quot;Review comment&quot;);
 729             pr.addReviewComment(masterHash, editHash, reviewFile.toString(), 24, &quot;Another review comment&quot;);
 730 
 731             TestBotRunner.runPeriodicItems(mlBot);
 732             listServer.processIncoming();
 733 
 734             // The archive should only contain context around line 2 and 20
 735             Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);
 736             assertTrue(archiveContains(archiveFolder.path(), &quot;reviewfile.txt line 7&quot;));
 737             assertTrue(archiveContains(archiveFolder.path(), &quot;^&gt; 6: Line 1$&quot;));
 738             assertTrue(archiveContains(archiveFolder.path(), &quot;^&gt; 7: Line 2 edit$&quot;));
 739             assertFalse(archiveContains(archiveFolder.path(), &quot;Line 3&quot;));
 740 
 741             assertTrue(archiveContains(archiveFolder.path(), &quot;reviewfile.txt line 24&quot;));
 742             assertTrue(archiveContains(archiveFolder.path(), &quot;^&gt; 23: Line 12.5$&quot;));
 743             assertTrue(archiveContains(archiveFolder.path(), &quot;^&gt; 24: Line 13 edit$&quot;));
 744             assertFalse(archiveContains(archiveFolder.path(), &quot;^Line 15&quot;));
 745         }
 746     }
 747 
 748     @Test
 749     void filterComments(TestInfo testInfo) throws IOException {
 750         try (var credentials = new HostCredentials(testInfo);
 751              var tempFolder = new TemporaryDirectory();
 752              var archiveFolder = new TemporaryDirectory();
 753              var listServer = new TestMailmanServer();
 754              var webrevServer = new TestWebrevServer()) {
 755             var author = credentials.getHostedRepository();
 756             var archive = credentials.getHostedRepository();
 757             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
 758             var censusBuilder = credentials.getCensusBuilder()
 759                                            .addAuthor(author.forge().currentUser().id());
 760             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
 761             var mlBot = new MailingListBridgeBot(from, author, archive, &quot;master&quot;,
 762                                                  censusBuilder.build(), &quot;master&quot;,
 763                                                  listAddress, Set.of(), Set.of(),
 764                                                  listServer.getArchive(), listServer.getSMTP(),
 765                                                  archive, &quot;webrev&quot;, Path.of(&quot;test&quot;),
 766                                                  webrevServer.uri(),
 767                                                  Set.of(), Map.of(),
 768                                                  URIBuilder.base(&quot;http://issues.test/browse/&quot;).build(),
 769                                                  Map.of(), Duration.ZERO);
 770 
 771             // Populate the projects repository
 772             var reviewFile = Path.of(&quot;reviewfile.txt&quot;);
 773             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType(), reviewFile);
 774             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
 775             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
 776             localRepo.push(masterHash, archive.url(), &quot;webrev&quot;, true);
 777 
 778             // Make a change with a corresponding PR
 779             var editHash = CheckableRepository.appendAndCommit(localRepo);
 780             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
 781             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
 782             pr.setBody(&quot;This is now ready\n&lt;!-- this is a comment --&gt;\nAnd this is not\n&quot; +
 783                                &quot;&lt;!-- Anything below this marker will be hidden --&gt;\nStatus stuff&quot;);
 784 
 785             // Make a bunch of comments
 786             pr.addComment(&quot;Plain comment\n&lt;!-- this is a comment --&gt;&quot;);
 787             pr.addReviewComment(masterHash, editHash, reviewFile.toString(), 2, &quot;Review comment &lt;!-- this is a comment --&gt;\n&quot;);
 788             pr.addComment(&quot;/integrate stuff&quot;);
 789             TestBotRunner.runPeriodicItems(mlBot);
 790 
 791             // Run an archive pass
 792             TestBotRunner.runPeriodicItems(mlBot);
 793 
 794             // The archive should not contain the comment
 795             Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);
 796             assertTrue(archiveContains(archiveFolder.path(), &quot;This is now ready&quot;));
 797             assertFalse(archiveContains(archiveFolder.path(), &quot;this is a comment&quot;));
 798             assertFalse(archiveContains(archiveFolder.path(), &quot;Status stuff&quot;));
 799             assertTrue(archiveContains(archiveFolder.path(), &quot;And this is not&quot;));
 800             assertFalse(archiveContains(archiveFolder.path(), &quot;&lt;!--&quot;));
 801             assertFalse(archiveContains(archiveFolder.path(), &quot;--&gt;&quot;));
 802             assertTrue(archiveContains(archiveFolder.path(), &quot;Plain comment&quot;));
 803             assertTrue(archiveContains(archiveFolder.path(), &quot;Review comment&quot;));
 804             assertFalse(archiveContains(archiveFolder.path(), &quot;/integrate&quot;));
 805         }
 806     }
 807 
 808     @Test
 809     void incrementalChanges(TestInfo testInfo) throws IOException {
 810         try (var credentials = new HostCredentials(testInfo);
 811              var tempFolder = new TemporaryDirectory();
 812              var archiveFolder = new TemporaryDirectory();
 813              var listServer = new TestMailmanServer();
 814              var webrevServer = new TestWebrevServer()) {
 815             var author = credentials.getHostedRepository();
 816             var archive = credentials.getHostedRepository();
 817             var commenter = credentials.getHostedRepository();
 818             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
 819             var censusBuilder = credentials.getCensusBuilder()
 820                                            .addAuthor(author.forge().currentUser().id());
 821             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
 822             var mlBot = new MailingListBridgeBot(from, author, archive, &quot;master&quot;,
 823                                                  censusBuilder.build(), &quot;master&quot;,
 824                                                  listAddress, Set.of(), Set.of(),
 825                                                  listServer.getArchive(), listServer.getSMTP(),
 826                                                  archive, &quot;webrev&quot;, Path.of(&quot;test&quot;),
 827                                                  webrevServer.uri(),
 828                                                  Set.of(), Map.of(),
 829                                                  URIBuilder.base(&quot;http://issues.test/browse/&quot;).build(),
 830                                                  Map.of(), Duration.ZERO);
 831 
 832             // Populate the projects repository
 833             var reviewFile = Path.of(&quot;reviewfile.txt&quot;);
 834             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType(), reviewFile);
 835             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
 836             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
 837             localRepo.push(masterHash, archive.url(), &quot;webrev&quot;, true);
 838 
 839             // Make a change with a corresponding PR
 840             var editHash = CheckableRepository.appendAndCommit(localRepo);
 841             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
 842             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
 843             pr.setBody(&quot;This is now ready&quot;);
 844 
 845             // Run an archive pass
 846             TestBotRunner.runPeriodicItems(mlBot);
 847             listServer.processIncoming();
 848 
 849             var nextHash = CheckableRepository.appendAndCommit(localRepo, &quot;Yet one more line&quot;, &quot;Fixing&quot;);
 850             localRepo.push(nextHash, author.url(), &quot;edit&quot;);
 851 
 852             // Make sure that the push registered
 853             var lastHeadHash = pr.headHash();
 854             var refreshCount = 0;
 855             do {
 856                 pr = author.pullRequest(pr.id());
 857                 if (refreshCount++ &gt; 100) {
 858                     fail(&quot;The PR did not update after the new push&quot;);
 859                 }
 860             } while (pr.headHash().equals(lastHeadHash));
 861 
 862             // Run another archive pass
 863             TestBotRunner.runPeriodicItems(mlBot);
 864             TestBotRunner.runPeriodicItems(mlBot);
 865             TestBotRunner.runPeriodicItems(mlBot);
 866             listServer.processIncoming();
 867 
 868             // The archive should reference the updated push
 869             Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);
 870             assertTrue(archiveContains(archiveFolder.path(), &quot;1 additional commit&quot;));
 871             assertTrue(archiveContains(archiveFolder.path(), &quot;full.*/&quot; + pr.id() + &quot;/webrev.01&quot;));
 872             assertTrue(archiveContains(archiveFolder.path(), &quot;inc.*/&quot; + pr.id() + &quot;/webrev.00-01&quot;));
 873             assertTrue(archiveContains(archiveFolder.path(), &quot;Patch&quot;));
 874             assertTrue(archiveContains(archiveFolder.path(), &quot;Fetch&quot;));
 875             assertTrue(archiveContains(archiveFolder.path(), &quot;Fixing&quot;));
 876 
 877             // The webrev comment should be updated
 878             var comments = pr.comments();
 879             var webrevComments = comments.stream()
 880                                          .filter(comment -&gt; comment.author().equals(author.forge().currentUser()))
 881                                          .filter(comment -&gt; comment.body().contains(&quot;webrev&quot;))
 882                                          .filter(comment -&gt; comment.body().contains(nextHash.hex()))
 883                                          .filter(comment -&gt; comment.body().contains(editHash.hex()))
 884                                          .collect(Collectors.toList());
 885             assertEquals(1, webrevComments.size());
 886 
 887             // Check that sender address is set properly
 888             var mailmanServer = MailingListServerFactory.createMailmanServer(listServer.getArchive(), listServer.getSMTP(), Duration.ZERO);
 889             var mailmanList = mailmanServer.getList(listAddress.address());
 890             var conversations = mailmanList.conversations(Duration.ofDays(1));
 891             assertEquals(1, conversations.size());
 892             for (var newMail : conversations.get(0).allMessages()) {
 893                 assertEquals(noreplyAddress(archive), newMail.author().address());
 894                 assertEquals(listAddress, newMail.sender());
 895             }
 896 
 897             // Add a comment
 898             var commenterPr = commenter.pullRequest(pr.id());
 899             commenterPr.addReviewComment(masterHash, nextHash, reviewFile.toString(), 2, &quot;Review comment&quot;);
 900             TestBotRunner.runPeriodicItems(mlBot);
 901             listServer.processIncoming();
 902 
 903             // Ensure that additional updates are only reported once
 904             for (int i = 0; i &lt; 3; ++i) {
 905                 var anotherHash = CheckableRepository.appendAndCommit(localRepo, &quot;Another line&quot;, &quot;Fixing&quot;);
 906                 localRepo.push(anotherHash, author.url(), &quot;edit&quot;);
 907 
 908                 // Make sure that the push registered
 909                 lastHeadHash = pr.headHash();
 910                 refreshCount = 0;
 911                 do {
 912                     pr = author.pullRequest(pr.id());
 913                     if (refreshCount++ &gt; 100) {
 914                         fail(&quot;The PR did not update after the new push&quot;);
 915                     }
 916                 } while (pr.headHash().equals(lastHeadHash));
 917 
 918                 TestBotRunner.runPeriodicItems(mlBot);
 919                 TestBotRunner.runPeriodicItems(mlBot);
 920                 listServer.processIncoming();
 921             }
 922             var updatedConversations = mailmanList.conversations(Duration.ofDays(1));
 923             assertEquals(1, updatedConversations.size());
 924             var conversation = updatedConversations.get(0);
 925             assertEquals(6, conversation.allMessages().size());
 926             assertEquals(&quot;Re: [Rev 01] RFR: This is a pull request&quot;, conversation.allMessages().get(1).subject());
 927             assertEquals(&quot;Re: [Rev 01] RFR: This is a pull request&quot;, conversation.allMessages().get(2).subject(), conversation.allMessages().get(2).toString());
 928             assertEquals(&quot;Re: [Rev 04] RFR: This is a pull request&quot;, conversation.allMessages().get(5).subject());
 929         }
 930     }
 931 
 932     @Test
 933     void rebased(TestInfo testInfo) throws IOException {
 934         try (var credentials = new HostCredentials(testInfo);
 935              var tempFolder = new TemporaryDirectory();
 936              var archiveFolder = new TemporaryDirectory();
 937              var listServer = new TestMailmanServer();
 938              var webrevServer = new TestWebrevServer()) {
 939             var author = credentials.getHostedRepository();
 940             var archive = credentials.getHostedRepository();
 941             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
 942             var censusBuilder = credentials.getCensusBuilder()
 943                                            .addAuthor(author.forge().currentUser().id());
 944             var sender = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
 945             var mlBot = new MailingListBridgeBot(sender, author, archive, &quot;master&quot;,
 946                                                  censusBuilder.build(), &quot;master&quot;,
 947                                                  listAddress, Set.of(), Set.of(),
 948                                                  listServer.getArchive(), listServer.getSMTP(),
 949                                                  archive, &quot;webrev&quot;, Path.of(&quot;test&quot;),
 950                                                  webrevServer.uri(),
 951                                                  Set.of(), Map.of(),
 952                                                  URIBuilder.base(&quot;http://issues.test/browse/&quot;).build(),
 953                                                  Map.of(), Duration.ZERO);
 954 
 955             // Populate the projects repository
 956             var reviewFile = Path.of(&quot;reviewfile.txt&quot;);
 957             var localRepo = CheckableRepository.init(tempFolder.path().resolve(&quot;first&quot;), author.repositoryType(), reviewFile);
 958             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
 959             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
 960             localRepo.push(masterHash, archive.url(), &quot;webrev&quot;, true);
 961 
 962             // Make a change with a corresponding PR
 963             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;A line&quot;, &quot;Original msg&quot;);
 964             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
 965             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
 966             pr.setBody(&quot;This is now ready&quot;);
 967 
 968             // Run an archive pass
 969             TestBotRunner.runPeriodicItems(mlBot);
 970             listServer.processIncoming();
 971 
 972             var newLocalRepo = Repository.materialize(tempFolder.path().resolve(&quot;second&quot;), author.url(), &quot;master&quot;);
 973             var newEditHash = CheckableRepository.appendAndCommit(newLocalRepo, &quot;Another line&quot;, &quot;Replaced msg&quot;);
 974             newLocalRepo.push(newEditHash, author.url(), &quot;edit&quot;, true);
 975 
 976             // Make sure that the push registered
 977             var lastHeadHash = pr.headHash();
 978             var refreshCount = 0;
 979             do {
 980                 pr = author.pullRequest(pr.id());
 981                 if (refreshCount++ &gt; 100) {
 982                     fail(&quot;The PR did not update after the new push&quot;);
 983                 }
 984             } while (pr.headHash().equals(lastHeadHash));
 985 
 986             // Run another archive pass
 987             TestBotRunner.runPeriodicItems(mlBot);
 988             listServer.processIncoming();
 989 
 990             // The archive should reference the rebased push
 991             Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);
 992             assertTrue(archiveContains(archiveFolder.path(), &quot;updated with a new target base&quot;));
 993             assertTrue(archiveContains(archiveFolder.path(), pr.id() + &quot;/webrev.01&quot;));
 994             assertFalse(archiveContains(archiveFolder.path(), &quot;Incremental&quot;));
 995             assertTrue(archiveContains(archiveFolder.path(), &quot;Patch&quot;));
 996             assertTrue(archiveContains(archiveFolder.path(), &quot;Fetch&quot;));
 997             assertTrue(archiveContains(archiveFolder.path(), &quot;Original msg&quot;));
 998             assertTrue(archiveContains(archiveFolder.path(), &quot;Replaced msg&quot;));
 999 
1000             // The webrev comment should be updated
1001             var comments = pr.comments();
1002             var webrevComments = comments.stream()
1003                                          .filter(comment -&gt; comment.author().equals(author.forge().currentUser()))
1004                                          .filter(comment -&gt; comment.body().contains(&quot;webrev&quot;))
1005                                          .filter(comment -&gt; comment.body().contains(newEditHash.hex()))
1006                                          .collect(Collectors.toList());
1007             assertEquals(1, webrevComments.size());
1008 
1009             // Check that sender address is set properly
1010             var mailmanServer = MailingListServerFactory.createMailmanServer(listServer.getArchive(), listServer.getSMTP(), Duration.ZERO);
1011             var mailmanList = mailmanServer.getList(listAddress.address());
1012             var conversations = mailmanList.conversations(Duration.ofDays(1));
1013             assertEquals(1, conversations.size());
1014             for (var newMail : conversations.get(0).allMessages()) {
1015                 assertEquals(noreplyAddress(archive), newMail.author().address());
1016                 assertEquals(listAddress, newMail.sender());
1017                 assertFalse(newMail.hasHeader(&quot;PR-Head-Hash&quot;));
1018             }
1019             assertEquals(&quot;Re: [Rev 01] RFR: This is a pull request&quot;, conversations.get(0).allMessages().get(1).subject());
1020         }
1021     }
1022 
1023     @Test
1024     void incrementalAfterRebase(TestInfo testInfo) throws IOException {
1025         try (var credentials = new HostCredentials(testInfo);
1026              var tempFolder = new TemporaryDirectory();
1027              var archiveFolder = new TemporaryDirectory();
1028              var listServer = new TestMailmanServer();
1029              var webrevServer = new TestWebrevServer()) {
1030             var author = credentials.getHostedRepository();
1031             var archive = credentials.getHostedRepository();
1032             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
1033             var censusBuilder = credentials.getCensusBuilder()
1034                                            .addAuthor(author.forge().currentUser().id());
1035             var sender = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
1036             var mlBot = new MailingListBridgeBot(sender, author, archive, &quot;archive&quot;,
1037                                                  censusBuilder.build(), &quot;master&quot;,
1038                                                  listAddress, Set.of(), Set.of(),
1039                                                  listServer.getArchive(), listServer.getSMTP(),
1040                                                  archive, &quot;webrev&quot;, Path.of(&quot;test&quot;),
1041                                                  webrevServer.uri(),
1042                                                  Set.of(), Map.of(),
1043                                                  URIBuilder.base(&quot;http://issues.test/browse/&quot;).build(),
1044                                                  Map.of(), Duration.ZERO);
1045 
1046             // Populate the projects repository
1047             var reviewFile = Path.of(&quot;reviewfile.txt&quot;);
1048             var localRepo = CheckableRepository.init(tempFolder.path().resolve(&quot;first&quot;), author.repositoryType(), reviewFile);
1049             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
1050             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
1051             localRepo.push(masterHash, archive.url(), &quot;webrev&quot;, true);
1052             localRepo.push(masterHash, archive.url(), &quot;archive&quot;, true);
1053 
1054             // Make a change with a corresponding PR
1055             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;A line&quot;, &quot;Original msg&quot;);
1056             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
1057             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
1058             pr.setBody(&quot;This is now ready&quot;);
1059 
1060             // Run an archive pass
1061             TestBotRunner.runPeriodicItems(mlBot);
1062             listServer.processIncoming();
1063 
1064             // Push more stuff to master
1065             localRepo.checkout(masterHash, true);
1066             var unrelatedFile = localRepo.root().resolve(&quot;unrelated.txt&quot;);
1067             Files.writeString(unrelatedFile, &quot;Other things happens in master&quot;);
1068             localRepo.add(unrelatedFile);
1069             var newMasterHash = localRepo.commit(&quot;Unrelated change&quot;, &quot;duke&quot;, &quot;duke@openjdk.org&quot;);
1070             localRepo.push(newMasterHash, author.url(), &quot;master&quot;);
1071 
1072             // And more stuff to the pr branch
1073             localRepo.checkout(editHash, true);
1074             CheckableRepository.appendAndCommit(localRepo, &quot;Another line&quot;, &quot;More updates&quot;);
1075 
1076             // Merge master
1077             localRepo.merge(newMasterHash);
1078             var newEditHash = localRepo.commit(&quot;Latest changes from master&quot;, &quot;duke&quot;, &quot;duke@openjdk.org&quot;);
1079             localRepo.push(newEditHash, author.url(), &quot;edit&quot;);
1080 
1081             // Make sure that the push registered
1082             var lastHeadHash = pr.headHash();
1083             var refreshCount = 0;
1084             do {
1085                 pr = author.pullRequest(pr.id());
1086                 if (refreshCount++ &gt; 100) {
1087                     fail(&quot;The PR did not update after the new push&quot;);
1088                 }
1089             } while (pr.headHash().equals(lastHeadHash));
1090 
1091             // Run another archive pass
1092             TestBotRunner.runPeriodicItems(mlBot);
1093             listServer.processIncoming();
1094 
1095             // The archive should reference the rebased push
1096             Repository.materialize(archiveFolder.path(), archive.url(), &quot;archive&quot;);
1097             assertTrue(archiveContains(archiveFolder.path(), &quot;updated with a new target base&quot;));
1098             assertTrue(archiveContains(archiveFolder.path(), &quot;excludes the unrelated changes&quot;));
1099             assertTrue(archiveContains(archiveFolder.path(), pr.id() + &quot;/webrev.01&quot;));
1100             assertTrue(archiveContains(archiveFolder.path(), pr.id() + &quot;/webrev.00-01&quot;));
1101             assertTrue(archiveContains(archiveFolder.path(), &quot;Original msg&quot;));
1102             assertTrue(archiveContains(archiveFolder.path(), &quot;More updates&quot;));
1103         }
1104     }
1105 
1106     @Test
1107     void skipAddingExistingWebrev(TestInfo testInfo) throws IOException {
1108         try (var credentials = new HostCredentials(testInfo);
1109              var tempFolder = new TemporaryDirectory();
1110              var archiveFolder = new TemporaryDirectory();
1111              var webrevFolder = new TemporaryDirectory();
1112              var listServer = new TestMailmanServer();
1113              var webrevServer = new TestWebrevServer()) {
1114             var author = credentials.getHostedRepository();
1115             var archive = credentials.getHostedRepository();
1116             var ignored = credentials.getHostedRepository();
1117             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
1118             var censusBuilder = credentials.getCensusBuilder()
1119                                            .addAuthor(author.forge().currentUser().id());
1120             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
1121             var mlBot = new MailingListBridgeBot(from, author, archive, &quot;master&quot;,
1122                                                  censusBuilder.build(), &quot;master&quot;,
1123                                                  listAddress,
1124                                                  Set.of(ignored.forge().currentUser().userName()),
1125                                                  Set.of(),
1126                                                  listServer.getArchive(), listServer.getSMTP(),
1127                                                  archive, &quot;webrev&quot;, Path.of(&quot;test&quot;),
1128                                                  webrevServer.uri(),
1129                                                  Set.of(), Map.of(),
1130                                                  URIBuilder.base(&quot;http://issues.test/browse/&quot;).build(),
1131                                                  Map.of(), Duration.ZERO);
1132 
1133             // Populate the projects repository
1134             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType());
1135             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
1136             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
1137             localRepo.push(masterHash, archive.url(), &quot;webrev&quot;, true);
1138 
1139             // Make a change with a corresponding PR
1140             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;A simple change&quot;,
1141                                                                &quot;Change msg\n\nWith several lines&quot;);
1142             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
1143             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
1144 
1145             // Flag it as ready for review
1146             pr.setBody(&quot;This should now be ready&quot;);
1147 
1148             // Run an archive pass
1149             TestBotRunner.runPeriodicItems(mlBot);
1150 
1151             // The archive should now contain an entry
1152             var archiveRepo = Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);
1153             assertTrue(archiveContains(archiveFolder.path(), editHash.abbreviate()));
1154 
1155             // And there should be a webrev comment
1156             var comments = pr.comments();
1157             var webrevComments = comments.stream()
1158                                          .filter(comment -&gt; comment.author().equals(author.forge().currentUser()))
1159                                          .filter(comment -&gt; comment.body().contains(&quot;webrev&quot;))
1160                                          .filter(comment -&gt; comment.body().contains(editHash.hex()))
1161                                          .collect(Collectors.toList());
1162             assertEquals(1, webrevComments.size());
1163             assertEquals(1, countSubstrings(webrevComments.get(0).body(), &quot;webrev.00&quot;));
1164 
1165             // Pretend the archive didn&#39;t work out
1166             archiveRepo.push(masterHash, archive.url(), &quot;master&quot;, true);
1167 
1168             // Run another archive pass
1169             TestBotRunner.runPeriodicItems(mlBot);
1170 
1171             // The webrev comment should not contain duplicate entries
1172             comments = pr.comments();
1173             webrevComments = comments.stream()
1174                                          .filter(comment -&gt; comment.author().equals(author.forge().currentUser()))
1175                                          .filter(comment -&gt; comment.body().contains(&quot;webrev&quot;))
1176                                          .filter(comment -&gt; comment.body().contains(editHash.hex()))
1177                                          .collect(Collectors.toList());
1178             assertEquals(1, webrevComments.size());
1179             assertEquals(1, countSubstrings(webrevComments.get(0).body(), &quot;webrev.00&quot;));
1180         }
1181     }
1182 
1183     @Test
1184     void notifyReviewVerdicts(TestInfo testInfo) throws IOException {
1185         try (var credentials = new HostCredentials(testInfo);
1186              var tempFolder = new TemporaryDirectory();
1187              var archiveFolder = new TemporaryDirectory();
1188              var listServer = new TestMailmanServer();
1189              var webrevServer = new TestWebrevServer()) {
1190             var author = credentials.getHostedRepository();
1191             var archive = credentials.getHostedRepository();
1192             var reviewer = credentials.getHostedRepository();
1193             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
1194             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
1195             var censusBuilder = credentials.getCensusBuilder()
1196                                            .addReviewer(reviewer.forge().currentUser().id())
1197                                            .addAuthor(author.forge().currentUser().id());
1198             var mlBot = new MailingListBridgeBot(from, author, archive, &quot;master&quot;,
1199                                                  censusBuilder.build(), &quot;master&quot;,
1200                                                  listAddress, Set.of(), Set.of(),
1201                                                  listServer.getArchive(), listServer.getSMTP(),
1202                                                  archive, &quot;webrev&quot;, Path.of(&quot;test&quot;),
1203                                                  webrevServer.uri(),
1204                                                  Set.of(), Map.of(),
1205                                                  URIBuilder.base(&quot;http://issues.test/browse/&quot;).build(),
1206                                                  Map.of(), Duration.ZERO);
1207 
1208             // Populate the projects repository
1209             var reviewFile = Path.of(&quot;reviewfile.txt&quot;);
1210             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType(), reviewFile);
1211             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
1212             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
1213             localRepo.push(masterHash, archive.url(), &quot;webrev&quot;, true);
1214 
1215             // Make a change with a corresponding PR
1216             var editHash = CheckableRepository.appendAndCommit(localRepo);
1217             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
1218             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
1219             pr.setBody(&quot;This is now ready&quot;);
1220 
1221             // Run an archive pass
1222             TestBotRunner.runPeriodicItems(mlBot);
1223 
1224             // First unapprove it
1225             var reviewedPr = reviewer.pullRequest(pr.id());
1226             reviewedPr.addReview(Review.Verdict.DISAPPROVED, &quot;Reason 1&quot;);
1227             TestBotRunner.runPeriodicItems(mlBot);
1228             TestBotRunner.runPeriodicItems(mlBot);
1229             TestBotRunner.runPeriodicItems(mlBot);
1230 
1231             // The archive should contain a note
1232             Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);
1233             assertEquals(1, archiveContainsCount(archiveFolder.path(), &quot;Changes requested by &quot;));
1234             assertEquals(1, archiveContainsCount(archiveFolder.path(), &quot; by integrationreviewer1&quot;));
1235             if (author.forge().supportsReviewBody()) {
1236                 assertEquals(1, archiveContainsCount(archiveFolder.path(), &quot;Reason 1&quot;));
1237             }
1238 
1239             // Then approve it
1240             reviewedPr.addReview(Review.Verdict.APPROVED, &quot;Reason 2&quot;);
1241             TestBotRunner.runPeriodicItems(mlBot);
1242             TestBotRunner.runPeriodicItems(mlBot);
1243             TestBotRunner.runPeriodicItems(mlBot);
1244 
1245             // The archive should contain another note
1246             Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);
1247             assertEquals(1, archiveContainsCount(archiveFolder.path(), &quot;Marked as reviewed by &quot;));
1248             if (author.forge().supportsReviewBody()) {
1249                 assertEquals(1, archiveContainsCount(archiveFolder.path(), &quot;Reason 2&quot;));
1250             }
1251             assertEquals(2, archiveContainsCount(archiveFolder.path(), &quot;Re: RFR:&quot;));
1252 
1253             // Yet another change
1254             reviewedPr.addReview(Review.Verdict.DISAPPROVED, &quot;Reason 3&quot;);
1255             TestBotRunner.runPeriodicItems(mlBot);
1256             TestBotRunner.runPeriodicItems(mlBot);
1257             TestBotRunner.runPeriodicItems(mlBot);
1258 
1259             // The archive should contain another note
1260             Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);
1261             assertEquals(2, archiveContainsCount(archiveFolder.path(), &quot;Changes requested by &quot;));
1262             if (author.forge().supportsReviewBody()) {
1263                 assertEquals(1, archiveContainsCount(archiveFolder.path(), &quot;Reason 3&quot;));
1264             }
1265         }
1266     }
1267 
1268     @Test
1269     void ignoreComments(TestInfo testInfo) throws IOException {
1270         try (var credentials = new HostCredentials(testInfo);
1271              var tempFolder = new TemporaryDirectory();
1272              var archiveFolder = new TemporaryDirectory();
1273              var listServer = new TestMailmanServer();
1274              var webrevServer = new TestWebrevServer()) {
1275             var author = credentials.getHostedRepository();
1276             var ignored = credentials.getHostedRepository();
1277             var archive = credentials.getHostedRepository();
1278             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
1279             var censusBuilder = credentials.getCensusBuilder()
1280                                            .addAuthor(author.forge().currentUser().id());
1281             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
1282             var mlBot = new MailingListBridgeBot(from, author, archive, &quot;master&quot;,
1283                                                  censusBuilder.build(), &quot;master&quot;,
1284                                                  listAddress,
1285                                                  Set.of(ignored.forge().currentUser().userName()),
1286                                                  Set.of(Pattern.compile(&quot;ignore this comment&quot;, Pattern.MULTILINE | Pattern.DOTALL)),
1287                                                  listServer.getArchive(), listServer.getSMTP(),
1288                                                  archive, &quot;webrev&quot;, Path.of(&quot;test&quot;),
1289                                                  webrevServer.uri(),
1290                                                  Set.of(), Map.of(),
1291                                                  URIBuilder.base(&quot;http://issues.test/browse/&quot;).build(),
1292                                                  Map.of(), Duration.ZERO);
1293 
1294             // Populate the projects repository
1295             var reviewFile = Path.of(&quot;reviewfile.txt&quot;);
1296             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType(), reviewFile);
1297             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
1298             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
1299             localRepo.push(masterHash, archive.url(), &quot;webrev&quot;, true);
1300 
1301             // Make a change with a corresponding PR
1302             var editHash = CheckableRepository.appendAndCommit(localRepo);
1303             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
1304             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
1305             pr.setBody(&quot;This is now ready&quot;);
1306 
1307             // Make a bunch of comments
1308             pr.addComment(&quot;Plain comment&quot;);
1309             pr.addComment(&quot;ignore this comment&quot;);
1310             pr.addComment(&quot;I think it is time to\nignore this comment!&quot;);
1311             pr.addReviewComment(masterHash, editHash, reviewFile.toString(), 2, &quot;Review ignore this comment&quot;);
1312 
1313             var ignoredPR = ignored.pullRequest(pr.id());
1314             ignoredPR.addComment(&quot;Don&#39;t mind me&quot;);
1315 
1316             TestBotRunner.runPeriodicItems(mlBot);
1317             TestBotRunner.runPeriodicItems(mlBot);
1318 
1319             // The archive should not contain the ignored comments
1320             Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);
1321             assertTrue(archiveContains(archiveFolder.path(), &quot;This is now ready&quot;));
1322             assertFalse(archiveContains(archiveFolder.path(), &quot;ignore this comment&quot;));
1323             assertFalse(archiveContains(archiveFolder.path(), &quot;it is time to&quot;));
1324             assertFalse(archiveContains(archiveFolder.path(), &quot;Don&#39;t mind me&quot;));
1325             assertFalse(archiveContains(archiveFolder.path(), &quot;Review ignore&quot;));
1326         }
1327     }
1328 
1329     @Test
1330     void replyToEmptyReview(TestInfo testInfo) throws IOException {
1331         try (var credentials = new HostCredentials(testInfo);
1332              var tempFolder = new TemporaryDirectory();
1333              var archiveFolder = new TemporaryDirectory();
1334              var listServer = new TestMailmanServer();
1335              var webrevServer = new TestWebrevServer()) {
1336             var author = credentials.getHostedRepository();
1337             var reviewer = credentials.getHostedRepository();
1338             var archive = credentials.getHostedRepository();
1339             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
1340             var censusBuilder = credentials.getCensusBuilder()
1341                                            .addReviewer(reviewer.forge().currentUser().id())
1342                                            .addAuthor(author.forge().currentUser().id());
1343             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
1344             var mlBot = new MailingListBridgeBot(from, author, archive, &quot;master&quot;, censusBuilder.build(), &quot;master&quot;,
1345                                                  listAddress, Set.of(), Set.of(),
1346                                                  listServer.getArchive(),
1347                                                  listServer.getSMTP(),
1348                                                  archive, &quot;webrev&quot;, Path.of(&quot;test&quot;),
1349                                                  webrevServer.uri(),
1350                                                  Set.of(), Map.of(),
1351                                                  URIBuilder.base(&quot;http://issues.test/browse/&quot;).build(),
1352                                                  Map.of(), Duration.ZERO);
1353 
1354             // Populate the projects repository
1355             var reviewFile = Path.of(&quot;reviewfile.txt&quot;);
1356             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType(), reviewFile);
1357             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
1358             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
1359             localRepo.push(masterHash, archive.url(), &quot;webrev&quot;, true);
1360 
1361             // Make a change with a corresponding PR
1362             var editHash = CheckableRepository.appendAndCommit(localRepo);
1363             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
1364             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
1365             pr.setBody(&quot;This is now ready&quot;);
1366             TestBotRunner.runPeriodicItems(mlBot);
1367             listServer.processIncoming();
1368 
1369             // Make an empty approval
1370             var reviewPr = reviewer.pullRequest(pr.id());
1371             reviewPr.addReview(Review.Verdict.APPROVED, &quot;&quot;);
1372             TestBotRunner.runPeriodicItems(mlBot);
1373             listServer.processIncoming();
1374 
1375             pr.addComment(&quot;Thanks for the review!&quot;);
1376             TestBotRunner.runPeriodicItems(mlBot);
1377             listServer.processIncoming();
1378 
1379             // The approval text should be included in the quote
1380             Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);
1381             assertEquals(1, archiveContainsCount(archiveFolder.path(), &quot;^&gt; Marked as reviewed&quot;));
1382         }
1383     }
1384 }
    </pre>
  </body>
</html>