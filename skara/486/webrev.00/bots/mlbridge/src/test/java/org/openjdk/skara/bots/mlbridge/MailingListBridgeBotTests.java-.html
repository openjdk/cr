<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Old bots/mlbridge/src/test/java/org/openjdk/skara/bots/mlbridge/MailingListBridgeBotTests.java</title>
    <link rel="stylesheet" href="../../../../../../../../../../style.css" />
  </head>
  <body>
    <pre>
   1 /*
   2  * Copyright (c) 2019, Oracle and/or its affiliates. All rights reserved.
   3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   4  *
   5  * This code is free software; you can redistribute it and/or modify it
   6  * under the terms of the GNU General Public License version 2 only, as
   7  * published by the Free Software Foundation.
   8  *
   9  * This code is distributed in the hope that it will be useful, but WITHOUT
  10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
  11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
  12  * version 2 for more details (a copy is included in the LICENSE file that
  13  * accompanied this code).
  14  *
  15  * You should have received a copy of the GNU General Public License version
  16  * 2 along with this work; if not, write to the Free Software Foundation,
  17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
  18  *
  19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
  20  * or visit www.oracle.com if you need additional information or have any
  21  * questions.
  22  */
  23 package org.openjdk.skara.bots.mlbridge;
  24 
  25 import org.openjdk.skara.email.EmailAddress;
  26 import org.openjdk.skara.forge.*;
  27 import org.openjdk.skara.network.URIBuilder;
  28 import org.openjdk.skara.mailinglist.MailingListServerFactory;
  29 import org.openjdk.skara.test.*;
  30 import org.openjdk.skara.vcs.Repository;
  31 
  32 import org.junit.jupiter.api.*;
  33 
  34 import java.io.IOException;
  35 import java.nio.charset.StandardCharsets;
  36 import java.nio.file.*;
  37 import java.time.*;
  38 import java.util.*;
  39 import java.util.logging.Logger;
  40 import java.util.regex.Pattern;
  41 import java.util.stream.Collectors;
  42 
  43 import static org.junit.jupiter.api.Assertions.*;
  44 
  45 class MailingListBridgeBotTests {
  46     private final Logger log = Logger.getLogger(&quot;org.openjdk.skara.bots.mlbridge.test&quot;);
  47 
  48     private Optional&lt;String&gt; archiveContents(Path archive) {
  49         try {
  50             var mbox = Files.find(archive, 50, (path, attrs) -&gt; path.toString().endsWith(&quot;.mbox&quot;)).findAny();
  51             if (mbox.isEmpty()) {
  52                 return Optional.empty();
  53             }
  54             return Optional.of(Files.readString(mbox.get(), StandardCharsets.UTF_8));
  55         } catch (IOException e) {
  56             return Optional.empty();
  57         }
  58 
  59     }
  60 
  61     private boolean archiveContains(Path archive, String text) {
  62         return archiveContainsCount(archive, text) &gt; 0;
  63     }
  64 
  65     private int archiveContainsCount(Path archive, String text) {
  66         var lines = archiveContents(archive);
  67         if (lines.isEmpty()) {
  68             return 0;
  69         }
  70         var pattern = Pattern.compile(text);
  71         int count = 0;
  72         for (var line : lines.get().split(&quot;\\R&quot;)) {
  73             var matcher = pattern.matcher(line);
  74             if (matcher.find()) {
  75                 count++;
  76             }
  77         }
  78         return count;
  79     }
  80 
  81     private boolean webrevContains(Path webrev, String text) {
  82         try {
  83             var index = Files.find(webrev, 5, (path, attrs) -&gt; path.toString().endsWith(&quot;index.html&quot;)).findAny();
  84             if (index.isEmpty()) {
  85                 return false;
  86             }
  87             var lines = Files.readString(index.get(), StandardCharsets.UTF_8);
  88             return lines.contains(text);
  89         } catch (IOException e) {
  90             return false;
  91         }
  92     }
  93 
  94     private long countSubstrings(String string, String substring) {
  95         return Pattern.compile(substring).matcher(string).results().count();
  96     }
  97 
  98     private String noreplyAddress(HostedRepository repository) {
  99         return &quot;test+&quot; + repository.forge().currentUser().id() + &quot;+&quot; +
 100                 repository.forge().currentUser().userName() +
 101                 &quot;@openjdk.java.net&quot;;
 102     }
 103 
 104     @Test
 105     void simpleArchive(TestInfo testInfo) throws IOException {
 106         try (var credentials = new HostCredentials(testInfo);
 107              var tempFolder = new TemporaryDirectory();
 108              var archiveFolder = new TemporaryDirectory();
 109              var webrevFolder = new TemporaryDirectory();
 110              var listServer = new TestMailmanServer();
 111              var webrevServer = new TestWebrevServer()) {
 112             var author = credentials.getHostedRepository();
 113             var archive = credentials.getHostedRepository();
 114             var ignored = credentials.getHostedRepository();
 115             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
 116             var censusBuilder = credentials.getCensusBuilder()
 117                                            .addAuthor(author.forge().currentUser().id());
 118             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
 119             var mlBot = MailingListBridgeBot.newBuilder()
 120                                             .from(from)
 121                                             .repo(author)
 122                                             .archive(archive)
 123                                             .censusRepo(censusBuilder.build())
 124                                             .list(listAddress)
 125                                             .ignoredUsers(Set.of(ignored.forge().currentUser().userName()))
 126                                             .ignoredComments(Set.of())
 127                                             .listArchive(listServer.getArchive())
 128                                             .smtpServer(listServer.getSMTP())
 129                                             .webrevStorageRepository(archive)
 130                                             .webrevStorageRef(&quot;webrev&quot;)
 131                                             .webrevStorageBase(Path.of(&quot;test&quot;))
 132                                             .webrevStorageBaseUri(webrevServer.uri())
 133                                             .readyLabels(Set.of(&quot;rfr&quot;))
 134                                             .readyComments(Map.of(ignored.forge().currentUser().userName(), Pattern.compile(&quot;ready&quot;)))
 135                                             .issueTracker(URIBuilder.base(&quot;http://issues.test/browse/&quot;).build())
 136                                             .headers(Map.of(&quot;Extra1&quot;, &quot;val1&quot;, &quot;Extra2&quot;, &quot;val2&quot;))
 137                                             .sendInterval(Duration.ZERO)
 138                                             .build();
 139 
 140             // Populate the projects repository
 141             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType());
 142             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
 143             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
 144             localRepo.push(masterHash, archive.url(), &quot;webrev&quot;, true);
 145 
 146             // Make a change with a corresponding PR
 147             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;A simple change&quot;,
 148                                                                &quot;Change msg\n\nWith several lines&quot;);
 149             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
 150             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;1234: This is a pull request&quot;);
 151             pr.setBody(&quot;This should not be ready&quot;);
 152 
 153             // Run an archive pass
 154             TestBotRunner.runPeriodicItems(mlBot);
 155 
 156             // A PR that isn&#39;t ready for review should not be archived
 157             Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);
 158             assertFalse(archiveContains(archiveFolder.path(), &quot;This is a pull request&quot;));
 159 
 160             // Flag it as ready for review
 161             pr.setBody(&quot;This should now be ready&quot;);
 162             pr.addLabel(&quot;rfr&quot;);
 163 
 164             // Run another archive pass
 165             TestBotRunner.runPeriodicItems(mlBot);
 166 
 167             // But it should still not be archived
 168             Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);
 169             assertFalse(archiveContains(archiveFolder.path(), &quot;This is a pull request&quot;));
 170 
 171             // Now post a general comment - not a ready marker
 172             var ignoredPr = ignored.pullRequest(pr.id());
 173             ignoredPr.addComment(&quot;hello there&quot;);
 174 
 175             // Run another archive pass
 176             TestBotRunner.runPeriodicItems(mlBot);
 177 
 178             // It should still not be archived
 179             Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);
 180             assertFalse(archiveContains(archiveFolder.path(), &quot;This is a pull request&quot;));
 181 
 182             // Now post a ready comment
 183             ignoredPr.addComment(&quot;ready&quot;);
 184 
 185             // Run another archive pass
 186             TestBotRunner.runPeriodicItems(mlBot);
 187 
 188             // The archive should now contain an entry
 189             Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);
 190             assertTrue(archiveContains(archiveFolder.path(), &quot;This is a pull request&quot;));
 191             assertTrue(archiveContains(archiveFolder.path(), &quot;This should now be ready&quot;));
 192             assertTrue(archiveContains(archiveFolder.path(), &quot;Patch:&quot;));
 193             assertTrue(archiveContains(archiveFolder.path(), &quot;Changes:&quot;));
 194             assertTrue(archiveContains(archiveFolder.path(), &quot;Webrev:&quot;));
 195             assertTrue(archiveContains(archiveFolder.path(), webrevServer.uri().toString()));
 196             assertTrue(archiveContains(archiveFolder.path(), &quot;webrev.00&quot;));
 197             assertTrue(archiveContains(archiveFolder.path(), &quot;Issue:&quot;));
 198             assertTrue(archiveContains(archiveFolder.path(), &quot;http://issues.test/browse/TSTPRJ-1234&quot;));
 199             assertTrue(archiveContains(archiveFolder.path(), &quot;Fetch:&quot;));
 200             assertTrue(archiveContains(archiveFolder.path(), &quot;^ - &quot; + editHash.abbreviate() + &quot;: Change msg&quot;));
 201             assertFalse(archiveContains(archiveFolder.path(), &quot;With several lines&quot;));
 202 
 203             // The mailing list as well
 204             listServer.processIncoming();
 205             var mailmanServer = MailingListServerFactory.createMailmanServer(listServer.getArchive(), listServer.getSMTP(), Duration.ZERO);
 206             var mailmanList = mailmanServer.getList(listAddress.address());
 207             var conversations = mailmanList.conversations(Duration.ofDays(1));
 208             assertEquals(1, conversations.size());
 209             var mail = conversations.get(0).first();
 210             assertEquals(&quot;RFR: 1234: This is a pull request&quot;, mail.subject());
 211             assertEquals(pr.author().fullName(), mail.author().fullName().orElseThrow());
 212             assertEquals(noreplyAddress(archive), mail.author().address());
 213             assertEquals(listAddress, mail.sender());
 214             assertEquals(&quot;val1&quot;, mail.headerValue(&quot;Extra1&quot;));
 215             assertEquals(&quot;val2&quot;, mail.headerValue(&quot;Extra2&quot;));
 216 
 217             // And there should be a webrev
 218             Repository.materialize(webrevFolder.path(), archive.url(), &quot;webrev&quot;);
 219             assertTrue(webrevContains(webrevFolder.path(), &quot;1 lines changed&quot;));
 220             var comments = pr.comments();
 221             var webrevComments = comments.stream()
 222                                          .filter(comment -&gt; comment.author().equals(author.forge().currentUser()))
 223                                          .filter(comment -&gt; comment.body().contains(&quot;webrev&quot;))
 224                                          .filter(comment -&gt; comment.body().contains(editHash.hex()))
 225                                          .collect(Collectors.toList());
 226             assertEquals(1, webrevComments.size());
 227 
 228             // Add a comment
 229             pr.addComment(&quot;This is a comment :smile:&quot;);
 230 
 231             // Add a comment from an ignored user as well
 232             ignoredPr.addComment(&quot;Don&#39;t mind me&quot;);
 233 
 234             // Run another archive pass
 235             TestBotRunner.runPeriodicItems(mlBot);
 236 
 237             // The archive should now contain the comment, but not the ignored one
 238             Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);
 239             assertTrue(archiveContains(archiveFolder.path(), &quot;This is a comment&quot;));
 240             assertTrue(archiveContains(archiveFolder.path(), &quot;&gt; This should now be ready&quot;));
 241             assertFalse(archiveContains(archiveFolder.path(), &quot;Don&#39;t mind me&quot;));
 242 
 243             listServer.processIncoming();
 244             conversations = mailmanList.conversations(Duration.ofDays(1));
 245             assertEquals(1, conversations.size());
 246             assertEquals(2, conversations.get(0).allMessages().size());
 247 
 248             // Remove the rfr flag and post another comment
 249             pr.addLabel(&quot;rfr&quot;);
 250             pr.addComment(&quot;This is another comment&quot;);
 251 
 252             // Run another archive pass
 253             TestBotRunner.runPeriodicItems(mlBot);
 254 
 255             // The archive should contain the additional comment
 256             Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);
 257             assertTrue(archiveContains(archiveFolder.path(), &quot;This is another comment&quot;));
 258             assertTrue(archiveContains(archiveFolder.path(), &quot;&gt;&gt; This should now be ready&quot;));
 259 
 260             listServer.processIncoming();
 261             conversations = mailmanList.conversations(Duration.ofDays(1));
 262             assertEquals(1, conversations.size());
 263             assertEquals(3, conversations.get(0).allMessages().size());
 264             for (var newMail : conversations.get(0).allMessages()) {
 265                 assertEquals(noreplyAddress(archive), newMail.author().address());
 266                 assertEquals(listAddress, newMail.sender());
 267             }
 268             assertTrue(conversations.get(0).allMessages().get(2).body().contains(&quot;This is a comment ðŸ˜„&quot;));
 269         }
 270     }
 271 
 272     @Test
 273     void reviewComment(TestInfo testInfo) throws IOException {
 274         try (var credentials = new HostCredentials(testInfo);
 275              var tempFolder = new TemporaryDirectory();
 276              var archiveFolder = new TemporaryDirectory();
 277              var listServer = new TestMailmanServer();
 278              var webrevServer = new TestWebrevServer()) {
 279             var author = credentials.getHostedRepository();
 280             var archive = credentials.getHostedRepository();
 281             var ignored = credentials.getHostedRepository();
 282             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
 283             var censusBuilder = credentials.getCensusBuilder()
 284                                            .addAuthor(author.forge().currentUser().id());
 285             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
 286             var mlBot = MailingListBridgeBot.newBuilder()
 287                                             .from(from)
 288                                             .repo(author)
 289                                             .archive(archive)
 290                                             .censusRepo(censusBuilder.build())
 291                                             .list(listAddress)
 292                                             .ignoredUsers(Set.of(ignored.forge().currentUser().userName()))
 293                                             .listArchive(listServer.getArchive())
 294                                             .smtpServer(listServer.getSMTP())
 295                                             .webrevStorageRepository(archive)
 296                                             .webrevStorageRef(&quot;webrev&quot;)
 297                                             .webrevStorageBase(Path.of(&quot;test&quot;))
 298                                             .webrevStorageBaseUri(webrevServer.uri())
 299                                             .issueTracker(URIBuilder.base(&quot;http://issues.test/browse/&quot;).build())
 300                                             .build();
 301 
 302             // Populate the projects repository
 303             var reviewFile = Path.of(&quot;reviewfile.txt&quot;);
 304             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType(), reviewFile);
 305             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
 306             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
 307             localRepo.push(masterHash, archive.url(), &quot;webrev&quot;, true);
 308 
 309             // Make a change with a corresponding PR
 310             var editHash = CheckableRepository.appendAndCommit(localRepo);
 311             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
 312             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
 313             pr.setBody(&quot;This is now ready&quot;);
 314             TestBotRunner.runPeriodicItems(mlBot);
 315             listServer.processIncoming();
 316 
 317             // And make a file specific comment
 318             var currentMaster = localRepo.resolve(&quot;master&quot;).orElseThrow();
 319             var comment = pr.addReviewComment(masterHash, editHash, reviewFile.toString(), 2, &quot;Review comment&quot;);
 320 
 321             // Add one from an ignored user as well
 322             var ignoredPr = ignored.pullRequest(pr.id());
 323             ignoredPr.addReviewComment(masterHash, editHash, reviewFile.toString(), 2, &quot;Don&#39;t mind me&quot;);
 324 
 325             // Process comments
 326             TestBotRunner.runPeriodicItems(mlBot);
 327             listServer.processIncoming();
 328 
 329             // The archive should now contain an entry
 330             Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);
 331             assertTrue(archiveContains(archiveFolder.path(), &quot;This is a pull request&quot;));
 332             assertTrue(archiveContains(archiveFolder.path(), &quot;This is now ready&quot;));
 333             assertTrue(archiveContains(archiveFolder.path(), &quot;Review comment&quot;));
 334             assertTrue(archiveContains(archiveFolder.path(), &quot;&gt; This is now ready&quot;));
 335             assertTrue(archiveContains(archiveFolder.path(), reviewFile.toString()));
 336             assertFalse(archiveContains(archiveFolder.path(), &quot;Don&#39;t mind me&quot;));
 337 
 338             // The mailing list as well
 339             var mailmanServer = MailingListServerFactory.createMailmanServer(listServer.getArchive(), listServer.getSMTP(), Duration.ZERO);
 340             var mailmanList = mailmanServer.getList(listAddress.address());
 341             var conversations = mailmanList.conversations(Duration.ofDays(1));
 342             assertEquals(1, conversations.size());
 343             var mail = conversations.get(0).first();
 344             assertEquals(&quot;RFR: This is a pull request&quot;, mail.subject());
 345 
 346             // Comment on the comment
 347             pr.addReviewCommentReply(comment, &quot;This is a review reply&quot;);
 348             TestBotRunner.runPeriodicItems(mlBot);
 349             listServer.processIncoming();
 350 
 351             // The archive should contain the additional comment (but no quoted footers)
 352             Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);
 353             assertTrue(archiveContains(archiveFolder.path(), &quot;This is a review reply&quot;));
 354             assertTrue(archiveContains(archiveFolder.path(), &quot;&gt;&gt; This is now ready&quot;));
 355             assertFalse(archiveContains(archiveFolder.path(), &quot;^&gt; PR:&quot;));
 356 
 357             // As well as the mailing list
 358             conversations = mailmanList.conversations(Duration.ofDays(1));
 359             assertEquals(1, conversations.size());
 360             assertEquals(3, conversations.get(0).allMessages().size());
 361             for (var newMail : conversations.get(0).allMessages()) {
 362                 assertEquals(noreplyAddress(archive), newMail.author().address());
 363                 assertEquals(listAddress, newMail.sender());
 364             }
 365         }
 366     }
 367 
 368     @Test
 369     void combineComments(TestInfo testInfo) throws IOException {
 370         try (var credentials = new HostCredentials(testInfo);
 371              var tempFolder = new TemporaryDirectory();
 372              var archiveFolder = new TemporaryDirectory();
 373              var listServer = new TestMailmanServer();
 374              var webrevServer = new TestWebrevServer()) {
 375             var author = credentials.getHostedRepository();
 376             var archive = credentials.getHostedRepository();
 377             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
 378             var censusBuilder = credentials.getCensusBuilder()
 379                                            .addAuthor(author.forge().currentUser().id());
 380             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
 381             var mlBot = MailingListBridgeBot.newBuilder()
 382                                             .from(from)
 383                                             .repo(author)
 384                                             .archive(archive)
 385                                             .censusRepo(censusBuilder.build())
 386                                             .list(listAddress)
 387                                             .listArchive(listServer.getArchive())
 388                                             .smtpServer(listServer.getSMTP())
 389                                             .webrevStorageRepository(archive)
 390                                             .webrevStorageRef(&quot;webrev&quot;)
 391                                             .webrevStorageBase(Path.of(&quot;test&quot;))
 392                                             .webrevStorageBaseUri(webrevServer.uri())
 393                                             .issueTracker(URIBuilder.base(&quot;http://issues.test/browse/&quot;).build())
 394                                             .build();
 395 
 396             // Populate the projects repository
 397             var reviewFile = Path.of(&quot;reviewfile.txt&quot;);
 398             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType(), reviewFile);
 399             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
 400             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
 401             localRepo.push(masterHash, archive.url(), &quot;webrev&quot;, true);
 402 
 403             // Make a change with a corresponding PR
 404             var editHash = CheckableRepository.appendAndCommit(localRepo);
 405             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
 406             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
 407             pr.setBody(&quot;This is now ready&quot;);
 408             pr.addComment(&quot;Avoid combining&quot;);
 409 
 410             TestBotRunner.runPeriodicItems(mlBot);
 411             listServer.processIncoming();
 412             listServer.processIncoming();
 413 
 414             // Make several file specific comments
 415             var first = pr.addReviewComment(masterHash, editHash, reviewFile.toString(), 2, &quot;Review comment&quot;);
 416             var second = pr.addReviewComment(masterHash, editHash, reviewFile.toString(), 2, &quot;Another review comment&quot;);
 417             pr.addReviewComment(masterHash, editHash, reviewFile.toString(), 2, &quot;Further review comment&quot;);
 418             pr.addReviewComment(masterHash, editHash, reviewFile.toString(), 2, &quot;Final review comment&quot;);
 419             TestBotRunner.runPeriodicItems(mlBot);
 420             listServer.processIncoming();
 421 
 422             // The archive should contain a combined entry
 423             Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);
 424             assertEquals(2, archiveContainsCount(archiveFolder.path(), &quot;^On.*wrote:&quot;));
 425 
 426             // As well as the mailing list
 427             var mailmanServer = MailingListServerFactory.createMailmanServer(listServer.getArchive(), listServer.getSMTP(), Duration.ZERO);
 428             var mailmanList = mailmanServer.getList(listAddress.address());
 429             var conversations = mailmanList.conversations(Duration.ofDays(1));
 430             assertEquals(1, conversations.size());
 431             var mail = conversations.get(0).first();
 432             assertEquals(&quot;RFR: This is a pull request&quot;, mail.subject());
 433             assertEquals(3, conversations.get(0).allMessages().size());
 434 
 435             var commentReply = conversations.get(0).replies(mail).get(0);
 436             assertEquals(2, commentReply.body().split(&quot;^On.*wrote:&quot;).length);
 437             assertTrue(commentReply.body().contains(&quot;Avoid combining\n\n&quot;), commentReply.body());
 438 
 439             var reviewReply = conversations.get(0).replies(mail).get(1);
 440             assertEquals(2, reviewReply.body().split(&quot;^On.*wrote:&quot;).length);
 441             assertEquals(2, reviewReply.body().split(&quot;&gt; This is now ready&quot;).length, reviewReply.body());
 442             assertEquals(&quot;RFR: This is a pull request&quot;, reviewReply.subject());
 443             assertTrue(reviewReply.body().contains(&quot;Review comment\n\n&quot;), reviewReply.body());
 444             assertTrue(reviewReply.body().contains(&quot;Another review comment&quot;), reviewReply.body());
 445 
 446             // Now reply to the first and second (collapsed) comment
 447             pr.addReviewCommentReply(first, &quot;I agree&quot;);
 448             pr.addReviewCommentReply(second, &quot;Not with this one though&quot;);
 449             TestBotRunner.runPeriodicItems(mlBot);
 450             listServer.processIncoming();
 451 
 452             // The archive should contain a new entry
 453             Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);
 454             assertEquals(3, archiveContainsCount(archiveFolder.path(), &quot;^On.*wrote:&quot;));
 455 
 456             // The combined review comments should only appear unquoted once
 457             assertEquals(1, archiveContainsCount(archiveFolder.path(), &quot;^Another review comment&quot;));
 458         }
 459     }
 460 
 461     @Test
 462     void commentThreading(TestInfo testInfo) throws IOException {
 463         try (var credentials = new HostCredentials(testInfo);
 464              var tempFolder = new TemporaryDirectory();
 465              var archiveFolder = new TemporaryDirectory();
 466              var listServer = new TestMailmanServer();
 467              var webrevServer = new TestWebrevServer()) {
 468             var author = credentials.getHostedRepository();
 469             var reviewer = credentials.getHostedRepository();
 470             var archive = credentials.getHostedRepository();
 471             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
 472             var censusBuilder = credentials.getCensusBuilder()
 473                                            .addReviewer(reviewer.forge().currentUser().id())
 474                                            .addAuthor(author.forge().currentUser().id());
 475             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
 476             var mlBot = MailingListBridgeBot.newBuilder()
 477                                             .from(from)
 478                                             .repo(author)
 479                                             .archive(archive)
 480                                             .censusRepo(censusBuilder.build())
 481                                             .list(listAddress)
 482                                             .listArchive(listServer.getArchive())
 483                                             .smtpServer(listServer.getSMTP())
 484                                             .webrevStorageRepository(archive)
 485                                             .webrevStorageRef(&quot;webrev&quot;)
 486                                             .webrevStorageBase(Path.of(&quot;test&quot;))
 487                                             .webrevStorageBaseUri(webrevServer.uri())
 488                                             .issueTracker(URIBuilder.base(&quot;http://issues.test/browse/&quot;).build())
 489                                             .build();
 490 
 491             // Populate the projects repository
 492             var reviewFile = Path.of(&quot;reviewfile.txt&quot;);
 493             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType(), reviewFile);
 494             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
 495             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
 496             localRepo.push(masterHash, archive.url(), &quot;webrev&quot;, true);
 497 
 498             // Make a change with a corresponding PR
 499             var editHash = CheckableRepository.appendAndCommit(localRepo);
 500             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
 501             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
 502             pr.setBody(&quot;This is now ready&quot;);
 503             TestBotRunner.runPeriodicItems(mlBot);
 504             listServer.processIncoming();
 505 
 506             // Make a file specific comment
 507             var reviewPr = reviewer.pullRequest(pr.id());
 508             var comment1 = reviewPr.addReviewComment(masterHash, editHash, reviewFile.toString(), 2, &quot;Review comment&quot;);
 509             pr.addReviewCommentReply(comment1, &quot;I agree&quot;);
 510             reviewPr.addReviewCommentReply(comment1, &quot;Great&quot;);
 511             TestBotRunner.runPeriodicItems(mlBot);
 512             listServer.processIncoming();
 513             listServer.processIncoming();
 514             listServer.processIncoming();
 515 
 516             // And a second one by ourselves
 517             var comment2 = pr.addReviewComment(masterHash, editHash, reviewFile.toString(), 2, &quot;Another review comment&quot;);
 518             reviewPr.addReviewCommentReply(comment2, &quot;Sounds good&quot;);
 519             pr.addReviewCommentReply(comment2, &quot;Thanks&quot;);
 520             TestBotRunner.runPeriodicItems(mlBot);
 521             listServer.processIncoming();
 522             listServer.processIncoming();
 523             listServer.processIncoming();
 524 
 525             // Finally some approvals and another comment
 526             pr.addReview(Review.Verdict.APPROVED, &quot;Nice&quot;);
 527             reviewPr.addReviewComment(masterHash, editHash, reviewFile.toString(), 2, &quot;The final review comment&quot;);
 528             reviewPr.addReview(Review.Verdict.APPROVED, &quot;Looks fine&quot;);
 529             reviewPr.addReviewCommentReply(comment2, &quot;You are welcome&quot;);
 530             TestBotRunner.runPeriodicItems(mlBot);
 531             listServer.processIncoming();
 532             listServer.processIncoming();
 533             listServer.processIncoming();
 534 
 535             // Sanity check the archive
 536             Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);
 537             assertEquals(9, archiveContainsCount(archiveFolder.path(), &quot;^On.*wrote:&quot;));
 538 
 539             // File specific comments should appear after the approval
 540             var archiveText = archiveContents(archiveFolder.path()).orElseThrow();
 541             assertTrue(archiveText.indexOf(&quot;Looks fine&quot;) &lt; archiveText.indexOf(&quot;The final review comment&quot;));
 542 
 543             // Check the mailing list
 544             var mailmanServer = MailingListServerFactory.createMailmanServer(listServer.getArchive(), listServer.getSMTP(), Duration.ZERO);
 545             var mailmanList = mailmanServer.getList(listAddress.address());
 546             var conversations = mailmanList.conversations(Duration.ofDays(1));
 547             assertEquals(1, conversations.size());
 548             var mail = conversations.get(0).first();
 549             assertEquals(&quot;RFR: This is a pull request&quot;, mail.subject());
 550             assertEquals(10, conversations.get(0).allMessages().size());
 551 
 552             // There should be four separate threads
 553             var thread1 = conversations.get(0).replies(mail).get(0);
 554             assertEquals(2, thread1.body().split(&quot;^On.*wrote:&quot;).length);
 555             assertEquals(2, thread1.body().split(&quot;&gt; This is now ready&quot;).length, thread1.body());
 556             assertEquals(&quot;RFR: This is a pull request&quot;, thread1.subject());
 557             assertTrue(thread1.body().contains(&quot;Review comment\n\n&quot;), thread1.body());
 558             assertFalse(thread1.body().contains(&quot;Another review comment&quot;), thread1.body());
 559             var thread1reply1 = conversations.get(0).replies(thread1).get(0);
 560             assertTrue(thread1reply1.body().contains(&quot;I agree&quot;));
 561             assertEquals(noreplyAddress(archive), thread1reply1.author().address());
 562             assertEquals(archive.forge().currentUser().fullName(), thread1reply1.author().fullName().orElseThrow());
 563             var thread1reply2 = conversations.get(0).replies(thread1reply1).get(0);
 564             assertTrue(thread1reply2.body().contains(&quot;Great&quot;));
 565             assertEquals(&quot;integrationreviewer1@openjdk.java.net&quot;, thread1reply2.author().address());
 566             assertEquals(&quot;Generated Reviewer 1&quot;, thread1reply2.author().fullName().orElseThrow());
 567 
 568             var thread2 = conversations.get(0).replies(mail).get(1);
 569             assertEquals(2, thread2.body().split(&quot;^On.*wrote:&quot;).length);
 570             assertEquals(2, thread2.body().split(&quot;&gt; This is now ready&quot;).length, thread2.body());
 571             assertEquals(&quot;RFR: This is a pull request&quot;, thread2.subject());
 572             assertFalse(thread2.body().contains(&quot;Review comment\n\n&quot;), thread2.body());
 573             assertTrue(thread2.body().contains(&quot;Another review comment&quot;), thread2.body());
 574             var thread2reply1 = conversations.get(0).replies(thread2).get(0);
 575             assertTrue(thread2reply1.body().contains(&quot;Sounds good&quot;));
 576             var thread2reply2 = conversations.get(0).replies(thread2reply1).get(0);
 577             assertTrue(thread2reply2.body().contains(&quot;Thanks&quot;));
 578 
 579             var replies = conversations.get(0).replies(mail);
 580             var thread3 = replies.get(2);
 581             assertEquals(&quot;RFR: This is a pull request&quot;, thread3.subject());
 582             var thread4 = replies.get(3);
 583             assertEquals(&quot;RFR: This is a pull request&quot;, thread4.subject());
 584             assertTrue(thread4.body().contains(&quot;Looks fine&quot;));
 585             assertTrue(thread4.body().contains(&quot;The final review comment&quot;));
 586             assertTrue(thread4.body().contains(&quot;Marked as reviewed by integrationreviewer1 (Reviewer)&quot;));
 587         }
 588     }
 589 
 590     @Test
 591     void commentThreadingSeparated(TestInfo testInfo) throws IOException {
 592         try (var credentials = new HostCredentials(testInfo);
 593              var tempFolder = new TemporaryDirectory();
 594              var archiveFolder = new TemporaryDirectory();
 595              var listServer = new TestMailmanServer();
 596              var webrevServer = new TestWebrevServer()) {
 597             var author = credentials.getHostedRepository();
 598             var reviewer = credentials.getHostedRepository();
 599             var archive = credentials.getHostedRepository();
 600             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
 601             var censusBuilder = credentials.getCensusBuilder()
 602                                            .addReviewer(reviewer.forge().currentUser().id())
 603                                            .addAuthor(author.forge().currentUser().id());
 604             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
 605             var mlBot = MailingListBridgeBot.newBuilder()
 606                                             .from(from)
 607                                             .repo(author)
 608                                             .archive(archive)
 609                                             .censusRepo(censusBuilder.build())
 610                                             .list(listAddress)
 611                                             .listArchive(listServer.getArchive())
 612                                             .smtpServer(listServer.getSMTP())
 613                                             .webrevStorageRepository(archive)
 614                                             .webrevStorageRef(&quot;webrev&quot;)
 615                                             .webrevStorageBase(Path.of(&quot;test&quot;))
 616                                             .webrevStorageBaseUri(webrevServer.uri())
 617                                             .issueTracker(URIBuilder.base(&quot;http://issues.test/browse/&quot;).build())
 618                                             .build();
 619 
 620             // Populate the projects repository
 621             var reviewFile = Path.of(&quot;reviewfile.txt&quot;);
 622             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType(), reviewFile);
 623             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
 624             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
 625             localRepo.push(masterHash, archive.url(), &quot;webrev&quot;, true);
 626 
 627             // Make a change with a corresponding PR
 628             var editHash = CheckableRepository.appendAndCommit(localRepo);
 629             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
 630             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
 631             pr.setBody(&quot;This is now ready&quot;);
 632             TestBotRunner.runPeriodicItems(mlBot);
 633             listServer.processIncoming();
 634 
 635             // Make two file specific comments
 636             var reviewPr = reviewer.pullRequest(pr.id());
 637             var comment1 = reviewPr.addReviewComment(masterHash, editHash, reviewFile.toString(), 2, &quot;Review comment&quot;);
 638             var comment2 = reviewPr.addReviewComment(masterHash, editHash, reviewFile.toString(), 2, &quot;Another review comment&quot;);
 639             TestBotRunner.runPeriodicItems(mlBot);
 640             listServer.processIncoming();
 641 
 642             pr.addReviewCommentReply(comment1, &quot;I agree&quot;);
 643             pr.addReviewCommentReply(comment2, &quot;I don&#39;t agree&quot;);
 644             TestBotRunner.runPeriodicItems(mlBot);
 645             listServer.processIncoming();
 646 
 647             // Sanity check the archive
 648             Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);
 649             assertEquals(2, archiveContainsCount(archiveFolder.path(), &quot;^On.*wrote:&quot;));
 650         }
 651     }
 652 
 653     @Test
 654     void reviewContext(TestInfo testInfo) throws IOException {
 655         try (var credentials = new HostCredentials(testInfo);
 656              var tempFolder = new TemporaryDirectory();
 657              var archiveFolder = new TemporaryDirectory();
 658              var listServer = new TestMailmanServer();
 659              var webrevServer = new TestWebrevServer()) {
 660             var author = credentials.getHostedRepository();
 661             var archive = credentials.getHostedRepository();
 662             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
 663             var censusBuilder = credentials.getCensusBuilder()
 664                                            .addAuthor(author.forge().currentUser().id());
 665             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
 666             var mlBot = MailingListBridgeBot.newBuilder()
 667                                             .from(from)
 668                                             .repo(author)
 669                                             .archive(archive)
 670                                             .censusRepo(censusBuilder.build())
 671                                             .list(listAddress)
 672                                             .listArchive(listServer.getArchive())
 673                                             .smtpServer(listServer.getSMTP())
 674                                             .webrevStorageRepository(archive)
 675                                             .webrevStorageRef(&quot;webrev&quot;)
 676                                             .webrevStorageBase(Path.of(&quot;test&quot;))
 677                                             .webrevStorageBaseUri(webrevServer.uri())
 678                                             .issueTracker(URIBuilder.base(&quot;http://issues.test/browse/&quot;).build())
 679                                             .build();
 680 
 681             // Populate the projects repository
 682             var reviewFile = Path.of(&quot;reviewfile.txt&quot;);
 683             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType(), reviewFile);
 684             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
 685             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
 686             localRepo.push(masterHash, archive.url(), &quot;webrev&quot;, true);
 687 
 688             // Make a change with a corresponding PR
 689             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;Line 1\nLine 2\nLine 3\nLine 4&quot;);
 690             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
 691             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
 692             pr.setBody(&quot;This is now ready&quot;);
 693             TestBotRunner.runPeriodicItems(mlBot);
 694             listServer.processIncoming();
 695 
 696             // Make a file specific comment
 697             pr.addReviewComment(masterHash, editHash, reviewFile.toString(), 2, &quot;Review comment&quot;);
 698 
 699             TestBotRunner.runPeriodicItems(mlBot);
 700             listServer.processIncoming();
 701 
 702             // The archive should only contain context around line 2
 703             Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);
 704             assertTrue(archiveContains(archiveFolder.path(), &quot;^&gt; 2: Line 1$&quot;));
 705             assertTrue(archiveContains(archiveFolder.path(), &quot;^&gt; 3: Line 2$&quot;));
 706             assertFalse(archiveContains(archiveFolder.path(), &quot;^&gt; 4: Line 3$&quot;));
 707         }
 708     }
 709 
 710     @Test
 711     void multipleReviewContexts(TestInfo testInfo) throws IOException {
 712         try (var credentials = new HostCredentials(testInfo);
 713              var tempFolder = new TemporaryDirectory();
 714              var archiveFolder = new TemporaryDirectory();
 715              var listServer = new TestMailmanServer();
 716              var webrevServer = new TestWebrevServer()) {
 717             var author = credentials.getHostedRepository();
 718             var archive = credentials.getHostedRepository();
 719             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
 720             var censusBuilder = credentials.getCensusBuilder()
 721                                            .addAuthor(author.forge().currentUser().id());
 722             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
 723             var mlBot = MailingListBridgeBot.newBuilder()
 724                                             .from(from)
 725                                             .repo(author)
 726                                             .archive(archive)
 727                                             .censusRepo(censusBuilder.build())
 728                                             .list(listAddress)
 729                                             .listArchive(listServer.getArchive())
 730                                             .smtpServer(listServer.getSMTP())
 731                                             .webrevStorageRepository(archive)
 732                                             .webrevStorageRef(&quot;webrev&quot;)
 733                                             .webrevStorageBase(Path.of(&quot;test&quot;))
 734                                             .webrevStorageBaseUri(webrevServer.uri())
 735                                             .issueTracker(URIBuilder.base(&quot;http://issues.test/browse/&quot;).build())
 736                                             .build();
 737 
 738             // Populate the projects repository
 739             var reviewFile = Path.of(&quot;reviewfile.txt&quot;);
 740             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType(), reviewFile);
 741             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
 742             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
 743             localRepo.push(masterHash, archive.url(), &quot;webrev&quot;, true);
 744             var initialHash = CheckableRepository.appendAndCommit(localRepo,
 745                                                                   &quot;Line 0.1\nLine 0.2\nLine 0.3\nLine 0.4\n&quot; +
 746                                                                           &quot;Line 1\nLine 2\nLine 3\nLine 4\n&quot; +
 747                                                                           &quot;Line 5\nLine 6\nLine 7\nLine 8\n&quot; +
 748                                                                           &quot;Line 8.1\nLine 8.2\nLine 8.3\nLine 8.4\n&quot; +
 749                                                                           &quot;Line 9\nLine 10\nLine 11\nLine 12\n&quot; +
 750                                                                           &quot;Line 13\nLine 14\nLine 15\nLine 16\n&quot;);
 751             localRepo.push(initialHash, author.url(), &quot;master&quot;);
 752 
 753             // Make a change with a corresponding PR
 754             var current = Files.readString(localRepo.root().resolve(reviewFile), StandardCharsets.UTF_8);
 755             var updated = current.replaceAll(&quot;Line 2&quot;, &quot;Line 2 edit\nLine 2.5&quot;);
 756             updated = updated.replaceAll(&quot;Line 13&quot;, &quot;Line 12.5\nLine 13 edit&quot;);
 757             Files.writeString(localRepo.root().resolve(reviewFile), updated, StandardCharsets.UTF_8);
 758             var editHash = CheckableRepository.appendAndCommit(localRepo);
 759             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
 760             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
 761             pr.setBody(&quot;This is now ready&quot;);
 762             TestBotRunner.runPeriodicItems(mlBot);
 763             listServer.processIncoming();
 764 
 765             // Make file specific comments
 766             pr.addReviewComment(masterHash, editHash, reviewFile.toString(), 7, &quot;Review comment&quot;);
 767             pr.addReviewComment(masterHash, editHash, reviewFile.toString(), 24, &quot;Another review comment&quot;);
 768 
 769             TestBotRunner.runPeriodicItems(mlBot);
 770             listServer.processIncoming();
 771 
 772             // The archive should only contain context around line 2 and 20
 773             Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);
 774             assertTrue(archiveContains(archiveFolder.path(), &quot;reviewfile.txt line 7&quot;));
 775             assertTrue(archiveContains(archiveFolder.path(), &quot;^&gt; 6: Line 1$&quot;));
 776             assertTrue(archiveContains(archiveFolder.path(), &quot;^&gt; 7: Line 2 edit$&quot;));
 777             assertFalse(archiveContains(archiveFolder.path(), &quot;Line 3&quot;));
 778 
 779             assertTrue(archiveContains(archiveFolder.path(), &quot;reviewfile.txt line 24&quot;));
 780             assertTrue(archiveContains(archiveFolder.path(), &quot;^&gt; 23: Line 12.5$&quot;));
 781             assertTrue(archiveContains(archiveFolder.path(), &quot;^&gt; 24: Line 13 edit$&quot;));
 782             assertFalse(archiveContains(archiveFolder.path(), &quot;^Line 15&quot;));
 783         }
 784     }
 785 
 786     @Test
 787     void filterComments(TestInfo testInfo) throws IOException {
 788         try (var credentials = new HostCredentials(testInfo);
 789              var tempFolder = new TemporaryDirectory();
 790              var archiveFolder = new TemporaryDirectory();
 791              var listServer = new TestMailmanServer();
 792              var webrevServer = new TestWebrevServer()) {
 793             var author = credentials.getHostedRepository();
 794             var archive = credentials.getHostedRepository();
 795             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
 796             var censusBuilder = credentials.getCensusBuilder()
 797                                            .addAuthor(author.forge().currentUser().id());
 798             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
 799             var mlBot = MailingListBridgeBot.newBuilder()
 800                                             .from(from)
 801                                             .repo(author)
 802                                             .archive(archive)
 803                                             .censusRepo(censusBuilder.build())
 804                                             .list(listAddress)
 805                                             .listArchive(listServer.getArchive())
 806                                             .smtpServer(listServer.getSMTP())
 807                                             .webrevStorageRepository(archive)
 808                                             .webrevStorageRef(&quot;webrev&quot;)
 809                                             .webrevStorageBase(Path.of(&quot;test&quot;))
 810                                             .webrevStorageBaseUri(webrevServer.uri())
 811                                             .issueTracker(URIBuilder.base(&quot;http://issues.test/browse/&quot;).build())
 812                                             .build();
 813 
 814             // Populate the projects repository
 815             var reviewFile = Path.of(&quot;reviewfile.txt&quot;);
 816             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType(), reviewFile);
 817             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
 818             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
 819             localRepo.push(masterHash, archive.url(), &quot;webrev&quot;, true);
 820 
 821             // Make a change with a corresponding PR
 822             var editHash = CheckableRepository.appendAndCommit(localRepo);
 823             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
 824             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
 825             pr.setBody(&quot;This is now ready\n&lt;!-- this is a comment --&gt;\nAnd this is not\n&quot; +
 826                                &quot;&lt;!-- Anything below this marker will be hidden --&gt;\nStatus stuff&quot;);
 827 
 828             // Make a bunch of comments
 829             pr.addComment(&quot;Plain comment\n&lt;!-- this is a comment --&gt;&quot;);
 830             pr.addReviewComment(masterHash, editHash, reviewFile.toString(), 2, &quot;Review comment &lt;!-- this is a comment --&gt;\n&quot;);
 831             pr.addComment(&quot;/integrate stuff&quot;);
 832             TestBotRunner.runPeriodicItems(mlBot);
 833 
 834             // Run an archive pass
 835             TestBotRunner.runPeriodicItems(mlBot);
 836 
 837             // The archive should not contain the comment
 838             Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);
 839             assertTrue(archiveContains(archiveFolder.path(), &quot;This is now ready&quot;));
 840             assertFalse(archiveContains(archiveFolder.path(), &quot;this is a comment&quot;));
 841             assertFalse(archiveContains(archiveFolder.path(), &quot;Status stuff&quot;));
 842             assertTrue(archiveContains(archiveFolder.path(), &quot;And this is not&quot;));
 843             assertFalse(archiveContains(archiveFolder.path(), &quot;&lt;!--&quot;));
 844             assertFalse(archiveContains(archiveFolder.path(), &quot;--&gt;&quot;));
 845             assertTrue(archiveContains(archiveFolder.path(), &quot;Plain comment&quot;));
 846             assertTrue(archiveContains(archiveFolder.path(), &quot;Review comment&quot;));
 847             assertFalse(archiveContains(archiveFolder.path(), &quot;/integrate&quot;));
 848         }
 849     }
 850 
 851     @Test
 852     void incrementalChanges(TestInfo testInfo) throws IOException {
 853         try (var credentials = new HostCredentials(testInfo);
 854              var tempFolder = new TemporaryDirectory();
 855              var archiveFolder = new TemporaryDirectory();
 856              var listServer = new TestMailmanServer();
 857              var webrevServer = new TestWebrevServer()) {
 858             var author = credentials.getHostedRepository();
 859             var archive = credentials.getHostedRepository();
 860             var commenter = credentials.getHostedRepository();
 861             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
 862             var censusBuilder = credentials.getCensusBuilder()
 863                                            .addAuthor(author.forge().currentUser().id());
 864             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
 865             var mlBot = MailingListBridgeBot.newBuilder()
 866                                             .from(from)
 867                                             .repo(author)
 868                                             .archive(archive)
 869                                             .censusRepo(censusBuilder.build())
 870                                             .list(listAddress)
 871                                             .listArchive(listServer.getArchive())
 872                                             .smtpServer(listServer.getSMTP())
 873                                             .webrevStorageRepository(archive)
 874                                             .webrevStorageRef(&quot;webrev&quot;)
 875                                             .webrevStorageBase(Path.of(&quot;test&quot;))
 876                                             .webrevStorageBaseUri(webrevServer.uri())
 877                                             .issueTracker(URIBuilder.base(&quot;http://issues.test/browse/&quot;).build())
 878                                             .build();
 879 
 880             // Populate the projects repository
 881             var reviewFile = Path.of(&quot;reviewfile.txt&quot;);
 882             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType(), reviewFile);
 883             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
 884             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
 885             localRepo.push(masterHash, archive.url(), &quot;webrev&quot;, true);
 886 
 887             // Make a change with a corresponding PR
 888             var editHash = CheckableRepository.appendAndCommit(localRepo);
 889             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
 890             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
 891             pr.setBody(&quot;This is now ready&quot;);
 892 
 893             // Run an archive pass
 894             TestBotRunner.runPeriodicItems(mlBot);
 895             listServer.processIncoming();
 896 
 897             var nextHash = CheckableRepository.appendAndCommit(localRepo, &quot;Yet one more line&quot;, &quot;Fixing&quot;);
 898             localRepo.push(nextHash, author.url(), &quot;edit&quot;);
 899 
 900             // Make sure that the push registered
 901             var lastHeadHash = pr.headHash();
 902             var refreshCount = 0;
 903             do {
 904                 pr = author.pullRequest(pr.id());
 905                 if (refreshCount++ &gt; 100) {
 906                     fail(&quot;The PR did not update after the new push&quot;);
 907                 }
 908             } while (pr.headHash().equals(lastHeadHash));
 909 
 910             // Run another archive pass
 911             TestBotRunner.runPeriodicItems(mlBot);
 912             TestBotRunner.runPeriodicItems(mlBot);
 913             TestBotRunner.runPeriodicItems(mlBot);
 914             listServer.processIncoming();
 915 
 916             // The archive should reference the updated push
 917             Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);
 918             assertTrue(archiveContains(archiveFolder.path(), &quot;1 additional commit&quot;));
 919             assertTrue(archiveContains(archiveFolder.path(), &quot;full.*/&quot; + pr.id() + &quot;/webrev.01&quot;));
 920             assertTrue(archiveContains(archiveFolder.path(), &quot;inc.*/&quot; + pr.id() + &quot;/webrev.00-01&quot;));
 921             assertTrue(archiveContains(archiveFolder.path(), &quot;Patch&quot;));
 922             assertTrue(archiveContains(archiveFolder.path(), &quot;Fetch&quot;));
 923             assertTrue(archiveContains(archiveFolder.path(), &quot;Fixing&quot;));
 924 
 925             // The webrev comment should be updated
 926             var comments = pr.comments();
 927             var webrevComments = comments.stream()
 928                                          .filter(comment -&gt; comment.author().equals(author.forge().currentUser()))
 929                                          .filter(comment -&gt; comment.body().contains(&quot;webrev&quot;))
 930                                          .filter(comment -&gt; comment.body().contains(&quot;Full&quot;))
 931                                          .filter(comment -&gt; comment.body().contains(&quot;Incremental&quot;))
 932                                          .filter(comment -&gt; comment.body().contains(nextHash.hex()))
 933                                          .filter(comment -&gt; comment.body().contains(editHash.hex()))
 934                                          .collect(Collectors.toList());
 935             assertEquals(1, webrevComments.size());
 936 
 937             // Check that sender address is set properly
 938             var mailmanServer = MailingListServerFactory.createMailmanServer(listServer.getArchive(), listServer.getSMTP(), Duration.ZERO);
 939             var mailmanList = mailmanServer.getList(listAddress.address());
 940             var conversations = mailmanList.conversations(Duration.ofDays(1));
 941             assertEquals(1, conversations.size());
 942             for (var newMail : conversations.get(0).allMessages()) {
 943                 assertEquals(noreplyAddress(archive), newMail.author().address());
 944                 assertEquals(listAddress, newMail.sender());
 945             }
 946 
 947             // Add a comment
 948             var commenterPr = commenter.pullRequest(pr.id());
 949             commenterPr.addReviewComment(masterHash, nextHash, reviewFile.toString(), 2, &quot;Review comment&quot;);
 950             TestBotRunner.runPeriodicItems(mlBot);
 951             listServer.processIncoming();
 952 
 953             // Ensure that additional updates are only reported once
 954             for (int i = 0; i &lt; 3; ++i) {
 955                 var anotherHash = CheckableRepository.appendAndCommit(localRepo, &quot;Another line&quot;, &quot;Fixing&quot;);
 956                 localRepo.push(anotherHash, author.url(), &quot;edit&quot;);
 957 
 958                 // Make sure that the push registered
 959                 lastHeadHash = pr.headHash();
 960                 refreshCount = 0;
 961                 do {
 962                     pr = author.pullRequest(pr.id());
 963                     if (refreshCount++ &gt; 100) {
 964                         fail(&quot;The PR did not update after the new push&quot;);
 965                     }
 966                 } while (pr.headHash().equals(lastHeadHash));
 967 
 968                 TestBotRunner.runPeriodicItems(mlBot);
 969                 TestBotRunner.runPeriodicItems(mlBot);
 970                 listServer.processIncoming();
 971             }
 972             var updatedConversations = mailmanList.conversations(Duration.ofDays(1));
 973             assertEquals(1, updatedConversations.size());
 974             var conversation = updatedConversations.get(0);
 975             assertEquals(6, conversation.allMessages().size());
 976             assertEquals(&quot;[Rev 01] RFR: This is a pull request&quot;, conversation.allMessages().get(1).subject());
 977             assertEquals(&quot;[Rev 01] RFR: This is a pull request&quot;, conversation.allMessages().get(2).subject(), conversation.allMessages().get(2).toString());
 978             assertEquals(&quot;[Rev 04] RFR: This is a pull request&quot;, conversation.allMessages().get(5).subject());
 979         }
 980     }
 981 
 982     @Test
 983     void rebased(TestInfo testInfo) throws IOException {
 984         try (var credentials = new HostCredentials(testInfo);
 985              var tempFolder = new TemporaryDirectory();
 986              var archiveFolder = new TemporaryDirectory();
 987              var listServer = new TestMailmanServer();
 988              var webrevServer = new TestWebrevServer()) {
 989             var author = credentials.getHostedRepository();
 990             var archive = credentials.getHostedRepository();
 991             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
 992             var censusBuilder = credentials.getCensusBuilder()
 993                                            .addAuthor(author.forge().currentUser().id());
 994             var sender = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
 995             var mlBot = MailingListBridgeBot.newBuilder()
 996                                             .from(sender)
 997                                             .repo(author)
 998                                             .archive(archive)
 999                                             .censusRepo(censusBuilder.build())
1000                                             .list(listAddress)
1001                                             .listArchive(listServer.getArchive())
1002                                             .smtpServer(listServer.getSMTP())
1003                                             .webrevStorageRepository(archive)
1004                                             .webrevStorageRef(&quot;webrev&quot;)
1005                                             .webrevStorageBase(Path.of(&quot;test&quot;))
1006                                             .webrevStorageBaseUri(webrevServer.uri())
1007                                             .issueTracker(URIBuilder.base(&quot;http://issues.test/browse/&quot;).build())
1008                                             .build();
1009 
1010             // Populate the projects repository
1011             var reviewFile = Path.of(&quot;reviewfile.txt&quot;);
1012             var localRepo = CheckableRepository.init(tempFolder.path().resolve(&quot;first&quot;), author.repositoryType(), reviewFile);
1013             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
1014             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
1015             localRepo.push(masterHash, archive.url(), &quot;webrev&quot;, true);
1016 
1017             // Make a change with a corresponding PR
1018             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;A line&quot;, &quot;Original msg&quot;);
1019             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
1020             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
1021             pr.setBody(&quot;This is now ready&quot;);
1022 
1023             // Run an archive pass
1024             TestBotRunner.runPeriodicItems(mlBot);
1025             listServer.processIncoming();
1026 
1027             var newLocalRepo = Repository.materialize(tempFolder.path().resolve(&quot;second&quot;), author.url(), &quot;master&quot;);
1028             var newEditHash = CheckableRepository.appendAndCommit(newLocalRepo, &quot;Another line&quot;, &quot;Replaced msg&quot;);
1029             newLocalRepo.push(newEditHash, author.url(), &quot;edit&quot;, true);
1030 
1031             // Make sure that the push registered
1032             var lastHeadHash = pr.headHash();
1033             var refreshCount = 0;
1034             do {
1035                 pr = author.pullRequest(pr.id());
1036                 if (refreshCount++ &gt; 100) {
1037                     fail(&quot;The PR did not update after the new push&quot;);
1038                 }
1039             } while (pr.headHash().equals(lastHeadHash));
1040 
1041             // Run another archive pass
1042             TestBotRunner.runPeriodicItems(mlBot);
1043             listServer.processIncoming();
1044 
1045             // The archive should reference the rebased push
1046             Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);
1047             assertTrue(archiveContains(archiveFolder.path(), &quot;updated with a new target base&quot;));
1048             assertTrue(archiveContains(archiveFolder.path(), pr.id() + &quot;/webrev.01&quot;));
1049             assertFalse(archiveContains(archiveFolder.path(), &quot;Incremental&quot;));
1050             assertTrue(archiveContains(archiveFolder.path(), &quot;Patch&quot;));
1051             assertTrue(archiveContains(archiveFolder.path(), &quot;Fetch&quot;));
1052             assertTrue(archiveContains(archiveFolder.path(), &quot;Original msg&quot;));
1053             assertTrue(archiveContains(archiveFolder.path(), &quot;Replaced msg&quot;));
1054 
1055             // The webrev comment should be updated
1056             var comments = pr.comments();
1057             var webrevComments = comments.stream()
1058                                          .filter(comment -&gt; comment.author().equals(author.forge().currentUser()))
1059                                          .filter(comment -&gt; comment.body().contains(&quot;webrev&quot;))
1060                                          .filter(comment -&gt; comment.body().contains(newEditHash.hex()))
1061                                          .collect(Collectors.toList());
1062             assertEquals(1, webrevComments.size());
1063 
1064             // Check that sender address is set properly
1065             var mailmanServer = MailingListServerFactory.createMailmanServer(listServer.getArchive(), listServer.getSMTP(), Duration.ZERO);
1066             var mailmanList = mailmanServer.getList(listAddress.address());
1067             var conversations = mailmanList.conversations(Duration.ofDays(1));
1068             assertEquals(1, conversations.size());
1069             for (var newMail : conversations.get(0).allMessages()) {
1070                 assertEquals(noreplyAddress(archive), newMail.author().address());
1071                 assertEquals(listAddress, newMail.sender());
1072                 assertFalse(newMail.hasHeader(&quot;PR-Head-Hash&quot;));
1073             }
1074             assertEquals(&quot;[Rev 01] RFR: This is a pull request&quot;, conversations.get(0).allMessages().get(1).subject());
1075         }
1076     }
1077 
1078     @Test
1079     void incrementalAfterRebase(TestInfo testInfo) throws IOException {
1080         try (var credentials = new HostCredentials(testInfo);
1081              var tempFolder = new TemporaryDirectory();
1082              var archiveFolder = new TemporaryDirectory();
1083              var listServer = new TestMailmanServer();
1084              var webrevServer = new TestWebrevServer()) {
1085             var author = credentials.getHostedRepository();
1086             var archive = credentials.getHostedRepository();
1087             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
1088             var censusBuilder = credentials.getCensusBuilder()
1089                                            .addAuthor(author.forge().currentUser().id());
1090             var sender = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
1091             var mlBot = MailingListBridgeBot.newBuilder()
1092                                             .from(sender)
1093                                             .repo(author)
1094                                             .archive(archive)
1095                                             .archiveRef(&quot;archive&quot;)
1096                                             .censusRepo(censusBuilder.build())
1097                                             .list(listAddress)
1098                                             .listArchive(listServer.getArchive())
1099                                             .smtpServer(listServer.getSMTP())
1100                                             .webrevStorageRepository(archive)
1101                                             .webrevStorageRef(&quot;webrev&quot;)
1102                                             .webrevStorageBase(Path.of(&quot;test&quot;))
1103                                             .webrevStorageBaseUri(webrevServer.uri())
1104                                             .issueTracker(URIBuilder.base(&quot;http://issues.test/browse/&quot;).build())
1105                                             .build();
1106 
1107             // Populate the projects repository
1108             var reviewFile = Path.of(&quot;reviewfile.txt&quot;);
1109             var localRepo = CheckableRepository.init(tempFolder.path().resolve(&quot;first&quot;), author.repositoryType(), reviewFile);
1110             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
1111             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
1112             localRepo.push(masterHash, archive.url(), &quot;webrev&quot;, true);
1113             localRepo.push(masterHash, archive.url(), &quot;archive&quot;, true);
1114 
1115             // Make a change with a corresponding PR
1116             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;A line&quot;, &quot;Original msg&quot;);
1117             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
1118             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
1119             pr.setBody(&quot;This is now ready&quot;);
1120 
1121             // Run an archive pass
1122             TestBotRunner.runPeriodicItems(mlBot);
1123             listServer.processIncoming();
1124 
1125             // Push more stuff to master
1126             localRepo.checkout(masterHash, true);
1127             var unrelatedFile = localRepo.root().resolve(&quot;unrelated.txt&quot;);
1128             Files.writeString(unrelatedFile, &quot;Other things happens in master&quot;);
1129             localRepo.add(unrelatedFile);
1130             var newMasterHash = localRepo.commit(&quot;Unrelated change&quot;, &quot;duke&quot;, &quot;duke@openjdk.org&quot;);
1131             localRepo.push(newMasterHash, author.url(), &quot;master&quot;);
1132 
1133             // And more stuff to the pr branch
1134             localRepo.checkout(editHash, true);
1135             CheckableRepository.appendAndCommit(localRepo, &quot;Another line&quot;, &quot;More updates&quot;);
1136 
1137             // Merge master
1138             localRepo.merge(newMasterHash);
1139             var newEditHash = localRepo.commit(&quot;Latest changes from master&quot;, &quot;duke&quot;, &quot;duke@openjdk.org&quot;);
1140             localRepo.push(newEditHash, author.url(), &quot;edit&quot;);
1141 
1142             // Make sure that the push registered
1143             var lastHeadHash = pr.headHash();
1144             var refreshCount = 0;
1145             do {
1146                 pr = author.pullRequest(pr.id());
1147                 if (refreshCount++ &gt; 100) {
1148                     fail(&quot;The PR did not update after the new push&quot;);
1149                 }
1150             } while (pr.headHash().equals(lastHeadHash));
1151 
1152             // Run another archive pass
1153             TestBotRunner.runPeriodicItems(mlBot);
1154             listServer.processIncoming();
1155 
1156             // The archive should reference the rebased push
1157             Repository.materialize(archiveFolder.path(), archive.url(), &quot;archive&quot;);
1158             assertTrue(archiveContains(archiveFolder.path(), &quot;updated with a new target base&quot;));
1159             assertTrue(archiveContains(archiveFolder.path(), &quot;excludes the unrelated changes&quot;));
1160             assertTrue(archiveContains(archiveFolder.path(), pr.id() + &quot;/webrev.01&quot;));
1161             assertTrue(archiveContains(archiveFolder.path(), pr.id() + &quot;/webrev.00-01&quot;));
1162             assertTrue(archiveContains(archiveFolder.path(), &quot;Original msg&quot;));
1163             assertTrue(archiveContains(archiveFolder.path(), &quot;More updates&quot;));
1164         }
1165     }
1166 
1167     @Test
1168     void skipAddingExistingWebrev(TestInfo testInfo) throws IOException {
1169         try (var credentials = new HostCredentials(testInfo);
1170              var tempFolder = new TemporaryDirectory();
1171              var archiveFolder = new TemporaryDirectory();
1172              var webrevFolder = new TemporaryDirectory();
1173              var listServer = new TestMailmanServer();
1174              var webrevServer = new TestWebrevServer()) {
1175             var author = credentials.getHostedRepository();
1176             var archive = credentials.getHostedRepository();
1177             var ignored = credentials.getHostedRepository();
1178             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
1179             var censusBuilder = credentials.getCensusBuilder()
1180                                            .addAuthor(author.forge().currentUser().id());
1181             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
1182             var mlBot = MailingListBridgeBot.newBuilder()
1183                                             .from(from)
1184                                             .repo(author)
1185                                             .archive(archive)
1186                                             .censusRepo(censusBuilder.build())
1187                                             .list(listAddress)
1188                                             .ignoredUsers(Set.of(ignored.forge().currentUser().userName()))
1189                                             .listArchive(listServer.getArchive())
1190                                             .smtpServer(listServer.getSMTP())
1191                                             .webrevStorageRepository(archive)
1192                                             .webrevStorageRef(&quot;webrev&quot;)
1193                                             .webrevStorageBase(Path.of(&quot;test&quot;))
1194                                             .webrevStorageBaseUri(webrevServer.uri())
1195                                             .issueTracker(URIBuilder.base(&quot;http://issues.test/browse/&quot;).build())
1196                                             .build();
1197 
1198             // Populate the projects repository
1199             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType());
1200             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
1201             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
1202             localRepo.push(masterHash, archive.url(), &quot;webrev&quot;, true);
1203 
1204             // Make a change with a corresponding PR
1205             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;A simple change&quot;,
1206                                                                &quot;Change msg\n\nWith several lines&quot;);
1207             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
1208             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
1209 
1210             // Flag it as ready for review
1211             pr.setBody(&quot;This should now be ready&quot;);
1212 
1213             // Run an archive pass
1214             TestBotRunner.runPeriodicItems(mlBot);
1215 
1216             // The archive should now contain an entry
1217             var archiveRepo = Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);
1218             assertTrue(archiveContains(archiveFolder.path(), editHash.abbreviate()));
1219 
1220             // And there should be a webrev comment
1221             var comments = pr.comments();
1222             var webrevComments = comments.stream()
1223                                          .filter(comment -&gt; comment.author().equals(author.forge().currentUser()))
1224                                          .filter(comment -&gt; comment.body().contains(&quot;webrev&quot;))
1225                                          .filter(comment -&gt; comment.body().contains(editHash.hex()))
1226                                          .collect(Collectors.toList());
1227             assertEquals(1, webrevComments.size());
1228             assertEquals(1, countSubstrings(webrevComments.get(0).body(), &quot;webrev.00&quot;));
1229 
1230             // Pretend the archive didn&#39;t work out
1231             archiveRepo.push(masterHash, archive.url(), &quot;master&quot;, true);
1232 
1233             // Run another archive pass
1234             TestBotRunner.runPeriodicItems(mlBot);
1235 
1236             // The webrev comment should not contain duplicate entries
1237             comments = pr.comments();
1238             webrevComments = comments.stream()
1239                                      .filter(comment -&gt; comment.author().equals(author.forge().currentUser()))
1240                                      .filter(comment -&gt; comment.body().contains(&quot;webrev&quot;))
1241                                      .filter(comment -&gt; comment.body().contains(editHash.hex()))
1242                                      .collect(Collectors.toList());
1243             assertEquals(1, webrevComments.size());
1244             assertEquals(1, countSubstrings(webrevComments.get(0).body(), &quot;webrev.00&quot;));
1245         }
1246     }
1247 
1248     @Test
1249     void notifyReviewVerdicts(TestInfo testInfo) throws IOException {
1250         try (var credentials = new HostCredentials(testInfo);
1251              var tempFolder = new TemporaryDirectory();
1252              var archiveFolder = new TemporaryDirectory();
1253              var listServer = new TestMailmanServer();
1254              var webrevServer = new TestWebrevServer()) {
1255             var author = credentials.getHostedRepository();
1256             var archive = credentials.getHostedRepository();
1257             var reviewer = credentials.getHostedRepository();
1258             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
1259             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
1260             var censusBuilder = credentials.getCensusBuilder()
1261                                            .addReviewer(reviewer.forge().currentUser().id())
1262                                            .addAuthor(author.forge().currentUser().id());
1263             var mlBot = MailingListBridgeBot.newBuilder()
1264                                             .from(from)
1265                                             .repo(author)
1266                                             .archive(archive)
1267                                             .censusRepo(censusBuilder.build())
1268                                             .list(listAddress)
1269                                             .listArchive(listServer.getArchive())
1270                                             .smtpServer(listServer.getSMTP())
1271                                             .webrevStorageRepository(archive)
1272                                             .webrevStorageRef(&quot;webrev&quot;)
1273                                             .webrevStorageBase(Path.of(&quot;test&quot;))
1274                                             .webrevStorageBaseUri(webrevServer.uri())
1275                                             .issueTracker(URIBuilder.base(&quot;http://issues.test/browse/&quot;).build())
1276                                             .build();
1277 
1278             // Populate the projects repository
1279             var reviewFile = Path.of(&quot;reviewfile.txt&quot;);
1280             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType(), reviewFile);
1281             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
1282             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
1283             localRepo.push(masterHash, archive.url(), &quot;webrev&quot;, true);
1284 
1285             // Make a change with a corresponding PR
1286             var editHash = CheckableRepository.appendAndCommit(localRepo);
1287             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
1288             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
1289             pr.setBody(&quot;This is now ready&quot;);
1290 
1291             // Run an archive pass
1292             TestBotRunner.runPeriodicItems(mlBot);
1293 
1294             // First unapprove it
1295             var reviewedPr = reviewer.pullRequest(pr.id());
1296             reviewedPr.addReview(Review.Verdict.DISAPPROVED, &quot;Reason 1&quot;);
1297             TestBotRunner.runPeriodicItems(mlBot);
1298             TestBotRunner.runPeriodicItems(mlBot);
1299             TestBotRunner.runPeriodicItems(mlBot);
1300 
1301             // The archive should contain a note
1302             Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);
1303             assertEquals(1, archiveContainsCount(archiveFolder.path(), &quot;Changes requested by &quot;));
1304             assertEquals(1, archiveContainsCount(archiveFolder.path(), &quot; by integrationreviewer1&quot;));
1305             if (author.forge().supportsReviewBody()) {
1306                 assertEquals(1, archiveContainsCount(archiveFolder.path(), &quot;Reason 1&quot;));
1307             }
1308 
1309             // Then approve it
1310             reviewedPr.addReview(Review.Verdict.APPROVED, &quot;Reason 2&quot;);
1311             TestBotRunner.runPeriodicItems(mlBot);
1312             TestBotRunner.runPeriodicItems(mlBot);
1313             TestBotRunner.runPeriodicItems(mlBot);
1314 
1315             // The archive should contain another note
1316             Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);
1317             assertEquals(1, archiveContainsCount(archiveFolder.path(), &quot;Marked as reviewed by &quot;));
1318             if (author.forge().supportsReviewBody()) {
1319                 assertEquals(1, archiveContainsCount(archiveFolder.path(), &quot;Reason 2&quot;));
1320             }
1321             assertEquals(2, archiveContainsCount(archiveFolder.path(), &quot;Re: RFR:&quot;));
1322 
1323             // Yet another change
1324             reviewedPr.addReview(Review.Verdict.DISAPPROVED, &quot;Reason 3&quot;);
1325             TestBotRunner.runPeriodicItems(mlBot);
1326             TestBotRunner.runPeriodicItems(mlBot);
1327             TestBotRunner.runPeriodicItems(mlBot);
1328 
1329             // The archive should contain another note
1330             Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);
1331             assertEquals(2, archiveContainsCount(archiveFolder.path(), &quot;Changes requested by &quot;));
1332             if (author.forge().supportsReviewBody()) {
1333                 assertEquals(1, archiveContainsCount(archiveFolder.path(), &quot;Reason 3&quot;));
1334             }
1335         }
1336     }
1337 
1338     @Test
1339     void ignoreComments(TestInfo testInfo) throws IOException {
1340         try (var credentials = new HostCredentials(testInfo);
1341              var tempFolder = new TemporaryDirectory();
1342              var archiveFolder = new TemporaryDirectory();
1343              var listServer = new TestMailmanServer();
1344              var webrevServer = new TestWebrevServer()) {
1345             var author = credentials.getHostedRepository();
1346             var ignored = credentials.getHostedRepository();
1347             var archive = credentials.getHostedRepository();
1348             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
1349             var censusBuilder = credentials.getCensusBuilder()
1350                                            .addAuthor(author.forge().currentUser().id());
1351             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
1352             var mlBot = MailingListBridgeBot.newBuilder()
1353                                             .from(from)
1354                                             .repo(author)
1355                                             .archive(archive)
1356                                             .censusRepo(censusBuilder.build())
1357                                             .list(listAddress)
1358                                             .ignoredUsers(Set.of(ignored.forge().currentUser().userName()))
1359                                             .ignoredComments(Set.of(Pattern.compile(&quot;ignore this comment&quot;, Pattern.MULTILINE | Pattern.DOTALL)))
1360                                             .listArchive(listServer.getArchive())
1361                                             .smtpServer(listServer.getSMTP())
1362                                             .webrevStorageRepository(archive)
1363                                             .webrevStorageRef(&quot;webrev&quot;)
1364                                             .webrevStorageBase(Path.of(&quot;test&quot;))
1365                                             .webrevStorageBaseUri(webrevServer.uri())
1366                                             .issueTracker(URIBuilder.base(&quot;http://issues.test/browse/&quot;).build())
1367                                             .build();
1368 
1369             // Populate the projects repository
1370             var reviewFile = Path.of(&quot;reviewfile.txt&quot;);
1371             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType(), reviewFile);
1372             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
1373             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
1374             localRepo.push(masterHash, archive.url(), &quot;webrev&quot;, true);
1375 
1376             // Make a change with a corresponding PR
1377             var editHash = CheckableRepository.appendAndCommit(localRepo);
1378             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
1379             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
1380             pr.setBody(&quot;This is now ready&quot;);
1381 
1382             // Make a bunch of comments
1383             pr.addComment(&quot;Plain comment&quot;);
1384             pr.addComment(&quot;ignore this comment&quot;);
1385             pr.addComment(&quot;I think it is time to\nignore this comment!&quot;);
1386             pr.addReviewComment(masterHash, editHash, reviewFile.toString(), 2, &quot;Review ignore this comment&quot;);
1387 
1388             var ignoredPR = ignored.pullRequest(pr.id());
1389             ignoredPR.addComment(&quot;Don&#39;t mind me&quot;);
1390 
1391             TestBotRunner.runPeriodicItems(mlBot);
1392             TestBotRunner.runPeriodicItems(mlBot);
1393 
1394             // The archive should not contain the ignored comments
1395             Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);
1396             assertTrue(archiveContains(archiveFolder.path(), &quot;This is now ready&quot;));
1397             assertFalse(archiveContains(archiveFolder.path(), &quot;ignore this comment&quot;));
1398             assertFalse(archiveContains(archiveFolder.path(), &quot;it is time to&quot;));
1399             assertFalse(archiveContains(archiveFolder.path(), &quot;Don&#39;t mind me&quot;));
1400             assertFalse(archiveContains(archiveFolder.path(), &quot;Review ignore&quot;));
1401         }
1402     }
1403 
1404     @Test
1405     void replyToEmptyReview(TestInfo testInfo) throws IOException {
1406         try (var credentials = new HostCredentials(testInfo);
1407              var tempFolder = new TemporaryDirectory();
1408              var archiveFolder = new TemporaryDirectory();
1409              var listServer = new TestMailmanServer();
1410              var webrevServer = new TestWebrevServer()) {
1411             var author = credentials.getHostedRepository();
1412             var reviewer = credentials.getHostedRepository();
1413             var archive = credentials.getHostedRepository();
1414             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
1415             var censusBuilder = credentials.getCensusBuilder()
1416                                            .addReviewer(reviewer.forge().currentUser().id())
1417                                            .addAuthor(author.forge().currentUser().id());
1418             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
1419             var mlBot = MailingListBridgeBot.newBuilder()
1420                                             .from(from)
1421                                             .repo(author)
1422                                             .archive(archive)
1423                                             .censusRepo(censusBuilder.build())
1424                                             .list(listAddress)
1425                                             .listArchive(listServer.getArchive())
1426                                             .smtpServer(listServer.getSMTP())
1427                                             .webrevStorageRepository(archive)
1428                                             .webrevStorageRef(&quot;webrev&quot;)
1429                                             .webrevStorageBase(Path.of(&quot;test&quot;))
1430                                             .webrevStorageBaseUri(webrevServer.uri())
1431                                             .issueTracker(URIBuilder.base(&quot;http://issues.test/browse/&quot;).build())
1432                                             .build();
1433 
1434             // Populate the projects repository
1435             var reviewFile = Path.of(&quot;reviewfile.txt&quot;);
1436             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType(), reviewFile);
1437             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
1438             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
1439             localRepo.push(masterHash, archive.url(), &quot;webrev&quot;, true);
1440 
1441             // Make a change with a corresponding PR
1442             var editHash = CheckableRepository.appendAndCommit(localRepo);
1443             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
1444             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
1445             pr.setBody(&quot;This is now ready&quot;);
1446             TestBotRunner.runPeriodicItems(mlBot);
1447             listServer.processIncoming();
1448 
1449             // Make an empty approval
1450             var reviewPr = reviewer.pullRequest(pr.id());
1451             reviewPr.addReview(Review.Verdict.APPROVED, &quot;&quot;);
1452             TestBotRunner.runPeriodicItems(mlBot);
1453             listServer.processIncoming();
1454 
1455             pr.addComment(&quot;Thanks for the review!&quot;);
1456             TestBotRunner.runPeriodicItems(mlBot);
1457             listServer.processIncoming();
1458 
1459             // The approval text should be included in the quote
1460             Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);
1461             assertEquals(1, archiveContainsCount(archiveFolder.path(), &quot;^&gt; Marked as reviewed&quot;));
1462         }
1463     }
1464 
1465     @Test
1466     void cooldown(TestInfo testInfo) throws IOException {
1467         try (var credentials = new HostCredentials(testInfo);
1468              var tempFolder = new TemporaryDirectory();
1469              var archiveFolder = new TemporaryDirectory();
1470              var listServer = new TestMailmanServer();
1471              var webrevServer = new TestWebrevServer()) {
1472             var bot = credentials.getHostedRepository();
1473             var author = credentials.getHostedRepository();
1474             var archive = credentials.getHostedRepository();
1475             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
1476             var censusBuilder = credentials.getCensusBuilder()
1477                                            .addAuthor(author.forge().currentUser().id());
1478             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
1479             var mlBotBuilder = MailingListBridgeBot.newBuilder()
1480                                                    .from(from)
1481                                                    .repo(bot)
1482                                                    .ignoredUsers(Set.of(bot.forge().currentUser().userName()))
1483                                                    .archive(archive)
1484                                                    .censusRepo(censusBuilder.build())
1485                                                    .list(listAddress)
1486                                                    .listArchive(listServer.getArchive())
1487                                                    .smtpServer(listServer.getSMTP())
1488                                                    .webrevStorageRepository(archive)
1489                                                    .webrevStorageRef(&quot;webrev&quot;)
1490                                                    .webrevStorageBase(Path.of(&quot;test&quot;))
1491                                                    .webrevStorageBaseUri(webrevServer.uri())
1492                                                    .issueTracker(URIBuilder.base(&quot;http://issues.test/browse/&quot;).build());
1493 
1494             // Populate the projects repository
1495             var reviewFile = Path.of(&quot;reviewfile.txt&quot;);
1496             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType(), reviewFile);
1497             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
1498             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
1499             localRepo.push(masterHash, archive.url(), &quot;webrev&quot;, true);
1500 
1501             // Make a change with a corresponding PR
1502             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;Line 1\nLine 2\nLine 3\nLine 4&quot;);
1503             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
1504             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
1505             pr.setBody(&quot;This is now ready&quot;);
1506 
1507             var mlBot = mlBotBuilder.build();
1508             var mlBotWithCooldown = mlBotBuilder.cooldown(Duration.ofDays(1)).build();
1509 
1510             TestBotRunner.runPeriodicItems(mlBot);
1511             listServer.processIncoming();
1512 
1513             // Make a comment
1514             pr.addComment(&quot;Looks good&quot;);
1515 
1516             // Bot with cooldown configured should not bridge the comment
1517             TestBotRunner.runPeriodicItems(mlBotWithCooldown);
1518             assertThrows(RuntimeException.class, () -&gt; listServer.processIncoming(Duration.ofMillis(1)));
1519 
1520             // But without, it should
1521             TestBotRunner.runPeriodicItems(mlBot);
1522             listServer.processIncoming();
1523 
1524             // Check the archive
1525             Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);
1526             assertTrue(archiveContains(archiveFolder.path(), &quot;Looks good&quot;));
1527         }
1528     }
1529 
1530     @Test
1531     void cooldownNewRevision(TestInfo testInfo) throws IOException {
1532         try (var credentials = new HostCredentials(testInfo);
1533              var tempFolder = new TemporaryDirectory();
1534              var archiveFolder = new TemporaryDirectory();
1535              var listServer = new TestMailmanServer();
1536              var webrevServer = new TestWebrevServer()) {
1537             var bot = credentials.getHostedRepository();
1538             var author = credentials.getHostedRepository();
1539             var archive = credentials.getHostedRepository();
1540             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
1541             var censusBuilder = credentials.getCensusBuilder()
1542                                            .addAuthor(author.forge().currentUser().id());
1543             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
1544             var mlBotBuilder = MailingListBridgeBot.newBuilder()
1545                                                    .from(from)
1546                                                    .repo(bot)
1547                                                    .ignoredUsers(Set.of(bot.forge().currentUser().userName()))
1548                                                    .archive(archive)
1549                                                    .censusRepo(censusBuilder.build())
1550                                                    .list(listAddress)
1551                                                    .listArchive(listServer.getArchive())
1552                                                    .smtpServer(listServer.getSMTP())
1553                                                    .webrevStorageRepository(archive)
1554                                                    .webrevStorageRef(&quot;webrev&quot;)
1555                                                    .webrevStorageBase(Path.of(&quot;test&quot;))
1556                                                    .webrevStorageBaseUri(webrevServer.uri())
1557                                                    .issueTracker(URIBuilder.base(&quot;http://issues.test/browse/&quot;).build());
1558 
1559             // Populate the projects repository
1560             var reviewFile = Path.of(&quot;reviewfile.txt&quot;);
1561             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType(), reviewFile);
1562             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
1563             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
1564             localRepo.push(masterHash, archive.url(), &quot;webrev&quot;, true);
1565 
1566             // Make a change with a corresponding PR
1567             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;Line 1\nLine 2\nLine 3\nLine 4&quot;);
1568             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
1569             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
1570             pr.setBody(&quot;This is now ready&quot;);
1571 
1572             var mlBot = mlBotBuilder.build();
1573             var mlBotWithCooldown = mlBotBuilder.cooldown(Duration.ofDays(1)).build();
1574 
1575             TestBotRunner.runPeriodicItems(mlBot);
1576             listServer.processIncoming();
1577 
1578             // Commit another revision
1579             var updatedHash = CheckableRepository.appendAndCommit(localRepo, &quot;More stuff&quot;);
1580             localRepo.push(updatedHash, author.url(), &quot;edit&quot;);
1581 
1582             // Bot with cooldown configured should not create a new webrev
1583             TestBotRunner.runPeriodicItems(mlBotWithCooldown);
1584             assertThrows(RuntimeException.class, () -&gt; listServer.processIncoming(Duration.ofMillis(1)));
1585 
1586             // But without, it should
1587             TestBotRunner.runPeriodicItems(mlBot);
1588             listServer.processIncoming();
1589 
1590             // Check the archive
1591             Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);
1592             assertTrue(archiveContains(archiveFolder.path(), &quot;webrev.01&quot;));
1593         }
1594     }
1595 
1596     @Test
1597     void retryAfterCooldown(TestInfo testInfo) throws IOException, InterruptedException {
1598         try (var credentials = new HostCredentials(testInfo);
1599              var tempFolder = new TemporaryDirectory();
1600              var archiveFolder = new TemporaryDirectory();
1601              var listServer = new TestMailmanServer();
1602              var webrevServer = new TestWebrevServer()) {
1603             var bot = credentials.getHostedRepository();
1604             var author = credentials.getHostedRepository();
1605             var archive = credentials.getHostedRepository();
1606             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
1607             var censusBuilder = credentials.getCensusBuilder()
1608                                            .addAuthor(author.forge().currentUser().id());
1609             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
1610             var cooldown = Duration.ofMillis(500);
1611             var mlBotBuilder = MailingListBridgeBot.newBuilder()
1612                                                    .from(from)
1613                                                    .repo(bot)
1614                                                    .ignoredUsers(Set.of(bot.forge().currentUser().userName()))
1615                                                    .archive(archive)
1616                                                    .censusRepo(censusBuilder.build())
1617                                                    .list(listAddress)
1618                                                    .listArchive(listServer.getArchive())
1619                                                    .smtpServer(listServer.getSMTP())
1620                                                    .webrevStorageRepository(archive)
1621                                                    .webrevStorageRef(&quot;webrev&quot;)
1622                                                    .webrevStorageBase(Path.of(&quot;test&quot;))
1623                                                    .webrevStorageBaseUri(webrevServer.uri())
1624                                                    .issueTracker(URIBuilder.base(&quot;http://issues.test/browse/&quot;).build());
1625 
1626             // Populate the projects repository
1627             var reviewFile = Path.of(&quot;reviewfile.txt&quot;);
1628             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType(), reviewFile);
1629             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
1630             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
1631             localRepo.push(masterHash, archive.url(), &quot;webrev&quot;, true);
1632 
1633             // Make a change with a corresponding PR
1634             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;Line 1\nLine 2\nLine 3\nLine 4&quot;);
1635             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
1636             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
1637             pr.setBody(&quot;This is now ready&quot;);
1638 
1639             var mlBot = mlBotBuilder.cooldown(cooldown).build();
1640             Thread.sleep(cooldown.toMillis());
1641             TestBotRunner.runPeriodicItems(mlBot);
1642             listServer.processIncoming();
1643 
1644             // Make a comment and run the check within the cooldown period
1645             int counter;
1646             boolean noMailReceived = false;
1647             for (counter = 1; counter &lt; 10; ++counter) {
1648                 var start = Instant.now();
1649                 pr.addComment(&quot;Looks good - &quot; + counter + &quot; -&quot;);
1650 
1651                 // The bot should not bridge the comment due to cooldown
1652                 TestBotRunner.runPeriodicItems(mlBot);
1653                 try {
1654                     noMailReceived = false;
1655                     listServer.processIncoming(Duration.ofMillis(1));
1656                 } catch (RuntimeException e) {
1657                     noMailReceived = true;
1658                 }
1659                 var elapsed = Duration.between(start, Instant.now());
1660                 if (elapsed.compareTo(cooldown) &lt; 0) {
1661                     break;
1662                 } else {
1663                     log.info(&quot;Didn&#39;t do the test in time - retrying (elapsed: &quot; + elapsed + &quot; required: &quot; + cooldown + &quot;)&quot;);
1664                     // Ensure that the cooldown expires
1665                     Thread.sleep(cooldown.toMillis());
1666                     // If no mail was received, we have to flush it out
1667                     if (noMailReceived) {
1668                         TestBotRunner.runPeriodicItems(mlBot);
1669                         listServer.processIncoming();
1670                     }
1671                     cooldown = cooldown.multipliedBy(2);
1672                     mlBot = mlBotBuilder.cooldown(cooldown).build();
1673                 }
1674             }
1675             assertTrue(noMailReceived);
1676 
1677             // But after the cooldown period has passed, it should
1678             Thread.sleep(cooldown.toMillis());
1679             TestBotRunner.runPeriodicItems(mlBot);
1680             listServer.processIncoming();
1681 
1682             // Check the archive
1683             Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);
1684             assertTrue(archiveContains(archiveFolder.path(), &quot;Looks good - &quot; + counter + &quot; -&quot;));
1685         }
1686     }
1687 
1688     @Test
1689     void branchPrefix(TestInfo testInfo) throws IOException {
1690         try (var credentials = new HostCredentials(testInfo);
1691              var tempFolder = new TemporaryDirectory();
1692              var archiveFolder = new TemporaryDirectory();
1693              var listServer = new TestMailmanServer();
1694              var webrevServer = new TestWebrevServer()) {
1695             var author = credentials.getHostedRepository();
1696             var archive = credentials.getHostedRepository();
1697             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
1698             var censusBuilder = credentials.getCensusBuilder()
1699                                            .addAuthor(author.forge().currentUser().id());
1700             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
1701             var mlBot = MailingListBridgeBot.newBuilder()
1702                                             .from(from)
1703                                             .repo(author)
1704                                             .archive(archive)
1705                                             .censusRepo(censusBuilder.build())
1706                                             .list(listAddress)
1707                                             .listArchive(listServer.getArchive())
1708                                             .smtpServer(listServer.getSMTP())
1709                                             .webrevStorageRepository(archive)
1710                                             .webrevStorageRef(&quot;webrev&quot;)
1711                                             .webrevStorageBase(Path.of(&quot;test&quot;))
1712                                             .webrevStorageBaseUri(webrevServer.uri())
1713                                             .issueTracker(URIBuilder.base(&quot;http://issues.test/browse/&quot;).build())
1714                                             .branchInSubject(Pattern.compile(&quot;.*&quot;))
1715                                             .build();
1716 
1717             // Populate the projects repository
1718             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType());
1719             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
1720             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
1721             localRepo.push(masterHash, archive.url(), &quot;webrev&quot;, true);
1722 
1723             // Make a change with a corresponding PR
1724             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;A simple change&quot;,
1725                                                                &quot;Change msg\n\nWith several lines&quot;);
1726             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
1727             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;1234: This is a pull request&quot;);
1728             pr.setBody(&quot;This is a PR&quot;);
1729 
1730             // Run an archive pass
1731             TestBotRunner.runPeriodicItems(mlBot);
1732             listServer.processIncoming();
1733 
1734             pr.addComment(&quot;Looks good!&quot;);
1735             TestBotRunner.runPeriodicItems(mlBot);
1736             listServer.processIncoming();
1737 
1738             // Check the archive
1739             Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);
1740             assertTrue(archiveContains(archiveFolder.path(), &quot;Subject: \\[master\\] RFR: &quot;));
1741             assertTrue(archiveContains(archiveFolder.path(), &quot;Subject: Re: \\[master\\] RFR: &quot;));
1742         }
1743     }
1744 
1745     @Test
1746     void repoPrefix(TestInfo testInfo) throws IOException {
1747         try (var credentials = new HostCredentials(testInfo);
1748              var tempFolder = new TemporaryDirectory();
1749              var archiveFolder = new TemporaryDirectory();
1750              var listServer = new TestMailmanServer();
1751              var webrevServer = new TestWebrevServer()) {
1752             var author = credentials.getHostedRepository();
1753             var archive = credentials.getHostedRepository();
1754             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
1755             var censusBuilder = credentials.getCensusBuilder()
1756                                            .addAuthor(author.forge().currentUser().id());
1757             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
1758             var mlBot = MailingListBridgeBot.newBuilder()
1759                                             .from(from)
1760                                             .repo(author)
1761                                             .archive(archive)
1762                                             .censusRepo(censusBuilder.build())
1763                                             .list(listAddress)
1764                                             .listArchive(listServer.getArchive())
1765                                             .smtpServer(listServer.getSMTP())
1766                                             .webrevStorageRepository(archive)
1767                                             .webrevStorageRef(&quot;webrev&quot;)
1768                                             .webrevStorageBase(Path.of(&quot;test&quot;))
1769                                             .webrevStorageBaseUri(webrevServer.uri())
1770                                             .issueTracker(URIBuilder.base(&quot;http://issues.test/browse/&quot;).build())
1771                                             .repoInSubject(true)
1772                                             .build();
1773 
1774             // Populate the projects repository
1775             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType());
1776             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
1777             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
1778             localRepo.push(masterHash, archive.url(), &quot;webrev&quot;, true);
1779 
1780             // Make a change with a corresponding PR
1781             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;A simple change&quot;,
1782                                                                &quot;Change msg\n\nWith several lines&quot;);
1783             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
1784             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;1234: This is a pull request&quot;);
1785             pr.setBody(&quot;This is a PR&quot;);
1786 
1787             // Run an archive pass
1788             TestBotRunner.runPeriodicItems(mlBot);
1789             listServer.processIncoming();
1790 
1791             pr.addComment(&quot;Looks good!&quot;);
1792             TestBotRunner.runPeriodicItems(mlBot);
1793             listServer.processIncoming();
1794 
1795             // Check the archive
1796             Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);
1797             assertTrue(archiveContains(archiveFolder.path(), &quot;Subject: \\[&quot; + pr.repository().name() + &quot;\\] RFR: &quot;));
1798             assertTrue(archiveContains(archiveFolder.path(), &quot;Subject: Re: \\[&quot; + pr.repository().name() + &quot;\\] RFR: &quot;));
1799         }
1800     }
1801 
1802     @Test
1803     void repoAndBranchPrefix(TestInfo testInfo) throws IOException {
1804         try (var credentials = new HostCredentials(testInfo);
1805              var tempFolder = new TemporaryDirectory();
1806              var archiveFolder = new TemporaryDirectory();
1807              var listServer = new TestMailmanServer();
1808              var webrevServer = new TestWebrevServer()) {
1809             var author = credentials.getHostedRepository();
1810             var archive = credentials.getHostedRepository();
1811             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
1812             var censusBuilder = credentials.getCensusBuilder()
1813                                            .addAuthor(author.forge().currentUser().id());
1814             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
1815             var mlBot = MailingListBridgeBot.newBuilder()
1816                                             .from(from)
1817                                             .repo(author)
1818                                             .archive(archive)
1819                                             .censusRepo(censusBuilder.build())
1820                                             .list(listAddress)
1821                                             .listArchive(listServer.getArchive())
1822                                             .smtpServer(listServer.getSMTP())
1823                                             .webrevStorageRepository(archive)
1824                                             .webrevStorageRef(&quot;webrev&quot;)
1825                                             .webrevStorageBase(Path.of(&quot;test&quot;))
1826                                             .webrevStorageBaseUri(webrevServer.uri())
1827                                             .issueTracker(URIBuilder.base(&quot;http://issues.test/browse/&quot;).build())
1828                                             .repoInSubject(true)
1829                                             .branchInSubject(Pattern.compile(&quot;.*&quot;))
1830                                             .build();
1831 
1832             // Populate the projects repository
1833             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType());
1834             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
1835             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
1836             localRepo.push(masterHash, archive.url(), &quot;webrev&quot;, true);
1837 
1838             // Make a change with a corresponding PR
1839             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;A simple change&quot;,
1840                                                                &quot;Change msg\n\nWith several lines&quot;);
1841             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
1842             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;1234: This is a pull request&quot;);
1843             pr.setBody(&quot;This is a PR&quot;);
1844 
1845             // Run an archive pass
1846             TestBotRunner.runPeriodicItems(mlBot);
1847             listServer.processIncoming();
1848 
1849             pr.addComment(&quot;Looks good!&quot;);
1850             TestBotRunner.runPeriodicItems(mlBot);
1851             listServer.processIncoming();
1852 
1853             // Check the archive
1854             Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);
1855             assertTrue(archiveContains(archiveFolder.path(), &quot;Subject: \\[&quot; + pr.repository().name() + &quot;:master\\] RFR: &quot;));
1856             assertTrue(archiveContains(archiveFolder.path(), &quot;Subject: Re: \\[&quot; + pr.repository().name() + &quot;:master\\] RFR: &quot;));
1857         }
1858     }
1859 
1860     @Test
1861     void retryNewRevisionAfterCooldown(TestInfo testInfo) throws IOException, InterruptedException {
1862         try (var credentials = new HostCredentials(testInfo);
1863              var tempFolder = new TemporaryDirectory();
1864              var archiveFolder = new TemporaryDirectory();
1865              var listServer = new TestMailmanServer();
1866              var webrevServer = new TestWebrevServer()) {
1867             var bot = credentials.getHostedRepository();
1868             var author = credentials.getHostedRepository();
1869             var archive = credentials.getHostedRepository();
1870             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
1871             var censusBuilder = credentials.getCensusBuilder()
1872                                            .addAuthor(author.forge().currentUser().id());
1873             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
1874             var cooldown = Duration.ofMillis(500);
1875             var mlBotBuilder = MailingListBridgeBot.newBuilder()
1876                                                    .from(from)
1877                                                    .repo(bot)
1878                                                    .ignoredUsers(Set.of(bot.forge().currentUser().userName()))
1879                                                    .archive(archive)
1880                                                    .censusRepo(censusBuilder.build())
1881                                                    .list(listAddress)
1882                                                    .listArchive(listServer.getArchive())
1883                                                    .smtpServer(listServer.getSMTP())
1884                                                    .webrevStorageRepository(archive)
1885                                                    .webrevStorageRef(&quot;webrev&quot;)
1886                                                    .webrevStorageBase(Path.of(&quot;test&quot;))
1887                                                    .webrevStorageBaseUri(webrevServer.uri())
1888                                                    .issueTracker(URIBuilder.base(&quot;http://issues.test/browse/&quot;).build());
1889 
1890             // Populate the projects repository
1891             var reviewFile = Path.of(&quot;reviewfile.txt&quot;);
1892             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType(), reviewFile);
1893             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
1894             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
1895             localRepo.push(masterHash, archive.url(), &quot;webrev&quot;, true);
1896 
1897             // Make a change with a corresponding PR
1898             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;Line 1\nLine 2\nLine 3\nLine 4&quot;);
1899             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
1900             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
1901             pr.setBody(&quot;This is now ready&quot;);
1902 
1903             var mlBot = mlBotBuilder.cooldown(cooldown).build();
1904             Thread.sleep(cooldown.toMillis());
1905             TestBotRunner.runPeriodicItems(mlBot);
1906             listServer.processIncoming();
1907 
1908             // Make a new revision and run the check within the cooldown period
1909             int counter;
1910             boolean noMailReceived = false;
1911             for (counter = 1; counter &lt; 10; ++counter) {
1912                 var start = Instant.now();
1913                 var revHash = CheckableRepository.appendAndCommit(localRepo, &quot;more stuff&quot;, &quot;Update number - &quot; + counter + &quot; -&quot;);
1914                 localRepo.push(revHash, author.url(), &quot;edit&quot;);
1915 
1916                 // The bot should not bridge the new revision due to cooldown
1917                 TestBotRunner.runPeriodicItems(mlBot);
1918                 try {
1919                     noMailReceived = false;
1920                     listServer.processIncoming(Duration.ofMillis(1));
1921                 } catch (RuntimeException e) {
1922                     noMailReceived = true;
1923                 }
1924                 var elapsed = Duration.between(start, Instant.now());
1925                 if (elapsed.compareTo(cooldown) &lt; 0) {
1926                     break;
1927                 } else {
1928                     log.info(&quot;Didn&#39;t do the test in time - retrying (elapsed: &quot; + elapsed + &quot; required: &quot; + cooldown + &quot;)&quot;);
1929                     // Ensure that the cooldown expires
1930                     Thread.sleep(cooldown.toMillis());
1931                     // If no mail was received, we have to flush it out
1932                     if (noMailReceived) {
1933                         TestBotRunner.runPeriodicItems(mlBot);
1934                         listServer.processIncoming();
1935                     }
1936                     cooldown = cooldown.multipliedBy(2);
1937                     mlBot = mlBotBuilder.cooldown(cooldown).build();
1938                 }
1939             }
1940             assertTrue(noMailReceived);
1941 
1942             // But after the cooldown period has passed, it should
1943             Thread.sleep(cooldown.toMillis());
1944             TestBotRunner.runPeriodicItems(mlBot);
1945             listServer.processIncoming();
1946 
1947             // Check the archive
1948             Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);
1949             assertTrue(archiveContains(archiveFolder.path(), &quot;Update number - &quot; + counter + &quot; -&quot;));
1950         }
1951     }
1952 }
    </pre>
  </body>
</html>