<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>New bots/mlbridge/src/test/java/org/openjdk/skara/bots/mlbridge/MailingListBridgeBotTests.java</title>
    <link rel="stylesheet" href="../../../../../../../../../../style.css" />
  </head>
  <body>
    <pre>
   1 /*
   2  * Copyright (c) 2019, Oracle and/or its affiliates. All rights reserved.
   3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   4  *
   5  * This code is free software; you can redistribute it and/or modify it
   6  * under the terms of the GNU General Public License version 2 only, as
   7  * published by the Free Software Foundation.
   8  *
   9  * This code is distributed in the hope that it will be useful, but WITHOUT
  10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
  11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
  12  * version 2 for more details (a copy is included in the LICENSE file that
  13  * accompanied this code).
  14  *
  15  * You should have received a copy of the GNU General Public License version
  16  * 2 along with this work; if not, write to the Free Software Foundation,
  17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
  18  *
  19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
  20  * or visit www.oracle.com if you need additional information or have any
  21  * questions.
  22  */
  23 package org.openjdk.skara.bots.mlbridge;
  24 
  25 import org.openjdk.skara.email.EmailAddress;
  26 import org.openjdk.skara.host.*;
  27 import org.openjdk.skara.host.network.URIBuilder;
  28 import org.openjdk.skara.mailinglist.MailingListServerFactory;
  29 import org.openjdk.skara.test.*;
  30 import org.openjdk.skara.vcs.Repository;
  31 
  32 import org.junit.jupiter.api.*;
  33 
  34 import java.io.IOException;
  35 import java.nio.charset.StandardCharsets;
  36 import java.nio.file.*;
  37 import java.time.Duration;
  38 import java.util.*;
  39 import java.util.regex.Pattern;
  40 import java.util.stream.Collectors;
  41 
  42 import static org.junit.jupiter.api.Assertions.*;
  43 
  44 class MailingListBridgeBotTests {
  45     private Optional&lt;String&gt; archiveContents(Path archive) {
  46         try {
  47             var mbox = Files.find(archive, 50, (path, attrs) -&gt; path.toString().endsWith(&quot;.mbox&quot;)).findAny();
  48             if (mbox.isEmpty()) {
  49                 return Optional.empty();
  50             }
  51             return Optional.of(Files.readString(mbox.get(), StandardCharsets.UTF_8));
  52         } catch (IOException e) {
  53             return Optional.empty();
  54         }
  55 
  56     }
  57 
  58     private boolean archiveContains(Path archive, String text) {
  59         return archiveContainsCount(archive, text) &gt; 0;
  60     }
  61 
  62     private int archiveContainsCount(Path archive, String text) {
  63         var lines = archiveContents(archive);
  64         if (lines.isEmpty()) {
  65             return 0;
  66         }
  67         var pattern = Pattern.compile(text);
  68         int count = 0;
  69         for (var line : lines.get().split(&quot;\\R&quot;)) {
  70             var matcher = pattern.matcher(line);
  71             if (matcher.find()) {
  72                 count++;
  73             }
  74         }
  75         return count;
  76     }
  77 
  78     private boolean webrevContains(Path webrev, String text) {
  79         try {
  80             var index = Files.find(webrev, 5, (path, attrs) -&gt; path.toString().endsWith(&quot;index.html&quot;)).findAny();
  81             if (index.isEmpty()) {
  82                 return false;
  83             }
  84             var lines = Files.readString(index.get(), StandardCharsets.UTF_8);
  85             return lines.contains(text);
  86         } catch (IOException e) {
  87             return false;
  88         }
  89     }
  90 
  91     private long countSubstrings(String string, String substring) {
  92         return Pattern.compile(substring).matcher(string).results().count();
  93     }
  94 
  95     private String noreplyAddress(HostedRepository repository) {
  96         return &quot;test+&quot; + repository.host().getCurrentUserDetails().id() + &quot;+&quot; +
  97                 repository.host().getCurrentUserDetails().userName() +
  98                 &quot;@openjdk.java.net&quot;;
  99     }
 100 
 101     @Test
 102     void simpleArchive(TestInfo testInfo) throws IOException {
 103         try (var credentials = new HostCredentials(testInfo);
 104              var tempFolder = new TemporaryDirectory();
 105              var archiveFolder = new TemporaryDirectory();
 106              var webrevFolder = new TemporaryDirectory();
 107              var listServer = new TestMailmanServer()) {
 108             var author = credentials.getHostedRepository();
 109             var archive = credentials.getHostedRepository();
 110             var ignored = credentials.getHostedRepository();
 111             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
 112             var censusBuilder = credentials.getCensusBuilder()
 113                                            .addAuthor(author.host().getCurrentUserDetails().id());
 114             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
 115             var mlBot = new MailingListBridgeBot(from, author, archive, censusBuilder.build(), &quot;master&quot;, listAddress,
 116                                                  Set.of(ignored.host().getCurrentUserDetails().userName()),
 117                                                  Set.of(),
 118                                                  listServer.getArchive(), listServer.getSMTP(),
 119                                                  archive, &quot;webrev&quot;, Path.of(&quot;test&quot;),
 120                                                  URIBuilder.base(&quot;http://www.test.test/&quot;).build(),
 121                                                  Set.of(&quot;rfr&quot;), Map.of(ignored.host().getCurrentUserDetails().userName(),
 122                                                                        Pattern.compile(&quot;ready&quot;)),
 123                                                  URIBuilder.base(&quot;http://issues.test/browse/&quot;).build(),
 124                                                  Map.of(&quot;Extra1&quot;, &quot;val1&quot;, &quot;Extra2&quot;, &quot;val2&quot;));
 125 
 126             // Populate the projects repository
 127             var localRepo = CheckableRepository.init(tempFolder.path(), author.getRepositoryType());
 128             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
 129             localRepo.push(masterHash, author.getUrl(), &quot;master&quot;, true);
 130             localRepo.push(masterHash, archive.getUrl(), &quot;webrev&quot;, true);
 131 
 132             // Make a change with a corresponding PR
 133             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;A simple change&quot;,
 134                                                                &quot;Change msg\n\nWith several lines&quot;);
 135             localRepo.push(editHash, author.getUrl(), &quot;edit&quot;, true);
 136             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;1234: This is a pull request&quot;);
 137             pr.setBody(&quot;This should not be ready&quot;);
 138 
 139             // Run an archive pass
 140             TestBotRunner.runPeriodicItems(mlBot);
 141 
 142             // A PR that isn&#39;t ready for review should not be archived
 143             Repository.materialize(archiveFolder.path(), archive.getUrl(), &quot;master&quot;);
 144             assertFalse(archiveContains(archiveFolder.path(), &quot;This is a pull request&quot;));
 145 
 146             // Flag it as ready for review
 147             pr.setBody(&quot;This should now be ready&quot;);
 148             pr.addLabel(&quot;rfr&quot;);
 149 
 150             // Run another archive pass
 151             TestBotRunner.runPeriodicItems(mlBot);
 152 
 153             // But it should still not be archived
 154             Repository.materialize(archiveFolder.path(), archive.getUrl(), &quot;master&quot;);
 155             assertFalse(archiveContains(archiveFolder.path(), &quot;This is a pull request&quot;));
 156 
 157             // Now post a general comment - not a ready marker
 158             var ignoredPr = ignored.getPullRequest(pr.getId());
 159             ignoredPr.addComment(&quot;hello there&quot;);
 160 
 161             // Run another archive pass
 162             TestBotRunner.runPeriodicItems(mlBot);
 163 
 164             // It should still not be archived
 165             Repository.materialize(archiveFolder.path(), archive.getUrl(), &quot;master&quot;);
 166             assertFalse(archiveContains(archiveFolder.path(), &quot;This is a pull request&quot;));
 167 
 168             // Now post a ready comment
 169             ignoredPr.addComment(&quot;ready&quot;);
 170 
 171             // Run another archive pass
 172             TestBotRunner.runPeriodicItems(mlBot);
 173 
 174             // The archive should now contain an entry
 175             Repository.materialize(archiveFolder.path(), archive.getUrl(), &quot;master&quot;);
 176             assertTrue(archiveContains(archiveFolder.path(), &quot;This is a pull request&quot;));
 177             assertTrue(archiveContains(archiveFolder.path(), &quot;This should now be ready&quot;));
 178             assertTrue(archiveContains(archiveFolder.path(), &quot;Patch:&quot;));
 179             assertTrue(archiveContains(archiveFolder.path(), &quot;Changes:&quot;));
 180             assertTrue(archiveContains(archiveFolder.path(), &quot;Webrev:&quot;));
 181             assertTrue(archiveContains(archiveFolder.path(), &quot;http://www.test.test/&quot;));
 182             assertTrue(archiveContains(archiveFolder.path(), &quot;webrev.00&quot;));
 183             assertTrue(archiveContains(archiveFolder.path(), &quot;Issue:&quot;));
 184             assertTrue(archiveContains(archiveFolder.path(), &quot;http://issues.test/browse/TSTPRJ-1234&quot;));
 185             assertTrue(archiveContains(archiveFolder.path(), &quot;Fetch:&quot;));
 186             assertTrue(archiveContains(archiveFolder.path(), &quot;^ - &quot; + editHash.abbreviate() + &quot;: Change msg&quot;));
 187             assertFalse(archiveContains(archiveFolder.path(), &quot;With several lines&quot;));
 188 
 189             // The mailing list as well
 190             listServer.processIncoming();
 191             var mailmanServer = MailingListServerFactory.createMailmanServer(listServer.getArchive(), listServer.getSMTP());
 192             var mailmanList = mailmanServer.getList(listAddress.address());
 193             var conversations = mailmanList.conversations(Duration.ofDays(1));
 194             assertEquals(1, conversations.size());
 195             var mail = conversations.get(0).first();
 196             assertEquals(&quot;RFR: 1234: This is a pull request&quot;, mail.subject());
 197             assertEquals(pr.getAuthor().fullName(), mail.author().fullName().orElseThrow());
 198             assertEquals(noreplyAddress(archive), mail.author().address());
 199             assertEquals(from, mail.sender());
 200             assertEquals(&quot;val1&quot;, mail.headerValue(&quot;Extra1&quot;));
 201             assertEquals(&quot;val2&quot;, mail.headerValue(&quot;Extra2&quot;));
 202 
 203             // And there should be a webrev
 204             Repository.materialize(webrevFolder.path(), archive.getUrl(), &quot;webrev&quot;);
 205             assertTrue(webrevContains(webrevFolder.path(), &quot;1 lines changed&quot;));
 206             var comments = pr.getComments();
 207             var webrevComments = comments.stream()
 208                                          .filter(comment -&gt; comment.author().equals(author.host().getCurrentUserDetails()))
 209                                          .filter(comment -&gt; comment.body().contains(&quot;webrev&quot;))
 210                                          .filter(comment -&gt; comment.body().contains(editHash.hex()))
 211                                          .collect(Collectors.toList());
 212             assertEquals(1, webrevComments.size());
 213 
 214             // Add a comment
 215             pr.addComment(&quot;This is a comment :smile:&quot;);
 216 
 217             // Add a comment from an ignored user as well
 218             ignoredPr.addComment(&quot;Don&#39;t mind me&quot;);
 219 
 220             // Run another archive pass
 221             TestBotRunner.runPeriodicItems(mlBot);
 222 
 223             // The archive should now contain the comment, but not the ignored one
 224             Repository.materialize(archiveFolder.path(), archive.getUrl(), &quot;master&quot;);
 225             assertTrue(archiveContains(archiveFolder.path(), &quot;This is a comment&quot;));
 226             assertTrue(archiveContains(archiveFolder.path(), &quot;&gt; This should now be ready&quot;));
 227             assertFalse(archiveContains(archiveFolder.path(), &quot;Don&#39;t mind me&quot;));
 228 
 229             listServer.processIncoming();
 230             conversations = mailmanList.conversations(Duration.ofDays(1));
 231             assertEquals(1, conversations.size());
 232             assertEquals(2, conversations.get(0).allMessages().size());
 233 
 234             // Remove the rfr flag and post another comment
 235             pr.addLabel(&quot;rfr&quot;);
 236             pr.addComment(&quot;This is another comment&quot;);
 237 
 238             // Run another archive pass
 239             TestBotRunner.runPeriodicItems(mlBot);
 240 
 241             // The archive should contain the additional comment
 242             Repository.materialize(archiveFolder.path(), archive.getUrl(), &quot;master&quot;);
 243             assertTrue(archiveContains(archiveFolder.path(), &quot;This is another comment&quot;));
 244             assertTrue(archiveContains(archiveFolder.path(), &quot;&gt;&gt; This should now be ready&quot;));
 245 
 246             listServer.processIncoming();
 247             conversations = mailmanList.conversations(Duration.ofDays(1));
 248             assertEquals(1, conversations.size());
 249             assertEquals(3, conversations.get(0).allMessages().size());
 250             for (var newMail : conversations.get(0).allMessages()) {
 251                 assertEquals(noreplyAddress(archive), newMail.author().address());
 252                 assertEquals(from, newMail.sender());
 253             }
 254             assertTrue(conversations.get(0).allMessages().get(2).body().contains(&quot;This is a comment ðŸ˜„&quot;));
 255         }
 256     }
 257 
 258     @Test
 259     void reviewComment(TestInfo testInfo) throws IOException {
 260         try (var credentials = new HostCredentials(testInfo);
 261              var tempFolder = new TemporaryDirectory();
 262              var archiveFolder = new TemporaryDirectory();
 263              var listServer = new TestMailmanServer()) {
 264             var author = credentials.getHostedRepository();
 265             var archive = credentials.getHostedRepository();
 266             var ignored = credentials.getHostedRepository();
 267             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
 268             var censusBuilder = credentials.getCensusBuilder()
 269                                            .addAuthor(author.host().getCurrentUserDetails().id());
 270             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
 271             var mlBot = new MailingListBridgeBot(from, author, archive, censusBuilder.build(), &quot;master&quot;, listAddress,
 272                                                  Set.of(ignored.host().getCurrentUserDetails().userName()),
 273                                                  Set.of(),
 274                                                  listServer.getArchive(), listServer.getSMTP(),
 275                                                  archive, &quot;webrev&quot;, Path.of(&quot;test&quot;),
 276                                                  URIBuilder.base(&quot;http://www.test.test/&quot;).build(),
 277                                                  Set.of(), Map.of(),
 278                                                  URIBuilder.base(&quot;http://issues.test/browse/&quot;).build(),
 279                                                  Map.of());
 280 
 281             // Populate the projects repository
 282             var reviewFile = Path.of(&quot;reviewfile.txt&quot;);
 283             var localRepo = CheckableRepository.init(tempFolder.path(), author.getRepositoryType(), reviewFile);
 284             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
 285             localRepo.push(masterHash, author.getUrl(), &quot;master&quot;, true);
 286             localRepo.push(masterHash, archive.getUrl(), &quot;webrev&quot;, true);
 287 
 288             // Make a change with a corresponding PR
 289             var editHash = CheckableRepository.appendAndCommit(localRepo);
 290             localRepo.push(editHash, author.getUrl(), &quot;edit&quot;, true);
 291             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
 292             pr.setBody(&quot;This is now ready&quot;);
 293             TestBotRunner.runPeriodicItems(mlBot);
 294             listServer.processIncoming();
 295 
 296             // And make a file specific comment
 297             var currentMaster = localRepo.resolve(&quot;master&quot;).orElseThrow();
 298             var comment = pr.addReviewComment(masterHash, editHash, reviewFile.toString(), 2, &quot;Review comment&quot;);
 299 
 300             // Add one from an ignored user as well
 301             var ignoredPr = ignored.getPullRequest(pr.getId());
 302             ignoredPr.addReviewComment(masterHash, editHash, reviewFile.toString(), 2, &quot;Don&#39;t mind me&quot;);
 303 
 304             // Process comments
 305             TestBotRunner.runPeriodicItems(mlBot);
 306             listServer.processIncoming();
 307 
 308             // The archive should now contain an entry
 309             Repository.materialize(archiveFolder.path(), archive.getUrl(), &quot;master&quot;);
 310             assertTrue(archiveContains(archiveFolder.path(), &quot;This is a pull request&quot;));
 311             assertTrue(archiveContains(archiveFolder.path(), &quot;This is now ready&quot;));
 312             assertTrue(archiveContains(archiveFolder.path(), &quot;Review comment&quot;));
 313             assertTrue(archiveContains(archiveFolder.path(), &quot;&gt; This is now ready&quot;));
 314             assertTrue(archiveContains(archiveFolder.path(), reviewFile.toString()));
 315             assertFalse(archiveContains(archiveFolder.path(), &quot;Don&#39;t mind me&quot;));
 316 
 317             // The mailing list as well
 318             var mailmanServer = MailingListServerFactory.createMailmanServer(listServer.getArchive(), listServer.getSMTP());
 319             var mailmanList = mailmanServer.getList(listAddress.address());
 320             var conversations = mailmanList.conversations(Duration.ofDays(1));
 321             assertEquals(1, conversations.size());
 322             var mail = conversations.get(0).first();
 323             assertEquals(&quot;RFR: This is a pull request&quot;, mail.subject());
 324 
 325             // Comment on the comment
 326             pr.addReviewCommentReply(comment, &quot;This is a review reply&quot;);
 327             TestBotRunner.runPeriodicItems(mlBot);
 328             listServer.processIncoming();
 329 
 330             // The archive should contain the additional comment (but no quoted footers)
 331             Repository.materialize(archiveFolder.path(), archive.getUrl(), &quot;master&quot;);
 332             assertTrue(archiveContains(archiveFolder.path(), &quot;This is a review reply&quot;));
 333             assertTrue(archiveContains(archiveFolder.path(), &quot;&gt;&gt; This is now ready&quot;));
 334             assertFalse(archiveContains(archiveFolder.path(), &quot;^&gt; PR:&quot;));
 335 
 336             // As well as the mailing list
 337             conversations = mailmanList.conversations(Duration.ofDays(1));
 338             assertEquals(1, conversations.size());
 339             assertEquals(3, conversations.get(0).allMessages().size());
 340             for (var newMail : conversations.get(0).allMessages()) {
 341                 assertEquals(noreplyAddress(archive), newMail.author().address());
 342                 assertEquals(from, newMail.sender());
 343             }
 344         }
 345     }
 346 
 347     @Test
 348     void combineComments(TestInfo testInfo) throws IOException {
 349         try (var credentials = new HostCredentials(testInfo);
 350              var tempFolder = new TemporaryDirectory();
 351              var archiveFolder = new TemporaryDirectory();
 352              var listServer = new TestMailmanServer()) {
 353             var author = credentials.getHostedRepository();
 354             var archive = credentials.getHostedRepository();
 355             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
 356             var censusBuilder = credentials.getCensusBuilder()
 357                                            .addAuthor(author.host().getCurrentUserDetails().id());
 358             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
 359             var mlBot = new MailingListBridgeBot(from, author, archive, censusBuilder.build(), &quot;master&quot;,
 360                                                  listAddress, Set.of(), Set.of(),
 361                                                  listServer.getArchive(),
 362                                                  listServer.getSMTP(),
 363                                                  archive, &quot;webrev&quot;, Path.of(&quot;test&quot;),
 364                                                  URIBuilder.base(&quot;http://www.test.test/&quot;).build(),
 365                                                  Set.of(), Map.of(),
 366                                                  URIBuilder.base(&quot;http://issues.test/browse/&quot;).build(),
 367                                                  Map.of());
 368 
 369             // Populate the projects repository
 370             var reviewFile = Path.of(&quot;reviewfile.txt&quot;);
 371             var localRepo = CheckableRepository.init(tempFolder.path(), author.getRepositoryType(), reviewFile);
 372             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
 373             localRepo.push(masterHash, author.getUrl(), &quot;master&quot;, true);
 374             localRepo.push(masterHash, archive.getUrl(), &quot;webrev&quot;, true);
 375 
 376             // Make a change with a corresponding PR
 377             var editHash = CheckableRepository.appendAndCommit(localRepo);
 378             localRepo.push(editHash, author.getUrl(), &quot;edit&quot;, true);
 379             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
 380             pr.setBody(&quot;This is now ready&quot;);
 381             pr.addComment(&quot;Avoid combining&quot;);
 382 
 383             TestBotRunner.runPeriodicItems(mlBot);
 384             listServer.processIncoming();
 385             listServer.processIncoming();
 386 
 387             // Make several file specific comments
 388             var first = pr.addReviewComment(masterHash, editHash, reviewFile.toString(), 2, &quot;Review comment&quot;);
 389             pr.addReviewComment(masterHash, editHash, reviewFile.toString(), 2, &quot;Another review comment&quot;);
 390             pr.addReviewComment(masterHash, editHash, reviewFile.toString(), 2, &quot;Further review comment&quot;);
 391             pr.addReviewComment(masterHash, editHash, reviewFile.toString(), 2, &quot;Final review comment&quot;);
 392             TestBotRunner.runPeriodicItems(mlBot);
 393             listServer.processIncoming();
 394 
 395             // The archive should contain a combined entry
 396             Repository.materialize(archiveFolder.path(), archive.getUrl(), &quot;master&quot;);
 397             assertEquals(2, archiveContainsCount(archiveFolder.path(), &quot;^On.*wrote:&quot;));
 398 
 399             // As well as the mailing list
 400             var mailmanServer = MailingListServerFactory.createMailmanServer(listServer.getArchive(), listServer.getSMTP());
 401             var mailmanList = mailmanServer.getList(listAddress.address());
 402             var conversations = mailmanList.conversations(Duration.ofDays(1));
 403             assertEquals(1, conversations.size());
 404             var mail = conversations.get(0).first();
 405             assertEquals(&quot;RFR: This is a pull request&quot;, mail.subject());
 406             assertEquals(3, conversations.get(0).allMessages().size());
 407 
 408             var commentReply = conversations.get(0).replies(mail).get(0);
 409             assertEquals(2, commentReply.body().split(&quot;^On.*wrote:&quot;).length);
 410             assertTrue(commentReply.body().contains(&quot;Avoid combining\n\n&quot;), commentReply.body());
 411 
 412             var reviewReply = conversations.get(0).replies(mail).get(1);
 413             assertEquals(2, reviewReply.body().split(&quot;^On.*wrote:&quot;).length);
 414             assertEquals(2, reviewReply.body().split(&quot;&gt; This is now ready&quot;).length, reviewReply.body());
 415             assertEquals(&quot;Re: RFR: This is a pull request&quot;, reviewReply.subject());
 416             assertTrue(reviewReply.body().contains(&quot;Review comment\n\n&quot;), reviewReply.body());
 417             assertTrue(reviewReply.body().contains(&quot;Another review comment&quot;), reviewReply.body());
 418 
 419             // Now reply to the first (collapsed) comment
 420             pr.addReviewCommentReply(first, &quot;I agree&quot;);
 421             TestBotRunner.runPeriodicItems(mlBot);
 422             listServer.processIncoming();
 423 
 424             // The archive should contain a new entry
 425             Repository.materialize(archiveFolder.path(), archive.getUrl(), &quot;master&quot;);
 426             assertEquals(3, archiveContainsCount(archiveFolder.path(), &quot;^On.*wrote:&quot;));
 427 
 428             // The combined review comments should only appear unquoted once
 429             assertEquals(1, archiveContainsCount(archiveFolder.path(), &quot;^Another review comment&quot;));
 430         }
 431     }
 432 
 433     @Test
 434     void commentThreading(TestInfo testInfo) throws IOException {
 435         try (var credentials = new HostCredentials(testInfo);
 436              var tempFolder = new TemporaryDirectory();
 437              var archiveFolder = new TemporaryDirectory();
 438              var listServer = new TestMailmanServer()) {
 439             var author = credentials.getHostedRepository();
 440             var reviewer = credentials.getHostedRepository();
 441             var archive = credentials.getHostedRepository();
 442             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
 443             var censusBuilder = credentials.getCensusBuilder()
 444                                            .addReviewer(reviewer.host().getCurrentUserDetails().id())
 445                                            .addAuthor(author.host().getCurrentUserDetails().id());
 446             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
 447             var mlBot = new MailingListBridgeBot(from, author, archive, censusBuilder.build(), &quot;master&quot;,
 448                                                  listAddress, Set.of(), Set.of(),
 449                                                  listServer.getArchive(),
 450                                                  listServer.getSMTP(),
 451                                                  archive, &quot;webrev&quot;, Path.of(&quot;test&quot;),
 452                                                  URIBuilder.base(&quot;http://www.test.test/&quot;).build(),
 453                                                  Set.of(), Map.of(),
 454                                                  URIBuilder.base(&quot;http://issues.test/browse/&quot;).build(),
 455                                                  Map.of());
 456 
 457             // Populate the projects repository
 458             var reviewFile = Path.of(&quot;reviewfile.txt&quot;);
 459             var localRepo = CheckableRepository.init(tempFolder.path(), author.getRepositoryType(), reviewFile);
 460             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
 461             localRepo.push(masterHash, author.getUrl(), &quot;master&quot;, true);
 462             localRepo.push(masterHash, archive.getUrl(), &quot;webrev&quot;, true);
 463 
 464             // Make a change with a corresponding PR
 465             var editHash = CheckableRepository.appendAndCommit(localRepo);
 466             localRepo.push(editHash, author.getUrl(), &quot;edit&quot;, true);
 467             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
 468             pr.setBody(&quot;This is now ready&quot;);
 469             TestBotRunner.runPeriodicItems(mlBot);
 470             listServer.processIncoming();
 471 
 472             // Make a file specific comment
 473             var reviewPr = reviewer.getPullRequest(pr.getId());
 474             var comment1 = reviewPr.addReviewComment(masterHash, editHash, reviewFile.toString(), 2, &quot;Review comment&quot;);
 475             pr.addReviewCommentReply(comment1, &quot;I agree&quot;);
 476             reviewPr.addReviewCommentReply(comment1, &quot;Great&quot;);
 477             TestBotRunner.runPeriodicItems(mlBot);
 478             listServer.processIncoming();
 479             listServer.processIncoming();
 480             listServer.processIncoming();
 481 
 482             // And a second one by ourselves
 483             var comment2 = pr.addReviewComment(masterHash, editHash, reviewFile.toString(), 2, &quot;Another review comment&quot;);
 484             reviewPr.addReviewCommentReply(comment2, &quot;Sounds good&quot;);
 485             pr.addReviewCommentReply(comment2, &quot;Thanks&quot;);
 486             TestBotRunner.runPeriodicItems(mlBot);
 487             listServer.processIncoming();
 488             listServer.processIncoming();
 489             listServer.processIncoming();
 490 
 491             // Finally some approvals and another comment
 492             pr.addReview(Review.Verdict.APPROVED, &quot;Nice&quot;);
 493             reviewPr.addReview(Review.Verdict.APPROVED, &quot;Looks fine&quot;);
 494             reviewPr.addReviewCommentReply(comment2, &quot;You are welcome&quot;);
 495             TestBotRunner.runPeriodicItems(mlBot);
 496             listServer.processIncoming();
 497             listServer.processIncoming();
 498             listServer.processIncoming();
 499 
 500             // Sanity check the archive
 501             Repository.materialize(archiveFolder.path(), archive.getUrl(), &quot;master&quot;);
 502             assertEquals(9, archiveContainsCount(archiveFolder.path(), &quot;^On.*wrote:&quot;));
 503 
 504             // File specific comments should appear before the approval
 505             var archiveText = archiveContents(archiveFolder.path()).orElseThrow();
 506             assertTrue(archiveText.indexOf(&quot;Looks fine&quot;) &gt; archiveText.indexOf(&quot;You are welcome&quot;));
 507 
 508             // Check the mailing list
 509             var mailmanServer = MailingListServerFactory.createMailmanServer(listServer.getArchive(), listServer.getSMTP());
 510             var mailmanList = mailmanServer.getList(listAddress.address());
 511             var conversations = mailmanList.conversations(Duration.ofDays(1));
 512             assertEquals(1, conversations.size());
 513             var mail = conversations.get(0).first();
 514             assertEquals(&quot;RFR: This is a pull request&quot;, mail.subject());
 515             assertEquals(10, conversations.get(0).allMessages().size());
 516 
 517             // There should be four separate threads
 518             var thread1 = conversations.get(0).replies(mail).get(0);
 519             assertEquals(2, thread1.body().split(&quot;^On.*wrote:&quot;).length);
 520             assertEquals(2, thread1.body().split(&quot;&gt; This is now ready&quot;).length, thread1.body());
 521             assertEquals(&quot;Re: RFR: This is a pull request&quot;, thread1.subject());
 522             assertTrue(thread1.body().contains(&quot;Review comment\n\n&quot;), thread1.body());
 523             assertFalse(thread1.body().contains(&quot;Another review comment&quot;), thread1.body());
 524             var thread1reply1 = conversations.get(0).replies(thread1).get(0);
 525             assertTrue(thread1reply1.body().contains(&quot;I agree&quot;));
 526             assertEquals(noreplyAddress(archive), thread1reply1.author().address());
 527             assertEquals(archive.host().getCurrentUserDetails().fullName(), thread1reply1.author().fullName().orElseThrow());
 528             var thread1reply2 = conversations.get(0).replies(thread1reply1).get(0);
 529             assertTrue(thread1reply2.body().contains(&quot;Great&quot;));
 530             assertEquals(&quot;integrationreviewer1@openjdk.java.net&quot;, thread1reply2.author().address());
 531             assertEquals(&quot;Generated Reviewer 1&quot;, thread1reply2.author().fullName().orElseThrow());
 532 
 533             var thread2 = conversations.get(0).replies(mail).get(1);
 534             assertEquals(2, thread2.body().split(&quot;^On.*wrote:&quot;).length);
 535             assertEquals(2, thread2.body().split(&quot;&gt; This is now ready&quot;).length, thread2.body());
 536             assertEquals(&quot;Re: RFR: This is a pull request&quot;, thread2.subject());
 537             assertFalse(thread2.body().contains(&quot;Review comment\n\n&quot;), thread2.body());
 538             assertTrue(thread2.body().contains(&quot;Another review comment&quot;), thread2.body());
 539             var thread2reply1 = conversations.get(0).replies(thread2).get(0);
 540             assertTrue(thread2reply1.body().contains(&quot;Sounds good&quot;));
 541             var thread2reply2 = conversations.get(0).replies(thread2reply1).get(0);
 542             assertTrue(thread2reply2.body().contains(&quot;Thanks&quot;));
 543 
 544             var replies = conversations.get(0).replies(mail);
 545             var thread3 = conversations.get(0).replies(mail).get(2);
 546             assertEquals(&quot;Re: RFR: This is a pull request&quot;, thread3.subject());
 547             var thread4 = conversations.get(0).replies(mail).get(3);
 548             assertEquals(&quot;Re: [Approved] RFR: This is a pull request&quot;, thread4.subject());
 549         }
 550     }
 551 
 552     @Test
 553     void reviewContext(TestInfo testInfo) throws IOException {
 554         try (var credentials = new HostCredentials(testInfo);
 555              var tempFolder = new TemporaryDirectory();
 556              var archiveFolder = new TemporaryDirectory();
 557              var listServer = new TestMailmanServer()) {
 558             var author = credentials.getHostedRepository();
 559             var archive = credentials.getHostedRepository();
 560             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
 561             var censusBuilder = credentials.getCensusBuilder()
 562                                            .addAuthor(author.host().getCurrentUserDetails().id());
 563             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
 564             var mlBot = new MailingListBridgeBot(from, author, archive, censusBuilder.build(), &quot;master&quot;,
 565                                                  listAddress, Set.of(), Set.of(),
 566                                                  listServer.getArchive(),
 567                                                  listServer.getSMTP(),
 568                                                  archive, &quot;webrev&quot;, Path.of(&quot;test&quot;),
 569                                                  URIBuilder.base(&quot;http://www.test.test/&quot;).build(),
 570                                                  Set.of(), Map.of(),
 571                                                  URIBuilder.base(&quot;http://issues.test/browse/&quot;).build(),
 572                                                  Map.of());
 573 
 574             // Populate the projects repository
 575             var reviewFile = Path.of(&quot;reviewfile.txt&quot;);
 576             var localRepo = CheckableRepository.init(tempFolder.path(), author.getRepositoryType(), reviewFile);
 577             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
 578             localRepo.push(masterHash, author.getUrl(), &quot;master&quot;, true);
 579             localRepo.push(masterHash, archive.getUrl(), &quot;webrev&quot;, true);
 580 
 581             // Make a change with a corresponding PR
 582             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;Line 1\nLine 2\nLine 3\nLine 4&quot;);
 583             localRepo.push(editHash, author.getUrl(), &quot;edit&quot;, true);
 584             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
 585             pr.setBody(&quot;This is now ready&quot;);
 586             TestBotRunner.runPeriodicItems(mlBot);
 587             listServer.processIncoming();
 588 
 589             // Make a file specific comment
 590             pr.addReviewComment(masterHash, editHash, reviewFile.toString(), 2, &quot;Review comment&quot;);
 591 
 592             TestBotRunner.runPeriodicItems(mlBot);
 593             listServer.processIncoming();
 594 
 595             // The archive should only contain context around line 2
 596             Repository.materialize(archiveFolder.path(), archive.getUrl(), &quot;master&quot;);
 597             assertTrue(archiveContains(archiveFolder.path(), &quot;^&gt; 2: Line 1$&quot;));
 598             assertTrue(archiveContains(archiveFolder.path(), &quot;^&gt; 3: Line 2$&quot;));
 599             assertFalse(archiveContains(archiveFolder.path(), &quot;^&gt; 4: Line 3$&quot;));
 600         }
 601     }
 602 
 603     @Test
 604     void multipleReviewContexts(TestInfo testInfo) throws IOException {
 605         try (var credentials = new HostCredentials(testInfo);
 606              var tempFolder = new TemporaryDirectory();
 607              var archiveFolder = new TemporaryDirectory();
 608              var listServer = new TestMailmanServer()) {
 609             var author = credentials.getHostedRepository();
 610             var archive = credentials.getHostedRepository();
 611             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
 612             var censusBuilder = credentials.getCensusBuilder()
 613                                            .addAuthor(author.host().getCurrentUserDetails().id());
 614             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
 615             var mlBot = new MailingListBridgeBot(from, author, archive, censusBuilder.build(), &quot;master&quot;,
 616                                                  listAddress, Set.of(), Set.of(),
 617                                                  listServer.getArchive(),
 618                                                  listServer.getSMTP(),
 619                                                  archive, &quot;webrev&quot;, Path.of(&quot;test&quot;),
 620                                                  URIBuilder.base(&quot;http://www.test.test/&quot;).build(),
 621                                                  Set.of(), Map.of(),
 622                                                  URIBuilder.base(&quot;http://issues.test/browse/&quot;).build(),
 623                                                  Map.of());
 624 
 625             // Populate the projects repository
 626             var reviewFile = Path.of(&quot;reviewfile.txt&quot;);
 627             var localRepo = CheckableRepository.init(tempFolder.path(), author.getRepositoryType(), reviewFile);
 628             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
 629             localRepo.push(masterHash, author.getUrl(), &quot;master&quot;, true);
 630             localRepo.push(masterHash, archive.getUrl(), &quot;webrev&quot;, true);
 631             var initialHash = CheckableRepository.appendAndCommit(localRepo,
 632                                                                   &quot;Line 0.1\nLine 0.2\nLine 0.3\nLine 0.4\n&quot; +
 633                                                                           &quot;Line 1\nLine 2\nLine 3\nLine 4\n&quot; +
 634                                                                           &quot;Line 5\nLine 6\nLine 7\nLine 8\n&quot; +
 635                                                                           &quot;Line 8.1\nLine 8.2\nLine 8.3\nLine 8.4\n&quot; +
 636                                                                           &quot;Line 9\nLine 10\nLine 11\nLine 12\n&quot; +
 637                                                                           &quot;Line 13\nLine 14\nLine 15\nLine 16\n&quot;);
 638             localRepo.push(initialHash, author.getUrl(), &quot;master&quot;);
 639 
 640             // Make a change with a corresponding PR
 641             var current = Files.readString(localRepo.root().resolve(reviewFile), StandardCharsets.UTF_8);
 642             var updated = current.replaceAll(&quot;Line 2&quot;, &quot;Line 2 edit\nLine 2.5&quot;);
 643             updated = updated.replaceAll(&quot;Line 13&quot;, &quot;Line 12.5\nLine 13 edit&quot;);
 644             Files.writeString(localRepo.root().resolve(reviewFile), updated, StandardCharsets.UTF_8);
 645             var editHash = CheckableRepository.appendAndCommit(localRepo);
 646             localRepo.push(editHash, author.getUrl(), &quot;edit&quot;, true);
 647             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
 648             pr.setBody(&quot;This is now ready&quot;);
 649             TestBotRunner.runPeriodicItems(mlBot);
 650             listServer.processIncoming();
 651 
 652             // Make file specific comments
 653             pr.addReviewComment(masterHash, editHash, reviewFile.toString(), 7, &quot;Review comment&quot;);
 654             pr.addReviewComment(masterHash, editHash, reviewFile.toString(), 24, &quot;Another review comment&quot;);
 655 
 656             TestBotRunner.runPeriodicItems(mlBot);
 657             listServer.processIncoming();
 658 
 659             // The archive should only contain context around line 2 and 20
 660             Repository.materialize(archiveFolder.path(), archive.getUrl(), &quot;master&quot;);
 661             assertTrue(archiveContains(archiveFolder.path(), &quot;reviewfile.txt line 7&quot;));
 662             assertTrue(archiveContains(archiveFolder.path(), &quot;^&gt; 6: Line 1$&quot;));
 663             assertTrue(archiveContains(archiveFolder.path(), &quot;^&gt; 7: Line 2 edit$&quot;));
 664             assertFalse(archiveContains(archiveFolder.path(), &quot;Line 3&quot;));
 665 
 666             assertTrue(archiveContains(archiveFolder.path(), &quot;reviewfile.txt line 24&quot;));
 667             assertTrue(archiveContains(archiveFolder.path(), &quot;^&gt; 23: Line 12.5$&quot;));
 668             assertTrue(archiveContains(archiveFolder.path(), &quot;^&gt; 24: Line 13 edit$&quot;));
 669             assertFalse(archiveContains(archiveFolder.path(), &quot;^Line 15&quot;));
 670         }
 671     }
 672 
 673     @Test
 674     void filterComments(TestInfo testInfo) throws IOException {
 675         try (var credentials = new HostCredentials(testInfo);
 676              var tempFolder = new TemporaryDirectory();
 677              var archiveFolder = new TemporaryDirectory();
 678              var listServer = new TestMailmanServer()) {
 679             var author = credentials.getHostedRepository();
 680             var archive = credentials.getHostedRepository();
 681             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
 682             var censusBuilder = credentials.getCensusBuilder()
 683                                            .addAuthor(author.host().getCurrentUserDetails().id());
 684             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
 685             var mlBot = new MailingListBridgeBot(from, author, archive, censusBuilder.build(), &quot;master&quot;,
 686                                                  listAddress, Set.of(), Set.of(),
 687                                                  listServer.getArchive(), listServer.getSMTP(),
 688                                                  archive, &quot;webrev&quot;, Path.of(&quot;test&quot;),
 689                                                  URIBuilder.base(&quot;http://www.test.test/&quot;).build(),
 690                                                  Set.of(), Map.of(),
 691                                                  URIBuilder.base(&quot;http://issues.test/browse/&quot;).build(),
 692                                                  Map.of());
 693 
 694             // Populate the projects repository
 695             var reviewFile = Path.of(&quot;reviewfile.txt&quot;);
 696             var localRepo = CheckableRepository.init(tempFolder.path(), author.getRepositoryType(), reviewFile);
 697             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
 698             localRepo.push(masterHash, author.getUrl(), &quot;master&quot;, true);
 699             localRepo.push(masterHash, archive.getUrl(), &quot;webrev&quot;, true);
 700 
 701             // Make a change with a corresponding PR
 702             var editHash = CheckableRepository.appendAndCommit(localRepo);
 703             localRepo.push(editHash, author.getUrl(), &quot;edit&quot;, true);
 704             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
 705             pr.setBody(&quot;This is now ready\n&lt;!-- this is a comment --&gt;\nAnd this is not\n&quot; +
 706                                &quot;&lt;!-- Anything below this marker will be hidden --&gt;\nStatus stuff&quot;);
 707 
 708             // Make a bunch of comments
 709             pr.addComment(&quot;Plain comment\n&lt;!-- this is a comment --&gt;&quot;);
 710             pr.addReviewComment(masterHash, editHash, reviewFile.toString(), 2, &quot;Review comment &lt;!-- this is a comment --&gt;\n&quot;);
 711             pr.addComment(&quot;/integrate stuff&quot;);
 712             TestBotRunner.runPeriodicItems(mlBot);
 713 
 714             // Run an archive pass
 715             TestBotRunner.runPeriodicItems(mlBot);
 716 
 717             // The archive should not contain the comment
 718             Repository.materialize(archiveFolder.path(), archive.getUrl(), &quot;master&quot;);
 719             assertTrue(archiveContains(archiveFolder.path(), &quot;This is now ready&quot;));
 720             assertFalse(archiveContains(archiveFolder.path(), &quot;this is a comment&quot;));
 721             assertFalse(archiveContains(archiveFolder.path(), &quot;Status stuff&quot;));
 722             assertTrue(archiveContains(archiveFolder.path(), &quot;And this is not&quot;));
 723             assertFalse(archiveContains(archiveFolder.path(), &quot;&lt;!--&quot;));
 724             assertFalse(archiveContains(archiveFolder.path(), &quot;--&gt;&quot;));
 725             assertTrue(archiveContains(archiveFolder.path(), &quot;Plain comment&quot;));
 726             assertTrue(archiveContains(archiveFolder.path(), &quot;Review comment&quot;));
 727             assertFalse(archiveContains(archiveFolder.path(), &quot;/integrate&quot;));
 728         }
 729     }
 730 
 731     @Test
 732     void incrementalChanges(TestInfo testInfo) throws IOException {
 733         try (var credentials = new HostCredentials(testInfo);
 734              var tempFolder = new TemporaryDirectory();
 735              var archiveFolder = new TemporaryDirectory();
 736              var listServer = new TestMailmanServer()) {
 737             var author = credentials.getHostedRepository();
 738             var archive = credentials.getHostedRepository();
 739             var commenter = credentials.getHostedRepository();
 740             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
 741             var censusBuilder = credentials.getCensusBuilder()
 742                                            .addAuthor(author.host().getCurrentUserDetails().id());
 743             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
 744             var mlBot = new MailingListBridgeBot(from, author, archive, censusBuilder.build(), &quot;master&quot;,
 745                                                  listAddress, Set.of(), Set.of(),
 746                                                  listServer.getArchive(), listServer.getSMTP(),
 747                                                  archive, &quot;webrev&quot;, Path.of(&quot;test&quot;),
 748                                                  URIBuilder.base(&quot;http://www.test.test/&quot;).build(),
 749                                                  Set.of(), Map.of(),
 750                                                  URIBuilder.base(&quot;http://issues.test/browse/&quot;).build(),
 751                                                  Map.of());
 752 
 753             // Populate the projects repository
 754             var reviewFile = Path.of(&quot;reviewfile.txt&quot;);
 755             var localRepo = CheckableRepository.init(tempFolder.path(), author.getRepositoryType(), reviewFile);
 756             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
 757             localRepo.push(masterHash, author.getUrl(), &quot;master&quot;, true);
 758             localRepo.push(masterHash, archive.getUrl(), &quot;webrev&quot;, true);
 759 
 760             // Make a change with a corresponding PR
 761             var editHash = CheckableRepository.appendAndCommit(localRepo);
 762             localRepo.push(editHash, author.getUrl(), &quot;edit&quot;, true);
 763             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
 764             pr.setBody(&quot;This is now ready&quot;);
 765 
 766             // Run an archive pass
 767             TestBotRunner.runPeriodicItems(mlBot);
 768             listServer.processIncoming();
 769 
 770             var nextHash = CheckableRepository.appendAndCommit(localRepo, &quot;Yet one more line&quot;, &quot;Fixing&quot;);
 771             localRepo.push(nextHash, author.getUrl(), &quot;edit&quot;);
 772 
 773             // Make sure that the push registered
 774             var lastHeadHash = pr.getHeadHash();
 775             var refreshCount = 0;
 776             do {
 777                 pr = author.getPullRequest(pr.getId());
 778                 if (refreshCount++ &gt; 100) {
 779                     fail(&quot;The PR did not update after the new push&quot;);
 780                 }
 781             } while (pr.getHeadHash().equals(lastHeadHash));
 782 
 783             // Run another archive pass
 784             TestBotRunner.runPeriodicItems(mlBot);
 785             TestBotRunner.runPeriodicItems(mlBot);
 786             TestBotRunner.runPeriodicItems(mlBot);
 787             listServer.processIncoming();
 788 
 789             // The archive should reference the updated push
 790             Repository.materialize(archiveFolder.path(), archive.getUrl(), &quot;master&quot;);
 791             assertTrue(archiveContains(archiveFolder.path(), &quot;additional changes&quot;));
 792             assertTrue(archiveContains(archiveFolder.path(), &quot;full.*/&quot; + pr.getId() + &quot;/webrev.01&quot;));
 793             assertTrue(archiveContains(archiveFolder.path(), &quot;inc.*/&quot; + pr.getId() + &quot;/webrev.00-01&quot;));
 794             assertTrue(archiveContains(archiveFolder.path(), &quot;Patch&quot;));
 795             assertTrue(archiveContains(archiveFolder.path(), &quot;Fetch&quot;));
 796             assertTrue(archiveContains(archiveFolder.path(), &quot;Fixing&quot;));
 797 
 798             // The webrev comment should be updated
 799             var comments = pr.getComments();
 800             var webrevComments = comments.stream()
 801                                          .filter(comment -&gt; comment.author().equals(author.host().getCurrentUserDetails()))
 802                                          .filter(comment -&gt; comment.body().contains(&quot;webrev&quot;))
 803                                          .filter(comment -&gt; comment.body().contains(nextHash.hex()))
 804                                          .filter(comment -&gt; comment.body().contains(editHash.hex()))
 805                                          .collect(Collectors.toList());
 806             assertEquals(1, webrevComments.size());
 807 
 808             // Check that sender address is set properly
 809             var mailmanServer = MailingListServerFactory.createMailmanServer(listServer.getArchive(), listServer.getSMTP());
 810             var mailmanList = mailmanServer.getList(listAddress.address());
 811             var conversations = mailmanList.conversations(Duration.ofDays(1));
 812             assertEquals(1, conversations.size());
 813             for (var newMail : conversations.get(0).allMessages()) {
 814                 assertEquals(noreplyAddress(archive), newMail.author().address());
 815                 assertEquals(from, newMail.sender());
 816             }
 817 
 818             // Add a comment
 819             var commenterPr = commenter.getPullRequest(pr.getId());
 820             commenterPr.addReviewComment(masterHash, nextHash, reviewFile.toString(), 2, &quot;Review comment&quot;);
 821             TestBotRunner.runPeriodicItems(mlBot);
 822             listServer.processIncoming();
 823 
 824             // Ensure that additional updates are only reported once
 825             for (int i = 0; i &lt; 3; ++i) {
 826                 var anotherHash = CheckableRepository.appendAndCommit(localRepo, &quot;Another line&quot;, &quot;Fixing&quot;);
 827                 localRepo.push(anotherHash, author.getUrl(), &quot;edit&quot;);
 828 
 829                 // Make sure that the push registered
 830                 lastHeadHash = pr.getHeadHash();
 831                 refreshCount = 0;
 832                 do {
 833                     pr = author.getPullRequest(pr.getId());
 834                     if (refreshCount++ &gt; 100) {
 835                         fail(&quot;The PR did not update after the new push&quot;);
 836                     }
 837                 } while (pr.getHeadHash().equals(lastHeadHash));
 838 
 839                 TestBotRunner.runPeriodicItems(mlBot);
 840                 TestBotRunner.runPeriodicItems(mlBot);
 841                 listServer.processIncoming();
 842             }
 843             var updatedConversations = mailmanList.conversations(Duration.ofDays(1));
 844             assertEquals(1, updatedConversations.size());
 845             var conversation = updatedConversations.get(0);
 846             assertEquals(6, conversation.allMessages().size());
 847             assertEquals(&quot;Re: [Rev 01] RFR: This is a pull request&quot;, conversation.allMessages().get(1).subject());
 848             assertEquals(&quot;Re: [Rev 01] RFR: This is a pull request&quot;, conversation.allMessages().get(2).subject(), conversation.allMessages().get(2).toString());
 849             assertEquals(&quot;Re: [Rev 04] RFR: This is a pull request&quot;, conversation.allMessages().get(5).subject());
 850         }
 851     }
 852 
 853     @Test
 854     void rebased(TestInfo testInfo) throws IOException {
 855         try (var credentials = new HostCredentials(testInfo);
 856              var tempFolder = new TemporaryDirectory();
 857              var archiveFolder = new TemporaryDirectory();
 858              var listServer = new TestMailmanServer()) {
 859             var author = credentials.getHostedRepository();
 860             var archive = credentials.getHostedRepository();
 861             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
 862             var censusBuilder = credentials.getCensusBuilder()
 863                                            .addAuthor(author.host().getCurrentUserDetails().id());
 864             var sender = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
 865             var mlBot = new MailingListBridgeBot(sender, author, archive, censusBuilder.build(), &quot;master&quot;,
 866                                                  listAddress, Set.of(), Set.of(),
 867                                                  listServer.getArchive(), listServer.getSMTP(),
 868                                                  archive, &quot;webrev&quot;, Path.of(&quot;test&quot;),
 869                                                  URIBuilder.base(&quot;http://www.test.test/&quot;).build(),
 870                                                  Set.of(), Map.of(),
 871                                                  URIBuilder.base(&quot;http://issues.test/browse/&quot;).build(),
 872                                                  Map.of());
 873 
 874             // Populate the projects repository
 875             var reviewFile = Path.of(&quot;reviewfile.txt&quot;);
 876             var localRepo = CheckableRepository.init(tempFolder.path().resolve(&quot;first&quot;), author.getRepositoryType(), reviewFile);
 877             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
 878             localRepo.push(masterHash, author.getUrl(), &quot;master&quot;, true);
 879             localRepo.push(masterHash, archive.getUrl(), &quot;webrev&quot;, true);
 880 
 881             // Make a change with a corresponding PR
 882             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;A line&quot;, &quot;Original msg&quot;);
 883             localRepo.push(editHash, author.getUrl(), &quot;edit&quot;, true);
 884             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
 885             pr.setBody(&quot;This is now ready&quot;);
 886 
 887             // Run an archive pass
 888             TestBotRunner.runPeriodicItems(mlBot);
 889             listServer.processIncoming();
 890 
 891             var newLocalRepo = Repository.materialize(tempFolder.path().resolve(&quot;second&quot;), author.getUrl(), &quot;master&quot;);
 892             var newEditHash = CheckableRepository.appendAndCommit(newLocalRepo, &quot;Another line&quot;, &quot;Replaced msg&quot;);
 893             newLocalRepo.push(newEditHash, author.getUrl(), &quot;edit&quot;, true);
 894 
 895             // Make sure that the push registered
 896             var lastHeadHash = pr.getHeadHash();
 897             var refreshCount = 0;
 898             do {
 899                 pr = author.getPullRequest(pr.getId());
 900                 if (refreshCount++ &gt; 100) {
 901                     fail(&quot;The PR did not update after the new push&quot;);
 902                 }
 903             } while (pr.getHeadHash().equals(lastHeadHash));
 904 
 905             // Run another archive pass
 906             TestBotRunner.runPeriodicItems(mlBot);
 907             listServer.processIncoming();
 908 
 909             // The archive should reference the rebased push
 910             Repository.materialize(archiveFolder.path(), archive.getUrl(), &quot;master&quot;);
 911             assertTrue(archiveContains(archiveFolder.path(), &quot;complete new set of changes&quot;));
 912             assertTrue(archiveContains(archiveFolder.path(), pr.getId() + &quot;/webrev.01&quot;));
 913             assertFalse(archiveContains(archiveFolder.path(), &quot;Incremental&quot;));
 914             assertTrue(archiveContains(archiveFolder.path(), &quot;Patch&quot;));
 915             assertTrue(archiveContains(archiveFolder.path(), &quot;Fetch&quot;));
 916             assertTrue(archiveContains(archiveFolder.path(), &quot;Original msg&quot;));
 917             assertTrue(archiveContains(archiveFolder.path(), &quot;Replaced msg&quot;));
 918 
 919             // The webrev comment should be updated
 920             var comments = pr.getComments();
 921             var webrevComments = comments.stream()
 922                                          .filter(comment -&gt; comment.author().equals(author.host().getCurrentUserDetails()))
 923                                          .filter(comment -&gt; comment.body().contains(&quot;webrev&quot;))
 924                                          .filter(comment -&gt; comment.body().contains(newEditHash.hex()))
 925                                          .collect(Collectors.toList());
 926             assertEquals(1, webrevComments.size());
 927 
 928             // Check that sender address is set properly
 929             var mailmanServer = MailingListServerFactory.createMailmanServer(listServer.getArchive(), listServer.getSMTP());
 930             var mailmanList = mailmanServer.getList(listAddress.address());
 931             var conversations = mailmanList.conversations(Duration.ofDays(1));
 932             assertEquals(1, conversations.size());
 933             for (var newMail : conversations.get(0).allMessages()) {
 934                 assertEquals(noreplyAddress(archive), newMail.author().address());
 935                 assertEquals(sender, newMail.sender());
 936                 assertFalse(newMail.hasHeader(&quot;PR-Head-Hash&quot;));
 937             }
 938             assertEquals(&quot;Re: [Rev 01] RFR: This is a pull request&quot;, conversations.get(0).allMessages().get(1).subject());
 939         }
 940     }
 941 
 942     @Test
 943     void skipAddingExistingWebrev(TestInfo testInfo) throws IOException {
 944         try (var credentials = new HostCredentials(testInfo);
 945              var tempFolder = new TemporaryDirectory();
 946              var archiveFolder = new TemporaryDirectory();
 947              var webrevFolder = new TemporaryDirectory();
 948              var listServer = new TestMailmanServer()) {
 949             var author = credentials.getHostedRepository();
 950             var archive = credentials.getHostedRepository();
 951             var ignored = credentials.getHostedRepository();
 952             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
 953             var censusBuilder = credentials.getCensusBuilder()
 954                                            .addAuthor(author.host().getCurrentUserDetails().id());
 955             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
 956             var mlBot = new MailingListBridgeBot(from, author, archive, censusBuilder.build(), &quot;master&quot;,
 957                                                  listAddress,
 958                                                  Set.of(ignored.host().getCurrentUserDetails().userName()),
 959                                                  Set.of(),
 960                                                  listServer.getArchive(), listServer.getSMTP(),
 961                                                  archive, &quot;webrev&quot;, Path.of(&quot;test&quot;),
 962                                                  URIBuilder.base(&quot;http://www.test.test/&quot;).build(),
 963                                                  Set.of(), Map.of(),
 964                                                  URIBuilder.base(&quot;http://issues.test/browse/&quot;).build(),
 965                                                  Map.of());
 966 
 967             // Populate the projects repository
 968             var localRepo = CheckableRepository.init(tempFolder.path(), author.getRepositoryType());
 969             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
 970             localRepo.push(masterHash, author.getUrl(), &quot;master&quot;, true);
 971             localRepo.push(masterHash, archive.getUrl(), &quot;webrev&quot;, true);
 972 
 973             // Make a change with a corresponding PR
 974             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;A simple change&quot;,
 975                                                                &quot;Change msg\n\nWith several lines&quot;);
 976             localRepo.push(editHash, author.getUrl(), &quot;edit&quot;, true);
 977             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
 978 
 979             // Flag it as ready for review
 980             pr.setBody(&quot;This should now be ready&quot;);
 981 
 982             // Run an archive pass
 983             TestBotRunner.runPeriodicItems(mlBot);
 984 
 985             // The archive should now contain an entry
 986             var archiveRepo = Repository.materialize(archiveFolder.path(), archive.getUrl(), &quot;master&quot;);
 987             assertTrue(archiveContains(archiveFolder.path(), editHash.abbreviate()));
 988 
 989             // And there should be a webrev comment
 990             var comments = pr.getComments();
 991             var webrevComments = comments.stream()
 992                                          .filter(comment -&gt; comment.author().equals(author.host().getCurrentUserDetails()))
 993                                          .filter(comment -&gt; comment.body().contains(&quot;webrev&quot;))
 994                                          .filter(comment -&gt; comment.body().contains(editHash.hex()))
 995                                          .collect(Collectors.toList());
 996             assertEquals(1, webrevComments.size());
 997             assertEquals(1, countSubstrings(webrevComments.get(0).body(), &quot;webrev.00&quot;));
 998 
 999             // Pretend the archive didn&#39;t work out
1000             archiveRepo.push(masterHash, archive.getUrl(), &quot;master&quot;, true);
1001 
1002             // Run another archive pass
1003             TestBotRunner.runPeriodicItems(mlBot);
1004 
1005             // The webrev comment should not contain duplicate entries
1006             comments = pr.getComments();
1007             webrevComments = comments.stream()
1008                                          .filter(comment -&gt; comment.author().equals(author.host().getCurrentUserDetails()))
1009                                          .filter(comment -&gt; comment.body().contains(&quot;webrev&quot;))
1010                                          .filter(comment -&gt; comment.body().contains(editHash.hex()))
1011                                          .collect(Collectors.toList());
1012             assertEquals(1, webrevComments.size());
1013             assertEquals(1, countSubstrings(webrevComments.get(0).body(), &quot;webrev.00&quot;));
1014         }
1015     }
1016 
1017     @Test
1018     void notifyReviewVerdicts(TestInfo testInfo) throws IOException {
1019         try (var credentials = new HostCredentials(testInfo);
1020              var tempFolder = new TemporaryDirectory();
1021              var archiveFolder = new TemporaryDirectory();
1022              var listServer = new TestMailmanServer()) {
1023             var author = credentials.getHostedRepository();
1024             var archive = credentials.getHostedRepository();
1025             var reviewer = credentials.getHostedRepository();
1026             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
1027             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
1028             var censusBuilder = credentials.getCensusBuilder()
1029                                            .addReviewer(reviewer.host().getCurrentUserDetails().id())
1030                                            .addAuthor(author.host().getCurrentUserDetails().id());
1031             var mlBot = new MailingListBridgeBot(from, author, archive, censusBuilder.build(), &quot;master&quot;,
1032                                                  listAddress, Set.of(), Set.of(),
1033                                                  listServer.getArchive(), listServer.getSMTP(),
1034                                                  archive, &quot;webrev&quot;, Path.of(&quot;test&quot;),
1035                                                  URIBuilder.base(&quot;http://www.test.test/&quot;).build(),
1036                                                  Set.of(), Map.of(),
1037                                                  URIBuilder.base(&quot;http://issues.test/browse/&quot;).build(),
1038                                                  Map.of());
1039 
1040             // Populate the projects repository
1041             var reviewFile = Path.of(&quot;reviewfile.txt&quot;);
1042             var localRepo = CheckableRepository.init(tempFolder.path(), author.getRepositoryType(), reviewFile);
1043             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
1044             localRepo.push(masterHash, author.getUrl(), &quot;master&quot;, true);
1045             localRepo.push(masterHash, archive.getUrl(), &quot;webrev&quot;, true);
1046 
1047             // Make a change with a corresponding PR
1048             var editHash = CheckableRepository.appendAndCommit(localRepo);
1049             localRepo.push(editHash, author.getUrl(), &quot;edit&quot;, true);
1050             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
1051             pr.setBody(&quot;This is now ready&quot;);
1052 
1053             // Run an archive pass
1054             TestBotRunner.runPeriodicItems(mlBot);
1055 
1056             // First unapprove it
1057             var reviewedPr = reviewer.getPullRequest(pr.getId());
1058             reviewedPr.addReview(Review.Verdict.DISAPPROVED, &quot;Reason 1&quot;);
1059             TestBotRunner.runPeriodicItems(mlBot);
1060             TestBotRunner.runPeriodicItems(mlBot);
1061             TestBotRunner.runPeriodicItems(mlBot);
1062 
1063             // The archive should contain a note
1064             Repository.materialize(archiveFolder.path(), archive.getUrl(), &quot;master&quot;);
1065             assertEquals(1, archiveContainsCount(archiveFolder.path(), &quot;Disapproved by &quot;));
1066             assertEquals(1, archiveContainsCount(archiveFolder.path(), &quot; by integrationreviewer1&quot;));
1067             if (author.host().supportsReviewBody()) {
1068                 assertEquals(1, archiveContainsCount(archiveFolder.path(), &quot;Reason 1&quot;));
1069             }
1070 
1071             // Then approve it
1072             reviewedPr.addReview(Review.Verdict.APPROVED, &quot;Reason 2&quot;);
1073             TestBotRunner.runPeriodicItems(mlBot);
1074             TestBotRunner.runPeriodicItems(mlBot);
1075             TestBotRunner.runPeriodicItems(mlBot);
1076 
1077             // The archive should contain another note
1078             Repository.materialize(archiveFolder.path(), archive.getUrl(), &quot;master&quot;);
1079             assertEquals(1, archiveContainsCount(archiveFolder.path(), &quot;Approved by &quot;));
1080             if (author.host().supportsReviewBody()) {
1081                 assertEquals(1, archiveContainsCount(archiveFolder.path(), &quot;Reason 2&quot;));
1082             }
1083             assertEquals(1, archiveContainsCount(archiveFolder.path(), &quot;Re: \\[Approved\\] RFR:&quot;));
1084 
1085             // Yet another change
1086             reviewedPr.addReview(Review.Verdict.DISAPPROVED, &quot;Reason 3&quot;);
1087             TestBotRunner.runPeriodicItems(mlBot);
1088             TestBotRunner.runPeriodicItems(mlBot);
1089             TestBotRunner.runPeriodicItems(mlBot);
1090 
1091             // The archive should contain another note
1092             Repository.materialize(archiveFolder.path(), archive.getUrl(), &quot;master&quot;);
1093             assertEquals(2, archiveContainsCount(archiveFolder.path(), &quot;Disapproved by &quot;));
1094             if (author.host().supportsReviewBody()) {
1095                 assertEquals(1, archiveContainsCount(archiveFolder.path(), &quot;Reason 3&quot;));
1096             }
1097         }
1098     }
1099 
1100     @Test
1101     void ignoreComments(TestInfo testInfo) throws IOException {
1102         try (var credentials = new HostCredentials(testInfo);
1103              var tempFolder = new TemporaryDirectory();
1104              var archiveFolder = new TemporaryDirectory();
1105              var listServer = new TestMailmanServer()) {
1106             var author = credentials.getHostedRepository();
1107             var ignored = credentials.getHostedRepository();
1108             var archive = credentials.getHostedRepository();
1109             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
1110             var censusBuilder = credentials.getCensusBuilder()
1111                                            .addAuthor(author.host().getCurrentUserDetails().id());
1112             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
1113             var mlBot = new MailingListBridgeBot(from, author, archive, censusBuilder.build(), &quot;master&quot;,
1114                                                  listAddress,
1115                                                  Set.of(ignored.host().getCurrentUserDetails().userName()),
1116                                                  Set.of(Pattern.compile(&quot;ignore this comment&quot;, Pattern.MULTILINE | Pattern.DOTALL)),
1117                                                  listServer.getArchive(), listServer.getSMTP(),
1118                                                  archive, &quot;webrev&quot;, Path.of(&quot;test&quot;),
1119                                                  URIBuilder.base(&quot;http://www.test.test/&quot;).build(),
1120                                                  Set.of(), Map.of(),
1121                                                  URIBuilder.base(&quot;http://issues.test/browse/&quot;).build(),
1122                                                  Map.of());
1123 
1124             // Populate the projects repository
1125             var reviewFile = Path.of(&quot;reviewfile.txt&quot;);
1126             var localRepo = CheckableRepository.init(tempFolder.path(), author.getRepositoryType(), reviewFile);
1127             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
1128             localRepo.push(masterHash, author.getUrl(), &quot;master&quot;, true);
1129             localRepo.push(masterHash, archive.getUrl(), &quot;webrev&quot;, true);
1130 
1131             // Make a change with a corresponding PR
1132             var editHash = CheckableRepository.appendAndCommit(localRepo);
1133             localRepo.push(editHash, author.getUrl(), &quot;edit&quot;, true);
1134             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
1135             pr.setBody(&quot;This is now ready&quot;);
1136 
1137             // Make a bunch of comments
1138             pr.addComment(&quot;Plain comment&quot;);
1139             pr.addComment(&quot;ignore this comment&quot;);
1140             pr.addComment(&quot;I think it is time to\nignore this comment!&quot;);
1141             pr.addReviewComment(masterHash, editHash, reviewFile.toString(), 2, &quot;Review ignore this comment&quot;);
1142 
1143             var ignoredPR = ignored.getPullRequest(pr.getId());
1144             ignoredPR.addComment(&quot;Don&#39;t mind me&quot;);
1145 
1146             TestBotRunner.runPeriodicItems(mlBot);
1147             TestBotRunner.runPeriodicItems(mlBot);
1148 
1149             // The archive should not contain the ignored comments
1150             Repository.materialize(archiveFolder.path(), archive.getUrl(), &quot;master&quot;);
1151             assertTrue(archiveContains(archiveFolder.path(), &quot;This is now ready&quot;));
1152             assertFalse(archiveContains(archiveFolder.path(), &quot;ignore this comment&quot;));
1153             assertFalse(archiveContains(archiveFolder.path(), &quot;it is time to&quot;));
1154             assertFalse(archiveContains(archiveFolder.path(), &quot;Don&#39;t mind me&quot;));
1155             assertFalse(archiveContains(archiveFolder.path(), &quot;Review ignore&quot;));
1156         }
1157     }
1158 }
    </pre>
  </body>
</html>