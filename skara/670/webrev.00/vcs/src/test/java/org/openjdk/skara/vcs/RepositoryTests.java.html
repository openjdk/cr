<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>New vcs/src/test/java/org/openjdk/skara/vcs/RepositoryTests.java</title>
    <link rel="stylesheet" href="../../../../../../../../style.css" />
  </head>
  <body>
    <pre>
   1 /*
   2  * Copyright (c) 2018, 2019, Oracle and/or its affiliates. All rights reserved.
   3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   4  *
   5  * This code is free software; you can redistribute it and/or modify it
   6  * under the terms of the GNU General Public License version 2 only, as
   7  * published by the Free Software Foundation.
   8  *
   9  * This code is distributed in the hope that it will be useful, but WITHOUT
  10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
  11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
  12  * version 2 for more details (a copy is included in the LICENSE file that
  13  * accompanied this code).
  14  *
  15  * You should have received a copy of the GNU General Public License version
  16  * 2 along with this work; if not, write to the Free Software Foundation,
  17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
  18  *
  19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
  20  * or visit www.oracle.com if you need additional information or have any
  21  * questions.
  22  */
  23 package org.openjdk.skara.vcs;
  24 
  25 import org.junit.jupiter.api.Assumptions;
  26 import org.openjdk.skara.test.TemporaryDirectory;
  27 
  28 import org.junit.jupiter.api.Test;
  29 import org.junit.jupiter.params.ParameterizedTest;
  30 import org.junit.jupiter.params.provider.EnumSource;
  31 
  32 import java.io.IOException;
  33 import java.net.URI;
  34 import java.nio.file.*;
  35 import java.nio.file.attribute.*;
  36 import java.time.ZonedDateTime;
  37 import java.util.*;
  38 import java.util.stream.Collectors;
  39 
  40 import static java.nio.file.StandardOpenOption.*;
  41 import static org.junit.jupiter.api.Assertions.*;
  42 import static org.junit.jupiter.api.Assumptions.assumeTrue;
  43 
  44 public class RepositoryTests {
  45 
  46     @ParameterizedTest
  47     @EnumSource(VCS.class)
  48     void testExistsOnMissingDirectory(VCS vcs) throws IOException {
  49         var d = Paths.get(&quot;/&quot;, &quot;this&quot;, &quot;path&quot;, &quot;does&quot;, &quot;not&quot;, &quot;exist&quot;);
  50         var r = Repository.get(d);
  51         assertTrue(r.isEmpty());
  52     }
  53 
  54     @ParameterizedTest
  55     @EnumSource(VCS.class)
  56     void testExistsOnEmptyDirectory(VCS vcs) throws IOException {
  57         try (var dir = new TemporaryDirectory()) {
  58             var r = Repository.get(dir.path());
  59             assertTrue(r.isEmpty());
  60         }
  61     }
  62 
  63     @ParameterizedTest
  64     @EnumSource(VCS.class)
  65     void testExistsOnInitializedRepository(VCS vcs) throws IOException {
  66         try (var dir = new TemporaryDirectory()) {
  67             var r = Repository.init(dir.path(), vcs);
  68             assertTrue(r.exists());
  69         }
  70     }
  71 
  72     @ParameterizedTest
  73     @EnumSource(VCS.class)
  74     void testExistsOnSubdir() throws IOException {
  75         try (var dir = new TemporaryDirectory()) {
  76             var r = Repository.init(dir.path(), VCS.GIT);
  77             assertTrue(r.exists());
  78 
  79             var subdir = Paths.get(dir.toString(), &quot;test&quot;);
  80             Files.createDirectories(subdir);
  81             var r2 = Repository.get(subdir);
  82             assertTrue(r2.get().exists());
  83         }
  84     }
  85 
  86     @ParameterizedTest
  87     @EnumSource(VCS.class)
  88     void testRootOnTopLevel() throws IOException {
  89         try (var dir = new TemporaryDirectory()) {
  90             var r = Repository.init(dir.path(), VCS.GIT);
  91             assertEquals(dir.toString(), r.root().toString());
  92         }
  93     }
  94 
  95     @ParameterizedTest
  96     @EnumSource(VCS.class)
  97     void testRootOnSubdirectory(VCS vcs) throws IOException {
  98         try (var dir = new TemporaryDirectory()) {
  99             var r = Repository.init(dir.path(), vcs);
 100             assertEquals(dir.toString(), r.root().toString());
 101 
 102             var subdir = Paths.get(dir.toString(), &quot;sub&quot;);
 103             Files.createDirectories(subdir);
 104 
 105             var r2 = Repository.get(subdir);
 106             assertEquals(dir.toString(), r2.get().root().toString());
 107         }
 108     }
 109 
 110     @ParameterizedTest
 111     @EnumSource(VCS.class)
 112     void testResolveOnEmptyRepository(VCS vcs) throws IOException {
 113         try (var dir = new TemporaryDirectory()) {
 114             var r = Repository.init(dir.path(), vcs);
 115             assertTrue(r.resolve(&quot;HEAD&quot;).isEmpty());
 116         }
 117     }
 118 
 119     @ParameterizedTest
 120     @EnumSource(VCS.class)
 121     void testResolveWithHEAD(VCS vcs) throws IOException {
 122         try (var dir = new TemporaryDirectory()) {
 123             var r = Repository.init(dir.path(), vcs);
 124 
 125             var readme = dir.path().resolve(&quot;README&quot;);
 126             Files.write(readme, List.of(&quot;Hello, readme!&quot;));
 127 
 128             r.add(readme);
 129             var head = r.commit(&quot;Add README&quot;, &quot;duke&quot;, &quot;duke@openjdk.java.net&quot;);
 130             assertEquals(head, r.head());
 131         }
 132     }
 133 
 134     @ParameterizedTest
 135     @EnumSource(VCS.class)
 136     void testConfig(VCS vcs) throws IOException {
 137         try (var dir = new TemporaryDirectory()) {
 138             var r = Repository.init(dir.path(), vcs);
 139 
 140             if (vcs == VCS.GIT) {
 141                 var config = dir.path().resolve(&quot;.git&quot;).resolve(&quot;config&quot;);
 142                 Files.write(config, List.of(&quot;[user]&quot;, &quot;name = duke&quot;), WRITE, APPEND);
 143                 assertEquals(List.of(&quot;duke&quot;), r.config(&quot;user.name&quot;));
 144             } else if (vcs == VCS.HG) {
 145                 var config = dir.path().resolve(&quot;.hg&quot;).resolve(&quot;hgrc&quot;);
 146                 Files.write(config, List.of(&quot;[ui]&quot;, &quot;username = duke&quot;), WRITE, CREATE);
 147                 assertEquals(List.of(&quot;duke&quot;), r.config(&quot;ui.username&quot;));
 148             }
 149 
 150             assertEquals(&quot;duke&quot;, r.username().get());
 151         }
 152     }
 153 
 154     @ParameterizedTest
 155     @EnumSource(VCS.class)
 156     void testCurrentBranchOnEmptyRepository(VCS vcs) throws IOException {
 157         try (var dir = new TemporaryDirectory()) {
 158             var r = Repository.init(dir.path(), vcs);
 159             assertEquals(r.defaultBranch(), r.currentBranch().get());
 160         }
 161     }
 162 
 163     @ParameterizedTest
 164     @EnumSource(VCS.class)
 165     void testCheckout(VCS vcs) throws IOException {
 166         try (var dir = new TemporaryDirectory()) {
 167             var r = Repository.init(dir.path(), vcs);
 168 
 169             var readme = dir.path().resolve(&quot;README&quot;);
 170             Files.write(readme, List.of(&quot;Hello, readme!&quot;));
 171             r.add(readme);
 172 
 173             var head1 = r.commit(&quot;Add README&quot;, &quot;duke&quot;, &quot;duke@openjdk.java.net&quot;);
 174             assertEquals(head1, r.head());
 175 
 176             Files.write(readme, List.of(&quot;Another line&quot;), WRITE, APPEND);
 177             r.add(readme);
 178 
 179             var head2 = r.commit(&quot;Add one more line&quot;, &quot;duke&quot;, &quot;duke@openjdk.java.net&quot;);
 180             assertEquals(head2, r.head());
 181 
 182             r.checkout(head1, false);
 183             assertEquals(head1, r.head());
 184 
 185             r.checkout(head2, false);
 186             assertEquals(head2, r.head());
 187         }
 188     }
 189 
 190     @ParameterizedTest
 191     @EnumSource(VCS.class)
 192     void testLines(VCS vcs) throws IOException {
 193         try (var dir = new TemporaryDirectory()) {
 194             var r = Repository.init(dir.path(), vcs);
 195 
 196             var readme = dir.path().resolve(&quot;README&quot;);
 197             Files.write(readme, List.of(&quot;Hello, readme!&quot;));
 198             r.add(readme);
 199 
 200             var head1 = r.commit(&quot;Add README&quot;, &quot;duke&quot;, &quot;duke@openjdk.java.net&quot;);
 201             assertEquals(List.of(&quot;Hello, readme!&quot;),
 202                          r.lines(readme, head1).orElseThrow());
 203 
 204             Files.write(readme, List.of(&quot;Another line&quot;), WRITE, APPEND);
 205             r.add(readme);
 206 
 207             var head2 = r.commit(&quot;Add one more line&quot;, &quot;duke&quot;, &quot;duke@openjdk.java.net&quot;);
 208             assertEquals(List.of(&quot;Hello, readme!&quot;, &quot;Another line&quot;),
 209                          r.lines(readme, head2).orElseThrow());
 210         }
 211     }
 212 
 213     @ParameterizedTest
 214     @EnumSource(VCS.class)
 215     void testLinesInSubdir(VCS vcs) throws IOException {
 216         try (var dir = new TemporaryDirectory()) {
 217             Repository.init(dir.path(), vcs);
 218 
 219             var subdir = dir.path().resolve(&quot;sub&quot;);
 220             Files.createDirectories(subdir);
 221             var r = Repository.get(subdir).get();
 222 
 223             var readme = subdir.getParent().resolve(&quot;README&quot;);
 224             Files.write(readme, List.of(&quot;Hello, readme!&quot;));
 225             r.add(readme);
 226 
 227             var head = r.commit(&quot;Add README&quot;, &quot;duke&quot;, &quot;duke@openjdk.java.net&quot;);
 228             assertEquals(List.of(&quot;Hello, readme!&quot;),
 229                          r.lines(readme, head).orElseThrow());
 230 
 231             var example = subdir.resolve(&quot;EXAMPLE&quot;);
 232             Files.write(example, List.of(&quot;An example&quot;));
 233             r.add(example);
 234 
 235             var head2 = r.commit(&quot;Add EXAMPLE&quot;, &quot;duke&quot;, &quot;duke@openjdk.java.net&quot;);
 236             assertEquals(List.of(&quot;An example&quot;),
 237                          r.lines(example, head2).orElseThrow());
 238         }
 239     }
 240 
 241     @ParameterizedTest
 242     @EnumSource(VCS.class)
 243     void testCommitListingOnEmptyRepo(VCS vcs) throws IOException {
 244         try (var dir = new TemporaryDirectory()) {
 245             var r = Repository.init(dir.path(), vcs);
 246             assertTrue(r.commits().asList().isEmpty());
 247         }
 248     }
 249 
 250     @ParameterizedTest
 251     @EnumSource(VCS.class)
 252     void testCommitListingWithSingleCommit(VCS vcs) throws IOException {
 253         try (var dir = new TemporaryDirectory()) {
 254             var r = Repository.init(dir.path(), vcs);
 255 
 256             var readme = dir.path().resolve(&quot;README&quot;);
 257             Files.write(readme, List.of(&quot;Hello, readme!&quot;));
 258 
 259             r.add(readme);
 260 
 261             var committerName = vcs == VCS.GIT ? &quot;bot&quot; : &quot;duke&quot;;
 262             var committerEmail = vcs == VCS.GIT ? &quot;bot@openjdk.java.net&quot; : &quot;duke@openjdk.java.net&quot;;
 263             var hash = r.commit(&quot;Add README&quot;, &quot;duke&quot;, &quot;duke@openjdk.java.net&quot;, committerName, committerEmail);
 264 
 265             var commits = r.commits().asList();
 266             assertEquals(1, commits.size());
 267 
 268             var commit = commits.get(0);
 269             assertEquals(&quot;duke&quot;, commit.author().name());
 270             assertEquals(&quot;duke@openjdk.java.net&quot;, commit.author().email());
 271             assertEquals(committerName, commit.committer().name());
 272             assertEquals(committerEmail, commit.committer().email());
 273 
 274             assertEquals(List.of(&quot;Add README&quot;), commit.message());
 275 
 276             assertEquals(1, commit.numParents());
 277             assertEquals(1, commit.parents().size());
 278 
 279             var parent = commit.parents().get(0);
 280             assertEquals(Hash.zero(), parent);
 281 
 282             assertTrue(commit.isInitialCommit());
 283             assertFalse(commit.isMerge());
 284             assertEquals(hash, commit.hash());
 285 
 286             var diffs = commit.parentDiffs();
 287             assertEquals(1, diffs.size());
 288 
 289             var diff = diffs.get(0);
 290             assertEquals(Hash.zero(), diff.from());
 291             assertEquals(hash, diff.to());
 292 
 293             assertEquals(0, diff.removed());
 294             assertEquals(0, diff.modified());
 295             assertEquals(1, diff.added());
 296 
 297             var patches = diff.patches();
 298             assertEquals(1, patches.size());
 299 
 300             var patch = patches.get(0).asTextualPatch();
 301             assertTrue(patch.status().isAdded());
 302 
 303             assertTrue(patch.source().path().isEmpty());
 304             assertTrue(patch.source().type().isEmpty());
 305 
 306             assertEquals(Path.of(&quot;README&quot;), patch.target().path().get());
 307             assertTrue(patch.target().type().get().isRegularNonExecutable());
 308 
 309             var hunks = patch.hunks();
 310             assertEquals(1, hunks.size());
 311 
 312             var hunk = hunks.get(0);
 313             assertEquals(new Range(0, 0), hunk.source().range());
 314             assertEquals(new Range(1, 1), hunk.target().range());
 315 
 316             assertLinesEquals(List.of(), hunk.source().lines());
 317             assertLinesEquals(List.of(&quot;Hello, readme!&quot;), hunk.target().lines());
 318         }
 319     }
 320 
 321     static String stripTrailingCR(String line) {
 322         return line.endsWith(&quot;\r&quot;) ? line.substring(0, line.length() - 1) : line;
 323     }
 324 
 325     static void assertLinesEquals(List&lt;String&gt; expected, List&lt;String&gt; actual) {
 326         assertEquals(expected, actual.stream().map(RepositoryTests::stripTrailingCR).collect(Collectors.toList()));
 327     }
 328 
 329     @ParameterizedTest
 330     @EnumSource(VCS.class)
 331     void testCommitListingWithMultipleCommits(VCS vcs) throws IOException {
 332         try (var dir = new TemporaryDirectory()) {
 333             var r = Repository.init(dir.path(), vcs);
 334 
 335             var readme = dir.path().resolve(&quot;README&quot;);
 336             Files.write(readme, List.of(&quot;Hello, readme!&quot;));
 337 
 338             r.add(readme);
 339             var hash1 = r.commit(&quot;Add README&quot;, &quot;duke&quot;, &quot;duke@openjdk.java.net&quot;);
 340 
 341             Files.write(readme, List.of(&quot;Another line&quot;), WRITE, APPEND);
 342             r.add(readme);
 343             var hash2 = r.commit(&quot;Modify README&quot;, &quot;duke&quot;, &quot;duke@openjdk.java.net&quot;);
 344 
 345             var commits = r.commits().asList();
 346             assertEquals(2, commits.size());
 347 
 348             var commit = commits.get(0);
 349             assertEquals(&quot;duke&quot;, commit.author().name());
 350             assertEquals(&quot;duke@openjdk.java.net&quot;, commit.author().email());
 351 
 352             assertEquals(List.of(&quot;Modify README&quot;), commit.message());
 353 
 354             assertEquals(1, commit.numParents());
 355             assertEquals(1, commit.parents().size());
 356 
 357             var parent = commit.parents().get(0);
 358             assertEquals(hash1, parent);
 359 
 360             assertFalse(commit.isInitialCommit());
 361             assertFalse(commit.isMerge());
 362             assertEquals(hash2, commit.hash());
 363 
 364             var diffs = commit.parentDiffs();
 365             assertEquals(1, diffs.size());
 366 
 367             var diff = diffs.get(0);
 368             assertEquals(hash1, diff.from());
 369             assertEquals(hash2, diff.to());
 370 
 371             assertEquals(0, diff.removed());
 372             assertEquals(0, diff.modified());
 373             assertEquals(1, diff.added());
 374 
 375             var patches = diff.patches();
 376             assertEquals(1, patches.size());
 377 
 378             var patch = patches.get(0).asTextualPatch();
 379             assertTrue(patch.status().isModified());
 380             assertEquals(Path.of(&quot;README&quot;), patch.source().path().get());
 381             assertTrue(patch.source().type().get().isRegularNonExecutable());
 382             assertEquals(Path.of(&quot;README&quot;), patch.target().path().get());
 383             assertTrue(patch.target().type().get().isRegularNonExecutable());
 384 
 385             var hunks = patch.hunks();
 386             assertEquals(1, hunks.size());
 387 
 388             var hunk = hunks.get(0);
 389             assertEquals(new Range(2, 0), hunk.source().range());
 390             assertEquals(new Range(2, 1), hunk.target().range());
 391 
 392             assertLinesEquals(List.of(), hunk.source().lines());
 393             assertLinesEquals(List.of(&quot;Another line&quot;), hunk.target().lines());
 394         }
 395     }
 396 
 397     @ParameterizedTest
 398     @EnumSource(VCS.class)
 399     void testSquashDeletes(VCS vcs) throws IOException {
 400         try (var dir = new TemporaryDirectory()) {
 401             var r = Repository.init(dir.path(), vcs);
 402 
 403             var file1 = dir.path().resolve(&quot;file1.txt&quot;);
 404             Files.write(file1, List.of(&quot;Hello, file 1!&quot;));
 405             var file2 = dir.path().resolve(&quot;file2.txt&quot;);
 406             Files.write(file2, List.of(&quot;Hello, file 2!&quot;));
 407             var file3 = dir.path().resolve(&quot;file3.txt&quot;);
 408             Files.write(file3, List.of(&quot;Hello, file 3!&quot;));
 409 
 410             r.add(file1, file2, file3);
 411             var hash1 = r.commit(&quot;Add files&quot;, &quot;duke&quot;, &quot;duke@openjdk.java.net&quot;);
 412 
 413             Files.delete(file2);
 414             r.remove(file2);
 415             var hash2 = r.commit(&quot;Remove file 2&quot;, &quot;duke&quot;, &quot;duke@openjdk.java.net&quot;);
 416 
 417             Files.delete(file3);
 418             r.remove(file3);
 419             var hash3 = r.commit(&quot;Remove file 3&quot;, &quot;duke&quot;, &quot;duke@openjdk.java.net&quot;);
 420 
 421             var refspec = vcs == VCS.GIT ? r.head().hex() : r.head().hex() + &quot;:0&quot;;
 422             assertEquals(3, r.commits(refspec).asList().size());
 423 
 424             r.checkout(hash1, false);
 425             r.squash(hash3);
 426             r.commit(&quot;Squashed remove of file 2 and 3&quot;, &quot;duke&quot;, &quot;duke@openjdk.java.net&quot;);
 427 
 428             refspec = vcs == VCS.GIT ? r.head().hex() : r.head().hex() + &quot;:0&quot;;
 429             var commits = r.commits(refspec).asList();
 430             assertEquals(2, commits.size());
 431 
 432             assertEquals(hash1, commits.get(1).hash());
 433 
 434             var head = commits.get(0);
 435             assertNotEquals(hash2, head);
 436             assertNotEquals(hash3, head);
 437 
 438             assertEquals(hash1, head.parents().get(0));
 439             assertFalse(head.isInitialCommit());
 440             assertFalse(head.isMerge());
 441 
 442             var diffs = head.parentDiffs();
 443             assertEquals(1, diffs.size());
 444 
 445             var diff = diffs.get(0);
 446             assertEquals(hash1, diff.from());
 447             assertEquals(head.hash(), diff.to());
 448 
 449             assertEquals(2, diff.removed());
 450             assertEquals(0, diff.modified());
 451             assertEquals(0, diff.added());
 452         }
 453     }
 454 
 455     @ParameterizedTest
 456     @EnumSource(VCS.class)
 457     void testSquash(VCS vcs) throws IOException {
 458         try (var dir = new TemporaryDirectory()) {
 459             var r = Repository.init(dir.path(), vcs);
 460 
 461             var readme = dir.path().resolve(&quot;README&quot;);
 462             Files.write(readme, List.of(&quot;Hello, readme!&quot;));
 463 
 464             r.add(readme);
 465             var hash1 = r.commit(&quot;Add README&quot;, &quot;duke&quot;, &quot;duke@openjdk.java.net&quot;);
 466 
 467             Files.write(readme, List.of(&quot;Another line&quot;), WRITE, APPEND);
 468             r.add(readme);
 469             var hash2 = r.commit(&quot;Modify README&quot;, &quot;duke&quot;, &quot;duke@openjdk.java.net&quot;);
 470 
 471             Files.write(readme, List.of(&quot;A final line&quot;), WRITE, APPEND);
 472             r.add(readme);
 473             var hash3 = r.commit(&quot;Modify README again&quot;, &quot;duke&quot;, &quot;duke@openjdk.java.net&quot;);
 474 
 475             var refspec = vcs == VCS.GIT ? r.head().hex() : r.head().hex() + &quot;:0&quot;;
 476             assertEquals(3, r.commits(refspec).asList().size());
 477 
 478             r.checkout(hash1, false);
 479             r.squash(hash3);
 480             r.commit(&quot;Squashed commits 2 and 3&quot;, &quot;duke&quot;, &quot;duke@openjdk.java.net&quot;);
 481 
 482             refspec = vcs == VCS.GIT ? r.head().hex() : r.head().hex() + &quot;:0&quot;;
 483             var commits = r.commits(refspec).asList();
 484             assertEquals(2, commits.size());
 485 
 486             assertEquals(hash1, commits.get(1).hash());
 487 
 488             var head = commits.get(0);
 489             assertNotEquals(hash2, head);
 490             assertNotEquals(hash3, head);
 491 
 492             assertEquals(hash1, head.parents().get(0));
 493             assertFalse(head.isInitialCommit());
 494             assertFalse(head.isMerge());
 495 
 496             var diffs = head.parentDiffs();
 497             assertEquals(1, diffs.size());
 498 
 499             var diff = diffs.get(0);
 500             assertEquals(hash1, diff.from());
 501             assertEquals(head.hash(), diff.to());
 502 
 503             assertEquals(0, diff.removed());
 504             assertEquals(0, diff.modified());
 505             assertEquals(2, diff.added());
 506 
 507             var patches = diff.patches();
 508             assertEquals(1, patches.size());
 509 
 510             var patch = patches.get(0).asTextualPatch();
 511             assertTrue(patch.status().isModified());
 512             assertEquals(Path.of(&quot;README&quot;), patch.source().path().get());
 513             assertTrue(patch.source().type().get().isRegularNonExecutable());
 514             assertEquals(Path.of(&quot;README&quot;), patch.target().path().get());
 515             assertTrue(patch.target().type().get().isRegularNonExecutable());
 516 
 517             var hunks = patch.hunks();
 518             assertEquals(1, hunks.size());
 519 
 520             var hunk = hunks.get(0);
 521             assertEquals(new Range(2, 0), hunk.source().range());
 522             assertEquals(new Range(2, 2), hunk.target().range());
 523 
 524             assertLinesEquals(List.of(), hunk.source().lines());
 525             assertLinesEquals(List.of(&quot;Another line&quot;, &quot;A final line&quot;), hunk.target().lines());
 526         }
 527     }
 528 
 529     @ParameterizedTest
 530     @EnumSource(VCS.class)
 531     void testMergeBase(VCS vcs) throws IOException {
 532         try (var dir = new TemporaryDirectory()) {
 533             var r = Repository.init(dir.path(), vcs);
 534 
 535             var readme = dir.path().resolve(&quot;README&quot;);
 536             Files.write(readme, List.of(&quot;Hello, readme!&quot;));
 537 
 538             r.add(readme);
 539             var hash1 = r.commit(&quot;Add README&quot;, &quot;duke&quot;, &quot;duke@openjdk.java.net&quot;);
 540 
 541             Files.write(readme, List.of(&quot;Another line&quot;), WRITE, APPEND);
 542             r.add(readme);
 543             var hash2 = r.commit(&quot;Modify README&quot;, &quot;duke&quot;, &quot;duke@openjdk.java.net&quot;);
 544 
 545             r.checkout(hash1, false);
 546             Files.write(readme, List.of(&quot;A conflicting line&quot;), WRITE, APPEND);
 547             r.add(readme);
 548             var hash3 = r.commit(&quot;Branching README modification&quot;, &quot;duke&quot;, &quot;duke@openjdk.java.net&quot;);
 549 
 550             assertEquals(hash1, r.mergeBase(hash2, hash3));
 551         }
 552     }
 553 
 554     @ParameterizedTest
 555     @EnumSource(VCS.class)
 556     void testRebase(VCS vcs) throws IOException {
 557         try (var dir = new TemporaryDirectory()) {
 558             var r = Repository.init(dir.path(), vcs);
 559 
 560             var readme = dir.path().resolve(&quot;README&quot;);
 561             Files.write(readme, List.of(&quot;Hello, readme!&quot;));
 562 
 563             r.add(readme);
 564             var hash1 = r.commit(&quot;Add README&quot;, &quot;duke&quot;, &quot;duke@openjdk.java.net&quot;);
 565 
 566             Files.write(readme, List.of(&quot;Another line&quot;), WRITE, APPEND);
 567             r.add(readme);
 568             var hash2 = r.commit(&quot;Modify README&quot;, &quot;duke&quot;, &quot;duke@openjdk.java.net&quot;);
 569 
 570             r.checkout(hash1, false);
 571 
 572             var contributing = dir.path().resolve(&quot;CONTRIBUTING&quot;);
 573             Files.write(contributing, List.of(&quot;Keep the patches coming&quot;));
 574             r.add(contributing);
 575             var hash3 = r.commit(&quot;Add independent change&quot;, &quot;duke&quot;, &quot;duke@openjdk.java.net&quot;);
 576 
 577             var committerName = vcs == VCS.GIT ? &quot;bot&quot; : &quot;duke&quot;;
 578             var committerEmail = vcs == VCS.GIT ? &quot;bot@openjdk.java.net&quot; : &quot;duke@openjdk.java.net&quot;;
 579             r.rebase(hash2, committerName, committerEmail);
 580 
 581             var refspec = vcs == VCS.GIT ? r.head().hex() : r.head().hex() + &quot;:0&quot;;
 582             var commits = r.commits(refspec).asList();
 583             assertEquals(3, commits.size());
 584             assertEquals(hash2, commits.get(1).hash());
 585             assertEquals(hash1, commits.get(2).hash());
 586 
 587             assertEquals(&quot;duke&quot;, commits.get(0).author().name());
 588             assertEquals(&quot;duke@openjdk.java.net&quot;, commits.get(0).author().email());
 589             assertEquals(committerName, commits.get(0).committer().name());
 590             assertEquals(committerEmail, commits.get(0).committer().email());
 591 
 592             assertEquals(&quot;duke&quot;, commits.get(1).author().name());
 593             assertEquals(&quot;duke@openjdk.java.net&quot;, commits.get(1).author().email());
 594             assertEquals(&quot;duke&quot;, commits.get(1).committer().name());
 595             assertEquals(&quot;duke@openjdk.java.net&quot;, commits.get(1).committer().email());
 596 
 597             assertEquals(&quot;duke&quot;, commits.get(2).author().name());
 598             assertEquals(&quot;duke@openjdk.java.net&quot;, commits.get(2).author().email());
 599             assertEquals(&quot;duke&quot;, commits.get(2).committer().name());
 600             assertEquals(&quot;duke@openjdk.java.net&quot;, commits.get(2).committer().email());
 601 
 602             var head = commits.get(0);
 603             assertEquals(hash2, head.parents().get(0));
 604             assertEquals(List.of(&quot;Add independent change&quot;), head.message());
 605 
 606             var diffs = head.parentDiffs();
 607             assertEquals(1, diffs.size());
 608             var diff = diffs.get(0);
 609 
 610             assertEquals(0, diff.removed());
 611             assertEquals(0, diff.modified());
 612             assertEquals(1, diff.added());
 613 
 614             var patches = diff.patches();
 615             assertEquals(1, patches.size());
 616             var patch = patches.get(0).asTextualPatch();
 617             assertEquals(Path.of(&quot;CONTRIBUTING&quot;), patch.target().path().get());
 618 
 619             var hunks = patch.hunks();
 620             assertEquals(1, hunks.size());
 621             var hunk = hunks.get(0);
 622             assertLinesEquals(List.of(&quot;Keep the patches coming&quot;), hunk.target().lines());
 623         }
 624     }
 625 
 626     @ParameterizedTest
 627     @EnumSource(VCS.class)
 628     void testInitializedRepositoryIsEmpty(VCS vcs) throws IOException {
 629         try (var dir = new TemporaryDirectory()) {
 630             var r = Repository.init(dir.path(), vcs);
 631             assertTrue(r.isEmpty());
 632         }
 633     }
 634 
 635     @ParameterizedTest
 636     @EnumSource(VCS.class)
 637     void testRepositoryWithCommitIsNonEmpty(VCS vcs) throws IOException {
 638         try (var dir = new TemporaryDirectory()) {
 639             var r = Repository.init(dir.path(), vcs);
 640 
 641             var readme = dir.path().resolve(&quot;README&quot;);
 642             Files.write(readme, List.of(&quot;Hello, readme!&quot;));
 643 
 644             r.add(readme);
 645             r.commit(&quot;Add README&quot;, &quot;duke&quot;, &quot;duke@openjdk.java.net&quot;);
 646 
 647             assertFalse(r.isEmpty());
 648         }
 649     }
 650 
 651     @ParameterizedTest
 652     @EnumSource(VCS.class)
 653     void testEmptyRepositoryIsHealthy(VCS vcs) throws IOException {
 654         try (var dir = new TemporaryDirectory()) {
 655             var r = Repository.init(dir.path(), vcs);
 656             assertTrue(r.isHealthy());
 657         }
 658     }
 659 
 660     @ParameterizedTest
 661     @EnumSource(VCS.class)
 662     void testNonEmptyRepositoryIsHealthy(VCS vcs) throws IOException {
 663         try (var dir = new TemporaryDirectory()) {
 664             var r = Repository.init(dir.path(), vcs);
 665 
 666             var readme = dir.path().resolve(&quot;README&quot;);
 667             Files.write(readme, List.of(&quot;Hello, readme!&quot;));
 668 
 669             r.add(readme);
 670             r.commit(&quot;Add README&quot;, &quot;duke&quot;, &quot;duke@openjdk.java.net&quot;);
 671 
 672             assertTrue(r.isHealthy());
 673         }
 674     }
 675 
 676     @ParameterizedTest
 677     @EnumSource(VCS.class)
 678     void testNonCheckedOutRepositoryIsHealthy(VCS vcs) throws IOException {
 679         try (var dir1 = new TemporaryDirectory();
 680              var dir2 = new TemporaryDirectory()) {
 681             var r1 = Repository.init(dir1.path(), vcs);
 682 
 683             var readme = dir1.path().resolve(&quot;README&quot;);
 684             Files.write(readme, List.of(&quot;Hello, readme!&quot;));
 685 
 686             r1.add(readme);
 687             var hash = r1.commit(&quot;Add README&quot;, &quot;duke&quot;, &quot;duke@openjdk.java.net&quot;);
 688             r1.tag(hash, &quot;tag&quot;, &quot;tagging&quot;, &quot;duke&quot;, &quot;duke@openjdk.java.net&quot;);
 689 
 690             var r2 = Repository.init(dir2.path(), vcs);
 691             r2.fetch(r1.root().toUri(), r1.defaultBranch().name());
 692 
 693             assertTrue(r2.isHealthy());
 694         }
 695     }
 696 
 697     @ParameterizedTest
 698     @EnumSource(VCS.class)
 699     void testBranchesOnEmptyRepository(VCS vcs) throws IOException {
 700         try (var dir = new TemporaryDirectory()) {
 701             var r = Repository.init(dir.path(), vcs);
 702             var expected = vcs == VCS.GIT ? List.of() : List.of(new Branch(&quot;default&quot;));
 703             assertEquals(List.of(), r.branches());
 704         }
 705     }
 706 
 707     @ParameterizedTest
 708     @EnumSource(VCS.class)
 709     void testBranchesOnNonEmptyRepository(VCS vcs) throws IOException {
 710         try (var dir = new TemporaryDirectory()) {
 711             var r = Repository.init(dir.path(), vcs);
 712 
 713             var readme = dir.path().resolve(&quot;README&quot;);
 714             Files.write(readme, List.of(&quot;Hello, readme!&quot;));
 715 
 716             r.add(readme);
 717             r.commit(&quot;Add README&quot;, &quot;duke&quot;, &quot;duke@openjdk.java.net&quot;);
 718 
 719             assertEquals(List.of(r.defaultBranch()), r.branches());
 720         }
 721     }
 722 
 723     @ParameterizedTest
 724     @EnumSource(VCS.class)
 725     void testTagsOnEmptyRepository(VCS vcs) throws IOException {
 726         try (var dir = new TemporaryDirectory()) {
 727             var r = Repository.init(dir.path(), vcs);
 728             var expected = vcs == VCS.GIT ? List.of() : List.of(new Tag(&quot;tip&quot;));
 729             assertEquals(expected, r.tags());
 730         }
 731     }
 732 
 733     @ParameterizedTest
 734     @EnumSource(VCS.class)
 735     void testTagsOnNonEmptyRepository(VCS vcs) throws IOException {
 736         try (var dir = new TemporaryDirectory()) {
 737             var r = Repository.init(dir.path(), vcs);
 738 
 739             var readme = dir.path().resolve(&quot;README&quot;);
 740             Files.write(readme, List.of(&quot;Hello, readme!&quot;));
 741 
 742             r.add(readme);
 743             r.commit(&quot;Add README&quot;, &quot;duke&quot;, &quot;duke@openjdk.java.net&quot;);
 744 
 745             var expected = vcs == VCS.GIT ? List.of() : List.of(new Tag(&quot;tip&quot;));
 746             assertEquals(expected, r.tags());
 747         }
 748     }
 749 
 750     @ParameterizedTest
 751     @EnumSource(VCS.class)
 752     void testFetchAndPush(VCS vcs) throws IOException {
 753         try (var dir = new TemporaryDirectory()) {
 754             var upstream = Repository.init(dir.path(), vcs);
 755 
 756             if (vcs == VCS.GIT) {
 757                 Files.write(upstream.root().resolve(&quot;.git&quot;).resolve(&quot;config&quot;),
 758                             List.of(&quot;[receive]&quot;, &quot;denyCurrentBranch=ignore&quot;),
 759                             WRITE, APPEND);
 760             }
 761 
 762             var readme = dir.path().resolve(&quot;README&quot;);
 763             Files.write(readme, List.of(&quot;Hello, readme!&quot;));
 764 
 765             upstream.add(readme);
 766             upstream.commit(&quot;Add README&quot;, &quot;duke&quot;, &quot;duke@openjdk.java.net&quot;);
 767 
 768             try (var dir2 = new TemporaryDirectory()) {
 769                 var downstream = Repository.init(dir2.path(), vcs);
 770 
 771                  // note: forcing unix path separators for URI
 772                 var upstreamURI = URI.create(&quot;file:///&quot; + dir.toString().replace(&#39;\\&#39;, &#39;/&#39;));
 773 
 774                 var fetchHead = downstream.fetch(upstreamURI, downstream.defaultBranch().name());
 775                 downstream.checkout(fetchHead, false);
 776 
 777                 var downstreamReadme = dir2.path().resolve(&quot;README&quot;);
 778                 Files.write(downstreamReadme, List.of(&quot;Downstream change&quot;), WRITE, APPEND);
 779 
 780                 downstream.add(downstreamReadme);
 781                 var head = downstream.commit(&quot;Modify README&quot;, &quot;duke&quot;, &quot;duke@openjdk.java.net&quot;);
 782 
 783                 downstream.push(head, upstreamURI, downstream.defaultBranch().name());
 784             }
 785 
 786             upstream.checkout(upstream.resolve(upstream.defaultBranch().name()).get(), false);
 787 
 788             var commits = upstream.commits().asList();
 789             assertEquals(2, commits.size());
 790         }
 791     }
 792 
 793     @ParameterizedTest
 794     @EnumSource(VCS.class)
 795     void testClean(VCS vcs) throws IOException {
 796         try (var dir = new TemporaryDirectory()) {
 797             var r = Repository.init(dir.path(), vcs);
 798             r.clean();
 799 
 800             var readme = dir.path().resolve(&quot;README&quot;);
 801             Files.write(readme, List.of(&quot;Hello, readme!&quot;));
 802 
 803             r.add(readme);
 804             var hash1 = r.commit(&quot;Add README&quot;, &quot;duke&quot;, &quot;duke@openjdk.java.net&quot;);
 805 
 806             r.clean();
 807 
 808             assertEquals(hash1, r.head());
 809 
 810             Files.write(readme, List.of(&quot;A random change&quot;), WRITE, APPEND);
 811 
 812             r.clean();
 813 
 814             assertEquals(List.of(&quot;Hello, readme!&quot;), Files.readAllLines(readme));
 815 
 816             var untracked = dir.path().resolve(&quot;UNTRACKED&quot;);
 817             Files.write(untracked, List.of(&quot;Random text&quot;));
 818 
 819             r.clean();
 820 
 821             assertFalse(Files.exists(untracked));
 822 
 823             // Mercurial cannot currently deal with this situation
 824             if (vcs != VCS.HG) {
 825                 var subRepo = Repository.init(dir.path().resolve(&quot;submodule&quot;), vcs);
 826                 var subRepoFile = subRepo.root().resolve(&quot;file.txt&quot;);
 827                 Files.write(subRepoFile, List.of(&quot;Looks like a file in a submodule&quot;));
 828 
 829                 r.clean();
 830 
 831                 assertFalse(Files.exists(subRepoFile));
 832             }
 833         }
 834     }
 835 
 836     @ParameterizedTest
 837     @EnumSource(VCS.class)
 838     void testCleanIgnored(VCS vcs) throws IOException {
 839         try (var dir = new TemporaryDirectory()) {
 840             var r = Repository.init(dir.path(), vcs);
 841             r.clean();
 842 
 843             var readme = dir.path().resolve(&quot;README&quot;);
 844             Files.write(readme, List.of(&quot;Hello, readme!&quot;));
 845             Files.write(dir.path().resolve(&quot;.gitignore&quot;), List.of(&quot;*.txt&quot;));
 846             Files.write(dir.path().resolve(&quot;.hgignore&quot;), List.of(&quot;.*txt&quot;));
 847 
 848             r.add(readme);
 849             var hash1 = r.commit(&quot;Add README&quot;, &quot;duke&quot;, &quot;duke@openjdk.java.net&quot;);
 850 
 851             var ignored = dir.path().resolve(&quot;ignored.txt&quot;);
 852             Files.write(ignored, List.of(&quot;Random text&quot;));
 853 
 854             r.clean();
 855 
 856             assertFalse(Files.exists(ignored));
 857         }
 858     }
 859 
 860     @ParameterizedTest
 861     @EnumSource(VCS.class)
 862     void testDiffBetweenCommits(VCS vcs) throws IOException {
 863         try (var dir = new TemporaryDirectory()) {
 864             var r = Repository.init(dir.path(), vcs);
 865 
 866             var readme = dir.path().resolve(&quot;README&quot;);
 867             Files.write(readme, List.of(&quot;Hello, readme!&quot;));
 868 
 869             r.add(readme);
 870             var first = r.commit(&quot;Add README&quot;, &quot;duke&quot;, &quot;duke@openjdk.java.net&quot;);
 871 
 872             Files.write(readme, List.of(&quot;One more line&quot;), WRITE, APPEND);
 873             r.add(readme);
 874             var second = r.commit(&quot;Add one more line&quot;, &quot;duke&quot;, &quot;duke@openjdk.java.net&quot;);
 875 
 876             var diff = r.diff(first, second);
 877             assertEquals(first, diff.from());
 878             assertEquals(second, diff.to());
 879 
 880             var patches = diff.patches();
 881             assertEquals(1, patches.size());
 882 
 883             var patch = patches.get(0).asTextualPatch();
 884             assertEquals(Path.of(&quot;README&quot;), patch.source().path().get());
 885             assertEquals(Path.of(&quot;README&quot;), patch.target().path().get());
 886             assertTrue(patch.source().type().get().isRegularNonExecutable());
 887             assertTrue(patch.target().type().get().isRegularNonExecutable());
 888             assertTrue(patch.status().isModified());
 889 
 890             var hunks = patch.hunks();
 891             assertEquals(1, hunks.size());
 892 
 893             var hunk = hunks.get(0);
 894             assertEquals(2, hunk.source().range().start());
 895             assertEquals(0, hunk.source().range().count());
 896             assertEquals(0, hunk.source().lines().size());
 897 
 898             assertEquals(2, hunk.target().range().start());
 899             assertEquals(1, hunk.target().range().count());
 900             assertLinesEquals(List.of(&quot;One more line&quot;), hunk.target().lines());
 901 
 902             assertEquals(1, hunk.added());
 903             assertEquals(0, hunk.removed());
 904             assertEquals(0, hunk.modified());
 905         }
 906     }
 907 
 908     @ParameterizedTest
 909     @EnumSource(VCS.class)
 910     void testDiffBetweenCommitsWithMultiplePatches(VCS vcs) throws IOException {
 911         try (var dir = new TemporaryDirectory()) {
 912             var r = Repository.init(dir.path(), vcs);
 913 
 914             var readme = dir.path().resolve(&quot;README&quot;);
 915             Files.write(readme, List.of(&quot;Hello, readme!&quot;));
 916 
 917             var building = dir.path().resolve(&quot;BUILDING&quot;);
 918             Files.write(building, List.of(&quot;make&quot;));
 919 
 920             r.add(readme);
 921             r.add(building);
 922             var first = r.commit(&quot;Add README and BUILDING&quot;, &quot;duke&quot;, &quot;duke@openjdk.java.net&quot;);
 923 
 924             Files.write(readme, List.of(&quot;Hello, Skara!&quot;), WRITE, TRUNCATE_EXISTING);
 925             Files.write(building, List.of(&quot;make images&quot;), WRITE, TRUNCATE_EXISTING);
 926             r.add(readme);
 927             r.add(building);
 928             var second = r.commit(&quot;Modify README and BUILDING&quot;, &quot;duke&quot;, &quot;duke@openjdk.java.net&quot;);
 929 
 930             var diff = r.diff(first, second);
 931             assertEquals(first, diff.from());
 932             assertEquals(second, diff.to());
 933 
 934             var patches = diff.patches();
 935             assertEquals(2, patches.size());
 936 
 937             var patch1 = patches.get(0).asTextualPatch();
 938             assertEquals(Path.of(&quot;BUILDING&quot;), patch1.source().path().get());
 939             assertEquals(Path.of(&quot;BUILDING&quot;), patch1.target().path().get());
 940             assertTrue(patch1.source().type().get().isRegularNonExecutable());
 941             assertTrue(patch1.target().type().get().isRegularNonExecutable());
 942             assertTrue(patch1.status().isModified());
 943 
 944             var hunks1 = patch1.hunks();
 945             assertEquals(1, hunks1.size());
 946 
 947             var hunk1 = hunks1.get(0);
 948             assertEquals(1, hunk1.source().range().start());
 949             assertEquals(1, hunk1.source().range().count());
 950             assertLinesEquals(List.of(&quot;make&quot;), hunk1.source().lines());
 951 
 952             assertEquals(1, hunk1.target().range().start());
 953             assertEquals(1, hunk1.target().range().count());
 954             assertLinesEquals(List.of(&quot;make images&quot;), hunk1.target().lines());
 955 
 956             var patch2 = patches.get(1).asTextualPatch();
 957             assertEquals(Path.of(&quot;README&quot;), patch2.source().path().get());
 958             assertEquals(Path.of(&quot;README&quot;), patch2.target().path().get());
 959             assertTrue(patch2.source().type().get().isRegularNonExecutable());
 960             assertTrue(patch2.target().type().get().isRegularNonExecutable());
 961             assertTrue(patch2.status().isModified());
 962 
 963             var hunks2 = patch2.hunks();
 964             assertEquals(1, hunks2.size());
 965 
 966             var hunk2 = hunks2.get(0);
 967             assertEquals(1, hunk2.source().range().start());
 968             assertEquals(1, hunk2.source().range().count());
 969             assertLinesEquals(List.of(&quot;Hello, readme!&quot;), hunk2.source().lines());
 970 
 971             assertEquals(1, hunk2.target().range().start());
 972             assertEquals(1, hunk2.target().range().count());
 973             assertLinesEquals(List.of(&quot;Hello, Skara!&quot;), hunk2.target().lines());
 974         }
 975     }
 976 
 977     @ParameterizedTest
 978     @EnumSource(VCS.class)
 979     void testDiffBetweenCommitsWithMultipleHunks(VCS vcs) throws IOException {
 980         try (var dir = new TemporaryDirectory()) {
 981             var r = Repository.init(dir.path(), vcs);
 982 
 983             var abc = dir.path().resolve(&quot;abc.txt&quot;);
 984             Files.write(abc, List.of(&quot;A&quot;, &quot;B&quot;, &quot;C&quot;));
 985 
 986             r.add(abc);
 987             var first = r.commit(&quot;Added ABC&quot;, &quot;duke&quot;, &quot;duke@openjdk.java.net&quot;);
 988 
 989             Files.write(abc, List.of(&quot;1&quot;, &quot;2&quot;, &quot;B&quot;, &quot;3&quot;), WRITE, TRUNCATE_EXISTING);
 990             r.add(abc);
 991             var second = r.commit(&quot;Modify A and C&quot;, &quot;duke&quot;, &quot;duke@openjdk.java.net&quot;);
 992 
 993             var diff = r.diff(first, second);
 994             assertEquals(first, diff.from());
 995             assertEquals(second, diff.to());
 996 
 997             var patches = diff.patches();
 998             assertEquals(1, patches.size());
 999 
1000             var patch = patches.get(0).asTextualPatch();
1001             assertEquals(Path.of(&quot;abc.txt&quot;), patch.source().path().get());
1002             assertEquals(Path.of(&quot;abc.txt&quot;), patch.target().path().get());
1003             assertTrue(patch.source().type().get().isRegularNonExecutable());
1004             assertTrue(patch.target().type().get().isRegularNonExecutable());
1005             assertTrue(patch.status().isModified());
1006 
1007             var hunks = patch.hunks();
1008             assertEquals(2, hunks.size());
1009 
1010             var hunk1 = hunks.get(0);
1011             assertEquals(1, hunk1.source().range().start());
1012             assertEquals(1, hunk1.source().range().count());
1013             assertLinesEquals(List.of(&quot;A&quot;), hunk1.source().lines());
1014 
1015             assertEquals(1, hunk1.target().range().start());
1016             assertEquals(2, hunk1.target().range().count());
1017             assertLinesEquals(List.of(&quot;1&quot;, &quot;2&quot;), hunk1.target().lines());
1018 
1019             assertEquals(1, hunk1.added());
1020             assertEquals(0, hunk1.removed());
1021             assertEquals(1, hunk1.modified());
1022 
1023             var hunk2 = hunks.get(1);
1024             assertEquals(3, hunk2.source().range().start());
1025             assertEquals(1, hunk2.source().range().count());
1026             assertLinesEquals(List.of(&quot;C&quot;), hunk2.source().lines());
1027 
1028             assertEquals(4, hunk2.target().range().start());
1029             assertEquals(1, hunk2.target().range().count());
1030             assertLinesEquals(List.of(&quot;3&quot;), hunk2.target().lines());
1031 
1032             assertEquals(0, hunk2.added());
1033             assertEquals(0, hunk2.removed());
1034             assertEquals(1, hunk2.modified());
1035         }
1036     }
1037 
1038     @ParameterizedTest
1039     @EnumSource(VCS.class)
1040     void testDiffWithRemoval(VCS vcs) throws IOException {
1041         try (var dir = new TemporaryDirectory()) {
1042             var r = Repository.init(dir.path(), vcs);
1043 
1044             var readme = dir.path().resolve(&quot;README&quot;);
1045             Files.write(readme, List.of(&quot;Hello, world!&quot;));
1046 
1047             r.add(readme);
1048             var first = r.commit(&quot;Added README&quot;, &quot;duke&quot;, &quot;duke@openjdk.java.net&quot;);
1049 
1050             Files.delete(readme);
1051             r.remove(readme);
1052             var second = r.commit(&quot;Removed README&quot;, &quot;duke&quot;, &quot;duke@openjdk.java.net&quot;);
1053 
1054             var diff = r.diff(first, second);
1055             assertEquals(first, diff.from());
1056             assertEquals(second, diff.to());
1057 
1058             var patches = diff.patches();
1059             assertEquals(1, patches.size());
1060 
1061             var patch = patches.get(0).asTextualPatch();
1062             assertEquals(Path.of(&quot;README&quot;), patch.source().path().get());
1063             assertTrue(patch.target().path().isEmpty());
1064             assertTrue(patch.source().type().get().isRegularNonExecutable());
1065             assertTrue(patch.target().type().isEmpty());
1066             assertTrue(patch.status().isDeleted());
1067 
1068             var hunks = patch.hunks();
1069             assertEquals(1, hunks.size());
1070 
1071             var hunk = hunks.get(0);
1072             assertEquals(1, hunk.source().range().start());
1073             assertEquals(1, hunk.source().range().count());
1074             assertLinesEquals(List.of(&quot;Hello, world!&quot;), hunk.source().lines());
1075 
1076             assertEquals(0, hunk.target().range().start());
1077             assertEquals(0, hunk.target().range().count());
1078             assertLinesEquals(List.of(), hunk.target().lines());
1079 
1080             assertEquals(0, hunk.added());
1081             assertEquals(1, hunk.removed());
1082             assertEquals(0, hunk.modified());
1083         }
1084     }
1085 
1086     @ParameterizedTest
1087     @EnumSource(VCS.class)
1088     void testDiffWithAddition(VCS vcs) throws IOException {
1089         try (var dir = new TemporaryDirectory()) {
1090             var r = Repository.init(dir.path(), vcs);
1091 
1092             var readme = dir.path().resolve(&quot;README&quot;);
1093             Files.write(readme, List.of(&quot;Hello, world!&quot;));
1094 
1095             r.add(readme);
1096             var first = r.commit(&quot;Added README&quot;, &quot;duke&quot;, &quot;duke@openjdk.java.net&quot;);
1097 
1098             var building = dir.path().resolve(&quot;BUILDING&quot;);
1099             Files.write(building, List.of(&quot;make&quot;));
1100             r.add(building);
1101             var second = r.commit(&quot;Added BUILDING&quot;, &quot;duke&quot;, &quot;duke@openjdk.java.net&quot;);
1102 
1103             var diff = r.diff(first, second);
1104             assertEquals(first, diff.from());
1105             assertEquals(second, diff.to());
1106 
1107             var patches = diff.patches();
1108             assertEquals(1, patches.size());
1109 
1110             var patch = patches.get(0).asTextualPatch();
1111             assertTrue(patch.source().path().isEmpty());
1112             assertEquals(Path.of(&quot;BUILDING&quot;), patch.target().path().get());
1113             assertTrue(patch.source().type().isEmpty());
1114             assertTrue(patch.target().type().get().isRegularNonExecutable());
1115             assertTrue(patch.status().isAdded());
1116 
1117             var hunks = patch.hunks();
1118             assertEquals(1, hunks.size());
1119 
1120             var hunk = hunks.get(0);
1121             assertEquals(0, hunk.source().range().start());
1122             assertEquals(0, hunk.source().range().count());
1123             assertLinesEquals(List.of(), hunk.source().lines());
1124 
1125             assertEquals(1, hunk.target().range().start());
1126             assertEquals(1, hunk.target().range().count());
1127             assertLinesEquals(List.of(&quot;make&quot;), hunk.target().lines());
1128 
1129             assertEquals(1, hunk.added());
1130             assertEquals(0, hunk.removed());
1131             assertEquals(0, hunk.modified());
1132         }
1133     }
1134 
1135     @ParameterizedTest
1136     @EnumSource(VCS.class)
1137     void testDiffWithWorkingDir(VCS vcs) throws IOException {
1138         try (var dir = new TemporaryDirectory()) {
1139             var r = Repository.init(dir.path(), vcs);
1140 
1141             var readme = dir.path().resolve(&quot;README&quot;);
1142             Files.write(readme, List.of(&quot;Hello, world!&quot;));
1143 
1144             r.add(readme);
1145             var first = r.commit(&quot;Added README&quot;, &quot;duke&quot;, &quot;duke@openjdk.java.net&quot;);
1146 
1147             Files.write(readme, List.of(&quot;One more line&quot;), WRITE, APPEND);
1148             var diff = r.diff(first);
1149 
1150             assertEquals(first, diff.from());
1151             assertNull(diff.to());
1152 
1153             var patches = diff.patches();
1154             assertEquals(1, patches.size());
1155 
1156             var patch = patches.get(0).asTextualPatch();
1157             assertEquals(Path.of(&quot;README&quot;), patch.source().path().get());
1158             assertEquals(Path.of(&quot;README&quot;), patch.target().path().get());
1159             assertTrue(patch.source().type().get().isRegularNonExecutable());
1160             assertTrue(patch.target().type().get().isRegularNonExecutable());
1161             assertTrue(patch.status().isModified());
1162 
1163             var hunks = patch.hunks();
1164             assertEquals(1, hunks.size());
1165 
1166             var hunk = hunks.get(0);
1167             assertEquals(2, hunk.source().range().start());
1168             assertEquals(0, hunk.source().range().count());
1169             assertLinesEquals(List.of(), hunk.source().lines());
1170 
1171             assertEquals(2, hunk.target().range().start());
1172             assertEquals(1, hunk.target().range().count());
1173             assertLinesEquals(List.of(&quot;One more line&quot;), hunk.target().lines());
1174 
1175             assertEquals(1, hunk.added());
1176             assertEquals(0, hunk.removed());
1177             assertEquals(0, hunk.modified());
1178         }
1179     }
1180 
1181     @ParameterizedTest
1182     @EnumSource(VCS.class)
1183     void testCommitMetadata(VCS vcs) throws IOException {
1184         try (var dir = new TemporaryDirectory()) {
1185             var r = Repository.init(dir.path(), vcs);
1186 
1187             var readme = dir.path().resolve(&quot;README&quot;);
1188             Files.write(readme, List.of(&quot;Hello, world!&quot;));
1189             r.add(readme);
1190             var first = r.commit(&quot;Added README&quot;, &quot;duke&quot;, &quot;duke@openjdk.java.net&quot;);
1191 
1192             Files.write(readme, List.of(&quot;One more line&quot;), WRITE, APPEND);
1193             r.add(readme);
1194             var second = r.commit(&quot;Modified README&quot;, &quot;duke&quot;, &quot;duke@openjdk.java.net&quot;);
1195 
1196             var metadata = r.commitMetadata();
1197             assertEquals(2, metadata.size());
1198 
1199             assertEquals(second, metadata.get(0).hash());
1200             assertEquals(List.of(&quot;Modified README&quot;), metadata.get(0).message());
1201 
1202             assertEquals(first, metadata.get(1).hash());
1203             assertEquals(List.of(&quot;Added README&quot;), metadata.get(1).message());
1204         }
1205     }
1206 
1207     @ParameterizedTest
1208     @EnumSource(VCS.class)
1209     void testCommitMetadataWithFiles(VCS vcs) throws IOException {
1210         try (var dir = new TemporaryDirectory()) {
1211             var r = Repository.init(dir.path(), vcs);
1212 
1213             var readme1 = dir.path().resolve(&quot;README_1&quot;);
1214             Files.write(readme1, List.of(&quot;1&quot;));
1215             r.add(readme1);
1216             var first = r.commit(&quot;Added README_1&quot;, &quot;duke&quot;, &quot;duke@openjdk.java.net&quot;);
1217 
1218             var readme2 = dir.path().resolve(&quot;README_2&quot;);
1219             Files.write(readme2, List.of(&quot;2&quot;));
1220             r.add(readme2);
1221             var second = r.commit(&quot;Added README_2&quot;, &quot;duke&quot;, &quot;duke@openjdk.java.net&quot;);
1222 
1223             Files.write(readme2, List.of(&quot;3&quot;), WRITE, APPEND);
1224             r.add(readme2);
1225             var third = r.commit(&quot;Modified README_2&quot;, &quot;duke&quot;, &quot;duke@openjdk.java.net&quot;);
1226 
1227             var metadata = r.commitMetadata(List.of(Path.of(&quot;README_1&quot;)));
1228             assertEquals(1, metadata.size());
1229             assertEquals(first, metadata.get(0).hash());
1230 
1231             metadata = r.commitMetadata(List.of(Path.of(&quot;README_2&quot;)));
1232             assertEquals(2, metadata.size());
1233             assertEquals(third, metadata.get(0).hash());
1234             assertEquals(second, metadata.get(1).hash());
1235 
1236             metadata = r.commitMetadata(List.of(Path.of(&quot;README_1&quot;), Path.of(&quot;README_2&quot;)));
1237             assertEquals(3, metadata.size());
1238             assertEquals(third, metadata.get(0).hash());
1239             assertEquals(second, metadata.get(1).hash());
1240             assertEquals(first, metadata.get(2).hash());
1241         }
1242     }
1243 
1244     @ParameterizedTest
1245     @EnumSource(VCS.class)
1246     void testCommitMetadataWithReverse(VCS vcs) throws IOException {
1247         try (var dir = new TemporaryDirectory()) {
1248             var r = Repository.init(dir.path(), vcs);
1249 
1250             var readme = dir.path().resolve(&quot;README&quot;);
1251             Files.write(readme, List.of(&quot;Hello, world!&quot;));
1252             r.add(readme);
1253             var first = r.commit(&quot;Added README&quot;, &quot;duke&quot;, &quot;duke@openjdk.java.net&quot;);
1254 
1255             Files.write(readme, List.of(&quot;One more line&quot;), WRITE, APPEND);
1256             r.add(readme);
1257             var second = r.commit(&quot;Modified README&quot;, &quot;duke&quot;, &quot;duke@openjdk.java.net&quot;);
1258 
1259             var metadata = r.commitMetadata();
1260             assertEquals(2, metadata.size());
1261             assertEquals(second, metadata.get(0).hash());
1262             assertEquals(first, metadata.get(1).hash());
1263 
1264             metadata = r.commitMetadata(true);
1265             assertEquals(2, metadata.size());
1266             assertEquals(first, metadata.get(0).hash());
1267             assertEquals(second, metadata.get(1).hash());
1268         }
1269     }
1270 
1271     @ParameterizedTest
1272     @EnumSource(VCS.class)
1273     void testTrivialMerge(VCS vcs) throws IOException {
1274         try (var dir = new TemporaryDirectory()) {
1275             var r = Repository.init(dir.path(), vcs);
1276 
1277             var readme = dir.path().resolve(&quot;README&quot;);
1278             Files.write(readme, List.of(&quot;Hello, world!&quot;));
1279             r.add(readme);
1280             var first = r.commit(&quot;Added README&quot;, &quot;duke&quot;, &quot;duke@openjdk.java.net&quot;);
1281 
1282             Files.write(readme, List.of(&quot;One more line&quot;), WRITE, APPEND);
1283             r.add(readme);
1284             var second = r.commit(&quot;Modified README&quot;, &quot;duke&quot;, &quot;duke@openjdk.java.net&quot;);
1285 
1286             r.checkout(first, false);
1287 
1288             var contributing = dir.path().resolve(&quot;CONTRIBUTING&quot;);
1289             Files.write(contributing, List.of(&quot;Send those patches!&quot;));
1290             r.add(contributing);
1291             var third = r.commit(&quot;Added contributing&quot;, &quot;duke&quot;, &quot;duke@openjdk.java.net&quot;);
1292 
1293             r.merge(second);
1294             r.commit(&quot;Merge&quot;, &quot;duke&quot;, &quot;duke@openjdk.java.net&quot;);
1295 
1296             var refspec = vcs == VCS.GIT ? r.head().hex() : r.head().hex() + &quot;:0&quot;;
1297             var commits = r.commits(refspec).asList();
1298 
1299             assertEquals(4, commits.size());
1300 
1301             var merge = commits.get(0);
1302             assertEquals(List.of(&quot;Merge&quot;), merge.message());
1303 
1304             var parents = new HashSet&lt;&gt;(merge.parents());
1305             assertEquals(2, parents.size());
1306             assertTrue(parents.contains(second));
1307             assertTrue(parents.contains(third));
1308 
1309             var diffs = merge.parentDiffs();
1310             assertEquals(2, diffs.size());
1311 
1312             var diff1 = diffs.get(0);
1313             assertEquals(merge.hash(), diff1.to());
1314             assertEquals(0, diff1.patches().size());
1315             assertTrue(parents.contains(diff1.from()));
1316 
1317             var diff2 = diffs.get(1);
1318             assertEquals(merge.hash(), diff2.to());
1319             assertEquals(0, diff2.patches().size());
1320             assertTrue(parents.contains(diff2.from()));
1321         }
1322     }
1323 
1324     @ParameterizedTest
1325     @EnumSource(VCS.class)
1326     void testMergeWithEdit(VCS vcs) throws IOException {
1327         try (var dir = new TemporaryDirectory()) {
1328             var r = Repository.init(dir.path(), vcs);
1329 
1330             var readme = dir.path().resolve(&quot;README&quot;);
1331             Files.write(readme, List.of(&quot;Hello, world!&quot;));
1332             r.add(readme);
1333             var first = r.commit(&quot;Added README&quot;, &quot;duke&quot;, &quot;duke@openjdk.java.net&quot;);
1334 
1335             Files.write(readme, List.of(&quot;One more line&quot;), WRITE, APPEND);
1336             r.add(readme);
1337             var second = r.commit(&quot;Modified README&quot;, &quot;duke&quot;, &quot;duke@openjdk.java.net&quot;);
1338 
1339             r.checkout(first, false);
1340 
1341             var contributing = dir.path().resolve(&quot;CONTRIBUTING&quot;);
1342             Files.write(contributing, List.of(&quot;Send those patches!&quot;));
1343             r.add(contributing);
1344             var third = r.commit(&quot;Added contributing&quot;, &quot;duke&quot;, &quot;duke@openjdk.java.net&quot;);
1345 
1346             r.merge(second);
1347 
1348             Files.write(readme, List.of(&quot;One last line&quot;), WRITE, APPEND);
1349             r.add(readme);
1350             r.commit(&quot;Merge&quot;, &quot;duke&quot;, &quot;duke@openjdk.java.net&quot;);
1351 
1352             var refspec = vcs == VCS.GIT ? r.head().hex() : r.head().hex() + &quot;:0&quot;;
1353             var commits = r.commits(refspec).asList();
1354 
1355             assertEquals(4, commits.size());
1356 
1357             var merge = commits.get(0);
1358             assertEquals(List.of(&quot;Merge&quot;), merge.message());
1359 
1360             var parents = new HashSet&lt;&gt;(merge.parents());
1361             assertEquals(2, parents.size());
1362             assertTrue(parents.contains(second));
1363             assertTrue(parents.contains(third));
1364 
1365             var diffs = merge.parentDiffs();
1366             assertEquals(2, diffs.size());
1367 
1368             var secondDiff = diffs.stream().filter(d -&gt; d.from().equals(second)).findFirst().get();
1369             assertEquals(merge.hash(), secondDiff.to());
1370             assertEquals(1, secondDiff.patches().size());
1371             var secondPatch = secondDiff.patches().get(0).asTextualPatch();
1372 
1373             assertEquals(Path.of(&quot;README&quot;), secondPatch.source().path().get());
1374             assertEquals(Path.of(&quot;README&quot;), secondPatch.target().path().get());
1375             assertTrue(secondPatch.status().isModified());
1376             assertEquals(1, secondPatch.hunks().size());
1377 
1378             var secondHunk = secondPatch.hunks().get(0);
1379             assertLinesEquals(List.of(), secondHunk.source().lines());
1380             assertLinesEquals(List.of(&quot;One last line&quot;), secondHunk.target().lines());
1381 
1382             assertEquals(3, secondHunk.source().range().start());
1383             assertEquals(0, secondHunk.source().range().count());
1384             assertEquals(3, secondHunk.target().range().start());
1385             assertEquals(1, secondHunk.target().range().count());
1386 
1387             var thirdDiff = diffs.stream().filter(d -&gt; d.from().equals(third)).findFirst().get();
1388             assertEquals(merge.hash(), thirdDiff.to());
1389             assertEquals(1, thirdDiff.patches().size());
1390             var thirdPatch = thirdDiff.patches().get(0).asTextualPatch();
1391 
1392             assertEquals(Path.of(&quot;README&quot;), thirdPatch.source().path().get());
1393             assertEquals(Path.of(&quot;README&quot;), thirdPatch.target().path().get());
1394             assertTrue(thirdPatch.status().isModified());
1395             assertEquals(1, thirdPatch.hunks().size());
1396 
1397             var thirdHunk = thirdPatch.hunks().get(0);
1398             assertLinesEquals(List.of(), thirdHunk.source().lines());
1399             assertLinesEquals(List.of(&quot;One more line&quot;, &quot;One last line&quot;), thirdHunk.target().lines());
1400 
1401             assertEquals(2, thirdHunk.source().range().start());
1402             assertEquals(0, thirdHunk.source().range().count());
1403             assertEquals(2, thirdHunk.target().range().start());
1404             assertEquals(2, thirdHunk.target().range().count());
1405         }
1406     }
1407 
1408     @ParameterizedTest
1409     @EnumSource(VCS.class)
1410     void testDefaultBranch(VCS vcs) throws IOException {
1411         try (var dir = new TemporaryDirectory()) {
1412             var r = Repository.init(dir.path(), vcs);
1413             var expected = vcs == VCS.GIT ? &quot;master&quot; : &quot;default&quot;;
1414             assertEquals(expected, r.defaultBranch().name());
1415         }
1416     }
1417 
1418     @ParameterizedTest
1419     @EnumSource(VCS.class)
1420     void testPaths(VCS vcs) throws IOException {
1421         try (var dir = new TemporaryDirectory()) {
1422             var r = Repository.init(dir.path(), vcs);
1423             var remote = vcs == VCS.GIT ? &quot;origin&quot; : &quot;default&quot;;
1424             r.setPaths(remote, &quot;http://pull&quot;, &quot;http://push&quot;);
1425             assertEquals(&quot;http://pull&quot;, r.pullPath(remote));
1426             assertEquals(&quot;http://push&quot;, r.pushPath(remote));
1427         }
1428     }
1429 
1430     @ParameterizedTest
1431     @EnumSource(VCS.class)
1432     void testIsValidRevisionRange(VCS vcs) throws IOException {
1433         try (var dir = new TemporaryDirectory()) {
1434             var r = Repository.init(dir.path(), vcs);
1435             assertFalse(r.isValidRevisionRange(&quot;foo&quot;));
1436 
1437             var readme = dir.path().resolve(&quot;README&quot;);
1438             Files.write(readme, List.of(&quot;Hello, world!&quot;));
1439             r.add(readme);
1440             r.commit(&quot;Added README&quot;, &quot;duke&quot;, &quot;duke@openjdk.java.net&quot;);
1441 
1442             assertTrue(r.isValidRevisionRange(r.defaultBranch().toString()));
1443         }
1444     }
1445 
1446     @ParameterizedTest
1447     @EnumSource(VCS.class)
1448     void testDefaultTag(VCS vcs) throws IOException {
1449         try (var dir = new TemporaryDirectory()) {
1450             var r = Repository.init(dir.path(), vcs);
1451             var expected = vcs == VCS.GIT ? Optional.empty() : Optional.of(new Tag(&quot;tip&quot;));
1452             assertEquals(expected, r.defaultTag());
1453         }
1454     }
1455 
1456     @ParameterizedTest
1457     @EnumSource(VCS.class)
1458     void testTag(VCS vcs) throws IOException {
1459         try (var dir = new TemporaryDirectory()) {
1460             var r = Repository.init(dir.path(), vcs);
1461 
1462             var readme = dir.path().resolve(&quot;README&quot;);
1463             Files.write(readme, List.of(&quot;Hello, world!&quot;));
1464             r.add(readme);
1465             var first = r.commit(&quot;Added README&quot;, &quot;duke&quot;, &quot;duke@openjdk.java.net&quot;);
1466 
1467             r.tag(first, &quot;test&quot;, &quot;Tagging test&quot;, &quot;duke&quot;, &quot;duke@openjdk.java.net&quot;);
1468             var defaultTag = r.defaultTag().orElse(null);
1469             var nonDefaultTags = r.tags().stream()
1470                                   .filter(tag -&gt; !tag.equals(defaultTag))
1471                                   .map(Tag::toString)
1472                                   .collect(Collectors.toList());
1473             assertEquals(List.of(&quot;test&quot;), nonDefaultTags);
1474         }
1475     }
1476 
1477     @ParameterizedTest
1478     @EnumSource(VCS.class)
1479     void testIsClean(VCS vcs) throws IOException {
1480         try (var dir = new TemporaryDirectory()) {
1481             var r = Repository.init(dir.path(), vcs);
1482             assertTrue(r.isClean());
1483 
1484             var readme = dir.path().resolve(&quot;README&quot;);
1485             Files.write(readme, List.of(&quot;Hello, world!&quot;));
1486             assertFalse(r.isClean());
1487 
1488             r.add(readme);
1489             assertFalse(r.isClean());
1490 
1491             r.commit(&quot;Added README&quot;, &quot;duke&quot;, &quot;duke@openjdk.java.net&quot;);
1492             assertTrue(r.isClean());
1493 
1494             Files.delete(readme);
1495             assertFalse(r.isClean());
1496 
1497             Files.write(readme, List.of(&quot;Hello, world!&quot;));
1498             assertTrue(r.isClean());
1499         }
1500     }
1501 
1502     @ParameterizedTest
1503     @EnumSource(VCS.class)
1504     void testShowOnExecutableFiles(VCS vcs) throws IOException {
1505         try (var dir = new TemporaryDirectory()) {
1506             var r = Repository.init(dir.path(), vcs);
1507             assertTrue(r.isClean());
1508 
1509             var readOnlyExecutableFile = dir.path().resolve(&quot;hello.sh&quot;);
1510             Files.write(readOnlyExecutableFile, List.of(&quot;echo &#39;hello&#39;&quot;));
1511             if (readOnlyExecutableFile.getFileSystem().supportedFileAttributeViews().contains(&quot;posix&quot;)) {
1512                 var permissions = PosixFilePermissions.fromString(&quot;r-xr-xr-x&quot;);
1513                 Files.setPosixFilePermissions(readOnlyExecutableFile, permissions);
1514             }
1515             r.add(readOnlyExecutableFile);
1516             var hash = r.commit(&quot;Added read only executable file&quot;, &quot;duke&quot;, &quot;duke@openjdk.java.net&quot;);
1517             assertEquals(Optional.of(List.of(&quot;echo &#39;hello&#39;&quot;)), r.lines(readOnlyExecutableFile, hash));
1518 
1519             var readWriteExecutableFile = dir.path().resolve(&quot;goodbye.sh&quot;);
1520             Files.write(readWriteExecutableFile, List.of(&quot;echo &#39;goodbye&#39;&quot;));
1521             if (readOnlyExecutableFile.getFileSystem().supportedFileAttributeViews().contains(&quot;posix&quot;)) {
1522                 var permissions = PosixFilePermissions.fromString(&quot;rwxrwxrwx&quot;);
1523                 Files.setPosixFilePermissions(readWriteExecutableFile, permissions);
1524             }
1525             r.add(readWriteExecutableFile);
1526             var hash2 = r.commit(&quot;Added read-write executable file&quot;, &quot;duke&quot;, &quot;duke@openjdk.java.net&quot;);
1527             assertEquals(Optional.of(List.of(&quot;echo &#39;goodbye&#39;&quot;)), r.lines(readWriteExecutableFile, hash2));
1528         }
1529     }
1530 
1531     @Test
1532     void testGetAndExistsOnNonExistingDirectory() throws IOException {
1533         var nonExistingDirectory = Path.of(&quot;this&quot;, &quot;does&quot;, &quot;not&quot;, &quot;exist&quot;);
1534         assertEquals(Optional.empty(), Repository.get(nonExistingDirectory));
1535         assertEquals(false, Repository.exists(nonExistingDirectory));
1536     }
1537 
1538     @ParameterizedTest
1539     @EnumSource(VCS.class)
1540     void testDiffOnFilenamesWithSpace(VCS vcs) throws IOException {
1541         try (var dir = new TemporaryDirectory()) {
1542             var r = Repository.init(dir.path(), vcs);
1543             assertTrue(r.isClean());
1544 
1545             var fileWithSpaceInName = dir.path().resolve(&quot;hello world.txt&quot;);
1546             Files.writeString(fileWithSpaceInName, &quot;Hello world\n&quot;);
1547             r.add(fileWithSpaceInName);
1548             var hash1 = r.commit(&quot;Added file with space in name&quot;, &quot;duke&quot;, &quot;duke@openjdk.java.net&quot;);
1549             Files.writeString(fileWithSpaceInName, &quot;Goodbye world\n&quot;);
1550             r.add(fileWithSpaceInName);
1551             var hash2 = r.commit(&quot;Modified file with space in name&quot;, &quot;duke&quot;, &quot;duke@openjdk.java.net&quot;);
1552             var diff = r.diff(hash1, hash2);
1553             var patches = diff.patches();
1554             assertEquals(1, patches.size());
1555             var patch = patches.get(0);
1556             assertTrue(patch.target().path().isPresent());
1557             var path = patch.target().path().get();
1558             assertEquals(Path.of(&quot;hello world.txt&quot;), path);
1559         }
1560     }
1561 
1562     @Test
1563     void testSingleEmptyCommit() throws IOException, InterruptedException {
1564         try (var dir = new TemporaryDirectory()) {
1565             var r = Repository.init(dir.path(), VCS.GIT);
1566             assertTrue(r.isClean());
1567 
1568             // must ust git directly to be able to pass --allow-empty
1569             var pb = new ProcessBuilder(&quot;git&quot;, &quot;commit&quot;, &quot;--message&quot;, &quot;An empty commit&quot;, &quot;--allow-empty&quot;);
1570             pb.environment().put(&quot;GIT_AUTHOR_NAME&quot;, &quot;duke&quot;);
1571             pb.environment().put(&quot;GIT_AUTHOR_EMAIL&quot;, &quot;duke@openjdk.org&quot;);
1572             pb.environment().put(&quot;GIT_COMMITTER_NAME&quot;, &quot;duke&quot;);
1573             pb.environment().put(&quot;GIT_COMMITTER_EMAIL&quot;, &quot;duke@openjdk.org&quot;);
1574             pb.directory(dir.path().toFile());
1575 
1576             var res = pb.start().waitFor();
1577             assertEquals(0, res);
1578 
1579             var commits = r.commits().asList();
1580             assertEquals(1, commits.size());
1581             var commit = commits.get(0);
1582             assertEquals(&quot;duke&quot;, commit.author().name());
1583             assertEquals(&quot;duke@openjdk.org&quot;, commit.author().email());
1584             assertEquals(&quot;duke&quot;, commit.committer().name());
1585             assertEquals(&quot;duke@openjdk.org&quot;, commit.committer().email());
1586             assertEquals(List.of(&quot;An empty commit&quot;), commit.message());
1587         }
1588     }
1589 
1590     @Test
1591     void testEmptyCommitWithParent() throws IOException, InterruptedException {
1592         try (var dir = new TemporaryDirectory()) {
1593             var r = Repository.init(dir.path(), VCS.GIT);
1594             assertTrue(r.isClean());
1595 
1596             var f = Files.createFile(dir.path().resolve(&quot;hello.txt&quot;));
1597             Files.writeString(f, &quot;Hello world\n&quot;);
1598             r.add(f);
1599             r.commit(&quot;Initial commit&quot;, &quot;duke&quot;, &quot;duke@openjdk.org&quot;);
1600 
1601             // must ust git directly to be able to pass --allow-empty
1602             var pb = new ProcessBuilder(&quot;git&quot;, &quot;commit&quot;, &quot;--message&quot;, &quot;An empty commit&quot;, &quot;--allow-empty&quot;);
1603             pb.environment().put(&quot;GIT_AUTHOR_NAME&quot;, &quot;duke&quot;);
1604             pb.environment().put(&quot;GIT_AUTHOR_EMAIL&quot;, &quot;duke@openjdk.org&quot;);
1605             pb.environment().put(&quot;GIT_COMMITTER_NAME&quot;, &quot;duke&quot;);
1606             pb.environment().put(&quot;GIT_COMMITTER_EMAIL&quot;, &quot;duke@openjdk.org&quot;);
1607             pb.directory(dir.path().toFile());
1608 
1609             var res = pb.start().waitFor();
1610             assertEquals(0, res);
1611 
1612             var commits = r.commits().asList();
1613             assertEquals(2, commits.size());
1614             var commit = commits.get(0);
1615             assertEquals(&quot;duke&quot;, commit.author().name());
1616             assertEquals(&quot;duke@openjdk.org&quot;, commit.author().email());
1617             assertEquals(&quot;duke&quot;, commit.committer().name());
1618             assertEquals(&quot;duke@openjdk.org&quot;, commit.committer().email());
1619             assertEquals(List.of(&quot;An empty commit&quot;), commit.message());
1620         }
1621     }
1622 
1623     @ParameterizedTest
1624     @EnumSource(VCS.class)
1625     void testAmend(VCS vcs) throws IOException {
1626         try (var dir = new TemporaryDirectory()) {
1627             var r = Repository.init(dir.path(), vcs);
1628             assertTrue(r.isClean());
1629 
1630             var f = dir.path().resolve(&quot;README&quot;);
1631             Files.writeString(f, &quot;Hello\n&quot;);
1632             r.add(f);
1633             r.commit(&quot;Initial commit&quot;, &quot;duke&quot;, &quot;duke@openjdk.org&quot;);
1634 
1635             Files.writeString(f, &quot;Hello, world\n&quot;);
1636             r.add(f);
1637             r.amend(&quot;Initial commit corrected&quot;, &quot;duke&quot;, &quot;duke@openjdk.java.net&quot;);
1638             var commits = r.commits().asList();
1639             assertEquals(1, commits.size());
1640             var commit = commits.get(0);
1641             assertEquals(List.of(&quot;Initial commit corrected&quot;), commit.message());
1642         }
1643     }
1644 
1645     @ParameterizedTest
1646     @EnumSource(VCS.class)
1647     void testRevert(VCS vcs) throws IOException {
1648         try (var dir = new TemporaryDirectory()) {
1649             var r = Repository.init(dir.path(), vcs);
1650             assertTrue(r.isClean());
1651 
1652             var f = dir.path().resolve(&quot;README&quot;);
1653             Files.writeString(f, &quot;Hello\n&quot;);
1654             r.add(f);
1655             var initial = r.commit(&quot;Initial commit&quot;, &quot;duke&quot;, &quot;duke@openjdk.org&quot;);
1656 
1657             Files.writeString(f, &quot;Hello, world\n&quot;);
1658             r.revert(initial);
1659             Files.writeString(f, &quot;Goodbye, world\n&quot;);
1660             r.add(f);
1661             var hash = r.commit(&quot;Second commit&quot;, &quot;duke&quot;, &quot;duke@openjdk.org&quot;);
1662             var commit = r.lookup(hash).orElseThrow();
1663             var patches = commit.parentDiffs().get(0).patches();
1664             assertEquals(1, patches.size());
1665             var patch = patches.get(0).asTextualPatch();
1666             assertEquals(1, patch.hunks().size());
1667             var hunk = patch.hunks().get(0);
1668             assertEquals(List.of(&quot;Goodbye, world&quot;), hunk.target().lines());
1669         }
1670     }
1671 
1672     @ParameterizedTest
1673     @EnumSource(VCS.class)
1674     void testFiles(VCS vcs) throws IOException {
1675         try (var dir = new TemporaryDirectory()) {
1676             var r = Repository.init(dir.path(), vcs);
1677             assertTrue(r.isClean());
1678 
1679             var f = dir.path().resolve(&quot;README&quot;);
1680             Files.writeString(f, &quot;Hello\n&quot;);
1681             r.add(f);
1682             var initial = r.commit(&quot;Initial commit&quot;, &quot;duke&quot;, &quot;duke@openjdk.org&quot;);
1683 
1684             var entries = r.files(initial);
1685             assertEquals(1, entries.size());
1686             var entry = entries.get(0);
1687             assertEquals(Path.of(&quot;README&quot;), entry.path());
1688             assertTrue(entry.type().isRegularNonExecutable());
1689 
1690             var f2 = dir.path().resolve(&quot;CONTRIBUTING&quot;);
1691             Files.writeString(f2, &quot;Hello\n&quot;);
1692             r.add(f2);
1693             var second = r.commit(&quot;Second commit&quot;, &quot;duke&quot;, &quot;duke@openjdk.org&quot;);
1694 
1695             entries = r.files(second);
1696             assertEquals(2, entries.size());
1697             assertTrue(entries.stream().allMatch(e -&gt; e.type().isRegularNonExecutable()));
1698             var paths = entries.stream().map(FileEntry::path).collect(Collectors.toSet());
1699             assertTrue(paths.contains(Path.of(&quot;README&quot;)));
1700             assertTrue(paths.contains(Path.of(&quot;CONTRIBUTING&quot;)));
1701 
1702             entries = r.files(second, Path.of(&quot;README&quot;));
1703             assertEquals(1, entries.size());
1704             entry = entries.get(0);
1705             assertEquals(Path.of(&quot;README&quot;), entry.path());
1706             assertTrue(entry.type().isRegularNonExecutable());
1707         }
1708     }
1709 
1710     @ParameterizedTest
1711     @EnumSource(VCS.class)
1712     void testDump(VCS vcs) throws IOException {
1713         try (var dir = new TemporaryDirectory()) {
1714             var r = Repository.init(dir.path(), vcs);
1715             assertTrue(r.isClean());
1716 
1717             var f = dir.path().resolve(&quot;README&quot;);
1718             Files.writeString(f, &quot;Hello\n&quot;);
1719             r.add(f);
1720             var initial = r.commit(&quot;Initial commit&quot;, &quot;duke&quot;, &quot;duke@openjdk.org&quot;);
1721 
1722             var readme = r.files(initial).get(0);
1723 
1724             var tmp = Files.createTempFile(&quot;README&quot;, &quot;txt&quot;);
1725             r.dump(readme, tmp);
1726             assertEquals(&quot;Hello\n&quot;, Files.readString(tmp));
1727             Files.delete(tmp);
1728         }
1729     }
1730 
1731     @ParameterizedTest
1732     @EnumSource(VCS.class)
1733     void testStatus(VCS vcs) throws IOException {
1734         try (var dir = new TemporaryDirectory()) {
1735             var r = Repository.init(dir.path(), vcs);
1736             assertTrue(r.isClean());
1737 
1738             var f = dir.path().resolve(&quot;README&quot;);
1739             Files.writeString(f, &quot;Hello\n&quot;);
1740             r.add(f);
1741             var initial = r.commit(&quot;Initial commit&quot;, &quot;duke&quot;, &quot;duke@openjdk.org&quot;);
1742 
1743             var f2 = dir.path().resolve(&quot;CONTRIBUTING&quot;);
1744             Files.writeString(f2, &quot;Goodbye\n&quot;);
1745             r.add(f2);
1746             var second = r.commit(&quot;Second commit&quot;, &quot;duke&quot;, &quot;duke@openjdk.org&quot;);
1747 
1748             var entries = r.status(initial, second);
1749             assertEquals(1, entries.size());
1750             var entry = entries.get(0);
1751             assertTrue(entry.status().isAdded());
1752             assertTrue(entry.source().path().isEmpty());
1753             assertTrue(entry.source().type().isEmpty());
1754 
1755             assertTrue(entry.target().path().isPresent());
1756             assertEquals(Path.of(&quot;CONTRIBUTING&quot;), entry.target().path().get());
1757             assertTrue(entry.target().type().get().isRegular());
1758         }
1759     }
1760 
1761     @ParameterizedTest
1762     @EnumSource(VCS.class)
1763     void testTrackLineEndings(VCS vcs) throws IOException, InterruptedException {
1764         try (var dir = new TemporaryDirectory()) {
1765             var r = Repository.init(dir.path(), vcs);
1766             if (vcs == VCS.GIT) { // turn of git&#39;s meddling
1767                 int exitCode = new ProcessBuilder()
1768                         .command(&quot;git&quot;, &quot;config&quot;, &quot;--local&quot;, &quot;core.autocrlf&quot;, &quot;false&quot;)
1769                         .directory(dir.path().toFile())
1770                         .start()
1771                         .waitFor();
1772                 assertEquals(0, exitCode);
1773             }
1774 
1775             var readme = dir.path().resolve(&quot;README&quot;);
1776             Files.writeString(readme, &quot;Line with Unix line ending\n&quot;);
1777             Files.writeString(readme, &quot;Line with Windows line ending\r\n&quot;, APPEND);
1778 
1779             r.add(readme);
1780             r.commit(&quot;Add README&quot;, &quot;duke&quot;, &quot;duke@openjdk.java.net&quot;);
1781 
1782             var commits = r.commits().asList();
1783             assertEquals(1, commits.size());
1784 
1785             var commit = commits.get(0);
1786             var diffs = commit.parentDiffs();
1787             var diff = diffs.get(0);
1788             assertEquals(2, diff.added());
1789 
1790             var patches = diff.patches();
1791             assertEquals(1, patches.size());
1792 
1793             var patch = patches.get(0).asTextualPatch();
1794             var hunks = patch.hunks();
1795             assertEquals(1, hunks.size());
1796 
1797             var hunk = hunks.get(0);
1798             assertEquals(new Range(0, 0), hunk.source().range());
1799             assertEquals(new Range(1, 2), hunk.target().range());
1800 
1801             assertEquals(
1802                     List.of(&quot;Line with Unix line ending&quot;, &quot;Line with Windows line ending\r&quot;),
1803                     hunk.target().lines());
1804         }
1805     }
1806 
1807     @ParameterizedTest
1808     @EnumSource(VCS.class)
1809     void testContains(VCS vcs) throws IOException {
1810         try (var dir = new TemporaryDirectory()) {
1811             var r = Repository.init(dir.path(), vcs);
1812             assertTrue(r.isClean());
1813 
1814             var f = dir.path().resolve(&quot;README&quot;);
1815             Files.writeString(f, &quot;Hello\n&quot;);
1816             r.add(f);
1817             var initial = r.commit(&quot;Initial commit&quot;, &quot;duke&quot;, &quot;duke@openjdk.org&quot;);
1818 
1819             assertTrue(r.contains(r.defaultBranch(), initial));
1820 
1821             Files.writeString(f, &quot;Hello again\n&quot;);
1822             r.add(f);
1823             var second = r.commit(&quot;Second commit&quot;, &quot;duke&quot;, &quot;duke@openjdk.org&quot;);
1824 
1825             assertTrue(r.contains(r.defaultBranch(), initial));
1826         }
1827     }
1828 
1829     @ParameterizedTest
1830     @EnumSource(VCS.class)
1831     void testAbortMerge(VCS vcs) throws IOException {
1832         try (var dir = new TemporaryDirectory()) {
1833             var r = Repository.init(dir.path(), vcs);
1834             assertTrue(r.isClean());
1835 
1836             var f = dir.path().resolve(&quot;README&quot;);
1837             Files.writeString(f, &quot;Hello\n&quot;);
1838             r.add(f);
1839             var initial = r.commit(&quot;Initial commit&quot;, &quot;duke&quot;, &quot;duke@openjdk.org&quot;);
1840 
1841             Files.writeString(f, &quot;Hello again\n&quot;);
1842             r.add(f);
1843             var second = r.commit(&quot;Second commit&quot;, &quot;duke&quot;, &quot;duke@openjdk.org&quot;);
1844 
1845             r.checkout(initial);
1846             Files.writeString(f, &quot;Conflicting hello\n&quot;);
1847             r.add(f);
1848             var third = r.commit(&quot;Third commit&quot;, &quot;duke&quot;, &quot;duke@openjdk.org&quot;);
1849 
1850             assertThrows(IOException.class, () -&gt; { r.merge(second); });
1851 
1852             r.abortMerge();
1853             assertTrue(r.isClean());
1854         }
1855     }
1856 
1857     @ParameterizedTest
1858     @EnumSource(VCS.class)
1859     void testReset(VCS vcs) throws IOException {
1860         assumeTrue(vcs == VCS.GIT); // FIXME reset is not yet implemented for HG
1861 
1862         try (var dir = new TemporaryDirectory()) {
1863             var repo = Repository.init(dir.path(), vcs);
1864             assertTrue(repo.isClean());
1865 
1866             var f = dir.path().resolve(&quot;README&quot;);
1867             Files.writeString(f, &quot;Hello\n&quot;);
1868             repo.add(f);
1869             var initial = repo.commit(&quot;Initial commit&quot;, &quot;duke&quot;, &quot;duke@openjdk.org&quot;);
1870 
1871             Files.writeString(f, &quot;Hello again\n&quot;);
1872             repo.add(f);
1873             var second = repo.commit(&quot;Second commit&quot;, &quot;duke&quot;, &quot;duke@openjdk.org&quot;);
1874 
1875             assertEquals(second, repo.head());
1876             assertEquals(2, repo.commits().asList().size());
1877 
1878             repo.reset(initial, true);
1879 
1880             assertEquals(initial, repo.head());
1881             assertEquals(1, repo.commits().asList().size());
1882         }
1883     }
1884 
1885     @ParameterizedTest
1886     @EnumSource(VCS.class)
1887     void testRemotes(VCS vcs) throws IOException {
1888         try (var dir = new TemporaryDirectory()) {
1889             var repo = Repository.init(dir.path(), vcs);
1890             assertEquals(List.of(), repo.remotes());
1891             repo.addRemote(&quot;foobar&quot;, &quot;https://foo/bar&quot;);
1892             assertEquals(List.of(&quot;foobar&quot;), repo.remotes());
1893         }
1894     }
1895 
1896     @ParameterizedTest
1897     @EnumSource(VCS.class)
1898     void testRemoteBranches(VCS vcs) throws IOException {
1899         try (var dir = new TemporaryDirectory()) {
1900             var upstream = Repository.init(dir.path().resolve(&quot;upstream&quot;), vcs);
1901             var readme = upstream.root().resolve(&quot;README&quot;);
1902             Files.writeString(readme, &quot;Hello\n&quot;);
1903             upstream.add(readme);
1904             var head = upstream.commit(&quot;Added README&quot;, &quot;duke&quot;, &quot;duke@openjdk.org&quot;);
1905 
1906             var fork = Repository.init(dir.path().resolve(&quot;fork&quot;), vcs);
1907             fork.addRemote(&quot;upstream&quot;, upstream.root().toUri().toString());
1908             var refs = fork.remoteBranches(&quot;upstream&quot;);
1909             assertEquals(1, refs.size());
1910             var ref = refs.get(0);
1911             assertEquals(head, ref.hash());
1912             assertEquals(upstream.defaultBranch().name(), ref.name());
1913         }
1914     }
1915 
1916     @ParameterizedTest
1917     @EnumSource(VCS.class)
1918     void testSubmodulesOnEmptyRepo(VCS vcs) throws IOException {
1919         try (var dir = new TemporaryDirectory()) {
1920             var repo = Repository.init(dir.path(), vcs);
1921             assertEquals(List.of(), repo.submodules());
1922         }
1923     }
1924 
1925     @ParameterizedTest
1926     @EnumSource(VCS.class)
1927     void testSubmodulesOnRepoWithNoSubmodules(VCS vcs) throws IOException {
1928         try (var dir = new TemporaryDirectory()) {
1929             var repo = Repository.init(dir.path().resolve(&quot;repo&quot;), vcs);
1930             var readme = repo.root().resolve(&quot;README&quot;);
1931             Files.writeString(readme, &quot;Hello\n&quot;);
1932             repo.add(readme);
1933             repo.commit(&quot;Added README&quot;, &quot;duke&quot;, &quot;duke@openjdk.org&quot;);
1934             assertEquals(List.of(), repo.submodules());
1935         }
1936     }
1937 
1938     @ParameterizedTest
1939     @EnumSource(VCS.class)
1940     void testSubmodulesOnRepoWithSubmodule(VCS vcs) throws IOException {
1941         try (var dir = new TemporaryDirectory()) {
1942             var submodule = Repository.init(dir.path().resolve(&quot;submodule&quot;), vcs);
1943             var readme = submodule.root().resolve(&quot;README&quot;);
1944             Files.writeString(readme, &quot;Hello\n&quot;);
1945             submodule.add(readme);
1946             var head = submodule.commit(&quot;Added README&quot;, &quot;duke&quot;, &quot;duke@openjdk.org&quot;);
1947 
1948             var repo = Repository.init(dir.path().resolve(&quot;repo&quot;), vcs);
1949             var pullPath = submodule.root().toAbsolutePath().toString();
1950             repo.addSubmodule(pullPath, Path.of(&quot;sub&quot;));
1951             repo.commit(&quot;Added submodule&quot;, &quot;duke&quot;, &quot;duke@openjdk.org&quot;);
1952 
1953             var submodules = repo.submodules();
1954             assertEquals(1, submodules.size());
1955             var module = submodules.get(0);
1956             assertEquals(Path.of(&quot;sub&quot;), module.path());
1957             assertEquals(head, module.hash());
1958             assertEquals(pullPath, module.pullPath());
1959         }
1960     }
1961 
1962     @ParameterizedTest
1963     @EnumSource(VCS.class)
1964     void testAnnotateTag(VCS vcs) throws IOException {
1965         try (var dir = new TemporaryDirectory(false)) {
1966             var repo = Repository.init(dir.path(), vcs);
1967             var readme = repo.root().resolve(&quot;README&quot;);
1968             var now = ZonedDateTime.now();
1969             Files.writeString(readme, &quot;Hello\n&quot;);
1970             repo.add(readme);
1971             var head = repo.commit(&quot;Added README&quot;, &quot;duke&quot;, &quot;duke@openjdk.org&quot;);
1972             var tag = repo.tag(head, &quot;1.0&quot;, &quot;Added tag 1.0 for HEAD\n&quot;, &quot;duke&quot;, &quot;duke@openjdk.org&quot;);
1973             var annotated = repo.annotate(tag).get();
1974 
1975             assertEquals(&quot;1.0&quot;, annotated.name());
1976             assertEquals(head, annotated.target());
1977             assertEquals(new Author(&quot;duke&quot;, &quot;duke@openjdk.org&quot;), annotated.author());
1978             assertEquals(now.getYear(), annotated.date().getYear());
1979             assertEquals(now.getMonth(), annotated.date().getMonth());
1980             assertEquals(now.getDayOfYear(), annotated.date().getDayOfYear());
1981             assertEquals(now.getHour(), annotated.date().getHour());
1982             assertEquals(now.getOffset(), annotated.date().getOffset());
1983             assertEquals(&quot;Added tag 1.0 for HEAD\n&quot;, annotated.message());
1984         }
1985     }
1986 
1987     @ParameterizedTest
1988     @EnumSource(VCS.class)
1989     void testAnnotateTagOnMissingTag(VCS vcs) throws IOException {
1990         try (var dir = new TemporaryDirectory()) {
1991             var repo = Repository.init(dir.path(), vcs);
1992             var readme = repo.root().resolve(&quot;README&quot;);
1993             var now = ZonedDateTime.now();
1994             Files.writeString(readme, &quot;Hello\n&quot;);
1995             repo.add(readme);
1996             var head = repo.commit(&quot;Added README&quot;, &quot;duke&quot;, &quot;duke@openjdk.org&quot;);
1997 
1998             assertEquals(Optional.empty(), repo.annotate(new Tag(&quot;unknown&quot;)));
1999         }
2000     }
2001 
2002     @ParameterizedTest
2003     @EnumSource(VCS.class)
2004     void testAnnotateTagOnEmptyRepo(VCS vcs) throws IOException {
2005         try (var dir = new TemporaryDirectory()) {
2006             var repo = Repository.init(dir.path(), vcs);
2007             assertEquals(Optional.empty(), repo.annotate(new Tag(&quot;unknown&quot;)));
2008         }
2009     }
2010 
2011     @ParameterizedTest
2012     @EnumSource(VCS.class)
2013     void testDiffWithFileList(VCS vcs) throws IOException {
2014         try (var dir = new TemporaryDirectory()) {
2015             var repo = Repository.init(dir.path(), vcs);
2016             var readme = repo.root().resolve(&quot;README&quot;);
2017             Files.writeString(readme, &quot;Hello\n&quot;);
2018             repo.add(readme);
2019 
2020             var contribute = repo.root().resolve(&quot;CONTRIBUTE&quot;);
2021             Files.writeString(contribute, &quot;1. Make changes\n&quot;);
2022             repo.add(contribute);
2023 
2024             var first = repo.commit(&quot;Added README and CONTRIBUTE&quot;, &quot;duke&quot;, &quot;duke@openjdk.org&quot;);
2025             Files.writeString(readme, &quot;World\n&quot;, WRITE, APPEND);
2026             Files.writeString(contribute, &quot;2. Run git commit&quot;, WRITE, APPEND);
2027 
2028             var diff = repo.diff(first, List.of(Path.of(&quot;README&quot;)));
2029             assertEquals(1, diff.added());
2030             assertEquals(0, diff.modified());
2031             assertEquals(0, diff.removed());
2032             var patches = diff.patches();
2033             assertEquals(1, patches.size());
2034             var patch = patches.get(0);
2035             assertTrue(patch.isTextual());
2036             assertTrue(patch.status().isModified());
2037             assertEquals(Path.of(&quot;README&quot;), patch.source().path().get());
2038             assertEquals(Path.of(&quot;README&quot;), patch.target().path().get());
2039 
2040             repo.add(readme);
2041             repo.add(contribute);
2042             var second = repo.commit(&quot;Updates to both README and CONTRIBUTE&quot;, &quot;duke&quot;, &quot;duke@openjdk.org&quot;);
2043 
2044             diff = repo.diff(first, second, List.of(Path.of(&quot;CONTRIBUTE&quot;)));
2045             assertEquals(1, diff.added());
2046             assertEquals(0, diff.modified());
2047             assertEquals(0, diff.removed());
2048             patches = diff.patches();
2049             assertEquals(1, patches.size());
2050             patch = patches.get(0);
2051             assertTrue(patch.isTextual());
2052             assertTrue(patch.status().isModified());
2053             assertEquals(Path.of(&quot;CONTRIBUTE&quot;), patch.source().path().get());
2054             assertEquals(Path.of(&quot;CONTRIBUTE&quot;), patch.target().path().get());
2055 
2056             diff = repo.diff(first, second, List.of(Path.of(&quot;DOES_NOT_EXIST&quot;)));
2057             assertEquals(0, diff.patches().size());
2058         }
2059     }
2060 
2061     @ParameterizedTest
2062     @EnumSource(VCS.class)
2063     void testWritingConfigValue(VCS vcs) throws IOException {
2064         try (var dir = new TemporaryDirectory()) {
2065             var repo = Repository.init(dir.path(), vcs);
2066             assertEquals(List.of(), repo.config(&quot;test.key&quot;));
2067             repo.config(&quot;test&quot;, &quot;key&quot;, &quot;value&quot;);
2068             assertEquals(List.of(&quot;value&quot;), repo.config(&quot;test.key&quot;));
2069         }
2070     }
2071 
2072     @ParameterizedTest
2073     @EnumSource(VCS.class)
2074     void testFetchRemote(VCS vcs) throws IOException {
2075         try (var dir = new TemporaryDirectory()) {
2076             var upstream = Repository.init(dir.path(), vcs);
2077             var readme = dir.path().resolve(&quot;README&quot;);
2078             Files.write(readme, List.of(&quot;Hello, readme!&quot;));
2079 
2080             upstream.add(readme);
2081             upstream.commit(&quot;Add README&quot;, &quot;duke&quot;, &quot;duke@openjdk.java.net&quot;);
2082 
2083             try (var dir2 = new TemporaryDirectory()) {
2084                 var downstream = Repository.init(dir2.path(), vcs);
2085 
2086                  // note: forcing unix path separators for URI
2087                 var upstreamURI = URI.create(&quot;file:///&quot; + dir.toString().replace(&#39;\\&#39;, &#39;/&#39;));
2088                 downstream.addRemote(&quot;upstream&quot;, upstreamURI.toString());
2089                 downstream.addRemote(&quot;foobar&quot;, &quot;file:///this/path/does/not/exist&quot;);
2090                 downstream.fetchRemote(&quot;upstream&quot;);
2091             }
2092         }
2093     }
2094 
2095     @ParameterizedTest
2096     @EnumSource(VCS.class)
2097     void testPrune(VCS vcs) throws IOException {
2098         assumeTrue(vcs == VCS.GIT); // FIXME hard to test with hg due to bookmarks and branches
2099         try (var dir = new TemporaryDirectory(false)) {
2100             var upstreamDir = dir.path().resolve(&quot;upstream&quot; + (vcs == VCS.GIT ? &quot;.git&quot; : &quot;.hg&quot;));
2101             var upstream = Repository.init(upstreamDir, vcs);
2102 
2103             Files.write(upstream.root().resolve(&quot;.git&quot;).resolve(&quot;config&quot;),
2104                         List.of(&quot;[receive]&quot;, &quot;denyCurrentBranch=ignore&quot;),
2105                         WRITE, APPEND);
2106 
2107             var readme = upstreamDir.resolve(&quot;README&quot;);
2108             Files.write(readme, List.of(&quot;Hello, readme!&quot;));
2109 
2110             upstream.add(readme);
2111             var head = upstream.commit(&quot;Add README&quot;, &quot;duke&quot;, &quot;duke@openjdk.java.net&quot;);
2112             var branch = upstream.branch(head, &quot;foo&quot;);
2113             var upstreamBranches = upstream.branches();
2114             assertEquals(2, upstreamBranches.size());
2115             assertTrue(upstreamBranches.contains(branch));
2116 
2117             var upstreamURI = URI.create(&quot;file:///&quot; + upstreamDir.toString().replace(&#39;\\&#39;, &#39;/&#39;));
2118             var downstreamDir = dir.path().resolve(&quot;downstream&quot;);
2119             var downstream = Repository.clone(upstreamURI, downstreamDir);
2120 
2121             // Ensure that &#39;foo&#39; branch is materialized downstream
2122             downstream.checkout(branch);
2123             downstream.checkout(downstream.defaultBranch());
2124 
2125             var remotes = downstream.remotes();
2126             assertEquals(1, remotes.size());
2127             var downstreamBranches = downstream.branches();
2128             assertEquals(2, downstreamBranches.size());
2129             assertEquals(downstreamBranches, upstreamBranches);
2130 
2131             downstream.prune(branch, remotes.get(0));
2132 
2133             downstreamBranches = downstream.branches();
2134             assertEquals(1, downstreamBranches.size());
2135             assertEquals(List.of(downstream.defaultBranch()), downstreamBranches);
2136 
2137             upstreamBranches = upstream.branches();
2138             assertEquals(1, upstreamBranches.size());
2139             assertEquals(List.of(upstream.defaultBranch()), upstreamBranches);
2140         }
2141     }
2142 
2143     @ParameterizedTest
2144     @EnumSource(VCS.class)
2145     void testUnmergedStatus(VCS vcs) throws IOException {
2146         assumeTrue(vcs == VCS.GIT);
2147         try (var dir = new TemporaryDirectory(false)) {
2148             var r = Repository.init(dir.path(), vcs);
2149 
2150             var readme = dir.path().resolve(&quot;README&quot;);
2151             Files.write(readme, List.of(&quot;Hello, world!&quot;));
2152             r.add(readme);
2153             var first = r.commit(&quot;Added README&quot;, &quot;duke&quot;, &quot;duke@openjdk.java.net&quot;);
2154 
2155             Files.write(readme, List.of(&quot;One more line&quot;), WRITE, APPEND);
2156             r.add(readme);
2157             var second = r.commit(&quot;Modified README&quot;, &quot;duke&quot;, &quot;duke@openjdk.java.net&quot;);
2158 
2159             r.checkout(first, false);
2160 
2161             Files.write(readme, List.of(&quot;Another line&quot;), WRITE, APPEND);
2162             r.add(readme);
2163             var third = r.commit(&quot;Modified README again&quot;, &quot;duke&quot;, &quot;duke@openjdk.java.net&quot;);
2164 
2165             assertThrows(IOException.class, () -&gt; { r.merge(second); });
2166 
2167             var status = r.status();
2168             for (var s : status) {
2169                 System.out.println(s.status() + &quot; &quot; + s.source().path().get());
2170             }
2171             assertEquals(2, status.size());
2172             var statusEntry = status.get(0);
2173             assertTrue(statusEntry.status().isUnmerged());
2174             assertEquals(Path.of(&quot;README&quot;), statusEntry.source().path().get());
2175             assertEquals(Optional.empty(), statusEntry.source().type());
2176             assertEquals(Hash.zero(), statusEntry.source().hash());
2177         }
2178     }
2179 
2180     @ParameterizedTest
2181     @EnumSource(VCS.class)
2182     void testRangeSingle(VCS vcs) throws IOException {
2183         try (var dir = new TemporaryDirectory()) {
2184             var repo = Repository.init(dir.path(), vcs);
2185             var range = repo.range(new Hash(&quot;0123456789&quot;));
2186             if (vcs == VCS.GIT) {
2187                 assertEquals(&quot;0123456789^!&quot;, range);
2188             } else if (vcs == VCS.HG) {
2189                 assertEquals(&quot;0123456789&quot;, range);
2190             } else {
2191                 fail(&quot;Unexpected vcs: &quot; + vcs);
2192             }
2193         }
2194     }
2195 
2196     @ParameterizedTest
2197     @EnumSource(VCS.class)
2198     void testRangeInclusive(VCS vcs) throws IOException {
2199         try (var dir = new TemporaryDirectory()) {
2200             var repo = Repository.init(dir.path(), vcs);
2201             var range = repo.rangeInclusive(new Hash(&quot;01234&quot;), new Hash(&quot;56789&quot;));
2202             if (vcs == VCS.GIT) {
2203                 assertEquals(&quot;01234^..56789&quot;, range);
2204             } else if (vcs == VCS.HG) {
2205                 assertEquals(&quot;01234:56789&quot;, range);
2206             } else {
2207                 fail(&quot;Unexpected vcs: &quot; + vcs);
2208             }
2209         }
2210     }
2211 
2212     @ParameterizedTest
2213     @EnumSource(VCS.class)
2214     void testRangeExclusive(VCS vcs) throws IOException {
2215         try (var dir = new TemporaryDirectory()) {
2216             var repo = Repository.init(dir.path(), vcs);
2217             var range = repo.rangeExclusive(new Hash(&quot;01234&quot;), new Hash(&quot;56789&quot;));
2218             if (vcs == VCS.GIT) {
2219                 assertEquals(&quot;01234..56789&quot;, range);
2220             } else if (vcs == VCS.HG) {
2221                 assertEquals(&quot;01234:56789-01234&quot;, range);
2222             } else {
2223                 fail(&quot;Unexpected vcs: &quot; + vcs);
2224             }
2225         }
2226     }
2227 
2228     @Test
2229     void testHgRepoNestedInGitRepo() throws IOException {
2230         try (var gitDir = new TemporaryDirectory()) {
2231             var gitRepo = Repository.init(gitDir.path(), VCS.GIT);
2232             var gitFile = gitRepo.root().resolve(&quot;git-file.txt&quot;);
2233             Files.write(gitFile, List.of(&quot;Hello, Git!&quot;));
2234             gitRepo.add(gitFile);
2235             var gitHash = gitRepo.commit(&quot;Added git-file.txt&quot;, &quot;duke&quot;, &quot;duke@openjdk.java.net&quot;);
2236 
2237             var hgDir = gitRepo.root().resolve(&quot;hg&quot;);
2238             var hgRepo = Repository.init(hgDir, VCS.HG);
2239             var hgFile = hgRepo.root().resolve(&quot;hg-file.txt&quot;);
2240             Files.write(hgFile, List.of(&quot;Hello, Mercurial!&quot;));
2241             hgRepo.add(hgFile);
2242             var hgHash = hgRepo.commit(&quot;Added hg-file.txt&quot;, &quot;duke&quot;, &quot;duke@openjdk.java.net&quot;);
2243 
2244             var resolvedHgRepo = Repository.get(hgDir).orElseThrow();
2245             var resolvedHgCommits = resolvedHgRepo.commits().asList();
2246             assertEquals(1, resolvedHgCommits.size());
2247             assertEquals(hgHash, resolvedHgCommits.get(0).hash());
2248 
2249             var resolvedGitRepo = Repository.get(gitDir.path()).orElseThrow();
2250             var resolvedGitCommits = resolvedGitRepo.commits().asList();
2251             assertEquals(1, resolvedGitCommits.size());
2252             assertEquals(gitHash, resolvedGitCommits.get(0).hash());
2253         }
2254     }
2255 
2256     @Test
2257     void testGitRepoNestedInHgRepo() throws IOException {
2258         try (var hgDir = new TemporaryDirectory()) {
2259             var hgRepo = Repository.init(hgDir.path(), VCS.HG);
2260             var hgFile = hgRepo.root().resolve(&quot;hg-file.txt&quot;);
2261             Files.write(hgFile, List.of(&quot;Hello, Mercurial!&quot;));
2262             hgRepo.add(hgFile);
2263             var hgHash = hgRepo.commit(&quot;Added hg-file.txt&quot;, &quot;duke&quot;, &quot;duke@openjdk.java.net&quot;);
2264 
2265             var gitDir = hgRepo.root().resolve(&quot;git&quot;);
2266             var gitRepo = Repository.init(gitDir, VCS.GIT);
2267             var gitFile = gitRepo.root().resolve(&quot;git-file.txt&quot;);
2268             Files.write(gitFile, List.of(&quot;Hello, Git!&quot;));
2269             gitRepo.add(gitFile);
2270             var gitHash = gitRepo.commit(&quot;Added git-file.txt&quot;, &quot;duke&quot;, &quot;duke@openjdk.java.net&quot;);
2271 
2272             var resolvedHgRepo = Repository.get(hgDir.path()).orElseThrow();
2273             var resolvedHgCommits = resolvedHgRepo.commits().asList();
2274             assertEquals(1, resolvedHgCommits.size());
2275             assertEquals(hgHash, resolvedHgCommits.get(0).hash());
2276 
2277             var resolvedGitRepo = Repository.get(gitDir).orElseThrow();
2278             var resolvedGitCommits = resolvedGitRepo.commits().asList();
2279             assertEquals(1, resolvedGitCommits.size());
2280             assertEquals(gitHash, resolvedGitCommits.get(0).hash());
2281         }
2282     }
2283 
2284     @Test
2285     void testGitAndHgRepoInSameDirectory() throws IOException {
2286         try (var dir = new TemporaryDirectory()) {
2287             var hgRepo = Repository.init(dir.path(), VCS.HG);
2288             var hgFile = hgRepo.root().resolve(&quot;hg-file.txt&quot;);
2289             Files.write(hgFile, List.of(&quot;Hello, Mercurial!&quot;));
2290             hgRepo.add(hgFile);
2291             var hgHash = hgRepo.commit(&quot;Added hg-file.txt&quot;, &quot;duke&quot;, &quot;duke@openjdk.java.net&quot;);
2292 
2293             var gitRepo = Repository.init(dir.path(), VCS.GIT);
2294             var gitFile = gitRepo.root().resolve(&quot;git-file.txt&quot;);
2295             Files.write(gitFile, List.of(&quot;Hello, Git!&quot;));
2296             gitRepo.add(gitFile);
2297             var gitHash = gitRepo.commit(&quot;Added git-file.txt&quot;, &quot;duke&quot;, &quot;duke@openjdk.java.net&quot;);
2298 
2299             assertThrows(IOException.class, () -&gt; Repository.get(dir.path()));
2300         }
2301     }
2302 
2303     @Test
2304     void testCommitterDate() throws IOException {
2305         try (var dir = new TemporaryDirectory()) {
2306             var repo = Repository.init(dir.path(), VCS.GIT);
2307             var readme = dir.path().resolve(&quot;README&quot;);
2308             Files.write(readme, List.of(&quot;Hello, readme!&quot;));
2309 
2310             repo.add(readme);
2311             var authored = ZonedDateTime.parse(&quot;2020-06-15T14:27:13+02:00&quot;);
2312             var committed = authored.plusMinutes(10);
2313             var head = repo.commit(&quot;Add README&quot;,
2314                                    &quot;author&quot;, &quot;author@openjdk.java.net&quot;, authored,
2315                                    &quot;committer&quot;, &quot;committer@openjdk.java.net&quot;, committed);
2316             var commit = repo.lookup(head).orElseThrow();
2317             assertEquals(&quot;author&quot;, commit.author().name());
2318             assertEquals(&quot;author@openjdk.java.net&quot;, commit.author().email());
2319             assertEquals(authored, commit.authored());
2320 
2321             assertEquals(&quot;committer&quot;, commit.committer().name());
2322             assertEquals(&quot;committer@openjdk.java.net&quot;, commit.committer().email());
2323             assertEquals(committed, commit.committed());
2324         }
2325     }
2326 
2327     @Test
2328     void testLightweightTags() throws IOException, InterruptedException {
2329         try (var dir = new TemporaryDirectory()) {
2330             var repo = Repository.init(dir.path(), VCS.GIT);
2331             var readme = dir.path().resolve(&quot;README&quot;);
2332             Files.write(readme, List.of(&quot;Hello, readme!&quot;));
2333 
2334             repo.add(readme);
2335             var head = repo.commit(&quot;Add README&quot;, &quot;author&quot;, &quot;author@openjdk.java.net&quot;);
2336 
2337             // We don&#39;t want to expose making lightweight tags via the Repository class,
2338             // so use a ProcessBuilder and invoke git directly here
2339             var pb = new ProcessBuilder(&quot;git&quot;, &quot;tag&quot;, &quot;test-tag&quot;, head.hex());
2340             pb.directory(repo.root().toFile());
2341             assertEquals(0, pb.start().waitFor());
2342 
2343             var tags = repo.tags();
2344             assertEquals(1, tags.size());
2345 
2346             var tag = tags.get(0);
2347             assertEquals(&quot;test-tag&quot;, tag.name());
2348 
2349             // Lightweight tags can&#39;t be annotated
2350             assertEquals(Optional.empty(), repo.annotate(tag));
2351         }
2352     }
2353 }
    </pre>
  </body>
</html>