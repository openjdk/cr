<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Frames bots/mlbridge/src/test/java/org/openjdk/skara/bots/mlbridge/MailingListBridgeBotTests.java</title>
    <link rel="stylesheet" href="../../../../../../../../../../style.css" />
    <script type="text/javascript" src="../../../../../../../../../../navigation.js"></script>
  </head>
<body onkeypress="keypress(event);">
<a name="0"></a>
<hr />
<pre>   1 /*
   2  * Copyright (c) 2019, Oracle and/or its affiliates. All rights reserved.
   3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   4  *
   5  * This code is free software; you can redistribute it and/or modify it
   6  * under the terms of the GNU General Public License version 2 only, as
   7  * published by the Free Software Foundation.
   8  *
   9  * This code is distributed in the hope that it will be useful, but WITHOUT
  10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
  11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
  12  * version 2 for more details (a copy is included in the LICENSE file that
  13  * accompanied this code).
  14  *
  15  * You should have received a copy of the GNU General Public License version
  16  * 2 along with this work; if not, write to the Free Software Foundation,
  17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
  18  *
  19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
  20  * or visit www.oracle.com if you need additional information or have any
  21  * questions.
  22  */
  23 package org.openjdk.skara.bots.mlbridge;
  24 
  25 import org.openjdk.skara.email.EmailAddress;
  26 import org.openjdk.skara.host.Review;
  27 import org.openjdk.skara.host.network.URIBuilder;
  28 import org.openjdk.skara.mailinglist.MailingListServerFactory;
  29 import org.openjdk.skara.test.*;
  30 import org.openjdk.skara.vcs.Repository;
  31 
  32 import org.junit.jupiter.api.*;
  33 
  34 import java.io.IOException;
  35 import java.nio.charset.StandardCharsets;
  36 import java.nio.file.*;
  37 import java.time.Duration;
  38 import java.util.*;
  39 import java.util.regex.Pattern;
  40 import java.util.stream.Collectors;
  41 
  42 import static org.junit.jupiter.api.Assertions.*;
  43 
  44 class MailingListBridgeBotTests {
  45     private boolean archiveContains(Path archive, String text) {
  46         return archiveContainsCount(archive, text) &gt; 0;
  47     }
  48 
  49     private int archiveContainsCount(Path archive, String text) {
  50         try {
  51             var mbox = Files.find(archive, 50, (path, attrs) -&gt; path.toString().endsWith(&quot;.mbox&quot;)).findAny();
  52             if (mbox.isEmpty()) {
  53                 return 0;
  54             }
  55             var lines = Files.readString(mbox.get(), StandardCharsets.UTF_8);
  56             var pattern = Pattern.compile(text);
  57             int count = 0;
  58             for (var line : lines.split(&quot;\\R&quot;)) {
  59                 var matcher = pattern.matcher(line);
  60                 if (matcher.find()) {
  61                     count++;
  62                 }
  63             }
  64             return count;
  65         } catch (IOException e) {
  66             return 0;
  67         }
  68     }
  69 
  70     private boolean webrevContains(Path webrev, String text) {
  71         try {
  72             var index = Files.find(webrev, 5, (path, attrs) -&gt; path.toString().endsWith(&quot;index.html&quot;)).findAny();
  73             if (index.isEmpty()) {
  74                 return false;
  75             }
  76             var lines = Files.readString(index.get(), StandardCharsets.UTF_8);
  77             return lines.contains(text);
  78         } catch (IOException e) {
  79             return false;
  80         }
  81     }
  82 
  83     private long countSubstrings(String string, String substring) {
  84         return Pattern.compile(substring).matcher(string).results().count();
  85     }
  86 
  87     @Test
  88     void simpleArchive(TestInfo testInfo) throws IOException {
  89         try (var credentials = new HostCredentials(testInfo);
  90              var tempFolder = new TemporaryDirectory();
  91              var archiveFolder = new TemporaryDirectory();
  92              var webrevFolder = new TemporaryDirectory();
  93              var listServer = new TestMailmanServer()) {
  94             var author = credentials.getHostedRepository();
  95             var archive = credentials.getHostedRepository();
  96             var ignored = credentials.getHostedRepository();
  97             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
  98             var censusBuilder = credentials.getCensusBuilder()
  99                                            .addAuthor(author.host().getCurrentUserDetails().id());
 100             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
 101             var mlBot = new MailingListBridgeBot(from, author, archive, censusBuilder.build(), &quot;master&quot;, listAddress,
 102                                                  Set.of(ignored.host().getCurrentUserDetails().userName()),
 103                                                  Set.of(),
 104                                                  listServer.getArchive(), listServer.getSMTP(),
 105                                                  archive, &quot;webrev&quot;, Path.of(&quot;test&quot;),
 106                                                  URIBuilder.base(&quot;http://www.test.test/&quot;).build(),
 107                                                  Set.of(&quot;rfr&quot;), Map.of(ignored.host().getCurrentUserDetails().userName(),
 108                                                                        Pattern.compile(&quot;ready&quot;)));
 109 
 110             // Populate the projects repository
 111             var localRepo = CheckableRepository.init(tempFolder.path(), author.getRepositoryType());
 112             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
 113             localRepo.push(masterHash, author.getUrl(), &quot;master&quot;, true);
 114             localRepo.push(masterHash, archive.getUrl(), &quot;webrev&quot;, true);
 115 
 116             // Make a change with a corresponding PR
 117             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;A simple change&quot;,
 118                                                                &quot;Change msg\n\nWith several lines&quot;);
 119             localRepo.push(editHash, author.getUrl(), &quot;edit&quot;, true);
 120             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
 121             pr.setBody(&quot;This should not be ready&quot;);
 122 
 123             // Run an archive pass
 124             TestBotRunner.runPeriodicItems(mlBot);
 125 
 126             // A PR that isn&#39;t ready for review should not be archived
 127             Repository.materialize(archiveFolder.path(), archive.getUrl(), &quot;master&quot;);
 128             assertFalse(archiveContains(archiveFolder.path(), &quot;This is a pull request&quot;));
 129 
 130             // Flag it as ready for review
 131             pr.setBody(&quot;This should now be ready&quot;);
 132             pr.addLabel(&quot;rfr&quot;);
 133 
 134             // Run another archive pass
 135             TestBotRunner.runPeriodicItems(mlBot);
 136 
 137             // But it should still not be archived
 138             Repository.materialize(archiveFolder.path(), archive.getUrl(), &quot;master&quot;);
 139             assertFalse(archiveContains(archiveFolder.path(), &quot;This is a pull request&quot;));
 140 
 141             // Now post a general comment - not a ready marker
 142             var ignoredPr = ignored.getPullRequest(pr.getId());
 143             ignoredPr.addComment(&quot;hello there&quot;);
 144 
 145             // Run another archive pass
 146             TestBotRunner.runPeriodicItems(mlBot);
 147 
 148             // It should still not be archived
 149             Repository.materialize(archiveFolder.path(), archive.getUrl(), &quot;master&quot;);
 150             assertFalse(archiveContains(archiveFolder.path(), &quot;This is a pull request&quot;));
 151 
 152             // Now post a ready comment
 153             ignoredPr.addComment(&quot;ready&quot;);
 154 
 155             // Run another archive pass
 156             TestBotRunner.runPeriodicItems(mlBot);
 157 
 158             // The archive should now contain an entry
 159             Repository.materialize(archiveFolder.path(), archive.getUrl(), &quot;master&quot;);
 160             assertTrue(archiveContains(archiveFolder.path(), &quot;This is a pull request&quot;));
 161             assertTrue(archiveContains(archiveFolder.path(), &quot;This should now be ready&quot;));
 162             assertTrue(archiveContains(archiveFolder.path(), &quot;Patch:&quot;));
 163             assertTrue(archiveContains(archiveFolder.path(), &quot;Pull request:&quot;));
 164             assertTrue(archiveContains(archiveFolder.path(), &quot;Webrev:&quot;));
 165             assertTrue(archiveContains(archiveFolder.path(), &quot;http://www.test.test/&quot;));
 166             assertTrue(archiveContains(archiveFolder.path(), &quot;webrev.00&quot;));
 167             assertTrue(archiveContains(archiveFolder.path(), &quot;Fetch command:&quot;));
 168             assertTrue(archiveContains(archiveFolder.path(), &quot;^ - &quot; + editHash.abbreviate() + &quot;:\tChange msg&quot;));
 169             assertTrue(archiveContains(archiveFolder.path(), &quot;^\t\t\tWith several lines&quot;));
 170 
 171             // The mailing list as well
 172             listServer.processIncoming();
 173             var mailmanServer = MailingListServerFactory.createMailmanServer(listServer.getArchive(), listServer.getSMTP());
 174             var mailmanList = mailmanServer.getList(listAddress.address());
 175             var conversations = mailmanList.conversations(Duration.ofDays(1));
 176             assertEquals(1, conversations.size());
 177             var mail = conversations.get(0).first();
 178             assertEquals(&quot;RFR: This is a pull request&quot;, mail.subject());
 179             assertEquals(pr.getAuthor().fullName() + &quot; via &quot; + pr.repository().getUrl().getHost(), mail.author().fullName().orElseThrow());
 180             assertEquals(from.address(), mail.author().address());
 181             assertEquals(from, mail.sender());
 182 
 183             // And there should be a webrev
 184             Repository.materialize(webrevFolder.path(), archive.getUrl(), &quot;webrev&quot;);
 185             assertTrue(webrevContains(webrevFolder.path(), &quot;1 lines changed&quot;));
 186             var comments = pr.getComments();
 187             var webrevComments = comments.stream()
 188                                          .filter(comment -&gt; comment.author().equals(author.host().getCurrentUserDetails()))
 189                                          .filter(comment -&gt; comment.body().contains(&quot;webrev&quot;))
 190                                          .filter(comment -&gt; comment.body().contains(editHash.hex()))
 191                                          .collect(Collectors.toList());
 192             assertEquals(1, webrevComments.size());
 193 
 194             // Add a comment
 195             pr.addComment(&quot;This is a comment :smile:&quot;);
 196 
 197             // Add a comment from an ignored user as well
 198             ignoredPr.addComment(&quot;Don&#39;t mind me&quot;);
 199 
 200             // Run another archive pass
 201             TestBotRunner.runPeriodicItems(mlBot);
 202 
 203             // The archive should now contain the comment, but not the ignored one
 204             Repository.materialize(archiveFolder.path(), archive.getUrl(), &quot;master&quot;);
 205             assertTrue(archiveContains(archiveFolder.path(), &quot;This is a comment&quot;));
 206             assertTrue(archiveContains(archiveFolder.path(), &quot;&gt; This should now be ready&quot;));
 207             assertFalse(archiveContains(archiveFolder.path(), &quot;Don&#39;t mind me&quot;));
 208 
 209             listServer.processIncoming();
 210             conversations = mailmanList.conversations(Duration.ofDays(1));
 211             assertEquals(1, conversations.size());
 212             assertEquals(2, conversations.get(0).allMessages().size());
 213 
 214             // Remove the rfr flag and post another comment
 215             pr.addLabel(&quot;rfr&quot;);
 216             pr.addComment(&quot;This is another comment&quot;);
 217 
 218             // Run another archive pass
 219             TestBotRunner.runPeriodicItems(mlBot);
 220 
 221             // The archive should contain the additional comment
 222             Repository.materialize(archiveFolder.path(), archive.getUrl(), &quot;master&quot;);
 223             assertTrue(archiveContains(archiveFolder.path(), &quot;This is another comment&quot;));
 224             assertTrue(archiveContains(archiveFolder.path(), &quot;&gt;&gt; This should now be ready&quot;));
 225 
 226             listServer.processIncoming();
 227             conversations = mailmanList.conversations(Duration.ofDays(1));
 228             assertEquals(1, conversations.size());
 229             assertEquals(3, conversations.get(0).allMessages().size());
 230             for (var newMail : conversations.get(0).allMessages()) {
 231                 assertEquals(from.address(), newMail.author().address());
 232                 assertEquals(from, newMail.sender());
 233             }
 234             assertTrue(conversations.get(0).allMessages().get(2).body().contains(&quot;This is a comment ðŸ˜„&quot;));
 235         }
 236     }
 237 
 238     @Test
 239     void reviewComment(TestInfo testInfo) throws IOException {
 240         try (var credentials = new HostCredentials(testInfo);
 241              var tempFolder = new TemporaryDirectory();
 242              var archiveFolder = new TemporaryDirectory();
 243              var listServer = new TestMailmanServer()) {
 244             var author = credentials.getHostedRepository();
 245             var archive = credentials.getHostedRepository();
 246             var ignored = credentials.getHostedRepository();
 247             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
 248             var censusBuilder = credentials.getCensusBuilder()
 249                                            .addAuthor(author.host().getCurrentUserDetails().id());
 250             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
 251             var mlBot = new MailingListBridgeBot(from, author, archive, censusBuilder.build(), &quot;master&quot;, listAddress,
 252                                                  Set.of(ignored.host().getCurrentUserDetails().userName()),
 253                                                  Set.of(),
 254                                                  listServer.getArchive(), listServer.getSMTP(),
 255                                                  archive, &quot;webrev&quot;, Path.of(&quot;test&quot;),
 256                                                  URIBuilder.base(&quot;http://www.test.test/&quot;).build(),
 257                                                  Set.of(), Map.of());
 258 
 259             // Populate the projects repository
 260             var reviewFile = Path.of(&quot;reviewfile.txt&quot;);
 261             var localRepo = CheckableRepository.init(tempFolder.path(), author.getRepositoryType(), reviewFile);
 262             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
 263             localRepo.push(masterHash, author.getUrl(), &quot;master&quot;, true);
 264             localRepo.push(masterHash, archive.getUrl(), &quot;webrev&quot;, true);
 265 
 266             // Make a change with a corresponding PR
 267             var editHash = CheckableRepository.appendAndCommit(localRepo);
 268             localRepo.push(editHash, author.getUrl(), &quot;edit&quot;, true);
 269             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
 270             pr.setBody(&quot;This is now ready&quot;);
 271             TestBotRunner.runPeriodicItems(mlBot);
 272             listServer.processIncoming();
 273 
 274             // And make a file specific comment
 275             var currentMaster = localRepo.resolve(&quot;master&quot;).orElseThrow();
 276             var comment = pr.addReviewComment(masterHash, editHash, reviewFile.toString(), 2, &quot;Review comment&quot;);
 277 
 278             // Add one from an ignored user as well
 279             var ignoredPr = ignored.getPullRequest(pr.getId());
 280             ignoredPr.addReviewComment(masterHash, editHash, reviewFile.toString(), 2, &quot;Don&#39;t mind me&quot;);
 281 
 282             // Process comments
 283             TestBotRunner.runPeriodicItems(mlBot);
 284             listServer.processIncoming();
 285 
 286             // The archive should now contain an entry
 287             Repository.materialize(archiveFolder.path(), archive.getUrl(), &quot;master&quot;);
 288             assertTrue(archiveContains(archiveFolder.path(), &quot;This is a pull request&quot;));
 289             assertTrue(archiveContains(archiveFolder.path(), &quot;This is now ready&quot;));
 290             assertTrue(archiveContains(archiveFolder.path(), &quot;Review comment&quot;));
 291             assertTrue(archiveContains(archiveFolder.path(), &quot;&gt; This is now ready&quot;));
 292             assertTrue(archiveContains(archiveFolder.path(), reviewFile.toString()));
 293             assertFalse(archiveContains(archiveFolder.path(), &quot;Don&#39;t mind me&quot;));
 294 
 295             // The mailing list as well
 296             var mailmanServer = MailingListServerFactory.createMailmanServer(listServer.getArchive(), listServer.getSMTP());
 297             var mailmanList = mailmanServer.getList(listAddress.address());
 298             var conversations = mailmanList.conversations(Duration.ofDays(1));
 299             assertEquals(1, conversations.size());
 300             var mail = conversations.get(0).first();
 301             assertEquals(&quot;RFR: This is a pull request&quot;, mail.subject());
 302 
 303             // Comment on the comment
 304             pr.addReviewCommentReply(comment, &quot;This is a review reply&quot;);
 305             TestBotRunner.runPeriodicItems(mlBot);
 306             listServer.processIncoming();
 307 
 308             // The archive should contain the additional comment
 309             Repository.materialize(archiveFolder.path(), archive.getUrl(), &quot;master&quot;);
 310             assertTrue(archiveContains(archiveFolder.path(), &quot;This is a review reply&quot;));
 311             assertTrue(archiveContains(archiveFolder.path(), &quot;&gt;&gt; This is now ready&quot;));
 312 
 313             // As well as the mailing list
 314             conversations = mailmanList.conversations(Duration.ofDays(1));
 315             assertEquals(1, conversations.size());
 316             assertEquals(3, conversations.get(0).allMessages().size());
 317             for (var newMail : conversations.get(0).allMessages()) {
 318                 assertEquals(from.address(), newMail.author().address());
 319                 assertEquals(from, newMail.sender());
 320             }
 321         }
 322     }
 323 
 324     @Test
 325     void combineComments(TestInfo testInfo) throws IOException {
 326         try (var credentials = new HostCredentials(testInfo);
 327              var tempFolder = new TemporaryDirectory();
 328              var archiveFolder = new TemporaryDirectory();
 329              var listServer = new TestMailmanServer()) {
 330             var author = credentials.getHostedRepository();
 331             var archive = credentials.getHostedRepository();
 332             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
 333             var censusBuilder = credentials.getCensusBuilder()
 334                                            .addAuthor(author.host().getCurrentUserDetails().id());
 335             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
 336             var mlBot = new MailingListBridgeBot(from, author, archive, censusBuilder.build(), &quot;master&quot;,
 337                                                  listAddress, Set.of(), Set.of(),
 338                                                  listServer.getArchive(),
 339                                                  listServer.getSMTP(),
 340                                                  archive, &quot;webrev&quot;, Path.of(&quot;test&quot;),
 341                                                  URIBuilder.base(&quot;http://www.test.test/&quot;).build(),
 342                                                  Set.of(), Map.of());
 343 
 344             // Populate the projects repository
 345             var reviewFile = Path.of(&quot;reviewfile.txt&quot;);
 346             var localRepo = CheckableRepository.init(tempFolder.path(), author.getRepositoryType(), reviewFile);
 347             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
 348             localRepo.push(masterHash, author.getUrl(), &quot;master&quot;, true);
 349             localRepo.push(masterHash, archive.getUrl(), &quot;webrev&quot;, true);
 350 
 351             // Make a change with a corresponding PR
 352             var editHash = CheckableRepository.appendAndCommit(localRepo);
 353             localRepo.push(editHash, author.getUrl(), &quot;edit&quot;, true);
 354             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
 355             pr.setBody(&quot;This is now ready&quot;);
 356             TestBotRunner.runPeriodicItems(mlBot);
 357             listServer.processIncoming();
 358 
 359             // Make two file specific comments
 360             pr.addReviewComment(masterHash, editHash, reviewFile.toString(), 2, &quot;Review comment&quot;);
 361             pr.addReviewComment(masterHash, editHash, reviewFile.toString(), 2, &quot;Another review comment&quot;);
 362             TestBotRunner.runPeriodicItems(mlBot);
 363             listServer.processIncoming();
 364 
 365             // The archive should contain a combined entry
 366             Repository.materialize(archiveFolder.path(), archive.getUrl(), &quot;master&quot;);
 367             assertEquals(1, archiveContainsCount(archiveFolder.path(), &quot;^On.*wrote:&quot;));
 368 
 369             // As well as the mailing list
 370             var mailmanServer = MailingListServerFactory.createMailmanServer(listServer.getArchive(), listServer.getSMTP());
 371             var mailmanList = mailmanServer.getList(listAddress.address());
 372             var conversations = mailmanList.conversations(Duration.ofDays(1));
 373             assertEquals(1, conversations.size());
 374             var mail = conversations.get(0).first();
 375             assertEquals(&quot;RFR: This is a pull request&quot;, mail.subject());
 376             assertEquals(2, conversations.get(0).allMessages().size());
 377 
 378             var reply = conversations.get(0).replies(mail).get(0);
 379             assertEquals(2, reply.body().split(&quot;^On.*wrote:&quot;).length);
 380             assertEquals(2, reply.body().split(&quot;&gt; This is now ready&quot;).length, reply.body());
 381             assertEquals(&quot;Re: RFR: This is a pull request&quot;, reply.subject());
 382             assertTrue(reply.body().contains(&quot;Review comment\n\n&quot;), reply.body());
 383             assertTrue(reply.body().contains(&quot;Another review comment&quot;), reply.body());
 384         }
 385     }
 386 
 387     @Test
 388     void commentThreading(TestInfo testInfo) throws IOException {
 389         try (var credentials = new HostCredentials(testInfo);
 390              var tempFolder = new TemporaryDirectory();
 391              var archiveFolder = new TemporaryDirectory();
 392              var listServer = new TestMailmanServer()) {
 393             var author = credentials.getHostedRepository();
 394             var reviewer = credentials.getHostedRepository();
 395             var archive = credentials.getHostedRepository();
 396             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
 397             var censusBuilder = credentials.getCensusBuilder()
 398                                            .addReviewer(reviewer.host().getCurrentUserDetails().id())
 399                                            .addAuthor(author.host().getCurrentUserDetails().id());
 400             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
 401             var mlBot = new MailingListBridgeBot(from, author, archive, censusBuilder.build(), &quot;master&quot;,
 402                                                  listAddress, Set.of(), Set.of(),
 403                                                  listServer.getArchive(),
 404                                                  listServer.getSMTP(),
 405                                                  archive, &quot;webrev&quot;, Path.of(&quot;test&quot;),
 406                                                  URIBuilder.base(&quot;http://www.test.test/&quot;).build(),
 407                                                  Set.of(), Map.of());
 408 
 409             // Populate the projects repository
 410             var reviewFile = Path.of(&quot;reviewfile.txt&quot;);
 411             var localRepo = CheckableRepository.init(tempFolder.path(), author.getRepositoryType(), reviewFile);
 412             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
 413             localRepo.push(masterHash, author.getUrl(), &quot;master&quot;, true);
 414             localRepo.push(masterHash, archive.getUrl(), &quot;webrev&quot;, true);
 415 
 416             // Make a change with a corresponding PR
 417             var editHash = CheckableRepository.appendAndCommit(localRepo);
 418             localRepo.push(editHash, author.getUrl(), &quot;edit&quot;, true);
 419             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
 420             pr.setBody(&quot;This is now ready&quot;);
 421             TestBotRunner.runPeriodicItems(mlBot);
 422             listServer.processIncoming();
 423 
 424             // Make a file specific comment
 425             var reviewPr = reviewer.getPullRequest(pr.getId());
 426             var comment1 = reviewPr.addReviewComment(masterHash, editHash, reviewFile.toString(), 2, &quot;Review comment&quot;);
 427             pr.addReviewCommentReply(comment1, &quot;I agree&quot;);
 428             reviewPr.addReviewCommentReply(comment1, &quot;Great&quot;);
 429             TestBotRunner.runPeriodicItems(mlBot);
 430             listServer.processIncoming();
 431             listServer.processIncoming();
 432             listServer.processIncoming();
 433 
 434             // And a second one by ourselves
 435             var comment2 = pr.addReviewComment(masterHash, editHash, reviewFile.toString(), 2, &quot;Another review comment&quot;);
 436             reviewPr.addReviewCommentReply(comment2, &quot;Sounds good&quot;);
 437             pr.addReviewCommentReply(comment2, &quot;Thanks&quot;);
 438             TestBotRunner.runPeriodicItems(mlBot);
 439             listServer.processIncoming();
 440             listServer.processIncoming();
 441             listServer.processIncoming();
 442 
 443             // Sanity check the archive
 444             Repository.materialize(archiveFolder.path(), archive.getUrl(), &quot;master&quot;);
 445             assertEquals(6, archiveContainsCount(archiveFolder.path(), &quot;^On.*wrote:&quot;));
 446 
 447             // Check the mailing list
 448             var mailmanServer = MailingListServerFactory.createMailmanServer(listServer.getArchive(), listServer.getSMTP());
 449             var mailmanList = mailmanServer.getList(listAddress.address());
 450             var conversations = mailmanList.conversations(Duration.ofDays(1));
 451             assertEquals(1, conversations.size());
 452             var mail = conversations.get(0).first();
 453             assertEquals(&quot;RFR: This is a pull request&quot;, mail.subject());
 454             assertEquals(7, conversations.get(0).allMessages().size());
 455 
 456             // There should be two separate threads
 457             var thread1 = conversations.get(0).replies(mail).get(0);
 458             assertEquals(2, thread1.body().split(&quot;^On.*wrote:&quot;).length);
 459             assertEquals(2, thread1.body().split(&quot;&gt; This is now ready&quot;).length, thread1.body());
 460             assertEquals(&quot;Re: RFR: This is a pull request&quot;, thread1.subject());
 461             assertTrue(thread1.body().contains(&quot;Review comment\n\n&quot;), thread1.body());
 462             assertFalse(thread1.body().contains(&quot;Another review comment&quot;), thread1.body());
 463             var thread1reply1 = conversations.get(0).replies(thread1).get(0);
 464             assertTrue(thread1reply1.body().contains(&quot;I agree&quot;));
 465             var thread1reply2 = conversations.get(0).replies(thread1reply1).get(0);
 466             assertTrue(thread1reply2.body().contains(&quot;Great&quot;));
 467 
 468             var thread2 = conversations.get(0).replies(mail).get(1);
 469             assertEquals(2, thread2.body().split(&quot;^On.*wrote:&quot;).length);
 470             assertEquals(2, thread2.body().split(&quot;&gt; This is now ready&quot;).length, thread2.body());
 471             assertEquals(&quot;Re: RFR: This is a pull request&quot;, thread2.subject());
 472             assertFalse(thread2.body().contains(&quot;Review comment\n\n&quot;), thread2.body());
 473             assertTrue(thread2.body().contains(&quot;Another review comment&quot;), thread2.body());
 474             var thread2reply1 = conversations.get(0).replies(thread2).get(0);
 475             assertTrue(thread2reply1.body().contains(&quot;Sounds good&quot;));
 476             var thread2reply2 = conversations.get(0).replies(thread2reply1).get(0);
 477             assertTrue(thread2reply2.body().contains(&quot;Thanks&quot;));
 478         }
 479     }
 480 
 481     @Test
 482     void reviewContext(TestInfo testInfo) throws IOException {
 483         try (var credentials = new HostCredentials(testInfo);
 484              var tempFolder = new TemporaryDirectory();
 485              var archiveFolder = new TemporaryDirectory();
 486              var listServer = new TestMailmanServer()) {
 487             var author = credentials.getHostedRepository();
 488             var archive = credentials.getHostedRepository();
 489             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
 490             var censusBuilder = credentials.getCensusBuilder()
 491                                            .addAuthor(author.host().getCurrentUserDetails().id());
 492             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
 493             var mlBot = new MailingListBridgeBot(from, author, archive, censusBuilder.build(), &quot;master&quot;,
 494                                                  listAddress, Set.of(), Set.of(),
 495                                                  listServer.getArchive(),
 496                                                  listServer.getSMTP(),
 497                                                  archive, &quot;webrev&quot;, Path.of(&quot;test&quot;),
 498                                                  URIBuilder.base(&quot;http://www.test.test/&quot;).build(),
 499                                                  Set.of(), Map.of());
 500 
 501             // Populate the projects repository
 502             var reviewFile = Path.of(&quot;reviewfile.txt&quot;);
 503             var localRepo = CheckableRepository.init(tempFolder.path(), author.getRepositoryType(), reviewFile);
 504             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
 505             localRepo.push(masterHash, author.getUrl(), &quot;master&quot;, true);
 506             localRepo.push(masterHash, archive.getUrl(), &quot;webrev&quot;, true);
 507 
 508             // Make a change with a corresponding PR
 509             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;Line 1\nLine 2\nLine 3\nLine 4&quot;);
 510             localRepo.push(editHash, author.getUrl(), &quot;edit&quot;, true);
 511             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
 512             pr.setBody(&quot;This is now ready&quot;);
 513             TestBotRunner.runPeriodicItems(mlBot);
 514             listServer.processIncoming();
 515 
 516             // Make a file specific comment
 517             pr.addReviewComment(masterHash, editHash, reviewFile.toString(), 2, &quot;Review comment&quot;);
 518 
 519             TestBotRunner.runPeriodicItems(mlBot);
 520             listServer.processIncoming();
 521 
 522             // The archive should only contain context around line 2
 523             Repository.materialize(archiveFolder.path(), archive.getUrl(), &quot;master&quot;);
 524             assertTrue(archiveContains(archiveFolder.path(), &quot;^&gt; 2: Line 1$&quot;));
 525             assertTrue(archiveContains(archiveFolder.path(), &quot;^&gt; 3: Line 2$&quot;));
 526             assertFalse(archiveContains(archiveFolder.path(), &quot;^&gt; 4: Line 3$&quot;));
 527         }
 528     }
 529 
 530     @Test
 531     void multipleReviewContexts(TestInfo testInfo) throws IOException {
 532         try (var credentials = new HostCredentials(testInfo);
 533              var tempFolder = new TemporaryDirectory();
 534              var archiveFolder = new TemporaryDirectory();
 535              var listServer = new TestMailmanServer()) {
 536             var author = credentials.getHostedRepository();
 537             var archive = credentials.getHostedRepository();
 538             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
 539             var censusBuilder = credentials.getCensusBuilder()
 540                                            .addAuthor(author.host().getCurrentUserDetails().id());
 541             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
 542             var mlBot = new MailingListBridgeBot(from, author, archive, censusBuilder.build(), &quot;master&quot;,
 543                                                  listAddress, Set.of(), Set.of(),
 544                                                  listServer.getArchive(),
 545                                                  listServer.getSMTP(),
 546                                                  archive, &quot;webrev&quot;, Path.of(&quot;test&quot;),
 547                                                  URIBuilder.base(&quot;http://www.test.test/&quot;).build(),
 548                                                  Set.of(), Map.of());
 549 
 550             // Populate the projects repository
 551             var reviewFile = Path.of(&quot;reviewfile.txt&quot;);
 552             var localRepo = CheckableRepository.init(tempFolder.path(), author.getRepositoryType(), reviewFile);
 553             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
 554             localRepo.push(masterHash, author.getUrl(), &quot;master&quot;, true);
 555             localRepo.push(masterHash, archive.getUrl(), &quot;webrev&quot;, true);
 556             var initialHash = CheckableRepository.appendAndCommit(localRepo,
 557                                                                   &quot;Line 0.1\nLine 0.2\nLine 0.3\nLine 0.4\n&quot; +
 558                                                                           &quot;Line 1\nLine 2\nLine 3\nLine 4\n&quot; +
 559                                                                           &quot;Line 5\nLine 6\nLine 7\nLine 8\n&quot; +
 560                                                                           &quot;Line 8.1\nLine 8.2\nLine 8.3\nLine 8.4\n&quot; +
 561                                                                           &quot;Line 9\nLine 10\nLine 11\nLine 12\n&quot; +
 562                                                                           &quot;Line 13\nLine 14\nLine 15\nLine 16\n&quot;);
 563             localRepo.push(initialHash, author.getUrl(), &quot;master&quot;);
 564 
 565             // Make a change with a corresponding PR
 566             var current = Files.readString(localRepo.root().resolve(reviewFile), StandardCharsets.UTF_8);
 567             var updated = current.replaceAll(&quot;Line 2&quot;, &quot;Line 2 edit\nLine 2.5&quot;);
 568             updated = updated.replaceAll(&quot;Line 13&quot;, &quot;Line 12.5\nLine 13 edit&quot;);
 569             Files.writeString(localRepo.root().resolve(reviewFile), updated, StandardCharsets.UTF_8);
 570             var editHash = CheckableRepository.appendAndCommit(localRepo);
 571             localRepo.push(editHash, author.getUrl(), &quot;edit&quot;, true);
 572             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
 573             pr.setBody(&quot;This is now ready&quot;);
 574             TestBotRunner.runPeriodicItems(mlBot);
 575             listServer.processIncoming();
 576 
 577             // Make file specific comments
 578             pr.addReviewComment(masterHash, editHash, reviewFile.toString(), 7, &quot;Review comment&quot;);
 579             pr.addReviewComment(masterHash, editHash, reviewFile.toString(), 24, &quot;Another review comment&quot;);
 580 
 581             TestBotRunner.runPeriodicItems(mlBot);
 582             listServer.processIncoming();
 583 
 584             // The archive should only contain context around line 2 and 20
 585             Repository.materialize(archiveFolder.path(), archive.getUrl(), &quot;master&quot;);
 586             assertTrue(archiveContains(archiveFolder.path(), &quot;reviewfile.txt line 7&quot;));
 587             assertTrue(archiveContains(archiveFolder.path(), &quot;^&gt; 6: Line 1$&quot;));
 588             assertTrue(archiveContains(archiveFolder.path(), &quot;^&gt; 7: Line 2 edit$&quot;));
 589             assertFalse(archiveContains(archiveFolder.path(), &quot;Line 3&quot;));
 590 
 591             assertTrue(archiveContains(archiveFolder.path(), &quot;reviewfile.txt line 24&quot;));
 592             assertTrue(archiveContains(archiveFolder.path(), &quot;^&gt; 23: Line 12.5$&quot;));
 593             assertTrue(archiveContains(archiveFolder.path(), &quot;^&gt; 24: Line 13 edit$&quot;));
 594             assertFalse(archiveContains(archiveFolder.path(), &quot;^Line 15&quot;));
 595         }
 596     }
 597 
 598     @Test
 599     void filterComments(TestInfo testInfo) throws IOException {
 600         try (var credentials = new HostCredentials(testInfo);
 601              var tempFolder = new TemporaryDirectory();
 602              var archiveFolder = new TemporaryDirectory();
 603              var listServer = new TestMailmanServer()) {
 604             var author = credentials.getHostedRepository();
 605             var archive = credentials.getHostedRepository();
 606             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
 607             var censusBuilder = credentials.getCensusBuilder()
 608                                            .addAuthor(author.host().getCurrentUserDetails().id());
 609             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
 610             var mlBot = new MailingListBridgeBot(from, author, archive, censusBuilder.build(), &quot;master&quot;,
 611                                                  listAddress, Set.of(), Set.of(),
 612                                                  listServer.getArchive(), listServer.getSMTP(),
 613                                                  archive, &quot;webrev&quot;, Path.of(&quot;test&quot;),
 614                                                  URIBuilder.base(&quot;http://www.test.test/&quot;).build(),
 615                                                  Set.of(), Map.of());
 616 
 617             // Populate the projects repository
 618             var reviewFile = Path.of(&quot;reviewfile.txt&quot;);
 619             var localRepo = CheckableRepository.init(tempFolder.path(), author.getRepositoryType(), reviewFile);
 620             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
 621             localRepo.push(masterHash, author.getUrl(), &quot;master&quot;, true);
 622             localRepo.push(masterHash, archive.getUrl(), &quot;webrev&quot;, true);
 623 
 624             // Make a change with a corresponding PR
 625             var editHash = CheckableRepository.appendAndCommit(localRepo);
 626             localRepo.push(editHash, author.getUrl(), &quot;edit&quot;, true);
 627             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
 628             pr.setBody(&quot;This is now ready\n&lt;!-- this is a comment --&gt;\nAnd this is not\n&quot; +
 629                                &quot;&lt;!-- Anything below this marker will be hidden --&gt;\nStatus stuff&quot;);
 630 
 631             // Make a bunch of comments
 632             pr.addComment(&quot;Plain comment\n&lt;!-- this is a comment --&gt;&quot;);
 633             pr.addReviewComment(masterHash, editHash, reviewFile.toString(), 2, &quot;Review comment &lt;!-- this is a comment --&gt;\n&quot;);
 634             pr.addComment(&quot;/integrate stuff&quot;);
 635             TestBotRunner.runPeriodicItems(mlBot);
 636 
 637             // Run an archive pass
 638             TestBotRunner.runPeriodicItems(mlBot);
 639 
 640             // The archive should not contain the comment
 641             Repository.materialize(archiveFolder.path(), archive.getUrl(), &quot;master&quot;);
 642             assertTrue(archiveContains(archiveFolder.path(), &quot;This is now ready&quot;));
 643             assertFalse(archiveContains(archiveFolder.path(), &quot;this is a comment&quot;));
 644             assertFalse(archiveContains(archiveFolder.path(), &quot;Status stuff&quot;));
 645             assertTrue(archiveContains(archiveFolder.path(), &quot;And this is not&quot;));
 646             assertFalse(archiveContains(archiveFolder.path(), &quot;&lt;!--&quot;));
 647             assertFalse(archiveContains(archiveFolder.path(), &quot;--&gt;&quot;));
 648             assertTrue(archiveContains(archiveFolder.path(), &quot;Plain comment&quot;));
 649             assertTrue(archiveContains(archiveFolder.path(), &quot;Review comment&quot;));
 650             assertFalse(archiveContains(archiveFolder.path(), &quot;/integrate&quot;));
 651         }
 652     }
 653 
 654     @Test
 655     void incrementalChanges(TestInfo testInfo) throws IOException {
 656         try (var credentials = new HostCredentials(testInfo);
 657              var tempFolder = new TemporaryDirectory();
 658              var archiveFolder = new TemporaryDirectory();
 659              var listServer = new TestMailmanServer()) {
 660             var author = credentials.getHostedRepository();
 661             var archive = credentials.getHostedRepository();
<a name="1" id="anc1"></a><span class="line-added"> 662             var commenter = credentials.getHostedRepository();</span>
 663             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
 664             var censusBuilder = credentials.getCensusBuilder()
 665                                            .addAuthor(author.host().getCurrentUserDetails().id());
 666             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
 667             var mlBot = new MailingListBridgeBot(from, author, archive, censusBuilder.build(), &quot;master&quot;,
 668                                                  listAddress, Set.of(), Set.of(),
 669                                                  listServer.getArchive(), listServer.getSMTP(),
 670                                                  archive, &quot;webrev&quot;, Path.of(&quot;test&quot;),
 671                                                  URIBuilder.base(&quot;http://www.test.test/&quot;).build(),
 672                                                  Set.of(), Map.of());
 673 
 674             // Populate the projects repository
 675             var reviewFile = Path.of(&quot;reviewfile.txt&quot;);
 676             var localRepo = CheckableRepository.init(tempFolder.path(), author.getRepositoryType(), reviewFile);
 677             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
 678             localRepo.push(masterHash, author.getUrl(), &quot;master&quot;, true);
 679             localRepo.push(masterHash, archive.getUrl(), &quot;webrev&quot;, true);
 680 
 681             // Make a change with a corresponding PR
 682             var editHash = CheckableRepository.appendAndCommit(localRepo);
 683             localRepo.push(editHash, author.getUrl(), &quot;edit&quot;, true);
 684             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
 685             pr.setBody(&quot;This is now ready&quot;);
 686 
 687             // Run an archive pass
 688             TestBotRunner.runPeriodicItems(mlBot);
 689             listServer.processIncoming();
 690 
 691             var nextHash = CheckableRepository.appendAndCommit(localRepo, &quot;Yet one more line&quot;, &quot;Fixing&quot;);
 692             localRepo.push(nextHash, author.getUrl(), &quot;edit&quot;);
 693 
 694             // Make sure that the push registered
 695             var lastHeadHash = pr.getHeadHash();
 696             var refreshCount = 0;
 697             do {
 698                 pr = author.getPullRequest(pr.getId());
 699                 if (refreshCount++ &gt; 100) {
 700                     fail(&quot;The PR did not update after the new push&quot;);
 701                 }
 702             } while (pr.getHeadHash().equals(lastHeadHash));
 703 
 704             // Run another archive pass
 705             TestBotRunner.runPeriodicItems(mlBot);
 706             TestBotRunner.runPeriodicItems(mlBot);
 707             TestBotRunner.runPeriodicItems(mlBot);
 708             listServer.processIncoming();
 709 
 710             // The archive should reference the updated push
 711             Repository.materialize(archiveFolder.path(), archive.getUrl(), &quot;master&quot;);
 712             assertTrue(archiveContains(archiveFolder.path(), &quot;additional changes&quot;));
 713             assertTrue(archiveContains(archiveFolder.path(), &quot;full.*/&quot; + pr.getId() + &quot;/webrev.01&quot;));
 714             assertTrue(archiveContains(archiveFolder.path(), &quot;inc.*/&quot; + pr.getId() + &quot;/webrev.00-01&quot;));
 715             assertTrue(archiveContains(archiveFolder.path(), &quot;Updated full patch&quot;));
 716             assertTrue(archiveContains(archiveFolder.path(), &quot;Fetch&quot;));
 717             assertTrue(archiveContains(archiveFolder.path(), &quot;Fixing&quot;));
 718 
 719             // The webrev comment should be updated
 720             var comments = pr.getComments();
 721             var webrevComments = comments.stream()
 722                                          .filter(comment -&gt; comment.author().equals(author.host().getCurrentUserDetails()))
 723                                          .filter(comment -&gt; comment.body().contains(&quot;webrev&quot;))
 724                                          .filter(comment -&gt; comment.body().contains(nextHash.hex()))
 725                                          .filter(comment -&gt; comment.body().contains(editHash.hex()))
 726                                          .collect(Collectors.toList());
 727             assertEquals(1, webrevComments.size());
 728 
 729             // Check that sender address is set properly
 730             var mailmanServer = MailingListServerFactory.createMailmanServer(listServer.getArchive(), listServer.getSMTP());
 731             var mailmanList = mailmanServer.getList(listAddress.address());
 732             var conversations = mailmanList.conversations(Duration.ofDays(1));
 733             assertEquals(1, conversations.size());
 734             for (var newMail : conversations.get(0).allMessages()) {
 735                 assertEquals(from.address(), newMail.author().address());
 736                 assertEquals(from, newMail.sender());
 737             }
 738 
<a name="2" id="anc2"></a><span class="line-added"> 739             // Add a comment</span>
<span class="line-added"> 740             var commenterPr = commenter.getPullRequest(pr.getId());</span>
<span class="line-added"> 741             commenterPr.addReviewComment(masterHash, nextHash, reviewFile.toString(), 2, &quot;Review comment&quot;);</span>
<span class="line-added"> 742             TestBotRunner.runPeriodicItems(mlBot);</span>
<span class="line-added"> 743             listServer.processIncoming();</span>
<span class="line-added"> 744 </span>
 745             // Ensure that additional updates are only reported once
 746             for (int i = 0; i &lt; 3; ++i) {
 747                 var anotherHash = CheckableRepository.appendAndCommit(localRepo, &quot;Another line&quot;, &quot;Fixing&quot;);
 748                 localRepo.push(anotherHash, author.getUrl(), &quot;edit&quot;);
 749 
 750                 // Make sure that the push registered
 751                 lastHeadHash = pr.getHeadHash();
 752                 refreshCount = 0;
 753                 do {
 754                     pr = author.getPullRequest(pr.getId());
 755                     if (refreshCount++ &gt; 100) {
 756                         fail(&quot;The PR did not update after the new push&quot;);
 757                     }
 758                 } while (pr.getHeadHash().equals(lastHeadHash));
 759 
 760                 TestBotRunner.runPeriodicItems(mlBot);
 761                 TestBotRunner.runPeriodicItems(mlBot);
 762                 listServer.processIncoming();
 763             }
 764             var updatedConversations = mailmanList.conversations(Duration.ofDays(1));
 765             assertEquals(1, updatedConversations.size());
 766             var conversation = updatedConversations.get(0);
<a name="3" id="anc3"></a><span class="line-modified"> 767             assertEquals(6, conversation.allMessages().size());</span>
<span class="line-added"> 768             assertEquals(&quot;Re: 01: Fixing&quot;, conversation.allMessages().get(1).subject());</span>
<span class="line-added"> 769             assertEquals(&quot;Re: 01: Fixing&quot;, conversation.allMessages().get(2).subject());</span>
<span class="line-added"> 770             assertEquals(&quot;Re: 04: Fixing&quot;, conversation.allMessages().get(5).subject());</span>
 771         }
 772     }
 773 
 774     @Test
 775     void rebased(TestInfo testInfo) throws IOException {
 776         try (var credentials = new HostCredentials(testInfo);
 777              var tempFolder = new TemporaryDirectory();
 778              var archiveFolder = new TemporaryDirectory();
 779              var listServer = new TestMailmanServer()) {
 780             var author = credentials.getHostedRepository();
 781             var archive = credentials.getHostedRepository();
 782             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
 783             var censusBuilder = credentials.getCensusBuilder()
 784                                            .addAuthor(author.host().getCurrentUserDetails().id());
 785             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
 786             var mlBot = new MailingListBridgeBot(from, author, archive, censusBuilder.build(), &quot;master&quot;,
 787                                                  listAddress, Set.of(), Set.of(),
 788                                                  listServer.getArchive(), listServer.getSMTP(),
 789                                                  archive, &quot;webrev&quot;, Path.of(&quot;test&quot;),
 790                                                  URIBuilder.base(&quot;http://www.test.test/&quot;).build(),
 791                                                  Set.of(), Map.of());
 792 
 793             // Populate the projects repository
 794             var reviewFile = Path.of(&quot;reviewfile.txt&quot;);
 795             var localRepo = CheckableRepository.init(tempFolder.path().resolve(&quot;first&quot;), author.getRepositoryType(), reviewFile);
 796             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
 797             localRepo.push(masterHash, author.getUrl(), &quot;master&quot;, true);
 798             localRepo.push(masterHash, archive.getUrl(), &quot;webrev&quot;, true);
 799 
 800             // Make a change with a corresponding PR
 801             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;A line&quot;, &quot;Original msg&quot;);
 802             localRepo.push(editHash, author.getUrl(), &quot;edit&quot;, true);
 803             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
 804             pr.setBody(&quot;This is now ready&quot;);
 805 
 806             // Run an archive pass
 807             TestBotRunner.runPeriodicItems(mlBot);
 808             listServer.processIncoming();
 809 
 810             var newLocalRepo = Repository.materialize(tempFolder.path().resolve(&quot;second&quot;), author.getUrl(), &quot;master&quot;);
 811             var newEditHash = CheckableRepository.appendAndCommit(newLocalRepo, &quot;Another line&quot;, &quot;Replaced msg&quot;);
 812             newLocalRepo.push(newEditHash, author.getUrl(), &quot;edit&quot;, true);
 813 
 814             // Make sure that the push registered
 815             var lastHeadHash = pr.getHeadHash();
 816             var refreshCount = 0;
 817             do {
 818                 pr = author.getPullRequest(pr.getId());
 819                 if (refreshCount++ &gt; 100) {
 820                     fail(&quot;The PR did not update after the new push&quot;);
 821                 }
 822             } while (pr.getHeadHash().equals(lastHeadHash));
 823 
 824             // Run another archive pass
 825             TestBotRunner.runPeriodicItems(mlBot);
 826             listServer.processIncoming();
 827 
 828             // The archive should reference the rebased push
 829             Repository.materialize(archiveFolder.path(), archive.getUrl(), &quot;master&quot;);
 830             assertTrue(archiveContains(archiveFolder.path(), &quot;complete new set of changes&quot;));
 831             assertTrue(archiveContains(archiveFolder.path(), pr.getId() + &quot;/webrev.01&quot;));
 832             assertFalse(archiveContains(archiveFolder.path(), &quot;Incremental&quot;));
 833             assertTrue(archiveContains(archiveFolder.path(), &quot;Updated full patch&quot;));
 834             assertTrue(archiveContains(archiveFolder.path(), &quot;Fetch&quot;));
 835             assertTrue(archiveContains(archiveFolder.path(), &quot;Original msg&quot;));
 836             assertTrue(archiveContains(archiveFolder.path(), &quot;Replaced msg&quot;));
 837 
 838             // The webrev comment should be updated
 839             var comments = pr.getComments();
 840             var webrevComments = comments.stream()
 841                                          .filter(comment -&gt; comment.author().equals(author.host().getCurrentUserDetails()))
 842                                          .filter(comment -&gt; comment.body().contains(&quot;webrev&quot;))
 843                                          .filter(comment -&gt; comment.body().contains(newEditHash.hex()))
 844                                          .collect(Collectors.toList());
 845             assertEquals(1, webrevComments.size());
 846 
 847             // Check that sender address is set properly
 848             var mailmanServer = MailingListServerFactory.createMailmanServer(listServer.getArchive(), listServer.getSMTP());
 849             var mailmanList = mailmanServer.getList(listAddress.address());
 850             var conversations = mailmanList.conversations(Duration.ofDays(1));
 851             assertEquals(1, conversations.size());
 852             for (var newMail : conversations.get(0).allMessages()) {
 853                 assertEquals(from.address(), newMail.author().address());
 854                 assertEquals(from, newMail.sender());
 855             }
<a name="4" id="anc4"></a><span class="line-added"> 856             assertEquals(&quot;Re: 01: Replaced msg&quot;, conversations.get(0).allMessages().get(1).subject());</span>
 857         }
 858     }
 859 
 860     @Test
 861     void skipAddingExistingWebrev(TestInfo testInfo) throws IOException {
 862         try (var credentials = new HostCredentials(testInfo);
 863              var tempFolder = new TemporaryDirectory();
 864              var archiveFolder = new TemporaryDirectory();
 865              var webrevFolder = new TemporaryDirectory();
 866              var listServer = new TestMailmanServer()) {
 867             var author = credentials.getHostedRepository();
 868             var archive = credentials.getHostedRepository();
 869             var ignored = credentials.getHostedRepository();
 870             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
 871             var censusBuilder = credentials.getCensusBuilder()
 872                                            .addAuthor(author.host().getCurrentUserDetails().id());
 873             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
 874             var mlBot = new MailingListBridgeBot(from, author, archive, censusBuilder.build(), &quot;master&quot;,
 875                                                  listAddress,
 876                                                  Set.of(ignored.host().getCurrentUserDetails().userName()),
 877                                                  Set.of(),
 878                                                  listServer.getArchive(), listServer.getSMTP(),
 879                                                  archive, &quot;webrev&quot;, Path.of(&quot;test&quot;),
 880                                                  URIBuilder.base(&quot;http://www.test.test/&quot;).build(),
 881                                                  Set.of(), Map.of());
 882 
 883             // Populate the projects repository
 884             var localRepo = CheckableRepository.init(tempFolder.path(), author.getRepositoryType());
 885             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
 886             localRepo.push(masterHash, author.getUrl(), &quot;master&quot;, true);
 887             localRepo.push(masterHash, archive.getUrl(), &quot;webrev&quot;, true);
 888 
 889             // Make a change with a corresponding PR
 890             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;A simple change&quot;,
 891                                                                &quot;Change msg\n\nWith several lines&quot;);
 892             localRepo.push(editHash, author.getUrl(), &quot;edit&quot;, true);
 893             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
 894 
 895             // Flag it as ready for review
 896             pr.setBody(&quot;This should now be ready&quot;);
 897 
 898             // Run an archive pass
 899             TestBotRunner.runPeriodicItems(mlBot);
 900 
 901             // The archive should now contain an entry
 902             var archiveRepo = Repository.materialize(archiveFolder.path(), archive.getUrl(), &quot;master&quot;);
 903             assertTrue(archiveContains(archiveFolder.path(), editHash.abbreviate()));
 904 
 905             // And there should be a webrev comment
 906             var comments = pr.getComments();
 907             var webrevComments = comments.stream()
 908                                          .filter(comment -&gt; comment.author().equals(author.host().getCurrentUserDetails()))
 909                                          .filter(comment -&gt; comment.body().contains(&quot;webrev&quot;))
 910                                          .filter(comment -&gt; comment.body().contains(editHash.hex()))
 911                                          .collect(Collectors.toList());
 912             assertEquals(1, webrevComments.size());
 913             assertEquals(1, countSubstrings(webrevComments.get(0).body(), &quot;webrev.00&quot;));
 914 
 915             // Pretend the archive didn&#39;t work out
 916             archiveRepo.push(masterHash, archive.getUrl(), &quot;master&quot;, true);
 917 
 918             // Run another archive pass
 919             TestBotRunner.runPeriodicItems(mlBot);
 920 
 921             // The webrev comment should not contain duplicate entries
 922             comments = pr.getComments();
 923             webrevComments = comments.stream()
 924                                          .filter(comment -&gt; comment.author().equals(author.host().getCurrentUserDetails()))
 925                                          .filter(comment -&gt; comment.body().contains(&quot;webrev&quot;))
 926                                          .filter(comment -&gt; comment.body().contains(editHash.hex()))
 927                                          .collect(Collectors.toList());
 928             assertEquals(1, webrevComments.size());
 929             assertEquals(1, countSubstrings(webrevComments.get(0).body(), &quot;webrev.00&quot;));
 930         }
 931     }
 932 
 933     @Test
 934     void notifyReviewVerdicts(TestInfo testInfo) throws IOException {
 935         try (var credentials = new HostCredentials(testInfo);
 936              var tempFolder = new TemporaryDirectory();
 937              var archiveFolder = new TemporaryDirectory();
 938              var listServer = new TestMailmanServer()) {
 939             var author = credentials.getHostedRepository();
 940             var archive = credentials.getHostedRepository();
 941             var reviewer = credentials.getHostedRepository();
 942             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
 943             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
 944             var censusBuilder = credentials.getCensusBuilder()
 945                                            .addReviewer(reviewer.host().getCurrentUserDetails().id())
 946                                            .addAuthor(author.host().getCurrentUserDetails().id());
 947             var mlBot = new MailingListBridgeBot(from, author, archive, censusBuilder.build(), &quot;master&quot;,
 948                                                  listAddress, Set.of(), Set.of(),
 949                                                  listServer.getArchive(), listServer.getSMTP(),
 950                                                  archive, &quot;webrev&quot;, Path.of(&quot;test&quot;),
 951                                                  URIBuilder.base(&quot;http://www.test.test/&quot;).build(),
 952                                                  Set.of(), Map.of());
 953 
 954             // Populate the projects repository
 955             var reviewFile = Path.of(&quot;reviewfile.txt&quot;);
 956             var localRepo = CheckableRepository.init(tempFolder.path(), author.getRepositoryType(), reviewFile);
 957             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
 958             localRepo.push(masterHash, author.getUrl(), &quot;master&quot;, true);
 959             localRepo.push(masterHash, archive.getUrl(), &quot;webrev&quot;, true);
 960 
 961             // Make a change with a corresponding PR
 962             var editHash = CheckableRepository.appendAndCommit(localRepo);
 963             localRepo.push(editHash, author.getUrl(), &quot;edit&quot;, true);
 964             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
 965             pr.setBody(&quot;This is now ready&quot;);
 966 
 967             // Run an archive pass
 968             TestBotRunner.runPeriodicItems(mlBot);
 969 
 970             // First unapprove it
 971             var reviewedPr = reviewer.getPullRequest(pr.getId());
 972             reviewedPr.addReview(Review.Verdict.DISAPPROVED, &quot;Reason 1&quot;);
 973             TestBotRunner.runPeriodicItems(mlBot);
 974             TestBotRunner.runPeriodicItems(mlBot);
 975             TestBotRunner.runPeriodicItems(mlBot);
 976 
 977             // The archive should contain a note
 978             Repository.materialize(archiveFolder.path(), archive.getUrl(), &quot;master&quot;);
 979             assertEquals(1, archiveContainsCount(archiveFolder.path(), &quot;Review status set to Disapproved&quot;));
 980             assertEquals(1, archiveContainsCount(archiveFolder.path(), &quot; by integrationreviewer1&quot;));
 981             if (author.host().supportsReviewBody()) {
 982                 assertEquals(1, archiveContainsCount(archiveFolder.path(), &quot;Reason 1&quot;));
 983             }
 984 
 985             // Then approve it
 986             reviewedPr.addReview(Review.Verdict.APPROVED, &quot;Reason 2&quot;);
 987             TestBotRunner.runPeriodicItems(mlBot);
 988             TestBotRunner.runPeriodicItems(mlBot);
 989             TestBotRunner.runPeriodicItems(mlBot);
 990 
 991             // The archive should contain another note
 992             Repository.materialize(archiveFolder.path(), archive.getUrl(), &quot;master&quot;);
 993             assertEquals(1, archiveContainsCount(archiveFolder.path(), &quot;Review status set to Approved&quot;));
 994             if (author.host().supportsReviewBody()) {
 995                 assertEquals(1, archiveContainsCount(archiveFolder.path(), &quot;Reason 2&quot;));
 996             }
 997             assertEquals(1, archiveContainsCount(archiveFolder.path(), &quot;This PR has been marked as Reviewed by integrationreviewer1.&quot;));
 998 
 999             // Yet another change
1000             reviewedPr.addReview(Review.Verdict.DISAPPROVED, &quot;Reason 3&quot;);
1001             TestBotRunner.runPeriodicItems(mlBot);
1002             TestBotRunner.runPeriodicItems(mlBot);
1003             TestBotRunner.runPeriodicItems(mlBot);
1004 
1005             // The archive should contain another note
1006             Repository.materialize(archiveFolder.path(), archive.getUrl(), &quot;master&quot;);
1007             assertEquals(2, archiveContainsCount(archiveFolder.path(), &quot;Review status set to Disapproved&quot;));
1008             if (author.host().supportsReviewBody()) {
1009                 assertEquals(1, archiveContainsCount(archiveFolder.path(), &quot;Reason 3&quot;));
1010             }
1011         }
1012     }
1013 
1014     @Test
1015     void ignoreComments(TestInfo testInfo) throws IOException {
1016         try (var credentials = new HostCredentials(testInfo);
1017              var tempFolder = new TemporaryDirectory();
1018              var archiveFolder = new TemporaryDirectory();
1019              var listServer = new TestMailmanServer()) {
1020             var author = credentials.getHostedRepository();
1021             var ignored = credentials.getHostedRepository();
1022             var archive = credentials.getHostedRepository();
1023             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
1024             var censusBuilder = credentials.getCensusBuilder()
1025                                            .addAuthor(author.host().getCurrentUserDetails().id());
1026             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
1027             var mlBot = new MailingListBridgeBot(from, author, archive, censusBuilder.build(), &quot;master&quot;,
1028                                                  listAddress,
1029                                                  Set.of(ignored.host().getCurrentUserDetails().userName()),
1030                                                  Set.of(Pattern.compile(&quot;ignore this comment&quot;, Pattern.MULTILINE | Pattern.DOTALL)),
1031                                                  listServer.getArchive(), listServer.getSMTP(),
1032                                                  archive, &quot;webrev&quot;, Path.of(&quot;test&quot;),
1033                                                  URIBuilder.base(&quot;http://www.test.test/&quot;).build(),
1034                                                  Set.of(), Map.of());
1035 
1036             // Populate the projects repository
1037             var reviewFile = Path.of(&quot;reviewfile.txt&quot;);
1038             var localRepo = CheckableRepository.init(tempFolder.path(), author.getRepositoryType(), reviewFile);
1039             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
1040             localRepo.push(masterHash, author.getUrl(), &quot;master&quot;, true);
1041             localRepo.push(masterHash, archive.getUrl(), &quot;webrev&quot;, true);
1042 
1043             // Make a change with a corresponding PR
1044             var editHash = CheckableRepository.appendAndCommit(localRepo);
1045             localRepo.push(editHash, author.getUrl(), &quot;edit&quot;, true);
1046             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
1047             pr.setBody(&quot;This is now ready&quot;);
1048 
1049             // Make a bunch of comments
1050             pr.addComment(&quot;Plain comment&quot;);
1051             pr.addComment(&quot;ignore this comment&quot;);
1052             pr.addComment(&quot;I think it is time to\nignore this comment!&quot;);
1053             pr.addReviewComment(masterHash, editHash, reviewFile.toString(), 2, &quot;Review ignore this comment&quot;);
1054 
1055             var ignoredPR = ignored.getPullRequest(pr.getId());
1056             ignoredPR.addComment(&quot;Don&#39;t mind me&quot;);
1057 
1058             TestBotRunner.runPeriodicItems(mlBot);
1059             TestBotRunner.runPeriodicItems(mlBot);
1060 
1061             // The archive should not contain the ignored comments
1062             Repository.materialize(archiveFolder.path(), archive.getUrl(), &quot;master&quot;);
1063             assertTrue(archiveContains(archiveFolder.path(), &quot;This is now ready&quot;));
1064             assertFalse(archiveContains(archiveFolder.path(), &quot;ignore this comment&quot;));
1065             assertFalse(archiveContains(archiveFolder.path(), &quot;it is time to&quot;));
1066             assertFalse(archiveContains(archiveFolder.path(), &quot;Don&#39;t mind me&quot;));
1067             assertFalse(archiveContains(archiveFolder.path(), &quot;Review ignore&quot;));
1068         }
1069     }
1070 }
<a name="5" id="anc5"></a><b style="font-size: large; color: red">--- EOF ---</b>
















































































</pre>
<input id="eof" value="5" type="hidden" />
</body>
</html>