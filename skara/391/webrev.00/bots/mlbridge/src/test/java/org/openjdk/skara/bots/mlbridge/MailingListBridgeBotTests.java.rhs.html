<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Frames bots/mlbridge/src/test/java/org/openjdk/skara/bots/mlbridge/MailingListBridgeBotTests.java</title>
    <link rel="stylesheet" href="../../../../../../../../../../style.css" />
    <script type="text/javascript" src="../../../../../../../../../../navigation.js"></script>
  </head>
<body onkeypress="keypress(event);">
<a name="0"></a>
<hr />
<pre>   1 /*
   2  * Copyright (c) 2019, Oracle and/or its affiliates. All rights reserved.
   3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   4  *
   5  * This code is free software; you can redistribute it and/or modify it
   6  * under the terms of the GNU General Public License version 2 only, as
   7  * published by the Free Software Foundation.
   8  *
   9  * This code is distributed in the hope that it will be useful, but WITHOUT
  10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
  11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
  12  * version 2 for more details (a copy is included in the LICENSE file that
  13  * accompanied this code).
  14  *
  15  * You should have received a copy of the GNU General Public License version
  16  * 2 along with this work; if not, write to the Free Software Foundation,
  17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
  18  *
  19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
  20  * or visit www.oracle.com if you need additional information or have any
  21  * questions.
  22  */
  23 package org.openjdk.skara.bots.mlbridge;
  24 
  25 import org.openjdk.skara.email.EmailAddress;
  26 import org.openjdk.skara.forge.*;
  27 import org.openjdk.skara.network.URIBuilder;
  28 import org.openjdk.skara.mailinglist.MailingListServerFactory;
  29 import org.openjdk.skara.test.*;
  30 import org.openjdk.skara.vcs.Repository;
  31 
  32 import org.junit.jupiter.api.*;
  33 
  34 import java.io.IOException;
  35 import java.nio.charset.StandardCharsets;
  36 import java.nio.file.*;
  37 import java.time.Duration;
  38 import java.util.*;
  39 import java.util.regex.Pattern;
  40 import java.util.stream.Collectors;
  41 
  42 import static org.junit.jupiter.api.Assertions.*;
  43 
  44 class MailingListBridgeBotTests {
  45     private Optional&lt;String&gt; archiveContents(Path archive) {
  46         try {
  47             var mbox = Files.find(archive, 50, (path, attrs) -&gt; path.toString().endsWith(&quot;.mbox&quot;)).findAny();
  48             if (mbox.isEmpty()) {
  49                 return Optional.empty();
  50             }
  51             return Optional.of(Files.readString(mbox.get(), StandardCharsets.UTF_8));
  52         } catch (IOException e) {
  53             return Optional.empty();
  54         }
  55 
  56     }
  57 
  58     private boolean archiveContains(Path archive, String text) {
  59         return archiveContainsCount(archive, text) &gt; 0;
  60     }
  61 
  62     private int archiveContainsCount(Path archive, String text) {
  63         var lines = archiveContents(archive);
  64         if (lines.isEmpty()) {
  65             return 0;
  66         }
  67         var pattern = Pattern.compile(text);
  68         int count = 0;
  69         for (var line : lines.get().split(&quot;\\R&quot;)) {
  70             var matcher = pattern.matcher(line);
  71             if (matcher.find()) {
  72                 count++;
  73             }
  74         }
  75         return count;
  76     }
  77 
  78     private boolean webrevContains(Path webrev, String text) {
  79         try {
  80             var index = Files.find(webrev, 5, (path, attrs) -&gt; path.toString().endsWith(&quot;index.html&quot;)).findAny();
  81             if (index.isEmpty()) {
  82                 return false;
  83             }
  84             var lines = Files.readString(index.get(), StandardCharsets.UTF_8);
  85             return lines.contains(text);
  86         } catch (IOException e) {
  87             return false;
  88         }
  89     }
  90 
  91     private long countSubstrings(String string, String substring) {
  92         return Pattern.compile(substring).matcher(string).results().count();
  93     }
  94 
  95     private String noreplyAddress(HostedRepository repository) {
  96         return &quot;test+&quot; + repository.forge().currentUser().id() + &quot;+&quot; +
  97                 repository.forge().currentUser().userName() +
  98                 &quot;@openjdk.java.net&quot;;
  99     }
 100 
 101     @Test
 102     void simpleArchive(TestInfo testInfo) throws IOException {
 103         try (var credentials = new HostCredentials(testInfo);
 104              var tempFolder = new TemporaryDirectory();
 105              var archiveFolder = new TemporaryDirectory();
 106              var webrevFolder = new TemporaryDirectory();
 107              var listServer = new TestMailmanServer();
 108              var webrevServer = new TestWebrevServer()) {
 109             var author = credentials.getHostedRepository();
 110             var archive = credentials.getHostedRepository();
 111             var ignored = credentials.getHostedRepository();
 112             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
 113             var censusBuilder = credentials.getCensusBuilder()
 114                                            .addAuthor(author.forge().currentUser().id());
 115             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
 116             var mlBot = MailingListBridgeBot.newBuilder()
 117                                             .from(from)
 118                                             .repo(author)
 119                                             .archive(archive)
 120                                             .censusRepo(censusBuilder.build())
 121                                             .list(listAddress)
 122                                             .ignoredUsers(Set.of(ignored.forge().currentUser().userName()))
 123                                             .ignoredComments(Set.of())
 124                                             .listArchive(listServer.getArchive())
 125                                             .smtpServer(listServer.getSMTP())
 126                                             .webrevStorageRepository(archive)
 127                                             .webrevStorageRef(&quot;webrev&quot;)
 128                                             .webrevStorageBase(Path.of(&quot;test&quot;))
 129                                             .webrevStorageBaseUri(webrevServer.uri())
 130                                             .readyLabels(Set.of(&quot;rfr&quot;))
 131                                             .readyComments(Map.of(ignored.forge().currentUser().userName(), Pattern.compile(&quot;ready&quot;)))
 132                                             .issueTracker(URIBuilder.base(&quot;http://issues.test/browse/&quot;).build())
 133                                             .headers(Map.of(&quot;Extra1&quot;, &quot;val1&quot;, &quot;Extra2&quot;, &quot;val2&quot;))
 134                                             .sendInterval(Duration.ZERO)
 135                                             .build();
 136 
 137             // Populate the projects repository
 138             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType());
 139             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
 140             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
 141             localRepo.push(masterHash, archive.url(), &quot;webrev&quot;, true);
 142 
 143             // Make a change with a corresponding PR
 144             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;A simple change&quot;,
 145                                                                &quot;Change msg\n\nWith several lines&quot;);
 146             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
 147             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;1234: This is a pull request&quot;);
 148             pr.setBody(&quot;This should not be ready&quot;);
 149 
 150             // Run an archive pass
 151             TestBotRunner.runPeriodicItems(mlBot);
 152 
 153             // A PR that isn&#39;t ready for review should not be archived
 154             Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);
 155             assertFalse(archiveContains(archiveFolder.path(), &quot;This is a pull request&quot;));
 156 
 157             // Flag it as ready for review
 158             pr.setBody(&quot;This should now be ready&quot;);
 159             pr.addLabel(&quot;rfr&quot;);
 160 
 161             // Run another archive pass
 162             TestBotRunner.runPeriodicItems(mlBot);
 163 
 164             // But it should still not be archived
 165             Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);
 166             assertFalse(archiveContains(archiveFolder.path(), &quot;This is a pull request&quot;));
 167 
 168             // Now post a general comment - not a ready marker
 169             var ignoredPr = ignored.pullRequest(pr.id());
 170             ignoredPr.addComment(&quot;hello there&quot;);
 171 
 172             // Run another archive pass
 173             TestBotRunner.runPeriodicItems(mlBot);
 174 
 175             // It should still not be archived
 176             Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);
 177             assertFalse(archiveContains(archiveFolder.path(), &quot;This is a pull request&quot;));
 178 
 179             // Now post a ready comment
 180             ignoredPr.addComment(&quot;ready&quot;);
 181 
 182             // Run another archive pass
 183             TestBotRunner.runPeriodicItems(mlBot);
 184 
 185             // The archive should now contain an entry
 186             Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);
 187             assertTrue(archiveContains(archiveFolder.path(), &quot;This is a pull request&quot;));
 188             assertTrue(archiveContains(archiveFolder.path(), &quot;This should now be ready&quot;));
 189             assertTrue(archiveContains(archiveFolder.path(), &quot;Patch:&quot;));
 190             assertTrue(archiveContains(archiveFolder.path(), &quot;Changes:&quot;));
 191             assertTrue(archiveContains(archiveFolder.path(), &quot;Webrev:&quot;));
 192             assertTrue(archiveContains(archiveFolder.path(), webrevServer.uri().toString()));
 193             assertTrue(archiveContains(archiveFolder.path(), &quot;webrev.00&quot;));
 194             assertTrue(archiveContains(archiveFolder.path(), &quot;Issue:&quot;));
 195             assertTrue(archiveContains(archiveFolder.path(), &quot;http://issues.test/browse/TSTPRJ-1234&quot;));
 196             assertTrue(archiveContains(archiveFolder.path(), &quot;Fetch:&quot;));
 197             assertTrue(archiveContains(archiveFolder.path(), &quot;^ - &quot; + editHash.abbreviate() + &quot;: Change msg&quot;));
 198             assertFalse(archiveContains(archiveFolder.path(), &quot;With several lines&quot;));
 199 
 200             // The mailing list as well
 201             listServer.processIncoming();
 202             var mailmanServer = MailingListServerFactory.createMailmanServer(listServer.getArchive(), listServer.getSMTP(), Duration.ZERO);
 203             var mailmanList = mailmanServer.getList(listAddress.address());
 204             var conversations = mailmanList.conversations(Duration.ofDays(1));
 205             assertEquals(1, conversations.size());
 206             var mail = conversations.get(0).first();
 207             assertEquals(&quot;RFR: 1234: This is a pull request&quot;, mail.subject());
 208             assertEquals(pr.author().fullName(), mail.author().fullName().orElseThrow());
 209             assertEquals(noreplyAddress(archive), mail.author().address());
 210             assertEquals(listAddress, mail.sender());
 211             assertEquals(&quot;val1&quot;, mail.headerValue(&quot;Extra1&quot;));
 212             assertEquals(&quot;val2&quot;, mail.headerValue(&quot;Extra2&quot;));
 213 
 214             // And there should be a webrev
 215             Repository.materialize(webrevFolder.path(), archive.url(), &quot;webrev&quot;);
 216             assertTrue(webrevContains(webrevFolder.path(), &quot;1 lines changed&quot;));
 217             var comments = pr.comments();
 218             var webrevComments = comments.stream()
 219                                          .filter(comment -&gt; comment.author().equals(author.forge().currentUser()))
 220                                          .filter(comment -&gt; comment.body().contains(&quot;webrev&quot;))
 221                                          .filter(comment -&gt; comment.body().contains(editHash.hex()))
 222                                          .collect(Collectors.toList());
 223             assertEquals(1, webrevComments.size());
 224 
 225             // Add a comment
 226             pr.addComment(&quot;This is a comment :smile:&quot;);
 227 
 228             // Add a comment from an ignored user as well
 229             ignoredPr.addComment(&quot;Don&#39;t mind me&quot;);
 230 
 231             // Run another archive pass
 232             TestBotRunner.runPeriodicItems(mlBot);
 233 
 234             // The archive should now contain the comment, but not the ignored one
 235             Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);
 236             assertTrue(archiveContains(archiveFolder.path(), &quot;This is a comment&quot;));
 237             assertTrue(archiveContains(archiveFolder.path(), &quot;&gt; This should now be ready&quot;));
 238             assertFalse(archiveContains(archiveFolder.path(), &quot;Don&#39;t mind me&quot;));
 239 
 240             listServer.processIncoming();
 241             conversations = mailmanList.conversations(Duration.ofDays(1));
 242             assertEquals(1, conversations.size());
 243             assertEquals(2, conversations.get(0).allMessages().size());
 244 
 245             // Remove the rfr flag and post another comment
 246             pr.addLabel(&quot;rfr&quot;);
 247             pr.addComment(&quot;This is another comment&quot;);
 248 
 249             // Run another archive pass
 250             TestBotRunner.runPeriodicItems(mlBot);
 251 
 252             // The archive should contain the additional comment
 253             Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);
 254             assertTrue(archiveContains(archiveFolder.path(), &quot;This is another comment&quot;));
 255             assertTrue(archiveContains(archiveFolder.path(), &quot;&gt;&gt; This should now be ready&quot;));
 256 
 257             listServer.processIncoming();
 258             conversations = mailmanList.conversations(Duration.ofDays(1));
 259             assertEquals(1, conversations.size());
 260             assertEquals(3, conversations.get(0).allMessages().size());
 261             for (var newMail : conversations.get(0).allMessages()) {
 262                 assertEquals(noreplyAddress(archive), newMail.author().address());
 263                 assertEquals(listAddress, newMail.sender());
 264             }
 265             assertTrue(conversations.get(0).allMessages().get(2).body().contains(&quot;This is a comment ðŸ˜„&quot;));
 266         }
 267     }
 268 
 269     @Test
 270     void reviewComment(TestInfo testInfo) throws IOException {
 271         try (var credentials = new HostCredentials(testInfo);
 272              var tempFolder = new TemporaryDirectory();
 273              var archiveFolder = new TemporaryDirectory();
 274              var listServer = new TestMailmanServer();
 275              var webrevServer = new TestWebrevServer()) {
 276             var author = credentials.getHostedRepository();
 277             var archive = credentials.getHostedRepository();
 278             var ignored = credentials.getHostedRepository();
 279             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
 280             var censusBuilder = credentials.getCensusBuilder()
 281                                            .addAuthor(author.forge().currentUser().id());
 282             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
 283             var mlBot = MailingListBridgeBot.newBuilder()
 284                                             .from(from)
 285                                             .repo(author)
 286                                             .archive(archive)
 287                                             .censusRepo(censusBuilder.build())
 288                                             .list(listAddress)
 289                                             .ignoredUsers(Set.of(ignored.forge().currentUser().userName()))
 290                                             .listArchive(listServer.getArchive())
 291                                             .smtpServer(listServer.getSMTP())
 292                                             .webrevStorageRepository(archive)
 293                                             .webrevStorageRef(&quot;webrev&quot;)
 294                                             .webrevStorageBase(Path.of(&quot;test&quot;))
 295                                             .webrevStorageBaseUri(webrevServer.uri())
 296                                             .issueTracker(URIBuilder.base(&quot;http://issues.test/browse/&quot;).build())
 297                                             .build();
 298 
 299             // Populate the projects repository
 300             var reviewFile = Path.of(&quot;reviewfile.txt&quot;);
 301             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType(), reviewFile);
 302             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
 303             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
 304             localRepo.push(masterHash, archive.url(), &quot;webrev&quot;, true);
 305 
 306             // Make a change with a corresponding PR
 307             var editHash = CheckableRepository.appendAndCommit(localRepo);
 308             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
 309             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
 310             pr.setBody(&quot;This is now ready&quot;);
 311             TestBotRunner.runPeriodicItems(mlBot);
 312             listServer.processIncoming();
 313 
 314             // And make a file specific comment
 315             var currentMaster = localRepo.resolve(&quot;master&quot;).orElseThrow();
 316             var comment = pr.addReviewComment(masterHash, editHash, reviewFile.toString(), 2, &quot;Review comment&quot;);
 317 
 318             // Add one from an ignored user as well
 319             var ignoredPr = ignored.pullRequest(pr.id());
 320             ignoredPr.addReviewComment(masterHash, editHash, reviewFile.toString(), 2, &quot;Don&#39;t mind me&quot;);
 321 
 322             // Process comments
 323             TestBotRunner.runPeriodicItems(mlBot);
 324             listServer.processIncoming();
 325 
 326             // The archive should now contain an entry
 327             Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);
 328             assertTrue(archiveContains(archiveFolder.path(), &quot;This is a pull request&quot;));
 329             assertTrue(archiveContains(archiveFolder.path(), &quot;This is now ready&quot;));
 330             assertTrue(archiveContains(archiveFolder.path(), &quot;Review comment&quot;));
 331             assertTrue(archiveContains(archiveFolder.path(), &quot;&gt; This is now ready&quot;));
 332             assertTrue(archiveContains(archiveFolder.path(), reviewFile.toString()));
 333             assertFalse(archiveContains(archiveFolder.path(), &quot;Don&#39;t mind me&quot;));
 334 
 335             // The mailing list as well
 336             var mailmanServer = MailingListServerFactory.createMailmanServer(listServer.getArchive(), listServer.getSMTP(), Duration.ZERO);
 337             var mailmanList = mailmanServer.getList(listAddress.address());
 338             var conversations = mailmanList.conversations(Duration.ofDays(1));
 339             assertEquals(1, conversations.size());
 340             var mail = conversations.get(0).first();
 341             assertEquals(&quot;RFR: This is a pull request&quot;, mail.subject());
 342 
 343             // Comment on the comment
 344             pr.addReviewCommentReply(comment, &quot;This is a review reply&quot;);
 345             TestBotRunner.runPeriodicItems(mlBot);
 346             listServer.processIncoming();
 347 
 348             // The archive should contain the additional comment (but no quoted footers)
 349             Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);
 350             assertTrue(archiveContains(archiveFolder.path(), &quot;This is a review reply&quot;));
 351             assertTrue(archiveContains(archiveFolder.path(), &quot;&gt;&gt; This is now ready&quot;));
 352             assertFalse(archiveContains(archiveFolder.path(), &quot;^&gt; PR:&quot;));
 353 
 354             // As well as the mailing list
 355             conversations = mailmanList.conversations(Duration.ofDays(1));
 356             assertEquals(1, conversations.size());
 357             assertEquals(3, conversations.get(0).allMessages().size());
 358             for (var newMail : conversations.get(0).allMessages()) {
 359                 assertEquals(noreplyAddress(archive), newMail.author().address());
 360                 assertEquals(listAddress, newMail.sender());
 361             }
 362         }
 363     }
 364 
 365     @Test
 366     void combineComments(TestInfo testInfo) throws IOException {
 367         try (var credentials = new HostCredentials(testInfo);
 368              var tempFolder = new TemporaryDirectory();
 369              var archiveFolder = new TemporaryDirectory();
 370              var listServer = new TestMailmanServer();
 371              var webrevServer = new TestWebrevServer()) {
 372             var author = credentials.getHostedRepository();
 373             var archive = credentials.getHostedRepository();
 374             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
 375             var censusBuilder = credentials.getCensusBuilder()
 376                                            .addAuthor(author.forge().currentUser().id());
 377             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
 378             var mlBot = MailingListBridgeBot.newBuilder()
 379                                             .from(from)
 380                                             .repo(author)
 381                                             .archive(archive)
 382                                             .censusRepo(censusBuilder.build())
 383                                             .list(listAddress)
 384                                             .listArchive(listServer.getArchive())
 385                                             .smtpServer(listServer.getSMTP())
 386                                             .webrevStorageRepository(archive)
 387                                             .webrevStorageRef(&quot;webrev&quot;)
 388                                             .webrevStorageBase(Path.of(&quot;test&quot;))
 389                                             .webrevStorageBaseUri(webrevServer.uri())
 390                                             .issueTracker(URIBuilder.base(&quot;http://issues.test/browse/&quot;).build())
 391                                             .build();
 392 
 393             // Populate the projects repository
 394             var reviewFile = Path.of(&quot;reviewfile.txt&quot;);
 395             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType(), reviewFile);
 396             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
 397             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
 398             localRepo.push(masterHash, archive.url(), &quot;webrev&quot;, true);
 399 
 400             // Make a change with a corresponding PR
 401             var editHash = CheckableRepository.appendAndCommit(localRepo);
 402             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
 403             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
 404             pr.setBody(&quot;This is now ready&quot;);
 405             pr.addComment(&quot;Avoid combining&quot;);
 406 
 407             TestBotRunner.runPeriodicItems(mlBot);
 408             listServer.processIncoming();
 409             listServer.processIncoming();
 410 
 411             // Make several file specific comments
 412             var first = pr.addReviewComment(masterHash, editHash, reviewFile.toString(), 2, &quot;Review comment&quot;);
 413             pr.addReviewComment(masterHash, editHash, reviewFile.toString(), 2, &quot;Another review comment&quot;);
 414             pr.addReviewComment(masterHash, editHash, reviewFile.toString(), 2, &quot;Further review comment&quot;);
 415             pr.addReviewComment(masterHash, editHash, reviewFile.toString(), 2, &quot;Final review comment&quot;);
 416             TestBotRunner.runPeriodicItems(mlBot);
 417             listServer.processIncoming();
 418 
 419             // The archive should contain a combined entry
 420             Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);
 421             assertEquals(2, archiveContainsCount(archiveFolder.path(), &quot;^On.*wrote:&quot;));
 422 
 423             // As well as the mailing list
 424             var mailmanServer = MailingListServerFactory.createMailmanServer(listServer.getArchive(), listServer.getSMTP(), Duration.ZERO);
 425             var mailmanList = mailmanServer.getList(listAddress.address());
 426             var conversations = mailmanList.conversations(Duration.ofDays(1));
 427             assertEquals(1, conversations.size());
 428             var mail = conversations.get(0).first();
 429             assertEquals(&quot;RFR: This is a pull request&quot;, mail.subject());
 430             assertEquals(3, conversations.get(0).allMessages().size());
 431 
 432             var commentReply = conversations.get(0).replies(mail).get(0);
 433             assertEquals(2, commentReply.body().split(&quot;^On.*wrote:&quot;).length);
 434             assertTrue(commentReply.body().contains(&quot;Avoid combining\n\n&quot;), commentReply.body());
 435 
 436             var reviewReply = conversations.get(0).replies(mail).get(1);
 437             assertEquals(2, reviewReply.body().split(&quot;^On.*wrote:&quot;).length);
 438             assertEquals(2, reviewReply.body().split(&quot;&gt; This is now ready&quot;).length, reviewReply.body());
<a name="1" id="anc1"></a><span class="line-modified"> 439             assertEquals(&quot;RFR: This is a pull request&quot;, reviewReply.subject());</span>
 440             assertTrue(reviewReply.body().contains(&quot;Review comment\n\n&quot;), reviewReply.body());
 441             assertTrue(reviewReply.body().contains(&quot;Another review comment&quot;), reviewReply.body());
 442 
 443             // Now reply to the first (collapsed) comment
 444             pr.addReviewCommentReply(first, &quot;I agree&quot;);
 445             TestBotRunner.runPeriodicItems(mlBot);
 446             listServer.processIncoming();
 447 
 448             // The archive should contain a new entry
 449             Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);
 450             assertEquals(3, archiveContainsCount(archiveFolder.path(), &quot;^On.*wrote:&quot;));
 451 
 452             // The combined review comments should only appear unquoted once
 453             assertEquals(1, archiveContainsCount(archiveFolder.path(), &quot;^Another review comment&quot;));
 454         }
 455     }
 456 
 457     @Test
 458     void commentThreading(TestInfo testInfo) throws IOException {
 459         try (var credentials = new HostCredentials(testInfo);
 460              var tempFolder = new TemporaryDirectory();
 461              var archiveFolder = new TemporaryDirectory();
 462              var listServer = new TestMailmanServer();
 463              var webrevServer = new TestWebrevServer()) {
 464             var author = credentials.getHostedRepository();
 465             var reviewer = credentials.getHostedRepository();
 466             var archive = credentials.getHostedRepository();
 467             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
 468             var censusBuilder = credentials.getCensusBuilder()
 469                                            .addReviewer(reviewer.forge().currentUser().id())
 470                                            .addAuthor(author.forge().currentUser().id());
 471             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
 472             var mlBot = MailingListBridgeBot.newBuilder()
 473                                             .from(from)
 474                                             .repo(author)
 475                                             .archive(archive)
 476                                             .censusRepo(censusBuilder.build())
 477                                             .list(listAddress)
 478                                             .listArchive(listServer.getArchive())
 479                                             .smtpServer(listServer.getSMTP())
 480                                             .webrevStorageRepository(archive)
 481                                             .webrevStorageRef(&quot;webrev&quot;)
 482                                             .webrevStorageBase(Path.of(&quot;test&quot;))
 483                                             .webrevStorageBaseUri(webrevServer.uri())
 484                                             .issueTracker(URIBuilder.base(&quot;http://issues.test/browse/&quot;).build())
 485                                             .build();
 486 
 487             // Populate the projects repository
 488             var reviewFile = Path.of(&quot;reviewfile.txt&quot;);
 489             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType(), reviewFile);
 490             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
 491             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
 492             localRepo.push(masterHash, archive.url(), &quot;webrev&quot;, true);
 493 
 494             // Make a change with a corresponding PR
 495             var editHash = CheckableRepository.appendAndCommit(localRepo);
 496             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
 497             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
 498             pr.setBody(&quot;This is now ready&quot;);
 499             TestBotRunner.runPeriodicItems(mlBot);
 500             listServer.processIncoming();
 501 
 502             // Make a file specific comment
 503             var reviewPr = reviewer.pullRequest(pr.id());
 504             var comment1 = reviewPr.addReviewComment(masterHash, editHash, reviewFile.toString(), 2, &quot;Review comment&quot;);
 505             pr.addReviewCommentReply(comment1, &quot;I agree&quot;);
 506             reviewPr.addReviewCommentReply(comment1, &quot;Great&quot;);
 507             TestBotRunner.runPeriodicItems(mlBot);
 508             listServer.processIncoming();
 509             listServer.processIncoming();
 510             listServer.processIncoming();
 511 
 512             // And a second one by ourselves
 513             var comment2 = pr.addReviewComment(masterHash, editHash, reviewFile.toString(), 2, &quot;Another review comment&quot;);
 514             reviewPr.addReviewCommentReply(comment2, &quot;Sounds good&quot;);
 515             pr.addReviewCommentReply(comment2, &quot;Thanks&quot;);
 516             TestBotRunner.runPeriodicItems(mlBot);
 517             listServer.processIncoming();
 518             listServer.processIncoming();
 519             listServer.processIncoming();
 520 
 521             // Finally some approvals and another comment
 522             pr.addReview(Review.Verdict.APPROVED, &quot;Nice&quot;);
 523             reviewPr.addReviewComment(masterHash, editHash, reviewFile.toString(), 2, &quot;The final review comment&quot;);
 524             reviewPr.addReview(Review.Verdict.APPROVED, &quot;Looks fine&quot;);
 525             reviewPr.addReviewCommentReply(comment2, &quot;You are welcome&quot;);
 526             TestBotRunner.runPeriodicItems(mlBot);
 527             listServer.processIncoming();
 528             listServer.processIncoming();
 529             listServer.processIncoming();
 530 
 531             // Sanity check the archive
 532             Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);
 533             assertEquals(9, archiveContainsCount(archiveFolder.path(), &quot;^On.*wrote:&quot;));
 534 
 535             // File specific comments should appear after the approval
 536             var archiveText = archiveContents(archiveFolder.path()).orElseThrow();
 537             assertTrue(archiveText.indexOf(&quot;Looks fine&quot;) &lt; archiveText.indexOf(&quot;The final review comment&quot;));
 538 
 539             // Check the mailing list
 540             var mailmanServer = MailingListServerFactory.createMailmanServer(listServer.getArchive(), listServer.getSMTP(), Duration.ZERO);
 541             var mailmanList = mailmanServer.getList(listAddress.address());
 542             var conversations = mailmanList.conversations(Duration.ofDays(1));
 543             assertEquals(1, conversations.size());
 544             var mail = conversations.get(0).first();
 545             assertEquals(&quot;RFR: This is a pull request&quot;, mail.subject());
 546             assertEquals(10, conversations.get(0).allMessages().size());
 547 
 548             // There should be four separate threads
 549             var thread1 = conversations.get(0).replies(mail).get(0);
 550             assertEquals(2, thread1.body().split(&quot;^On.*wrote:&quot;).length);
 551             assertEquals(2, thread1.body().split(&quot;&gt; This is now ready&quot;).length, thread1.body());
<a name="2" id="anc2"></a><span class="line-modified"> 552             assertEquals(&quot;RFR: This is a pull request&quot;, thread1.subject());</span>
 553             assertTrue(thread1.body().contains(&quot;Review comment\n\n&quot;), thread1.body());
 554             assertFalse(thread1.body().contains(&quot;Another review comment&quot;), thread1.body());
 555             var thread1reply1 = conversations.get(0).replies(thread1).get(0);
 556             assertTrue(thread1reply1.body().contains(&quot;I agree&quot;));
 557             assertEquals(noreplyAddress(archive), thread1reply1.author().address());
 558             assertEquals(archive.forge().currentUser().fullName(), thread1reply1.author().fullName().orElseThrow());
 559             var thread1reply2 = conversations.get(0).replies(thread1reply1).get(0);
 560             assertTrue(thread1reply2.body().contains(&quot;Great&quot;));
 561             assertEquals(&quot;integrationreviewer1@openjdk.java.net&quot;, thread1reply2.author().address());
 562             assertEquals(&quot;Generated Reviewer 1&quot;, thread1reply2.author().fullName().orElseThrow());
 563 
 564             var thread2 = conversations.get(0).replies(mail).get(1);
 565             assertEquals(2, thread2.body().split(&quot;^On.*wrote:&quot;).length);
 566             assertEquals(2, thread2.body().split(&quot;&gt; This is now ready&quot;).length, thread2.body());
<a name="3" id="anc3"></a><span class="line-modified"> 567             assertEquals(&quot;RFR: This is a pull request&quot;, thread2.subject());</span>
 568             assertFalse(thread2.body().contains(&quot;Review comment\n\n&quot;), thread2.body());
 569             assertTrue(thread2.body().contains(&quot;Another review comment&quot;), thread2.body());
 570             var thread2reply1 = conversations.get(0).replies(thread2).get(0);
 571             assertTrue(thread2reply1.body().contains(&quot;Sounds good&quot;));
 572             var thread2reply2 = conversations.get(0).replies(thread2reply1).get(0);
 573             assertTrue(thread2reply2.body().contains(&quot;Thanks&quot;));
 574 
 575             var replies = conversations.get(0).replies(mail);
 576             var thread3 = replies.get(2);
<a name="4" id="anc4"></a><span class="line-modified"> 577             assertEquals(&quot;RFR: This is a pull request&quot;, thread3.subject());</span>
 578             var thread4 = replies.get(3);
<a name="5" id="anc5"></a><span class="line-modified"> 579             assertEquals(&quot;RFR: This is a pull request&quot;, thread4.subject());</span>
 580             assertTrue(thread4.body().contains(&quot;Looks fine&quot;));
 581             assertTrue(thread4.body().contains(&quot;The final review comment&quot;));
 582             assertTrue(thread4.body().contains(&quot;Marked as reviewed by integrationreviewer1 (Reviewer)&quot;));
 583         }
 584     }
 585 
 586     @Test
 587     void commentThreadingSeparated(TestInfo testInfo) throws IOException {
 588         try (var credentials = new HostCredentials(testInfo);
 589              var tempFolder = new TemporaryDirectory();
 590              var archiveFolder = new TemporaryDirectory();
 591              var listServer = new TestMailmanServer();
 592              var webrevServer = new TestWebrevServer()) {
 593             var author = credentials.getHostedRepository();
 594             var reviewer = credentials.getHostedRepository();
 595             var archive = credentials.getHostedRepository();
 596             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
 597             var censusBuilder = credentials.getCensusBuilder()
 598                                            .addReviewer(reviewer.forge().currentUser().id())
 599                                            .addAuthor(author.forge().currentUser().id());
 600             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
 601             var mlBot = MailingListBridgeBot.newBuilder()
 602                                             .from(from)
 603                                             .repo(author)
 604                                             .archive(archive)
 605                                             .censusRepo(censusBuilder.build())
 606                                             .list(listAddress)
 607                                             .listArchive(listServer.getArchive())
 608                                             .smtpServer(listServer.getSMTP())
 609                                             .webrevStorageRepository(archive)
 610                                             .webrevStorageRef(&quot;webrev&quot;)
 611                                             .webrevStorageBase(Path.of(&quot;test&quot;))
 612                                             .webrevStorageBaseUri(webrevServer.uri())
 613                                             .issueTracker(URIBuilder.base(&quot;http://issues.test/browse/&quot;).build())
 614                                             .build();
 615 
 616             // Populate the projects repository
 617             var reviewFile = Path.of(&quot;reviewfile.txt&quot;);
 618             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType(), reviewFile);
 619             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
 620             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
 621             localRepo.push(masterHash, archive.url(), &quot;webrev&quot;, true);
 622 
 623             // Make a change with a corresponding PR
 624             var editHash = CheckableRepository.appendAndCommit(localRepo);
 625             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
 626             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
 627             pr.setBody(&quot;This is now ready&quot;);
 628             TestBotRunner.runPeriodicItems(mlBot);
 629             listServer.processIncoming();
 630 
 631             // Make two file specific comments
 632             var reviewPr = reviewer.pullRequest(pr.id());
 633             var comment1 = reviewPr.addReviewComment(masterHash, editHash, reviewFile.toString(), 2, &quot;Review comment&quot;);
 634             var comment2 = reviewPr.addReviewComment(masterHash, editHash, reviewFile.toString(), 2, &quot;Another review comment&quot;);
 635             TestBotRunner.runPeriodicItems(mlBot);
 636             listServer.processIncoming();
 637 
 638             pr.addReviewCommentReply(comment1, &quot;I agree&quot;);
 639             pr.addReviewCommentReply(comment2, &quot;I don&#39;t agree&quot;);
 640             TestBotRunner.runPeriodicItems(mlBot);
 641             listServer.processIncoming();
 642 
 643             // Sanity check the archive
 644             Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);
 645             assertEquals(3, archiveContainsCount(archiveFolder.path(), &quot;^On.*wrote:&quot;));
 646         }
 647     }
 648 
 649     @Test
 650     void reviewContext(TestInfo testInfo) throws IOException {
 651         try (var credentials = new HostCredentials(testInfo);
 652              var tempFolder = new TemporaryDirectory();
 653              var archiveFolder = new TemporaryDirectory();
 654              var listServer = new TestMailmanServer();
 655              var webrevServer = new TestWebrevServer()) {
 656             var author = credentials.getHostedRepository();
 657             var archive = credentials.getHostedRepository();
 658             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
 659             var censusBuilder = credentials.getCensusBuilder()
 660                                            .addAuthor(author.forge().currentUser().id());
 661             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
 662             var mlBot = MailingListBridgeBot.newBuilder()
 663                                             .from(from)
 664                                             .repo(author)
 665                                             .archive(archive)
 666                                             .censusRepo(censusBuilder.build())
 667                                             .list(listAddress)
 668                                             .listArchive(listServer.getArchive())
 669                                             .smtpServer(listServer.getSMTP())
 670                                             .webrevStorageRepository(archive)
 671                                             .webrevStorageRef(&quot;webrev&quot;)
 672                                             .webrevStorageBase(Path.of(&quot;test&quot;))
 673                                             .webrevStorageBaseUri(webrevServer.uri())
 674                                             .issueTracker(URIBuilder.base(&quot;http://issues.test/browse/&quot;).build())
 675                                             .build();
 676 
 677             // Populate the projects repository
 678             var reviewFile = Path.of(&quot;reviewfile.txt&quot;);
 679             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType(), reviewFile);
 680             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
 681             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
 682             localRepo.push(masterHash, archive.url(), &quot;webrev&quot;, true);
 683 
 684             // Make a change with a corresponding PR
 685             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;Line 1\nLine 2\nLine 3\nLine 4&quot;);
 686             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
 687             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
 688             pr.setBody(&quot;This is now ready&quot;);
 689             TestBotRunner.runPeriodicItems(mlBot);
 690             listServer.processIncoming();
 691 
 692             // Make a file specific comment
 693             pr.addReviewComment(masterHash, editHash, reviewFile.toString(), 2, &quot;Review comment&quot;);
 694 
 695             TestBotRunner.runPeriodicItems(mlBot);
 696             listServer.processIncoming();
 697 
 698             // The archive should only contain context around line 2
 699             Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);
 700             assertTrue(archiveContains(archiveFolder.path(), &quot;^&gt; 2: Line 1$&quot;));
 701             assertTrue(archiveContains(archiveFolder.path(), &quot;^&gt; 3: Line 2$&quot;));
 702             assertFalse(archiveContains(archiveFolder.path(), &quot;^&gt; 4: Line 3$&quot;));
 703         }
 704     }
 705 
 706     @Test
 707     void multipleReviewContexts(TestInfo testInfo) throws IOException {
 708         try (var credentials = new HostCredentials(testInfo);
 709              var tempFolder = new TemporaryDirectory();
 710              var archiveFolder = new TemporaryDirectory();
 711              var listServer = new TestMailmanServer();
 712              var webrevServer = new TestWebrevServer()) {
 713             var author = credentials.getHostedRepository();
 714             var archive = credentials.getHostedRepository();
 715             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
 716             var censusBuilder = credentials.getCensusBuilder()
 717                                            .addAuthor(author.forge().currentUser().id());
 718             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
 719             var mlBot = MailingListBridgeBot.newBuilder()
 720                                             .from(from)
 721                                             .repo(author)
 722                                             .archive(archive)
 723                                             .censusRepo(censusBuilder.build())
 724                                             .list(listAddress)
 725                                             .listArchive(listServer.getArchive())
 726                                             .smtpServer(listServer.getSMTP())
 727                                             .webrevStorageRepository(archive)
 728                                             .webrevStorageRef(&quot;webrev&quot;)
 729                                             .webrevStorageBase(Path.of(&quot;test&quot;))
 730                                             .webrevStorageBaseUri(webrevServer.uri())
 731                                             .issueTracker(URIBuilder.base(&quot;http://issues.test/browse/&quot;).build())
 732                                             .build();
 733 
 734             // Populate the projects repository
 735             var reviewFile = Path.of(&quot;reviewfile.txt&quot;);
 736             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType(), reviewFile);
 737             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
 738             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
 739             localRepo.push(masterHash, archive.url(), &quot;webrev&quot;, true);
 740             var initialHash = CheckableRepository.appendAndCommit(localRepo,
 741                                                                   &quot;Line 0.1\nLine 0.2\nLine 0.3\nLine 0.4\n&quot; +
 742                                                                           &quot;Line 1\nLine 2\nLine 3\nLine 4\n&quot; +
 743                                                                           &quot;Line 5\nLine 6\nLine 7\nLine 8\n&quot; +
 744                                                                           &quot;Line 8.1\nLine 8.2\nLine 8.3\nLine 8.4\n&quot; +
 745                                                                           &quot;Line 9\nLine 10\nLine 11\nLine 12\n&quot; +
 746                                                                           &quot;Line 13\nLine 14\nLine 15\nLine 16\n&quot;);
 747             localRepo.push(initialHash, author.url(), &quot;master&quot;);
 748 
 749             // Make a change with a corresponding PR
 750             var current = Files.readString(localRepo.root().resolve(reviewFile), StandardCharsets.UTF_8);
 751             var updated = current.replaceAll(&quot;Line 2&quot;, &quot;Line 2 edit\nLine 2.5&quot;);
 752             updated = updated.replaceAll(&quot;Line 13&quot;, &quot;Line 12.5\nLine 13 edit&quot;);
 753             Files.writeString(localRepo.root().resolve(reviewFile), updated, StandardCharsets.UTF_8);
 754             var editHash = CheckableRepository.appendAndCommit(localRepo);
 755             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
 756             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
 757             pr.setBody(&quot;This is now ready&quot;);
 758             TestBotRunner.runPeriodicItems(mlBot);
 759             listServer.processIncoming();
 760 
 761             // Make file specific comments
 762             pr.addReviewComment(masterHash, editHash, reviewFile.toString(), 7, &quot;Review comment&quot;);
 763             pr.addReviewComment(masterHash, editHash, reviewFile.toString(), 24, &quot;Another review comment&quot;);
 764 
 765             TestBotRunner.runPeriodicItems(mlBot);
 766             listServer.processIncoming();
 767 
 768             // The archive should only contain context around line 2 and 20
 769             Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);
 770             assertTrue(archiveContains(archiveFolder.path(), &quot;reviewfile.txt line 7&quot;));
 771             assertTrue(archiveContains(archiveFolder.path(), &quot;^&gt; 6: Line 1$&quot;));
 772             assertTrue(archiveContains(archiveFolder.path(), &quot;^&gt; 7: Line 2 edit$&quot;));
 773             assertFalse(archiveContains(archiveFolder.path(), &quot;Line 3&quot;));
 774 
 775             assertTrue(archiveContains(archiveFolder.path(), &quot;reviewfile.txt line 24&quot;));
 776             assertTrue(archiveContains(archiveFolder.path(), &quot;^&gt; 23: Line 12.5$&quot;));
 777             assertTrue(archiveContains(archiveFolder.path(), &quot;^&gt; 24: Line 13 edit$&quot;));
 778             assertFalse(archiveContains(archiveFolder.path(), &quot;^Line 15&quot;));
 779         }
 780     }
 781 
 782     @Test
 783     void filterComments(TestInfo testInfo) throws IOException {
 784         try (var credentials = new HostCredentials(testInfo);
 785              var tempFolder = new TemporaryDirectory();
 786              var archiveFolder = new TemporaryDirectory();
 787              var listServer = new TestMailmanServer();
 788              var webrevServer = new TestWebrevServer()) {
 789             var author = credentials.getHostedRepository();
 790             var archive = credentials.getHostedRepository();
 791             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
 792             var censusBuilder = credentials.getCensusBuilder()
 793                                            .addAuthor(author.forge().currentUser().id());
 794             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
 795             var mlBot = MailingListBridgeBot.newBuilder()
 796                                             .from(from)
 797                                             .repo(author)
 798                                             .archive(archive)
 799                                             .censusRepo(censusBuilder.build())
 800                                             .list(listAddress)
 801                                             .listArchive(listServer.getArchive())
 802                                             .smtpServer(listServer.getSMTP())
 803                                             .webrevStorageRepository(archive)
 804                                             .webrevStorageRef(&quot;webrev&quot;)
 805                                             .webrevStorageBase(Path.of(&quot;test&quot;))
 806                                             .webrevStorageBaseUri(webrevServer.uri())
 807                                             .issueTracker(URIBuilder.base(&quot;http://issues.test/browse/&quot;).build())
 808                                             .build();
 809 
 810             // Populate the projects repository
 811             var reviewFile = Path.of(&quot;reviewfile.txt&quot;);
 812             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType(), reviewFile);
 813             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
 814             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
 815             localRepo.push(masterHash, archive.url(), &quot;webrev&quot;, true);
 816 
 817             // Make a change with a corresponding PR
 818             var editHash = CheckableRepository.appendAndCommit(localRepo);
 819             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
 820             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
 821             pr.setBody(&quot;This is now ready\n&lt;!-- this is a comment --&gt;\nAnd this is not\n&quot; +
 822                                &quot;&lt;!-- Anything below this marker will be hidden --&gt;\nStatus stuff&quot;);
 823 
 824             // Make a bunch of comments
 825             pr.addComment(&quot;Plain comment\n&lt;!-- this is a comment --&gt;&quot;);
 826             pr.addReviewComment(masterHash, editHash, reviewFile.toString(), 2, &quot;Review comment &lt;!-- this is a comment --&gt;\n&quot;);
 827             pr.addComment(&quot;/integrate stuff&quot;);
 828             TestBotRunner.runPeriodicItems(mlBot);
 829 
 830             // Run an archive pass
 831             TestBotRunner.runPeriodicItems(mlBot);
 832 
 833             // The archive should not contain the comment
 834             Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);
 835             assertTrue(archiveContains(archiveFolder.path(), &quot;This is now ready&quot;));
 836             assertFalse(archiveContains(archiveFolder.path(), &quot;this is a comment&quot;));
 837             assertFalse(archiveContains(archiveFolder.path(), &quot;Status stuff&quot;));
 838             assertTrue(archiveContains(archiveFolder.path(), &quot;And this is not&quot;));
 839             assertFalse(archiveContains(archiveFolder.path(), &quot;&lt;!--&quot;));
 840             assertFalse(archiveContains(archiveFolder.path(), &quot;--&gt;&quot;));
 841             assertTrue(archiveContains(archiveFolder.path(), &quot;Plain comment&quot;));
 842             assertTrue(archiveContains(archiveFolder.path(), &quot;Review comment&quot;));
 843             assertFalse(archiveContains(archiveFolder.path(), &quot;/integrate&quot;));
 844         }
 845     }
 846 
 847     @Test
 848     void incrementalChanges(TestInfo testInfo) throws IOException {
 849         try (var credentials = new HostCredentials(testInfo);
 850              var tempFolder = new TemporaryDirectory();
 851              var archiveFolder = new TemporaryDirectory();
 852              var listServer = new TestMailmanServer();
 853              var webrevServer = new TestWebrevServer()) {
 854             var author = credentials.getHostedRepository();
 855             var archive = credentials.getHostedRepository();
 856             var commenter = credentials.getHostedRepository();
 857             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
 858             var censusBuilder = credentials.getCensusBuilder()
 859                                            .addAuthor(author.forge().currentUser().id());
 860             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
 861             var mlBot = MailingListBridgeBot.newBuilder()
 862                                             .from(from)
 863                                             .repo(author)
 864                                             .archive(archive)
 865                                             .censusRepo(censusBuilder.build())
 866                                             .list(listAddress)
 867                                             .listArchive(listServer.getArchive())
 868                                             .smtpServer(listServer.getSMTP())
 869                                             .webrevStorageRepository(archive)
 870                                             .webrevStorageRef(&quot;webrev&quot;)
 871                                             .webrevStorageBase(Path.of(&quot;test&quot;))
 872                                             .webrevStorageBaseUri(webrevServer.uri())
 873                                             .issueTracker(URIBuilder.base(&quot;http://issues.test/browse/&quot;).build())
 874                                             .build();
 875 
 876             // Populate the projects repository
 877             var reviewFile = Path.of(&quot;reviewfile.txt&quot;);
 878             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType(), reviewFile);
 879             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
 880             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
 881             localRepo.push(masterHash, archive.url(), &quot;webrev&quot;, true);
 882 
 883             // Make a change with a corresponding PR
 884             var editHash = CheckableRepository.appendAndCommit(localRepo);
 885             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
 886             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
 887             pr.setBody(&quot;This is now ready&quot;);
 888 
 889             // Run an archive pass
 890             TestBotRunner.runPeriodicItems(mlBot);
 891             listServer.processIncoming();
 892 
 893             var nextHash = CheckableRepository.appendAndCommit(localRepo, &quot;Yet one more line&quot;, &quot;Fixing&quot;);
 894             localRepo.push(nextHash, author.url(), &quot;edit&quot;);
 895 
 896             // Make sure that the push registered
 897             var lastHeadHash = pr.headHash();
 898             var refreshCount = 0;
 899             do {
 900                 pr = author.pullRequest(pr.id());
 901                 if (refreshCount++ &gt; 100) {
 902                     fail(&quot;The PR did not update after the new push&quot;);
 903                 }
 904             } while (pr.headHash().equals(lastHeadHash));
 905 
 906             // Run another archive pass
 907             TestBotRunner.runPeriodicItems(mlBot);
 908             TestBotRunner.runPeriodicItems(mlBot);
 909             TestBotRunner.runPeriodicItems(mlBot);
 910             listServer.processIncoming();
 911 
 912             // The archive should reference the updated push
 913             Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);
 914             assertTrue(archiveContains(archiveFolder.path(), &quot;1 additional commit&quot;));
 915             assertTrue(archiveContains(archiveFolder.path(), &quot;full.*/&quot; + pr.id() + &quot;/webrev.01&quot;));
 916             assertTrue(archiveContains(archiveFolder.path(), &quot;inc.*/&quot; + pr.id() + &quot;/webrev.00-01&quot;));
 917             assertTrue(archiveContains(archiveFolder.path(), &quot;Patch&quot;));
 918             assertTrue(archiveContains(archiveFolder.path(), &quot;Fetch&quot;));
 919             assertTrue(archiveContains(archiveFolder.path(), &quot;Fixing&quot;));
 920 
 921             // The webrev comment should be updated
 922             var comments = pr.comments();
 923             var webrevComments = comments.stream()
 924                                          .filter(comment -&gt; comment.author().equals(author.forge().currentUser()))
 925                                          .filter(comment -&gt; comment.body().contains(&quot;webrev&quot;))
 926                                          .filter(comment -&gt; comment.body().contains(&quot;Full&quot;))
 927                                          .filter(comment -&gt; comment.body().contains(&quot;Incremental&quot;))
 928                                          .filter(comment -&gt; comment.body().contains(nextHash.hex()))
 929                                          .filter(comment -&gt; comment.body().contains(editHash.hex()))
 930                                          .collect(Collectors.toList());
 931             assertEquals(1, webrevComments.size());
 932 
 933             // Check that sender address is set properly
 934             var mailmanServer = MailingListServerFactory.createMailmanServer(listServer.getArchive(), listServer.getSMTP(), Duration.ZERO);
 935             var mailmanList = mailmanServer.getList(listAddress.address());
 936             var conversations = mailmanList.conversations(Duration.ofDays(1));
 937             assertEquals(1, conversations.size());
 938             for (var newMail : conversations.get(0).allMessages()) {
 939                 assertEquals(noreplyAddress(archive), newMail.author().address());
 940                 assertEquals(listAddress, newMail.sender());
 941             }
 942 
 943             // Add a comment
 944             var commenterPr = commenter.pullRequest(pr.id());
 945             commenterPr.addReviewComment(masterHash, nextHash, reviewFile.toString(), 2, &quot;Review comment&quot;);
 946             TestBotRunner.runPeriodicItems(mlBot);
 947             listServer.processIncoming();
 948 
 949             // Ensure that additional updates are only reported once
 950             for (int i = 0; i &lt; 3; ++i) {
 951                 var anotherHash = CheckableRepository.appendAndCommit(localRepo, &quot;Another line&quot;, &quot;Fixing&quot;);
 952                 localRepo.push(anotherHash, author.url(), &quot;edit&quot;);
 953 
 954                 // Make sure that the push registered
 955                 lastHeadHash = pr.headHash();
 956                 refreshCount = 0;
 957                 do {
 958                     pr = author.pullRequest(pr.id());
 959                     if (refreshCount++ &gt; 100) {
 960                         fail(&quot;The PR did not update after the new push&quot;);
 961                     }
 962                 } while (pr.headHash().equals(lastHeadHash));
 963 
 964                 TestBotRunner.runPeriodicItems(mlBot);
 965                 TestBotRunner.runPeriodicItems(mlBot);
 966                 listServer.processIncoming();
 967             }
 968             var updatedConversations = mailmanList.conversations(Duration.ofDays(1));
 969             assertEquals(1, updatedConversations.size());
 970             var conversation = updatedConversations.get(0);
 971             assertEquals(6, conversation.allMessages().size());
<a name="6" id="anc6"></a><span class="line-modified"> 972             assertEquals(&quot;[Rev 01] RFR: This is a pull request&quot;, conversation.allMessages().get(1).subject());</span>
<span class="line-modified"> 973             assertEquals(&quot;[Rev 01] RFR: This is a pull request&quot;, conversation.allMessages().get(2).subject(), conversation.allMessages().get(2).toString());</span>
<span class="line-modified"> 974             assertEquals(&quot;[Rev 04] RFR: This is a pull request&quot;, conversation.allMessages().get(5).subject());</span>
 975         }
 976     }
 977 
 978     @Test
 979     void rebased(TestInfo testInfo) throws IOException {
 980         try (var credentials = new HostCredentials(testInfo);
 981              var tempFolder = new TemporaryDirectory();
 982              var archiveFolder = new TemporaryDirectory();
 983              var listServer = new TestMailmanServer();
 984              var webrevServer = new TestWebrevServer()) {
 985             var author = credentials.getHostedRepository();
 986             var archive = credentials.getHostedRepository();
 987             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
 988             var censusBuilder = credentials.getCensusBuilder()
 989                                            .addAuthor(author.forge().currentUser().id());
 990             var sender = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
 991             var mlBot = MailingListBridgeBot.newBuilder()
 992                                             .from(sender)
 993                                             .repo(author)
 994                                             .archive(archive)
 995                                             .censusRepo(censusBuilder.build())
 996                                             .list(listAddress)
 997                                             .listArchive(listServer.getArchive())
 998                                             .smtpServer(listServer.getSMTP())
 999                                             .webrevStorageRepository(archive)
1000                                             .webrevStorageRef(&quot;webrev&quot;)
1001                                             .webrevStorageBase(Path.of(&quot;test&quot;))
1002                                             .webrevStorageBaseUri(webrevServer.uri())
1003                                             .issueTracker(URIBuilder.base(&quot;http://issues.test/browse/&quot;).build())
1004                                             .build();
1005 
1006             // Populate the projects repository
1007             var reviewFile = Path.of(&quot;reviewfile.txt&quot;);
1008             var localRepo = CheckableRepository.init(tempFolder.path().resolve(&quot;first&quot;), author.repositoryType(), reviewFile);
1009             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
1010             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
1011             localRepo.push(masterHash, archive.url(), &quot;webrev&quot;, true);
1012 
1013             // Make a change with a corresponding PR
1014             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;A line&quot;, &quot;Original msg&quot;);
1015             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
1016             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
1017             pr.setBody(&quot;This is now ready&quot;);
1018 
1019             // Run an archive pass
1020             TestBotRunner.runPeriodicItems(mlBot);
1021             listServer.processIncoming();
1022 
1023             var newLocalRepo = Repository.materialize(tempFolder.path().resolve(&quot;second&quot;), author.url(), &quot;master&quot;);
1024             var newEditHash = CheckableRepository.appendAndCommit(newLocalRepo, &quot;Another line&quot;, &quot;Replaced msg&quot;);
1025             newLocalRepo.push(newEditHash, author.url(), &quot;edit&quot;, true);
1026 
1027             // Make sure that the push registered
1028             var lastHeadHash = pr.headHash();
1029             var refreshCount = 0;
1030             do {
1031                 pr = author.pullRequest(pr.id());
1032                 if (refreshCount++ &gt; 100) {
1033                     fail(&quot;The PR did not update after the new push&quot;);
1034                 }
1035             } while (pr.headHash().equals(lastHeadHash));
1036 
1037             // Run another archive pass
1038             TestBotRunner.runPeriodicItems(mlBot);
1039             listServer.processIncoming();
1040 
1041             // The archive should reference the rebased push
1042             Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);
1043             assertTrue(archiveContains(archiveFolder.path(), &quot;updated with a new target base&quot;));
1044             assertTrue(archiveContains(archiveFolder.path(), pr.id() + &quot;/webrev.01&quot;));
1045             assertFalse(archiveContains(archiveFolder.path(), &quot;Incremental&quot;));
1046             assertTrue(archiveContains(archiveFolder.path(), &quot;Patch&quot;));
1047             assertTrue(archiveContains(archiveFolder.path(), &quot;Fetch&quot;));
1048             assertTrue(archiveContains(archiveFolder.path(), &quot;Original msg&quot;));
1049             assertTrue(archiveContains(archiveFolder.path(), &quot;Replaced msg&quot;));
1050 
1051             // The webrev comment should be updated
1052             var comments = pr.comments();
1053             var webrevComments = comments.stream()
1054                                          .filter(comment -&gt; comment.author().equals(author.forge().currentUser()))
1055                                          .filter(comment -&gt; comment.body().contains(&quot;webrev&quot;))
1056                                          .filter(comment -&gt; comment.body().contains(newEditHash.hex()))
1057                                          .collect(Collectors.toList());
1058             assertEquals(1, webrevComments.size());
1059 
1060             // Check that sender address is set properly
1061             var mailmanServer = MailingListServerFactory.createMailmanServer(listServer.getArchive(), listServer.getSMTP(), Duration.ZERO);
1062             var mailmanList = mailmanServer.getList(listAddress.address());
1063             var conversations = mailmanList.conversations(Duration.ofDays(1));
1064             assertEquals(1, conversations.size());
1065             for (var newMail : conversations.get(0).allMessages()) {
1066                 assertEquals(noreplyAddress(archive), newMail.author().address());
1067                 assertEquals(listAddress, newMail.sender());
1068                 assertFalse(newMail.hasHeader(&quot;PR-Head-Hash&quot;));
1069             }
<a name="7" id="anc7"></a><span class="line-modified">1070             assertEquals(&quot;[Rev 01] RFR: This is a pull request&quot;, conversations.get(0).allMessages().get(1).subject());</span>
1071         }
1072     }
1073 
1074     @Test
1075     void incrementalAfterRebase(TestInfo testInfo) throws IOException {
1076         try (var credentials = new HostCredentials(testInfo);
1077              var tempFolder = new TemporaryDirectory();
1078              var archiveFolder = new TemporaryDirectory();
1079              var listServer = new TestMailmanServer();
1080              var webrevServer = new TestWebrevServer()) {
1081             var author = credentials.getHostedRepository();
1082             var archive = credentials.getHostedRepository();
1083             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
1084             var censusBuilder = credentials.getCensusBuilder()
1085                                            .addAuthor(author.forge().currentUser().id());
1086             var sender = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
1087             var mlBot = MailingListBridgeBot.newBuilder()
1088                                             .from(sender)
1089                                             .repo(author)
1090                                             .archive(archive)
1091                                             .archiveRef(&quot;archive&quot;)
1092                                             .censusRepo(censusBuilder.build())
1093                                             .list(listAddress)
1094                                             .listArchive(listServer.getArchive())
1095                                             .smtpServer(listServer.getSMTP())
1096                                             .webrevStorageRepository(archive)
1097                                             .webrevStorageRef(&quot;webrev&quot;)
1098                                             .webrevStorageBase(Path.of(&quot;test&quot;))
1099                                             .webrevStorageBaseUri(webrevServer.uri())
1100                                             .issueTracker(URIBuilder.base(&quot;http://issues.test/browse/&quot;).build())
1101                                             .build();
1102 
1103             // Populate the projects repository
1104             var reviewFile = Path.of(&quot;reviewfile.txt&quot;);
1105             var localRepo = CheckableRepository.init(tempFolder.path().resolve(&quot;first&quot;), author.repositoryType(), reviewFile);
1106             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
1107             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
1108             localRepo.push(masterHash, archive.url(), &quot;webrev&quot;, true);
1109             localRepo.push(masterHash, archive.url(), &quot;archive&quot;, true);
1110 
1111             // Make a change with a corresponding PR
1112             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;A line&quot;, &quot;Original msg&quot;);
1113             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
1114             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
1115             pr.setBody(&quot;This is now ready&quot;);
1116 
1117             // Run an archive pass
1118             TestBotRunner.runPeriodicItems(mlBot);
1119             listServer.processIncoming();
1120 
1121             // Push more stuff to master
1122             localRepo.checkout(masterHash, true);
1123             var unrelatedFile = localRepo.root().resolve(&quot;unrelated.txt&quot;);
1124             Files.writeString(unrelatedFile, &quot;Other things happens in master&quot;);
1125             localRepo.add(unrelatedFile);
1126             var newMasterHash = localRepo.commit(&quot;Unrelated change&quot;, &quot;duke&quot;, &quot;duke@openjdk.org&quot;);
1127             localRepo.push(newMasterHash, author.url(), &quot;master&quot;);
1128 
1129             // And more stuff to the pr branch
1130             localRepo.checkout(editHash, true);
1131             CheckableRepository.appendAndCommit(localRepo, &quot;Another line&quot;, &quot;More updates&quot;);
1132 
1133             // Merge master
1134             localRepo.merge(newMasterHash);
1135             var newEditHash = localRepo.commit(&quot;Latest changes from master&quot;, &quot;duke&quot;, &quot;duke@openjdk.org&quot;);
1136             localRepo.push(newEditHash, author.url(), &quot;edit&quot;);
1137 
1138             // Make sure that the push registered
1139             var lastHeadHash = pr.headHash();
1140             var refreshCount = 0;
1141             do {
1142                 pr = author.pullRequest(pr.id());
1143                 if (refreshCount++ &gt; 100) {
1144                     fail(&quot;The PR did not update after the new push&quot;);
1145                 }
1146             } while (pr.headHash().equals(lastHeadHash));
1147 
1148             // Run another archive pass
1149             TestBotRunner.runPeriodicItems(mlBot);
1150             listServer.processIncoming();
1151 
1152             // The archive should reference the rebased push
1153             Repository.materialize(archiveFolder.path(), archive.url(), &quot;archive&quot;);
1154             assertTrue(archiveContains(archiveFolder.path(), &quot;updated with a new target base&quot;));
1155             assertTrue(archiveContains(archiveFolder.path(), &quot;excludes the unrelated changes&quot;));
1156             assertTrue(archiveContains(archiveFolder.path(), pr.id() + &quot;/webrev.01&quot;));
1157             assertTrue(archiveContains(archiveFolder.path(), pr.id() + &quot;/webrev.00-01&quot;));
1158             assertTrue(archiveContains(archiveFolder.path(), &quot;Original msg&quot;));
1159             assertTrue(archiveContains(archiveFolder.path(), &quot;More updates&quot;));
1160         }
1161     }
1162 
1163     @Test
1164     void skipAddingExistingWebrev(TestInfo testInfo) throws IOException {
1165         try (var credentials = new HostCredentials(testInfo);
1166              var tempFolder = new TemporaryDirectory();
1167              var archiveFolder = new TemporaryDirectory();
1168              var webrevFolder = new TemporaryDirectory();
1169              var listServer = new TestMailmanServer();
1170              var webrevServer = new TestWebrevServer()) {
1171             var author = credentials.getHostedRepository();
1172             var archive = credentials.getHostedRepository();
1173             var ignored = credentials.getHostedRepository();
1174             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
1175             var censusBuilder = credentials.getCensusBuilder()
1176                                            .addAuthor(author.forge().currentUser().id());
1177             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
1178             var mlBot = MailingListBridgeBot.newBuilder()
1179                                             .from(from)
1180                                             .repo(author)
1181                                             .archive(archive)
1182                                             .censusRepo(censusBuilder.build())
1183                                             .list(listAddress)
1184                                             .ignoredUsers(Set.of(ignored.forge().currentUser().userName()))
1185                                             .listArchive(listServer.getArchive())
1186                                             .smtpServer(listServer.getSMTP())
1187                                             .webrevStorageRepository(archive)
1188                                             .webrevStorageRef(&quot;webrev&quot;)
1189                                             .webrevStorageBase(Path.of(&quot;test&quot;))
1190                                             .webrevStorageBaseUri(webrevServer.uri())
1191                                             .issueTracker(URIBuilder.base(&quot;http://issues.test/browse/&quot;).build())
1192                                             .build();
1193 
1194             // Populate the projects repository
1195             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType());
1196             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
1197             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
1198             localRepo.push(masterHash, archive.url(), &quot;webrev&quot;, true);
1199 
1200             // Make a change with a corresponding PR
1201             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;A simple change&quot;,
1202                                                                &quot;Change msg\n\nWith several lines&quot;);
1203             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
1204             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
1205 
1206             // Flag it as ready for review
1207             pr.setBody(&quot;This should now be ready&quot;);
1208 
1209             // Run an archive pass
1210             TestBotRunner.runPeriodicItems(mlBot);
1211 
1212             // The archive should now contain an entry
1213             var archiveRepo = Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);
1214             assertTrue(archiveContains(archiveFolder.path(), editHash.abbreviate()));
1215 
1216             // And there should be a webrev comment
1217             var comments = pr.comments();
1218             var webrevComments = comments.stream()
1219                                          .filter(comment -&gt; comment.author().equals(author.forge().currentUser()))
1220                                          .filter(comment -&gt; comment.body().contains(&quot;webrev&quot;))
1221                                          .filter(comment -&gt; comment.body().contains(editHash.hex()))
1222                                          .collect(Collectors.toList());
1223             assertEquals(1, webrevComments.size());
1224             assertEquals(1, countSubstrings(webrevComments.get(0).body(), &quot;webrev.00&quot;));
1225 
1226             // Pretend the archive didn&#39;t work out
1227             archiveRepo.push(masterHash, archive.url(), &quot;master&quot;, true);
1228 
1229             // Run another archive pass
1230             TestBotRunner.runPeriodicItems(mlBot);
1231 
1232             // The webrev comment should not contain duplicate entries
1233             comments = pr.comments();
1234             webrevComments = comments.stream()
1235                                      .filter(comment -&gt; comment.author().equals(author.forge().currentUser()))
1236                                      .filter(comment -&gt; comment.body().contains(&quot;webrev&quot;))
1237                                      .filter(comment -&gt; comment.body().contains(editHash.hex()))
1238                                      .collect(Collectors.toList());
1239             assertEquals(1, webrevComments.size());
1240             assertEquals(1, countSubstrings(webrevComments.get(0).body(), &quot;webrev.00&quot;));
1241         }
1242     }
1243 
1244     @Test
1245     void notifyReviewVerdicts(TestInfo testInfo) throws IOException {
1246         try (var credentials = new HostCredentials(testInfo);
1247              var tempFolder = new TemporaryDirectory();
1248              var archiveFolder = new TemporaryDirectory();
1249              var listServer = new TestMailmanServer();
1250              var webrevServer = new TestWebrevServer()) {
1251             var author = credentials.getHostedRepository();
1252             var archive = credentials.getHostedRepository();
1253             var reviewer = credentials.getHostedRepository();
1254             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
1255             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
1256             var censusBuilder = credentials.getCensusBuilder()
1257                                            .addReviewer(reviewer.forge().currentUser().id())
1258                                            .addAuthor(author.forge().currentUser().id());
1259             var mlBot = MailingListBridgeBot.newBuilder()
1260                                             .from(from)
1261                                             .repo(author)
1262                                             .archive(archive)
1263                                             .censusRepo(censusBuilder.build())
1264                                             .list(listAddress)
1265                                             .listArchive(listServer.getArchive())
1266                                             .smtpServer(listServer.getSMTP())
1267                                             .webrevStorageRepository(archive)
1268                                             .webrevStorageRef(&quot;webrev&quot;)
1269                                             .webrevStorageBase(Path.of(&quot;test&quot;))
1270                                             .webrevStorageBaseUri(webrevServer.uri())
1271                                             .issueTracker(URIBuilder.base(&quot;http://issues.test/browse/&quot;).build())
1272                                             .build();
1273 
1274             // Populate the projects repository
1275             var reviewFile = Path.of(&quot;reviewfile.txt&quot;);
1276             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType(), reviewFile);
1277             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
1278             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
1279             localRepo.push(masterHash, archive.url(), &quot;webrev&quot;, true);
1280 
1281             // Make a change with a corresponding PR
1282             var editHash = CheckableRepository.appendAndCommit(localRepo);
1283             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
1284             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
1285             pr.setBody(&quot;This is now ready&quot;);
1286 
1287             // Run an archive pass
1288             TestBotRunner.runPeriodicItems(mlBot);
1289 
1290             // First unapprove it
1291             var reviewedPr = reviewer.pullRequest(pr.id());
1292             reviewedPr.addReview(Review.Verdict.DISAPPROVED, &quot;Reason 1&quot;);
1293             TestBotRunner.runPeriodicItems(mlBot);
1294             TestBotRunner.runPeriodicItems(mlBot);
1295             TestBotRunner.runPeriodicItems(mlBot);
1296 
1297             // The archive should contain a note
1298             Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);
1299             assertEquals(1, archiveContainsCount(archiveFolder.path(), &quot;Changes requested by &quot;));
1300             assertEquals(1, archiveContainsCount(archiveFolder.path(), &quot; by integrationreviewer1&quot;));
1301             if (author.forge().supportsReviewBody()) {
1302                 assertEquals(1, archiveContainsCount(archiveFolder.path(), &quot;Reason 1&quot;));
1303             }
1304 
1305             // Then approve it
1306             reviewedPr.addReview(Review.Verdict.APPROVED, &quot;Reason 2&quot;);
1307             TestBotRunner.runPeriodicItems(mlBot);
1308             TestBotRunner.runPeriodicItems(mlBot);
1309             TestBotRunner.runPeriodicItems(mlBot);
1310 
1311             // The archive should contain another note
1312             Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);
1313             assertEquals(1, archiveContainsCount(archiveFolder.path(), &quot;Marked as reviewed by &quot;));
1314             if (author.forge().supportsReviewBody()) {
1315                 assertEquals(1, archiveContainsCount(archiveFolder.path(), &quot;Reason 2&quot;));
1316             }
1317             assertEquals(2, archiveContainsCount(archiveFolder.path(), &quot;Re: RFR:&quot;));
1318 
1319             // Yet another change
1320             reviewedPr.addReview(Review.Verdict.DISAPPROVED, &quot;Reason 3&quot;);
1321             TestBotRunner.runPeriodicItems(mlBot);
1322             TestBotRunner.runPeriodicItems(mlBot);
1323             TestBotRunner.runPeriodicItems(mlBot);
1324 
1325             // The archive should contain another note
1326             Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);
1327             assertEquals(2, archiveContainsCount(archiveFolder.path(), &quot;Changes requested by &quot;));
1328             if (author.forge().supportsReviewBody()) {
1329                 assertEquals(1, archiveContainsCount(archiveFolder.path(), &quot;Reason 3&quot;));
1330             }
1331         }
1332     }
1333 
1334     @Test
1335     void ignoreComments(TestInfo testInfo) throws IOException {
1336         try (var credentials = new HostCredentials(testInfo);
1337              var tempFolder = new TemporaryDirectory();
1338              var archiveFolder = new TemporaryDirectory();
1339              var listServer = new TestMailmanServer();
1340              var webrevServer = new TestWebrevServer()) {
1341             var author = credentials.getHostedRepository();
1342             var ignored = credentials.getHostedRepository();
1343             var archive = credentials.getHostedRepository();
1344             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
1345             var censusBuilder = credentials.getCensusBuilder()
1346                                            .addAuthor(author.forge().currentUser().id());
1347             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
1348             var mlBot = MailingListBridgeBot.newBuilder()
1349                                             .from(from)
1350                                             .repo(author)
1351                                             .archive(archive)
1352                                             .censusRepo(censusBuilder.build())
1353                                             .list(listAddress)
1354                                             .ignoredUsers(Set.of(ignored.forge().currentUser().userName()))
1355                                             .ignoredComments(Set.of(Pattern.compile(&quot;ignore this comment&quot;, Pattern.MULTILINE | Pattern.DOTALL)))
1356                                             .listArchive(listServer.getArchive())
1357                                             .smtpServer(listServer.getSMTP())
1358                                             .webrevStorageRepository(archive)
1359                                             .webrevStorageRef(&quot;webrev&quot;)
1360                                             .webrevStorageBase(Path.of(&quot;test&quot;))
1361                                             .webrevStorageBaseUri(webrevServer.uri())
1362                                             .issueTracker(URIBuilder.base(&quot;http://issues.test/browse/&quot;).build())
1363                                             .build();
1364 
1365             // Populate the projects repository
1366             var reviewFile = Path.of(&quot;reviewfile.txt&quot;);
1367             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType(), reviewFile);
1368             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
1369             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
1370             localRepo.push(masterHash, archive.url(), &quot;webrev&quot;, true);
1371 
1372             // Make a change with a corresponding PR
1373             var editHash = CheckableRepository.appendAndCommit(localRepo);
1374             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
1375             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
1376             pr.setBody(&quot;This is now ready&quot;);
1377 
1378             // Make a bunch of comments
1379             pr.addComment(&quot;Plain comment&quot;);
1380             pr.addComment(&quot;ignore this comment&quot;);
1381             pr.addComment(&quot;I think it is time to\nignore this comment!&quot;);
1382             pr.addReviewComment(masterHash, editHash, reviewFile.toString(), 2, &quot;Review ignore this comment&quot;);
1383 
1384             var ignoredPR = ignored.pullRequest(pr.id());
1385             ignoredPR.addComment(&quot;Don&#39;t mind me&quot;);
1386 
1387             TestBotRunner.runPeriodicItems(mlBot);
1388             TestBotRunner.runPeriodicItems(mlBot);
1389 
1390             // The archive should not contain the ignored comments
1391             Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);
1392             assertTrue(archiveContains(archiveFolder.path(), &quot;This is now ready&quot;));
1393             assertFalse(archiveContains(archiveFolder.path(), &quot;ignore this comment&quot;));
1394             assertFalse(archiveContains(archiveFolder.path(), &quot;it is time to&quot;));
1395             assertFalse(archiveContains(archiveFolder.path(), &quot;Don&#39;t mind me&quot;));
1396             assertFalse(archiveContains(archiveFolder.path(), &quot;Review ignore&quot;));
1397         }
1398     }
1399 
1400     @Test
1401     void replyToEmptyReview(TestInfo testInfo) throws IOException {
1402         try (var credentials = new HostCredentials(testInfo);
1403              var tempFolder = new TemporaryDirectory();
1404              var archiveFolder = new TemporaryDirectory();
1405              var listServer = new TestMailmanServer();
1406              var webrevServer = new TestWebrevServer()) {
1407             var author = credentials.getHostedRepository();
1408             var reviewer = credentials.getHostedRepository();
1409             var archive = credentials.getHostedRepository();
1410             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
1411             var censusBuilder = credentials.getCensusBuilder()
1412                                            .addReviewer(reviewer.forge().currentUser().id())
1413                                            .addAuthor(author.forge().currentUser().id());
1414             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
1415             var mlBot = MailingListBridgeBot.newBuilder()
1416                                             .from(from)
1417                                             .repo(author)
1418                                             .archive(archive)
1419                                             .censusRepo(censusBuilder.build())
1420                                             .list(listAddress)
1421                                             .listArchive(listServer.getArchive())
1422                                             .smtpServer(listServer.getSMTP())
1423                                             .webrevStorageRepository(archive)
1424                                             .webrevStorageRef(&quot;webrev&quot;)
1425                                             .webrevStorageBase(Path.of(&quot;test&quot;))
1426                                             .webrevStorageBaseUri(webrevServer.uri())
1427                                             .issueTracker(URIBuilder.base(&quot;http://issues.test/browse/&quot;).build())
1428                                             .build();
1429 
1430             // Populate the projects repository
1431             var reviewFile = Path.of(&quot;reviewfile.txt&quot;);
1432             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType(), reviewFile);
1433             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
1434             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
1435             localRepo.push(masterHash, archive.url(), &quot;webrev&quot;, true);
1436 
1437             // Make a change with a corresponding PR
1438             var editHash = CheckableRepository.appendAndCommit(localRepo);
1439             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
1440             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
1441             pr.setBody(&quot;This is now ready&quot;);
1442             TestBotRunner.runPeriodicItems(mlBot);
1443             listServer.processIncoming();
1444 
1445             // Make an empty approval
1446             var reviewPr = reviewer.pullRequest(pr.id());
1447             reviewPr.addReview(Review.Verdict.APPROVED, &quot;&quot;);
1448             TestBotRunner.runPeriodicItems(mlBot);
1449             listServer.processIncoming();
1450 
1451             pr.addComment(&quot;Thanks for the review!&quot;);
1452             TestBotRunner.runPeriodicItems(mlBot);
1453             listServer.processIncoming();
1454 
1455             // The approval text should be included in the quote
1456             Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);
1457             assertEquals(1, archiveContainsCount(archiveFolder.path(), &quot;^&gt; Marked as reviewed&quot;));
1458         }
1459     }
1460 
1461     @Test
1462     void cooldown(TestInfo testInfo) throws IOException {
1463         try (var credentials = new HostCredentials(testInfo);
1464              var tempFolder = new TemporaryDirectory();
1465              var archiveFolder = new TemporaryDirectory();
1466              var listServer = new TestMailmanServer();
1467              var webrevServer = new TestWebrevServer()) {
1468             var bot = credentials.getHostedRepository();
1469             var author = credentials.getHostedRepository();
1470             var archive = credentials.getHostedRepository();
1471             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
1472             var censusBuilder = credentials.getCensusBuilder()
1473                                            .addAuthor(author.forge().currentUser().id());
1474             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
1475             var mlBotBuilder = MailingListBridgeBot.newBuilder()
1476                                                    .from(from)
1477                                                    .repo(bot)
1478                                                    .ignoredUsers(Set.of(bot.forge().currentUser().userName()))
1479                                                    .archive(archive)
1480                                                    .censusRepo(censusBuilder.build())
1481                                                    .list(listAddress)
1482                                                    .listArchive(listServer.getArchive())
1483                                                    .smtpServer(listServer.getSMTP())
1484                                                    .webrevStorageRepository(archive)
1485                                                    .webrevStorageRef(&quot;webrev&quot;)
1486                                                    .webrevStorageBase(Path.of(&quot;test&quot;))
1487                                                    .webrevStorageBaseUri(webrevServer.uri())
1488                                                    .issueTracker(URIBuilder.base(&quot;http://issues.test/browse/&quot;).build());
1489 
1490             // Populate the projects repository
1491             var reviewFile = Path.of(&quot;reviewfile.txt&quot;);
1492             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType(), reviewFile);
1493             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
1494             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
1495             localRepo.push(masterHash, archive.url(), &quot;webrev&quot;, true);
1496 
1497             // Make a change with a corresponding PR
1498             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;Line 1\nLine 2\nLine 3\nLine 4&quot;);
1499             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
1500             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
1501             pr.setBody(&quot;This is now ready&quot;);
1502 
1503             var mlBot = mlBotBuilder.build();
1504             var mlBotWithCooldown = mlBotBuilder.cooldown(Duration.ofDays(1)).build();
1505 
1506             TestBotRunner.runPeriodicItems(mlBot);
1507             listServer.processIncoming();
1508 
1509             // Make a comment
1510             pr.addComment(&quot;Looks good&quot;);
1511 
1512             // Bot with cooldown configured should not bridge the comment
1513             TestBotRunner.runPeriodicItems(mlBotWithCooldown);
1514             assertThrows(RuntimeException.class, () -&gt; listServer.processIncoming(Duration.ofMillis(1)));
1515 
1516             // But without, it should
1517             TestBotRunner.runPeriodicItems(mlBot);
1518             listServer.processIncoming();
1519 
1520             // Check the archive
1521             Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);
1522             assertTrue(archiveContains(archiveFolder.path(), &quot;Looks good&quot;));
1523         }
1524     }
1525 }
<a name="8" id="anc8"></a><b style="font-size: large; color: red">--- EOF ---</b>
















































































</pre>
<input id="eof" value="8" type="hidden" />
</body>
</html>