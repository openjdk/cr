<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Old bots/mlbridge/src/test/java/org/openjdk/skara/bots/mlbridge/MailingListBridgeBotTests.java</title>
    <link rel="stylesheet" href="../../../../../../../../../../style.css" />
  </head>
  <body>
    <pre>
   1 /*
   2  * Copyright (c) 2019, Oracle and/or its affiliates. All rights reserved.
   3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   4  *
   5  * This code is free software; you can redistribute it and/or modify it
   6  * under the terms of the GNU General Public License version 2 only, as
   7  * published by the Free Software Foundation.
   8  *
   9  * This code is distributed in the hope that it will be useful, but WITHOUT
  10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
  11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
  12  * version 2 for more details (a copy is included in the LICENSE file that
  13  * accompanied this code).
  14  *
  15  * You should have received a copy of the GNU General Public License version
  16  * 2 along with this work; if not, write to the Free Software Foundation,
  17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
  18  *
  19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
  20  * or visit www.oracle.com if you need additional information or have any
  21  * questions.
  22  */
  23 package org.openjdk.skara.bots.mlbridge;
  24 
  25 import org.openjdk.skara.email.EmailAddress;
  26 import org.openjdk.skara.forge.*;
  27 import org.openjdk.skara.issuetracker.Issue;
  28 import org.openjdk.skara.network.URIBuilder;
  29 import org.openjdk.skara.mailinglist.MailingListServerFactory;
  30 import org.openjdk.skara.test.*;
  31 import org.openjdk.skara.vcs.Repository;
  32 
  33 import org.junit.jupiter.api.*;
  34 
  35 import java.io.IOException;
  36 import java.nio.charset.StandardCharsets;
  37 import java.nio.file.*;
  38 import java.time.*;
  39 import java.util.*;
  40 import java.util.logging.Logger;
  41 import java.util.regex.Pattern;
  42 import java.util.stream.Collectors;
  43 
  44 import static org.junit.jupiter.api.Assertions.*;
  45 
  46 class MailingListBridgeBotTests {
  47     private final Logger log = Logger.getLogger(&quot;org.openjdk.skara.bots.mlbridge.test&quot;);
  48 
  49     private Optional&lt;String&gt; archiveContents(Path archive) {
  50         try {
  51             var mbox = Files.find(archive, 50, (path, attrs) -&gt; path.toString().endsWith(&quot;.mbox&quot;)).findAny();
  52             if (mbox.isEmpty()) {
  53                 return Optional.empty();
  54             }
  55             return Optional.of(Files.readString(mbox.get(), StandardCharsets.UTF_8));
  56         } catch (IOException e) {
  57             return Optional.empty();
  58         }
  59 
  60     }
  61 
  62     private boolean archiveContains(Path archive, String text) {
  63         return archiveContainsCount(archive, text) &gt; 0;
  64     }
  65 
  66     private int archiveContainsCount(Path archive, String text) {
  67         var lines = archiveContents(archive);
  68         if (lines.isEmpty()) {
  69             return 0;
  70         }
  71         var pattern = Pattern.compile(text);
  72         int count = 0;
  73         for (var line : lines.get().split(&quot;\\R&quot;)) {
  74             var matcher = pattern.matcher(line);
  75             if (matcher.find()) {
  76                 count++;
  77             }
  78         }
  79         return count;
  80     }
  81 
  82     private boolean webrevContains(Path webrev, String text) {
  83         try {
  84             var index = Files.find(webrev, 5, (path, attrs) -&gt; path.toString().endsWith(&quot;index.html&quot;)).findAny();
  85             if (index.isEmpty()) {
  86                 return false;
  87             }
  88             var lines = Files.readString(index.get(), StandardCharsets.UTF_8);
  89             return lines.contains(text);
  90         } catch (IOException e) {
  91             return false;
  92         }
  93     }
  94 
  95     private long countSubstrings(String string, String substring) {
  96         return Pattern.compile(substring).matcher(string).results().count();
  97     }
  98 
  99     private String noreplyAddress(HostedRepository repository) {
 100         return &quot;test+&quot; + repository.forge().currentUser().id() + &quot;+&quot; +
 101                 repository.forge().currentUser().userName() +
 102                 &quot;@openjdk.java.net&quot;;
 103     }
 104 
 105     @Test
 106     void simpleArchive(TestInfo testInfo) throws IOException {
 107         try (var credentials = new HostCredentials(testInfo);
 108              var tempFolder = new TemporaryDirectory();
 109              var archiveFolder = new TemporaryDirectory();
 110              var webrevFolder = new TemporaryDirectory();
 111              var listServer = new TestMailmanServer();
 112              var webrevServer = new TestWebrevServer()) {
 113             var author = credentials.getHostedRepository();
 114             var archive = credentials.getHostedRepository();
 115             var ignored = credentials.getHostedRepository();
 116             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
 117             var censusBuilder = credentials.getCensusBuilder()
 118                                            .addAuthor(author.forge().currentUser().id());
 119             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
 120             var mlBot = MailingListBridgeBot.newBuilder()
 121                                             .from(from)
 122                                             .repo(author)
 123                                             .archive(archive)
 124                                             .censusRepo(censusBuilder.build())
 125                                             .list(listAddress)
 126                                             .ignoredUsers(Set.of(ignored.forge().currentUser().userName()))
 127                                             .ignoredComments(Set.of())
 128                                             .listArchive(listServer.getArchive())
 129                                             .smtpServer(listServer.getSMTP())
 130                                             .webrevStorageRepository(archive)
 131                                             .webrevStorageRef(&quot;webrev&quot;)
 132                                             .webrevStorageBase(Path.of(&quot;test&quot;))
 133                                             .webrevStorageBaseUri(webrevServer.uri())
 134                                             .readyLabels(Set.of(&quot;rfr&quot;))
 135                                             .readyComments(Map.of(ignored.forge().currentUser().userName(), Pattern.compile(&quot;ready&quot;)))
 136                                             .issueTracker(URIBuilder.base(&quot;http://issues.test/browse/&quot;).build())
 137                                             .headers(Map.of(&quot;Extra1&quot;, &quot;val1&quot;, &quot;Extra2&quot;, &quot;val2&quot;))
 138                                             .sendInterval(Duration.ZERO)
 139                                             .build();
 140 
 141             // Populate the projects repository
 142             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType());
 143             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
 144             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
 145             localRepo.push(masterHash, archive.url(), &quot;webrev&quot;, true);
 146 
 147             // Make a change with a corresponding PR
 148             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;A simple change&quot;,
 149                                                                &quot;Change msg\n\nWith several lines&quot;);
 150             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
 151             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;1234: This is a pull request&quot;);
 152             pr.setBody(&quot;This should not be ready&quot;);
 153 
 154             // Run an archive pass
 155             TestBotRunner.runPeriodicItems(mlBot);
 156 
 157             // A PR that isn&#39;t ready for review should not be archived
 158             Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);
 159             assertFalse(archiveContains(archiveFolder.path(), &quot;This is a pull request&quot;));
 160 
 161             // Flag it as ready for review
 162             pr.setBody(&quot;This should now be ready&quot;);
 163             pr.addLabel(&quot;rfr&quot;);
 164 
 165             // Run another archive pass
 166             TestBotRunner.runPeriodicItems(mlBot);
 167 
 168             // But it should still not be archived
 169             Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);
 170             assertFalse(archiveContains(archiveFolder.path(), &quot;This is a pull request&quot;));
 171 
 172             // Now post a general comment - not a ready marker
 173             var ignoredPr = ignored.pullRequest(pr.id());
 174             ignoredPr.addComment(&quot;hello there&quot;);
 175 
 176             // Run another archive pass
 177             TestBotRunner.runPeriodicItems(mlBot);
 178 
 179             // It should still not be archived
 180             Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);
 181             assertFalse(archiveContains(archiveFolder.path(), &quot;This is a pull request&quot;));
 182 
 183             // Now post a ready comment
 184             ignoredPr.addComment(&quot;ready&quot;);
 185 
 186             // Run another archive pass
 187             TestBotRunner.runPeriodicItems(mlBot);
 188 
 189             // The archive should now contain an entry
 190             Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);
 191             assertTrue(archiveContains(archiveFolder.path(), &quot;This is a pull request&quot;));
 192             assertTrue(archiveContains(archiveFolder.path(), &quot;This should now be ready&quot;));
 193             assertTrue(archiveContains(archiveFolder.path(), &quot;Patch:&quot;));
 194             assertTrue(archiveContains(archiveFolder.path(), &quot;Changes:&quot;));
 195             assertTrue(archiveContains(archiveFolder.path(), &quot;Webrev:&quot;));
 196             assertTrue(archiveContains(archiveFolder.path(), webrevServer.uri().toString()));
 197             assertTrue(archiveContains(archiveFolder.path(), &quot;webrev.00&quot;));
 198             assertTrue(archiveContains(archiveFolder.path(), &quot;Issue:&quot;));
 199             assertTrue(archiveContains(archiveFolder.path(), &quot;http://issues.test/browse/TSTPRJ-1234&quot;));
 200             assertTrue(archiveContains(archiveFolder.path(), &quot;Fetch:&quot;));
 201             assertTrue(archiveContains(archiveFolder.path(), &quot;^ - Change msg&quot;));
 202             assertFalse(archiveContains(archiveFolder.path(), &quot;With several lines&quot;));
 203 
 204             // The mailing list as well
 205             listServer.processIncoming();
 206             var mailmanServer = MailingListServerFactory.createMailmanServer(listServer.getArchive(), listServer.getSMTP(), Duration.ZERO);
 207             var mailmanList = mailmanServer.getList(listAddress.address());
 208             var conversations = mailmanList.conversations(Duration.ofDays(1));
 209             assertEquals(1, conversations.size());
 210             var mail = conversations.get(0).first();
 211             assertEquals(&quot;RFR: 1234: This is a pull request&quot;, mail.subject());
 212             assertEquals(pr.author().fullName(), mail.author().fullName().orElseThrow());
 213             assertEquals(noreplyAddress(archive), mail.author().address());
 214             assertEquals(listAddress, mail.sender());
 215             assertEquals(&quot;val1&quot;, mail.headerValue(&quot;Extra1&quot;));
 216             assertEquals(&quot;val2&quot;, mail.headerValue(&quot;Extra2&quot;));
 217 
 218             // And there should be a webrev
 219             Repository.materialize(webrevFolder.path(), archive.url(), &quot;webrev&quot;);
 220             assertTrue(webrevContains(webrevFolder.path(), &quot;1 lines changed&quot;));
 221             var comments = pr.comments();
 222             var webrevComments = comments.stream()
 223                                          .filter(comment -&gt; comment.author().equals(author.forge().currentUser()))
 224                                          .filter(comment -&gt; comment.body().contains(&quot;webrev&quot;))
 225                                          .filter(comment -&gt; comment.body().contains(editHash.hex()))
 226                                          .collect(Collectors.toList());
 227             assertEquals(1, webrevComments.size());
 228 
 229             // Add a comment
 230             pr.addComment(&quot;This is a comment :smile:&quot;);
 231 
 232             // Add a comment from an ignored user as well
 233             ignoredPr.addComment(&quot;Don&#39;t mind me&quot;);
 234 
 235             // Run another archive pass
 236             TestBotRunner.runPeriodicItems(mlBot);
 237 
 238             // The archive should now contain the comment, but not the ignored one
 239             Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);
 240             assertTrue(archiveContains(archiveFolder.path(), &quot;This is a comment&quot;));
 241             assertTrue(archiveContains(archiveFolder.path(), &quot;&gt; This should now be ready&quot;));
 242             assertFalse(archiveContains(archiveFolder.path(), &quot;Don&#39;t mind me&quot;));
 243 
 244             listServer.processIncoming();
 245             conversations = mailmanList.conversations(Duration.ofDays(1));
 246             assertEquals(1, conversations.size());
 247             assertEquals(2, conversations.get(0).allMessages().size());
 248 
 249             // Remove the rfr flag and post another comment
 250             pr.addLabel(&quot;rfr&quot;);
 251             pr.addComment(&quot;This is another comment&quot;);
 252 
 253             // Run another archive pass
 254             TestBotRunner.runPeriodicItems(mlBot);
 255 
 256             // The archive should contain the additional comment
 257             Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);
 258             assertTrue(archiveContains(archiveFolder.path(), &quot;This is another comment&quot;));
 259             assertTrue(archiveContains(archiveFolder.path(), &quot;&gt;&gt; This should now be ready&quot;));
 260 
 261             listServer.processIncoming();
 262             conversations = mailmanList.conversations(Duration.ofDays(1));
 263             assertEquals(1, conversations.size());
 264             assertEquals(3, conversations.get(0).allMessages().size());
 265             for (var newMail : conversations.get(0).allMessages()) {
 266                 assertEquals(noreplyAddress(archive), newMail.author().address());
 267                 assertEquals(listAddress, newMail.sender());
 268             }
 269             assertTrue(conversations.get(0).allMessages().get(2).body().contains(&quot;This is a comment ðŸ˜„&quot;));
 270         }
 271     }
 272 
 273     @Test
 274     void archiveIntegrated(TestInfo testInfo) throws IOException {
 275         try (var credentials = new HostCredentials(testInfo);
 276              var tempFolder = new TemporaryDirectory();
 277              var archiveFolder = new TemporaryDirectory();
 278              var webrevFolder = new TemporaryDirectory();
 279              var listServer = new TestMailmanServer();
 280              var webrevServer = new TestWebrevServer()) {
 281             var author = credentials.getHostedRepository();
 282             var archive = credentials.getHostedRepository();
 283             var ignored = credentials.getHostedRepository();
 284             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
 285             var censusBuilder = credentials.getCensusBuilder()
 286                                            .addAuthor(author.forge().currentUser().id());
 287             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
 288             var mlBot = MailingListBridgeBot.newBuilder()
 289                                             .from(from)
 290                                             .repo(author)
 291                                             .archive(archive)
 292                                             .censusRepo(censusBuilder.build())
 293                                             .list(listAddress)
 294                                             .ignoredUsers(Set.of(ignored.forge().currentUser().userName()))
 295                                             .listArchive(listServer.getArchive())
 296                                             .smtpServer(listServer.getSMTP())
 297                                             .webrevStorageRepository(archive)
 298                                             .webrevStorageRef(&quot;webrev&quot;)
 299                                             .webrevStorageBase(Path.of(&quot;test&quot;))
 300                                             .webrevStorageBaseUri(webrevServer.uri())
 301                                             .issueTracker(URIBuilder.base(&quot;http://issues.test/browse/&quot;).build())
 302                                             .build();
 303 
 304             // Populate the projects repository
 305             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType());
 306             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
 307             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
 308             localRepo.push(masterHash, archive.url(), &quot;webrev&quot;, true);
 309 
 310             // Make a change with a corresponding PR
 311             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;A simple change&quot;,
 312                                                                &quot;Change msg\n\nWith several lines&quot;);
 313             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
 314             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;1234: This is a pull request&quot;);
 315             pr.setBody(&quot;This is now ready&quot;);
 316             pr.addLabel(&quot;rfr&quot;);
 317 
 318             // Run an archive pass
 319             TestBotRunner.runPeriodicItems(mlBot);
 320             TestBotRunner.runPeriodicItems(mlBot);
 321 
 322             // There should be an RFR thread
 323             Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);
 324             assertTrue(archiveContains(archiveFolder.path(), &quot;Subject: RFR: 1234: This is a pull request&quot;));
 325 
 326             // Now it has been integrated
 327             var ignoredPr = ignored.pullRequest(pr.id());
 328             ignoredPr.setBody(&quot;This has been integrated&quot;);
 329             ignoredPr.addLabel(&quot;integrated&quot;);
 330             ignoredPr.addComment(&quot;Pushed as commit &quot; + editHash + &quot;.&quot;);
 331             ignoredPr.setState(Issue.State.CLOSED);
 332 
 333             // Run another archive pass
 334             TestBotRunner.runPeriodicItems(mlBot);
 335 
 336             // The archive should now contain another entry
 337             Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);
 338             assertTrue(archiveContains(archiveFolder.path(), &quot;Subject: Re: \\[Integrated\\] RFR: 1234: This is a pull request&quot;));
 339             assertFalse(archiveContains(archiveFolder.path(), &quot;\\[Closed\\]&quot;));
 340         }
 341     }
 342 
 343     @Test
 344     void archiveLegacyIntegrated(TestInfo testInfo) throws IOException {
 345         try (var credentials = new HostCredentials(testInfo);
 346              var tempFolder = new TemporaryDirectory();
 347              var archiveFolder = new TemporaryDirectory();
 348              var webrevFolder = new TemporaryDirectory();
 349              var listServer = new TestMailmanServer();
 350              var webrevServer = new TestWebrevServer()) {
 351             var author = credentials.getHostedRepository();
 352             var archive = credentials.getHostedRepository();
 353             var ignored = credentials.getHostedRepository();
 354             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
 355             var censusBuilder = credentials.getCensusBuilder()
 356                     .addAuthor(author.forge().currentUser().id());
 357             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
 358             var mlBot = MailingListBridgeBot.newBuilder()
 359                     .from(from)
 360                     .repo(author)
 361                     .archive(archive)
 362                     .censusRepo(censusBuilder.build())
 363                     .list(listAddress)
 364                     .ignoredUsers(Set.of(ignored.forge().currentUser().userName()))
 365                     .listArchive(listServer.getArchive())
 366                     .smtpServer(listServer.getSMTP())
 367                     .webrevStorageRepository(archive)
 368                     .webrevStorageRef(&quot;webrev&quot;)
 369                     .webrevStorageBase(Path.of(&quot;test&quot;))
 370                     .webrevStorageBaseUri(webrevServer.uri())
 371                     .issueTracker(URIBuilder.base(&quot;http://issues.test/browse/&quot;).build())
 372                     .build();
 373 
 374             // Populate the projects repository
 375             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType());
 376             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
 377             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
 378             localRepo.push(masterHash, archive.url(), &quot;webrev&quot;, true);
 379 
 380             // Make a change with a corresponding PR with a date in the past
 381             var editFile = tempFolder.path().resolve(&quot;change.txt&quot;);
 382             Files.writeString(editFile, &quot;A simple change&quot;);
 383             localRepo.add(editFile);
 384             var commitDate = ZonedDateTime.of(2020, 3, 12, 0, 0, 0, 0, ZoneId.of(&quot;UTC&quot;));
 385             var editHash = localRepo.commit(&quot;An old change&quot;, &quot;duke&quot;, &quot;duke@openjdk.org&quot;, commitDate,
 386                              &quot;duke&quot;, &quot;duke@openjdk.org&quot;, commitDate);
 387             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
 388             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;1234: This is a pull request&quot;);
 389             pr.setBody(&quot;This is now ready&quot;);
 390             pr.addLabel(&quot;rfr&quot;);
 391 
 392             // Run an archive pass
 393             TestBotRunner.runPeriodicItems(mlBot);
 394             TestBotRunner.runPeriodicItems(mlBot);
 395 
 396             // There should be an RFR thread
 397             Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);
 398             assertTrue(archiveContains(archiveFolder.path(), &quot;Subject: RFR: 1234: This is a pull request&quot;));
 399 
 400             // Now it has been integrated
 401             var ignoredPr = ignored.pullRequest(pr.id());
 402             ignoredPr.setBody(&quot;This has been integrated&quot;);
 403             ignoredPr.addLabel(&quot;integrated&quot;);
 404             ignoredPr.addComment(&quot;Pushed as commit &quot; + editHash + &quot;.&quot;);
 405             ignoredPr.setState(Issue.State.CLOSED);
 406 
 407             // Run another archive pass
 408             TestBotRunner.runPeriodicItems(mlBot);
 409 
 410             // The archive should not contain another entry
 411             Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);
 412             assertFalse(archiveContains(archiveFolder.path(), &quot;\\[Integrated\\]&quot;));
 413             assertFalse(archiveContains(archiveFolder.path(), &quot;\\[Closed\\]&quot;));
 414         }
 415     }
 416 
 417     @Test
 418     void archiveDirectToIntegrated(TestInfo testInfo) throws IOException {
 419         try (var credentials = new HostCredentials(testInfo);
 420              var tempFolder = new TemporaryDirectory();
 421              var archiveFolder = new TemporaryDirectory();
 422              var webrevFolder = new TemporaryDirectory();
 423              var listServer = new TestMailmanServer();
 424              var webrevServer = new TestWebrevServer()) {
 425             var author = credentials.getHostedRepository();
 426             var archive = credentials.getHostedRepository();
 427             var ignored = credentials.getHostedRepository();
 428             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
 429             var censusBuilder = credentials.getCensusBuilder()
 430                                            .addAuthor(author.forge().currentUser().id());
 431             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
 432             var mlBot = MailingListBridgeBot.newBuilder()
 433                                             .from(from)
 434                                             .repo(author)
 435                                             .archive(archive)
 436                                             .censusRepo(censusBuilder.build())
 437                                             .list(listAddress)
 438                                             .ignoredUsers(Set.of(ignored.forge().currentUser().userName()))
 439                                             .listArchive(listServer.getArchive())
 440                                             .smtpServer(listServer.getSMTP())
 441                                             .webrevStorageRepository(archive)
 442                                             .webrevStorageRef(&quot;webrev&quot;)
 443                                             .webrevStorageBase(Path.of(&quot;test&quot;))
 444                                             .webrevStorageBaseUri(webrevServer.uri())
 445                                             .issueTracker(URIBuilder.base(&quot;http://issues.test/browse/&quot;).build())
 446                                             .build();
 447 
 448             // Populate the projects repository
 449             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType());
 450             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
 451             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
 452             localRepo.push(masterHash, archive.url(), &quot;webrev&quot;, true);
 453 
 454             // Make a change with a corresponding PR
 455             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;A simple change&quot;,
 456                                                                &quot;Change msg\n\nWith several lines&quot;);
 457             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
 458             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;1234: This is a pull request&quot;);
 459             pr.setBody(&quot;This should not be ready&quot;);
 460             pr.setState(Issue.State.CLOSED);
 461 
 462             // Run an archive pass
 463             TestBotRunner.runPeriodicItems(mlBot);
 464             TestBotRunner.runPeriodicItems(mlBot);
 465 
 466             // A PR that isn&#39;t ready for review should not be archived
 467             Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);
 468             assertFalse(archiveContains(archiveFolder.path(), &quot;This is a pull request&quot;));
 469 
 470             // Now it has been integrated
 471             var ignoredPr = ignored.pullRequest(pr.id());
 472             ignoredPr.setBody(&quot;This has already been integrated&quot;);
 473             ignoredPr.addLabel(&quot;integrated&quot;);
 474             ignoredPr.addComment(&quot;Pushed as commit &quot; + editHash + &quot;.&quot;);
 475 
 476             // Run another archive pass
 477             TestBotRunner.runPeriodicItems(mlBot);
 478 
 479             // The archive should now contain an entry
 480             Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);
 481             assertTrue(archiveContains(archiveFolder.path(), &quot;Subject: FYI: 1234: This is a pull request&quot;));
 482 
 483             var updatedHash = CheckableRepository.appendAndCommit(localRepo, &quot;Another change&quot;);
 484             localRepo.push(updatedHash, author.url(), &quot;edit&quot;);
 485 
 486             // Run another archive pass
 487             TestBotRunner.runPeriodicItems(mlBot);
 488 
 489             // The archive should now contain another entry
 490             Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);
 491             assertTrue(archiveContains(archiveFolder.path(), &quot;Subject: Re: \\[Rev 01\\] FYI: 1234: This is a pull request&quot;));
 492             assertFalse(archiveContains(archiveFolder.path(), &quot;\\[Closed\\]&quot;));
 493         }
 494     }
 495 
 496     @Test
 497     void archiveIntegratedRetainPrefix(TestInfo testInfo) throws IOException {
 498         try (var credentials = new HostCredentials(testInfo);
 499              var tempFolder = new TemporaryDirectory();
 500              var archiveFolder = new TemporaryDirectory();
 501              var webrevFolder = new TemporaryDirectory();
 502              var listServer = new TestMailmanServer();
 503              var webrevServer = new TestWebrevServer()) {
 504             var author = credentials.getHostedRepository();
 505             var archive = credentials.getHostedRepository();
 506             var ignored = credentials.getHostedRepository();
 507             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
 508             var censusBuilder = credentials.getCensusBuilder()
 509                                            .addAuthor(author.forge().currentUser().id());
 510             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
 511             var mlBot = MailingListBridgeBot.newBuilder()
 512                                             .from(from)
 513                                             .repo(author)
 514                                             .archive(archive)
 515                                             .censusRepo(censusBuilder.build())
 516                                             .list(listAddress)
 517                                             .ignoredUsers(Set.of(ignored.forge().currentUser().userName()))
 518                                             .listArchive(listServer.getArchive())
 519                                             .smtpServer(listServer.getSMTP())
 520                                             .webrevStorageRepository(archive)
 521                                             .webrevStorageRef(&quot;webrev&quot;)
 522                                             .webrevStorageBase(Path.of(&quot;test&quot;))
 523                                             .webrevStorageBaseUri(webrevServer.uri())
 524                                             .readyLabels(Set.of(&quot;rfr&quot;))
 525                                             .issueTracker(URIBuilder.base(&quot;http://issues.test/browse/&quot;).build())
 526                                             .build();
 527 
 528             // Populate the projects repository
 529             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType());
 530             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
 531             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
 532             localRepo.push(masterHash, archive.url(), &quot;webrev&quot;, true);
 533 
 534             // Make a change with a corresponding PR
 535             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;A simple change&quot;,
 536                                                                &quot;Change msg\n\nWith several lines&quot;);
 537             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
 538             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;1234: This is a pull request&quot;);
 539             pr.setBody(&quot;This should be ready&quot;);
 540 
 541             // Run an archive pass
 542             TestBotRunner.runPeriodicItems(mlBot);
 543             TestBotRunner.runPeriodicItems(mlBot);
 544 
 545             // A PR that isn&#39;t ready for review should not be archived
 546             Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);
 547             assertFalse(archiveContains(archiveFolder.path(), &quot;This is a pull request&quot;));
 548 
 549             // Flag it as ready for review
 550             pr.addLabel(&quot;rfr&quot;);
 551 
 552             // Run another archive pass
 553             TestBotRunner.runPeriodicItems(mlBot);
 554 
 555             // The archive should now contain an entry
 556             Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);
 557             assertTrue(archiveContains(archiveFolder.path(), &quot;Subject: RFR: 1234: This is a pull request&quot;));
 558 
 559             // Close it and then push another change
 560             pr.setState(Issue.State.CLOSED);
 561             var updatedHash = CheckableRepository.appendAndCommit(localRepo, &quot;Another change&quot;);
 562             localRepo.push(updatedHash, author.url(), &quot;edit&quot;);
 563 
 564             // Run another archive pass
 565             TestBotRunner.runPeriodicItems(mlBot);
 566 
 567             // The archive should now contain another entry - should retain the RFR thread prefix
 568             Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);
 569             assertTrue(archiveContains(archiveFolder.path(), &quot;Subject: Re: \\[Rev 01\\] RFR: 1234: This is a pull request&quot;));
 570         }
 571     }
 572 
 573     @Test
 574     void archiveClosed(TestInfo testInfo) throws IOException {
 575         try (var credentials = new HostCredentials(testInfo);
 576              var tempFolder = new TemporaryDirectory();
 577              var archiveFolder = new TemporaryDirectory();
 578              var webrevFolder = new TemporaryDirectory();
 579              var listServer = new TestMailmanServer();
 580              var webrevServer = new TestWebrevServer()) {
 581             var author = credentials.getHostedRepository();
 582             var archive = credentials.getHostedRepository();
 583             var ignored = credentials.getHostedRepository();
 584             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
 585             var censusBuilder = credentials.getCensusBuilder()
 586                                            .addAuthor(author.forge().currentUser().id());
 587             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
 588             var mlBot = MailingListBridgeBot.newBuilder()
 589                                             .from(from)
 590                                             .repo(author)
 591                                             .archive(archive)
 592                                             .censusRepo(censusBuilder.build())
 593                                             .list(listAddress)
 594                                             .ignoredUsers(Set.of(ignored.forge().currentUser().userName()))
 595                                             .listArchive(listServer.getArchive())
 596                                             .smtpServer(listServer.getSMTP())
 597                                             .webrevStorageRepository(archive)
 598                                             .webrevStorageRef(&quot;webrev&quot;)
 599                                             .webrevStorageBase(Path.of(&quot;test&quot;))
 600                                             .webrevStorageBaseUri(webrevServer.uri())
 601                                             .readyLabels(Set.of(&quot;rfr&quot;))
 602                                             .issueTracker(URIBuilder.base(&quot;http://issues.test/browse/&quot;).build())
 603                                             .build();
 604 
 605             // Populate the projects repository
 606             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType());
 607             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
 608             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
 609             localRepo.push(masterHash, archive.url(), &quot;webrev&quot;, true);
 610 
 611             // Make a change with a corresponding PR
 612             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;A simple change&quot;,
 613                                                                &quot;Change msg\n\nWith several lines&quot;);
 614             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
 615             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;1234: This is a pull request&quot;);
 616             pr.setBody(&quot;This should be ready&quot;);
 617 
 618             // Run an archive pass
 619             TestBotRunner.runPeriodicItems(mlBot);
 620             TestBotRunner.runPeriodicItems(mlBot);
 621 
 622             // A PR that isn&#39;t ready for review should not be archived
 623             Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);
 624             assertFalse(archiveContains(archiveFolder.path(), &quot;This is a pull request&quot;));
 625 
 626             // Flag it as ready for review
 627             pr.addLabel(&quot;rfr&quot;);
 628 
 629             // Run another archive pass
 630             TestBotRunner.runPeriodicItems(mlBot);
 631 
 632             // The archive should now contain an entry
 633             Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);
 634             assertTrue(archiveContains(archiveFolder.path(), &quot;Subject: RFR: 1234: This is a pull request&quot;));
 635 
 636             // Close it
 637             pr.setState(Issue.State.CLOSED);
 638 
 639             // Run another archive pass
 640             TestBotRunner.runPeriodicItems(mlBot);
 641 
 642             // The archive should now contain another entry - should say that it is closed
 643             Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);
 644             assertEquals(1, archiveContainsCount(archiveFolder.path(), &quot;Subject: Re: \\[Closed\\] RFR: 1234: This is a pull request&quot;));
 645 
 646             pr.addComment(&quot;Fair enough&quot;);
 647 
 648             // Run another archive pass - only a single close notice should have been posted
 649             TestBotRunner.runPeriodicItems(mlBot);
 650             Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);
 651             assertEquals(1, archiveContainsCount(archiveFolder.path(), &quot;Subject: Re: \\[Closed\\] RFR: 1234: This is a pull request&quot;));
 652         }
 653     }
 654 
 655     @Test
 656     void archiveFailedAutoMerge(TestInfo testInfo) throws IOException {
 657         try (var credentials = new HostCredentials(testInfo);
 658              var tempFolder = new TemporaryDirectory();
 659              var archiveFolder = new TemporaryDirectory();
 660              var webrevFolder = new TemporaryDirectory();
 661              var listServer = new TestMailmanServer();
 662              var webrevServer = new TestWebrevServer()) {
 663             var author = credentials.getHostedRepository();
 664             var archive = credentials.getHostedRepository();
 665             var ignored = credentials.getHostedRepository();
 666             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
 667             var censusBuilder = credentials.getCensusBuilder()
 668                                            .addAuthor(author.forge().currentUser().id());
 669             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
 670             var mlBot = MailingListBridgeBot.newBuilder()
 671                                             .from(from)
 672                                             .repo(author)
 673                                             .archive(archive)
 674                                             .censusRepo(censusBuilder.build())
 675                                             .list(listAddress)
 676                                             .ignoredUsers(Set.of(ignored.forge().currentUser().userName()))
 677                                             .listArchive(listServer.getArchive())
 678                                             .smtpServer(listServer.getSMTP())
 679                                             .webrevStorageRepository(archive)
 680                                             .webrevStorageRef(&quot;webrev&quot;)
 681                                             .webrevStorageBase(Path.of(&quot;test&quot;))
 682                                             .webrevStorageBaseUri(webrevServer.uri())
 683                                             .issueTracker(URIBuilder.base(&quot;http://issues.test/browse/&quot;).build())
 684                                             .build();
 685 
 686             // Populate the projects repository
 687             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType());
 688             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
 689             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
 690             localRepo.push(masterHash, archive.url(), &quot;webrev&quot;, true);
 691 
 692             // Make a change with a corresponding PR
 693             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;A simple change&quot;,
 694                                                                &quot;Change msg\n\nWith several lines&quot;);
 695             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
 696             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;Cannot automatically merge&quot;);
 697             pr.setBody(&quot;This is an automated merge PR&quot;);
 698             pr.addLabel(&quot;failed-auto-merge&quot;);
 699 
 700             // Run an archive pass
 701             TestBotRunner.runPeriodicItems(mlBot);
 702             TestBotRunner.runPeriodicItems(mlBot);
 703 
 704             // The archive should contain an entry
 705             Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);
 706             assertTrue(archiveContains(archiveFolder.path(), &quot;Subject: RFR: Cannot automatically merge&quot;));
 707         }
 708     }
 709 
 710     @Test
 711     void reviewComment(TestInfo testInfo) throws IOException {
 712         try (var credentials = new HostCredentials(testInfo);
 713              var tempFolder = new TemporaryDirectory();
 714              var archiveFolder = new TemporaryDirectory();
 715              var listServer = new TestMailmanServer();
 716              var webrevServer = new TestWebrevServer()) {
 717             var author = credentials.getHostedRepository();
 718             var archive = credentials.getHostedRepository();
 719             var ignored = credentials.getHostedRepository();
 720             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
 721             var censusBuilder = credentials.getCensusBuilder()
 722                                            .addAuthor(author.forge().currentUser().id());
 723             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
 724             var mlBot = MailingListBridgeBot.newBuilder()
 725                                             .from(from)
 726                                             .repo(author)
 727                                             .archive(archive)
 728                                             .censusRepo(censusBuilder.build())
 729                                             .list(listAddress)
 730                                             .ignoredUsers(Set.of(ignored.forge().currentUser().userName()))
 731                                             .listArchive(listServer.getArchive())
 732                                             .smtpServer(listServer.getSMTP())
 733                                             .webrevStorageRepository(archive)
 734                                             .webrevStorageRef(&quot;webrev&quot;)
 735                                             .webrevStorageBase(Path.of(&quot;test&quot;))
 736                                             .webrevStorageBaseUri(webrevServer.uri())
 737                                             .issueTracker(URIBuilder.base(&quot;http://issues.test/browse/&quot;).build())
 738                                             .build();
 739 
 740             // Populate the projects repository
 741             var reviewFile = Path.of(&quot;reviewfile.txt&quot;);
 742             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType(), reviewFile);
 743             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
 744             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
 745             localRepo.push(masterHash, archive.url(), &quot;webrev&quot;, true);
 746 
 747             // Make a change with a corresponding PR
 748             var editHash = CheckableRepository.appendAndCommit(localRepo);
 749             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
 750             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
 751             pr.setBody(&quot;This is now ready&quot;);
 752             TestBotRunner.runPeriodicItems(mlBot);
 753             listServer.processIncoming();
 754 
 755             // And make a file specific comment
 756             var currentMaster = localRepo.resolve(&quot;master&quot;).orElseThrow();
 757             var comment = pr.addReviewComment(masterHash, editHash, reviewFile.toString(), 2, &quot;Review comment&quot;);
 758 
 759             // Add one from an ignored user as well
 760             var ignoredPr = ignored.pullRequest(pr.id());
 761             ignoredPr.addReviewComment(masterHash, editHash, reviewFile.toString(), 2, &quot;Don&#39;t mind me&quot;);
 762 
 763             // Process comments
 764             TestBotRunner.runPeriodicItems(mlBot);
 765             listServer.processIncoming();
 766 
 767             // The archive should now contain an entry
 768             Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);
 769             assertTrue(archiveContains(archiveFolder.path(), &quot;This is a pull request&quot;));
 770             assertTrue(archiveContains(archiveFolder.path(), &quot;This is now ready&quot;));
 771             assertTrue(archiveContains(archiveFolder.path(), &quot;Review comment&quot;));
 772             assertTrue(archiveContains(archiveFolder.path(), &quot;&gt; This is now ready&quot;));
 773             assertTrue(archiveContains(archiveFolder.path(), reviewFile.toString()));
 774             assertFalse(archiveContains(archiveFolder.path(), &quot;Don&#39;t mind me&quot;));
 775 
 776             // The mailing list as well
 777             var mailmanServer = MailingListServerFactory.createMailmanServer(listServer.getArchive(), listServer.getSMTP(), Duration.ZERO);
 778             var mailmanList = mailmanServer.getList(listAddress.address());
 779             var conversations = mailmanList.conversations(Duration.ofDays(1));
 780             assertEquals(1, conversations.size());
 781             var mail = conversations.get(0).first();
 782             assertEquals(&quot;RFR: This is a pull request&quot;, mail.subject());
 783 
 784             // Comment on the comment
 785             pr.addReviewCommentReply(comment, &quot;This is a review reply&quot;);
 786             TestBotRunner.runPeriodicItems(mlBot);
 787             listServer.processIncoming();
 788 
 789             // The archive should contain the additional comment (but no quoted footers)
 790             Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);
 791             assertTrue(archiveContains(archiveFolder.path(), &quot;This is a review reply&quot;));
 792             assertTrue(archiveContains(archiveFolder.path(), &quot;&gt;&gt; This is now ready&quot;));
 793             assertFalse(archiveContains(archiveFolder.path(), &quot;^&gt; PR:&quot;));
 794 
 795             // As well as the mailing list
 796             conversations = mailmanList.conversations(Duration.ofDays(1));
 797             assertEquals(1, conversations.size());
 798             assertEquals(3, conversations.get(0).allMessages().size());
 799             for (var newMail : conversations.get(0).allMessages()) {
 800                 assertEquals(noreplyAddress(archive), newMail.author().address());
 801                 assertEquals(listAddress, newMail.sender());
 802             }
 803         }
 804     }
 805 
 806     @Test
 807     void combineComments(TestInfo testInfo) throws IOException {
 808         try (var credentials = new HostCredentials(testInfo);
 809              var tempFolder = new TemporaryDirectory();
 810              var archiveFolder = new TemporaryDirectory();
 811              var listServer = new TestMailmanServer();
 812              var webrevServer = new TestWebrevServer()) {
 813             var author = credentials.getHostedRepository();
 814             var archive = credentials.getHostedRepository();
 815             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
 816             var censusBuilder = credentials.getCensusBuilder()
 817                                            .addAuthor(author.forge().currentUser().id());
 818             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
 819             var mlBot = MailingListBridgeBot.newBuilder()
 820                                             .from(from)
 821                                             .repo(author)
 822                                             .archive(archive)
 823                                             .censusRepo(censusBuilder.build())
 824                                             .list(listAddress)
 825                                             .listArchive(listServer.getArchive())
 826                                             .smtpServer(listServer.getSMTP())
 827                                             .webrevStorageRepository(archive)
 828                                             .webrevStorageRef(&quot;webrev&quot;)
 829                                             .webrevStorageBase(Path.of(&quot;test&quot;))
 830                                             .webrevStorageBaseUri(webrevServer.uri())
 831                                             .issueTracker(URIBuilder.base(&quot;http://issues.test/browse/&quot;).build())
 832                                             .build();
 833 
 834             // Populate the projects repository
 835             var reviewFile = Path.of(&quot;reviewfile.txt&quot;);
 836             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType(), reviewFile);
 837             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
 838             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
 839             localRepo.push(masterHash, archive.url(), &quot;webrev&quot;, true);
 840 
 841             // Make a change with a corresponding PR
 842             var editHash = CheckableRepository.appendAndCommit(localRepo);
 843             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
 844             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
 845             pr.setBody(&quot;This is now ready&quot;);
 846             pr.addComment(&quot;Avoid combining&quot;);
 847 
 848             TestBotRunner.runPeriodicItems(mlBot);
 849             listServer.processIncoming();
 850             listServer.processIncoming();
 851 
 852             // Make several file specific comments
 853             var first = pr.addReviewComment(masterHash, editHash, reviewFile.toString(), 2, &quot;Review comment&quot;);
 854             var second = pr.addReviewComment(masterHash, editHash, reviewFile.toString(), 2, &quot;Another review comment&quot;);
 855             pr.addReviewComment(masterHash, editHash, reviewFile.toString(), 2, &quot;Further review comment&quot;);
 856             pr.addReviewComment(masterHash, editHash, reviewFile.toString(), 2, &quot;Final review comment&quot;);
 857             TestBotRunner.runPeriodicItems(mlBot);
 858             listServer.processIncoming();
 859 
 860             // The archive should contain a combined entry
 861             Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);
 862             assertEquals(2, archiveContainsCount(archiveFolder.path(), &quot;^On.*wrote:&quot;));
 863 
 864             // As well as the mailing list
 865             var mailmanServer = MailingListServerFactory.createMailmanServer(listServer.getArchive(), listServer.getSMTP(), Duration.ZERO);
 866             var mailmanList = mailmanServer.getList(listAddress.address());
 867             var conversations = mailmanList.conversations(Duration.ofDays(1));
 868             assertEquals(1, conversations.size());
 869             var mail = conversations.get(0).first();
 870             assertEquals(&quot;RFR: This is a pull request&quot;, mail.subject());
 871             assertEquals(3, conversations.get(0).allMessages().size());
 872 
 873             var commentReply = conversations.get(0).replies(mail).get(0);
 874             assertEquals(2, commentReply.body().split(&quot;^On.*wrote:&quot;).length);
 875             assertTrue(commentReply.body().contains(&quot;Avoid combining\n\n&quot;), commentReply.body());
 876 
 877             var reviewReply = conversations.get(0).replies(mail).get(1);
 878             assertEquals(2, reviewReply.body().split(&quot;^On.*wrote:&quot;).length);
 879             assertEquals(2, reviewReply.body().split(&quot;&gt; This is now ready&quot;).length, reviewReply.body());
 880             assertEquals(&quot;RFR: This is a pull request&quot;, reviewReply.subject());
 881             assertTrue(reviewReply.body().contains(&quot;Review comment\n\n&quot;), reviewReply.body());
 882             assertTrue(reviewReply.body().contains(&quot;Another review comment&quot;), reviewReply.body());
 883 
 884             // Now reply to the first and second (collapsed) comment
 885             pr.addReviewCommentReply(first, &quot;I agree&quot;);
 886             pr.addReviewCommentReply(second, &quot;Not with this one though&quot;);
 887             TestBotRunner.runPeriodicItems(mlBot);
 888             listServer.processIncoming();
 889 
 890             // The archive should contain a new entry
 891             Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);
 892             assertEquals(3, archiveContainsCount(archiveFolder.path(), &quot;^On.*wrote:&quot;));
 893 
 894             // The combined review comments should only appear unquoted once
 895             assertEquals(1, archiveContainsCount(archiveFolder.path(), &quot;^Another review comment&quot;));
 896         }
 897     }
 898 
 899     @Test
 900     void commentThreading(TestInfo testInfo) throws IOException {
 901         try (var credentials = new HostCredentials(testInfo);
 902              var tempFolder = new TemporaryDirectory();
 903              var archiveFolder = new TemporaryDirectory();
 904              var listServer = new TestMailmanServer();
 905              var webrevServer = new TestWebrevServer()) {
 906             var author = credentials.getHostedRepository();
 907             var reviewer = credentials.getHostedRepository();
 908             var archive = credentials.getHostedRepository();
 909             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
 910             var censusBuilder = credentials.getCensusBuilder()
 911                                            .addReviewer(reviewer.forge().currentUser().id())
 912                                            .addAuthor(author.forge().currentUser().id());
 913             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
 914             var mlBot = MailingListBridgeBot.newBuilder()
 915                                             .from(from)
 916                                             .repo(author)
 917                                             .archive(archive)
 918                                             .censusRepo(censusBuilder.build())
 919                                             .list(listAddress)
 920                                             .listArchive(listServer.getArchive())
 921                                             .smtpServer(listServer.getSMTP())
 922                                             .webrevStorageRepository(archive)
 923                                             .webrevStorageRef(&quot;webrev&quot;)
 924                                             .webrevStorageBase(Path.of(&quot;test&quot;))
 925                                             .webrevStorageBaseUri(webrevServer.uri())
 926                                             .issueTracker(URIBuilder.base(&quot;http://issues.test/browse/&quot;).build())
 927                                             .build();
 928 
 929             // Populate the projects repository
 930             var reviewFile = Path.of(&quot;reviewfile.txt&quot;);
 931             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType(), reviewFile);
 932             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
 933             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
 934             localRepo.push(masterHash, archive.url(), &quot;webrev&quot;, true);
 935 
 936             // Make a change with a corresponding PR
 937             var editHash = CheckableRepository.appendAndCommit(localRepo);
 938             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
 939             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
 940             pr.setBody(&quot;This is now ready&quot;);
 941             TestBotRunner.runPeriodicItems(mlBot);
 942             listServer.processIncoming();
 943 
 944             // Make a file specific comment
 945             var reviewPr = reviewer.pullRequest(pr.id());
 946             var comment1 = reviewPr.addReviewComment(masterHash, editHash, reviewFile.toString(), 2, &quot;Review comment&quot;);
 947             pr.addReviewCommentReply(comment1, &quot;I agree&quot;);
 948             reviewPr.addReviewCommentReply(comment1, &quot;Great&quot;);
 949             TestBotRunner.runPeriodicItems(mlBot);
 950             listServer.processIncoming();
 951             listServer.processIncoming();
 952             listServer.processIncoming();
 953 
 954             // And a second one by ourselves
 955             var comment2 = pr.addReviewComment(masterHash, editHash, reviewFile.toString(), 2, &quot;Another review comment&quot;);
 956             reviewPr.addReviewCommentReply(comment2, &quot;Sounds good&quot;);
 957             pr.addReviewCommentReply(comment2, &quot;Thanks&quot;);
 958             TestBotRunner.runPeriodicItems(mlBot);
 959             listServer.processIncoming();
 960             listServer.processIncoming();
 961             listServer.processIncoming();
 962 
 963             // Finally some approvals and another comment
 964             pr.addReview(Review.Verdict.APPROVED, &quot;Nice&quot;);
 965             reviewPr.addReviewComment(masterHash, editHash, reviewFile.toString(), 2, &quot;The final review comment&quot;);
 966             reviewPr.addReview(Review.Verdict.APPROVED, &quot;Looks fine&quot;);
 967             reviewPr.addReviewCommentReply(comment2, &quot;You are welcome&quot;);
 968             TestBotRunner.runPeriodicItems(mlBot);
 969             listServer.processIncoming();
 970             listServer.processIncoming();
 971             listServer.processIncoming();
 972 
 973             // Sanity check the archive
 974             Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);
 975             assertEquals(9, archiveContainsCount(archiveFolder.path(), &quot;^On.*wrote:&quot;));
 976 
 977             // File specific comments should appear after the approval
 978             var archiveText = archiveContents(archiveFolder.path()).orElseThrow();
 979             assertTrue(archiveText.indexOf(&quot;Looks fine&quot;) &lt; archiveText.indexOf(&quot;The final review comment&quot;));
 980 
 981             // Check the mailing list
 982             var mailmanServer = MailingListServerFactory.createMailmanServer(listServer.getArchive(), listServer.getSMTP(), Duration.ZERO);
 983             var mailmanList = mailmanServer.getList(listAddress.address());
 984             var conversations = mailmanList.conversations(Duration.ofDays(1));
 985             assertEquals(1, conversations.size());
 986             var mail = conversations.get(0).first();
 987             assertEquals(&quot;RFR: This is a pull request&quot;, mail.subject());
 988             assertEquals(10, conversations.get(0).allMessages().size());
 989 
 990             // There should be four separate threads
 991             var thread1 = conversations.get(0).replies(mail).get(0);
 992             assertEquals(2, thread1.body().split(&quot;^On.*wrote:&quot;).length);
 993             assertEquals(2, thread1.body().split(&quot;&gt; This is now ready&quot;).length, thread1.body());
 994             assertEquals(&quot;RFR: This is a pull request&quot;, thread1.subject());
 995             assertTrue(thread1.body().contains(&quot;Review comment\n\n&quot;), thread1.body());
 996             assertFalse(thread1.body().contains(&quot;Another review comment&quot;), thread1.body());
 997             var thread1reply1 = conversations.get(0).replies(thread1).get(0);
 998             assertTrue(thread1reply1.body().contains(&quot;I agree&quot;));
 999             assertEquals(noreplyAddress(archive), thread1reply1.author().address());
1000             assertEquals(archive.forge().currentUser().fullName(), thread1reply1.author().fullName().orElseThrow());
1001             var thread1reply2 = conversations.get(0).replies(thread1reply1).get(0);
1002             assertTrue(thread1reply2.body().contains(&quot;Great&quot;));
1003             assertEquals(&quot;integrationreviewer1@openjdk.java.net&quot;, thread1reply2.author().address());
1004             assertEquals(&quot;Generated Reviewer 1&quot;, thread1reply2.author().fullName().orElseThrow());
1005 
1006             var thread2 = conversations.get(0).replies(mail).get(1);
1007             assertEquals(2, thread2.body().split(&quot;^On.*wrote:&quot;).length);
1008             assertEquals(2, thread2.body().split(&quot;&gt; This is now ready&quot;).length, thread2.body());
1009             assertEquals(&quot;RFR: This is a pull request&quot;, thread2.subject());
1010             assertFalse(thread2.body().contains(&quot;Review comment\n\n&quot;), thread2.body());
1011             assertTrue(thread2.body().contains(&quot;Another review comment&quot;), thread2.body());
1012             var thread2reply1 = conversations.get(0).replies(thread2).get(0);
1013             assertTrue(thread2reply1.body().contains(&quot;Sounds good&quot;));
1014             var thread2reply2 = conversations.get(0).replies(thread2reply1).get(0);
1015             assertTrue(thread2reply2.body().contains(&quot;Thanks&quot;));
1016 
1017             var replies = conversations.get(0).replies(mail);
1018             var thread3 = replies.get(2);
1019             assertEquals(&quot;RFR: This is a pull request&quot;, thread3.subject());
1020             var thread4 = replies.get(3);
1021             assertEquals(&quot;RFR: This is a pull request&quot;, thread4.subject());
1022             assertTrue(thread4.body().contains(&quot;Looks fine&quot;));
1023             assertTrue(thread4.body().contains(&quot;The final review comment&quot;));
1024             assertTrue(thread4.body().contains(&quot;Marked as reviewed by integrationreviewer1 (Reviewer)&quot;));
1025         }
1026     }
1027 
1028     @Test
1029     void commentThreadingSeparated(TestInfo testInfo) throws IOException {
1030         try (var credentials = new HostCredentials(testInfo);
1031              var tempFolder = new TemporaryDirectory();
1032              var archiveFolder = new TemporaryDirectory();
1033              var listServer = new TestMailmanServer();
1034              var webrevServer = new TestWebrevServer()) {
1035             var author = credentials.getHostedRepository();
1036             var reviewer = credentials.getHostedRepository();
1037             var archive = credentials.getHostedRepository();
1038             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
1039             var censusBuilder = credentials.getCensusBuilder()
1040                                            .addReviewer(reviewer.forge().currentUser().id())
1041                                            .addAuthor(author.forge().currentUser().id());
1042             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
1043             var mlBot = MailingListBridgeBot.newBuilder()
1044                                             .from(from)
1045                                             .repo(author)
1046                                             .archive(archive)
1047                                             .censusRepo(censusBuilder.build())
1048                                             .list(listAddress)
1049                                             .listArchive(listServer.getArchive())
1050                                             .smtpServer(listServer.getSMTP())
1051                                             .webrevStorageRepository(archive)
1052                                             .webrevStorageRef(&quot;webrev&quot;)
1053                                             .webrevStorageBase(Path.of(&quot;test&quot;))
1054                                             .webrevStorageBaseUri(webrevServer.uri())
1055                                             .issueTracker(URIBuilder.base(&quot;http://issues.test/browse/&quot;).build())
1056                                             .build();
1057 
1058             // Populate the projects repository
1059             var reviewFile = Path.of(&quot;reviewfile.txt&quot;);
1060             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType(), reviewFile);
1061             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
1062             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
1063             localRepo.push(masterHash, archive.url(), &quot;webrev&quot;, true);
1064 
1065             // Make a change with a corresponding PR
1066             var editHash = CheckableRepository.appendAndCommit(localRepo);
1067             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
1068             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
1069             pr.setBody(&quot;This is now ready&quot;);
1070             TestBotRunner.runPeriodicItems(mlBot);
1071             listServer.processIncoming();
1072 
1073             // Make two file specific comments
1074             var reviewPr = reviewer.pullRequest(pr.id());
1075             var comment1 = reviewPr.addReviewComment(masterHash, editHash, reviewFile.toString(), 2, &quot;Review comment&quot;);
1076             var comment2 = reviewPr.addReviewComment(masterHash, editHash, reviewFile.toString(), 2, &quot;Another review comment&quot;);
1077             TestBotRunner.runPeriodicItems(mlBot);
1078             listServer.processIncoming();
1079 
1080             pr.addReviewCommentReply(comment1, &quot;I agree&quot;);
1081             pr.addReviewCommentReply(comment2, &quot;I don&#39;t agree&quot;);
1082             TestBotRunner.runPeriodicItems(mlBot);
1083             listServer.processIncoming();
1084 
1085             // Sanity check the archive
1086             Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);
1087             assertEquals(2, archiveContainsCount(archiveFolder.path(), &quot;^On.*wrote:&quot;));
1088         }
1089     }
1090 
1091     @Test
1092     void commentWithMention(TestInfo testInfo) throws IOException {
1093         try (var credentials = new HostCredentials(testInfo);
1094              var tempFolder = new TemporaryDirectory();
1095              var archiveFolder = new TemporaryDirectory();
1096              var listServer = new TestMailmanServer();
1097              var webrevServer = new TestWebrevServer()) {
1098             var author = credentials.getHostedRepository();
1099             var reviewer = credentials.getHostedRepository();
1100             var archive = credentials.getHostedRepository();
1101             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
1102             var censusBuilder = credentials.getCensusBuilder()
1103                                            .addReviewer(reviewer.forge().currentUser().id())
1104                                            .addAuthor(author.forge().currentUser().id());
1105             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
1106             var mlBot = MailingListBridgeBot.newBuilder()
1107                                             .from(from)
1108                                             .repo(author)
1109                                             .archive(archive)
1110                                             .censusRepo(censusBuilder.build())
1111                                             .list(listAddress)
1112                                             .listArchive(listServer.getArchive())
1113                                             .smtpServer(listServer.getSMTP())
1114                                             .webrevStorageRepository(archive)
1115                                             .webrevStorageRef(&quot;webrev&quot;)
1116                                             .webrevStorageBase(Path.of(&quot;test&quot;))
1117                                             .webrevStorageBaseUri(webrevServer.uri())
1118                                             .issueTracker(URIBuilder.base(&quot;http://issues.test/browse/&quot;).build())
1119                                             .build();
1120 
1121             // Populate the projects repository
1122             var reviewFile = Path.of(&quot;reviewfile.txt&quot;);
1123             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType(), reviewFile);
1124             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
1125             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
1126             localRepo.push(masterHash, archive.url(), &quot;webrev&quot;, true);
1127 
1128             // Make a change with a corresponding PR
1129             var editHash = CheckableRepository.appendAndCommit(localRepo);
1130             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
1131             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
1132             pr.setBody(&quot;This is now ready&quot;);
1133             TestBotRunner.runPeriodicItems(mlBot);
1134             listServer.processIncoming();
1135 
1136             // Make two comments from different authors
1137             var reviewPr = reviewer.pullRequest(pr.id());
1138             reviewPr.addComment(&quot;First comment&quot;);
1139             pr.addComment(&quot;Second comment&quot;);
1140 
1141             TestBotRunner.runPeriodicItems(mlBot);
1142             listServer.processIncoming();
1143 
1144             pr.addComment(&quot;@&quot; + reviewer.forge().currentUser().userName() + &quot; reply to first&quot;);
1145             TestBotRunner.runPeriodicItems(mlBot);
1146             listServer.processIncoming();
1147 
1148             // The first comment should be quoted more often than the second
1149             Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);
1150             assertEquals(3, archiveContainsCount(archiveFolder.path(), &quot;First comment&quot;));
1151             assertEquals(1, archiveContainsCount(archiveFolder.path(), &quot;Second comment&quot;));
1152         }
1153     }
1154 
1155     @Test
1156     void reviewCommentWithMention(TestInfo testInfo) throws IOException {
1157         try (var credentials = new HostCredentials(testInfo);
1158              var tempFolder = new TemporaryDirectory();
1159              var archiveFolder = new TemporaryDirectory();
1160              var listServer = new TestMailmanServer();
1161              var webrevServer = new TestWebrevServer()) {
1162             var author = credentials.getHostedRepository();
1163             var reviewer = credentials.getHostedRepository();
1164             var archive = credentials.getHostedRepository();
1165             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
1166             var censusBuilder = credentials.getCensusBuilder()
1167                                            .addReviewer(reviewer.forge().currentUser().id())
1168                                            .addAuthor(author.forge().currentUser().id());
1169             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
1170             var mlBot = MailingListBridgeBot.newBuilder()
1171                                             .from(from)
1172                                             .repo(author)
1173                                             .archive(archive)
1174                                             .censusRepo(censusBuilder.build())
1175                                             .list(listAddress)
1176                                             .listArchive(listServer.getArchive())
1177                                             .smtpServer(listServer.getSMTP())
1178                                             .webrevStorageRepository(archive)
1179                                             .webrevStorageRef(&quot;webrev&quot;)
1180                                             .webrevStorageBase(Path.of(&quot;test&quot;))
1181                                             .webrevStorageBaseUri(webrevServer.uri())
1182                                             .issueTracker(URIBuilder.base(&quot;http://issues.test/browse/&quot;).build())
1183                                             .build();
1184 
1185             // Populate the projects repository
1186             var reviewFile = Path.of(&quot;reviewfile.txt&quot;);
1187             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType(), reviewFile);
1188             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
1189             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
1190             localRepo.push(masterHash, archive.url(), &quot;webrev&quot;, true);
1191 
1192             // Make a change with a corresponding PR
1193             var editHash = CheckableRepository.appendAndCommit(localRepo);
1194             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
1195             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
1196             pr.setBody(&quot;This is now ready&quot;);
1197             TestBotRunner.runPeriodicItems(mlBot);
1198             listServer.processIncoming();
1199 
1200             // Make two review comments from different authors
1201             var reviewPr = reviewer.pullRequest(pr.id());
1202             var comment = reviewPr.addReviewComment(masterHash, editHash, reviewFile.toString(), 2, &quot;Review comment&quot;);
1203             reviewPr.addReviewCommentReply(comment, &quot;First review comment&quot;);
1204             pr.addReviewCommentReply(comment, &quot;Second review comment&quot;);
1205 
1206             TestBotRunner.runPeriodicItems(mlBot);
1207             listServer.processIncoming();
1208 
1209             pr.addReviewCommentReply(comment, &quot;@&quot; + reviewer.forge().currentUser().userName() + &quot; reply to first&quot;);
1210             TestBotRunner.runPeriodicItems(mlBot);
1211             listServer.processIncoming();
1212 
1213             // The first comment should be quoted more often than the second
1214             Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);
1215             assertEquals(3, archiveContainsCount(archiveFolder.path(), &quot;First review comment&quot;));
1216             assertEquals(1, archiveContainsCount(archiveFolder.path(), &quot;Second review comment&quot;));
1217         }
1218     }
1219 
1220     @Test
1221     void commentWithQuote(TestInfo testInfo) throws IOException {
1222         try (var credentials = new HostCredentials(testInfo);
1223              var tempFolder = new TemporaryDirectory();
1224              var archiveFolder = new TemporaryDirectory();
1225              var listServer = new TestMailmanServer();
1226              var webrevServer = new TestWebrevServer()) {
1227             var author = credentials.getHostedRepository();
1228             var reviewer = credentials.getHostedRepository();
1229             var archive = credentials.getHostedRepository();
1230             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
1231             var censusBuilder = credentials.getCensusBuilder()
1232                                            .addReviewer(reviewer.forge().currentUser().id())
1233                                            .addAuthor(author.forge().currentUser().id());
1234             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
1235             var mlBot = MailingListBridgeBot.newBuilder()
1236                                             .from(from)
1237                                             .repo(author)
1238                                             .archive(archive)
1239                                             .censusRepo(censusBuilder.build())
1240                                             .list(listAddress)
1241                                             .listArchive(listServer.getArchive())
1242                                             .smtpServer(listServer.getSMTP())
1243                                             .webrevStorageRepository(archive)
1244                                             .webrevStorageRef(&quot;webrev&quot;)
1245                                             .webrevStorageBase(Path.of(&quot;test&quot;))
1246                                             .webrevStorageBaseUri(webrevServer.uri())
1247                                             .issueTracker(URIBuilder.base(&quot;http://issues.test/browse/&quot;).build())
1248                                             .build();
1249 
1250             // Populate the projects repository
1251             var reviewFile = Path.of(&quot;reviewfile.txt&quot;);
1252             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType(), reviewFile);
1253             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
1254             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
1255             localRepo.push(masterHash, archive.url(), &quot;webrev&quot;, true);
1256 
1257             // Make a change with a corresponding PR
1258             var editHash = CheckableRepository.appendAndCommit(localRepo);
1259             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
1260             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
1261             pr.setBody(&quot;This is now ready&quot;);
1262             TestBotRunner.runPeriodicItems(mlBot);
1263             listServer.processIncoming();
1264 
1265             // Make two comments from different authors
1266             var reviewPr = reviewer.pullRequest(pr.id());
1267             reviewPr.addComment(&quot;First comment\nsecond line&quot;);
1268             pr.addComment(&quot;Second comment\nfourth line&quot;);
1269 
1270             TestBotRunner.runPeriodicItems(mlBot);
1271             listServer.processIncoming();
1272 
1273             pr.addComment(&quot;&gt;First comm\n\nreply to first&quot;);
1274             TestBotRunner.runPeriodicItems(mlBot);
1275             listServer.processIncoming();
1276 
1277             // The first comment should be quoted more often than the second
1278             Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);
1279             assertEquals(2, archiveContainsCount(archiveFolder.path(), &quot;First comment&quot;));
1280             assertEquals(3, archiveContainsCount(archiveFolder.path(), &quot;First comm&quot;));
1281             assertEquals(1, archiveContainsCount(archiveFolder.path(), &quot;Second comment&quot;));
1282         }
1283     }
1284 
1285     @Test
1286     void reviewContext(TestInfo testInfo) throws IOException {
1287         try (var credentials = new HostCredentials(testInfo);
1288              var tempFolder = new TemporaryDirectory();
1289              var archiveFolder = new TemporaryDirectory();
1290              var listServer = new TestMailmanServer();
1291              var webrevServer = new TestWebrevServer()) {
1292             var author = credentials.getHostedRepository();
1293             var archive = credentials.getHostedRepository();
1294             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
1295             var censusBuilder = credentials.getCensusBuilder()
1296                                            .addAuthor(author.forge().currentUser().id());
1297             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
1298             var mlBot = MailingListBridgeBot.newBuilder()
1299                                             .from(from)
1300                                             .repo(author)
1301                                             .archive(archive)
1302                                             .censusRepo(censusBuilder.build())
1303                                             .list(listAddress)
1304                                             .listArchive(listServer.getArchive())
1305                                             .smtpServer(listServer.getSMTP())
1306                                             .webrevStorageRepository(archive)
1307                                             .webrevStorageRef(&quot;webrev&quot;)
1308                                             .webrevStorageBase(Path.of(&quot;test&quot;))
1309                                             .webrevStorageBaseUri(webrevServer.uri())
1310                                             .issueTracker(URIBuilder.base(&quot;http://issues.test/browse/&quot;).build())
1311                                             .build();
1312 
1313             // Populate the projects repository
1314             var reviewFile = Path.of(&quot;reviewfile.txt&quot;);
1315             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType(), reviewFile);
1316             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
1317             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
1318             localRepo.push(masterHash, archive.url(), &quot;webrev&quot;, true);
1319 
1320             // Make a change with a corresponding PR
1321             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;Line 1\nLine 2\nLine 3\nLine 4&quot;);
1322             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
1323             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
1324             pr.setBody(&quot;This is now ready&quot;);
1325             TestBotRunner.runPeriodicItems(mlBot);
1326             listServer.processIncoming();
1327 
1328             // Make a file specific comment
1329             pr.addReviewComment(masterHash, editHash, reviewFile.toString(), 2, &quot;Review comment&quot;);
1330 
1331             TestBotRunner.runPeriodicItems(mlBot);
1332             listServer.processIncoming();
1333 
1334             // The archive should only contain context around line 2
1335             Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);
1336             assertTrue(archiveContains(archiveFolder.path(), &quot;^&gt; 2: Line 1$&quot;));
1337             assertTrue(archiveContains(archiveFolder.path(), &quot;^&gt; 3: Line 2$&quot;));
1338             assertFalse(archiveContains(archiveFolder.path(), &quot;^&gt; 4: Line 3$&quot;));
1339         }
1340     }
1341 
1342     @Test
1343     void multipleReviewContexts(TestInfo testInfo) throws IOException {
1344         try (var credentials = new HostCredentials(testInfo);
1345              var tempFolder = new TemporaryDirectory();
1346              var archiveFolder = new TemporaryDirectory();
1347              var listServer = new TestMailmanServer();
1348              var webrevServer = new TestWebrevServer()) {
1349             var author = credentials.getHostedRepository();
1350             var archive = credentials.getHostedRepository();
1351             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
1352             var censusBuilder = credentials.getCensusBuilder()
1353                                            .addAuthor(author.forge().currentUser().id());
1354             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
1355             var mlBot = MailingListBridgeBot.newBuilder()
1356                                             .from(from)
1357                                             .repo(author)
1358                                             .archive(archive)
1359                                             .censusRepo(censusBuilder.build())
1360                                             .list(listAddress)
1361                                             .listArchive(listServer.getArchive())
1362                                             .smtpServer(listServer.getSMTP())
1363                                             .webrevStorageRepository(archive)
1364                                             .webrevStorageRef(&quot;webrev&quot;)
1365                                             .webrevStorageBase(Path.of(&quot;test&quot;))
1366                                             .webrevStorageBaseUri(webrevServer.uri())
1367                                             .issueTracker(URIBuilder.base(&quot;http://issues.test/browse/&quot;).build())
1368                                             .build();
1369 
1370             // Populate the projects repository
1371             var reviewFile = Path.of(&quot;reviewfile.txt&quot;);
1372             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType(), reviewFile);
1373             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
1374             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
1375             localRepo.push(masterHash, archive.url(), &quot;webrev&quot;, true);
1376             var initialHash = CheckableRepository.appendAndCommit(localRepo,
1377                                                                   &quot;Line 0.1\nLine 0.2\nLine 0.3\nLine 0.4\n&quot; +
1378                                                                           &quot;Line 1\nLine 2\nLine 3\nLine 4\n&quot; +
1379                                                                           &quot;Line 5\nLine 6\nLine 7\nLine 8\n&quot; +
1380                                                                           &quot;Line 8.1\nLine 8.2\nLine 8.3\nLine 8.4\n&quot; +
1381                                                                           &quot;Line 9\nLine 10\nLine 11\nLine 12\n&quot; +
1382                                                                           &quot;Line 13\nLine 14\nLine 15\nLine 16\n&quot;);
1383             localRepo.push(initialHash, author.url(), &quot;master&quot;);
1384 
1385             // Make a change with a corresponding PR
1386             var current = Files.readString(localRepo.root().resolve(reviewFile), StandardCharsets.UTF_8);
1387             var updated = current.replaceAll(&quot;Line 2&quot;, &quot;Line 2 edit\nLine 2.5&quot;);
1388             updated = updated.replaceAll(&quot;Line 13&quot;, &quot;Line 12.5\nLine 13 edit&quot;);
1389             Files.writeString(localRepo.root().resolve(reviewFile), updated, StandardCharsets.UTF_8);
1390             var editHash = CheckableRepository.appendAndCommit(localRepo);
1391             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
1392             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
1393             pr.setBody(&quot;This is now ready&quot;);
1394             TestBotRunner.runPeriodicItems(mlBot);
1395             listServer.processIncoming();
1396 
1397             // Make file specific comments
1398             pr.addReviewComment(masterHash, editHash, reviewFile.toString(), 7, &quot;Review comment&quot;);
1399             pr.addReviewComment(masterHash, editHash, reviewFile.toString(), 24, &quot;Another review comment&quot;);
1400 
1401             TestBotRunner.runPeriodicItems(mlBot);
1402             listServer.processIncoming();
1403 
1404             // The archive should only contain context around line 2 and 20
1405             Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);
1406             assertTrue(archiveContains(archiveFolder.path(), &quot;reviewfile.txt line 7&quot;));
1407             assertTrue(archiveContains(archiveFolder.path(), &quot;^&gt; 6: Line 1$&quot;));
1408             assertTrue(archiveContains(archiveFolder.path(), &quot;^&gt; 7: Line 2 edit$&quot;));
1409             assertFalse(archiveContains(archiveFolder.path(), &quot;Line 3&quot;));
1410 
1411             assertTrue(archiveContains(archiveFolder.path(), &quot;reviewfile.txt line 24&quot;));
1412             assertTrue(archiveContains(archiveFolder.path(), &quot;^&gt; 23: Line 12.5$&quot;));
1413             assertTrue(archiveContains(archiveFolder.path(), &quot;^&gt; 24: Line 13 edit$&quot;));
1414             assertFalse(archiveContains(archiveFolder.path(), &quot;^Line 15&quot;));
1415         }
1416     }
1417 
1418     @Test
1419     void filterComments(TestInfo testInfo) throws IOException {
1420         try (var credentials = new HostCredentials(testInfo);
1421              var tempFolder = new TemporaryDirectory();
1422              var archiveFolder = new TemporaryDirectory();
1423              var listServer = new TestMailmanServer();
1424              var webrevServer = new TestWebrevServer()) {
1425             var author = credentials.getHostedRepository();
1426             var archive = credentials.getHostedRepository();
1427             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
1428             var censusBuilder = credentials.getCensusBuilder()
1429                                            .addAuthor(author.forge().currentUser().id());
1430             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
1431             var mlBot = MailingListBridgeBot.newBuilder()
1432                                             .from(from)
1433                                             .repo(author)
1434                                             .archive(archive)
1435                                             .censusRepo(censusBuilder.build())
1436                                             .list(listAddress)
1437                                             .listArchive(listServer.getArchive())
1438                                             .smtpServer(listServer.getSMTP())
1439                                             .webrevStorageRepository(archive)
1440                                             .webrevStorageRef(&quot;webrev&quot;)
1441                                             .webrevStorageBase(Path.of(&quot;test&quot;))
1442                                             .webrevStorageBaseUri(webrevServer.uri())
1443                                             .issueTracker(URIBuilder.base(&quot;http://issues.test/browse/&quot;).build())
1444                                             .build();
1445 
1446             // Populate the projects repository
1447             var reviewFile = Path.of(&quot;reviewfile.txt&quot;);
1448             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType(), reviewFile);
1449             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
1450             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
1451             localRepo.push(masterHash, archive.url(), &quot;webrev&quot;, true);
1452 
1453             // Make a change with a corresponding PR
1454             var editHash = CheckableRepository.appendAndCommit(localRepo);
1455             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
1456             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
1457             pr.setBody(&quot;This is now ready\n&lt;!-- this is a comment --&gt;\nAnd this is not\n&quot; +
1458                                &quot;&lt;!-- Anything below this marker will be hidden --&gt;\nStatus stuff&quot;);
1459 
1460             // Make a bunch of comments
1461             pr.addComment(&quot;Plain comment\n&lt;!-- this is a comment --&gt;&quot;);
1462             pr.addReviewComment(masterHash, editHash, reviewFile.toString(), 2, &quot;Review comment &lt;!-- this is a comment --&gt;\n&quot;);
1463             pr.addComment(&quot;/integrate stuff&quot;);
1464             TestBotRunner.runPeriodicItems(mlBot);
1465 
1466             // Run an archive pass
1467             TestBotRunner.runPeriodicItems(mlBot);
1468 
1469             // The archive should not contain the comment
1470             Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);
1471             assertTrue(archiveContains(archiveFolder.path(), &quot;This is now ready&quot;));
1472             assertFalse(archiveContains(archiveFolder.path(), &quot;this is a comment&quot;));
1473             assertFalse(archiveContains(archiveFolder.path(), &quot;Status stuff&quot;));
1474             assertTrue(archiveContains(archiveFolder.path(), &quot;And this is not&quot;));
1475             assertFalse(archiveContains(archiveFolder.path(), &quot;&lt;!--&quot;));
1476             assertFalse(archiveContains(archiveFolder.path(), &quot;--&gt;&quot;));
1477             assertTrue(archiveContains(archiveFolder.path(), &quot;Plain comment&quot;));
1478             assertTrue(archiveContains(archiveFolder.path(), &quot;Review comment&quot;));
1479             assertFalse(archiveContains(archiveFolder.path(), &quot;/integrate&quot;));
1480         }
1481     }
1482 
1483     @Test
1484     void incrementalChanges(TestInfo testInfo) throws IOException {
1485         try (var credentials = new HostCredentials(testInfo);
1486              var tempFolder = new TemporaryDirectory();
1487              var archiveFolder = new TemporaryDirectory();
1488              var listServer = new TestMailmanServer();
1489              var webrevServer = new TestWebrevServer()) {
1490             var author = credentials.getHostedRepository();
1491             var archive = credentials.getHostedRepository();
1492             var commenter = credentials.getHostedRepository();
1493             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
1494             var censusBuilder = credentials.getCensusBuilder()
1495                                            .addAuthor(author.forge().currentUser().id());
1496             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
1497             var mlBot = MailingListBridgeBot.newBuilder()
1498                                             .from(from)
1499                                             .repo(author)
1500                                             .archive(archive)
1501                                             .censusRepo(censusBuilder.build())
1502                                             .list(listAddress)
1503                                             .listArchive(listServer.getArchive())
1504                                             .smtpServer(listServer.getSMTP())
1505                                             .webrevStorageRepository(archive)
1506                                             .webrevStorageRef(&quot;webrev&quot;)
1507                                             .webrevStorageBase(Path.of(&quot;test&quot;))
1508                                             .webrevStorageBaseUri(webrevServer.uri())
1509                                             .issueTracker(URIBuilder.base(&quot;http://issues.test/browse/&quot;).build())
1510                                             .build();
1511 
1512             // Populate the projects repository
1513             var reviewFile = Path.of(&quot;reviewfile.txt&quot;);
1514             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType(), reviewFile);
1515             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
1516             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
1517             localRepo.push(masterHash, archive.url(), &quot;webrev&quot;, true);
1518 
1519             // Make a change with a corresponding PR
1520             var editHash = CheckableRepository.appendAndCommit(localRepo);
1521             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
1522             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
1523             pr.setBody(&quot;This is now ready&quot;);
1524 
1525             // Run an archive pass
1526             TestBotRunner.runPeriodicItems(mlBot);
1527             listServer.processIncoming();
1528 
1529             var nextHash = CheckableRepository.appendAndCommit(localRepo, &quot;Yet one more line&quot;, &quot;Fixing&quot;);
1530             localRepo.push(nextHash, author.url(), &quot;edit&quot;);
1531 
1532             // Make sure that the push registered
1533             var lastHeadHash = pr.headHash();
1534             var refreshCount = 0;
1535             do {
1536                 pr = author.pullRequest(pr.id());
1537                 if (refreshCount++ &gt; 100) {
1538                     fail(&quot;The PR did not update after the new push&quot;);
1539                 }
1540             } while (pr.headHash().equals(lastHeadHash));
1541 
1542             // Run another archive pass
1543             TestBotRunner.runPeriodicItems(mlBot);
1544             TestBotRunner.runPeriodicItems(mlBot);
1545             TestBotRunner.runPeriodicItems(mlBot);
1546             listServer.processIncoming();
1547 
1548             // The archive should reference the updated push
1549             Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);
1550             assertTrue(archiveContains(archiveFolder.path(), &quot;has updated the pull request incrementally&quot;));
1551             assertTrue(archiveContains(archiveFolder.path(), &quot;full.*/&quot; + pr.id() + &quot;/webrev.01&quot;));
1552             assertTrue(archiveContains(archiveFolder.path(), &quot;inc.*/&quot; + pr.id() + &quot;/webrev.00-01&quot;));
1553             assertTrue(archiveContains(archiveFolder.path(), &quot;Patch&quot;));
1554             assertTrue(archiveContains(archiveFolder.path(), &quot;Fetch&quot;));
1555             assertTrue(archiveContains(archiveFolder.path(), &quot;Fixing&quot;));
1556 
1557             // The webrev comment should be updated
1558             var comments = pr.comments();
1559             var webrevComments = comments.stream()
1560                                          .filter(comment -&gt; comment.author().equals(author.forge().currentUser()))
1561                                          .filter(comment -&gt; comment.body().contains(&quot;webrev&quot;))
1562                                          .filter(comment -&gt; comment.body().contains(&quot;Full&quot;))
1563                                          .filter(comment -&gt; comment.body().contains(&quot;Incremental&quot;))
1564                                          .filter(comment -&gt; comment.body().contains(nextHash.hex()))
1565                                          .filter(comment -&gt; comment.body().contains(editHash.hex()))
1566                                          .collect(Collectors.toList());
1567             assertEquals(1, webrevComments.size());
1568 
1569             // Check that sender address is set properly
1570             var mailmanServer = MailingListServerFactory.createMailmanServer(listServer.getArchive(), listServer.getSMTP(), Duration.ZERO);
1571             var mailmanList = mailmanServer.getList(listAddress.address());
1572             var conversations = mailmanList.conversations(Duration.ofDays(1));
1573             assertEquals(1, conversations.size());
1574             for (var newMail : conversations.get(0).allMessages()) {
1575                 assertEquals(noreplyAddress(archive), newMail.author().address());
1576                 assertEquals(listAddress, newMail.sender());
1577             }
1578 
1579             // Add a comment
1580             var commenterPr = commenter.pullRequest(pr.id());
1581             commenterPr.addReviewComment(masterHash, nextHash, reviewFile.toString(), 2, &quot;Review comment&quot;);
1582             TestBotRunner.runPeriodicItems(mlBot);
1583             listServer.processIncoming();
1584 
1585             // Ensure that additional updates are only reported once
1586             for (int i = 0; i &lt; 3; ++i) {
1587                 var anotherHash = CheckableRepository.appendAndCommit(localRepo, &quot;Another line&quot;, &quot;Fixing&quot;);
1588                 localRepo.push(anotherHash, author.url(), &quot;edit&quot;);
1589 
1590                 // Make sure that the push registered
1591                 lastHeadHash = pr.headHash();
1592                 refreshCount = 0;
1593                 do {
1594                     pr = author.pullRequest(pr.id());
1595                     if (refreshCount++ &gt; 100) {
1596                         fail(&quot;The PR did not update after the new push&quot;);
1597                     }
1598                 } while (pr.headHash().equals(lastHeadHash));
1599 
1600                 TestBotRunner.runPeriodicItems(mlBot);
1601                 TestBotRunner.runPeriodicItems(mlBot);
1602                 listServer.processIncoming();
1603             }
1604             var updatedConversations = mailmanList.conversations(Duration.ofDays(1));
1605             assertEquals(1, updatedConversations.size());
1606             var conversation = updatedConversations.get(0);
1607             assertEquals(6, conversation.allMessages().size());
1608             assertEquals(&quot;[Rev 01] RFR: This is a pull request&quot;, conversation.allMessages().get(1).subject());
1609             assertEquals(&quot;[Rev 01] RFR: This is a pull request&quot;, conversation.allMessages().get(2).subject(), conversation.allMessages().get(2).toString());
1610             assertEquals(&quot;[Rev 04] RFR: This is a pull request&quot;, conversation.allMessages().get(5).subject());
1611         }
1612     }
1613 
1614     @Test
1615     void rebased(TestInfo testInfo) throws IOException {
1616         try (var credentials = new HostCredentials(testInfo);
1617              var tempFolder = new TemporaryDirectory();
1618              var archiveFolder = new TemporaryDirectory();
1619              var listServer = new TestMailmanServer();
1620              var webrevServer = new TestWebrevServer()) {
1621             var author = credentials.getHostedRepository();
1622             var archive = credentials.getHostedRepository();
1623             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
1624             var censusBuilder = credentials.getCensusBuilder()
1625                                            .addAuthor(author.forge().currentUser().id());
1626             var sender = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
1627             var mlBot = MailingListBridgeBot.newBuilder()
1628                                             .from(sender)
1629                                             .repo(author)
1630                                             .archive(archive)
1631                                             .censusRepo(censusBuilder.build())
1632                                             .list(listAddress)
1633                                             .listArchive(listServer.getArchive())
1634                                             .smtpServer(listServer.getSMTP())
1635                                             .webrevStorageRepository(archive)
1636                                             .webrevStorageRef(&quot;webrev&quot;)
1637                                             .webrevStorageBase(Path.of(&quot;test&quot;))
1638                                             .webrevStorageBaseUri(webrevServer.uri())
1639                                             .issueTracker(URIBuilder.base(&quot;http://issues.test/browse/&quot;).build())
1640                                             .build();
1641 
1642             // Populate the projects repository
1643             var reviewFile = Path.of(&quot;reviewfile.txt&quot;);
1644             var localRepo = CheckableRepository.init(tempFolder.path().resolve(&quot;first&quot;), author.repositoryType(), reviewFile);
1645             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
1646             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
1647             localRepo.push(masterHash, archive.url(), &quot;webrev&quot;, true);
1648 
1649             // Make a change with a corresponding PR
1650             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;A line&quot;, &quot;Original msg&quot;);
1651             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
1652             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
1653             pr.setBody(&quot;This is now ready&quot;);
1654 
1655             // Run an archive pass
1656             TestBotRunner.runPeriodicItems(mlBot);
1657             listServer.processIncoming();
1658 
1659             var newLocalRepo = Repository.materialize(tempFolder.path().resolve(&quot;second&quot;), author.url(), &quot;master&quot;);
1660             var newEditHash = CheckableRepository.appendAndCommit(newLocalRepo, &quot;Another line&quot;, &quot;Replaced msg&quot;);
1661             newLocalRepo.push(newEditHash, author.url(), &quot;edit&quot;, true);
1662 
1663             // Make sure that the push registered
1664             var lastHeadHash = pr.headHash();
1665             var refreshCount = 0;
1666             do {
1667                 pr = author.pullRequest(pr.id());
1668                 if (refreshCount++ &gt; 100) {
1669                     fail(&quot;The PR did not update after the new push&quot;);
1670                 }
1671             } while (pr.headHash().equals(lastHeadHash));
1672 
1673             // Run another archive pass
1674             TestBotRunner.runPeriodicItems(mlBot);
1675             listServer.processIncoming();
1676 
1677             // The archive should reference the rebased push
1678             Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);
1679             assertTrue(archiveContains(archiveFolder.path(), &quot;has updated the pull request with a new target base&quot;));
1680             assertTrue(archiveContains(archiveFolder.path(), pr.id() + &quot;/webrev.01&quot;));
1681             assertFalse(archiveContains(archiveFolder.path(), &quot;Incremental&quot;));
1682             assertTrue(archiveContains(archiveFolder.path(), &quot;Patch&quot;));
1683             assertTrue(archiveContains(archiveFolder.path(), &quot;Fetch&quot;));
1684             assertTrue(archiveContains(archiveFolder.path(), &quot;Original msg&quot;));
1685             assertTrue(archiveContains(archiveFolder.path(), &quot;Replaced msg&quot;));
1686 
1687             // The webrev comment should be updated
1688             var comments = pr.comments();
1689             var webrevComments = comments.stream()
1690                                          .filter(comment -&gt; comment.author().equals(author.forge().currentUser()))
1691                                          .filter(comment -&gt; comment.body().contains(&quot;webrev&quot;))
1692                                          .filter(comment -&gt; comment.body().contains(newEditHash.hex()))
1693                                          .collect(Collectors.toList());
1694             assertEquals(1, webrevComments.size());
1695 
1696             // Check that sender address is set properly
1697             var mailmanServer = MailingListServerFactory.createMailmanServer(listServer.getArchive(), listServer.getSMTP(), Duration.ZERO);
1698             var mailmanList = mailmanServer.getList(listAddress.address());
1699             var conversations = mailmanList.conversations(Duration.ofDays(1));
1700             assertEquals(1, conversations.size());
1701             for (var newMail : conversations.get(0).allMessages()) {
1702                 assertEquals(noreplyAddress(archive), newMail.author().address());
1703                 assertEquals(listAddress, newMail.sender());
1704                 assertFalse(newMail.hasHeader(&quot;PR-Head-Hash&quot;));
1705             }
1706             assertEquals(&quot;[Rev 01] RFR: This is a pull request&quot;, conversations.get(0).allMessages().get(1).subject());
1707         }
1708     }
1709 
1710     @Test
1711     void incrementalAfterRebase(TestInfo testInfo) throws IOException {
1712         try (var credentials = new HostCredentials(testInfo);
1713              var tempFolder = new TemporaryDirectory();
1714              var archiveFolder = new TemporaryDirectory();
1715              var listServer = new TestMailmanServer();
1716              var webrevServer = new TestWebrevServer()) {
1717             var author = credentials.getHostedRepository();
1718             var archive = credentials.getHostedRepository();
1719             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
1720             var censusBuilder = credentials.getCensusBuilder()
1721                                            .addAuthor(author.forge().currentUser().id());
1722             var sender = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
1723             var mlBot = MailingListBridgeBot.newBuilder()
1724                                             .from(sender)
1725                                             .repo(author)
1726                                             .archive(archive)
1727                                             .archiveRef(&quot;archive&quot;)
1728                                             .censusRepo(censusBuilder.build())
1729                                             .list(listAddress)
1730                                             .listArchive(listServer.getArchive())
1731                                             .smtpServer(listServer.getSMTP())
1732                                             .webrevStorageRepository(archive)
1733                                             .webrevStorageRef(&quot;webrev&quot;)
1734                                             .webrevStorageBase(Path.of(&quot;test&quot;))
1735                                             .webrevStorageBaseUri(webrevServer.uri())
1736                                             .issueTracker(URIBuilder.base(&quot;http://issues.test/browse/&quot;).build())
1737                                             .build();
1738 
1739             // Populate the projects repository
1740             var reviewFile = Path.of(&quot;reviewfile.txt&quot;);
1741             var localRepo = CheckableRepository.init(tempFolder.path().resolve(&quot;first&quot;), author.repositoryType(), reviewFile);
1742             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
1743             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
1744             localRepo.push(masterHash, archive.url(), &quot;webrev&quot;, true);
1745             localRepo.push(masterHash, archive.url(), &quot;archive&quot;, true);
1746 
1747             // Make a change with a corresponding PR
1748             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;A line&quot;, &quot;Original msg&quot;);
1749             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
1750             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
1751             pr.setBody(&quot;This is now ready&quot;);
1752 
1753             // Run an archive pass
1754             TestBotRunner.runPeriodicItems(mlBot);
1755             listServer.processIncoming();
1756 
1757             // Push more stuff to master
1758             localRepo.checkout(masterHash, true);
1759             var unrelatedFile = localRepo.root().resolve(&quot;unrelated.txt&quot;);
1760             Files.writeString(unrelatedFile, &quot;Other things happens in master&quot;);
1761             localRepo.add(unrelatedFile);
1762             var newMasterHash = localRepo.commit(&quot;Unrelated change&quot;, &quot;duke&quot;, &quot;duke@openjdk.org&quot;);
1763             localRepo.push(newMasterHash, author.url(), &quot;master&quot;);
1764 
1765             // And more stuff to the pr branch
1766             localRepo.checkout(editHash, true);
1767             CheckableRepository.appendAndCommit(localRepo, &quot;Another line&quot;, &quot;More updates&quot;);
1768 
1769             // Merge master
1770             localRepo.merge(newMasterHash);
1771             var newEditHash = localRepo.commit(&quot;Latest changes from master&quot;, &quot;duke&quot;, &quot;duke@openjdk.org&quot;);
1772             localRepo.push(newEditHash, author.url(), &quot;edit&quot;);
1773 
1774             // Make sure that the push registered
1775             var lastHeadHash = pr.headHash();
1776             var refreshCount = 0;
1777             do {
1778                 pr = author.pullRequest(pr.id());
1779                 if (refreshCount++ &gt; 100) {
1780                     fail(&quot;The PR did not update after the new push&quot;);
1781                 }
1782             } while (pr.headHash().equals(lastHeadHash));
1783 
1784             // Run another archive pass
1785             TestBotRunner.runPeriodicItems(mlBot);
1786             listServer.processIncoming();
1787 
1788             // The archive should reference the rebased push
1789             Repository.materialize(archiveFolder.path(), archive.url(), &quot;archive&quot;);
1790             assertTrue(archiveContains(archiveFolder.path(), &quot;has updated the pull request with a new target base&quot;));
1791             assertTrue(archiveContains(archiveFolder.path(), &quot;excludes&quot;));
1792             assertTrue(archiveContains(archiveFolder.path(), pr.id() + &quot;/webrev.01&quot;));
1793             assertTrue(archiveContains(archiveFolder.path(), pr.id() + &quot;/webrev.00-01&quot;));
1794             assertTrue(archiveContains(archiveFolder.path(), &quot;Original msg&quot;));
1795             assertTrue(archiveContains(archiveFolder.path(), &quot;More updates&quot;));
1796         }
1797     }
1798 
1799     @Test
1800     void mergeWebrev(TestInfo testInfo) throws IOException {
1801         try (var credentials = new HostCredentials(testInfo);
1802              var tempFolder = new TemporaryDirectory();
1803              var archiveFolder = new TemporaryDirectory();
1804              var listServer = new TestMailmanServer();
1805              var webrevServer = new TestWebrevServer()) {
1806             var author = credentials.getHostedRepository();
1807             var archive = credentials.getHostedRepository();
1808             var commenter = credentials.getHostedRepository();
1809             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
1810             var censusBuilder = credentials.getCensusBuilder()
1811                                            .addAuthor(author.forge().currentUser().id());
1812             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
1813             var mlBot = MailingListBridgeBot.newBuilder()
1814                                             .from(from)
1815                                             .repo(author)
1816                                             .archive(archive)
1817                                             .archiveRef(&quot;archive&quot;)
1818                                             .censusRepo(censusBuilder.build())
1819                                             .list(listAddress)
1820                                             .listArchive(listServer.getArchive())
1821                                             .smtpServer(listServer.getSMTP())
1822                                             .webrevStorageRepository(archive)
1823                                             .webrevStorageRef(&quot;webrev&quot;)
1824                                             .webrevStorageBase(Path.of(&quot;test&quot;))
1825                                             .webrevStorageBaseUri(webrevServer.uri())
1826                                             .issueTracker(URIBuilder.base(&quot;http://issues.test/browse/&quot;).build())
1827                                             .build();
1828 
1829             // Populate the projects repository
1830             var reviewFile = Path.of(&quot;reviewfile.txt&quot;);
1831             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType(), reviewFile);
1832             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
1833             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
1834             localRepo.push(masterHash, archive.url(), &quot;archive&quot;, true);
1835             localRepo.push(masterHash, archive.url(), &quot;webrev&quot;, true);
1836 
1837             // Create a diverging branch
1838             var editOnlyFile = Path.of(&quot;editonly.txt&quot;);
1839             Files.writeString(localRepo.root().resolve(editOnlyFile), &quot;Only added in the edit&quot;);
1840             localRepo.add(editOnlyFile);
1841             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;Edited&quot;);
1842             localRepo.push(editHash, author.url(), &quot;edit&quot;);
1843 
1844             // Make conflicting changes in the target
1845             localRepo.checkout(masterHash, true);
1846             var masterOnlyFile = Path.of(&quot;masteronly.txt&quot;);
1847             Files.writeString(localRepo.root().resolve(masterOnlyFile), &quot;Only added in master&quot;);
1848             localRepo.add(masterOnlyFile);
1849             var updatedMasterHash = CheckableRepository.appendAndCommit(localRepo, &quot;Master change&quot;);
1850             localRepo.push(updatedMasterHash, author.url(), &quot;master&quot;);
1851 
1852             // Perform the merge - resolve conflicts in our favor
1853             localRepo.merge(editHash, &quot;ours&quot;);
1854             localRepo.commit(&quot;Merged edit&quot;, &quot;duke&quot;, &quot;duke@openjdk.java.net&quot;);
1855             var mergeOnlyFile = Path.of(&quot;mergeonly.txt&quot;);
1856             Files.writeString(localRepo.root().resolve(mergeOnlyFile), &quot;Only added in the merge&quot;);
1857             localRepo.add(mergeOnlyFile);
1858             Files.writeString(localRepo.root().resolve(reviewFile), &quot;Overwriting the conflict resolution&quot;);
1859             localRepo.add(reviewFile);
1860             var appendedCommit = localRepo.amend(&quot;Updated merge commit&quot;, &quot;duke&quot;, &quot;duke@openjdk.java.net&quot;);
1861             localRepo.push(appendedCommit, author.url(), &quot;merge_of_edit&quot;, true);
1862 
1863             // Make a merge PR
1864             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;merge_of_edit&quot;, &quot;Merge edit&quot;);
1865             pr.setBody(&quot;This is now ready&quot;);
1866 
1867             // Run an archive pass
1868             TestBotRunner.runPeriodicItems(mlBot);
1869             listServer.processIncoming();
1870 
1871             // The archive should contain a merge style webrev
1872             Repository.materialize(archiveFolder.path(), archive.url(), &quot;archive&quot;);
1873             assertTrue(archiveContains(archiveFolder.path(), &quot;The webrevs contain the adjustments done while merging with regards to each parent branch:&quot;));
1874             assertTrue(archiveContains(archiveFolder.path(), pr.id() + &quot;/webrev.00.0&quot;));
1875             assertTrue(archiveContains(archiveFolder.path(), &quot;3 lines in 2 files changed: 1 ins; 1 del; 1 mod&quot;));
1876 
1877             // The PR should contain a webrev comment
1878             assertEquals(1, pr.comments().size());
1879             var webrevComment = pr.comments().get(0);
1880             assertTrue(webrevComment.body().contains(&quot;Merge target&quot;));
1881             assertTrue(webrevComment.body().contains(&quot;Merge source&quot;));
1882         }
1883     }
1884 
1885     @Test
1886     void mergeWebrevConflict(TestInfo testInfo) throws IOException {
1887         try (var credentials = new HostCredentials(testInfo);
1888              var tempFolder = new TemporaryDirectory();
1889              var archiveFolder = new TemporaryDirectory();
1890              var listServer = new TestMailmanServer();
1891              var webrevServer = new TestWebrevServer()) {
1892             var author = credentials.getHostedRepository();
1893             var archive = credentials.getHostedRepository();
1894             var commenter = credentials.getHostedRepository();
1895             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
1896             var censusBuilder = credentials.getCensusBuilder()
1897                                            .addAuthor(author.forge().currentUser().id());
1898             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
1899             var mlBot = MailingListBridgeBot.newBuilder()
1900                                             .from(from)
1901                                             .repo(author)
1902                                             .archive(archive)
1903                                             .archiveRef(&quot;archive&quot;)
1904                                             .censusRepo(censusBuilder.build())
1905                                             .list(listAddress)
1906                                             .listArchive(listServer.getArchive())
1907                                             .smtpServer(listServer.getSMTP())
1908                                             .webrevStorageRepository(archive)
1909                                             .webrevStorageRef(&quot;webrev&quot;)
1910                                             .webrevStorageBase(Path.of(&quot;test&quot;))
1911                                             .webrevStorageBaseUri(webrevServer.uri())
1912                                             .issueTracker(URIBuilder.base(&quot;http://issues.test/browse/&quot;).build())
1913                                             .build();
1914 
1915             // Populate the projects repository
1916             var reviewFile = Path.of(&quot;reviewfile.txt&quot;);
1917             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType(), reviewFile);
1918             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
1919             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
1920             localRepo.push(masterHash, archive.url(), &quot;archive&quot;, true);
1921             localRepo.push(masterHash, archive.url(), &quot;webrev&quot;, true);
1922 
1923             // Create a merge
1924             var editOnlyFile = Path.of(&quot;editonly.txt&quot;);
1925             Files.writeString(localRepo.root().resolve(editOnlyFile), &quot;Only added in the edit&quot;);
1926             localRepo.add(editOnlyFile);
1927             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;Edited&quot;);
1928             localRepo.checkout(masterHash, true);
1929             var masterOnlyFile = Path.of(&quot;masteronly.txt&quot;);
1930             Files.writeString(localRepo.root().resolve(masterOnlyFile), &quot;Only added in master&quot;);
1931             localRepo.add(masterOnlyFile);
1932             var updatedMasterHash = CheckableRepository.appendAndCommit(localRepo, &quot;Master change&quot;);
1933             localRepo.push(updatedMasterHash, author.url(), &quot;master&quot;);
1934             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
1935 
1936             // Make a merge PR
1937             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;Merge edit&quot;);
1938             pr.setBody(&quot;This is now ready&quot;);
1939 
1940             // Run an archive pass
1941             TestBotRunner.runPeriodicItems(mlBot);
1942             listServer.processIncoming();
1943 
1944             // The archive should contain a merge style webrev
1945             Repository.materialize(archiveFolder.path(), archive.url(), &quot;archive&quot;);
1946             assertTrue(archiveContains(archiveFolder.path(), &quot;The webrev contains the conflicts with master:&quot;));
1947             assertTrue(archiveContains(archiveFolder.path(), pr.id() + &quot;/webrev.00.conflicts&quot;));
1948             assertTrue(archiveContains(archiveFolder.path(), &quot;2 lines in 2 files changed: 2 ins; 0 del; 0 mod&quot;));
1949 
1950             // The PR should contain a webrev comment
1951             assertEquals(1, pr.comments().size());
1952             var webrevComment = pr.comments().get(0);
1953             assertTrue(webrevComment.body().contains(&quot;Merge conflicts&quot;));
1954         }
1955     }
1956 
1957     @Test
1958     void mergeWebrevNoConflict(TestInfo testInfo) throws IOException {
1959         try (var credentials = new HostCredentials(testInfo);
1960              var tempFolder = new TemporaryDirectory();
1961              var archiveFolder = new TemporaryDirectory();
1962              var listServer = new TestMailmanServer();
1963              var webrevServer = new TestWebrevServer()) {
1964             var author = credentials.getHostedRepository();
1965             var archive = credentials.getHostedRepository();
1966             var commenter = credentials.getHostedRepository();
1967             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
1968             var censusBuilder = credentials.getCensusBuilder()
1969                                            .addAuthor(author.forge().currentUser().id());
1970             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
1971             var mlBot = MailingListBridgeBot.newBuilder()
1972                                             .from(from)
1973                                             .repo(author)
1974                                             .archive(archive)
1975                                             .archiveRef(&quot;archive&quot;)
1976                                             .censusRepo(censusBuilder.build())
1977                                             .list(listAddress)
1978                                             .listArchive(listServer.getArchive())
1979                                             .smtpServer(listServer.getSMTP())
1980                                             .webrevStorageRepository(archive)
1981                                             .webrevStorageRef(&quot;webrev&quot;)
1982                                             .webrevStorageBase(Path.of(&quot;test&quot;))
1983                                             .webrevStorageBaseUri(webrevServer.uri())
1984                                             .issueTracker(URIBuilder.base(&quot;http://issues.test/browse/&quot;).build())
1985                                             .build();
1986 
1987             // Populate the projects repository
1988             var reviewFile = Path.of(&quot;reviewfile.txt&quot;);
1989             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType(), reviewFile);
1990             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
1991             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
1992             localRepo.push(masterHash, archive.url(), &quot;archive&quot;, true);
1993             localRepo.push(masterHash, archive.url(), &quot;webrev&quot;, true);
1994 
1995             // Create a merge
1996             var editOnlyFile = Path.of(&quot;editonly.txt&quot;);
1997             Files.writeString(localRepo.root().resolve(editOnlyFile), &quot;Only added in the edit&quot;);
1998             localRepo.add(editOnlyFile);
1999             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;Edited&quot;, &quot;Commit in edit branch&quot;);
2000             localRepo.checkout(masterHash, true);
2001             var masterOnlyFile = Path.of(&quot;masteronly.txt&quot;);
2002             Files.writeString(localRepo.root().resolve(masterOnlyFile), &quot;Only added in master&quot;);
2003             localRepo.add(masterOnlyFile);
2004             var updatedMasterHash = localRepo.commit(&quot;Only added in master&quot;, &quot;duke&quot;, &quot;duke@openjdk.java.net&quot;);
2005             localRepo.push(updatedMasterHash, author.url(), &quot;master&quot;);
2006             localRepo.merge(editHash);
2007             var mergeCommit = localRepo.commit(&quot;Merged edit&quot;, &quot;duke&quot;, &quot;duke@openjdk.java.net&quot;);
2008             localRepo.push(mergeCommit, author.url(), &quot;edit&quot;, true);
2009 
2010             // Make a merge PR
2011             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;Merge edit&quot;);
2012             pr.setBody(&quot;This is now ready&quot;);
2013 
2014             // Run an archive pass
2015             TestBotRunner.runPeriodicItems(mlBot);
2016             listServer.processIncoming();
2017 
2018             // The archive should contain a merge style webrev
2019             Repository.materialize(archiveFolder.path(), archive.url(), &quot;archive&quot;);
2020             assertTrue(archiveContains(archiveFolder.path(), &quot;so no merge-specific webrevs have been generated&quot;));
2021 
2022             // The PR should not contain a webrev comment
2023             assertEquals(0, pr.comments().size());
2024         }
2025     }
2026 
2027     @Test
2028     void skipAddingExistingWebrev(TestInfo testInfo) throws IOException {
2029         try (var credentials = new HostCredentials(testInfo);
2030              var tempFolder = new TemporaryDirectory();
2031              var archiveFolder = new TemporaryDirectory();
2032              var webrevFolder = new TemporaryDirectory();
2033              var listServer = new TestMailmanServer();
2034              var webrevServer = new TestWebrevServer()) {
2035             var author = credentials.getHostedRepository();
2036             var archive = credentials.getHostedRepository();
2037             var ignored = credentials.getHostedRepository();
2038             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
2039             var censusBuilder = credentials.getCensusBuilder()
2040                                            .addAuthor(author.forge().currentUser().id());
2041             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
2042             var mlBot = MailingListBridgeBot.newBuilder()
2043                                             .from(from)
2044                                             .repo(author)
2045                                             .archive(archive)
2046                                             .censusRepo(censusBuilder.build())
2047                                             .list(listAddress)
2048                                             .ignoredUsers(Set.of(ignored.forge().currentUser().userName()))
2049                                             .listArchive(listServer.getArchive())
2050                                             .smtpServer(listServer.getSMTP())
2051                                             .webrevStorageRepository(archive)
2052                                             .webrevStorageRef(&quot;webrev&quot;)
2053                                             .webrevStorageBase(Path.of(&quot;test&quot;))
2054                                             .webrevStorageBaseUri(webrevServer.uri())
2055                                             .issueTracker(URIBuilder.base(&quot;http://issues.test/browse/&quot;).build())
2056                                             .build();
2057 
2058             // Populate the projects repository
2059             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType());
2060             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
2061             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
2062             localRepo.push(masterHash, archive.url(), &quot;webrev&quot;, true);
2063 
2064             // Make a change with a corresponding PR
2065             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;A simple change&quot;,
2066                                                                &quot;Change msg\n\nWith several lines&quot;);
2067             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
2068             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
2069 
2070             // Flag it as ready for review
2071             pr.setBody(&quot;This should now be ready&quot;);
2072 
2073             // Run an archive pass
2074             TestBotRunner.runPeriodicItems(mlBot);
2075 
2076             // The archive should now contain an entry
2077             var archiveRepo = Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);
2078             assertTrue(archiveContains(archiveFolder.path(), editHash.abbreviate()));
2079 
2080             // And there should be a webrev comment
2081             var comments = pr.comments();
2082             var webrevComments = comments.stream()
2083                                          .filter(comment -&gt; comment.author().equals(author.forge().currentUser()))
2084                                          .filter(comment -&gt; comment.body().contains(&quot;webrev&quot;))
2085                                          .filter(comment -&gt; comment.body().contains(editHash.hex()))
2086                                          .collect(Collectors.toList());
2087             assertEquals(1, webrevComments.size());
2088             assertEquals(1, countSubstrings(webrevComments.get(0).body(), &quot;webrev.00&quot;));
2089 
2090             // Pretend the archive didn&#39;t work out
2091             archiveRepo.push(masterHash, archive.url(), &quot;master&quot;, true);
2092 
2093             // Run another archive pass
2094             TestBotRunner.runPeriodicItems(mlBot);
2095 
2096             // The webrev comment should not contain duplicate entries
2097             comments = pr.comments();
2098             webrevComments = comments.stream()
2099                                      .filter(comment -&gt; comment.author().equals(author.forge().currentUser()))
2100                                      .filter(comment -&gt; comment.body().contains(&quot;webrev&quot;))
2101                                      .filter(comment -&gt; comment.body().contains(editHash.hex()))
2102                                      .collect(Collectors.toList());
2103             assertEquals(1, webrevComments.size());
2104             assertEquals(1, countSubstrings(webrevComments.get(0).body(), &quot;webrev.00&quot;));
2105         }
2106     }
2107 
2108     @Test
2109     void notifyReviewVerdicts(TestInfo testInfo) throws IOException {
2110         try (var credentials = new HostCredentials(testInfo);
2111              var tempFolder = new TemporaryDirectory();
2112              var archiveFolder = new TemporaryDirectory();
2113              var listServer = new TestMailmanServer();
2114              var webrevServer = new TestWebrevServer()) {
2115             var author = credentials.getHostedRepository();
2116             var archive = credentials.getHostedRepository();
2117             var reviewer = credentials.getHostedRepository();
2118             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
2119             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
2120             var censusBuilder = credentials.getCensusBuilder()
2121                                            .addReviewer(reviewer.forge().currentUser().id())
2122                                            .addAuthor(author.forge().currentUser().id());
2123             var mlBot = MailingListBridgeBot.newBuilder()
2124                                             .from(from)
2125                                             .repo(author)
2126                                             .archive(archive)
2127                                             .censusRepo(censusBuilder.build())
2128                                             .list(listAddress)
2129                                             .listArchive(listServer.getArchive())
2130                                             .smtpServer(listServer.getSMTP())
2131                                             .webrevStorageRepository(archive)
2132                                             .webrevStorageRef(&quot;webrev&quot;)
2133                                             .webrevStorageBase(Path.of(&quot;test&quot;))
2134                                             .webrevStorageBaseUri(webrevServer.uri())
2135                                             .issueTracker(URIBuilder.base(&quot;http://issues.test/browse/&quot;).build())
2136                                             .build();
2137 
2138             // Populate the projects repository
2139             var reviewFile = Path.of(&quot;reviewfile.txt&quot;);
2140             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType(), reviewFile);
2141             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
2142             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
2143             localRepo.push(masterHash, archive.url(), &quot;webrev&quot;, true);
2144 
2145             // Make a change with a corresponding PR
2146             var editHash = CheckableRepository.appendAndCommit(localRepo);
2147             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
2148             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
2149             pr.setBody(&quot;This is now ready&quot;);
2150 
2151             // Run an archive pass
2152             TestBotRunner.runPeriodicItems(mlBot);
2153 
2154             // First unapprove it
2155             var reviewedPr = reviewer.pullRequest(pr.id());
2156             reviewedPr.addReview(Review.Verdict.DISAPPROVED, &quot;Reason 1&quot;);
2157             TestBotRunner.runPeriodicItems(mlBot);
2158             TestBotRunner.runPeriodicItems(mlBot);
2159             TestBotRunner.runPeriodicItems(mlBot);
2160 
2161             // The archive should contain a note
2162             Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);
2163             assertEquals(1, archiveContainsCount(archiveFolder.path(), &quot;Changes requested by &quot;));
2164             assertEquals(1, archiveContainsCount(archiveFolder.path(), &quot; by integrationreviewer1&quot;));
2165             if (author.forge().supportsReviewBody()) {
2166                 assertEquals(1, archiveContainsCount(archiveFolder.path(), &quot;Reason 1&quot;));
2167             }
2168 
2169             // Then approve it
2170             reviewedPr.addReview(Review.Verdict.APPROVED, &quot;Reason 2&quot;);
2171             TestBotRunner.runPeriodicItems(mlBot);
2172             TestBotRunner.runPeriodicItems(mlBot);
2173             TestBotRunner.runPeriodicItems(mlBot);
2174 
2175             // The archive should contain another note
2176             Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);
2177             assertEquals(1, archiveContainsCount(archiveFolder.path(), &quot;Marked as reviewed by &quot;));
2178             if (author.forge().supportsReviewBody()) {
2179                 assertEquals(1, archiveContainsCount(archiveFolder.path(), &quot;Reason 2&quot;));
2180             }
2181             assertEquals(2, archiveContainsCount(archiveFolder.path(), &quot;Re: RFR:&quot;));
2182 
2183             // Yet another change
2184             reviewedPr.addReview(Review.Verdict.DISAPPROVED, &quot;Reason 3&quot;);
2185             TestBotRunner.runPeriodicItems(mlBot);
2186             TestBotRunner.runPeriodicItems(mlBot);
2187             TestBotRunner.runPeriodicItems(mlBot);
2188 
2189             // The archive should contain another note
2190             Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);
2191             assertEquals(2, archiveContainsCount(archiveFolder.path(), &quot;Changes requested by &quot;));
2192             if (author.forge().supportsReviewBody()) {
2193                 assertEquals(1, archiveContainsCount(archiveFolder.path(), &quot;Reason 3&quot;));
2194             }
2195         }
2196     }
2197 
2198     @Test
2199     void ignoreComments(TestInfo testInfo) throws IOException {
2200         try (var credentials = new HostCredentials(testInfo);
2201              var tempFolder = new TemporaryDirectory();
2202              var archiveFolder = new TemporaryDirectory();
2203              var listServer = new TestMailmanServer();
2204              var webrevServer = new TestWebrevServer()) {
2205             var author = credentials.getHostedRepository();
2206             var ignored = credentials.getHostedRepository();
2207             var archive = credentials.getHostedRepository();
2208             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
2209             var censusBuilder = credentials.getCensusBuilder()
2210                                            .addAuthor(author.forge().currentUser().id());
2211             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
2212             var mlBot = MailingListBridgeBot.newBuilder()
2213                                             .from(from)
2214                                             .repo(author)
2215                                             .archive(archive)
2216                                             .censusRepo(censusBuilder.build())
2217                                             .list(listAddress)
2218                                             .ignoredUsers(Set.of(ignored.forge().currentUser().userName()))
2219                                             .ignoredComments(Set.of(Pattern.compile(&quot;ignore this comment&quot;, Pattern.MULTILINE | Pattern.DOTALL)))
2220                                             .listArchive(listServer.getArchive())
2221                                             .smtpServer(listServer.getSMTP())
2222                                             .webrevStorageRepository(archive)
2223                                             .webrevStorageRef(&quot;webrev&quot;)
2224                                             .webrevStorageBase(Path.of(&quot;test&quot;))
2225                                             .webrevStorageBaseUri(webrevServer.uri())
2226                                             .issueTracker(URIBuilder.base(&quot;http://issues.test/browse/&quot;).build())
2227                                             .build();
2228 
2229             // Populate the projects repository
2230             var reviewFile = Path.of(&quot;reviewfile.txt&quot;);
2231             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType(), reviewFile);
2232             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
2233             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
2234             localRepo.push(masterHash, archive.url(), &quot;webrev&quot;, true);
2235 
2236             // Make a change with a corresponding PR
2237             var editHash = CheckableRepository.appendAndCommit(localRepo);
2238             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
2239             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
2240             pr.setBody(&quot;This is now ready&quot;);
2241 
2242             // Make a bunch of comments
2243             pr.addComment(&quot;Plain comment&quot;);
2244             pr.addComment(&quot;ignore this comment&quot;);
2245             pr.addComment(&quot;I think it is time to\nignore this comment!&quot;);
2246             pr.addReviewComment(masterHash, editHash, reviewFile.toString(), 2, &quot;Review ignore this comment&quot;);
2247 
2248             var ignoredPR = ignored.pullRequest(pr.id());
2249             ignoredPR.addComment(&quot;Don&#39;t mind me&quot;);
2250 
2251             TestBotRunner.runPeriodicItems(mlBot);
2252             TestBotRunner.runPeriodicItems(mlBot);
2253 
2254             // The archive should not contain the ignored comments
2255             Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);
2256             assertTrue(archiveContains(archiveFolder.path(), &quot;This is now ready&quot;));
2257             assertFalse(archiveContains(archiveFolder.path(), &quot;ignore this comment&quot;));
2258             assertFalse(archiveContains(archiveFolder.path(), &quot;it is time to&quot;));
2259             assertFalse(archiveContains(archiveFolder.path(), &quot;Don&#39;t mind me&quot;));
2260             assertFalse(archiveContains(archiveFolder.path(), &quot;Review ignore&quot;));
2261         }
2262     }
2263 
2264     @Test
2265     void replyToEmptyReview(TestInfo testInfo) throws IOException {
2266         try (var credentials = new HostCredentials(testInfo);
2267              var tempFolder = new TemporaryDirectory();
2268              var archiveFolder = new TemporaryDirectory();
2269              var listServer = new TestMailmanServer();
2270              var webrevServer = new TestWebrevServer()) {
2271             var author = credentials.getHostedRepository();
2272             var reviewer = credentials.getHostedRepository();
2273             var archive = credentials.getHostedRepository();
2274             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
2275             var censusBuilder = credentials.getCensusBuilder()
2276                                            .addReviewer(reviewer.forge().currentUser().id())
2277                                            .addAuthor(author.forge().currentUser().id());
2278             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
2279             var mlBot = MailingListBridgeBot.newBuilder()
2280                                             .from(from)
2281                                             .repo(author)
2282                                             .archive(archive)
2283                                             .censusRepo(censusBuilder.build())
2284                                             .list(listAddress)
2285                                             .listArchive(listServer.getArchive())
2286                                             .smtpServer(listServer.getSMTP())
2287                                             .webrevStorageRepository(archive)
2288                                             .webrevStorageRef(&quot;webrev&quot;)
2289                                             .webrevStorageBase(Path.of(&quot;test&quot;))
2290                                             .webrevStorageBaseUri(webrevServer.uri())
2291                                             .issueTracker(URIBuilder.base(&quot;http://issues.test/browse/&quot;).build())
2292                                             .build();
2293 
2294             // Populate the projects repository
2295             var reviewFile = Path.of(&quot;reviewfile.txt&quot;);
2296             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType(), reviewFile);
2297             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
2298             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
2299             localRepo.push(masterHash, archive.url(), &quot;webrev&quot;, true);
2300 
2301             // Make a change with a corresponding PR
2302             var editHash = CheckableRepository.appendAndCommit(localRepo);
2303             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
2304             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
2305             pr.setBody(&quot;This is now ready&quot;);
2306             TestBotRunner.runPeriodicItems(mlBot);
2307             listServer.processIncoming();
2308 
2309             // Make an empty approval
2310             var reviewPr = reviewer.pullRequest(pr.id());
2311             reviewPr.addReview(Review.Verdict.APPROVED, &quot;&quot;);
2312             TestBotRunner.runPeriodicItems(mlBot);
2313             listServer.processIncoming();
2314 
2315             pr.addComment(&quot;Thanks for the review!&quot;);
2316             TestBotRunner.runPeriodicItems(mlBot);
2317             listServer.processIncoming();
2318 
2319             // The approval text should be included in the quote
2320             Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);
2321             assertEquals(1, archiveContainsCount(archiveFolder.path(), &quot;^&gt; Marked as reviewed&quot;));
2322         }
2323     }
2324 
2325     @Test
2326     void cooldown(TestInfo testInfo) throws IOException {
2327         try (var credentials = new HostCredentials(testInfo);
2328              var tempFolder = new TemporaryDirectory();
2329              var archiveFolder = new TemporaryDirectory();
2330              var listServer = new TestMailmanServer();
2331              var webrevServer = new TestWebrevServer()) {
2332             var bot = credentials.getHostedRepository();
2333             var author = credentials.getHostedRepository();
2334             var archive = credentials.getHostedRepository();
2335             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
2336             var censusBuilder = credentials.getCensusBuilder()
2337                                            .addAuthor(author.forge().currentUser().id());
2338             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
2339             var mlBotBuilder = MailingListBridgeBot.newBuilder()
2340                                                    .from(from)
2341                                                    .repo(bot)
2342                                                    .ignoredUsers(Set.of(bot.forge().currentUser().userName()))
2343                                                    .archive(archive)
2344                                                    .censusRepo(censusBuilder.build())
2345                                                    .list(listAddress)
2346                                                    .listArchive(listServer.getArchive())
2347                                                    .smtpServer(listServer.getSMTP())
2348                                                    .webrevStorageRepository(archive)
2349                                                    .webrevStorageRef(&quot;webrev&quot;)
2350                                                    .webrevStorageBase(Path.of(&quot;test&quot;))
2351                                                    .webrevStorageBaseUri(webrevServer.uri())
2352                                                    .issueTracker(URIBuilder.base(&quot;http://issues.test/browse/&quot;).build());
2353 
2354             // Populate the projects repository
2355             var reviewFile = Path.of(&quot;reviewfile.txt&quot;);
2356             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType(), reviewFile);
2357             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
2358             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
2359             localRepo.push(masterHash, archive.url(), &quot;webrev&quot;, true);
2360 
2361             // Make a change with a corresponding PR
2362             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;Line 1\nLine 2\nLine 3\nLine 4&quot;);
2363             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
2364             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
2365             pr.setBody(&quot;This is now ready&quot;);
2366 
2367             var mlBot = mlBotBuilder.build();
2368             var mlBotWithCooldown = mlBotBuilder.cooldown(Duration.ofDays(1)).build();
2369 
2370             TestBotRunner.runPeriodicItems(mlBot);
2371             listServer.processIncoming();
2372 
2373             // Make a comment
2374             pr.addComment(&quot;Looks good&quot;);
2375 
2376             // Bot with cooldown configured should not bridge the comment
2377             TestBotRunner.runPeriodicItems(mlBotWithCooldown);
2378             assertThrows(RuntimeException.class, () -&gt; listServer.processIncoming(Duration.ofMillis(1)));
2379 
2380             // But without, it should
2381             TestBotRunner.runPeriodicItems(mlBot);
2382             listServer.processIncoming();
2383 
2384             // Check the archive
2385             Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);
2386             assertTrue(archiveContains(archiveFolder.path(), &quot;Looks good&quot;));
2387         }
2388     }
2389 
2390     @Test
2391     void cooldownNewRevision(TestInfo testInfo) throws IOException {
2392         try (var credentials = new HostCredentials(testInfo);
2393              var tempFolder = new TemporaryDirectory();
2394              var archiveFolder = new TemporaryDirectory();
2395              var listServer = new TestMailmanServer();
2396              var webrevServer = new TestWebrevServer()) {
2397             var bot = credentials.getHostedRepository();
2398             var author = credentials.getHostedRepository();
2399             var archive = credentials.getHostedRepository();
2400             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
2401             var censusBuilder = credentials.getCensusBuilder()
2402                                            .addAuthor(author.forge().currentUser().id());
2403             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
2404             var mlBotBuilder = MailingListBridgeBot.newBuilder()
2405                                                    .from(from)
2406                                                    .repo(bot)
2407                                                    .ignoredUsers(Set.of(bot.forge().currentUser().userName()))
2408                                                    .archive(archive)
2409                                                    .censusRepo(censusBuilder.build())
2410                                                    .list(listAddress)
2411                                                    .listArchive(listServer.getArchive())
2412                                                    .smtpServer(listServer.getSMTP())
2413                                                    .webrevStorageRepository(archive)
2414                                                    .webrevStorageRef(&quot;webrev&quot;)
2415                                                    .webrevStorageBase(Path.of(&quot;test&quot;))
2416                                                    .webrevStorageBaseUri(webrevServer.uri())
2417                                                    .issueTracker(URIBuilder.base(&quot;http://issues.test/browse/&quot;).build());
2418 
2419             // Populate the projects repository
2420             var reviewFile = Path.of(&quot;reviewfile.txt&quot;);
2421             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType(), reviewFile);
2422             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
2423             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
2424             localRepo.push(masterHash, archive.url(), &quot;webrev&quot;, true);
2425 
2426             // Make a change with a corresponding PR
2427             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;Line 1\nLine 2\nLine 3\nLine 4&quot;);
2428             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
2429             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
2430             pr.setBody(&quot;This is now ready&quot;);
2431 
2432             var mlBot = mlBotBuilder.build();
2433             var mlBotWithCooldown = mlBotBuilder.cooldown(Duration.ofDays(1)).build();
2434 
2435             TestBotRunner.runPeriodicItems(mlBot);
2436             listServer.processIncoming();
2437 
2438             // Commit another revision
2439             var updatedHash = CheckableRepository.appendAndCommit(localRepo, &quot;More stuff&quot;);
2440             localRepo.push(updatedHash, author.url(), &quot;edit&quot;);
2441 
2442             // Bot with cooldown configured should not create a new webrev
2443             TestBotRunner.runPeriodicItems(mlBotWithCooldown);
2444             assertThrows(RuntimeException.class, () -&gt; listServer.processIncoming(Duration.ofMillis(1)));
2445 
2446             // But without, it should
2447             TestBotRunner.runPeriodicItems(mlBot);
2448             listServer.processIncoming();
2449 
2450             // Check the archive
2451             Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);
2452             assertTrue(archiveContains(archiveFolder.path(), &quot;webrev.01&quot;));
2453         }
2454     }
2455 
2456     @Test
2457     void retryAfterCooldown(TestInfo testInfo) throws IOException, InterruptedException {
2458         try (var credentials = new HostCredentials(testInfo);
2459              var tempFolder = new TemporaryDirectory();
2460              var archiveFolder = new TemporaryDirectory();
2461              var listServer = new TestMailmanServer();
2462              var webrevServer = new TestWebrevServer()) {
2463             var bot = credentials.getHostedRepository();
2464             var author = credentials.getHostedRepository();
2465             var archive = credentials.getHostedRepository();
2466             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
2467             var censusBuilder = credentials.getCensusBuilder()
2468                                            .addAuthor(author.forge().currentUser().id());
2469             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
2470             var cooldown = Duration.ofMillis(500);
2471             var mlBotBuilder = MailingListBridgeBot.newBuilder()
2472                                                    .from(from)
2473                                                    .repo(bot)
2474                                                    .ignoredUsers(Set.of(bot.forge().currentUser().userName()))
2475                                                    .archive(archive)
2476                                                    .censusRepo(censusBuilder.build())
2477                                                    .list(listAddress)
2478                                                    .listArchive(listServer.getArchive())
2479                                                    .smtpServer(listServer.getSMTP())
2480                                                    .webrevStorageRepository(archive)
2481                                                    .webrevStorageRef(&quot;webrev&quot;)
2482                                                    .webrevStorageBase(Path.of(&quot;test&quot;))
2483                                                    .webrevStorageBaseUri(webrevServer.uri())
2484                                                    .issueTracker(URIBuilder.base(&quot;http://issues.test/browse/&quot;).build());
2485 
2486             // Populate the projects repository
2487             var reviewFile = Path.of(&quot;reviewfile.txt&quot;);
2488             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType(), reviewFile);
2489             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
2490             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
2491             localRepo.push(masterHash, archive.url(), &quot;webrev&quot;, true);
2492 
2493             // Make a change with a corresponding PR
2494             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;Line 1\nLine 2\nLine 3\nLine 4&quot;);
2495             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
2496             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
2497             pr.setBody(&quot;This is now ready&quot;);
2498 
2499             var mlBot = mlBotBuilder.cooldown(cooldown).build();
2500             Thread.sleep(cooldown.toMillis());
2501             TestBotRunner.runPeriodicItems(mlBot);
2502             listServer.processIncoming();
2503 
2504             // Make a comment and run the check within the cooldown period
2505             int counter;
2506             boolean noMailReceived = false;
2507             for (counter = 1; counter &lt; 10; ++counter) {
2508                 var start = Instant.now();
2509                 pr.addComment(&quot;Looks good - &quot; + counter + &quot; -&quot;);
2510 
2511                 // The bot should not bridge the comment due to cooldown
2512                 TestBotRunner.runPeriodicItems(mlBot);
2513                 try {
2514                     noMailReceived = false;
2515                     listServer.processIncoming(Duration.ofMillis(1));
2516                 } catch (RuntimeException e) {
2517                     noMailReceived = true;
2518                 }
2519                 var elapsed = Duration.between(start, Instant.now());
2520                 if (elapsed.compareTo(cooldown) &lt; 0) {
2521                     break;
2522                 } else {
2523                     log.info(&quot;Didn&#39;t do the test in time - retrying (elapsed: &quot; + elapsed + &quot; required: &quot; + cooldown + &quot;)&quot;);
2524                     // Ensure that the cooldown expires
2525                     Thread.sleep(cooldown.toMillis());
2526                     // If no mail was received, we have to flush it out
2527                     if (noMailReceived) {
2528                         TestBotRunner.runPeriodicItems(mlBot);
2529                         listServer.processIncoming();
2530                     }
2531                     cooldown = cooldown.multipliedBy(2);
2532                     mlBot = mlBotBuilder.cooldown(cooldown).build();
2533                 }
2534             }
2535             assertTrue(noMailReceived);
2536 
2537             // But after the cooldown period has passed, it should
2538             Thread.sleep(cooldown.toMillis());
2539             TestBotRunner.runPeriodicItems(mlBot);
2540             listServer.processIncoming();
2541 
2542             // Check the archive
2543             Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);
2544             assertTrue(archiveContains(archiveFolder.path(), &quot;Looks good - &quot; + counter + &quot; -&quot;));
2545         }
2546     }
2547 
2548     @Test
2549     void branchPrefix(TestInfo testInfo) throws IOException {
2550         try (var credentials = new HostCredentials(testInfo);
2551              var tempFolder = new TemporaryDirectory();
2552              var archiveFolder = new TemporaryDirectory();
2553              var listServer = new TestMailmanServer();
2554              var webrevServer = new TestWebrevServer()) {
2555             var author = credentials.getHostedRepository();
2556             var archive = credentials.getHostedRepository();
2557             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
2558             var censusBuilder = credentials.getCensusBuilder()
2559                                            .addAuthor(author.forge().currentUser().id());
2560             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
2561             var mlBot = MailingListBridgeBot.newBuilder()
2562                                             .from(from)
2563                                             .repo(author)
2564                                             .archive(archive)
2565                                             .censusRepo(censusBuilder.build())
2566                                             .list(listAddress)
2567                                             .listArchive(listServer.getArchive())
2568                                             .smtpServer(listServer.getSMTP())
2569                                             .webrevStorageRepository(archive)
2570                                             .webrevStorageRef(&quot;webrev&quot;)
2571                                             .webrevStorageBase(Path.of(&quot;test&quot;))
2572                                             .webrevStorageBaseUri(webrevServer.uri())
2573                                             .issueTracker(URIBuilder.base(&quot;http://issues.test/browse/&quot;).build())
2574                                             .branchInSubject(Pattern.compile(&quot;.*&quot;))
2575                                             .build();
2576 
2577             // Populate the projects repository
2578             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType());
2579             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
2580             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
2581             localRepo.push(masterHash, archive.url(), &quot;webrev&quot;, true);
2582 
2583             // Make a change with a corresponding PR
2584             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;A simple change&quot;,
2585                                                                &quot;Change msg\n\nWith several lines&quot;);
2586             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
2587             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;1234: This is a pull request&quot;);
2588             pr.setBody(&quot;This is a PR&quot;);
2589 
2590             // Run an archive pass
2591             TestBotRunner.runPeriodicItems(mlBot);
2592             listServer.processIncoming();
2593 
2594             pr.addComment(&quot;Looks good!&quot;);
2595             TestBotRunner.runPeriodicItems(mlBot);
2596             listServer.processIncoming();
2597 
2598             // Check the archive
2599             Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);
2600             assertTrue(archiveContains(archiveFolder.path(), &quot;Subject: \\[master\\] RFR: &quot;));
2601             assertTrue(archiveContains(archiveFolder.path(), &quot;Subject: Re: \\[master\\] RFR: &quot;));
2602         }
2603     }
2604 
2605     @Test
2606     void repoPrefix(TestInfo testInfo) throws IOException {
2607         try (var credentials = new HostCredentials(testInfo);
2608              var tempFolder = new TemporaryDirectory();
2609              var archiveFolder = new TemporaryDirectory();
2610              var listServer = new TestMailmanServer();
2611              var webrevServer = new TestWebrevServer()) {
2612             var author = credentials.getHostedRepository();
2613             var archive = credentials.getHostedRepository();
2614             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
2615             var censusBuilder = credentials.getCensusBuilder()
2616                                            .addAuthor(author.forge().currentUser().id());
2617             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
2618             var mlBot = MailingListBridgeBot.newBuilder()
2619                                             .from(from)
2620                                             .repo(author)
2621                                             .archive(archive)
2622                                             .censusRepo(censusBuilder.build())
2623                                             .list(listAddress)
2624                                             .listArchive(listServer.getArchive())
2625                                             .smtpServer(listServer.getSMTP())
2626                                             .webrevStorageRepository(archive)
2627                                             .webrevStorageRef(&quot;webrev&quot;)
2628                                             .webrevStorageBase(Path.of(&quot;test&quot;))
2629                                             .webrevStorageBaseUri(webrevServer.uri())
2630                                             .issueTracker(URIBuilder.base(&quot;http://issues.test/browse/&quot;).build())
2631                                             .repoInSubject(true)
2632                                             .build();
2633 
2634             // Populate the projects repository
2635             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType());
2636             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
2637             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
2638             localRepo.push(masterHash, archive.url(), &quot;webrev&quot;, true);
2639 
2640             // Make a change with a corresponding PR
2641             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;A simple change&quot;,
2642                                                                &quot;Change msg\n\nWith several lines&quot;);
2643             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
2644             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;1234: This is a pull request&quot;);
2645             pr.setBody(&quot;This is a PR&quot;);
2646 
2647             // Run an archive pass
2648             TestBotRunner.runPeriodicItems(mlBot);
2649             listServer.processIncoming();
2650 
2651             pr.addComment(&quot;Looks good!&quot;);
2652             TestBotRunner.runPeriodicItems(mlBot);
2653             listServer.processIncoming();
2654 
2655             // Check the archive
2656             Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);
2657             assertTrue(archiveContains(archiveFolder.path(), &quot;Subject: \\[&quot; + pr.repository().name() + &quot;\\] RFR: &quot;));
2658             assertTrue(archiveContains(archiveFolder.path(), &quot;Subject: Re: \\[&quot; + pr.repository().name() + &quot;\\] RFR: &quot;));
2659         }
2660     }
2661 
2662     @Test
2663     void repoAndBranchPrefix(TestInfo testInfo) throws IOException {
2664         try (var credentials = new HostCredentials(testInfo);
2665              var tempFolder = new TemporaryDirectory();
2666              var archiveFolder = new TemporaryDirectory();
2667              var listServer = new TestMailmanServer();
2668              var webrevServer = new TestWebrevServer()) {
2669             var author = credentials.getHostedRepository();
2670             var archive = credentials.getHostedRepository();
2671             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
2672             var censusBuilder = credentials.getCensusBuilder()
2673                                            .addAuthor(author.forge().currentUser().id());
2674             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
2675             var mlBot = MailingListBridgeBot.newBuilder()
2676                                             .from(from)
2677                                             .repo(author)
2678                                             .archive(archive)
2679                                             .censusRepo(censusBuilder.build())
2680                                             .list(listAddress)
2681                                             .listArchive(listServer.getArchive())
2682                                             .smtpServer(listServer.getSMTP())
2683                                             .webrevStorageRepository(archive)
2684                                             .webrevStorageRef(&quot;webrev&quot;)
2685                                             .webrevStorageBase(Path.of(&quot;test&quot;))
2686                                             .webrevStorageBaseUri(webrevServer.uri())
2687                                             .issueTracker(URIBuilder.base(&quot;http://issues.test/browse/&quot;).build())
2688                                             .repoInSubject(true)
2689                                             .branchInSubject(Pattern.compile(&quot;.*&quot;))
2690                                             .build();
2691 
2692             // Populate the projects repository
2693             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType());
2694             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
2695             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
2696             localRepo.push(masterHash, archive.url(), &quot;webrev&quot;, true);
2697 
2698             // Make a change with a corresponding PR
2699             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;A simple change&quot;,
2700                                                                &quot;Change msg\n\nWith several lines&quot;);
2701             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
2702             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;1234: This is a pull request&quot;);
2703             pr.setBody(&quot;This is a PR&quot;);
2704 
2705             // Run an archive pass
2706             TestBotRunner.runPeriodicItems(mlBot);
2707             listServer.processIncoming();
2708 
2709             pr.addComment(&quot;Looks good!&quot;);
2710             TestBotRunner.runPeriodicItems(mlBot);
2711             listServer.processIncoming();
2712 
2713             // Check the archive
2714             Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);
2715             assertTrue(archiveContains(archiveFolder.path(), &quot;Subject: \\[&quot; + pr.repository().name() + &quot;:master\\] RFR: &quot;));
2716             assertTrue(archiveContains(archiveFolder.path(), &quot;Subject: Re: \\[&quot; + pr.repository().name() + &quot;:master\\] RFR: &quot;));
2717         }
2718     }
2719 
2720     @Test
2721     void retryNewRevisionAfterCooldown(TestInfo testInfo) throws IOException, InterruptedException {
2722         try (var credentials = new HostCredentials(testInfo);
2723              var tempFolder = new TemporaryDirectory();
2724              var archiveFolder = new TemporaryDirectory();
2725              var listServer = new TestMailmanServer();
2726              var webrevServer = new TestWebrevServer()) {
2727             var bot = credentials.getHostedRepository();
2728             var author = credentials.getHostedRepository();
2729             var archive = credentials.getHostedRepository();
2730             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
2731             var censusBuilder = credentials.getCensusBuilder()
2732                                            .addAuthor(author.forge().currentUser().id());
2733             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
2734             var cooldown = Duration.ofMillis(500);
2735             var mlBotBuilder = MailingListBridgeBot.newBuilder()
2736                                                    .from(from)
2737                                                    .repo(bot)
2738                                                    .ignoredUsers(Set.of(bot.forge().currentUser().userName()))
2739                                                    .archive(archive)
2740                                                    .censusRepo(censusBuilder.build())
2741                                                    .list(listAddress)
2742                                                    .listArchive(listServer.getArchive())
2743                                                    .smtpServer(listServer.getSMTP())
2744                                                    .webrevStorageRepository(archive)
2745                                                    .webrevStorageRef(&quot;webrev&quot;)
2746                                                    .webrevStorageBase(Path.of(&quot;test&quot;))
2747                                                    .webrevStorageBaseUri(webrevServer.uri())
2748                                                    .issueTracker(URIBuilder.base(&quot;http://issues.test/browse/&quot;).build());
2749 
2750             // Populate the projects repository
2751             var reviewFile = Path.of(&quot;reviewfile.txt&quot;);
2752             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType(), reviewFile);
2753             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
2754             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
2755             localRepo.push(masterHash, archive.url(), &quot;webrev&quot;, true);
2756 
2757             // Make a change with a corresponding PR
2758             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;Line 1\nLine 2\nLine 3\nLine 4&quot;);
2759             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
2760             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
2761             pr.setBody(&quot;This is now ready&quot;);
2762 
2763             var mlBot = mlBotBuilder.cooldown(cooldown).build();
2764             Thread.sleep(cooldown.toMillis());
2765             TestBotRunner.runPeriodicItems(mlBot);
2766             listServer.processIncoming();
2767 
2768             // Make a new revision and run the check within the cooldown period
2769             int counter;
2770             boolean noMailReceived = false;
2771             for (counter = 1; counter &lt; 10; ++counter) {
2772                 var start = Instant.now();
2773                 var revHash = CheckableRepository.appendAndCommit(localRepo, &quot;more stuff&quot;, &quot;Update number - &quot; + counter + &quot; -&quot;);
2774                 localRepo.push(revHash, author.url(), &quot;edit&quot;);
2775 
2776                 // The bot should not bridge the new revision due to cooldown
2777                 TestBotRunner.runPeriodicItems(mlBot);
2778                 try {
2779                     noMailReceived = false;
2780                     listServer.processIncoming(Duration.ofMillis(1));
2781                 } catch (RuntimeException e) {
2782                     noMailReceived = true;
2783                 }
2784                 var elapsed = Duration.between(start, Instant.now());
2785                 if (elapsed.compareTo(cooldown) &lt; 0) {
2786                     break;
2787                 } else {
2788                     log.info(&quot;Didn&#39;t do the test in time - retrying (elapsed: &quot; + elapsed + &quot; required: &quot; + cooldown + &quot;)&quot;);
2789                     // Ensure that the cooldown expires
2790                     Thread.sleep(cooldown.toMillis());
2791                     // If no mail was received, we have to flush it out
2792                     if (noMailReceived) {
2793                         TestBotRunner.runPeriodicItems(mlBot);
2794                         listServer.processIncoming();
2795                     }
2796                     cooldown = cooldown.multipliedBy(2);
2797                     mlBot = mlBotBuilder.cooldown(cooldown).build();
2798                 }
2799             }
2800             assertTrue(noMailReceived);
2801 
2802             // But after the cooldown period has passed, it should
2803             Thread.sleep(cooldown.toMillis());
2804             TestBotRunner.runPeriodicItems(mlBot);
2805             listServer.processIncoming();
2806 
2807             // Check the archive
2808             Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);
2809             assertTrue(archiveContains(archiveFolder.path(), &quot;Update number - &quot; + counter + &quot; -&quot;));
2810         }
2811     }
2812 }
    </pre>
  </body>
</html>