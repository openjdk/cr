<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Frames bots/mlbridge/src/test/java/org/openjdk/skara/bots/mlbridge/MailingListBridgeBotTests.java</title>
    <link rel="stylesheet" href="../../../../../../../../../../style.css" />
    <script type="text/javascript" src="../../../../../../../../../../navigation.js"></script>
  </head>
<body onkeypress="keypress(event);">
<a name="0"></a>
<hr />
<pre>   1 /*
   2  * Copyright (c) 2019, Oracle and/or its affiliates. All rights reserved.
   3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   4  *
   5  * This code is free software; you can redistribute it and/or modify it
   6  * under the terms of the GNU General Public License version 2 only, as
   7  * published by the Free Software Foundation.
   8  *
   9  * This code is distributed in the hope that it will be useful, but WITHOUT
  10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
  11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
  12  * version 2 for more details (a copy is included in the LICENSE file that
  13  * accompanied this code).
  14  *
  15  * You should have received a copy of the GNU General Public License version
  16  * 2 along with this work; if not, write to the Free Software Foundation,
  17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
  18  *
  19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
  20  * or visit www.oracle.com if you need additional information or have any
  21  * questions.
  22  */
  23 package org.openjdk.skara.bots.mlbridge;
  24 
  25 import org.openjdk.skara.email.EmailAddress;
  26 import org.openjdk.skara.forge.*;
  27 import org.openjdk.skara.issuetracker.Issue;
  28 import org.openjdk.skara.network.URIBuilder;
  29 import org.openjdk.skara.mailinglist.MailingListServerFactory;
  30 import org.openjdk.skara.test.*;
  31 import org.openjdk.skara.vcs.Repository;
  32 
  33 import org.junit.jupiter.api.*;
  34 
  35 import java.io.IOException;
  36 import java.nio.charset.StandardCharsets;
  37 import java.nio.file.*;
  38 import java.time.*;
  39 import java.util.*;
  40 import java.util.logging.Logger;
  41 import java.util.regex.Pattern;
  42 import java.util.stream.Collectors;
  43 
  44 import static org.junit.jupiter.api.Assertions.*;
  45 
  46 class MailingListBridgeBotTests {
  47     private final Logger log = Logger.getLogger(&quot;org.openjdk.skara.bots.mlbridge.test&quot;);
  48 
  49     private Optional&lt;String&gt; archiveContents(Path archive) {
  50         try {
  51             var mbox = Files.find(archive, 50, (path, attrs) -&gt; path.toString().endsWith(&quot;.mbox&quot;)).findAny();
  52             if (mbox.isEmpty()) {
  53                 return Optional.empty();
  54             }
  55             return Optional.of(Files.readString(mbox.get(), StandardCharsets.UTF_8));
  56         } catch (IOException e) {
  57             return Optional.empty();
  58         }
  59 
  60     }
  61 
  62     private boolean archiveContains(Path archive, String text) {
  63         return archiveContainsCount(archive, text) &gt; 0;
  64     }
  65 
  66     private int archiveContainsCount(Path archive, String text) {
  67         var lines = archiveContents(archive);
  68         if (lines.isEmpty()) {
  69             return 0;
  70         }
  71         var pattern = Pattern.compile(text);
  72         int count = 0;
  73         for (var line : lines.get().split(&quot;\\R&quot;)) {
  74             var matcher = pattern.matcher(line);
  75             if (matcher.find()) {
  76                 count++;
  77             }
  78         }
  79         return count;
  80     }
  81 
  82     private boolean webrevContains(Path webrev, String text) {
  83         try {
  84             var index = Files.find(webrev, 5, (path, attrs) -&gt; path.toString().endsWith(&quot;index.html&quot;)).findAny();
  85             if (index.isEmpty()) {
  86                 return false;
  87             }
  88             var lines = Files.readString(index.get(), StandardCharsets.UTF_8);
  89             return lines.contains(text);
  90         } catch (IOException e) {
  91             return false;
  92         }
  93     }
  94 
  95     private long countSubstrings(String string, String substring) {
  96         return Pattern.compile(substring).matcher(string).results().count();
  97     }
  98 
  99     private String noreplyAddress(HostedRepository repository) {
 100         return &quot;test+&quot; + repository.forge().currentUser().id() + &quot;+&quot; +
 101                 repository.forge().currentUser().userName() +
 102                 &quot;@openjdk.java.net&quot;;
 103     }
 104 
 105     @Test
 106     void simpleArchive(TestInfo testInfo) throws IOException {
 107         try (var credentials = new HostCredentials(testInfo);
 108              var tempFolder = new TemporaryDirectory();
 109              var archiveFolder = new TemporaryDirectory();
 110              var webrevFolder = new TemporaryDirectory();
 111              var listServer = new TestMailmanServer();
 112              var webrevServer = new TestWebrevServer()) {
 113             var author = credentials.getHostedRepository();
 114             var archive = credentials.getHostedRepository();
 115             var ignored = credentials.getHostedRepository();
 116             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
 117             var censusBuilder = credentials.getCensusBuilder()
 118                                            .addAuthor(author.forge().currentUser().id());
 119             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
 120             var mlBot = MailingListBridgeBot.newBuilder()
 121                                             .from(from)
 122                                             .repo(author)
 123                                             .archive(archive)
 124                                             .censusRepo(censusBuilder.build())
 125                                             .list(listAddress)
 126                                             .ignoredUsers(Set.of(ignored.forge().currentUser().userName()))
 127                                             .ignoredComments(Set.of())
 128                                             .listArchive(listServer.getArchive())
 129                                             .smtpServer(listServer.getSMTP())
 130                                             .webrevStorageRepository(archive)
 131                                             .webrevStorageRef(&quot;webrev&quot;)
 132                                             .webrevStorageBase(Path.of(&quot;test&quot;))
 133                                             .webrevStorageBaseUri(webrevServer.uri())
 134                                             .readyLabels(Set.of(&quot;rfr&quot;))
 135                                             .readyComments(Map.of(ignored.forge().currentUser().userName(), Pattern.compile(&quot;ready&quot;)))
 136                                             .issueTracker(URIBuilder.base(&quot;http://issues.test/browse/&quot;).build())
 137                                             .headers(Map.of(&quot;Extra1&quot;, &quot;val1&quot;, &quot;Extra2&quot;, &quot;val2&quot;))
 138                                             .sendInterval(Duration.ZERO)
 139                                             .build();
 140 
 141             // Populate the projects repository
 142             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType());
 143             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
 144             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
 145             localRepo.push(masterHash, archive.url(), &quot;webrev&quot;, true);
 146 
 147             // Make a change with a corresponding PR
 148             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;A simple change&quot;,
 149                                                                &quot;Change msg\n\nWith several lines&quot;);
 150             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
 151             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;1234: This is a pull request&quot;);
 152             pr.setBody(&quot;This should not be ready&quot;);
 153 
 154             // Run an archive pass
 155             TestBotRunner.runPeriodicItems(mlBot);
 156 
 157             // A PR that isn&#39;t ready for review should not be archived
 158             Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);
 159             assertFalse(archiveContains(archiveFolder.path(), &quot;This is a pull request&quot;));
 160 
 161             // Flag it as ready for review
 162             pr.setBody(&quot;This should now be ready&quot;);
 163             pr.addLabel(&quot;rfr&quot;);
 164 
 165             // Run another archive pass
 166             TestBotRunner.runPeriodicItems(mlBot);
 167 
 168             // But it should still not be archived
 169             Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);
 170             assertFalse(archiveContains(archiveFolder.path(), &quot;This is a pull request&quot;));
 171 
 172             // Now post a general comment - not a ready marker
 173             var ignoredPr = ignored.pullRequest(pr.id());
 174             ignoredPr.addComment(&quot;hello there&quot;);
 175 
 176             // Run another archive pass
 177             TestBotRunner.runPeriodicItems(mlBot);
 178 
 179             // It should still not be archived
 180             Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);
 181             assertFalse(archiveContains(archiveFolder.path(), &quot;This is a pull request&quot;));
 182 
 183             // Now post a ready comment
 184             ignoredPr.addComment(&quot;ready&quot;);
 185 
 186             // Run another archive pass
 187             TestBotRunner.runPeriodicItems(mlBot);
 188 
 189             // The archive should now contain an entry
 190             Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);
 191             assertTrue(archiveContains(archiveFolder.path(), &quot;This is a pull request&quot;));
 192             assertTrue(archiveContains(archiveFolder.path(), &quot;This should now be ready&quot;));
 193             assertTrue(archiveContains(archiveFolder.path(), &quot;Patch:&quot;));
 194             assertTrue(archiveContains(archiveFolder.path(), &quot;Changes:&quot;));
 195             assertTrue(archiveContains(archiveFolder.path(), &quot;Webrev:&quot;));
 196             assertTrue(archiveContains(archiveFolder.path(), webrevServer.uri().toString()));
 197             assertTrue(archiveContains(archiveFolder.path(), &quot;webrev.00&quot;));
 198             assertTrue(archiveContains(archiveFolder.path(), &quot;Issue:&quot;));
 199             assertTrue(archiveContains(archiveFolder.path(), &quot;http://issues.test/browse/TSTPRJ-1234&quot;));
 200             assertTrue(archiveContains(archiveFolder.path(), &quot;Fetch:&quot;));
 201             assertTrue(archiveContains(archiveFolder.path(), &quot;^ - Change msg&quot;));
 202             assertFalse(archiveContains(archiveFolder.path(), &quot;With several lines&quot;));
 203 
 204             // The mailing list as well
 205             listServer.processIncoming();
 206             var mailmanServer = MailingListServerFactory.createMailmanServer(listServer.getArchive(), listServer.getSMTP(), Duration.ZERO);
 207             var mailmanList = mailmanServer.getList(listAddress.address());
 208             var conversations = mailmanList.conversations(Duration.ofDays(1));
 209             assertEquals(1, conversations.size());
 210             var mail = conversations.get(0).first();
 211             assertEquals(&quot;RFR: 1234: This is a pull request&quot;, mail.subject());
 212             assertEquals(pr.author().fullName(), mail.author().fullName().orElseThrow());
 213             assertEquals(noreplyAddress(archive), mail.author().address());
 214             assertEquals(listAddress, mail.sender());
 215             assertEquals(&quot;val1&quot;, mail.headerValue(&quot;Extra1&quot;));
 216             assertEquals(&quot;val2&quot;, mail.headerValue(&quot;Extra2&quot;));
 217 
 218             // And there should be a webrev
 219             Repository.materialize(webrevFolder.path(), archive.url(), &quot;webrev&quot;);
 220             assertTrue(webrevContains(webrevFolder.path(), &quot;1 lines changed&quot;));
 221             var comments = pr.comments();
 222             var webrevComments = comments.stream()
 223                                          .filter(comment -&gt; comment.author().equals(author.forge().currentUser()))
 224                                          .filter(comment -&gt; comment.body().contains(&quot;webrev&quot;))
 225                                          .filter(comment -&gt; comment.body().contains(editHash.hex()))
 226                                          .collect(Collectors.toList());
 227             assertEquals(1, webrevComments.size());
 228 
 229             // Add a comment
 230             pr.addComment(&quot;This is a comment :smile:&quot;);
 231 
 232             // Add a comment from an ignored user as well
 233             ignoredPr.addComment(&quot;Don&#39;t mind me&quot;);
 234 
 235             // Run another archive pass
 236             TestBotRunner.runPeriodicItems(mlBot);
 237 
 238             // The archive should now contain the comment, but not the ignored one
 239             Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);
 240             assertTrue(archiveContains(archiveFolder.path(), &quot;This is a comment&quot;));
 241             assertTrue(archiveContains(archiveFolder.path(), &quot;&gt; This should now be ready&quot;));
 242             assertFalse(archiveContains(archiveFolder.path(), &quot;Don&#39;t mind me&quot;));
 243 
 244             listServer.processIncoming();
 245             conversations = mailmanList.conversations(Duration.ofDays(1));
 246             assertEquals(1, conversations.size());
 247             assertEquals(2, conversations.get(0).allMessages().size());
 248 
 249             // Remove the rfr flag and post another comment
 250             pr.addLabel(&quot;rfr&quot;);
 251             pr.addComment(&quot;This is another comment&quot;);
 252 
 253             // Run another archive pass
 254             TestBotRunner.runPeriodicItems(mlBot);
 255 
 256             // The archive should contain the additional comment
 257             Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);
 258             assertTrue(archiveContains(archiveFolder.path(), &quot;This is another comment&quot;));
 259             assertTrue(archiveContains(archiveFolder.path(), &quot;&gt;&gt; This should now be ready&quot;));
 260 
 261             listServer.processIncoming();
 262             conversations = mailmanList.conversations(Duration.ofDays(1));
 263             assertEquals(1, conversations.size());
 264             assertEquals(3, conversations.get(0).allMessages().size());
 265             for (var newMail : conversations.get(0).allMessages()) {
 266                 assertEquals(noreplyAddress(archive), newMail.author().address());
 267                 assertEquals(listAddress, newMail.sender());
 268             }
 269             assertTrue(conversations.get(0).allMessages().get(2).body().contains(&quot;This is a comment ðŸ˜„&quot;));
 270         }
 271     }
 272 
 273     @Test
 274     void archiveIntegrated(TestInfo testInfo) throws IOException {
 275         try (var credentials = new HostCredentials(testInfo);
 276              var tempFolder = new TemporaryDirectory();
 277              var archiveFolder = new TemporaryDirectory();
 278              var webrevFolder = new TemporaryDirectory();
 279              var listServer = new TestMailmanServer();
 280              var webrevServer = new TestWebrevServer()) {
 281             var author = credentials.getHostedRepository();
 282             var archive = credentials.getHostedRepository();
 283             var ignored = credentials.getHostedRepository();
 284             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
 285             var censusBuilder = credentials.getCensusBuilder()
 286                                            .addAuthor(author.forge().currentUser().id());
 287             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
 288             var mlBot = MailingListBridgeBot.newBuilder()
 289                                             .from(from)
 290                                             .repo(author)
 291                                             .archive(archive)
 292                                             .censusRepo(censusBuilder.build())
 293                                             .list(listAddress)
 294                                             .ignoredUsers(Set.of(ignored.forge().currentUser().userName()))
 295                                             .listArchive(listServer.getArchive())
 296                                             .smtpServer(listServer.getSMTP())
 297                                             .webrevStorageRepository(archive)
 298                                             .webrevStorageRef(&quot;webrev&quot;)
 299                                             .webrevStorageBase(Path.of(&quot;test&quot;))
 300                                             .webrevStorageBaseUri(webrevServer.uri())
 301                                             .issueTracker(URIBuilder.base(&quot;http://issues.test/browse/&quot;).build())
 302                                             .build();
 303 
 304             // Populate the projects repository
 305             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType());
 306             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
 307             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
 308             localRepo.push(masterHash, archive.url(), &quot;webrev&quot;, true);
 309 
 310             // Make a change with a corresponding PR
 311             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;A simple change&quot;,
 312                                                                &quot;Change msg\n\nWith several lines&quot;);
 313             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
 314             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;1234: This is a pull request&quot;);
 315             pr.setBody(&quot;This should not be ready&quot;);
 316             pr.setState(Issue.State.CLOSED);
 317 
 318             // Run an archive pass
 319             TestBotRunner.runPeriodicItems(mlBot);
 320             TestBotRunner.runPeriodicItems(mlBot);
 321 
 322             // A PR that isn&#39;t ready for review should not be archived
 323             Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);
 324             assertFalse(archiveContains(archiveFolder.path(), &quot;This is a pull request&quot;));
 325 
 326             // Flag it as ready for review
 327             pr.setBody(&quot;This has already been integrated&quot;);
 328             pr.addLabel(&quot;integrated&quot;);
 329 
 330             // Run another archive pass
 331             TestBotRunner.runPeriodicItems(mlBot);
 332 
 333             // The archive should now contain an entry
 334             Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);
 335             assertTrue(archiveContains(archiveFolder.path(), &quot;Subject: FYI: 1234: This is a pull request&quot;));
 336 
 337             var updatedHash = CheckableRepository.appendAndCommit(localRepo, &quot;Another change&quot;);
 338             localRepo.push(updatedHash, author.url(), &quot;edit&quot;);
 339 
 340             // Run another archive pass
 341             TestBotRunner.runPeriodicItems(mlBot);
 342 
 343             // The archive should now contain another entry
 344             Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);
 345             assertTrue(archiveContains(archiveFolder.path(), &quot;Subject: Re: \\[Rev 01\\] FYI: 1234: This is a pull request&quot;));
<a name="1" id="anc1"></a>
 346         }
 347     }
 348 
 349     @Test
 350     void archiveIntegratedRetainPrefix(TestInfo testInfo) throws IOException {
 351         try (var credentials = new HostCredentials(testInfo);
 352              var tempFolder = new TemporaryDirectory();
 353              var archiveFolder = new TemporaryDirectory();
 354              var webrevFolder = new TemporaryDirectory();
 355              var listServer = new TestMailmanServer();
 356              var webrevServer = new TestWebrevServer()) {
 357             var author = credentials.getHostedRepository();
 358             var archive = credentials.getHostedRepository();
 359             var ignored = credentials.getHostedRepository();
 360             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
 361             var censusBuilder = credentials.getCensusBuilder()
 362                                            .addAuthor(author.forge().currentUser().id());
 363             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
 364             var mlBot = MailingListBridgeBot.newBuilder()
 365                                             .from(from)
 366                                             .repo(author)
 367                                             .archive(archive)
 368                                             .censusRepo(censusBuilder.build())
 369                                             .list(listAddress)
 370                                             .ignoredUsers(Set.of(ignored.forge().currentUser().userName()))
 371                                             .listArchive(listServer.getArchive())
 372                                             .smtpServer(listServer.getSMTP())
 373                                             .webrevStorageRepository(archive)
 374                                             .webrevStorageRef(&quot;webrev&quot;)
 375                                             .webrevStorageBase(Path.of(&quot;test&quot;))
 376                                             .webrevStorageBaseUri(webrevServer.uri())
 377                                             .readyLabels(Set.of(&quot;rfr&quot;))
 378                                             .issueTracker(URIBuilder.base(&quot;http://issues.test/browse/&quot;).build())
 379                                             .build();
 380 
 381             // Populate the projects repository
 382             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType());
 383             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
 384             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
 385             localRepo.push(masterHash, archive.url(), &quot;webrev&quot;, true);
 386 
 387             // Make a change with a corresponding PR
 388             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;A simple change&quot;,
 389                                                                &quot;Change msg\n\nWith several lines&quot;);
 390             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
 391             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;1234: This is a pull request&quot;);
 392             pr.setBody(&quot;This should be ready&quot;);
 393 
 394             // Run an archive pass
 395             TestBotRunner.runPeriodicItems(mlBot);
 396             TestBotRunner.runPeriodicItems(mlBot);
 397 
 398             // A PR that isn&#39;t ready for review should not be archived
 399             Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);
 400             assertFalse(archiveContains(archiveFolder.path(), &quot;This is a pull request&quot;));
 401 
 402             // Flag it as ready for review
 403             pr.addLabel(&quot;rfr&quot;);
 404 
 405             // Run another archive pass
 406             TestBotRunner.runPeriodicItems(mlBot);
 407 
 408             // The archive should now contain an entry
 409             Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);
 410             assertTrue(archiveContains(archiveFolder.path(), &quot;Subject: RFR: 1234: This is a pull request&quot;));
 411 
 412             // Close it and then push another change
 413             pr.setState(Issue.State.CLOSED);
 414             var updatedHash = CheckableRepository.appendAndCommit(localRepo, &quot;Another change&quot;);
 415             localRepo.push(updatedHash, author.url(), &quot;edit&quot;);
 416 
 417             // Run another archive pass
 418             TestBotRunner.runPeriodicItems(mlBot);
 419 
 420             // The archive should now contain another entry - should retain the RFR thread prefix
 421             Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);
 422             assertTrue(archiveContains(archiveFolder.path(), &quot;Subject: Re: \\[Rev 01\\] RFR: 1234: This is a pull request&quot;));
 423         }
 424     }
 425 
<a name="2" id="anc2"></a>

















































































 426     @Test
 427     void archiveFailedAutoMerge(TestInfo testInfo) throws IOException {
 428         try (var credentials = new HostCredentials(testInfo);
 429              var tempFolder = new TemporaryDirectory();
 430              var archiveFolder = new TemporaryDirectory();
 431              var webrevFolder = new TemporaryDirectory();
 432              var listServer = new TestMailmanServer();
 433              var webrevServer = new TestWebrevServer()) {
 434             var author = credentials.getHostedRepository();
 435             var archive = credentials.getHostedRepository();
 436             var ignored = credentials.getHostedRepository();
 437             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
 438             var censusBuilder = credentials.getCensusBuilder()
 439                                            .addAuthor(author.forge().currentUser().id());
 440             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
 441             var mlBot = MailingListBridgeBot.newBuilder()
 442                                             .from(from)
 443                                             .repo(author)
 444                                             .archive(archive)
 445                                             .censusRepo(censusBuilder.build())
 446                                             .list(listAddress)
 447                                             .ignoredUsers(Set.of(ignored.forge().currentUser().userName()))
 448                                             .listArchive(listServer.getArchive())
 449                                             .smtpServer(listServer.getSMTP())
 450                                             .webrevStorageRepository(archive)
 451                                             .webrevStorageRef(&quot;webrev&quot;)
 452                                             .webrevStorageBase(Path.of(&quot;test&quot;))
 453                                             .webrevStorageBaseUri(webrevServer.uri())
 454                                             .issueTracker(URIBuilder.base(&quot;http://issues.test/browse/&quot;).build())
 455                                             .build();
 456 
 457             // Populate the projects repository
 458             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType());
 459             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
 460             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
 461             localRepo.push(masterHash, archive.url(), &quot;webrev&quot;, true);
 462 
 463             // Make a change with a corresponding PR
 464             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;A simple change&quot;,
 465                                                                &quot;Change msg\n\nWith several lines&quot;);
 466             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
 467             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;Cannot automatically merge&quot;);
 468             pr.setBody(&quot;This is an automated merge PR&quot;);
 469             pr.addLabel(&quot;failed-auto-merge&quot;);
 470 
 471             // Run an archive pass
 472             TestBotRunner.runPeriodicItems(mlBot);
 473             TestBotRunner.runPeriodicItems(mlBot);
 474 
 475             // The archive should contain an entry
 476             Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);
 477             assertTrue(archiveContains(archiveFolder.path(), &quot;Subject: Cannot automatically merge&quot;));
 478         }
 479     }
 480 
 481     @Test
 482     void reviewComment(TestInfo testInfo) throws IOException {
 483         try (var credentials = new HostCredentials(testInfo);
 484              var tempFolder = new TemporaryDirectory();
 485              var archiveFolder = new TemporaryDirectory();
 486              var listServer = new TestMailmanServer();
 487              var webrevServer = new TestWebrevServer()) {
 488             var author = credentials.getHostedRepository();
 489             var archive = credentials.getHostedRepository();
 490             var ignored = credentials.getHostedRepository();
 491             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
 492             var censusBuilder = credentials.getCensusBuilder()
 493                                            .addAuthor(author.forge().currentUser().id());
 494             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
 495             var mlBot = MailingListBridgeBot.newBuilder()
 496                                             .from(from)
 497                                             .repo(author)
 498                                             .archive(archive)
 499                                             .censusRepo(censusBuilder.build())
 500                                             .list(listAddress)
 501                                             .ignoredUsers(Set.of(ignored.forge().currentUser().userName()))
 502                                             .listArchive(listServer.getArchive())
 503                                             .smtpServer(listServer.getSMTP())
 504                                             .webrevStorageRepository(archive)
 505                                             .webrevStorageRef(&quot;webrev&quot;)
 506                                             .webrevStorageBase(Path.of(&quot;test&quot;))
 507                                             .webrevStorageBaseUri(webrevServer.uri())
 508                                             .issueTracker(URIBuilder.base(&quot;http://issues.test/browse/&quot;).build())
 509                                             .build();
 510 
 511             // Populate the projects repository
 512             var reviewFile = Path.of(&quot;reviewfile.txt&quot;);
 513             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType(), reviewFile);
 514             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
 515             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
 516             localRepo.push(masterHash, archive.url(), &quot;webrev&quot;, true);
 517 
 518             // Make a change with a corresponding PR
 519             var editHash = CheckableRepository.appendAndCommit(localRepo);
 520             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
 521             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
 522             pr.setBody(&quot;This is now ready&quot;);
 523             TestBotRunner.runPeriodicItems(mlBot);
 524             listServer.processIncoming();
 525 
 526             // And make a file specific comment
 527             var currentMaster = localRepo.resolve(&quot;master&quot;).orElseThrow();
 528             var comment = pr.addReviewComment(masterHash, editHash, reviewFile.toString(), 2, &quot;Review comment&quot;);
 529 
 530             // Add one from an ignored user as well
 531             var ignoredPr = ignored.pullRequest(pr.id());
 532             ignoredPr.addReviewComment(masterHash, editHash, reviewFile.toString(), 2, &quot;Don&#39;t mind me&quot;);
 533 
 534             // Process comments
 535             TestBotRunner.runPeriodicItems(mlBot);
 536             listServer.processIncoming();
 537 
 538             // The archive should now contain an entry
 539             Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);
 540             assertTrue(archiveContains(archiveFolder.path(), &quot;This is a pull request&quot;));
 541             assertTrue(archiveContains(archiveFolder.path(), &quot;This is now ready&quot;));
 542             assertTrue(archiveContains(archiveFolder.path(), &quot;Review comment&quot;));
 543             assertTrue(archiveContains(archiveFolder.path(), &quot;&gt; This is now ready&quot;));
 544             assertTrue(archiveContains(archiveFolder.path(), reviewFile.toString()));
 545             assertFalse(archiveContains(archiveFolder.path(), &quot;Don&#39;t mind me&quot;));
 546 
 547             // The mailing list as well
 548             var mailmanServer = MailingListServerFactory.createMailmanServer(listServer.getArchive(), listServer.getSMTP(), Duration.ZERO);
 549             var mailmanList = mailmanServer.getList(listAddress.address());
 550             var conversations = mailmanList.conversations(Duration.ofDays(1));
 551             assertEquals(1, conversations.size());
 552             var mail = conversations.get(0).first();
 553             assertEquals(&quot;RFR: This is a pull request&quot;, mail.subject());
 554 
 555             // Comment on the comment
 556             pr.addReviewCommentReply(comment, &quot;This is a review reply&quot;);
 557             TestBotRunner.runPeriodicItems(mlBot);
 558             listServer.processIncoming();
 559 
 560             // The archive should contain the additional comment (but no quoted footers)
 561             Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);
 562             assertTrue(archiveContains(archiveFolder.path(), &quot;This is a review reply&quot;));
 563             assertTrue(archiveContains(archiveFolder.path(), &quot;&gt;&gt; This is now ready&quot;));
 564             assertFalse(archiveContains(archiveFolder.path(), &quot;^&gt; PR:&quot;));
 565 
 566             // As well as the mailing list
 567             conversations = mailmanList.conversations(Duration.ofDays(1));
 568             assertEquals(1, conversations.size());
 569             assertEquals(3, conversations.get(0).allMessages().size());
 570             for (var newMail : conversations.get(0).allMessages()) {
 571                 assertEquals(noreplyAddress(archive), newMail.author().address());
 572                 assertEquals(listAddress, newMail.sender());
 573             }
 574         }
 575     }
 576 
 577     @Test
 578     void combineComments(TestInfo testInfo) throws IOException {
 579         try (var credentials = new HostCredentials(testInfo);
 580              var tempFolder = new TemporaryDirectory();
 581              var archiveFolder = new TemporaryDirectory();
 582              var listServer = new TestMailmanServer();
 583              var webrevServer = new TestWebrevServer()) {
 584             var author = credentials.getHostedRepository();
 585             var archive = credentials.getHostedRepository();
 586             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
 587             var censusBuilder = credentials.getCensusBuilder()
 588                                            .addAuthor(author.forge().currentUser().id());
 589             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
 590             var mlBot = MailingListBridgeBot.newBuilder()
 591                                             .from(from)
 592                                             .repo(author)
 593                                             .archive(archive)
 594                                             .censusRepo(censusBuilder.build())
 595                                             .list(listAddress)
 596                                             .listArchive(listServer.getArchive())
 597                                             .smtpServer(listServer.getSMTP())
 598                                             .webrevStorageRepository(archive)
 599                                             .webrevStorageRef(&quot;webrev&quot;)
 600                                             .webrevStorageBase(Path.of(&quot;test&quot;))
 601                                             .webrevStorageBaseUri(webrevServer.uri())
 602                                             .issueTracker(URIBuilder.base(&quot;http://issues.test/browse/&quot;).build())
 603                                             .build();
 604 
 605             // Populate the projects repository
 606             var reviewFile = Path.of(&quot;reviewfile.txt&quot;);
 607             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType(), reviewFile);
 608             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
 609             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
 610             localRepo.push(masterHash, archive.url(), &quot;webrev&quot;, true);
 611 
 612             // Make a change with a corresponding PR
 613             var editHash = CheckableRepository.appendAndCommit(localRepo);
 614             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
 615             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
 616             pr.setBody(&quot;This is now ready&quot;);
 617             pr.addComment(&quot;Avoid combining&quot;);
 618 
 619             TestBotRunner.runPeriodicItems(mlBot);
 620             listServer.processIncoming();
 621             listServer.processIncoming();
 622 
 623             // Make several file specific comments
 624             var first = pr.addReviewComment(masterHash, editHash, reviewFile.toString(), 2, &quot;Review comment&quot;);
 625             var second = pr.addReviewComment(masterHash, editHash, reviewFile.toString(), 2, &quot;Another review comment&quot;);
 626             pr.addReviewComment(masterHash, editHash, reviewFile.toString(), 2, &quot;Further review comment&quot;);
 627             pr.addReviewComment(masterHash, editHash, reviewFile.toString(), 2, &quot;Final review comment&quot;);
 628             TestBotRunner.runPeriodicItems(mlBot);
 629             listServer.processIncoming();
 630 
 631             // The archive should contain a combined entry
 632             Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);
 633             assertEquals(2, archiveContainsCount(archiveFolder.path(), &quot;^On.*wrote:&quot;));
 634 
 635             // As well as the mailing list
 636             var mailmanServer = MailingListServerFactory.createMailmanServer(listServer.getArchive(), listServer.getSMTP(), Duration.ZERO);
 637             var mailmanList = mailmanServer.getList(listAddress.address());
 638             var conversations = mailmanList.conversations(Duration.ofDays(1));
 639             assertEquals(1, conversations.size());
 640             var mail = conversations.get(0).first();
 641             assertEquals(&quot;RFR: This is a pull request&quot;, mail.subject());
 642             assertEquals(3, conversations.get(0).allMessages().size());
 643 
 644             var commentReply = conversations.get(0).replies(mail).get(0);
 645             assertEquals(2, commentReply.body().split(&quot;^On.*wrote:&quot;).length);
 646             assertTrue(commentReply.body().contains(&quot;Avoid combining\n\n&quot;), commentReply.body());
 647 
 648             var reviewReply = conversations.get(0).replies(mail).get(1);
 649             assertEquals(2, reviewReply.body().split(&quot;^On.*wrote:&quot;).length);
 650             assertEquals(2, reviewReply.body().split(&quot;&gt; This is now ready&quot;).length, reviewReply.body());
 651             assertEquals(&quot;RFR: This is a pull request&quot;, reviewReply.subject());
 652             assertTrue(reviewReply.body().contains(&quot;Review comment\n\n&quot;), reviewReply.body());
 653             assertTrue(reviewReply.body().contains(&quot;Another review comment&quot;), reviewReply.body());
 654 
 655             // Now reply to the first and second (collapsed) comment
 656             pr.addReviewCommentReply(first, &quot;I agree&quot;);
 657             pr.addReviewCommentReply(second, &quot;Not with this one though&quot;);
 658             TestBotRunner.runPeriodicItems(mlBot);
 659             listServer.processIncoming();
 660 
 661             // The archive should contain a new entry
 662             Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);
 663             assertEquals(3, archiveContainsCount(archiveFolder.path(), &quot;^On.*wrote:&quot;));
 664 
 665             // The combined review comments should only appear unquoted once
 666             assertEquals(1, archiveContainsCount(archiveFolder.path(), &quot;^Another review comment&quot;));
 667         }
 668     }
 669 
 670     @Test
 671     void commentThreading(TestInfo testInfo) throws IOException {
 672         try (var credentials = new HostCredentials(testInfo);
 673              var tempFolder = new TemporaryDirectory();
 674              var archiveFolder = new TemporaryDirectory();
 675              var listServer = new TestMailmanServer();
 676              var webrevServer = new TestWebrevServer()) {
 677             var author = credentials.getHostedRepository();
 678             var reviewer = credentials.getHostedRepository();
 679             var archive = credentials.getHostedRepository();
 680             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
 681             var censusBuilder = credentials.getCensusBuilder()
 682                                            .addReviewer(reviewer.forge().currentUser().id())
 683                                            .addAuthor(author.forge().currentUser().id());
 684             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
 685             var mlBot = MailingListBridgeBot.newBuilder()
 686                                             .from(from)
 687                                             .repo(author)
 688                                             .archive(archive)
 689                                             .censusRepo(censusBuilder.build())
 690                                             .list(listAddress)
 691                                             .listArchive(listServer.getArchive())
 692                                             .smtpServer(listServer.getSMTP())
 693                                             .webrevStorageRepository(archive)
 694                                             .webrevStorageRef(&quot;webrev&quot;)
 695                                             .webrevStorageBase(Path.of(&quot;test&quot;))
 696                                             .webrevStorageBaseUri(webrevServer.uri())
 697                                             .issueTracker(URIBuilder.base(&quot;http://issues.test/browse/&quot;).build())
 698                                             .build();
 699 
 700             // Populate the projects repository
 701             var reviewFile = Path.of(&quot;reviewfile.txt&quot;);
 702             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType(), reviewFile);
 703             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
 704             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
 705             localRepo.push(masterHash, archive.url(), &quot;webrev&quot;, true);
 706 
 707             // Make a change with a corresponding PR
 708             var editHash = CheckableRepository.appendAndCommit(localRepo);
 709             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
 710             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
 711             pr.setBody(&quot;This is now ready&quot;);
 712             TestBotRunner.runPeriodicItems(mlBot);
 713             listServer.processIncoming();
 714 
 715             // Make a file specific comment
 716             var reviewPr = reviewer.pullRequest(pr.id());
 717             var comment1 = reviewPr.addReviewComment(masterHash, editHash, reviewFile.toString(), 2, &quot;Review comment&quot;);
 718             pr.addReviewCommentReply(comment1, &quot;I agree&quot;);
 719             reviewPr.addReviewCommentReply(comment1, &quot;Great&quot;);
 720             TestBotRunner.runPeriodicItems(mlBot);
 721             listServer.processIncoming();
 722             listServer.processIncoming();
 723             listServer.processIncoming();
 724 
 725             // And a second one by ourselves
 726             var comment2 = pr.addReviewComment(masterHash, editHash, reviewFile.toString(), 2, &quot;Another review comment&quot;);
 727             reviewPr.addReviewCommentReply(comment2, &quot;Sounds good&quot;);
 728             pr.addReviewCommentReply(comment2, &quot;Thanks&quot;);
 729             TestBotRunner.runPeriodicItems(mlBot);
 730             listServer.processIncoming();
 731             listServer.processIncoming();
 732             listServer.processIncoming();
 733 
 734             // Finally some approvals and another comment
 735             pr.addReview(Review.Verdict.APPROVED, &quot;Nice&quot;);
 736             reviewPr.addReviewComment(masterHash, editHash, reviewFile.toString(), 2, &quot;The final review comment&quot;);
 737             reviewPr.addReview(Review.Verdict.APPROVED, &quot;Looks fine&quot;);
 738             reviewPr.addReviewCommentReply(comment2, &quot;You are welcome&quot;);
 739             TestBotRunner.runPeriodicItems(mlBot);
 740             listServer.processIncoming();
 741             listServer.processIncoming();
 742             listServer.processIncoming();
 743 
 744             // Sanity check the archive
 745             Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);
 746             assertEquals(9, archiveContainsCount(archiveFolder.path(), &quot;^On.*wrote:&quot;));
 747 
 748             // File specific comments should appear after the approval
 749             var archiveText = archiveContents(archiveFolder.path()).orElseThrow();
 750             assertTrue(archiveText.indexOf(&quot;Looks fine&quot;) &lt; archiveText.indexOf(&quot;The final review comment&quot;));
 751 
 752             // Check the mailing list
 753             var mailmanServer = MailingListServerFactory.createMailmanServer(listServer.getArchive(), listServer.getSMTP(), Duration.ZERO);
 754             var mailmanList = mailmanServer.getList(listAddress.address());
 755             var conversations = mailmanList.conversations(Duration.ofDays(1));
 756             assertEquals(1, conversations.size());
 757             var mail = conversations.get(0).first();
 758             assertEquals(&quot;RFR: This is a pull request&quot;, mail.subject());
 759             assertEquals(10, conversations.get(0).allMessages().size());
 760 
 761             // There should be four separate threads
 762             var thread1 = conversations.get(0).replies(mail).get(0);
 763             assertEquals(2, thread1.body().split(&quot;^On.*wrote:&quot;).length);
 764             assertEquals(2, thread1.body().split(&quot;&gt; This is now ready&quot;).length, thread1.body());
 765             assertEquals(&quot;RFR: This is a pull request&quot;, thread1.subject());
 766             assertTrue(thread1.body().contains(&quot;Review comment\n\n&quot;), thread1.body());
 767             assertFalse(thread1.body().contains(&quot;Another review comment&quot;), thread1.body());
 768             var thread1reply1 = conversations.get(0).replies(thread1).get(0);
 769             assertTrue(thread1reply1.body().contains(&quot;I agree&quot;));
 770             assertEquals(noreplyAddress(archive), thread1reply1.author().address());
 771             assertEquals(archive.forge().currentUser().fullName(), thread1reply1.author().fullName().orElseThrow());
 772             var thread1reply2 = conversations.get(0).replies(thread1reply1).get(0);
 773             assertTrue(thread1reply2.body().contains(&quot;Great&quot;));
 774             assertEquals(&quot;integrationreviewer1@openjdk.java.net&quot;, thread1reply2.author().address());
 775             assertEquals(&quot;Generated Reviewer 1&quot;, thread1reply2.author().fullName().orElseThrow());
 776 
 777             var thread2 = conversations.get(0).replies(mail).get(1);
 778             assertEquals(2, thread2.body().split(&quot;^On.*wrote:&quot;).length);
 779             assertEquals(2, thread2.body().split(&quot;&gt; This is now ready&quot;).length, thread2.body());
 780             assertEquals(&quot;RFR: This is a pull request&quot;, thread2.subject());
 781             assertFalse(thread2.body().contains(&quot;Review comment\n\n&quot;), thread2.body());
 782             assertTrue(thread2.body().contains(&quot;Another review comment&quot;), thread2.body());
 783             var thread2reply1 = conversations.get(0).replies(thread2).get(0);
 784             assertTrue(thread2reply1.body().contains(&quot;Sounds good&quot;));
 785             var thread2reply2 = conversations.get(0).replies(thread2reply1).get(0);
 786             assertTrue(thread2reply2.body().contains(&quot;Thanks&quot;));
 787 
 788             var replies = conversations.get(0).replies(mail);
 789             var thread3 = replies.get(2);
 790             assertEquals(&quot;RFR: This is a pull request&quot;, thread3.subject());
 791             var thread4 = replies.get(3);
 792             assertEquals(&quot;RFR: This is a pull request&quot;, thread4.subject());
 793             assertTrue(thread4.body().contains(&quot;Looks fine&quot;));
 794             assertTrue(thread4.body().contains(&quot;The final review comment&quot;));
 795             assertTrue(thread4.body().contains(&quot;Marked as reviewed by integrationreviewer1 (Reviewer)&quot;));
 796         }
 797     }
 798 
 799     @Test
 800     void commentThreadingSeparated(TestInfo testInfo) throws IOException {
 801         try (var credentials = new HostCredentials(testInfo);
 802              var tempFolder = new TemporaryDirectory();
 803              var archiveFolder = new TemporaryDirectory();
 804              var listServer = new TestMailmanServer();
 805              var webrevServer = new TestWebrevServer()) {
 806             var author = credentials.getHostedRepository();
 807             var reviewer = credentials.getHostedRepository();
 808             var archive = credentials.getHostedRepository();
 809             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
 810             var censusBuilder = credentials.getCensusBuilder()
 811                                            .addReviewer(reviewer.forge().currentUser().id())
 812                                            .addAuthor(author.forge().currentUser().id());
 813             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
 814             var mlBot = MailingListBridgeBot.newBuilder()
 815                                             .from(from)
 816                                             .repo(author)
 817                                             .archive(archive)
 818                                             .censusRepo(censusBuilder.build())
 819                                             .list(listAddress)
 820                                             .listArchive(listServer.getArchive())
 821                                             .smtpServer(listServer.getSMTP())
 822                                             .webrevStorageRepository(archive)
 823                                             .webrevStorageRef(&quot;webrev&quot;)
 824                                             .webrevStorageBase(Path.of(&quot;test&quot;))
 825                                             .webrevStorageBaseUri(webrevServer.uri())
 826                                             .issueTracker(URIBuilder.base(&quot;http://issues.test/browse/&quot;).build())
 827                                             .build();
 828 
 829             // Populate the projects repository
 830             var reviewFile = Path.of(&quot;reviewfile.txt&quot;);
 831             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType(), reviewFile);
 832             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
 833             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
 834             localRepo.push(masterHash, archive.url(), &quot;webrev&quot;, true);
 835 
 836             // Make a change with a corresponding PR
 837             var editHash = CheckableRepository.appendAndCommit(localRepo);
 838             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
 839             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
 840             pr.setBody(&quot;This is now ready&quot;);
 841             TestBotRunner.runPeriodicItems(mlBot);
 842             listServer.processIncoming();
 843 
 844             // Make two file specific comments
 845             var reviewPr = reviewer.pullRequest(pr.id());
 846             var comment1 = reviewPr.addReviewComment(masterHash, editHash, reviewFile.toString(), 2, &quot;Review comment&quot;);
 847             var comment2 = reviewPr.addReviewComment(masterHash, editHash, reviewFile.toString(), 2, &quot;Another review comment&quot;);
 848             TestBotRunner.runPeriodicItems(mlBot);
 849             listServer.processIncoming();
 850 
 851             pr.addReviewCommentReply(comment1, &quot;I agree&quot;);
 852             pr.addReviewCommentReply(comment2, &quot;I don&#39;t agree&quot;);
 853             TestBotRunner.runPeriodicItems(mlBot);
 854             listServer.processIncoming();
 855 
 856             // Sanity check the archive
 857             Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);
 858             assertEquals(2, archiveContainsCount(archiveFolder.path(), &quot;^On.*wrote:&quot;));
 859         }
 860     }
 861 
 862     @Test
 863     void commentWithMention(TestInfo testInfo) throws IOException {
 864         try (var credentials = new HostCredentials(testInfo);
 865              var tempFolder = new TemporaryDirectory();
 866              var archiveFolder = new TemporaryDirectory();
 867              var listServer = new TestMailmanServer();
 868              var webrevServer = new TestWebrevServer()) {
 869             var author = credentials.getHostedRepository();
 870             var reviewer = credentials.getHostedRepository();
 871             var archive = credentials.getHostedRepository();
 872             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
 873             var censusBuilder = credentials.getCensusBuilder()
 874                                            .addReviewer(reviewer.forge().currentUser().id())
 875                                            .addAuthor(author.forge().currentUser().id());
 876             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
 877             var mlBot = MailingListBridgeBot.newBuilder()
 878                                             .from(from)
 879                                             .repo(author)
 880                                             .archive(archive)
 881                                             .censusRepo(censusBuilder.build())
 882                                             .list(listAddress)
 883                                             .listArchive(listServer.getArchive())
 884                                             .smtpServer(listServer.getSMTP())
 885                                             .webrevStorageRepository(archive)
 886                                             .webrevStorageRef(&quot;webrev&quot;)
 887                                             .webrevStorageBase(Path.of(&quot;test&quot;))
 888                                             .webrevStorageBaseUri(webrevServer.uri())
 889                                             .issueTracker(URIBuilder.base(&quot;http://issues.test/browse/&quot;).build())
 890                                             .build();
 891 
 892             // Populate the projects repository
 893             var reviewFile = Path.of(&quot;reviewfile.txt&quot;);
 894             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType(), reviewFile);
 895             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
 896             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
 897             localRepo.push(masterHash, archive.url(), &quot;webrev&quot;, true);
 898 
 899             // Make a change with a corresponding PR
 900             var editHash = CheckableRepository.appendAndCommit(localRepo);
 901             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
 902             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
 903             pr.setBody(&quot;This is now ready&quot;);
 904             TestBotRunner.runPeriodicItems(mlBot);
 905             listServer.processIncoming();
 906 
 907             // Make two comments from different authors
 908             var reviewPr = reviewer.pullRequest(pr.id());
 909             reviewPr.addComment(&quot;First comment&quot;);
 910             pr.addComment(&quot;Second comment&quot;);
 911 
 912             TestBotRunner.runPeriodicItems(mlBot);
 913             listServer.processIncoming();
 914 
 915             pr.addComment(&quot;@&quot; + reviewer.forge().currentUser().userName() + &quot; reply to first&quot;);
 916             TestBotRunner.runPeriodicItems(mlBot);
 917             listServer.processIncoming();
 918 
 919             // The first comment should be quoted more often than the second
 920             Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);
 921             assertEquals(3, archiveContainsCount(archiveFolder.path(), &quot;First comment&quot;));
 922             assertEquals(1, archiveContainsCount(archiveFolder.path(), &quot;Second comment&quot;));
 923         }
 924     }
 925 
 926     @Test
 927     void reviewCommentWithMention(TestInfo testInfo) throws IOException {
 928         try (var credentials = new HostCredentials(testInfo);
 929              var tempFolder = new TemporaryDirectory();
 930              var archiveFolder = new TemporaryDirectory();
 931              var listServer = new TestMailmanServer();
 932              var webrevServer = new TestWebrevServer()) {
 933             var author = credentials.getHostedRepository();
 934             var reviewer = credentials.getHostedRepository();
 935             var archive = credentials.getHostedRepository();
 936             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
 937             var censusBuilder = credentials.getCensusBuilder()
 938                                            .addReviewer(reviewer.forge().currentUser().id())
 939                                            .addAuthor(author.forge().currentUser().id());
 940             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
 941             var mlBot = MailingListBridgeBot.newBuilder()
 942                                             .from(from)
 943                                             .repo(author)
 944                                             .archive(archive)
 945                                             .censusRepo(censusBuilder.build())
 946                                             .list(listAddress)
 947                                             .listArchive(listServer.getArchive())
 948                                             .smtpServer(listServer.getSMTP())
 949                                             .webrevStorageRepository(archive)
 950                                             .webrevStorageRef(&quot;webrev&quot;)
 951                                             .webrevStorageBase(Path.of(&quot;test&quot;))
 952                                             .webrevStorageBaseUri(webrevServer.uri())
 953                                             .issueTracker(URIBuilder.base(&quot;http://issues.test/browse/&quot;).build())
 954                                             .build();
 955 
 956             // Populate the projects repository
 957             var reviewFile = Path.of(&quot;reviewfile.txt&quot;);
 958             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType(), reviewFile);
 959             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
 960             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
 961             localRepo.push(masterHash, archive.url(), &quot;webrev&quot;, true);
 962 
 963             // Make a change with a corresponding PR
 964             var editHash = CheckableRepository.appendAndCommit(localRepo);
 965             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
 966             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
 967             pr.setBody(&quot;This is now ready&quot;);
 968             TestBotRunner.runPeriodicItems(mlBot);
 969             listServer.processIncoming();
 970 
 971             // Make two review comments from different authors
 972             var reviewPr = reviewer.pullRequest(pr.id());
 973             var comment = reviewPr.addReviewComment(masterHash, editHash, reviewFile.toString(), 2, &quot;Review comment&quot;);
 974             reviewPr.addReviewCommentReply(comment, &quot;First review comment&quot;);
 975             pr.addReviewCommentReply(comment, &quot;Second review comment&quot;);
 976 
 977             TestBotRunner.runPeriodicItems(mlBot);
 978             listServer.processIncoming();
 979 
 980             pr.addReviewCommentReply(comment, &quot;@&quot; + reviewer.forge().currentUser().userName() + &quot; reply to first&quot;);
 981             TestBotRunner.runPeriodicItems(mlBot);
 982             listServer.processIncoming();
 983 
 984             // The first comment should be quoted more often than the second
 985             Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);
 986             assertEquals(3, archiveContainsCount(archiveFolder.path(), &quot;First review comment&quot;));
 987             assertEquals(1, archiveContainsCount(archiveFolder.path(), &quot;Second review comment&quot;));
 988         }
 989     }
 990 
 991     @Test
 992     void commentWithQuote(TestInfo testInfo) throws IOException {
 993         try (var credentials = new HostCredentials(testInfo);
 994              var tempFolder = new TemporaryDirectory();
 995              var archiveFolder = new TemporaryDirectory();
 996              var listServer = new TestMailmanServer();
 997              var webrevServer = new TestWebrevServer()) {
 998             var author = credentials.getHostedRepository();
 999             var reviewer = credentials.getHostedRepository();
1000             var archive = credentials.getHostedRepository();
1001             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
1002             var censusBuilder = credentials.getCensusBuilder()
1003                                            .addReviewer(reviewer.forge().currentUser().id())
1004                                            .addAuthor(author.forge().currentUser().id());
1005             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
1006             var mlBot = MailingListBridgeBot.newBuilder()
1007                                             .from(from)
1008                                             .repo(author)
1009                                             .archive(archive)
1010                                             .censusRepo(censusBuilder.build())
1011                                             .list(listAddress)
1012                                             .listArchive(listServer.getArchive())
1013                                             .smtpServer(listServer.getSMTP())
1014                                             .webrevStorageRepository(archive)
1015                                             .webrevStorageRef(&quot;webrev&quot;)
1016                                             .webrevStorageBase(Path.of(&quot;test&quot;))
1017                                             .webrevStorageBaseUri(webrevServer.uri())
1018                                             .issueTracker(URIBuilder.base(&quot;http://issues.test/browse/&quot;).build())
1019                                             .build();
1020 
1021             // Populate the projects repository
1022             var reviewFile = Path.of(&quot;reviewfile.txt&quot;);
1023             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType(), reviewFile);
1024             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
1025             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
1026             localRepo.push(masterHash, archive.url(), &quot;webrev&quot;, true);
1027 
1028             // Make a change with a corresponding PR
1029             var editHash = CheckableRepository.appendAndCommit(localRepo);
1030             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
1031             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
1032             pr.setBody(&quot;This is now ready&quot;);
1033             TestBotRunner.runPeriodicItems(mlBot);
1034             listServer.processIncoming();
1035 
1036             // Make two comments from different authors
1037             var reviewPr = reviewer.pullRequest(pr.id());
1038             reviewPr.addComment(&quot;First comment\nsecond line&quot;);
1039             pr.addComment(&quot;Second comment\nfourth line&quot;);
1040 
1041             TestBotRunner.runPeriodicItems(mlBot);
1042             listServer.processIncoming();
1043 
1044             pr.addComment(&quot;&gt;First comm\n\nreply to first&quot;);
1045             TestBotRunner.runPeriodicItems(mlBot);
1046             listServer.processIncoming();
1047 
1048             // The first comment should be quoted more often than the second
1049             Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);
1050             assertEquals(2, archiveContainsCount(archiveFolder.path(), &quot;First comment&quot;));
1051             assertEquals(3, archiveContainsCount(archiveFolder.path(), &quot;First comm&quot;));
1052             assertEquals(1, archiveContainsCount(archiveFolder.path(), &quot;Second comment&quot;));
1053         }
1054     }
1055 
1056     @Test
1057     void reviewContext(TestInfo testInfo) throws IOException {
1058         try (var credentials = new HostCredentials(testInfo);
1059              var tempFolder = new TemporaryDirectory();
1060              var archiveFolder = new TemporaryDirectory();
1061              var listServer = new TestMailmanServer();
1062              var webrevServer = new TestWebrevServer()) {
1063             var author = credentials.getHostedRepository();
1064             var archive = credentials.getHostedRepository();
1065             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
1066             var censusBuilder = credentials.getCensusBuilder()
1067                                            .addAuthor(author.forge().currentUser().id());
1068             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
1069             var mlBot = MailingListBridgeBot.newBuilder()
1070                                             .from(from)
1071                                             .repo(author)
1072                                             .archive(archive)
1073                                             .censusRepo(censusBuilder.build())
1074                                             .list(listAddress)
1075                                             .listArchive(listServer.getArchive())
1076                                             .smtpServer(listServer.getSMTP())
1077                                             .webrevStorageRepository(archive)
1078                                             .webrevStorageRef(&quot;webrev&quot;)
1079                                             .webrevStorageBase(Path.of(&quot;test&quot;))
1080                                             .webrevStorageBaseUri(webrevServer.uri())
1081                                             .issueTracker(URIBuilder.base(&quot;http://issues.test/browse/&quot;).build())
1082                                             .build();
1083 
1084             // Populate the projects repository
1085             var reviewFile = Path.of(&quot;reviewfile.txt&quot;);
1086             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType(), reviewFile);
1087             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
1088             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
1089             localRepo.push(masterHash, archive.url(), &quot;webrev&quot;, true);
1090 
1091             // Make a change with a corresponding PR
1092             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;Line 1\nLine 2\nLine 3\nLine 4&quot;);
1093             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
1094             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
1095             pr.setBody(&quot;This is now ready&quot;);
1096             TestBotRunner.runPeriodicItems(mlBot);
1097             listServer.processIncoming();
1098 
1099             // Make a file specific comment
1100             pr.addReviewComment(masterHash, editHash, reviewFile.toString(), 2, &quot;Review comment&quot;);
1101 
1102             TestBotRunner.runPeriodicItems(mlBot);
1103             listServer.processIncoming();
1104 
1105             // The archive should only contain context around line 2
1106             Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);
1107             assertTrue(archiveContains(archiveFolder.path(), &quot;^&gt; 2: Line 1$&quot;));
1108             assertTrue(archiveContains(archiveFolder.path(), &quot;^&gt; 3: Line 2$&quot;));
1109             assertFalse(archiveContains(archiveFolder.path(), &quot;^&gt; 4: Line 3$&quot;));
1110         }
1111     }
1112 
1113     @Test
1114     void multipleReviewContexts(TestInfo testInfo) throws IOException {
1115         try (var credentials = new HostCredentials(testInfo);
1116              var tempFolder = new TemporaryDirectory();
1117              var archiveFolder = new TemporaryDirectory();
1118              var listServer = new TestMailmanServer();
1119              var webrevServer = new TestWebrevServer()) {
1120             var author = credentials.getHostedRepository();
1121             var archive = credentials.getHostedRepository();
1122             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
1123             var censusBuilder = credentials.getCensusBuilder()
1124                                            .addAuthor(author.forge().currentUser().id());
1125             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
1126             var mlBot = MailingListBridgeBot.newBuilder()
1127                                             .from(from)
1128                                             .repo(author)
1129                                             .archive(archive)
1130                                             .censusRepo(censusBuilder.build())
1131                                             .list(listAddress)
1132                                             .listArchive(listServer.getArchive())
1133                                             .smtpServer(listServer.getSMTP())
1134                                             .webrevStorageRepository(archive)
1135                                             .webrevStorageRef(&quot;webrev&quot;)
1136                                             .webrevStorageBase(Path.of(&quot;test&quot;))
1137                                             .webrevStorageBaseUri(webrevServer.uri())
1138                                             .issueTracker(URIBuilder.base(&quot;http://issues.test/browse/&quot;).build())
1139                                             .build();
1140 
1141             // Populate the projects repository
1142             var reviewFile = Path.of(&quot;reviewfile.txt&quot;);
1143             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType(), reviewFile);
1144             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
1145             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
1146             localRepo.push(masterHash, archive.url(), &quot;webrev&quot;, true);
1147             var initialHash = CheckableRepository.appendAndCommit(localRepo,
1148                                                                   &quot;Line 0.1\nLine 0.2\nLine 0.3\nLine 0.4\n&quot; +
1149                                                                           &quot;Line 1\nLine 2\nLine 3\nLine 4\n&quot; +
1150                                                                           &quot;Line 5\nLine 6\nLine 7\nLine 8\n&quot; +
1151                                                                           &quot;Line 8.1\nLine 8.2\nLine 8.3\nLine 8.4\n&quot; +
1152                                                                           &quot;Line 9\nLine 10\nLine 11\nLine 12\n&quot; +
1153                                                                           &quot;Line 13\nLine 14\nLine 15\nLine 16\n&quot;);
1154             localRepo.push(initialHash, author.url(), &quot;master&quot;);
1155 
1156             // Make a change with a corresponding PR
1157             var current = Files.readString(localRepo.root().resolve(reviewFile), StandardCharsets.UTF_8);
1158             var updated = current.replaceAll(&quot;Line 2&quot;, &quot;Line 2 edit\nLine 2.5&quot;);
1159             updated = updated.replaceAll(&quot;Line 13&quot;, &quot;Line 12.5\nLine 13 edit&quot;);
1160             Files.writeString(localRepo.root().resolve(reviewFile), updated, StandardCharsets.UTF_8);
1161             var editHash = CheckableRepository.appendAndCommit(localRepo);
1162             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
1163             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
1164             pr.setBody(&quot;This is now ready&quot;);
1165             TestBotRunner.runPeriodicItems(mlBot);
1166             listServer.processIncoming();
1167 
1168             // Make file specific comments
1169             pr.addReviewComment(masterHash, editHash, reviewFile.toString(), 7, &quot;Review comment&quot;);
1170             pr.addReviewComment(masterHash, editHash, reviewFile.toString(), 24, &quot;Another review comment&quot;);
1171 
1172             TestBotRunner.runPeriodicItems(mlBot);
1173             listServer.processIncoming();
1174 
1175             // The archive should only contain context around line 2 and 20
1176             Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);
1177             assertTrue(archiveContains(archiveFolder.path(), &quot;reviewfile.txt line 7&quot;));
1178             assertTrue(archiveContains(archiveFolder.path(), &quot;^&gt; 6: Line 1$&quot;));
1179             assertTrue(archiveContains(archiveFolder.path(), &quot;^&gt; 7: Line 2 edit$&quot;));
1180             assertFalse(archiveContains(archiveFolder.path(), &quot;Line 3&quot;));
1181 
1182             assertTrue(archiveContains(archiveFolder.path(), &quot;reviewfile.txt line 24&quot;));
1183             assertTrue(archiveContains(archiveFolder.path(), &quot;^&gt; 23: Line 12.5$&quot;));
1184             assertTrue(archiveContains(archiveFolder.path(), &quot;^&gt; 24: Line 13 edit$&quot;));
1185             assertFalse(archiveContains(archiveFolder.path(), &quot;^Line 15&quot;));
1186         }
1187     }
1188 
1189     @Test
1190     void filterComments(TestInfo testInfo) throws IOException {
1191         try (var credentials = new HostCredentials(testInfo);
1192              var tempFolder = new TemporaryDirectory();
1193              var archiveFolder = new TemporaryDirectory();
1194              var listServer = new TestMailmanServer();
1195              var webrevServer = new TestWebrevServer()) {
1196             var author = credentials.getHostedRepository();
1197             var archive = credentials.getHostedRepository();
1198             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
1199             var censusBuilder = credentials.getCensusBuilder()
1200                                            .addAuthor(author.forge().currentUser().id());
1201             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
1202             var mlBot = MailingListBridgeBot.newBuilder()
1203                                             .from(from)
1204                                             .repo(author)
1205                                             .archive(archive)
1206                                             .censusRepo(censusBuilder.build())
1207                                             .list(listAddress)
1208                                             .listArchive(listServer.getArchive())
1209                                             .smtpServer(listServer.getSMTP())
1210                                             .webrevStorageRepository(archive)
1211                                             .webrevStorageRef(&quot;webrev&quot;)
1212                                             .webrevStorageBase(Path.of(&quot;test&quot;))
1213                                             .webrevStorageBaseUri(webrevServer.uri())
1214                                             .issueTracker(URIBuilder.base(&quot;http://issues.test/browse/&quot;).build())
1215                                             .build();
1216 
1217             // Populate the projects repository
1218             var reviewFile = Path.of(&quot;reviewfile.txt&quot;);
1219             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType(), reviewFile);
1220             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
1221             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
1222             localRepo.push(masterHash, archive.url(), &quot;webrev&quot;, true);
1223 
1224             // Make a change with a corresponding PR
1225             var editHash = CheckableRepository.appendAndCommit(localRepo);
1226             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
1227             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
1228             pr.setBody(&quot;This is now ready\n&lt;!-- this is a comment --&gt;\nAnd this is not\n&quot; +
1229                                &quot;&lt;!-- Anything below this marker will be hidden --&gt;\nStatus stuff&quot;);
1230 
1231             // Make a bunch of comments
1232             pr.addComment(&quot;Plain comment\n&lt;!-- this is a comment --&gt;&quot;);
1233             pr.addReviewComment(masterHash, editHash, reviewFile.toString(), 2, &quot;Review comment &lt;!-- this is a comment --&gt;\n&quot;);
1234             pr.addComment(&quot;/integrate stuff&quot;);
1235             TestBotRunner.runPeriodicItems(mlBot);
1236 
1237             // Run an archive pass
1238             TestBotRunner.runPeriodicItems(mlBot);
1239 
1240             // The archive should not contain the comment
1241             Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);
1242             assertTrue(archiveContains(archiveFolder.path(), &quot;This is now ready&quot;));
1243             assertFalse(archiveContains(archiveFolder.path(), &quot;this is a comment&quot;));
1244             assertFalse(archiveContains(archiveFolder.path(), &quot;Status stuff&quot;));
1245             assertTrue(archiveContains(archiveFolder.path(), &quot;And this is not&quot;));
1246             assertFalse(archiveContains(archiveFolder.path(), &quot;&lt;!--&quot;));
1247             assertFalse(archiveContains(archiveFolder.path(), &quot;--&gt;&quot;));
1248             assertTrue(archiveContains(archiveFolder.path(), &quot;Plain comment&quot;));
1249             assertTrue(archiveContains(archiveFolder.path(), &quot;Review comment&quot;));
1250             assertFalse(archiveContains(archiveFolder.path(), &quot;/integrate&quot;));
1251         }
1252     }
1253 
1254     @Test
1255     void incrementalChanges(TestInfo testInfo) throws IOException {
1256         try (var credentials = new HostCredentials(testInfo);
1257              var tempFolder = new TemporaryDirectory();
1258              var archiveFolder = new TemporaryDirectory();
1259              var listServer = new TestMailmanServer();
1260              var webrevServer = new TestWebrevServer()) {
1261             var author = credentials.getHostedRepository();
1262             var archive = credentials.getHostedRepository();
1263             var commenter = credentials.getHostedRepository();
1264             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
1265             var censusBuilder = credentials.getCensusBuilder()
1266                                            .addAuthor(author.forge().currentUser().id());
1267             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
1268             var mlBot = MailingListBridgeBot.newBuilder()
1269                                             .from(from)
1270                                             .repo(author)
1271                                             .archive(archive)
1272                                             .censusRepo(censusBuilder.build())
1273                                             .list(listAddress)
1274                                             .listArchive(listServer.getArchive())
1275                                             .smtpServer(listServer.getSMTP())
1276                                             .webrevStorageRepository(archive)
1277                                             .webrevStorageRef(&quot;webrev&quot;)
1278                                             .webrevStorageBase(Path.of(&quot;test&quot;))
1279                                             .webrevStorageBaseUri(webrevServer.uri())
1280                                             .issueTracker(URIBuilder.base(&quot;http://issues.test/browse/&quot;).build())
1281                                             .build();
1282 
1283             // Populate the projects repository
1284             var reviewFile = Path.of(&quot;reviewfile.txt&quot;);
1285             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType(), reviewFile);
1286             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
1287             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
1288             localRepo.push(masterHash, archive.url(), &quot;webrev&quot;, true);
1289 
1290             // Make a change with a corresponding PR
1291             var editHash = CheckableRepository.appendAndCommit(localRepo);
1292             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
1293             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
1294             pr.setBody(&quot;This is now ready&quot;);
1295 
1296             // Run an archive pass
1297             TestBotRunner.runPeriodicItems(mlBot);
1298             listServer.processIncoming();
1299 
1300             var nextHash = CheckableRepository.appendAndCommit(localRepo, &quot;Yet one more line&quot;, &quot;Fixing&quot;);
1301             localRepo.push(nextHash, author.url(), &quot;edit&quot;);
1302 
1303             // Make sure that the push registered
1304             var lastHeadHash = pr.headHash();
1305             var refreshCount = 0;
1306             do {
1307                 pr = author.pullRequest(pr.id());
1308                 if (refreshCount++ &gt; 100) {
1309                     fail(&quot;The PR did not update after the new push&quot;);
1310                 }
1311             } while (pr.headHash().equals(lastHeadHash));
1312 
1313             // Run another archive pass
1314             TestBotRunner.runPeriodicItems(mlBot);
1315             TestBotRunner.runPeriodicItems(mlBot);
1316             TestBotRunner.runPeriodicItems(mlBot);
1317             listServer.processIncoming();
1318 
1319             // The archive should reference the updated push
1320             Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);
1321             assertTrue(archiveContains(archiveFolder.path(), &quot;has updated the pull request incrementally&quot;));
1322             assertTrue(archiveContains(archiveFolder.path(), &quot;full.*/&quot; + pr.id() + &quot;/webrev.01&quot;));
1323             assertTrue(archiveContains(archiveFolder.path(), &quot;inc.*/&quot; + pr.id() + &quot;/webrev.00-01&quot;));
1324             assertTrue(archiveContains(archiveFolder.path(), &quot;Patch&quot;));
1325             assertTrue(archiveContains(archiveFolder.path(), &quot;Fetch&quot;));
1326             assertTrue(archiveContains(archiveFolder.path(), &quot;Fixing&quot;));
1327 
1328             // The webrev comment should be updated
1329             var comments = pr.comments();
1330             var webrevComments = comments.stream()
1331                                          .filter(comment -&gt; comment.author().equals(author.forge().currentUser()))
1332                                          .filter(comment -&gt; comment.body().contains(&quot;webrev&quot;))
1333                                          .filter(comment -&gt; comment.body().contains(&quot;Full&quot;))
1334                                          .filter(comment -&gt; comment.body().contains(&quot;Incremental&quot;))
1335                                          .filter(comment -&gt; comment.body().contains(nextHash.hex()))
1336                                          .filter(comment -&gt; comment.body().contains(editHash.hex()))
1337                                          .collect(Collectors.toList());
1338             assertEquals(1, webrevComments.size());
1339 
1340             // Check that sender address is set properly
1341             var mailmanServer = MailingListServerFactory.createMailmanServer(listServer.getArchive(), listServer.getSMTP(), Duration.ZERO);
1342             var mailmanList = mailmanServer.getList(listAddress.address());
1343             var conversations = mailmanList.conversations(Duration.ofDays(1));
1344             assertEquals(1, conversations.size());
1345             for (var newMail : conversations.get(0).allMessages()) {
1346                 assertEquals(noreplyAddress(archive), newMail.author().address());
1347                 assertEquals(listAddress, newMail.sender());
1348             }
1349 
1350             // Add a comment
1351             var commenterPr = commenter.pullRequest(pr.id());
1352             commenterPr.addReviewComment(masterHash, nextHash, reviewFile.toString(), 2, &quot;Review comment&quot;);
1353             TestBotRunner.runPeriodicItems(mlBot);
1354             listServer.processIncoming();
1355 
1356             // Ensure that additional updates are only reported once
1357             for (int i = 0; i &lt; 3; ++i) {
1358                 var anotherHash = CheckableRepository.appendAndCommit(localRepo, &quot;Another line&quot;, &quot;Fixing&quot;);
1359                 localRepo.push(anotherHash, author.url(), &quot;edit&quot;);
1360 
1361                 // Make sure that the push registered
1362                 lastHeadHash = pr.headHash();
1363                 refreshCount = 0;
1364                 do {
1365                     pr = author.pullRequest(pr.id());
1366                     if (refreshCount++ &gt; 100) {
1367                         fail(&quot;The PR did not update after the new push&quot;);
1368                     }
1369                 } while (pr.headHash().equals(lastHeadHash));
1370 
1371                 TestBotRunner.runPeriodicItems(mlBot);
1372                 TestBotRunner.runPeriodicItems(mlBot);
1373                 listServer.processIncoming();
1374             }
1375             var updatedConversations = mailmanList.conversations(Duration.ofDays(1));
1376             assertEquals(1, updatedConversations.size());
1377             var conversation = updatedConversations.get(0);
1378             assertEquals(6, conversation.allMessages().size());
1379             assertEquals(&quot;[Rev 01] RFR: This is a pull request&quot;, conversation.allMessages().get(1).subject());
1380             assertEquals(&quot;[Rev 01] RFR: This is a pull request&quot;, conversation.allMessages().get(2).subject(), conversation.allMessages().get(2).toString());
1381             assertEquals(&quot;[Rev 04] RFR: This is a pull request&quot;, conversation.allMessages().get(5).subject());
1382         }
1383     }
1384 
1385     @Test
1386     void rebased(TestInfo testInfo) throws IOException {
1387         try (var credentials = new HostCredentials(testInfo);
1388              var tempFolder = new TemporaryDirectory();
1389              var archiveFolder = new TemporaryDirectory();
1390              var listServer = new TestMailmanServer();
1391              var webrevServer = new TestWebrevServer()) {
1392             var author = credentials.getHostedRepository();
1393             var archive = credentials.getHostedRepository();
1394             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
1395             var censusBuilder = credentials.getCensusBuilder()
1396                                            .addAuthor(author.forge().currentUser().id());
1397             var sender = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
1398             var mlBot = MailingListBridgeBot.newBuilder()
1399                                             .from(sender)
1400                                             .repo(author)
1401                                             .archive(archive)
1402                                             .censusRepo(censusBuilder.build())
1403                                             .list(listAddress)
1404                                             .listArchive(listServer.getArchive())
1405                                             .smtpServer(listServer.getSMTP())
1406                                             .webrevStorageRepository(archive)
1407                                             .webrevStorageRef(&quot;webrev&quot;)
1408                                             .webrevStorageBase(Path.of(&quot;test&quot;))
1409                                             .webrevStorageBaseUri(webrevServer.uri())
1410                                             .issueTracker(URIBuilder.base(&quot;http://issues.test/browse/&quot;).build())
1411                                             .build();
1412 
1413             // Populate the projects repository
1414             var reviewFile = Path.of(&quot;reviewfile.txt&quot;);
1415             var localRepo = CheckableRepository.init(tempFolder.path().resolve(&quot;first&quot;), author.repositoryType(), reviewFile);
1416             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
1417             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
1418             localRepo.push(masterHash, archive.url(), &quot;webrev&quot;, true);
1419 
1420             // Make a change with a corresponding PR
1421             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;A line&quot;, &quot;Original msg&quot;);
1422             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
1423             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
1424             pr.setBody(&quot;This is now ready&quot;);
1425 
1426             // Run an archive pass
1427             TestBotRunner.runPeriodicItems(mlBot);
1428             listServer.processIncoming();
1429 
1430             var newLocalRepo = Repository.materialize(tempFolder.path().resolve(&quot;second&quot;), author.url(), &quot;master&quot;);
1431             var newEditHash = CheckableRepository.appendAndCommit(newLocalRepo, &quot;Another line&quot;, &quot;Replaced msg&quot;);
1432             newLocalRepo.push(newEditHash, author.url(), &quot;edit&quot;, true);
1433 
1434             // Make sure that the push registered
1435             var lastHeadHash = pr.headHash();
1436             var refreshCount = 0;
1437             do {
1438                 pr = author.pullRequest(pr.id());
1439                 if (refreshCount++ &gt; 100) {
1440                     fail(&quot;The PR did not update after the new push&quot;);
1441                 }
1442             } while (pr.headHash().equals(lastHeadHash));
1443 
1444             // Run another archive pass
1445             TestBotRunner.runPeriodicItems(mlBot);
1446             listServer.processIncoming();
1447 
1448             // The archive should reference the rebased push
1449             Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);
1450             assertTrue(archiveContains(archiveFolder.path(), &quot;has updated the pull request with a new target base&quot;));
1451             assertTrue(archiveContains(archiveFolder.path(), pr.id() + &quot;/webrev.01&quot;));
1452             assertFalse(archiveContains(archiveFolder.path(), &quot;Incremental&quot;));
1453             assertTrue(archiveContains(archiveFolder.path(), &quot;Patch&quot;));
1454             assertTrue(archiveContains(archiveFolder.path(), &quot;Fetch&quot;));
1455             assertTrue(archiveContains(archiveFolder.path(), &quot;Original msg&quot;));
1456             assertTrue(archiveContains(archiveFolder.path(), &quot;Replaced msg&quot;));
1457 
1458             // The webrev comment should be updated
1459             var comments = pr.comments();
1460             var webrevComments = comments.stream()
1461                                          .filter(comment -&gt; comment.author().equals(author.forge().currentUser()))
1462                                          .filter(comment -&gt; comment.body().contains(&quot;webrev&quot;))
1463                                          .filter(comment -&gt; comment.body().contains(newEditHash.hex()))
1464                                          .collect(Collectors.toList());
1465             assertEquals(1, webrevComments.size());
1466 
1467             // Check that sender address is set properly
1468             var mailmanServer = MailingListServerFactory.createMailmanServer(listServer.getArchive(), listServer.getSMTP(), Duration.ZERO);
1469             var mailmanList = mailmanServer.getList(listAddress.address());
1470             var conversations = mailmanList.conversations(Duration.ofDays(1));
1471             assertEquals(1, conversations.size());
1472             for (var newMail : conversations.get(0).allMessages()) {
1473                 assertEquals(noreplyAddress(archive), newMail.author().address());
1474                 assertEquals(listAddress, newMail.sender());
1475                 assertFalse(newMail.hasHeader(&quot;PR-Head-Hash&quot;));
1476             }
1477             assertEquals(&quot;[Rev 01] RFR: This is a pull request&quot;, conversations.get(0).allMessages().get(1).subject());
1478         }
1479     }
1480 
1481     @Test
1482     void incrementalAfterRebase(TestInfo testInfo) throws IOException {
1483         try (var credentials = new HostCredentials(testInfo);
1484              var tempFolder = new TemporaryDirectory();
1485              var archiveFolder = new TemporaryDirectory();
1486              var listServer = new TestMailmanServer();
1487              var webrevServer = new TestWebrevServer()) {
1488             var author = credentials.getHostedRepository();
1489             var archive = credentials.getHostedRepository();
1490             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
1491             var censusBuilder = credentials.getCensusBuilder()
1492                                            .addAuthor(author.forge().currentUser().id());
1493             var sender = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
1494             var mlBot = MailingListBridgeBot.newBuilder()
1495                                             .from(sender)
1496                                             .repo(author)
1497                                             .archive(archive)
1498                                             .archiveRef(&quot;archive&quot;)
1499                                             .censusRepo(censusBuilder.build())
1500                                             .list(listAddress)
1501                                             .listArchive(listServer.getArchive())
1502                                             .smtpServer(listServer.getSMTP())
1503                                             .webrevStorageRepository(archive)
1504                                             .webrevStorageRef(&quot;webrev&quot;)
1505                                             .webrevStorageBase(Path.of(&quot;test&quot;))
1506                                             .webrevStorageBaseUri(webrevServer.uri())
1507                                             .issueTracker(URIBuilder.base(&quot;http://issues.test/browse/&quot;).build())
1508                                             .build();
1509 
1510             // Populate the projects repository
1511             var reviewFile = Path.of(&quot;reviewfile.txt&quot;);
1512             var localRepo = CheckableRepository.init(tempFolder.path().resolve(&quot;first&quot;), author.repositoryType(), reviewFile);
1513             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
1514             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
1515             localRepo.push(masterHash, archive.url(), &quot;webrev&quot;, true);
1516             localRepo.push(masterHash, archive.url(), &quot;archive&quot;, true);
1517 
1518             // Make a change with a corresponding PR
1519             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;A line&quot;, &quot;Original msg&quot;);
1520             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
1521             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
1522             pr.setBody(&quot;This is now ready&quot;);
1523 
1524             // Run an archive pass
1525             TestBotRunner.runPeriodicItems(mlBot);
1526             listServer.processIncoming();
1527 
1528             // Push more stuff to master
1529             localRepo.checkout(masterHash, true);
1530             var unrelatedFile = localRepo.root().resolve(&quot;unrelated.txt&quot;);
1531             Files.writeString(unrelatedFile, &quot;Other things happens in master&quot;);
1532             localRepo.add(unrelatedFile);
1533             var newMasterHash = localRepo.commit(&quot;Unrelated change&quot;, &quot;duke&quot;, &quot;duke@openjdk.org&quot;);
1534             localRepo.push(newMasterHash, author.url(), &quot;master&quot;);
1535 
1536             // And more stuff to the pr branch
1537             localRepo.checkout(editHash, true);
1538             CheckableRepository.appendAndCommit(localRepo, &quot;Another line&quot;, &quot;More updates&quot;);
1539 
1540             // Merge master
1541             localRepo.merge(newMasterHash);
1542             var newEditHash = localRepo.commit(&quot;Latest changes from master&quot;, &quot;duke&quot;, &quot;duke@openjdk.org&quot;);
1543             localRepo.push(newEditHash, author.url(), &quot;edit&quot;);
1544 
1545             // Make sure that the push registered
1546             var lastHeadHash = pr.headHash();
1547             var refreshCount = 0;
1548             do {
1549                 pr = author.pullRequest(pr.id());
1550                 if (refreshCount++ &gt; 100) {
1551                     fail(&quot;The PR did not update after the new push&quot;);
1552                 }
1553             } while (pr.headHash().equals(lastHeadHash));
1554 
1555             // Run another archive pass
1556             TestBotRunner.runPeriodicItems(mlBot);
1557             listServer.processIncoming();
1558 
1559             // The archive should reference the rebased push
1560             Repository.materialize(archiveFolder.path(), archive.url(), &quot;archive&quot;);
1561             assertTrue(archiveContains(archiveFolder.path(), &quot;has updated the pull request with a new target base&quot;));
1562             assertTrue(archiveContains(archiveFolder.path(), &quot;excludes&quot;));
1563             assertTrue(archiveContains(archiveFolder.path(), pr.id() + &quot;/webrev.01&quot;));
1564             assertTrue(archiveContains(archiveFolder.path(), pr.id() + &quot;/webrev.00-01&quot;));
1565             assertTrue(archiveContains(archiveFolder.path(), &quot;Original msg&quot;));
1566             assertTrue(archiveContains(archiveFolder.path(), &quot;More updates&quot;));
1567         }
1568     }
1569 
1570     @Test
1571     void mergeWebrev(TestInfo testInfo) throws IOException {
1572         try (var credentials = new HostCredentials(testInfo);
1573              var tempFolder = new TemporaryDirectory();
1574              var archiveFolder = new TemporaryDirectory();
1575              var listServer = new TestMailmanServer();
1576              var webrevServer = new TestWebrevServer()) {
1577             var author = credentials.getHostedRepository();
1578             var archive = credentials.getHostedRepository();
1579             var commenter = credentials.getHostedRepository();
1580             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
1581             var censusBuilder = credentials.getCensusBuilder()
1582                                            .addAuthor(author.forge().currentUser().id());
1583             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
1584             var mlBot = MailingListBridgeBot.newBuilder()
1585                                             .from(from)
1586                                             .repo(author)
1587                                             .archive(archive)
1588                                             .archiveRef(&quot;archive&quot;)
1589                                             .censusRepo(censusBuilder.build())
1590                                             .list(listAddress)
1591                                             .listArchive(listServer.getArchive())
1592                                             .smtpServer(listServer.getSMTP())
1593                                             .webrevStorageRepository(archive)
1594                                             .webrevStorageRef(&quot;webrev&quot;)
1595                                             .webrevStorageBase(Path.of(&quot;test&quot;))
1596                                             .webrevStorageBaseUri(webrevServer.uri())
1597                                             .issueTracker(URIBuilder.base(&quot;http://issues.test/browse/&quot;).build())
1598                                             .build();
1599 
1600             // Populate the projects repository
1601             var reviewFile = Path.of(&quot;reviewfile.txt&quot;);
1602             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType(), reviewFile);
1603             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
1604             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
1605             localRepo.push(masterHash, archive.url(), &quot;archive&quot;, true);
1606             localRepo.push(masterHash, archive.url(), &quot;webrev&quot;, true);
1607 
1608             // Create a merge
1609             var editOnlyFile = Path.of(&quot;editonly.txt&quot;);
1610             Files.writeString(localRepo.root().resolve(editOnlyFile), &quot;Only added in the edit&quot;);
1611             localRepo.add(editOnlyFile);
1612             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;Edited&quot;);
1613             localRepo.checkout(masterHash, true);
1614             var masterOnlyFile = Path.of(&quot;masteronly.txt&quot;);
1615             Files.writeString(localRepo.root().resolve(masterOnlyFile), &quot;Only added in master&quot;);
1616             localRepo.add(masterOnlyFile);
1617             var updatedMasterHash = CheckableRepository.appendAndCommit(localRepo, &quot;Master change&quot;);
1618             localRepo.push(updatedMasterHash, author.url(), &quot;master&quot;);
1619             localRepo.merge(editHash, &quot;ours&quot;);
1620             var mergeCommit = localRepo.commit(&quot;Merged edit&quot;, &quot;duke&quot;, &quot;duke@openjdk.java.net&quot;);
1621             var mergeOnlyFile = Path.of(&quot;mergeonly.txt&quot;);
1622             Files.writeString(localRepo.root().resolve(mergeOnlyFile), &quot;Only added in the merge&quot;);
1623             localRepo.add(mergeOnlyFile);
1624             Files.writeString(localRepo.root().resolve(reviewFile), &quot;Overwriting the conflict resolution&quot;);
1625             localRepo.add(reviewFile);
1626             var appendedCommit = localRepo.amend(&quot;Updated merge commit&quot;, &quot;duke&quot;, &quot;duke@openjdk.java.net&quot;);
1627             localRepo.push(appendedCommit, author.url(), &quot;edit&quot;, true);
1628 
1629             // Make a merge PR
1630             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;Merge edit&quot;);
1631             pr.setBody(&quot;This is now ready&quot;);
1632 
1633             // Run an archive pass
1634             TestBotRunner.runPeriodicItems(mlBot);
1635             listServer.processIncoming();
1636 
1637             // The archive should contain a merge style webrev
1638             Repository.materialize(archiveFolder.path(), archive.url(), &quot;archive&quot;);
1639             assertTrue(archiveContains(archiveFolder.path(), &quot;webrevs contain only the adjustments&quot;));
1640             assertTrue(archiveContains(archiveFolder.path(), pr.id() + &quot;/webrev.00.0&quot;));
1641             assertTrue(archiveContains(archiveFolder.path(), &quot;3 lines in 2 files changed: 1 ins; 1 del; 1 mod&quot;));
1642 
1643             // The PR should contain a webrev comment
1644             assertEquals(1, pr.comments().size());
1645             var webrevComment = pr.comments().get(0);
1646             assertTrue(webrevComment.body().contains(&quot;Merge target&quot;));
1647             assertTrue(webrevComment.body().contains(&quot;Merge source&quot;));
1648         }
1649     }
1650 
1651     @Test
1652     void skipAddingExistingWebrev(TestInfo testInfo) throws IOException {
1653         try (var credentials = new HostCredentials(testInfo);
1654              var tempFolder = new TemporaryDirectory();
1655              var archiveFolder = new TemporaryDirectory();
1656              var webrevFolder = new TemporaryDirectory();
1657              var listServer = new TestMailmanServer();
1658              var webrevServer = new TestWebrevServer()) {
1659             var author = credentials.getHostedRepository();
1660             var archive = credentials.getHostedRepository();
1661             var ignored = credentials.getHostedRepository();
1662             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
1663             var censusBuilder = credentials.getCensusBuilder()
1664                                            .addAuthor(author.forge().currentUser().id());
1665             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
1666             var mlBot = MailingListBridgeBot.newBuilder()
1667                                             .from(from)
1668                                             .repo(author)
1669                                             .archive(archive)
1670                                             .censusRepo(censusBuilder.build())
1671                                             .list(listAddress)
1672                                             .ignoredUsers(Set.of(ignored.forge().currentUser().userName()))
1673                                             .listArchive(listServer.getArchive())
1674                                             .smtpServer(listServer.getSMTP())
1675                                             .webrevStorageRepository(archive)
1676                                             .webrevStorageRef(&quot;webrev&quot;)
1677                                             .webrevStorageBase(Path.of(&quot;test&quot;))
1678                                             .webrevStorageBaseUri(webrevServer.uri())
1679                                             .issueTracker(URIBuilder.base(&quot;http://issues.test/browse/&quot;).build())
1680                                             .build();
1681 
1682             // Populate the projects repository
1683             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType());
1684             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
1685             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
1686             localRepo.push(masterHash, archive.url(), &quot;webrev&quot;, true);
1687 
1688             // Make a change with a corresponding PR
1689             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;A simple change&quot;,
1690                                                                &quot;Change msg\n\nWith several lines&quot;);
1691             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
1692             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
1693 
1694             // Flag it as ready for review
1695             pr.setBody(&quot;This should now be ready&quot;);
1696 
1697             // Run an archive pass
1698             TestBotRunner.runPeriodicItems(mlBot);
1699 
1700             // The archive should now contain an entry
1701             var archiveRepo = Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);
1702             assertTrue(archiveContains(archiveFolder.path(), editHash.abbreviate()));
1703 
1704             // And there should be a webrev comment
1705             var comments = pr.comments();
1706             var webrevComments = comments.stream()
1707                                          .filter(comment -&gt; comment.author().equals(author.forge().currentUser()))
1708                                          .filter(comment -&gt; comment.body().contains(&quot;webrev&quot;))
1709                                          .filter(comment -&gt; comment.body().contains(editHash.hex()))
1710                                          .collect(Collectors.toList());
1711             assertEquals(1, webrevComments.size());
1712             assertEquals(1, countSubstrings(webrevComments.get(0).body(), &quot;webrev.00&quot;));
1713 
1714             // Pretend the archive didn&#39;t work out
1715             archiveRepo.push(masterHash, archive.url(), &quot;master&quot;, true);
1716 
1717             // Run another archive pass
1718             TestBotRunner.runPeriodicItems(mlBot);
1719 
1720             // The webrev comment should not contain duplicate entries
1721             comments = pr.comments();
1722             webrevComments = comments.stream()
1723                                      .filter(comment -&gt; comment.author().equals(author.forge().currentUser()))
1724                                      .filter(comment -&gt; comment.body().contains(&quot;webrev&quot;))
1725                                      .filter(comment -&gt; comment.body().contains(editHash.hex()))
1726                                      .collect(Collectors.toList());
1727             assertEquals(1, webrevComments.size());
1728             assertEquals(1, countSubstrings(webrevComments.get(0).body(), &quot;webrev.00&quot;));
1729         }
1730     }
1731 
1732     @Test
1733     void notifyReviewVerdicts(TestInfo testInfo) throws IOException {
1734         try (var credentials = new HostCredentials(testInfo);
1735              var tempFolder = new TemporaryDirectory();
1736              var archiveFolder = new TemporaryDirectory();
1737              var listServer = new TestMailmanServer();
1738              var webrevServer = new TestWebrevServer()) {
1739             var author = credentials.getHostedRepository();
1740             var archive = credentials.getHostedRepository();
1741             var reviewer = credentials.getHostedRepository();
1742             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
1743             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
1744             var censusBuilder = credentials.getCensusBuilder()
1745                                            .addReviewer(reviewer.forge().currentUser().id())
1746                                            .addAuthor(author.forge().currentUser().id());
1747             var mlBot = MailingListBridgeBot.newBuilder()
1748                                             .from(from)
1749                                             .repo(author)
1750                                             .archive(archive)
1751                                             .censusRepo(censusBuilder.build())
1752                                             .list(listAddress)
1753                                             .listArchive(listServer.getArchive())
1754                                             .smtpServer(listServer.getSMTP())
1755                                             .webrevStorageRepository(archive)
1756                                             .webrevStorageRef(&quot;webrev&quot;)
1757                                             .webrevStorageBase(Path.of(&quot;test&quot;))
1758                                             .webrevStorageBaseUri(webrevServer.uri())
1759                                             .issueTracker(URIBuilder.base(&quot;http://issues.test/browse/&quot;).build())
1760                                             .build();
1761 
1762             // Populate the projects repository
1763             var reviewFile = Path.of(&quot;reviewfile.txt&quot;);
1764             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType(), reviewFile);
1765             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
1766             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
1767             localRepo.push(masterHash, archive.url(), &quot;webrev&quot;, true);
1768 
1769             // Make a change with a corresponding PR
1770             var editHash = CheckableRepository.appendAndCommit(localRepo);
1771             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
1772             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
1773             pr.setBody(&quot;This is now ready&quot;);
1774 
1775             // Run an archive pass
1776             TestBotRunner.runPeriodicItems(mlBot);
1777 
1778             // First unapprove it
1779             var reviewedPr = reviewer.pullRequest(pr.id());
1780             reviewedPr.addReview(Review.Verdict.DISAPPROVED, &quot;Reason 1&quot;);
1781             TestBotRunner.runPeriodicItems(mlBot);
1782             TestBotRunner.runPeriodicItems(mlBot);
1783             TestBotRunner.runPeriodicItems(mlBot);
1784 
1785             // The archive should contain a note
1786             Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);
1787             assertEquals(1, archiveContainsCount(archiveFolder.path(), &quot;Changes requested by &quot;));
1788             assertEquals(1, archiveContainsCount(archiveFolder.path(), &quot; by integrationreviewer1&quot;));
1789             if (author.forge().supportsReviewBody()) {
1790                 assertEquals(1, archiveContainsCount(archiveFolder.path(), &quot;Reason 1&quot;));
1791             }
1792 
1793             // Then approve it
1794             reviewedPr.addReview(Review.Verdict.APPROVED, &quot;Reason 2&quot;);
1795             TestBotRunner.runPeriodicItems(mlBot);
1796             TestBotRunner.runPeriodicItems(mlBot);
1797             TestBotRunner.runPeriodicItems(mlBot);
1798 
1799             // The archive should contain another note
1800             Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);
1801             assertEquals(1, archiveContainsCount(archiveFolder.path(), &quot;Marked as reviewed by &quot;));
1802             if (author.forge().supportsReviewBody()) {
1803                 assertEquals(1, archiveContainsCount(archiveFolder.path(), &quot;Reason 2&quot;));
1804             }
1805             assertEquals(2, archiveContainsCount(archiveFolder.path(), &quot;Re: RFR:&quot;));
1806 
1807             // Yet another change
1808             reviewedPr.addReview(Review.Verdict.DISAPPROVED, &quot;Reason 3&quot;);
1809             TestBotRunner.runPeriodicItems(mlBot);
1810             TestBotRunner.runPeriodicItems(mlBot);
1811             TestBotRunner.runPeriodicItems(mlBot);
1812 
1813             // The archive should contain another note
1814             Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);
1815             assertEquals(2, archiveContainsCount(archiveFolder.path(), &quot;Changes requested by &quot;));
1816             if (author.forge().supportsReviewBody()) {
1817                 assertEquals(1, archiveContainsCount(archiveFolder.path(), &quot;Reason 3&quot;));
1818             }
1819         }
1820     }
1821 
1822     @Test
1823     void ignoreComments(TestInfo testInfo) throws IOException {
1824         try (var credentials = new HostCredentials(testInfo);
1825              var tempFolder = new TemporaryDirectory();
1826              var archiveFolder = new TemporaryDirectory();
1827              var listServer = new TestMailmanServer();
1828              var webrevServer = new TestWebrevServer()) {
1829             var author = credentials.getHostedRepository();
1830             var ignored = credentials.getHostedRepository();
1831             var archive = credentials.getHostedRepository();
1832             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
1833             var censusBuilder = credentials.getCensusBuilder()
1834                                            .addAuthor(author.forge().currentUser().id());
1835             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
1836             var mlBot = MailingListBridgeBot.newBuilder()
1837                                             .from(from)
1838                                             .repo(author)
1839                                             .archive(archive)
1840                                             .censusRepo(censusBuilder.build())
1841                                             .list(listAddress)
1842                                             .ignoredUsers(Set.of(ignored.forge().currentUser().userName()))
1843                                             .ignoredComments(Set.of(Pattern.compile(&quot;ignore this comment&quot;, Pattern.MULTILINE | Pattern.DOTALL)))
1844                                             .listArchive(listServer.getArchive())
1845                                             .smtpServer(listServer.getSMTP())
1846                                             .webrevStorageRepository(archive)
1847                                             .webrevStorageRef(&quot;webrev&quot;)
1848                                             .webrevStorageBase(Path.of(&quot;test&quot;))
1849                                             .webrevStorageBaseUri(webrevServer.uri())
1850                                             .issueTracker(URIBuilder.base(&quot;http://issues.test/browse/&quot;).build())
1851                                             .build();
1852 
1853             // Populate the projects repository
1854             var reviewFile = Path.of(&quot;reviewfile.txt&quot;);
1855             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType(), reviewFile);
1856             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
1857             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
1858             localRepo.push(masterHash, archive.url(), &quot;webrev&quot;, true);
1859 
1860             // Make a change with a corresponding PR
1861             var editHash = CheckableRepository.appendAndCommit(localRepo);
1862             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
1863             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
1864             pr.setBody(&quot;This is now ready&quot;);
1865 
1866             // Make a bunch of comments
1867             pr.addComment(&quot;Plain comment&quot;);
1868             pr.addComment(&quot;ignore this comment&quot;);
1869             pr.addComment(&quot;I think it is time to\nignore this comment!&quot;);
1870             pr.addReviewComment(masterHash, editHash, reviewFile.toString(), 2, &quot;Review ignore this comment&quot;);
1871 
1872             var ignoredPR = ignored.pullRequest(pr.id());
1873             ignoredPR.addComment(&quot;Don&#39;t mind me&quot;);
1874 
1875             TestBotRunner.runPeriodicItems(mlBot);
1876             TestBotRunner.runPeriodicItems(mlBot);
1877 
1878             // The archive should not contain the ignored comments
1879             Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);
1880             assertTrue(archiveContains(archiveFolder.path(), &quot;This is now ready&quot;));
1881             assertFalse(archiveContains(archiveFolder.path(), &quot;ignore this comment&quot;));
1882             assertFalse(archiveContains(archiveFolder.path(), &quot;it is time to&quot;));
1883             assertFalse(archiveContains(archiveFolder.path(), &quot;Don&#39;t mind me&quot;));
1884             assertFalse(archiveContains(archiveFolder.path(), &quot;Review ignore&quot;));
1885         }
1886     }
1887 
1888     @Test
1889     void replyToEmptyReview(TestInfo testInfo) throws IOException {
1890         try (var credentials = new HostCredentials(testInfo);
1891              var tempFolder = new TemporaryDirectory();
1892              var archiveFolder = new TemporaryDirectory();
1893              var listServer = new TestMailmanServer();
1894              var webrevServer = new TestWebrevServer()) {
1895             var author = credentials.getHostedRepository();
1896             var reviewer = credentials.getHostedRepository();
1897             var archive = credentials.getHostedRepository();
1898             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
1899             var censusBuilder = credentials.getCensusBuilder()
1900                                            .addReviewer(reviewer.forge().currentUser().id())
1901                                            .addAuthor(author.forge().currentUser().id());
1902             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
1903             var mlBot = MailingListBridgeBot.newBuilder()
1904                                             .from(from)
1905                                             .repo(author)
1906                                             .archive(archive)
1907                                             .censusRepo(censusBuilder.build())
1908                                             .list(listAddress)
1909                                             .listArchive(listServer.getArchive())
1910                                             .smtpServer(listServer.getSMTP())
1911                                             .webrevStorageRepository(archive)
1912                                             .webrevStorageRef(&quot;webrev&quot;)
1913                                             .webrevStorageBase(Path.of(&quot;test&quot;))
1914                                             .webrevStorageBaseUri(webrevServer.uri())
1915                                             .issueTracker(URIBuilder.base(&quot;http://issues.test/browse/&quot;).build())
1916                                             .build();
1917 
1918             // Populate the projects repository
1919             var reviewFile = Path.of(&quot;reviewfile.txt&quot;);
1920             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType(), reviewFile);
1921             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
1922             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
1923             localRepo.push(masterHash, archive.url(), &quot;webrev&quot;, true);
1924 
1925             // Make a change with a corresponding PR
1926             var editHash = CheckableRepository.appendAndCommit(localRepo);
1927             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
1928             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
1929             pr.setBody(&quot;This is now ready&quot;);
1930             TestBotRunner.runPeriodicItems(mlBot);
1931             listServer.processIncoming();
1932 
1933             // Make an empty approval
1934             var reviewPr = reviewer.pullRequest(pr.id());
1935             reviewPr.addReview(Review.Verdict.APPROVED, &quot;&quot;);
1936             TestBotRunner.runPeriodicItems(mlBot);
1937             listServer.processIncoming();
1938 
1939             pr.addComment(&quot;Thanks for the review!&quot;);
1940             TestBotRunner.runPeriodicItems(mlBot);
1941             listServer.processIncoming();
1942 
1943             // The approval text should be included in the quote
1944             Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);
1945             assertEquals(1, archiveContainsCount(archiveFolder.path(), &quot;^&gt; Marked as reviewed&quot;));
1946         }
1947     }
1948 
1949     @Test
1950     void cooldown(TestInfo testInfo) throws IOException {
1951         try (var credentials = new HostCredentials(testInfo);
1952              var tempFolder = new TemporaryDirectory();
1953              var archiveFolder = new TemporaryDirectory();
1954              var listServer = new TestMailmanServer();
1955              var webrevServer = new TestWebrevServer()) {
1956             var bot = credentials.getHostedRepository();
1957             var author = credentials.getHostedRepository();
1958             var archive = credentials.getHostedRepository();
1959             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
1960             var censusBuilder = credentials.getCensusBuilder()
1961                                            .addAuthor(author.forge().currentUser().id());
1962             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
1963             var mlBotBuilder = MailingListBridgeBot.newBuilder()
1964                                                    .from(from)
1965                                                    .repo(bot)
1966                                                    .ignoredUsers(Set.of(bot.forge().currentUser().userName()))
1967                                                    .archive(archive)
1968                                                    .censusRepo(censusBuilder.build())
1969                                                    .list(listAddress)
1970                                                    .listArchive(listServer.getArchive())
1971                                                    .smtpServer(listServer.getSMTP())
1972                                                    .webrevStorageRepository(archive)
1973                                                    .webrevStorageRef(&quot;webrev&quot;)
1974                                                    .webrevStorageBase(Path.of(&quot;test&quot;))
1975                                                    .webrevStorageBaseUri(webrevServer.uri())
1976                                                    .issueTracker(URIBuilder.base(&quot;http://issues.test/browse/&quot;).build());
1977 
1978             // Populate the projects repository
1979             var reviewFile = Path.of(&quot;reviewfile.txt&quot;);
1980             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType(), reviewFile);
1981             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
1982             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
1983             localRepo.push(masterHash, archive.url(), &quot;webrev&quot;, true);
1984 
1985             // Make a change with a corresponding PR
1986             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;Line 1\nLine 2\nLine 3\nLine 4&quot;);
1987             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
1988             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
1989             pr.setBody(&quot;This is now ready&quot;);
1990 
1991             var mlBot = mlBotBuilder.build();
1992             var mlBotWithCooldown = mlBotBuilder.cooldown(Duration.ofDays(1)).build();
1993 
1994             TestBotRunner.runPeriodicItems(mlBot);
1995             listServer.processIncoming();
1996 
1997             // Make a comment
1998             pr.addComment(&quot;Looks good&quot;);
1999 
2000             // Bot with cooldown configured should not bridge the comment
2001             TestBotRunner.runPeriodicItems(mlBotWithCooldown);
2002             assertThrows(RuntimeException.class, () -&gt; listServer.processIncoming(Duration.ofMillis(1)));
2003 
2004             // But without, it should
2005             TestBotRunner.runPeriodicItems(mlBot);
2006             listServer.processIncoming();
2007 
2008             // Check the archive
2009             Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);
2010             assertTrue(archiveContains(archiveFolder.path(), &quot;Looks good&quot;));
2011         }
2012     }
2013 
2014     @Test
2015     void cooldownNewRevision(TestInfo testInfo) throws IOException {
2016         try (var credentials = new HostCredentials(testInfo);
2017              var tempFolder = new TemporaryDirectory();
2018              var archiveFolder = new TemporaryDirectory();
2019              var listServer = new TestMailmanServer();
2020              var webrevServer = new TestWebrevServer()) {
2021             var bot = credentials.getHostedRepository();
2022             var author = credentials.getHostedRepository();
2023             var archive = credentials.getHostedRepository();
2024             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
2025             var censusBuilder = credentials.getCensusBuilder()
2026                                            .addAuthor(author.forge().currentUser().id());
2027             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
2028             var mlBotBuilder = MailingListBridgeBot.newBuilder()
2029                                                    .from(from)
2030                                                    .repo(bot)
2031                                                    .ignoredUsers(Set.of(bot.forge().currentUser().userName()))
2032                                                    .archive(archive)
2033                                                    .censusRepo(censusBuilder.build())
2034                                                    .list(listAddress)
2035                                                    .listArchive(listServer.getArchive())
2036                                                    .smtpServer(listServer.getSMTP())
2037                                                    .webrevStorageRepository(archive)
2038                                                    .webrevStorageRef(&quot;webrev&quot;)
2039                                                    .webrevStorageBase(Path.of(&quot;test&quot;))
2040                                                    .webrevStorageBaseUri(webrevServer.uri())
2041                                                    .issueTracker(URIBuilder.base(&quot;http://issues.test/browse/&quot;).build());
2042 
2043             // Populate the projects repository
2044             var reviewFile = Path.of(&quot;reviewfile.txt&quot;);
2045             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType(), reviewFile);
2046             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
2047             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
2048             localRepo.push(masterHash, archive.url(), &quot;webrev&quot;, true);
2049 
2050             // Make a change with a corresponding PR
2051             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;Line 1\nLine 2\nLine 3\nLine 4&quot;);
2052             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
2053             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
2054             pr.setBody(&quot;This is now ready&quot;);
2055 
2056             var mlBot = mlBotBuilder.build();
2057             var mlBotWithCooldown = mlBotBuilder.cooldown(Duration.ofDays(1)).build();
2058 
2059             TestBotRunner.runPeriodicItems(mlBot);
2060             listServer.processIncoming();
2061 
2062             // Commit another revision
2063             var updatedHash = CheckableRepository.appendAndCommit(localRepo, &quot;More stuff&quot;);
2064             localRepo.push(updatedHash, author.url(), &quot;edit&quot;);
2065 
2066             // Bot with cooldown configured should not create a new webrev
2067             TestBotRunner.runPeriodicItems(mlBotWithCooldown);
2068             assertThrows(RuntimeException.class, () -&gt; listServer.processIncoming(Duration.ofMillis(1)));
2069 
2070             // But without, it should
2071             TestBotRunner.runPeriodicItems(mlBot);
2072             listServer.processIncoming();
2073 
2074             // Check the archive
2075             Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);
2076             assertTrue(archiveContains(archiveFolder.path(), &quot;webrev.01&quot;));
2077         }
2078     }
2079 
2080     @Test
2081     void retryAfterCooldown(TestInfo testInfo) throws IOException, InterruptedException {
2082         try (var credentials = new HostCredentials(testInfo);
2083              var tempFolder = new TemporaryDirectory();
2084              var archiveFolder = new TemporaryDirectory();
2085              var listServer = new TestMailmanServer();
2086              var webrevServer = new TestWebrevServer()) {
2087             var bot = credentials.getHostedRepository();
2088             var author = credentials.getHostedRepository();
2089             var archive = credentials.getHostedRepository();
2090             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
2091             var censusBuilder = credentials.getCensusBuilder()
2092                                            .addAuthor(author.forge().currentUser().id());
2093             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
2094             var cooldown = Duration.ofMillis(500);
2095             var mlBotBuilder = MailingListBridgeBot.newBuilder()
2096                                                    .from(from)
2097                                                    .repo(bot)
2098                                                    .ignoredUsers(Set.of(bot.forge().currentUser().userName()))
2099                                                    .archive(archive)
2100                                                    .censusRepo(censusBuilder.build())
2101                                                    .list(listAddress)
2102                                                    .listArchive(listServer.getArchive())
2103                                                    .smtpServer(listServer.getSMTP())
2104                                                    .webrevStorageRepository(archive)
2105                                                    .webrevStorageRef(&quot;webrev&quot;)
2106                                                    .webrevStorageBase(Path.of(&quot;test&quot;))
2107                                                    .webrevStorageBaseUri(webrevServer.uri())
2108                                                    .issueTracker(URIBuilder.base(&quot;http://issues.test/browse/&quot;).build());
2109 
2110             // Populate the projects repository
2111             var reviewFile = Path.of(&quot;reviewfile.txt&quot;);
2112             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType(), reviewFile);
2113             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
2114             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
2115             localRepo.push(masterHash, archive.url(), &quot;webrev&quot;, true);
2116 
2117             // Make a change with a corresponding PR
2118             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;Line 1\nLine 2\nLine 3\nLine 4&quot;);
2119             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
2120             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
2121             pr.setBody(&quot;This is now ready&quot;);
2122 
2123             var mlBot = mlBotBuilder.cooldown(cooldown).build();
2124             Thread.sleep(cooldown.toMillis());
2125             TestBotRunner.runPeriodicItems(mlBot);
2126             listServer.processIncoming();
2127 
2128             // Make a comment and run the check within the cooldown period
2129             int counter;
2130             boolean noMailReceived = false;
2131             for (counter = 1; counter &lt; 10; ++counter) {
2132                 var start = Instant.now();
2133                 pr.addComment(&quot;Looks good - &quot; + counter + &quot; -&quot;);
2134 
2135                 // The bot should not bridge the comment due to cooldown
2136                 TestBotRunner.runPeriodicItems(mlBot);
2137                 try {
2138                     noMailReceived = false;
2139                     listServer.processIncoming(Duration.ofMillis(1));
2140                 } catch (RuntimeException e) {
2141                     noMailReceived = true;
2142                 }
2143                 var elapsed = Duration.between(start, Instant.now());
2144                 if (elapsed.compareTo(cooldown) &lt; 0) {
2145                     break;
2146                 } else {
2147                     log.info(&quot;Didn&#39;t do the test in time - retrying (elapsed: &quot; + elapsed + &quot; required: &quot; + cooldown + &quot;)&quot;);
2148                     // Ensure that the cooldown expires
2149                     Thread.sleep(cooldown.toMillis());
2150                     // If no mail was received, we have to flush it out
2151                     if (noMailReceived) {
2152                         TestBotRunner.runPeriodicItems(mlBot);
2153                         listServer.processIncoming();
2154                     }
2155                     cooldown = cooldown.multipliedBy(2);
2156                     mlBot = mlBotBuilder.cooldown(cooldown).build();
2157                 }
2158             }
2159             assertTrue(noMailReceived);
2160 
2161             // But after the cooldown period has passed, it should
2162             Thread.sleep(cooldown.toMillis());
2163             TestBotRunner.runPeriodicItems(mlBot);
2164             listServer.processIncoming();
2165 
2166             // Check the archive
2167             Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);
2168             assertTrue(archiveContains(archiveFolder.path(), &quot;Looks good - &quot; + counter + &quot; -&quot;));
2169         }
2170     }
2171 
2172     @Test
2173     void branchPrefix(TestInfo testInfo) throws IOException {
2174         try (var credentials = new HostCredentials(testInfo);
2175              var tempFolder = new TemporaryDirectory();
2176              var archiveFolder = new TemporaryDirectory();
2177              var listServer = new TestMailmanServer();
2178              var webrevServer = new TestWebrevServer()) {
2179             var author = credentials.getHostedRepository();
2180             var archive = credentials.getHostedRepository();
2181             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
2182             var censusBuilder = credentials.getCensusBuilder()
2183                                            .addAuthor(author.forge().currentUser().id());
2184             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
2185             var mlBot = MailingListBridgeBot.newBuilder()
2186                                             .from(from)
2187                                             .repo(author)
2188                                             .archive(archive)
2189                                             .censusRepo(censusBuilder.build())
2190                                             .list(listAddress)
2191                                             .listArchive(listServer.getArchive())
2192                                             .smtpServer(listServer.getSMTP())
2193                                             .webrevStorageRepository(archive)
2194                                             .webrevStorageRef(&quot;webrev&quot;)
2195                                             .webrevStorageBase(Path.of(&quot;test&quot;))
2196                                             .webrevStorageBaseUri(webrevServer.uri())
2197                                             .issueTracker(URIBuilder.base(&quot;http://issues.test/browse/&quot;).build())
2198                                             .branchInSubject(Pattern.compile(&quot;.*&quot;))
2199                                             .build();
2200 
2201             // Populate the projects repository
2202             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType());
2203             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
2204             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
2205             localRepo.push(masterHash, archive.url(), &quot;webrev&quot;, true);
2206 
2207             // Make a change with a corresponding PR
2208             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;A simple change&quot;,
2209                                                                &quot;Change msg\n\nWith several lines&quot;);
2210             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
2211             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;1234: This is a pull request&quot;);
2212             pr.setBody(&quot;This is a PR&quot;);
2213 
2214             // Run an archive pass
2215             TestBotRunner.runPeriodicItems(mlBot);
2216             listServer.processIncoming();
2217 
2218             pr.addComment(&quot;Looks good!&quot;);
2219             TestBotRunner.runPeriodicItems(mlBot);
2220             listServer.processIncoming();
2221 
2222             // Check the archive
2223             Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);
2224             assertTrue(archiveContains(archiveFolder.path(), &quot;Subject: \\[master\\] RFR: &quot;));
2225             assertTrue(archiveContains(archiveFolder.path(), &quot;Subject: Re: \\[master\\] RFR: &quot;));
2226         }
2227     }
2228 
2229     @Test
2230     void repoPrefix(TestInfo testInfo) throws IOException {
2231         try (var credentials = new HostCredentials(testInfo);
2232              var tempFolder = new TemporaryDirectory();
2233              var archiveFolder = new TemporaryDirectory();
2234              var listServer = new TestMailmanServer();
2235              var webrevServer = new TestWebrevServer()) {
2236             var author = credentials.getHostedRepository();
2237             var archive = credentials.getHostedRepository();
2238             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
2239             var censusBuilder = credentials.getCensusBuilder()
2240                                            .addAuthor(author.forge().currentUser().id());
2241             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
2242             var mlBot = MailingListBridgeBot.newBuilder()
2243                                             .from(from)
2244                                             .repo(author)
2245                                             .archive(archive)
2246                                             .censusRepo(censusBuilder.build())
2247                                             .list(listAddress)
2248                                             .listArchive(listServer.getArchive())
2249                                             .smtpServer(listServer.getSMTP())
2250                                             .webrevStorageRepository(archive)
2251                                             .webrevStorageRef(&quot;webrev&quot;)
2252                                             .webrevStorageBase(Path.of(&quot;test&quot;))
2253                                             .webrevStorageBaseUri(webrevServer.uri())
2254                                             .issueTracker(URIBuilder.base(&quot;http://issues.test/browse/&quot;).build())
2255                                             .repoInSubject(true)
2256                                             .build();
2257 
2258             // Populate the projects repository
2259             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType());
2260             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
2261             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
2262             localRepo.push(masterHash, archive.url(), &quot;webrev&quot;, true);
2263 
2264             // Make a change with a corresponding PR
2265             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;A simple change&quot;,
2266                                                                &quot;Change msg\n\nWith several lines&quot;);
2267             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
2268             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;1234: This is a pull request&quot;);
2269             pr.setBody(&quot;This is a PR&quot;);
2270 
2271             // Run an archive pass
2272             TestBotRunner.runPeriodicItems(mlBot);
2273             listServer.processIncoming();
2274 
2275             pr.addComment(&quot;Looks good!&quot;);
2276             TestBotRunner.runPeriodicItems(mlBot);
2277             listServer.processIncoming();
2278 
2279             // Check the archive
2280             Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);
2281             assertTrue(archiveContains(archiveFolder.path(), &quot;Subject: \\[&quot; + pr.repository().name() + &quot;\\] RFR: &quot;));
2282             assertTrue(archiveContains(archiveFolder.path(), &quot;Subject: Re: \\[&quot; + pr.repository().name() + &quot;\\] RFR: &quot;));
2283         }
2284     }
2285 
2286     @Test
2287     void repoAndBranchPrefix(TestInfo testInfo) throws IOException {
2288         try (var credentials = new HostCredentials(testInfo);
2289              var tempFolder = new TemporaryDirectory();
2290              var archiveFolder = new TemporaryDirectory();
2291              var listServer = new TestMailmanServer();
2292              var webrevServer = new TestWebrevServer()) {
2293             var author = credentials.getHostedRepository();
2294             var archive = credentials.getHostedRepository();
2295             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
2296             var censusBuilder = credentials.getCensusBuilder()
2297                                            .addAuthor(author.forge().currentUser().id());
2298             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
2299             var mlBot = MailingListBridgeBot.newBuilder()
2300                                             .from(from)
2301                                             .repo(author)
2302                                             .archive(archive)
2303                                             .censusRepo(censusBuilder.build())
2304                                             .list(listAddress)
2305                                             .listArchive(listServer.getArchive())
2306                                             .smtpServer(listServer.getSMTP())
2307                                             .webrevStorageRepository(archive)
2308                                             .webrevStorageRef(&quot;webrev&quot;)
2309                                             .webrevStorageBase(Path.of(&quot;test&quot;))
2310                                             .webrevStorageBaseUri(webrevServer.uri())
2311                                             .issueTracker(URIBuilder.base(&quot;http://issues.test/browse/&quot;).build())
2312                                             .repoInSubject(true)
2313                                             .branchInSubject(Pattern.compile(&quot;.*&quot;))
2314                                             .build();
2315 
2316             // Populate the projects repository
2317             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType());
2318             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
2319             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
2320             localRepo.push(masterHash, archive.url(), &quot;webrev&quot;, true);
2321 
2322             // Make a change with a corresponding PR
2323             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;A simple change&quot;,
2324                                                                &quot;Change msg\n\nWith several lines&quot;);
2325             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
2326             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;1234: This is a pull request&quot;);
2327             pr.setBody(&quot;This is a PR&quot;);
2328 
2329             // Run an archive pass
2330             TestBotRunner.runPeriodicItems(mlBot);
2331             listServer.processIncoming();
2332 
2333             pr.addComment(&quot;Looks good!&quot;);
2334             TestBotRunner.runPeriodicItems(mlBot);
2335             listServer.processIncoming();
2336 
2337             // Check the archive
2338             Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);
2339             assertTrue(archiveContains(archiveFolder.path(), &quot;Subject: \\[&quot; + pr.repository().name() + &quot;:master\\] RFR: &quot;));
2340             assertTrue(archiveContains(archiveFolder.path(), &quot;Subject: Re: \\[&quot; + pr.repository().name() + &quot;:master\\] RFR: &quot;));
2341         }
2342     }
2343 
2344     @Test
2345     void retryNewRevisionAfterCooldown(TestInfo testInfo) throws IOException, InterruptedException {
2346         try (var credentials = new HostCredentials(testInfo);
2347              var tempFolder = new TemporaryDirectory();
2348              var archiveFolder = new TemporaryDirectory();
2349              var listServer = new TestMailmanServer();
2350              var webrevServer = new TestWebrevServer()) {
2351             var bot = credentials.getHostedRepository();
2352             var author = credentials.getHostedRepository();
2353             var archive = credentials.getHostedRepository();
2354             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
2355             var censusBuilder = credentials.getCensusBuilder()
2356                                            .addAuthor(author.forge().currentUser().id());
2357             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
2358             var cooldown = Duration.ofMillis(500);
2359             var mlBotBuilder = MailingListBridgeBot.newBuilder()
2360                                                    .from(from)
2361                                                    .repo(bot)
2362                                                    .ignoredUsers(Set.of(bot.forge().currentUser().userName()))
2363                                                    .archive(archive)
2364                                                    .censusRepo(censusBuilder.build())
2365                                                    .list(listAddress)
2366                                                    .listArchive(listServer.getArchive())
2367                                                    .smtpServer(listServer.getSMTP())
2368                                                    .webrevStorageRepository(archive)
2369                                                    .webrevStorageRef(&quot;webrev&quot;)
2370                                                    .webrevStorageBase(Path.of(&quot;test&quot;))
2371                                                    .webrevStorageBaseUri(webrevServer.uri())
2372                                                    .issueTracker(URIBuilder.base(&quot;http://issues.test/browse/&quot;).build());
2373 
2374             // Populate the projects repository
2375             var reviewFile = Path.of(&quot;reviewfile.txt&quot;);
2376             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType(), reviewFile);
2377             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
2378             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
2379             localRepo.push(masterHash, archive.url(), &quot;webrev&quot;, true);
2380 
2381             // Make a change with a corresponding PR
2382             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;Line 1\nLine 2\nLine 3\nLine 4&quot;);
2383             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
2384             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
2385             pr.setBody(&quot;This is now ready&quot;);
2386 
2387             var mlBot = mlBotBuilder.cooldown(cooldown).build();
2388             Thread.sleep(cooldown.toMillis());
2389             TestBotRunner.runPeriodicItems(mlBot);
2390             listServer.processIncoming();
2391 
2392             // Make a new revision and run the check within the cooldown period
2393             int counter;
2394             boolean noMailReceived = false;
2395             for (counter = 1; counter &lt; 10; ++counter) {
2396                 var start = Instant.now();
2397                 var revHash = CheckableRepository.appendAndCommit(localRepo, &quot;more stuff&quot;, &quot;Update number - &quot; + counter + &quot; -&quot;);
2398                 localRepo.push(revHash, author.url(), &quot;edit&quot;);
2399 
2400                 // The bot should not bridge the new revision due to cooldown
2401                 TestBotRunner.runPeriodicItems(mlBot);
2402                 try {
2403                     noMailReceived = false;
2404                     listServer.processIncoming(Duration.ofMillis(1));
2405                 } catch (RuntimeException e) {
2406                     noMailReceived = true;
2407                 }
2408                 var elapsed = Duration.between(start, Instant.now());
2409                 if (elapsed.compareTo(cooldown) &lt; 0) {
2410                     break;
2411                 } else {
2412                     log.info(&quot;Didn&#39;t do the test in time - retrying (elapsed: &quot; + elapsed + &quot; required: &quot; + cooldown + &quot;)&quot;);
2413                     // Ensure that the cooldown expires
2414                     Thread.sleep(cooldown.toMillis());
2415                     // If no mail was received, we have to flush it out
2416                     if (noMailReceived) {
2417                         TestBotRunner.runPeriodicItems(mlBot);
2418                         listServer.processIncoming();
2419                     }
2420                     cooldown = cooldown.multipliedBy(2);
2421                     mlBot = mlBotBuilder.cooldown(cooldown).build();
2422                 }
2423             }
2424             assertTrue(noMailReceived);
2425 
2426             // But after the cooldown period has passed, it should
2427             Thread.sleep(cooldown.toMillis());
2428             TestBotRunner.runPeriodicItems(mlBot);
2429             listServer.processIncoming();
2430 
2431             // Check the archive
2432             Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);
2433             assertTrue(archiveContains(archiveFolder.path(), &quot;Update number - &quot; + counter + &quot; -&quot;));
2434         }
2435     }
2436 }
<a name="3" id="anc3"></a><b style="font-size: large; color: red">--- EOF ---</b>
















































































</pre>
<input id="eof" value="3" type="hidden" />
</body>
</html>