<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Old bots/mlbridge/src/test/java/org/openjdk/skara/bots/mlbridge/MailingListBridgeBotTests.java</title>
    <link rel="stylesheet" href="../../../../../../../../../../style.css" />
  </head>
  <body>
    <pre>
   1 /*
   2  * Copyright (c) 2019, Oracle and/or its affiliates. All rights reserved.
   3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   4  *
   5  * This code is free software; you can redistribute it and/or modify it
   6  * under the terms of the GNU General Public License version 2 only, as
   7  * published by the Free Software Foundation.
   8  *
   9  * This code is distributed in the hope that it will be useful, but WITHOUT
  10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
  11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
  12  * version 2 for more details (a copy is included in the LICENSE file that
  13  * accompanied this code).
  14  *
  15  * You should have received a copy of the GNU General Public License version
  16  * 2 along with this work; if not, write to the Free Software Foundation,
  17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
  18  *
  19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
  20  * or visit www.oracle.com if you need additional information or have any
  21  * questions.
  22  */
  23 package org.openjdk.skara.bots.mlbridge;
  24 
  25 import org.openjdk.skara.email.EmailAddress;
  26 import org.openjdk.skara.forge.*;
  27 import org.openjdk.skara.issuetracker.Issue;
  28 import org.openjdk.skara.network.URIBuilder;
  29 import org.openjdk.skara.mailinglist.MailingListServerFactory;
  30 import org.openjdk.skara.test.*;
  31 import org.openjdk.skara.vcs.Repository;
  32 
  33 import org.junit.jupiter.api.*;
  34 
  35 import java.io.IOException;
  36 import java.nio.charset.StandardCharsets;
  37 import java.nio.file.*;
  38 import java.time.*;
  39 import java.util.*;
  40 import java.util.logging.Logger;
  41 import java.util.regex.Pattern;
  42 import java.util.stream.Collectors;
  43 
  44 import static org.junit.jupiter.api.Assertions.*;
  45 
  46 class MailingListBridgeBotTests {
  47     private final Logger log = Logger.getLogger(&quot;org.openjdk.skara.bots.mlbridge.test&quot;);
  48 
  49     private Optional&lt;String&gt; archiveContents(Path archive) {
  50         try {
  51             var mbox = Files.find(archive, 50, (path, attrs) -&gt; path.toString().endsWith(&quot;.mbox&quot;)).findAny();
  52             if (mbox.isEmpty()) {
  53                 return Optional.empty();
  54             }
  55             return Optional.of(Files.readString(mbox.get(), StandardCharsets.UTF_8));
  56         } catch (IOException e) {
  57             return Optional.empty();
  58         }
  59 
  60     }
  61 
  62     private boolean archiveContains(Path archive, String text) {
  63         return archiveContainsCount(archive, text) &gt; 0;
  64     }
  65 
  66     private int archiveContainsCount(Path archive, String text) {
  67         var lines = archiveContents(archive);
  68         if (lines.isEmpty()) {
  69             return 0;
  70         }
  71         var pattern = Pattern.compile(text);
  72         int count = 0;
  73         for (var line : lines.get().split(&quot;\\R&quot;)) {
  74             var matcher = pattern.matcher(line);
  75             if (matcher.find()) {
  76                 count++;
  77             }
  78         }
  79         return count;
  80     }
  81 
  82     private boolean webrevContains(Path webrev, String text) {
  83         try {
  84             var index = Files.find(webrev, 5, (path, attrs) -&gt; path.toString().endsWith(&quot;index.html&quot;)).findAny();
  85             if (index.isEmpty()) {
  86                 return false;
  87             }
  88             var lines = Files.readString(index.get(), StandardCharsets.UTF_8);
  89             return lines.contains(text);
  90         } catch (IOException e) {
  91             return false;
  92         }
  93     }
  94 
  95     private long countSubstrings(String string, String substring) {
  96         return Pattern.compile(substring).matcher(string).results().count();
  97     }
  98 
  99     private String noreplyAddress(HostedRepository repository) {
 100         return &quot;test+&quot; + repository.forge().currentUser().id() + &quot;+&quot; +
 101                 repository.forge().currentUser().userName() +
 102                 &quot;@openjdk.java.net&quot;;
 103     }
 104 
 105     @Test
 106     void simpleArchive(TestInfo testInfo) throws IOException {
 107         try (var credentials = new HostCredentials(testInfo);
 108              var tempFolder = new TemporaryDirectory();
 109              var archiveFolder = new TemporaryDirectory();
 110              var webrevFolder = new TemporaryDirectory();
 111              var listServer = new TestMailmanServer();
 112              var webrevServer = new TestWebrevServer()) {
 113             var author = credentials.getHostedRepository();
 114             var archive = credentials.getHostedRepository();
 115             var ignored = credentials.getHostedRepository();
 116             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
 117             var censusBuilder = credentials.getCensusBuilder()
 118                                            .addAuthor(author.forge().currentUser().id());
 119             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
 120             var mlBot = MailingListBridgeBot.newBuilder()
 121                                             .from(from)
 122                                             .repo(author)
 123                                             .archive(archive)
 124                                             .censusRepo(censusBuilder.build())
 125                                             .list(listAddress)
 126                                             .ignoredUsers(Set.of(ignored.forge().currentUser().userName()))
 127                                             .ignoredComments(Set.of())
 128                                             .listArchive(listServer.getArchive())
 129                                             .smtpServer(listServer.getSMTP())
 130                                             .webrevStorageRepository(archive)
 131                                             .webrevStorageRef(&quot;webrev&quot;)
 132                                             .webrevStorageBase(Path.of(&quot;test&quot;))
 133                                             .webrevStorageBaseUri(webrevServer.uri())
 134                                             .readyLabels(Set.of(&quot;rfr&quot;))
 135                                             .readyComments(Map.of(ignored.forge().currentUser().userName(), Pattern.compile(&quot;ready&quot;)))
 136                                             .issueTracker(URIBuilder.base(&quot;http://issues.test/browse/&quot;).build())
 137                                             .headers(Map.of(&quot;Extra1&quot;, &quot;val1&quot;, &quot;Extra2&quot;, &quot;val2&quot;))
 138                                             .sendInterval(Duration.ZERO)
 139                                             .build();
 140 
 141             // Populate the projects repository
 142             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType());
 143             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
 144             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
 145             localRepo.push(masterHash, archive.url(), &quot;webrev&quot;, true);
 146 
 147             // Make a change with a corresponding PR
 148             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;A simple change&quot;,
 149                                                                &quot;Change msg\n\nWith several lines&quot;);
 150             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
 151             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;1234: This is a pull request&quot;);
 152             pr.setBody(&quot;This should not be ready&quot;);
 153 
 154             // Run an archive pass
 155             TestBotRunner.runPeriodicItems(mlBot);
 156 
 157             // A PR that isn&#39;t ready for review should not be archived
 158             Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);
 159             assertFalse(archiveContains(archiveFolder.path(), &quot;This is a pull request&quot;));
 160 
 161             // Flag it as ready for review
 162             pr.setBody(&quot;This should now be ready&quot;);
 163             pr.addLabel(&quot;rfr&quot;);
 164 
 165             // Run another archive pass
 166             TestBotRunner.runPeriodicItems(mlBot);
 167 
 168             // But it should still not be archived
 169             Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);
 170             assertFalse(archiveContains(archiveFolder.path(), &quot;This is a pull request&quot;));
 171 
 172             // Now post a general comment - not a ready marker
 173             var ignoredPr = ignored.pullRequest(pr.id());
 174             ignoredPr.addComment(&quot;hello there&quot;);
 175 
 176             // Run another archive pass
 177             TestBotRunner.runPeriodicItems(mlBot);
 178 
 179             // It should still not be archived
 180             Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);
 181             assertFalse(archiveContains(archiveFolder.path(), &quot;This is a pull request&quot;));
 182 
 183             // Now post a ready comment
 184             ignoredPr.addComment(&quot;ready&quot;);
 185 
 186             // Run another archive pass
 187             TestBotRunner.runPeriodicItems(mlBot);
 188 
 189             // The archive should now contain an entry
 190             Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);
 191             assertTrue(archiveContains(archiveFolder.path(), &quot;This is a pull request&quot;));
 192             assertTrue(archiveContains(archiveFolder.path(), &quot;This should now be ready&quot;));
 193             assertTrue(archiveContains(archiveFolder.path(), &quot;Patch:&quot;));
 194             assertTrue(archiveContains(archiveFolder.path(), &quot;Changes:&quot;));
 195             assertTrue(archiveContains(archiveFolder.path(), &quot;Webrev:&quot;));
 196             assertTrue(archiveContains(archiveFolder.path(), webrevServer.uri().toString()));
 197             assertTrue(archiveContains(archiveFolder.path(), &quot;webrev.00&quot;));
 198             assertTrue(archiveContains(archiveFolder.path(), &quot;Issue:&quot;));
 199             assertTrue(archiveContains(archiveFolder.path(), &quot;http://issues.test/browse/TSTPRJ-1234&quot;));
 200             assertTrue(archiveContains(archiveFolder.path(), &quot;Fetch:&quot;));
 201             assertTrue(archiveContains(archiveFolder.path(), &quot;^ - Change msg&quot;));
 202             assertFalse(archiveContains(archiveFolder.path(), &quot;With several lines&quot;));
 203 
 204             // The mailing list as well
 205             listServer.processIncoming();
 206             var mailmanServer = MailingListServerFactory.createMailmanServer(listServer.getArchive(), listServer.getSMTP(), Duration.ZERO);
 207             var mailmanList = mailmanServer.getList(listAddress.address());
 208             var conversations = mailmanList.conversations(Duration.ofDays(1));
 209             assertEquals(1, conversations.size());
 210             var mail = conversations.get(0).first();
 211             assertEquals(&quot;RFR: 1234: This is a pull request&quot;, mail.subject());
 212             assertEquals(pr.author().fullName(), mail.author().fullName().orElseThrow());
 213             assertEquals(noreplyAddress(archive), mail.author().address());
 214             assertEquals(listAddress, mail.sender());
 215             assertEquals(&quot;val1&quot;, mail.headerValue(&quot;Extra1&quot;));
 216             assertEquals(&quot;val2&quot;, mail.headerValue(&quot;Extra2&quot;));
 217 
 218             // And there should be a webrev
 219             Repository.materialize(webrevFolder.path(), archive.url(), &quot;webrev&quot;);
 220             assertTrue(webrevContains(webrevFolder.path(), &quot;1 lines changed&quot;));
 221             var comments = pr.comments();
 222             var webrevComments = comments.stream()
 223                                          .filter(comment -&gt; comment.author().equals(author.forge().currentUser()))
 224                                          .filter(comment -&gt; comment.body().contains(&quot;webrev&quot;))
 225                                          .filter(comment -&gt; comment.body().contains(editHash.hex()))
 226                                          .collect(Collectors.toList());
 227             assertEquals(1, webrevComments.size());
 228 
 229             // Add a comment
 230             pr.addComment(&quot;This is a comment :smile:&quot;);
 231 
 232             // Add a comment from an ignored user as well
 233             ignoredPr.addComment(&quot;Don&#39;t mind me&quot;);
 234 
 235             // Run another archive pass
 236             TestBotRunner.runPeriodicItems(mlBot);
 237 
 238             // The archive should now contain the comment, but not the ignored one
 239             Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);
 240             assertTrue(archiveContains(archiveFolder.path(), &quot;This is a comment&quot;));
 241             assertTrue(archiveContains(archiveFolder.path(), &quot;&gt; This should now be ready&quot;));
 242             assertFalse(archiveContains(archiveFolder.path(), &quot;Don&#39;t mind me&quot;));
 243 
 244             listServer.processIncoming();
 245             conversations = mailmanList.conversations(Duration.ofDays(1));
 246             assertEquals(1, conversations.size());
 247             assertEquals(2, conversations.get(0).allMessages().size());
 248 
 249             // Remove the rfr flag and post another comment
 250             pr.addLabel(&quot;rfr&quot;);
 251             pr.addComment(&quot;This is another comment&quot;);
 252 
 253             // Run another archive pass
 254             TestBotRunner.runPeriodicItems(mlBot);
 255 
 256             // The archive should contain the additional comment
 257             Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);
 258             assertTrue(archiveContains(archiveFolder.path(), &quot;This is another comment&quot;));
 259             assertTrue(archiveContains(archiveFolder.path(), &quot;&gt;&gt; This should now be ready&quot;));
 260 
 261             listServer.processIncoming();
 262             conversations = mailmanList.conversations(Duration.ofDays(1));
 263             assertEquals(1, conversations.size());
 264             assertEquals(3, conversations.get(0).allMessages().size());
 265             for (var newMail : conversations.get(0).allMessages()) {
 266                 assertEquals(noreplyAddress(archive), newMail.author().address());
 267                 assertEquals(listAddress, newMail.sender());
 268             }
 269             assertTrue(conversations.get(0).allMessages().get(2).body().contains(&quot;This is a comment ðŸ˜„&quot;));
 270         }
 271     }
 272 
 273     @Test
 274     void archiveIntegrated(TestInfo testInfo) throws IOException {
 275         try (var credentials = new HostCredentials(testInfo);
 276              var tempFolder = new TemporaryDirectory();
 277              var archiveFolder = new TemporaryDirectory();
 278              var webrevFolder = new TemporaryDirectory();
 279              var listServer = new TestMailmanServer();
 280              var webrevServer = new TestWebrevServer()) {
 281             var author = credentials.getHostedRepository();
 282             var archive = credentials.getHostedRepository();
 283             var ignored = credentials.getHostedRepository();
 284             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
 285             var censusBuilder = credentials.getCensusBuilder()
 286                                            .addAuthor(author.forge().currentUser().id());
 287             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
 288             var mlBot = MailingListBridgeBot.newBuilder()
 289                                             .from(from)
 290                                             .repo(author)
 291                                             .archive(archive)
 292                                             .censusRepo(censusBuilder.build())
 293                                             .list(listAddress)
 294                                             .ignoredUsers(Set.of(ignored.forge().currentUser().userName()))
 295                                             .listArchive(listServer.getArchive())
 296                                             .smtpServer(listServer.getSMTP())
 297                                             .webrevStorageRepository(archive)
 298                                             .webrevStorageRef(&quot;webrev&quot;)
 299                                             .webrevStorageBase(Path.of(&quot;test&quot;))
 300                                             .webrevStorageBaseUri(webrevServer.uri())
 301                                             .issueTracker(URIBuilder.base(&quot;http://issues.test/browse/&quot;).build())
 302                                             .build();
 303 
 304             // Populate the projects repository
 305             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType());
 306             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
 307             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
 308             localRepo.push(masterHash, archive.url(), &quot;webrev&quot;, true);
 309 
 310             // Make a change with a corresponding PR
 311             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;A simple change&quot;,
 312                                                                &quot;Change msg\n\nWith several lines&quot;);
 313             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
 314             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;1234: This is a pull request&quot;);
 315             pr.setBody(&quot;This is now ready&quot;);
 316             pr.addLabel(&quot;rfr&quot;);
 317 
 318             // Run an archive pass
 319             TestBotRunner.runPeriodicItems(mlBot);
 320             TestBotRunner.runPeriodicItems(mlBot);
 321 
 322             // There should be an RFR thread
 323             Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);
 324             assertTrue(archiveContains(archiveFolder.path(), &quot;Subject: RFR: 1234: This is a pull request&quot;));
 325 
 326             // Now it has been integrated
 327             var ignoredPr = ignored.pullRequest(pr.id());
 328             ignoredPr.setBody(&quot;This has been integrated&quot;);
 329             ignoredPr.addLabel(&quot;integrated&quot;);
 330             ignoredPr.addComment(&quot;Pushed as commit &quot; + editHash + &quot;.&quot;);
 331             ignoredPr.setState(Issue.State.CLOSED);
 332 
 333             // Run another archive pass
 334             TestBotRunner.runPeriodicItems(mlBot);
 335 
 336             // The archive should now contain another entry
 337             Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);
 338             assertTrue(archiveContains(archiveFolder.path(), &quot;Subject: Re: \\[Integrated\\] RFR: 1234: This is a pull request&quot;));
 339             assertFalse(archiveContains(archiveFolder.path(), &quot;\\[Closed\\]&quot;));
 340         }
 341     }
 342 
 343     @Test
 344     void archiveDirectToIntegrated(TestInfo testInfo) throws IOException {
 345         try (var credentials = new HostCredentials(testInfo);
 346              var tempFolder = new TemporaryDirectory();
 347              var archiveFolder = new TemporaryDirectory();
 348              var webrevFolder = new TemporaryDirectory();
 349              var listServer = new TestMailmanServer();
 350              var webrevServer = new TestWebrevServer()) {
 351             var author = credentials.getHostedRepository();
 352             var archive = credentials.getHostedRepository();
 353             var ignored = credentials.getHostedRepository();
 354             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
 355             var censusBuilder = credentials.getCensusBuilder()
 356                                            .addAuthor(author.forge().currentUser().id());
 357             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
 358             var mlBot = MailingListBridgeBot.newBuilder()
 359                                             .from(from)
 360                                             .repo(author)
 361                                             .archive(archive)
 362                                             .censusRepo(censusBuilder.build())
 363                                             .list(listAddress)
 364                                             .ignoredUsers(Set.of(ignored.forge().currentUser().userName()))
 365                                             .listArchive(listServer.getArchive())
 366                                             .smtpServer(listServer.getSMTP())
 367                                             .webrevStorageRepository(archive)
 368                                             .webrevStorageRef(&quot;webrev&quot;)
 369                                             .webrevStorageBase(Path.of(&quot;test&quot;))
 370                                             .webrevStorageBaseUri(webrevServer.uri())
 371                                             .issueTracker(URIBuilder.base(&quot;http://issues.test/browse/&quot;).build())
 372                                             .build();
 373 
 374             // Populate the projects repository
 375             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType());
 376             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
 377             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
 378             localRepo.push(masterHash, archive.url(), &quot;webrev&quot;, true);
 379 
 380             // Make a change with a corresponding PR
 381             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;A simple change&quot;,
 382                                                                &quot;Change msg\n\nWith several lines&quot;);
 383             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
 384             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;1234: This is a pull request&quot;);
 385             pr.setBody(&quot;This should not be ready&quot;);
 386             pr.setState(Issue.State.CLOSED);
 387 
 388             // Run an archive pass
 389             TestBotRunner.runPeriodicItems(mlBot);
 390             TestBotRunner.runPeriodicItems(mlBot);
 391 
 392             // A PR that isn&#39;t ready for review should not be archived
 393             Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);
 394             assertFalse(archiveContains(archiveFolder.path(), &quot;This is a pull request&quot;));
 395 
 396             // Now it has been integrated
 397             var ignoredPr = ignored.pullRequest(pr.id());
 398             ignoredPr.setBody(&quot;This has already been integrated&quot;);
 399             ignoredPr.addLabel(&quot;integrated&quot;);
 400             ignoredPr.addComment(&quot;Pushed as commit &quot; + editHash + &quot;.&quot;);
 401 
 402             // Run another archive pass
 403             TestBotRunner.runPeriodicItems(mlBot);
 404 
 405             // The archive should now contain an entry
 406             Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);
 407             assertTrue(archiveContains(archiveFolder.path(), &quot;Subject: FYI: 1234: This is a pull request&quot;));
 408 
 409             var updatedHash = CheckableRepository.appendAndCommit(localRepo, &quot;Another change&quot;);
 410             localRepo.push(updatedHash, author.url(), &quot;edit&quot;);
 411 
 412             // Run another archive pass
 413             TestBotRunner.runPeriodicItems(mlBot);
 414 
 415             // The archive should now contain another entry
 416             Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);
 417             assertTrue(archiveContains(archiveFolder.path(), &quot;Subject: Re: \\[Rev 01\\] FYI: 1234: This is a pull request&quot;));
 418             assertFalse(archiveContains(archiveFolder.path(), &quot;\\[Closed\\]&quot;));
 419         }
 420     }
 421 
 422     @Test
 423     void archiveIntegratedRetainPrefix(TestInfo testInfo) throws IOException {
 424         try (var credentials = new HostCredentials(testInfo);
 425              var tempFolder = new TemporaryDirectory();
 426              var archiveFolder = new TemporaryDirectory();
 427              var webrevFolder = new TemporaryDirectory();
 428              var listServer = new TestMailmanServer();
 429              var webrevServer = new TestWebrevServer()) {
 430             var author = credentials.getHostedRepository();
 431             var archive = credentials.getHostedRepository();
 432             var ignored = credentials.getHostedRepository();
 433             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
 434             var censusBuilder = credentials.getCensusBuilder()
 435                                            .addAuthor(author.forge().currentUser().id());
 436             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
 437             var mlBot = MailingListBridgeBot.newBuilder()
 438                                             .from(from)
 439                                             .repo(author)
 440                                             .archive(archive)
 441                                             .censusRepo(censusBuilder.build())
 442                                             .list(listAddress)
 443                                             .ignoredUsers(Set.of(ignored.forge().currentUser().userName()))
 444                                             .listArchive(listServer.getArchive())
 445                                             .smtpServer(listServer.getSMTP())
 446                                             .webrevStorageRepository(archive)
 447                                             .webrevStorageRef(&quot;webrev&quot;)
 448                                             .webrevStorageBase(Path.of(&quot;test&quot;))
 449                                             .webrevStorageBaseUri(webrevServer.uri())
 450                                             .readyLabels(Set.of(&quot;rfr&quot;))
 451                                             .issueTracker(URIBuilder.base(&quot;http://issues.test/browse/&quot;).build())
 452                                             .build();
 453 
 454             // Populate the projects repository
 455             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType());
 456             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
 457             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
 458             localRepo.push(masterHash, archive.url(), &quot;webrev&quot;, true);
 459 
 460             // Make a change with a corresponding PR
 461             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;A simple change&quot;,
 462                                                                &quot;Change msg\n\nWith several lines&quot;);
 463             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
 464             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;1234: This is a pull request&quot;);
 465             pr.setBody(&quot;This should be ready&quot;);
 466 
 467             // Run an archive pass
 468             TestBotRunner.runPeriodicItems(mlBot);
 469             TestBotRunner.runPeriodicItems(mlBot);
 470 
 471             // A PR that isn&#39;t ready for review should not be archived
 472             Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);
 473             assertFalse(archiveContains(archiveFolder.path(), &quot;This is a pull request&quot;));
 474 
 475             // Flag it as ready for review
 476             pr.addLabel(&quot;rfr&quot;);
 477 
 478             // Run another archive pass
 479             TestBotRunner.runPeriodicItems(mlBot);
 480 
 481             // The archive should now contain an entry
 482             Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);
 483             assertTrue(archiveContains(archiveFolder.path(), &quot;Subject: RFR: 1234: This is a pull request&quot;));
 484 
 485             // Close it and then push another change
 486             pr.setState(Issue.State.CLOSED);
 487             var updatedHash = CheckableRepository.appendAndCommit(localRepo, &quot;Another change&quot;);
 488             localRepo.push(updatedHash, author.url(), &quot;edit&quot;);
 489 
 490             // Run another archive pass
 491             TestBotRunner.runPeriodicItems(mlBot);
 492 
 493             // The archive should now contain another entry - should retain the RFR thread prefix
 494             Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);
 495             assertTrue(archiveContains(archiveFolder.path(), &quot;Subject: Re: \\[Rev 01\\] RFR: 1234: This is a pull request&quot;));
 496         }
 497     }
 498 
 499     @Test
 500     void archiveClosed(TestInfo testInfo) throws IOException {
 501         try (var credentials = new HostCredentials(testInfo);
 502              var tempFolder = new TemporaryDirectory();
 503              var archiveFolder = new TemporaryDirectory();
 504              var webrevFolder = new TemporaryDirectory();
 505              var listServer = new TestMailmanServer();
 506              var webrevServer = new TestWebrevServer()) {
 507             var author = credentials.getHostedRepository();
 508             var archive = credentials.getHostedRepository();
 509             var ignored = credentials.getHostedRepository();
 510             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
 511             var censusBuilder = credentials.getCensusBuilder()
 512                                            .addAuthor(author.forge().currentUser().id());
 513             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
 514             var mlBot = MailingListBridgeBot.newBuilder()
 515                                             .from(from)
 516                                             .repo(author)
 517                                             .archive(archive)
 518                                             .censusRepo(censusBuilder.build())
 519                                             .list(listAddress)
 520                                             .ignoredUsers(Set.of(ignored.forge().currentUser().userName()))
 521                                             .listArchive(listServer.getArchive())
 522                                             .smtpServer(listServer.getSMTP())
 523                                             .webrevStorageRepository(archive)
 524                                             .webrevStorageRef(&quot;webrev&quot;)
 525                                             .webrevStorageBase(Path.of(&quot;test&quot;))
 526                                             .webrevStorageBaseUri(webrevServer.uri())
 527                                             .readyLabels(Set.of(&quot;rfr&quot;))
 528                                             .issueTracker(URIBuilder.base(&quot;http://issues.test/browse/&quot;).build())
 529                                             .build();
 530 
 531             // Populate the projects repository
 532             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType());
 533             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
 534             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
 535             localRepo.push(masterHash, archive.url(), &quot;webrev&quot;, true);
 536 
 537             // Make a change with a corresponding PR
 538             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;A simple change&quot;,
 539                                                                &quot;Change msg\n\nWith several lines&quot;);
 540             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
 541             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;1234: This is a pull request&quot;);
 542             pr.setBody(&quot;This should be ready&quot;);
 543 
 544             // Run an archive pass
 545             TestBotRunner.runPeriodicItems(mlBot);
 546             TestBotRunner.runPeriodicItems(mlBot);
 547 
 548             // A PR that isn&#39;t ready for review should not be archived
 549             Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);
 550             assertFalse(archiveContains(archiveFolder.path(), &quot;This is a pull request&quot;));
 551 
 552             // Flag it as ready for review
 553             pr.addLabel(&quot;rfr&quot;);
 554 
 555             // Run another archive pass
 556             TestBotRunner.runPeriodicItems(mlBot);
 557 
 558             // The archive should now contain an entry
 559             Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);
 560             assertTrue(archiveContains(archiveFolder.path(), &quot;Subject: RFR: 1234: This is a pull request&quot;));
 561 
 562             // Close it
 563             pr.setState(Issue.State.CLOSED);
 564 
 565             // Run another archive pass
 566             TestBotRunner.runPeriodicItems(mlBot);
 567 
 568             // The archive should now contain another entry - should say that it is closed
 569             Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);
 570             assertEquals(1, archiveContainsCount(archiveFolder.path(), &quot;Subject: Re: \\[Closed\\] RFR: 1234: This is a pull request&quot;));
 571 
 572             pr.addComment(&quot;Fair enough&quot;);
 573 
 574             // Run another archive pass - only a single close notice should have been posted
 575             TestBotRunner.runPeriodicItems(mlBot);
 576             Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);
 577             assertEquals(1, archiveContainsCount(archiveFolder.path(), &quot;Subject: Re: \\[Closed\\] RFR: 1234: This is a pull request&quot;));
 578         }
 579     }
 580 
 581     @Test
 582     void archiveFailedAutoMerge(TestInfo testInfo) throws IOException {
 583         try (var credentials = new HostCredentials(testInfo);
 584              var tempFolder = new TemporaryDirectory();
 585              var archiveFolder = new TemporaryDirectory();
 586              var webrevFolder = new TemporaryDirectory();
 587              var listServer = new TestMailmanServer();
 588              var webrevServer = new TestWebrevServer()) {
 589             var author = credentials.getHostedRepository();
 590             var archive = credentials.getHostedRepository();
 591             var ignored = credentials.getHostedRepository();
 592             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
 593             var censusBuilder = credentials.getCensusBuilder()
 594                                            .addAuthor(author.forge().currentUser().id());
 595             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
 596             var mlBot = MailingListBridgeBot.newBuilder()
 597                                             .from(from)
 598                                             .repo(author)
 599                                             .archive(archive)
 600                                             .censusRepo(censusBuilder.build())
 601                                             .list(listAddress)
 602                                             .ignoredUsers(Set.of(ignored.forge().currentUser().userName()))
 603                                             .listArchive(listServer.getArchive())
 604                                             .smtpServer(listServer.getSMTP())
 605                                             .webrevStorageRepository(archive)
 606                                             .webrevStorageRef(&quot;webrev&quot;)
 607                                             .webrevStorageBase(Path.of(&quot;test&quot;))
 608                                             .webrevStorageBaseUri(webrevServer.uri())
 609                                             .issueTracker(URIBuilder.base(&quot;http://issues.test/browse/&quot;).build())
 610                                             .build();
 611 
 612             // Populate the projects repository
 613             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType());
 614             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
 615             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
 616             localRepo.push(masterHash, archive.url(), &quot;webrev&quot;, true);
 617 
 618             // Make a change with a corresponding PR
 619             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;A simple change&quot;,
 620                                                                &quot;Change msg\n\nWith several lines&quot;);
 621             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
 622             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;Cannot automatically merge&quot;);
 623             pr.setBody(&quot;This is an automated merge PR&quot;);
 624             pr.addLabel(&quot;failed-auto-merge&quot;);
 625 
 626             // Run an archive pass
 627             TestBotRunner.runPeriodicItems(mlBot);
 628             TestBotRunner.runPeriodicItems(mlBot);
 629 
 630             // The archive should contain an entry
 631             Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);
 632             assertTrue(archiveContains(archiveFolder.path(), &quot;Subject: RFR: Cannot automatically merge&quot;));
 633         }
 634     }
 635 
 636     @Test
 637     void reviewComment(TestInfo testInfo) throws IOException {
 638         try (var credentials = new HostCredentials(testInfo);
 639              var tempFolder = new TemporaryDirectory();
 640              var archiveFolder = new TemporaryDirectory();
 641              var listServer = new TestMailmanServer();
 642              var webrevServer = new TestWebrevServer()) {
 643             var author = credentials.getHostedRepository();
 644             var archive = credentials.getHostedRepository();
 645             var ignored = credentials.getHostedRepository();
 646             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
 647             var censusBuilder = credentials.getCensusBuilder()
 648                                            .addAuthor(author.forge().currentUser().id());
 649             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
 650             var mlBot = MailingListBridgeBot.newBuilder()
 651                                             .from(from)
 652                                             .repo(author)
 653                                             .archive(archive)
 654                                             .censusRepo(censusBuilder.build())
 655                                             .list(listAddress)
 656                                             .ignoredUsers(Set.of(ignored.forge().currentUser().userName()))
 657                                             .listArchive(listServer.getArchive())
 658                                             .smtpServer(listServer.getSMTP())
 659                                             .webrevStorageRepository(archive)
 660                                             .webrevStorageRef(&quot;webrev&quot;)
 661                                             .webrevStorageBase(Path.of(&quot;test&quot;))
 662                                             .webrevStorageBaseUri(webrevServer.uri())
 663                                             .issueTracker(URIBuilder.base(&quot;http://issues.test/browse/&quot;).build())
 664                                             .build();
 665 
 666             // Populate the projects repository
 667             var reviewFile = Path.of(&quot;reviewfile.txt&quot;);
 668             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType(), reviewFile);
 669             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
 670             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
 671             localRepo.push(masterHash, archive.url(), &quot;webrev&quot;, true);
 672 
 673             // Make a change with a corresponding PR
 674             var editHash = CheckableRepository.appendAndCommit(localRepo);
 675             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
 676             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
 677             pr.setBody(&quot;This is now ready&quot;);
 678             TestBotRunner.runPeriodicItems(mlBot);
 679             listServer.processIncoming();
 680 
 681             // And make a file specific comment
 682             var currentMaster = localRepo.resolve(&quot;master&quot;).orElseThrow();
 683             var comment = pr.addReviewComment(masterHash, editHash, reviewFile.toString(), 2, &quot;Review comment&quot;);
 684 
 685             // Add one from an ignored user as well
 686             var ignoredPr = ignored.pullRequest(pr.id());
 687             ignoredPr.addReviewComment(masterHash, editHash, reviewFile.toString(), 2, &quot;Don&#39;t mind me&quot;);
 688 
 689             // Process comments
 690             TestBotRunner.runPeriodicItems(mlBot);
 691             listServer.processIncoming();
 692 
 693             // The archive should now contain an entry
 694             Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);
 695             assertTrue(archiveContains(archiveFolder.path(), &quot;This is a pull request&quot;));
 696             assertTrue(archiveContains(archiveFolder.path(), &quot;This is now ready&quot;));
 697             assertTrue(archiveContains(archiveFolder.path(), &quot;Review comment&quot;));
 698             assertTrue(archiveContains(archiveFolder.path(), &quot;&gt; This is now ready&quot;));
 699             assertTrue(archiveContains(archiveFolder.path(), reviewFile.toString()));
 700             assertFalse(archiveContains(archiveFolder.path(), &quot;Don&#39;t mind me&quot;));
 701 
 702             // The mailing list as well
 703             var mailmanServer = MailingListServerFactory.createMailmanServer(listServer.getArchive(), listServer.getSMTP(), Duration.ZERO);
 704             var mailmanList = mailmanServer.getList(listAddress.address());
 705             var conversations = mailmanList.conversations(Duration.ofDays(1));
 706             assertEquals(1, conversations.size());
 707             var mail = conversations.get(0).first();
 708             assertEquals(&quot;RFR: This is a pull request&quot;, mail.subject());
 709 
 710             // Comment on the comment
 711             pr.addReviewCommentReply(comment, &quot;This is a review reply&quot;);
 712             TestBotRunner.runPeriodicItems(mlBot);
 713             listServer.processIncoming();
 714 
 715             // The archive should contain the additional comment (but no quoted footers)
 716             Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);
 717             assertTrue(archiveContains(archiveFolder.path(), &quot;This is a review reply&quot;));
 718             assertTrue(archiveContains(archiveFolder.path(), &quot;&gt;&gt; This is now ready&quot;));
 719             assertFalse(archiveContains(archiveFolder.path(), &quot;^&gt; PR:&quot;));
 720 
 721             // As well as the mailing list
 722             conversations = mailmanList.conversations(Duration.ofDays(1));
 723             assertEquals(1, conversations.size());
 724             assertEquals(3, conversations.get(0).allMessages().size());
 725             for (var newMail : conversations.get(0).allMessages()) {
 726                 assertEquals(noreplyAddress(archive), newMail.author().address());
 727                 assertEquals(listAddress, newMail.sender());
 728             }
 729         }
 730     }
 731 
 732     @Test
 733     void combineComments(TestInfo testInfo) throws IOException {
 734         try (var credentials = new HostCredentials(testInfo);
 735              var tempFolder = new TemporaryDirectory();
 736              var archiveFolder = new TemporaryDirectory();
 737              var listServer = new TestMailmanServer();
 738              var webrevServer = new TestWebrevServer()) {
 739             var author = credentials.getHostedRepository();
 740             var archive = credentials.getHostedRepository();
 741             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
 742             var censusBuilder = credentials.getCensusBuilder()
 743                                            .addAuthor(author.forge().currentUser().id());
 744             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
 745             var mlBot = MailingListBridgeBot.newBuilder()
 746                                             .from(from)
 747                                             .repo(author)
 748                                             .archive(archive)
 749                                             .censusRepo(censusBuilder.build())
 750                                             .list(listAddress)
 751                                             .listArchive(listServer.getArchive())
 752                                             .smtpServer(listServer.getSMTP())
 753                                             .webrevStorageRepository(archive)
 754                                             .webrevStorageRef(&quot;webrev&quot;)
 755                                             .webrevStorageBase(Path.of(&quot;test&quot;))
 756                                             .webrevStorageBaseUri(webrevServer.uri())
 757                                             .issueTracker(URIBuilder.base(&quot;http://issues.test/browse/&quot;).build())
 758                                             .build();
 759 
 760             // Populate the projects repository
 761             var reviewFile = Path.of(&quot;reviewfile.txt&quot;);
 762             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType(), reviewFile);
 763             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
 764             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
 765             localRepo.push(masterHash, archive.url(), &quot;webrev&quot;, true);
 766 
 767             // Make a change with a corresponding PR
 768             var editHash = CheckableRepository.appendAndCommit(localRepo);
 769             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
 770             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
 771             pr.setBody(&quot;This is now ready&quot;);
 772             pr.addComment(&quot;Avoid combining&quot;);
 773 
 774             TestBotRunner.runPeriodicItems(mlBot);
 775             listServer.processIncoming();
 776             listServer.processIncoming();
 777 
 778             // Make several file specific comments
 779             var first = pr.addReviewComment(masterHash, editHash, reviewFile.toString(), 2, &quot;Review comment&quot;);
 780             var second = pr.addReviewComment(masterHash, editHash, reviewFile.toString(), 2, &quot;Another review comment&quot;);
 781             pr.addReviewComment(masterHash, editHash, reviewFile.toString(), 2, &quot;Further review comment&quot;);
 782             pr.addReviewComment(masterHash, editHash, reviewFile.toString(), 2, &quot;Final review comment&quot;);
 783             TestBotRunner.runPeriodicItems(mlBot);
 784             listServer.processIncoming();
 785 
 786             // The archive should contain a combined entry
 787             Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);
 788             assertEquals(2, archiveContainsCount(archiveFolder.path(), &quot;^On.*wrote:&quot;));
 789 
 790             // As well as the mailing list
 791             var mailmanServer = MailingListServerFactory.createMailmanServer(listServer.getArchive(), listServer.getSMTP(), Duration.ZERO);
 792             var mailmanList = mailmanServer.getList(listAddress.address());
 793             var conversations = mailmanList.conversations(Duration.ofDays(1));
 794             assertEquals(1, conversations.size());
 795             var mail = conversations.get(0).first();
 796             assertEquals(&quot;RFR: This is a pull request&quot;, mail.subject());
 797             assertEquals(3, conversations.get(0).allMessages().size());
 798 
 799             var commentReply = conversations.get(0).replies(mail).get(0);
 800             assertEquals(2, commentReply.body().split(&quot;^On.*wrote:&quot;).length);
 801             assertTrue(commentReply.body().contains(&quot;Avoid combining\n\n&quot;), commentReply.body());
 802 
 803             var reviewReply = conversations.get(0).replies(mail).get(1);
 804             assertEquals(2, reviewReply.body().split(&quot;^On.*wrote:&quot;).length);
 805             assertEquals(2, reviewReply.body().split(&quot;&gt; This is now ready&quot;).length, reviewReply.body());
 806             assertEquals(&quot;RFR: This is a pull request&quot;, reviewReply.subject());
 807             assertTrue(reviewReply.body().contains(&quot;Review comment\n\n&quot;), reviewReply.body());
 808             assertTrue(reviewReply.body().contains(&quot;Another review comment&quot;), reviewReply.body());
 809 
 810             // Now reply to the first and second (collapsed) comment
 811             pr.addReviewCommentReply(first, &quot;I agree&quot;);
 812             pr.addReviewCommentReply(second, &quot;Not with this one though&quot;);
 813             TestBotRunner.runPeriodicItems(mlBot);
 814             listServer.processIncoming();
 815 
 816             // The archive should contain a new entry
 817             Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);
 818             assertEquals(3, archiveContainsCount(archiveFolder.path(), &quot;^On.*wrote:&quot;));
 819 
 820             // The combined review comments should only appear unquoted once
 821             assertEquals(1, archiveContainsCount(archiveFolder.path(), &quot;^Another review comment&quot;));
 822         }
 823     }
 824 
 825     @Test
 826     void commentThreading(TestInfo testInfo) throws IOException {
 827         try (var credentials = new HostCredentials(testInfo);
 828              var tempFolder = new TemporaryDirectory();
 829              var archiveFolder = new TemporaryDirectory();
 830              var listServer = new TestMailmanServer();
 831              var webrevServer = new TestWebrevServer()) {
 832             var author = credentials.getHostedRepository();
 833             var reviewer = credentials.getHostedRepository();
 834             var archive = credentials.getHostedRepository();
 835             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
 836             var censusBuilder = credentials.getCensusBuilder()
 837                                            .addReviewer(reviewer.forge().currentUser().id())
 838                                            .addAuthor(author.forge().currentUser().id());
 839             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
 840             var mlBot = MailingListBridgeBot.newBuilder()
 841                                             .from(from)
 842                                             .repo(author)
 843                                             .archive(archive)
 844                                             .censusRepo(censusBuilder.build())
 845                                             .list(listAddress)
 846                                             .listArchive(listServer.getArchive())
 847                                             .smtpServer(listServer.getSMTP())
 848                                             .webrevStorageRepository(archive)
 849                                             .webrevStorageRef(&quot;webrev&quot;)
 850                                             .webrevStorageBase(Path.of(&quot;test&quot;))
 851                                             .webrevStorageBaseUri(webrevServer.uri())
 852                                             .issueTracker(URIBuilder.base(&quot;http://issues.test/browse/&quot;).build())
 853                                             .build();
 854 
 855             // Populate the projects repository
 856             var reviewFile = Path.of(&quot;reviewfile.txt&quot;);
 857             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType(), reviewFile);
 858             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
 859             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
 860             localRepo.push(masterHash, archive.url(), &quot;webrev&quot;, true);
 861 
 862             // Make a change with a corresponding PR
 863             var editHash = CheckableRepository.appendAndCommit(localRepo);
 864             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
 865             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
 866             pr.setBody(&quot;This is now ready&quot;);
 867             TestBotRunner.runPeriodicItems(mlBot);
 868             listServer.processIncoming();
 869 
 870             // Make a file specific comment
 871             var reviewPr = reviewer.pullRequest(pr.id());
 872             var comment1 = reviewPr.addReviewComment(masterHash, editHash, reviewFile.toString(), 2, &quot;Review comment&quot;);
 873             pr.addReviewCommentReply(comment1, &quot;I agree&quot;);
 874             reviewPr.addReviewCommentReply(comment1, &quot;Great&quot;);
 875             TestBotRunner.runPeriodicItems(mlBot);
 876             listServer.processIncoming();
 877             listServer.processIncoming();
 878             listServer.processIncoming();
 879 
 880             // And a second one by ourselves
 881             var comment2 = pr.addReviewComment(masterHash, editHash, reviewFile.toString(), 2, &quot;Another review comment&quot;);
 882             reviewPr.addReviewCommentReply(comment2, &quot;Sounds good&quot;);
 883             pr.addReviewCommentReply(comment2, &quot;Thanks&quot;);
 884             TestBotRunner.runPeriodicItems(mlBot);
 885             listServer.processIncoming();
 886             listServer.processIncoming();
 887             listServer.processIncoming();
 888 
 889             // Finally some approvals and another comment
 890             pr.addReview(Review.Verdict.APPROVED, &quot;Nice&quot;);
 891             reviewPr.addReviewComment(masterHash, editHash, reviewFile.toString(), 2, &quot;The final review comment&quot;);
 892             reviewPr.addReview(Review.Verdict.APPROVED, &quot;Looks fine&quot;);
 893             reviewPr.addReviewCommentReply(comment2, &quot;You are welcome&quot;);
 894             TestBotRunner.runPeriodicItems(mlBot);
 895             listServer.processIncoming();
 896             listServer.processIncoming();
 897             listServer.processIncoming();
 898 
 899             // Sanity check the archive
 900             Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);
 901             assertEquals(9, archiveContainsCount(archiveFolder.path(), &quot;^On.*wrote:&quot;));
 902 
 903             // File specific comments should appear after the approval
 904             var archiveText = archiveContents(archiveFolder.path()).orElseThrow();
 905             assertTrue(archiveText.indexOf(&quot;Looks fine&quot;) &lt; archiveText.indexOf(&quot;The final review comment&quot;));
 906 
 907             // Check the mailing list
 908             var mailmanServer = MailingListServerFactory.createMailmanServer(listServer.getArchive(), listServer.getSMTP(), Duration.ZERO);
 909             var mailmanList = mailmanServer.getList(listAddress.address());
 910             var conversations = mailmanList.conversations(Duration.ofDays(1));
 911             assertEquals(1, conversations.size());
 912             var mail = conversations.get(0).first();
 913             assertEquals(&quot;RFR: This is a pull request&quot;, mail.subject());
 914             assertEquals(10, conversations.get(0).allMessages().size());
 915 
 916             // There should be four separate threads
 917             var thread1 = conversations.get(0).replies(mail).get(0);
 918             assertEquals(2, thread1.body().split(&quot;^On.*wrote:&quot;).length);
 919             assertEquals(2, thread1.body().split(&quot;&gt; This is now ready&quot;).length, thread1.body());
 920             assertEquals(&quot;RFR: This is a pull request&quot;, thread1.subject());
 921             assertTrue(thread1.body().contains(&quot;Review comment\n\n&quot;), thread1.body());
 922             assertFalse(thread1.body().contains(&quot;Another review comment&quot;), thread1.body());
 923             var thread1reply1 = conversations.get(0).replies(thread1).get(0);
 924             assertTrue(thread1reply1.body().contains(&quot;I agree&quot;));
 925             assertEquals(noreplyAddress(archive), thread1reply1.author().address());
 926             assertEquals(archive.forge().currentUser().fullName(), thread1reply1.author().fullName().orElseThrow());
 927             var thread1reply2 = conversations.get(0).replies(thread1reply1).get(0);
 928             assertTrue(thread1reply2.body().contains(&quot;Great&quot;));
 929             assertEquals(&quot;integrationreviewer1@openjdk.java.net&quot;, thread1reply2.author().address());
 930             assertEquals(&quot;Generated Reviewer 1&quot;, thread1reply2.author().fullName().orElseThrow());
 931 
 932             var thread2 = conversations.get(0).replies(mail).get(1);
 933             assertEquals(2, thread2.body().split(&quot;^On.*wrote:&quot;).length);
 934             assertEquals(2, thread2.body().split(&quot;&gt; This is now ready&quot;).length, thread2.body());
 935             assertEquals(&quot;RFR: This is a pull request&quot;, thread2.subject());
 936             assertFalse(thread2.body().contains(&quot;Review comment\n\n&quot;), thread2.body());
 937             assertTrue(thread2.body().contains(&quot;Another review comment&quot;), thread2.body());
 938             var thread2reply1 = conversations.get(0).replies(thread2).get(0);
 939             assertTrue(thread2reply1.body().contains(&quot;Sounds good&quot;));
 940             var thread2reply2 = conversations.get(0).replies(thread2reply1).get(0);
 941             assertTrue(thread2reply2.body().contains(&quot;Thanks&quot;));
 942 
 943             var replies = conversations.get(0).replies(mail);
 944             var thread3 = replies.get(2);
 945             assertEquals(&quot;RFR: This is a pull request&quot;, thread3.subject());
 946             var thread4 = replies.get(3);
 947             assertEquals(&quot;RFR: This is a pull request&quot;, thread4.subject());
 948             assertTrue(thread4.body().contains(&quot;Looks fine&quot;));
 949             assertTrue(thread4.body().contains(&quot;The final review comment&quot;));
 950             assertTrue(thread4.body().contains(&quot;Marked as reviewed by integrationreviewer1 (Reviewer)&quot;));
 951         }
 952     }
 953 
 954     @Test
 955     void commentThreadingSeparated(TestInfo testInfo) throws IOException {
 956         try (var credentials = new HostCredentials(testInfo);
 957              var tempFolder = new TemporaryDirectory();
 958              var archiveFolder = new TemporaryDirectory();
 959              var listServer = new TestMailmanServer();
 960              var webrevServer = new TestWebrevServer()) {
 961             var author = credentials.getHostedRepository();
 962             var reviewer = credentials.getHostedRepository();
 963             var archive = credentials.getHostedRepository();
 964             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
 965             var censusBuilder = credentials.getCensusBuilder()
 966                                            .addReviewer(reviewer.forge().currentUser().id())
 967                                            .addAuthor(author.forge().currentUser().id());
 968             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
 969             var mlBot = MailingListBridgeBot.newBuilder()
 970                                             .from(from)
 971                                             .repo(author)
 972                                             .archive(archive)
 973                                             .censusRepo(censusBuilder.build())
 974                                             .list(listAddress)
 975                                             .listArchive(listServer.getArchive())
 976                                             .smtpServer(listServer.getSMTP())
 977                                             .webrevStorageRepository(archive)
 978                                             .webrevStorageRef(&quot;webrev&quot;)
 979                                             .webrevStorageBase(Path.of(&quot;test&quot;))
 980                                             .webrevStorageBaseUri(webrevServer.uri())
 981                                             .issueTracker(URIBuilder.base(&quot;http://issues.test/browse/&quot;).build())
 982                                             .build();
 983 
 984             // Populate the projects repository
 985             var reviewFile = Path.of(&quot;reviewfile.txt&quot;);
 986             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType(), reviewFile);
 987             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
 988             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
 989             localRepo.push(masterHash, archive.url(), &quot;webrev&quot;, true);
 990 
 991             // Make a change with a corresponding PR
 992             var editHash = CheckableRepository.appendAndCommit(localRepo);
 993             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
 994             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
 995             pr.setBody(&quot;This is now ready&quot;);
 996             TestBotRunner.runPeriodicItems(mlBot);
 997             listServer.processIncoming();
 998 
 999             // Make two file specific comments
1000             var reviewPr = reviewer.pullRequest(pr.id());
1001             var comment1 = reviewPr.addReviewComment(masterHash, editHash, reviewFile.toString(), 2, &quot;Review comment&quot;);
1002             var comment2 = reviewPr.addReviewComment(masterHash, editHash, reviewFile.toString(), 2, &quot;Another review comment&quot;);
1003             TestBotRunner.runPeriodicItems(mlBot);
1004             listServer.processIncoming();
1005 
1006             pr.addReviewCommentReply(comment1, &quot;I agree&quot;);
1007             pr.addReviewCommentReply(comment2, &quot;I don&#39;t agree&quot;);
1008             TestBotRunner.runPeriodicItems(mlBot);
1009             listServer.processIncoming();
1010 
1011             // Sanity check the archive
1012             Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);
1013             assertEquals(2, archiveContainsCount(archiveFolder.path(), &quot;^On.*wrote:&quot;));
1014         }
1015     }
1016 
1017     @Test
1018     void commentWithMention(TestInfo testInfo) throws IOException {
1019         try (var credentials = new HostCredentials(testInfo);
1020              var tempFolder = new TemporaryDirectory();
1021              var archiveFolder = new TemporaryDirectory();
1022              var listServer = new TestMailmanServer();
1023              var webrevServer = new TestWebrevServer()) {
1024             var author = credentials.getHostedRepository();
1025             var reviewer = credentials.getHostedRepository();
1026             var archive = credentials.getHostedRepository();
1027             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
1028             var censusBuilder = credentials.getCensusBuilder()
1029                                            .addReviewer(reviewer.forge().currentUser().id())
1030                                            .addAuthor(author.forge().currentUser().id());
1031             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
1032             var mlBot = MailingListBridgeBot.newBuilder()
1033                                             .from(from)
1034                                             .repo(author)
1035                                             .archive(archive)
1036                                             .censusRepo(censusBuilder.build())
1037                                             .list(listAddress)
1038                                             .listArchive(listServer.getArchive())
1039                                             .smtpServer(listServer.getSMTP())
1040                                             .webrevStorageRepository(archive)
1041                                             .webrevStorageRef(&quot;webrev&quot;)
1042                                             .webrevStorageBase(Path.of(&quot;test&quot;))
1043                                             .webrevStorageBaseUri(webrevServer.uri())
1044                                             .issueTracker(URIBuilder.base(&quot;http://issues.test/browse/&quot;).build())
1045                                             .build();
1046 
1047             // Populate the projects repository
1048             var reviewFile = Path.of(&quot;reviewfile.txt&quot;);
1049             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType(), reviewFile);
1050             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
1051             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
1052             localRepo.push(masterHash, archive.url(), &quot;webrev&quot;, true);
1053 
1054             // Make a change with a corresponding PR
1055             var editHash = CheckableRepository.appendAndCommit(localRepo);
1056             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
1057             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
1058             pr.setBody(&quot;This is now ready&quot;);
1059             TestBotRunner.runPeriodicItems(mlBot);
1060             listServer.processIncoming();
1061 
1062             // Make two comments from different authors
1063             var reviewPr = reviewer.pullRequest(pr.id());
1064             reviewPr.addComment(&quot;First comment&quot;);
1065             pr.addComment(&quot;Second comment&quot;);
1066 
1067             TestBotRunner.runPeriodicItems(mlBot);
1068             listServer.processIncoming();
1069 
1070             pr.addComment(&quot;@&quot; + reviewer.forge().currentUser().userName() + &quot; reply to first&quot;);
1071             TestBotRunner.runPeriodicItems(mlBot);
1072             listServer.processIncoming();
1073 
1074             // The first comment should be quoted more often than the second
1075             Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);
1076             assertEquals(3, archiveContainsCount(archiveFolder.path(), &quot;First comment&quot;));
1077             assertEquals(1, archiveContainsCount(archiveFolder.path(), &quot;Second comment&quot;));
1078         }
1079     }
1080 
1081     @Test
1082     void reviewCommentWithMention(TestInfo testInfo) throws IOException {
1083         try (var credentials = new HostCredentials(testInfo);
1084              var tempFolder = new TemporaryDirectory();
1085              var archiveFolder = new TemporaryDirectory();
1086              var listServer = new TestMailmanServer();
1087              var webrevServer = new TestWebrevServer()) {
1088             var author = credentials.getHostedRepository();
1089             var reviewer = credentials.getHostedRepository();
1090             var archive = credentials.getHostedRepository();
1091             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
1092             var censusBuilder = credentials.getCensusBuilder()
1093                                            .addReviewer(reviewer.forge().currentUser().id())
1094                                            .addAuthor(author.forge().currentUser().id());
1095             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
1096             var mlBot = MailingListBridgeBot.newBuilder()
1097                                             .from(from)
1098                                             .repo(author)
1099                                             .archive(archive)
1100                                             .censusRepo(censusBuilder.build())
1101                                             .list(listAddress)
1102                                             .listArchive(listServer.getArchive())
1103                                             .smtpServer(listServer.getSMTP())
1104                                             .webrevStorageRepository(archive)
1105                                             .webrevStorageRef(&quot;webrev&quot;)
1106                                             .webrevStorageBase(Path.of(&quot;test&quot;))
1107                                             .webrevStorageBaseUri(webrevServer.uri())
1108                                             .issueTracker(URIBuilder.base(&quot;http://issues.test/browse/&quot;).build())
1109                                             .build();
1110 
1111             // Populate the projects repository
1112             var reviewFile = Path.of(&quot;reviewfile.txt&quot;);
1113             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType(), reviewFile);
1114             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
1115             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
1116             localRepo.push(masterHash, archive.url(), &quot;webrev&quot;, true);
1117 
1118             // Make a change with a corresponding PR
1119             var editHash = CheckableRepository.appendAndCommit(localRepo);
1120             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
1121             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
1122             pr.setBody(&quot;This is now ready&quot;);
1123             TestBotRunner.runPeriodicItems(mlBot);
1124             listServer.processIncoming();
1125 
1126             // Make two review comments from different authors
1127             var reviewPr = reviewer.pullRequest(pr.id());
1128             var comment = reviewPr.addReviewComment(masterHash, editHash, reviewFile.toString(), 2, &quot;Review comment&quot;);
1129             reviewPr.addReviewCommentReply(comment, &quot;First review comment&quot;);
1130             pr.addReviewCommentReply(comment, &quot;Second review comment&quot;);
1131 
1132             TestBotRunner.runPeriodicItems(mlBot);
1133             listServer.processIncoming();
1134 
1135             pr.addReviewCommentReply(comment, &quot;@&quot; + reviewer.forge().currentUser().userName() + &quot; reply to first&quot;);
1136             TestBotRunner.runPeriodicItems(mlBot);
1137             listServer.processIncoming();
1138 
1139             // The first comment should be quoted more often than the second
1140             Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);
1141             assertEquals(3, archiveContainsCount(archiveFolder.path(), &quot;First review comment&quot;));
1142             assertEquals(1, archiveContainsCount(archiveFolder.path(), &quot;Second review comment&quot;));
1143         }
1144     }
1145 
1146     @Test
1147     void commentWithQuote(TestInfo testInfo) throws IOException {
1148         try (var credentials = new HostCredentials(testInfo);
1149              var tempFolder = new TemporaryDirectory();
1150              var archiveFolder = new TemporaryDirectory();
1151              var listServer = new TestMailmanServer();
1152              var webrevServer = new TestWebrevServer()) {
1153             var author = credentials.getHostedRepository();
1154             var reviewer = credentials.getHostedRepository();
1155             var archive = credentials.getHostedRepository();
1156             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
1157             var censusBuilder = credentials.getCensusBuilder()
1158                                            .addReviewer(reviewer.forge().currentUser().id())
1159                                            .addAuthor(author.forge().currentUser().id());
1160             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
1161             var mlBot = MailingListBridgeBot.newBuilder()
1162                                             .from(from)
1163                                             .repo(author)
1164                                             .archive(archive)
1165                                             .censusRepo(censusBuilder.build())
1166                                             .list(listAddress)
1167                                             .listArchive(listServer.getArchive())
1168                                             .smtpServer(listServer.getSMTP())
1169                                             .webrevStorageRepository(archive)
1170                                             .webrevStorageRef(&quot;webrev&quot;)
1171                                             .webrevStorageBase(Path.of(&quot;test&quot;))
1172                                             .webrevStorageBaseUri(webrevServer.uri())
1173                                             .issueTracker(URIBuilder.base(&quot;http://issues.test/browse/&quot;).build())
1174                                             .build();
1175 
1176             // Populate the projects repository
1177             var reviewFile = Path.of(&quot;reviewfile.txt&quot;);
1178             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType(), reviewFile);
1179             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
1180             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
1181             localRepo.push(masterHash, archive.url(), &quot;webrev&quot;, true);
1182 
1183             // Make a change with a corresponding PR
1184             var editHash = CheckableRepository.appendAndCommit(localRepo);
1185             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
1186             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
1187             pr.setBody(&quot;This is now ready&quot;);
1188             TestBotRunner.runPeriodicItems(mlBot);
1189             listServer.processIncoming();
1190 
1191             // Make two comments from different authors
1192             var reviewPr = reviewer.pullRequest(pr.id());
1193             reviewPr.addComment(&quot;First comment\nsecond line&quot;);
1194             pr.addComment(&quot;Second comment\nfourth line&quot;);
1195 
1196             TestBotRunner.runPeriodicItems(mlBot);
1197             listServer.processIncoming();
1198 
1199             pr.addComment(&quot;&gt;First comm\n\nreply to first&quot;);
1200             TestBotRunner.runPeriodicItems(mlBot);
1201             listServer.processIncoming();
1202 
1203             // The first comment should be quoted more often than the second
1204             Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);
1205             assertEquals(2, archiveContainsCount(archiveFolder.path(), &quot;First comment&quot;));
1206             assertEquals(3, archiveContainsCount(archiveFolder.path(), &quot;First comm&quot;));
1207             assertEquals(1, archiveContainsCount(archiveFolder.path(), &quot;Second comment&quot;));
1208         }
1209     }
1210 
1211     @Test
1212     void reviewContext(TestInfo testInfo) throws IOException {
1213         try (var credentials = new HostCredentials(testInfo);
1214              var tempFolder = new TemporaryDirectory();
1215              var archiveFolder = new TemporaryDirectory();
1216              var listServer = new TestMailmanServer();
1217              var webrevServer = new TestWebrevServer()) {
1218             var author = credentials.getHostedRepository();
1219             var archive = credentials.getHostedRepository();
1220             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
1221             var censusBuilder = credentials.getCensusBuilder()
1222                                            .addAuthor(author.forge().currentUser().id());
1223             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
1224             var mlBot = MailingListBridgeBot.newBuilder()
1225                                             .from(from)
1226                                             .repo(author)
1227                                             .archive(archive)
1228                                             .censusRepo(censusBuilder.build())
1229                                             .list(listAddress)
1230                                             .listArchive(listServer.getArchive())
1231                                             .smtpServer(listServer.getSMTP())
1232                                             .webrevStorageRepository(archive)
1233                                             .webrevStorageRef(&quot;webrev&quot;)
1234                                             .webrevStorageBase(Path.of(&quot;test&quot;))
1235                                             .webrevStorageBaseUri(webrevServer.uri())
1236                                             .issueTracker(URIBuilder.base(&quot;http://issues.test/browse/&quot;).build())
1237                                             .build();
1238 
1239             // Populate the projects repository
1240             var reviewFile = Path.of(&quot;reviewfile.txt&quot;);
1241             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType(), reviewFile);
1242             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
1243             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
1244             localRepo.push(masterHash, archive.url(), &quot;webrev&quot;, true);
1245 
1246             // Make a change with a corresponding PR
1247             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;Line 1\nLine 2\nLine 3\nLine 4&quot;);
1248             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
1249             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
1250             pr.setBody(&quot;This is now ready&quot;);
1251             TestBotRunner.runPeriodicItems(mlBot);
1252             listServer.processIncoming();
1253 
1254             // Make a file specific comment
1255             pr.addReviewComment(masterHash, editHash, reviewFile.toString(), 2, &quot;Review comment&quot;);
1256 
1257             TestBotRunner.runPeriodicItems(mlBot);
1258             listServer.processIncoming();
1259 
1260             // The archive should only contain context around line 2
1261             Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);
1262             assertTrue(archiveContains(archiveFolder.path(), &quot;^&gt; 2: Line 1$&quot;));
1263             assertTrue(archiveContains(archiveFolder.path(), &quot;^&gt; 3: Line 2$&quot;));
1264             assertFalse(archiveContains(archiveFolder.path(), &quot;^&gt; 4: Line 3$&quot;));
1265         }
1266     }
1267 
1268     @Test
1269     void multipleReviewContexts(TestInfo testInfo) throws IOException {
1270         try (var credentials = new HostCredentials(testInfo);
1271              var tempFolder = new TemporaryDirectory();
1272              var archiveFolder = new TemporaryDirectory();
1273              var listServer = new TestMailmanServer();
1274              var webrevServer = new TestWebrevServer()) {
1275             var author = credentials.getHostedRepository();
1276             var archive = credentials.getHostedRepository();
1277             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
1278             var censusBuilder = credentials.getCensusBuilder()
1279                                            .addAuthor(author.forge().currentUser().id());
1280             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
1281             var mlBot = MailingListBridgeBot.newBuilder()
1282                                             .from(from)
1283                                             .repo(author)
1284                                             .archive(archive)
1285                                             .censusRepo(censusBuilder.build())
1286                                             .list(listAddress)
1287                                             .listArchive(listServer.getArchive())
1288                                             .smtpServer(listServer.getSMTP())
1289                                             .webrevStorageRepository(archive)
1290                                             .webrevStorageRef(&quot;webrev&quot;)
1291                                             .webrevStorageBase(Path.of(&quot;test&quot;))
1292                                             .webrevStorageBaseUri(webrevServer.uri())
1293                                             .issueTracker(URIBuilder.base(&quot;http://issues.test/browse/&quot;).build())
1294                                             .build();
1295 
1296             // Populate the projects repository
1297             var reviewFile = Path.of(&quot;reviewfile.txt&quot;);
1298             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType(), reviewFile);
1299             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
1300             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
1301             localRepo.push(masterHash, archive.url(), &quot;webrev&quot;, true);
1302             var initialHash = CheckableRepository.appendAndCommit(localRepo,
1303                                                                   &quot;Line 0.1\nLine 0.2\nLine 0.3\nLine 0.4\n&quot; +
1304                                                                           &quot;Line 1\nLine 2\nLine 3\nLine 4\n&quot; +
1305                                                                           &quot;Line 5\nLine 6\nLine 7\nLine 8\n&quot; +
1306                                                                           &quot;Line 8.1\nLine 8.2\nLine 8.3\nLine 8.4\n&quot; +
1307                                                                           &quot;Line 9\nLine 10\nLine 11\nLine 12\n&quot; +
1308                                                                           &quot;Line 13\nLine 14\nLine 15\nLine 16\n&quot;);
1309             localRepo.push(initialHash, author.url(), &quot;master&quot;);
1310 
1311             // Make a change with a corresponding PR
1312             var current = Files.readString(localRepo.root().resolve(reviewFile), StandardCharsets.UTF_8);
1313             var updated = current.replaceAll(&quot;Line 2&quot;, &quot;Line 2 edit\nLine 2.5&quot;);
1314             updated = updated.replaceAll(&quot;Line 13&quot;, &quot;Line 12.5\nLine 13 edit&quot;);
1315             Files.writeString(localRepo.root().resolve(reviewFile), updated, StandardCharsets.UTF_8);
1316             var editHash = CheckableRepository.appendAndCommit(localRepo);
1317             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
1318             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
1319             pr.setBody(&quot;This is now ready&quot;);
1320             TestBotRunner.runPeriodicItems(mlBot);
1321             listServer.processIncoming();
1322 
1323             // Make file specific comments
1324             pr.addReviewComment(masterHash, editHash, reviewFile.toString(), 7, &quot;Review comment&quot;);
1325             pr.addReviewComment(masterHash, editHash, reviewFile.toString(), 24, &quot;Another review comment&quot;);
1326 
1327             TestBotRunner.runPeriodicItems(mlBot);
1328             listServer.processIncoming();
1329 
1330             // The archive should only contain context around line 2 and 20
1331             Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);
1332             assertTrue(archiveContains(archiveFolder.path(), &quot;reviewfile.txt line 7&quot;));
1333             assertTrue(archiveContains(archiveFolder.path(), &quot;^&gt; 6: Line 1$&quot;));
1334             assertTrue(archiveContains(archiveFolder.path(), &quot;^&gt; 7: Line 2 edit$&quot;));
1335             assertFalse(archiveContains(archiveFolder.path(), &quot;Line 3&quot;));
1336 
1337             assertTrue(archiveContains(archiveFolder.path(), &quot;reviewfile.txt line 24&quot;));
1338             assertTrue(archiveContains(archiveFolder.path(), &quot;^&gt; 23: Line 12.5$&quot;));
1339             assertTrue(archiveContains(archiveFolder.path(), &quot;^&gt; 24: Line 13 edit$&quot;));
1340             assertFalse(archiveContains(archiveFolder.path(), &quot;^Line 15&quot;));
1341         }
1342     }
1343 
1344     @Test
1345     void filterComments(TestInfo testInfo) throws IOException {
1346         try (var credentials = new HostCredentials(testInfo);
1347              var tempFolder = new TemporaryDirectory();
1348              var archiveFolder = new TemporaryDirectory();
1349              var listServer = new TestMailmanServer();
1350              var webrevServer = new TestWebrevServer()) {
1351             var author = credentials.getHostedRepository();
1352             var archive = credentials.getHostedRepository();
1353             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
1354             var censusBuilder = credentials.getCensusBuilder()
1355                                            .addAuthor(author.forge().currentUser().id());
1356             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
1357             var mlBot = MailingListBridgeBot.newBuilder()
1358                                             .from(from)
1359                                             .repo(author)
1360                                             .archive(archive)
1361                                             .censusRepo(censusBuilder.build())
1362                                             .list(listAddress)
1363                                             .listArchive(listServer.getArchive())
1364                                             .smtpServer(listServer.getSMTP())
1365                                             .webrevStorageRepository(archive)
1366                                             .webrevStorageRef(&quot;webrev&quot;)
1367                                             .webrevStorageBase(Path.of(&quot;test&quot;))
1368                                             .webrevStorageBaseUri(webrevServer.uri())
1369                                             .issueTracker(URIBuilder.base(&quot;http://issues.test/browse/&quot;).build())
1370                                             .build();
1371 
1372             // Populate the projects repository
1373             var reviewFile = Path.of(&quot;reviewfile.txt&quot;);
1374             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType(), reviewFile);
1375             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
1376             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
1377             localRepo.push(masterHash, archive.url(), &quot;webrev&quot;, true);
1378 
1379             // Make a change with a corresponding PR
1380             var editHash = CheckableRepository.appendAndCommit(localRepo);
1381             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
1382             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
1383             pr.setBody(&quot;This is now ready\n&lt;!-- this is a comment --&gt;\nAnd this is not\n&quot; +
1384                                &quot;&lt;!-- Anything below this marker will be hidden --&gt;\nStatus stuff&quot;);
1385 
1386             // Make a bunch of comments
1387             pr.addComment(&quot;Plain comment\n&lt;!-- this is a comment --&gt;&quot;);
1388             pr.addReviewComment(masterHash, editHash, reviewFile.toString(), 2, &quot;Review comment &lt;!-- this is a comment --&gt;\n&quot;);
1389             pr.addComment(&quot;/integrate stuff&quot;);
1390             TestBotRunner.runPeriodicItems(mlBot);
1391 
1392             // Run an archive pass
1393             TestBotRunner.runPeriodicItems(mlBot);
1394 
1395             // The archive should not contain the comment
1396             Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);
1397             assertTrue(archiveContains(archiveFolder.path(), &quot;This is now ready&quot;));
1398             assertFalse(archiveContains(archiveFolder.path(), &quot;this is a comment&quot;));
1399             assertFalse(archiveContains(archiveFolder.path(), &quot;Status stuff&quot;));
1400             assertTrue(archiveContains(archiveFolder.path(), &quot;And this is not&quot;));
1401             assertFalse(archiveContains(archiveFolder.path(), &quot;&lt;!--&quot;));
1402             assertFalse(archiveContains(archiveFolder.path(), &quot;--&gt;&quot;));
1403             assertTrue(archiveContains(archiveFolder.path(), &quot;Plain comment&quot;));
1404             assertTrue(archiveContains(archiveFolder.path(), &quot;Review comment&quot;));
1405             assertFalse(archiveContains(archiveFolder.path(), &quot;/integrate&quot;));
1406         }
1407     }
1408 
1409     @Test
1410     void incrementalChanges(TestInfo testInfo) throws IOException {
1411         try (var credentials = new HostCredentials(testInfo);
1412              var tempFolder = new TemporaryDirectory();
1413              var archiveFolder = new TemporaryDirectory();
1414              var listServer = new TestMailmanServer();
1415              var webrevServer = new TestWebrevServer()) {
1416             var author = credentials.getHostedRepository();
1417             var archive = credentials.getHostedRepository();
1418             var commenter = credentials.getHostedRepository();
1419             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
1420             var censusBuilder = credentials.getCensusBuilder()
1421                                            .addAuthor(author.forge().currentUser().id());
1422             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
1423             var mlBot = MailingListBridgeBot.newBuilder()
1424                                             .from(from)
1425                                             .repo(author)
1426                                             .archive(archive)
1427                                             .censusRepo(censusBuilder.build())
1428                                             .list(listAddress)
1429                                             .listArchive(listServer.getArchive())
1430                                             .smtpServer(listServer.getSMTP())
1431                                             .webrevStorageRepository(archive)
1432                                             .webrevStorageRef(&quot;webrev&quot;)
1433                                             .webrevStorageBase(Path.of(&quot;test&quot;))
1434                                             .webrevStorageBaseUri(webrevServer.uri())
1435                                             .issueTracker(URIBuilder.base(&quot;http://issues.test/browse/&quot;).build())
1436                                             .build();
1437 
1438             // Populate the projects repository
1439             var reviewFile = Path.of(&quot;reviewfile.txt&quot;);
1440             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType(), reviewFile);
1441             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
1442             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
1443             localRepo.push(masterHash, archive.url(), &quot;webrev&quot;, true);
1444 
1445             // Make a change with a corresponding PR
1446             var editHash = CheckableRepository.appendAndCommit(localRepo);
1447             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
1448             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
1449             pr.setBody(&quot;This is now ready&quot;);
1450 
1451             // Run an archive pass
1452             TestBotRunner.runPeriodicItems(mlBot);
1453             listServer.processIncoming();
1454 
1455             var nextHash = CheckableRepository.appendAndCommit(localRepo, &quot;Yet one more line&quot;, &quot;Fixing&quot;);
1456             localRepo.push(nextHash, author.url(), &quot;edit&quot;);
1457 
1458             // Make sure that the push registered
1459             var lastHeadHash = pr.headHash();
1460             var refreshCount = 0;
1461             do {
1462                 pr = author.pullRequest(pr.id());
1463                 if (refreshCount++ &gt; 100) {
1464                     fail(&quot;The PR did not update after the new push&quot;);
1465                 }
1466             } while (pr.headHash().equals(lastHeadHash));
1467 
1468             // Run another archive pass
1469             TestBotRunner.runPeriodicItems(mlBot);
1470             TestBotRunner.runPeriodicItems(mlBot);
1471             TestBotRunner.runPeriodicItems(mlBot);
1472             listServer.processIncoming();
1473 
1474             // The archive should reference the updated push
1475             Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);
1476             assertTrue(archiveContains(archiveFolder.path(), &quot;has updated the pull request incrementally&quot;));
1477             assertTrue(archiveContains(archiveFolder.path(), &quot;full.*/&quot; + pr.id() + &quot;/webrev.01&quot;));
1478             assertTrue(archiveContains(archiveFolder.path(), &quot;inc.*/&quot; + pr.id() + &quot;/webrev.00-01&quot;));
1479             assertTrue(archiveContains(archiveFolder.path(), &quot;Patch&quot;));
1480             assertTrue(archiveContains(archiveFolder.path(), &quot;Fetch&quot;));
1481             assertTrue(archiveContains(archiveFolder.path(), &quot;Fixing&quot;));
1482 
1483             // The webrev comment should be updated
1484             var comments = pr.comments();
1485             var webrevComments = comments.stream()
1486                                          .filter(comment -&gt; comment.author().equals(author.forge().currentUser()))
1487                                          .filter(comment -&gt; comment.body().contains(&quot;webrev&quot;))
1488                                          .filter(comment -&gt; comment.body().contains(&quot;Full&quot;))
1489                                          .filter(comment -&gt; comment.body().contains(&quot;Incremental&quot;))
1490                                          .filter(comment -&gt; comment.body().contains(nextHash.hex()))
1491                                          .filter(comment -&gt; comment.body().contains(editHash.hex()))
1492                                          .collect(Collectors.toList());
1493             assertEquals(1, webrevComments.size());
1494 
1495             // Check that sender address is set properly
1496             var mailmanServer = MailingListServerFactory.createMailmanServer(listServer.getArchive(), listServer.getSMTP(), Duration.ZERO);
1497             var mailmanList = mailmanServer.getList(listAddress.address());
1498             var conversations = mailmanList.conversations(Duration.ofDays(1));
1499             assertEquals(1, conversations.size());
1500             for (var newMail : conversations.get(0).allMessages()) {
1501                 assertEquals(noreplyAddress(archive), newMail.author().address());
1502                 assertEquals(listAddress, newMail.sender());
1503             }
1504 
1505             // Add a comment
1506             var commenterPr = commenter.pullRequest(pr.id());
1507             commenterPr.addReviewComment(masterHash, nextHash, reviewFile.toString(), 2, &quot;Review comment&quot;);
1508             TestBotRunner.runPeriodicItems(mlBot);
1509             listServer.processIncoming();
1510 
1511             // Ensure that additional updates are only reported once
1512             for (int i = 0; i &lt; 3; ++i) {
1513                 var anotherHash = CheckableRepository.appendAndCommit(localRepo, &quot;Another line&quot;, &quot;Fixing&quot;);
1514                 localRepo.push(anotherHash, author.url(), &quot;edit&quot;);
1515 
1516                 // Make sure that the push registered
1517                 lastHeadHash = pr.headHash();
1518                 refreshCount = 0;
1519                 do {
1520                     pr = author.pullRequest(pr.id());
1521                     if (refreshCount++ &gt; 100) {
1522                         fail(&quot;The PR did not update after the new push&quot;);
1523                     }
1524                 } while (pr.headHash().equals(lastHeadHash));
1525 
1526                 TestBotRunner.runPeriodicItems(mlBot);
1527                 TestBotRunner.runPeriodicItems(mlBot);
1528                 listServer.processIncoming();
1529             }
1530             var updatedConversations = mailmanList.conversations(Duration.ofDays(1));
1531             assertEquals(1, updatedConversations.size());
1532             var conversation = updatedConversations.get(0);
1533             assertEquals(6, conversation.allMessages().size());
1534             assertEquals(&quot;[Rev 01] RFR: This is a pull request&quot;, conversation.allMessages().get(1).subject());
1535             assertEquals(&quot;[Rev 01] RFR: This is a pull request&quot;, conversation.allMessages().get(2).subject(), conversation.allMessages().get(2).toString());
1536             assertEquals(&quot;[Rev 04] RFR: This is a pull request&quot;, conversation.allMessages().get(5).subject());
1537         }
1538     }
1539 
1540     @Test
1541     void rebased(TestInfo testInfo) throws IOException {
1542         try (var credentials = new HostCredentials(testInfo);
1543              var tempFolder = new TemporaryDirectory();
1544              var archiveFolder = new TemporaryDirectory();
1545              var listServer = new TestMailmanServer();
1546              var webrevServer = new TestWebrevServer()) {
1547             var author = credentials.getHostedRepository();
1548             var archive = credentials.getHostedRepository();
1549             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
1550             var censusBuilder = credentials.getCensusBuilder()
1551                                            .addAuthor(author.forge().currentUser().id());
1552             var sender = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
1553             var mlBot = MailingListBridgeBot.newBuilder()
1554                                             .from(sender)
1555                                             .repo(author)
1556                                             .archive(archive)
1557                                             .censusRepo(censusBuilder.build())
1558                                             .list(listAddress)
1559                                             .listArchive(listServer.getArchive())
1560                                             .smtpServer(listServer.getSMTP())
1561                                             .webrevStorageRepository(archive)
1562                                             .webrevStorageRef(&quot;webrev&quot;)
1563                                             .webrevStorageBase(Path.of(&quot;test&quot;))
1564                                             .webrevStorageBaseUri(webrevServer.uri())
1565                                             .issueTracker(URIBuilder.base(&quot;http://issues.test/browse/&quot;).build())
1566                                             .build();
1567 
1568             // Populate the projects repository
1569             var reviewFile = Path.of(&quot;reviewfile.txt&quot;);
1570             var localRepo = CheckableRepository.init(tempFolder.path().resolve(&quot;first&quot;), author.repositoryType(), reviewFile);
1571             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
1572             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
1573             localRepo.push(masterHash, archive.url(), &quot;webrev&quot;, true);
1574 
1575             // Make a change with a corresponding PR
1576             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;A line&quot;, &quot;Original msg&quot;);
1577             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
1578             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
1579             pr.setBody(&quot;This is now ready&quot;);
1580 
1581             // Run an archive pass
1582             TestBotRunner.runPeriodicItems(mlBot);
1583             listServer.processIncoming();
1584 
1585             var newLocalRepo = Repository.materialize(tempFolder.path().resolve(&quot;second&quot;), author.url(), &quot;master&quot;);
1586             var newEditHash = CheckableRepository.appendAndCommit(newLocalRepo, &quot;Another line&quot;, &quot;Replaced msg&quot;);
1587             newLocalRepo.push(newEditHash, author.url(), &quot;edit&quot;, true);
1588 
1589             // Make sure that the push registered
1590             var lastHeadHash = pr.headHash();
1591             var refreshCount = 0;
1592             do {
1593                 pr = author.pullRequest(pr.id());
1594                 if (refreshCount++ &gt; 100) {
1595                     fail(&quot;The PR did not update after the new push&quot;);
1596                 }
1597             } while (pr.headHash().equals(lastHeadHash));
1598 
1599             // Run another archive pass
1600             TestBotRunner.runPeriodicItems(mlBot);
1601             listServer.processIncoming();
1602 
1603             // The archive should reference the rebased push
1604             Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);
1605             assertTrue(archiveContains(archiveFolder.path(), &quot;has updated the pull request with a new target base&quot;));
1606             assertTrue(archiveContains(archiveFolder.path(), pr.id() + &quot;/webrev.01&quot;));
1607             assertFalse(archiveContains(archiveFolder.path(), &quot;Incremental&quot;));
1608             assertTrue(archiveContains(archiveFolder.path(), &quot;Patch&quot;));
1609             assertTrue(archiveContains(archiveFolder.path(), &quot;Fetch&quot;));
1610             assertTrue(archiveContains(archiveFolder.path(), &quot;Original msg&quot;));
1611             assertTrue(archiveContains(archiveFolder.path(), &quot;Replaced msg&quot;));
1612 
1613             // The webrev comment should be updated
1614             var comments = pr.comments();
1615             var webrevComments = comments.stream()
1616                                          .filter(comment -&gt; comment.author().equals(author.forge().currentUser()))
1617                                          .filter(comment -&gt; comment.body().contains(&quot;webrev&quot;))
1618                                          .filter(comment -&gt; comment.body().contains(newEditHash.hex()))
1619                                          .collect(Collectors.toList());
1620             assertEquals(1, webrevComments.size());
1621 
1622             // Check that sender address is set properly
1623             var mailmanServer = MailingListServerFactory.createMailmanServer(listServer.getArchive(), listServer.getSMTP(), Duration.ZERO);
1624             var mailmanList = mailmanServer.getList(listAddress.address());
1625             var conversations = mailmanList.conversations(Duration.ofDays(1));
1626             assertEquals(1, conversations.size());
1627             for (var newMail : conversations.get(0).allMessages()) {
1628                 assertEquals(noreplyAddress(archive), newMail.author().address());
1629                 assertEquals(listAddress, newMail.sender());
1630                 assertFalse(newMail.hasHeader(&quot;PR-Head-Hash&quot;));
1631             }
1632             assertEquals(&quot;[Rev 01] RFR: This is a pull request&quot;, conversations.get(0).allMessages().get(1).subject());
1633         }
1634     }
1635 
1636     @Test
1637     void incrementalAfterRebase(TestInfo testInfo) throws IOException {
1638         try (var credentials = new HostCredentials(testInfo);
1639              var tempFolder = new TemporaryDirectory();
1640              var archiveFolder = new TemporaryDirectory();
1641              var listServer = new TestMailmanServer();
1642              var webrevServer = new TestWebrevServer()) {
1643             var author = credentials.getHostedRepository();
1644             var archive = credentials.getHostedRepository();
1645             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
1646             var censusBuilder = credentials.getCensusBuilder()
1647                                            .addAuthor(author.forge().currentUser().id());
1648             var sender = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
1649             var mlBot = MailingListBridgeBot.newBuilder()
1650                                             .from(sender)
1651                                             .repo(author)
1652                                             .archive(archive)
1653                                             .archiveRef(&quot;archive&quot;)
1654                                             .censusRepo(censusBuilder.build())
1655                                             .list(listAddress)
1656                                             .listArchive(listServer.getArchive())
1657                                             .smtpServer(listServer.getSMTP())
1658                                             .webrevStorageRepository(archive)
1659                                             .webrevStorageRef(&quot;webrev&quot;)
1660                                             .webrevStorageBase(Path.of(&quot;test&quot;))
1661                                             .webrevStorageBaseUri(webrevServer.uri())
1662                                             .issueTracker(URIBuilder.base(&quot;http://issues.test/browse/&quot;).build())
1663                                             .build();
1664 
1665             // Populate the projects repository
1666             var reviewFile = Path.of(&quot;reviewfile.txt&quot;);
1667             var localRepo = CheckableRepository.init(tempFolder.path().resolve(&quot;first&quot;), author.repositoryType(), reviewFile);
1668             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
1669             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
1670             localRepo.push(masterHash, archive.url(), &quot;webrev&quot;, true);
1671             localRepo.push(masterHash, archive.url(), &quot;archive&quot;, true);
1672 
1673             // Make a change with a corresponding PR
1674             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;A line&quot;, &quot;Original msg&quot;);
1675             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
1676             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
1677             pr.setBody(&quot;This is now ready&quot;);
1678 
1679             // Run an archive pass
1680             TestBotRunner.runPeriodicItems(mlBot);
1681             listServer.processIncoming();
1682 
1683             // Push more stuff to master
1684             localRepo.checkout(masterHash, true);
1685             var unrelatedFile = localRepo.root().resolve(&quot;unrelated.txt&quot;);
1686             Files.writeString(unrelatedFile, &quot;Other things happens in master&quot;);
1687             localRepo.add(unrelatedFile);
1688             var newMasterHash = localRepo.commit(&quot;Unrelated change&quot;, &quot;duke&quot;, &quot;duke@openjdk.org&quot;);
1689             localRepo.push(newMasterHash, author.url(), &quot;master&quot;);
1690 
1691             // And more stuff to the pr branch
1692             localRepo.checkout(editHash, true);
1693             CheckableRepository.appendAndCommit(localRepo, &quot;Another line&quot;, &quot;More updates&quot;);
1694 
1695             // Merge master
1696             localRepo.merge(newMasterHash);
1697             var newEditHash = localRepo.commit(&quot;Latest changes from master&quot;, &quot;duke&quot;, &quot;duke@openjdk.org&quot;);
1698             localRepo.push(newEditHash, author.url(), &quot;edit&quot;);
1699 
1700             // Make sure that the push registered
1701             var lastHeadHash = pr.headHash();
1702             var refreshCount = 0;
1703             do {
1704                 pr = author.pullRequest(pr.id());
1705                 if (refreshCount++ &gt; 100) {
1706                     fail(&quot;The PR did not update after the new push&quot;);
1707                 }
1708             } while (pr.headHash().equals(lastHeadHash));
1709 
1710             // Run another archive pass
1711             TestBotRunner.runPeriodicItems(mlBot);
1712             listServer.processIncoming();
1713 
1714             // The archive should reference the rebased push
1715             Repository.materialize(archiveFolder.path(), archive.url(), &quot;archive&quot;);
1716             assertTrue(archiveContains(archiveFolder.path(), &quot;has updated the pull request with a new target base&quot;));
1717             assertTrue(archiveContains(archiveFolder.path(), &quot;excludes&quot;));
1718             assertTrue(archiveContains(archiveFolder.path(), pr.id() + &quot;/webrev.01&quot;));
1719             assertTrue(archiveContains(archiveFolder.path(), pr.id() + &quot;/webrev.00-01&quot;));
1720             assertTrue(archiveContains(archiveFolder.path(), &quot;Original msg&quot;));
1721             assertTrue(archiveContains(archiveFolder.path(), &quot;More updates&quot;));
1722         }
1723     }
1724 
1725     @Test
1726     void mergeWebrev(TestInfo testInfo) throws IOException {
1727         try (var credentials = new HostCredentials(testInfo);
1728              var tempFolder = new TemporaryDirectory();
1729              var archiveFolder = new TemporaryDirectory();
1730              var listServer = new TestMailmanServer();
1731              var webrevServer = new TestWebrevServer()) {
1732             var author = credentials.getHostedRepository();
1733             var archive = credentials.getHostedRepository();
1734             var commenter = credentials.getHostedRepository();
1735             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
1736             var censusBuilder = credentials.getCensusBuilder()
1737                                            .addAuthor(author.forge().currentUser().id());
1738             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
1739             var mlBot = MailingListBridgeBot.newBuilder()
1740                                             .from(from)
1741                                             .repo(author)
1742                                             .archive(archive)
1743                                             .archiveRef(&quot;archive&quot;)
1744                                             .censusRepo(censusBuilder.build())
1745                                             .list(listAddress)
1746                                             .listArchive(listServer.getArchive())
1747                                             .smtpServer(listServer.getSMTP())
1748                                             .webrevStorageRepository(archive)
1749                                             .webrevStorageRef(&quot;webrev&quot;)
1750                                             .webrevStorageBase(Path.of(&quot;test&quot;))
1751                                             .webrevStorageBaseUri(webrevServer.uri())
1752                                             .issueTracker(URIBuilder.base(&quot;http://issues.test/browse/&quot;).build())
1753                                             .build();
1754 
1755             // Populate the projects repository
1756             var reviewFile = Path.of(&quot;reviewfile.txt&quot;);
1757             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType(), reviewFile);
1758             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
1759             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
1760             localRepo.push(masterHash, archive.url(), &quot;archive&quot;, true);
1761             localRepo.push(masterHash, archive.url(), &quot;webrev&quot;, true);
1762 
1763             // Create a diverging branch
1764             var editOnlyFile = Path.of(&quot;editonly.txt&quot;);
1765             Files.writeString(localRepo.root().resolve(editOnlyFile), &quot;Only added in the edit&quot;);
1766             localRepo.add(editOnlyFile);
1767             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;Edited&quot;);
1768             localRepo.push(editHash, author.url(), &quot;edit&quot;);
1769 
1770             // Make conflicting changes in the target
1771             localRepo.checkout(masterHash, true);
1772             var masterOnlyFile = Path.of(&quot;masteronly.txt&quot;);
1773             Files.writeString(localRepo.root().resolve(masterOnlyFile), &quot;Only added in master&quot;);
1774             localRepo.add(masterOnlyFile);
1775             var updatedMasterHash = CheckableRepository.appendAndCommit(localRepo, &quot;Master change&quot;);
1776             localRepo.push(updatedMasterHash, author.url(), &quot;master&quot;);
1777 
1778             // Perform the merge - resolve conflicts in our favor
1779             localRepo.merge(editHash, &quot;ours&quot;);
1780             localRepo.commit(&quot;Merged edit&quot;, &quot;duke&quot;, &quot;duke@openjdk.java.net&quot;);
1781             var mergeOnlyFile = Path.of(&quot;mergeonly.txt&quot;);
1782             Files.writeString(localRepo.root().resolve(mergeOnlyFile), &quot;Only added in the merge&quot;);
1783             localRepo.add(mergeOnlyFile);
1784             Files.writeString(localRepo.root().resolve(reviewFile), &quot;Overwriting the conflict resolution&quot;);
1785             localRepo.add(reviewFile);
1786             var appendedCommit = localRepo.amend(&quot;Updated merge commit&quot;, &quot;duke&quot;, &quot;duke@openjdk.java.net&quot;);
1787             localRepo.push(appendedCommit, author.url(), &quot;merge_of_edit&quot;, true);
1788 
1789             // Make a merge PR
1790             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;merge_of_edit&quot;, &quot;Merge edit&quot;);
1791             pr.setBody(&quot;This is now ready&quot;);
1792 
1793             // Run an archive pass
1794             TestBotRunner.runPeriodicItems(mlBot);
1795             listServer.processIncoming();
1796 
1797             // The archive should contain a merge style webrev
1798             Repository.materialize(archiveFolder.path(), archive.url(), &quot;archive&quot;);
1799             assertTrue(archiveContains(archiveFolder.path(), &quot;The webrevs contain the adjustments done while merging with regards to each parent branch:&quot;));
1800             assertTrue(archiveContains(archiveFolder.path(), pr.id() + &quot;/webrev.00.0&quot;));
1801             assertTrue(archiveContains(archiveFolder.path(), &quot;3 lines in 2 files changed: 1 ins; 1 del; 1 mod&quot;));
1802 
1803             // The PR should contain a webrev comment
1804             assertEquals(1, pr.comments().size());
1805             var webrevComment = pr.comments().get(0);
1806             assertTrue(webrevComment.body().contains(&quot;Merge target&quot;));
1807             assertTrue(webrevComment.body().contains(&quot;Merge source&quot;));
1808         }
1809     }
1810 
1811     @Test
1812     void mergeWebrevConflict(TestInfo testInfo) throws IOException {
1813         try (var credentials = new HostCredentials(testInfo);
1814              var tempFolder = new TemporaryDirectory();
1815              var archiveFolder = new TemporaryDirectory();
1816              var listServer = new TestMailmanServer();
1817              var webrevServer = new TestWebrevServer()) {
1818             var author = credentials.getHostedRepository();
1819             var archive = credentials.getHostedRepository();
1820             var commenter = credentials.getHostedRepository();
1821             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
1822             var censusBuilder = credentials.getCensusBuilder()
1823                                            .addAuthor(author.forge().currentUser().id());
1824             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
1825             var mlBot = MailingListBridgeBot.newBuilder()
1826                                             .from(from)
1827                                             .repo(author)
1828                                             .archive(archive)
1829                                             .archiveRef(&quot;archive&quot;)
1830                                             .censusRepo(censusBuilder.build())
1831                                             .list(listAddress)
1832                                             .listArchive(listServer.getArchive())
1833                                             .smtpServer(listServer.getSMTP())
1834                                             .webrevStorageRepository(archive)
1835                                             .webrevStorageRef(&quot;webrev&quot;)
1836                                             .webrevStorageBase(Path.of(&quot;test&quot;))
1837                                             .webrevStorageBaseUri(webrevServer.uri())
1838                                             .issueTracker(URIBuilder.base(&quot;http://issues.test/browse/&quot;).build())
1839                                             .build();
1840 
1841             // Populate the projects repository
1842             var reviewFile = Path.of(&quot;reviewfile.txt&quot;);
1843             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType(), reviewFile);
1844             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
1845             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
1846             localRepo.push(masterHash, archive.url(), &quot;archive&quot;, true);
1847             localRepo.push(masterHash, archive.url(), &quot;webrev&quot;, true);
1848 
1849             // Create a merge
1850             var editOnlyFile = Path.of(&quot;editonly.txt&quot;);
1851             Files.writeString(localRepo.root().resolve(editOnlyFile), &quot;Only added in the edit&quot;);
1852             localRepo.add(editOnlyFile);
1853             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;Edited&quot;);
1854             localRepo.checkout(masterHash, true);
1855             var masterOnlyFile = Path.of(&quot;masteronly.txt&quot;);
1856             Files.writeString(localRepo.root().resolve(masterOnlyFile), &quot;Only added in master&quot;);
1857             localRepo.add(masterOnlyFile);
1858             var updatedMasterHash = CheckableRepository.appendAndCommit(localRepo, &quot;Master change&quot;);
1859             localRepo.push(updatedMasterHash, author.url(), &quot;master&quot;);
1860             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
1861 
1862             // Make a merge PR
1863             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;Merge edit&quot;);
1864             pr.setBody(&quot;This is now ready&quot;);
1865 
1866             // Run an archive pass
1867             TestBotRunner.runPeriodicItems(mlBot);
1868             listServer.processIncoming();
1869 
1870             // The archive should contain a merge style webrev
1871             Repository.materialize(archiveFolder.path(), archive.url(), &quot;archive&quot;);
1872             assertTrue(archiveContains(archiveFolder.path(), &quot;The webrev contains the conflicts with master:&quot;));
1873             assertTrue(archiveContains(archiveFolder.path(), pr.id() + &quot;/webrev.00.conflicts&quot;));
1874             assertTrue(archiveContains(archiveFolder.path(), &quot;2 lines in 2 files changed: 2 ins; 0 del; 0 mod&quot;));
1875 
1876             // The PR should contain a webrev comment
1877             assertEquals(1, pr.comments().size());
1878             var webrevComment = pr.comments().get(0);
1879             assertTrue(webrevComment.body().contains(&quot;Merge conflicts&quot;));
1880         }
1881     }
1882 
1883     @Test
1884     void mergeWebrevNoConflict(TestInfo testInfo) throws IOException {
1885         try (var credentials = new HostCredentials(testInfo);
1886              var tempFolder = new TemporaryDirectory();
1887              var archiveFolder = new TemporaryDirectory();
1888              var listServer = new TestMailmanServer();
1889              var webrevServer = new TestWebrevServer()) {
1890             var author = credentials.getHostedRepository();
1891             var archive = credentials.getHostedRepository();
1892             var commenter = credentials.getHostedRepository();
1893             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
1894             var censusBuilder = credentials.getCensusBuilder()
1895                                            .addAuthor(author.forge().currentUser().id());
1896             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
1897             var mlBot = MailingListBridgeBot.newBuilder()
1898                                             .from(from)
1899                                             .repo(author)
1900                                             .archive(archive)
1901                                             .archiveRef(&quot;archive&quot;)
1902                                             .censusRepo(censusBuilder.build())
1903                                             .list(listAddress)
1904                                             .listArchive(listServer.getArchive())
1905                                             .smtpServer(listServer.getSMTP())
1906                                             .webrevStorageRepository(archive)
1907                                             .webrevStorageRef(&quot;webrev&quot;)
1908                                             .webrevStorageBase(Path.of(&quot;test&quot;))
1909                                             .webrevStorageBaseUri(webrevServer.uri())
1910                                             .issueTracker(URIBuilder.base(&quot;http://issues.test/browse/&quot;).build())
1911                                             .build();
1912 
1913             // Populate the projects repository
1914             var reviewFile = Path.of(&quot;reviewfile.txt&quot;);
1915             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType(), reviewFile);
1916             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
1917             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
1918             localRepo.push(masterHash, archive.url(), &quot;archive&quot;, true);
1919             localRepo.push(masterHash, archive.url(), &quot;webrev&quot;, true);
1920 
1921             // Create a merge
1922             var editOnlyFile = Path.of(&quot;editonly.txt&quot;);
1923             Files.writeString(localRepo.root().resolve(editOnlyFile), &quot;Only added in the edit&quot;);
1924             localRepo.add(editOnlyFile);
1925             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;Edited&quot;, &quot;Commit in edit branch&quot;);
1926             localRepo.checkout(masterHash, true);
1927             var masterOnlyFile = Path.of(&quot;masteronly.txt&quot;);
1928             Files.writeString(localRepo.root().resolve(masterOnlyFile), &quot;Only added in master&quot;);
1929             localRepo.add(masterOnlyFile);
1930             var updatedMasterHash = localRepo.commit(&quot;Only added in master&quot;, &quot;duke&quot;, &quot;duke@openjdk.java.net&quot;);
1931             localRepo.push(updatedMasterHash, author.url(), &quot;master&quot;);
1932             localRepo.merge(editHash);
1933             var mergeCommit = localRepo.commit(&quot;Merged edit&quot;, &quot;duke&quot;, &quot;duke@openjdk.java.net&quot;);
1934             localRepo.push(mergeCommit, author.url(), &quot;edit&quot;, true);
1935 
1936             // Make a merge PR
1937             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;Merge edit&quot;);
1938             pr.setBody(&quot;This is now ready&quot;);
1939 
1940             // Run an archive pass
1941             TestBotRunner.runPeriodicItems(mlBot);
1942             listServer.processIncoming();
1943 
1944             // The archive should contain a merge style webrev
1945             Repository.materialize(archiveFolder.path(), archive.url(), &quot;archive&quot;);
1946             assertTrue(archiveContains(archiveFolder.path(), &quot;so no merge-specific webrevs have been generated&quot;));
1947 
1948             // The PR should not contain a webrev comment
1949             assertEquals(0, pr.comments().size());
1950         }
1951     }
1952 
1953     @Test
1954     void skipAddingExistingWebrev(TestInfo testInfo) throws IOException {
1955         try (var credentials = new HostCredentials(testInfo);
1956              var tempFolder = new TemporaryDirectory();
1957              var archiveFolder = new TemporaryDirectory();
1958              var webrevFolder = new TemporaryDirectory();
1959              var listServer = new TestMailmanServer();
1960              var webrevServer = new TestWebrevServer()) {
1961             var author = credentials.getHostedRepository();
1962             var archive = credentials.getHostedRepository();
1963             var ignored = credentials.getHostedRepository();
1964             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
1965             var censusBuilder = credentials.getCensusBuilder()
1966                                            .addAuthor(author.forge().currentUser().id());
1967             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
1968             var mlBot = MailingListBridgeBot.newBuilder()
1969                                             .from(from)
1970                                             .repo(author)
1971                                             .archive(archive)
1972                                             .censusRepo(censusBuilder.build())
1973                                             .list(listAddress)
1974                                             .ignoredUsers(Set.of(ignored.forge().currentUser().userName()))
1975                                             .listArchive(listServer.getArchive())
1976                                             .smtpServer(listServer.getSMTP())
1977                                             .webrevStorageRepository(archive)
1978                                             .webrevStorageRef(&quot;webrev&quot;)
1979                                             .webrevStorageBase(Path.of(&quot;test&quot;))
1980                                             .webrevStorageBaseUri(webrevServer.uri())
1981                                             .issueTracker(URIBuilder.base(&quot;http://issues.test/browse/&quot;).build())
1982                                             .build();
1983 
1984             // Populate the projects repository
1985             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType());
1986             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
1987             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
1988             localRepo.push(masterHash, archive.url(), &quot;webrev&quot;, true);
1989 
1990             // Make a change with a corresponding PR
1991             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;A simple change&quot;,
1992                                                                &quot;Change msg\n\nWith several lines&quot;);
1993             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
1994             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
1995 
1996             // Flag it as ready for review
1997             pr.setBody(&quot;This should now be ready&quot;);
1998 
1999             // Run an archive pass
2000             TestBotRunner.runPeriodicItems(mlBot);
2001 
2002             // The archive should now contain an entry
2003             var archiveRepo = Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);
2004             assertTrue(archiveContains(archiveFolder.path(), editHash.abbreviate()));
2005 
2006             // And there should be a webrev comment
2007             var comments = pr.comments();
2008             var webrevComments = comments.stream()
2009                                          .filter(comment -&gt; comment.author().equals(author.forge().currentUser()))
2010                                          .filter(comment -&gt; comment.body().contains(&quot;webrev&quot;))
2011                                          .filter(comment -&gt; comment.body().contains(editHash.hex()))
2012                                          .collect(Collectors.toList());
2013             assertEquals(1, webrevComments.size());
2014             assertEquals(1, countSubstrings(webrevComments.get(0).body(), &quot;webrev.00&quot;));
2015 
2016             // Pretend the archive didn&#39;t work out
2017             archiveRepo.push(masterHash, archive.url(), &quot;master&quot;, true);
2018 
2019             // Run another archive pass
2020             TestBotRunner.runPeriodicItems(mlBot);
2021 
2022             // The webrev comment should not contain duplicate entries
2023             comments = pr.comments();
2024             webrevComments = comments.stream()
2025                                      .filter(comment -&gt; comment.author().equals(author.forge().currentUser()))
2026                                      .filter(comment -&gt; comment.body().contains(&quot;webrev&quot;))
2027                                      .filter(comment -&gt; comment.body().contains(editHash.hex()))
2028                                      .collect(Collectors.toList());
2029             assertEquals(1, webrevComments.size());
2030             assertEquals(1, countSubstrings(webrevComments.get(0).body(), &quot;webrev.00&quot;));
2031         }
2032     }
2033 
2034     @Test
2035     void notifyReviewVerdicts(TestInfo testInfo) throws IOException {
2036         try (var credentials = new HostCredentials(testInfo);
2037              var tempFolder = new TemporaryDirectory();
2038              var archiveFolder = new TemporaryDirectory();
2039              var listServer = new TestMailmanServer();
2040              var webrevServer = new TestWebrevServer()) {
2041             var author = credentials.getHostedRepository();
2042             var archive = credentials.getHostedRepository();
2043             var reviewer = credentials.getHostedRepository();
2044             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
2045             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
2046             var censusBuilder = credentials.getCensusBuilder()
2047                                            .addReviewer(reviewer.forge().currentUser().id())
2048                                            .addAuthor(author.forge().currentUser().id());
2049             var mlBot = MailingListBridgeBot.newBuilder()
2050                                             .from(from)
2051                                             .repo(author)
2052                                             .archive(archive)
2053                                             .censusRepo(censusBuilder.build())
2054                                             .list(listAddress)
2055                                             .listArchive(listServer.getArchive())
2056                                             .smtpServer(listServer.getSMTP())
2057                                             .webrevStorageRepository(archive)
2058                                             .webrevStorageRef(&quot;webrev&quot;)
2059                                             .webrevStorageBase(Path.of(&quot;test&quot;))
2060                                             .webrevStorageBaseUri(webrevServer.uri())
2061                                             .issueTracker(URIBuilder.base(&quot;http://issues.test/browse/&quot;).build())
2062                                             .build();
2063 
2064             // Populate the projects repository
2065             var reviewFile = Path.of(&quot;reviewfile.txt&quot;);
2066             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType(), reviewFile);
2067             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
2068             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
2069             localRepo.push(masterHash, archive.url(), &quot;webrev&quot;, true);
2070 
2071             // Make a change with a corresponding PR
2072             var editHash = CheckableRepository.appendAndCommit(localRepo);
2073             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
2074             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
2075             pr.setBody(&quot;This is now ready&quot;);
2076 
2077             // Run an archive pass
2078             TestBotRunner.runPeriodicItems(mlBot);
2079 
2080             // First unapprove it
2081             var reviewedPr = reviewer.pullRequest(pr.id());
2082             reviewedPr.addReview(Review.Verdict.DISAPPROVED, &quot;Reason 1&quot;);
2083             TestBotRunner.runPeriodicItems(mlBot);
2084             TestBotRunner.runPeriodicItems(mlBot);
2085             TestBotRunner.runPeriodicItems(mlBot);
2086 
2087             // The archive should contain a note
2088             Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);
2089             assertEquals(1, archiveContainsCount(archiveFolder.path(), &quot;Changes requested by &quot;));
2090             assertEquals(1, archiveContainsCount(archiveFolder.path(), &quot; by integrationreviewer1&quot;));
2091             if (author.forge().supportsReviewBody()) {
2092                 assertEquals(1, archiveContainsCount(archiveFolder.path(), &quot;Reason 1&quot;));
2093             }
2094 
2095             // Then approve it
2096             reviewedPr.addReview(Review.Verdict.APPROVED, &quot;Reason 2&quot;);
2097             TestBotRunner.runPeriodicItems(mlBot);
2098             TestBotRunner.runPeriodicItems(mlBot);
2099             TestBotRunner.runPeriodicItems(mlBot);
2100 
2101             // The archive should contain another note
2102             Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);
2103             assertEquals(1, archiveContainsCount(archiveFolder.path(), &quot;Marked as reviewed by &quot;));
2104             if (author.forge().supportsReviewBody()) {
2105                 assertEquals(1, archiveContainsCount(archiveFolder.path(), &quot;Reason 2&quot;));
2106             }
2107             assertEquals(2, archiveContainsCount(archiveFolder.path(), &quot;Re: RFR:&quot;));
2108 
2109             // Yet another change
2110             reviewedPr.addReview(Review.Verdict.DISAPPROVED, &quot;Reason 3&quot;);
2111             TestBotRunner.runPeriodicItems(mlBot);
2112             TestBotRunner.runPeriodicItems(mlBot);
2113             TestBotRunner.runPeriodicItems(mlBot);
2114 
2115             // The archive should contain another note
2116             Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);
2117             assertEquals(2, archiveContainsCount(archiveFolder.path(), &quot;Changes requested by &quot;));
2118             if (author.forge().supportsReviewBody()) {
2119                 assertEquals(1, archiveContainsCount(archiveFolder.path(), &quot;Reason 3&quot;));
2120             }
2121         }
2122     }
2123 
2124     @Test
2125     void ignoreComments(TestInfo testInfo) throws IOException {
2126         try (var credentials = new HostCredentials(testInfo);
2127              var tempFolder = new TemporaryDirectory();
2128              var archiveFolder = new TemporaryDirectory();
2129              var listServer = new TestMailmanServer();
2130              var webrevServer = new TestWebrevServer()) {
2131             var author = credentials.getHostedRepository();
2132             var ignored = credentials.getHostedRepository();
2133             var archive = credentials.getHostedRepository();
2134             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
2135             var censusBuilder = credentials.getCensusBuilder()
2136                                            .addAuthor(author.forge().currentUser().id());
2137             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
2138             var mlBot = MailingListBridgeBot.newBuilder()
2139                                             .from(from)
2140                                             .repo(author)
2141                                             .archive(archive)
2142                                             .censusRepo(censusBuilder.build())
2143                                             .list(listAddress)
2144                                             .ignoredUsers(Set.of(ignored.forge().currentUser().userName()))
2145                                             .ignoredComments(Set.of(Pattern.compile(&quot;ignore this comment&quot;, Pattern.MULTILINE | Pattern.DOTALL)))
2146                                             .listArchive(listServer.getArchive())
2147                                             .smtpServer(listServer.getSMTP())
2148                                             .webrevStorageRepository(archive)
2149                                             .webrevStorageRef(&quot;webrev&quot;)
2150                                             .webrevStorageBase(Path.of(&quot;test&quot;))
2151                                             .webrevStorageBaseUri(webrevServer.uri())
2152                                             .issueTracker(URIBuilder.base(&quot;http://issues.test/browse/&quot;).build())
2153                                             .build();
2154 
2155             // Populate the projects repository
2156             var reviewFile = Path.of(&quot;reviewfile.txt&quot;);
2157             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType(), reviewFile);
2158             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
2159             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
2160             localRepo.push(masterHash, archive.url(), &quot;webrev&quot;, true);
2161 
2162             // Make a change with a corresponding PR
2163             var editHash = CheckableRepository.appendAndCommit(localRepo);
2164             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
2165             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
2166             pr.setBody(&quot;This is now ready&quot;);
2167 
2168             // Make a bunch of comments
2169             pr.addComment(&quot;Plain comment&quot;);
2170             pr.addComment(&quot;ignore this comment&quot;);
2171             pr.addComment(&quot;I think it is time to\nignore this comment!&quot;);
2172             pr.addReviewComment(masterHash, editHash, reviewFile.toString(), 2, &quot;Review ignore this comment&quot;);
2173 
2174             var ignoredPR = ignored.pullRequest(pr.id());
2175             ignoredPR.addComment(&quot;Don&#39;t mind me&quot;);
2176 
2177             TestBotRunner.runPeriodicItems(mlBot);
2178             TestBotRunner.runPeriodicItems(mlBot);
2179 
2180             // The archive should not contain the ignored comments
2181             Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);
2182             assertTrue(archiveContains(archiveFolder.path(), &quot;This is now ready&quot;));
2183             assertFalse(archiveContains(archiveFolder.path(), &quot;ignore this comment&quot;));
2184             assertFalse(archiveContains(archiveFolder.path(), &quot;it is time to&quot;));
2185             assertFalse(archiveContains(archiveFolder.path(), &quot;Don&#39;t mind me&quot;));
2186             assertFalse(archiveContains(archiveFolder.path(), &quot;Review ignore&quot;));
2187         }
2188     }
2189 
2190     @Test
2191     void replyToEmptyReview(TestInfo testInfo) throws IOException {
2192         try (var credentials = new HostCredentials(testInfo);
2193              var tempFolder = new TemporaryDirectory();
2194              var archiveFolder = new TemporaryDirectory();
2195              var listServer = new TestMailmanServer();
2196              var webrevServer = new TestWebrevServer()) {
2197             var author = credentials.getHostedRepository();
2198             var reviewer = credentials.getHostedRepository();
2199             var archive = credentials.getHostedRepository();
2200             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
2201             var censusBuilder = credentials.getCensusBuilder()
2202                                            .addReviewer(reviewer.forge().currentUser().id())
2203                                            .addAuthor(author.forge().currentUser().id());
2204             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
2205             var mlBot = MailingListBridgeBot.newBuilder()
2206                                             .from(from)
2207                                             .repo(author)
2208                                             .archive(archive)
2209                                             .censusRepo(censusBuilder.build())
2210                                             .list(listAddress)
2211                                             .listArchive(listServer.getArchive())
2212                                             .smtpServer(listServer.getSMTP())
2213                                             .webrevStorageRepository(archive)
2214                                             .webrevStorageRef(&quot;webrev&quot;)
2215                                             .webrevStorageBase(Path.of(&quot;test&quot;))
2216                                             .webrevStorageBaseUri(webrevServer.uri())
2217                                             .issueTracker(URIBuilder.base(&quot;http://issues.test/browse/&quot;).build())
2218                                             .build();
2219 
2220             // Populate the projects repository
2221             var reviewFile = Path.of(&quot;reviewfile.txt&quot;);
2222             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType(), reviewFile);
2223             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
2224             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
2225             localRepo.push(masterHash, archive.url(), &quot;webrev&quot;, true);
2226 
2227             // Make a change with a corresponding PR
2228             var editHash = CheckableRepository.appendAndCommit(localRepo);
2229             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
2230             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
2231             pr.setBody(&quot;This is now ready&quot;);
2232             TestBotRunner.runPeriodicItems(mlBot);
2233             listServer.processIncoming();
2234 
2235             // Make an empty approval
2236             var reviewPr = reviewer.pullRequest(pr.id());
2237             reviewPr.addReview(Review.Verdict.APPROVED, &quot;&quot;);
2238             TestBotRunner.runPeriodicItems(mlBot);
2239             listServer.processIncoming();
2240 
2241             pr.addComment(&quot;Thanks for the review!&quot;);
2242             TestBotRunner.runPeriodicItems(mlBot);
2243             listServer.processIncoming();
2244 
2245             // The approval text should be included in the quote
2246             Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);
2247             assertEquals(1, archiveContainsCount(archiveFolder.path(), &quot;^&gt; Marked as reviewed&quot;));
2248         }
2249     }
2250 
2251     @Test
2252     void cooldown(TestInfo testInfo) throws IOException {
2253         try (var credentials = new HostCredentials(testInfo);
2254              var tempFolder = new TemporaryDirectory();
2255              var archiveFolder = new TemporaryDirectory();
2256              var listServer = new TestMailmanServer();
2257              var webrevServer = new TestWebrevServer()) {
2258             var bot = credentials.getHostedRepository();
2259             var author = credentials.getHostedRepository();
2260             var archive = credentials.getHostedRepository();
2261             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
2262             var censusBuilder = credentials.getCensusBuilder()
2263                                            .addAuthor(author.forge().currentUser().id());
2264             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
2265             var mlBotBuilder = MailingListBridgeBot.newBuilder()
2266                                                    .from(from)
2267                                                    .repo(bot)
2268                                                    .ignoredUsers(Set.of(bot.forge().currentUser().userName()))
2269                                                    .archive(archive)
2270                                                    .censusRepo(censusBuilder.build())
2271                                                    .list(listAddress)
2272                                                    .listArchive(listServer.getArchive())
2273                                                    .smtpServer(listServer.getSMTP())
2274                                                    .webrevStorageRepository(archive)
2275                                                    .webrevStorageRef(&quot;webrev&quot;)
2276                                                    .webrevStorageBase(Path.of(&quot;test&quot;))
2277                                                    .webrevStorageBaseUri(webrevServer.uri())
2278                                                    .issueTracker(URIBuilder.base(&quot;http://issues.test/browse/&quot;).build());
2279 
2280             // Populate the projects repository
2281             var reviewFile = Path.of(&quot;reviewfile.txt&quot;);
2282             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType(), reviewFile);
2283             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
2284             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
2285             localRepo.push(masterHash, archive.url(), &quot;webrev&quot;, true);
2286 
2287             // Make a change with a corresponding PR
2288             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;Line 1\nLine 2\nLine 3\nLine 4&quot;);
2289             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
2290             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
2291             pr.setBody(&quot;This is now ready&quot;);
2292 
2293             var mlBot = mlBotBuilder.build();
2294             var mlBotWithCooldown = mlBotBuilder.cooldown(Duration.ofDays(1)).build();
2295 
2296             TestBotRunner.runPeriodicItems(mlBot);
2297             listServer.processIncoming();
2298 
2299             // Make a comment
2300             pr.addComment(&quot;Looks good&quot;);
2301 
2302             // Bot with cooldown configured should not bridge the comment
2303             TestBotRunner.runPeriodicItems(mlBotWithCooldown);
2304             assertThrows(RuntimeException.class, () -&gt; listServer.processIncoming(Duration.ofMillis(1)));
2305 
2306             // But without, it should
2307             TestBotRunner.runPeriodicItems(mlBot);
2308             listServer.processIncoming();
2309 
2310             // Check the archive
2311             Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);
2312             assertTrue(archiveContains(archiveFolder.path(), &quot;Looks good&quot;));
2313         }
2314     }
2315 
2316     @Test
2317     void cooldownNewRevision(TestInfo testInfo) throws IOException {
2318         try (var credentials = new HostCredentials(testInfo);
2319              var tempFolder = new TemporaryDirectory();
2320              var archiveFolder = new TemporaryDirectory();
2321              var listServer = new TestMailmanServer();
2322              var webrevServer = new TestWebrevServer()) {
2323             var bot = credentials.getHostedRepository();
2324             var author = credentials.getHostedRepository();
2325             var archive = credentials.getHostedRepository();
2326             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
2327             var censusBuilder = credentials.getCensusBuilder()
2328                                            .addAuthor(author.forge().currentUser().id());
2329             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
2330             var mlBotBuilder = MailingListBridgeBot.newBuilder()
2331                                                    .from(from)
2332                                                    .repo(bot)
2333                                                    .ignoredUsers(Set.of(bot.forge().currentUser().userName()))
2334                                                    .archive(archive)
2335                                                    .censusRepo(censusBuilder.build())
2336                                                    .list(listAddress)
2337                                                    .listArchive(listServer.getArchive())
2338                                                    .smtpServer(listServer.getSMTP())
2339                                                    .webrevStorageRepository(archive)
2340                                                    .webrevStorageRef(&quot;webrev&quot;)
2341                                                    .webrevStorageBase(Path.of(&quot;test&quot;))
2342                                                    .webrevStorageBaseUri(webrevServer.uri())
2343                                                    .issueTracker(URIBuilder.base(&quot;http://issues.test/browse/&quot;).build());
2344 
2345             // Populate the projects repository
2346             var reviewFile = Path.of(&quot;reviewfile.txt&quot;);
2347             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType(), reviewFile);
2348             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
2349             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
2350             localRepo.push(masterHash, archive.url(), &quot;webrev&quot;, true);
2351 
2352             // Make a change with a corresponding PR
2353             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;Line 1\nLine 2\nLine 3\nLine 4&quot;);
2354             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
2355             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
2356             pr.setBody(&quot;This is now ready&quot;);
2357 
2358             var mlBot = mlBotBuilder.build();
2359             var mlBotWithCooldown = mlBotBuilder.cooldown(Duration.ofDays(1)).build();
2360 
2361             TestBotRunner.runPeriodicItems(mlBot);
2362             listServer.processIncoming();
2363 
2364             // Commit another revision
2365             var updatedHash = CheckableRepository.appendAndCommit(localRepo, &quot;More stuff&quot;);
2366             localRepo.push(updatedHash, author.url(), &quot;edit&quot;);
2367 
2368             // Bot with cooldown configured should not create a new webrev
2369             TestBotRunner.runPeriodicItems(mlBotWithCooldown);
2370             assertThrows(RuntimeException.class, () -&gt; listServer.processIncoming(Duration.ofMillis(1)));
2371 
2372             // But without, it should
2373             TestBotRunner.runPeriodicItems(mlBot);
2374             listServer.processIncoming();
2375 
2376             // Check the archive
2377             Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);
2378             assertTrue(archiveContains(archiveFolder.path(), &quot;webrev.01&quot;));
2379         }
2380     }
2381 
2382     @Test
2383     void retryAfterCooldown(TestInfo testInfo) throws IOException, InterruptedException {
2384         try (var credentials = new HostCredentials(testInfo);
2385              var tempFolder = new TemporaryDirectory();
2386              var archiveFolder = new TemporaryDirectory();
2387              var listServer = new TestMailmanServer();
2388              var webrevServer = new TestWebrevServer()) {
2389             var bot = credentials.getHostedRepository();
2390             var author = credentials.getHostedRepository();
2391             var archive = credentials.getHostedRepository();
2392             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
2393             var censusBuilder = credentials.getCensusBuilder()
2394                                            .addAuthor(author.forge().currentUser().id());
2395             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
2396             var cooldown = Duration.ofMillis(500);
2397             var mlBotBuilder = MailingListBridgeBot.newBuilder()
2398                                                    .from(from)
2399                                                    .repo(bot)
2400                                                    .ignoredUsers(Set.of(bot.forge().currentUser().userName()))
2401                                                    .archive(archive)
2402                                                    .censusRepo(censusBuilder.build())
2403                                                    .list(listAddress)
2404                                                    .listArchive(listServer.getArchive())
2405                                                    .smtpServer(listServer.getSMTP())
2406                                                    .webrevStorageRepository(archive)
2407                                                    .webrevStorageRef(&quot;webrev&quot;)
2408                                                    .webrevStorageBase(Path.of(&quot;test&quot;))
2409                                                    .webrevStorageBaseUri(webrevServer.uri())
2410                                                    .issueTracker(URIBuilder.base(&quot;http://issues.test/browse/&quot;).build());
2411 
2412             // Populate the projects repository
2413             var reviewFile = Path.of(&quot;reviewfile.txt&quot;);
2414             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType(), reviewFile);
2415             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
2416             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
2417             localRepo.push(masterHash, archive.url(), &quot;webrev&quot;, true);
2418 
2419             // Make a change with a corresponding PR
2420             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;Line 1\nLine 2\nLine 3\nLine 4&quot;);
2421             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
2422             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
2423             pr.setBody(&quot;This is now ready&quot;);
2424 
2425             var mlBot = mlBotBuilder.cooldown(cooldown).build();
2426             Thread.sleep(cooldown.toMillis());
2427             TestBotRunner.runPeriodicItems(mlBot);
2428             listServer.processIncoming();
2429 
2430             // Make a comment and run the check within the cooldown period
2431             int counter;
2432             boolean noMailReceived = false;
2433             for (counter = 1; counter &lt; 10; ++counter) {
2434                 var start = Instant.now();
2435                 pr.addComment(&quot;Looks good - &quot; + counter + &quot; -&quot;);
2436 
2437                 // The bot should not bridge the comment due to cooldown
2438                 TestBotRunner.runPeriodicItems(mlBot);
2439                 try {
2440                     noMailReceived = false;
2441                     listServer.processIncoming(Duration.ofMillis(1));
2442                 } catch (RuntimeException e) {
2443                     noMailReceived = true;
2444                 }
2445                 var elapsed = Duration.between(start, Instant.now());
2446                 if (elapsed.compareTo(cooldown) &lt; 0) {
2447                     break;
2448                 } else {
2449                     log.info(&quot;Didn&#39;t do the test in time - retrying (elapsed: &quot; + elapsed + &quot; required: &quot; + cooldown + &quot;)&quot;);
2450                     // Ensure that the cooldown expires
2451                     Thread.sleep(cooldown.toMillis());
2452                     // If no mail was received, we have to flush it out
2453                     if (noMailReceived) {
2454                         TestBotRunner.runPeriodicItems(mlBot);
2455                         listServer.processIncoming();
2456                     }
2457                     cooldown = cooldown.multipliedBy(2);
2458                     mlBot = mlBotBuilder.cooldown(cooldown).build();
2459                 }
2460             }
2461             assertTrue(noMailReceived);
2462 
2463             // But after the cooldown period has passed, it should
2464             Thread.sleep(cooldown.toMillis());
2465             TestBotRunner.runPeriodicItems(mlBot);
2466             listServer.processIncoming();
2467 
2468             // Check the archive
2469             Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);
2470             assertTrue(archiveContains(archiveFolder.path(), &quot;Looks good - &quot; + counter + &quot; -&quot;));
2471         }
2472     }
2473 
2474     @Test
2475     void branchPrefix(TestInfo testInfo) throws IOException {
2476         try (var credentials = new HostCredentials(testInfo);
2477              var tempFolder = new TemporaryDirectory();
2478              var archiveFolder = new TemporaryDirectory();
2479              var listServer = new TestMailmanServer();
2480              var webrevServer = new TestWebrevServer()) {
2481             var author = credentials.getHostedRepository();
2482             var archive = credentials.getHostedRepository();
2483             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
2484             var censusBuilder = credentials.getCensusBuilder()
2485                                            .addAuthor(author.forge().currentUser().id());
2486             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
2487             var mlBot = MailingListBridgeBot.newBuilder()
2488                                             .from(from)
2489                                             .repo(author)
2490                                             .archive(archive)
2491                                             .censusRepo(censusBuilder.build())
2492                                             .list(listAddress)
2493                                             .listArchive(listServer.getArchive())
2494                                             .smtpServer(listServer.getSMTP())
2495                                             .webrevStorageRepository(archive)
2496                                             .webrevStorageRef(&quot;webrev&quot;)
2497                                             .webrevStorageBase(Path.of(&quot;test&quot;))
2498                                             .webrevStorageBaseUri(webrevServer.uri())
2499                                             .issueTracker(URIBuilder.base(&quot;http://issues.test/browse/&quot;).build())
2500                                             .branchInSubject(Pattern.compile(&quot;.*&quot;))
2501                                             .build();
2502 
2503             // Populate the projects repository
2504             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType());
2505             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
2506             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
2507             localRepo.push(masterHash, archive.url(), &quot;webrev&quot;, true);
2508 
2509             // Make a change with a corresponding PR
2510             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;A simple change&quot;,
2511                                                                &quot;Change msg\n\nWith several lines&quot;);
2512             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
2513             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;1234: This is a pull request&quot;);
2514             pr.setBody(&quot;This is a PR&quot;);
2515 
2516             // Run an archive pass
2517             TestBotRunner.runPeriodicItems(mlBot);
2518             listServer.processIncoming();
2519 
2520             pr.addComment(&quot;Looks good!&quot;);
2521             TestBotRunner.runPeriodicItems(mlBot);
2522             listServer.processIncoming();
2523 
2524             // Check the archive
2525             Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);
2526             assertTrue(archiveContains(archiveFolder.path(), &quot;Subject: \\[master\\] RFR: &quot;));
2527             assertTrue(archiveContains(archiveFolder.path(), &quot;Subject: Re: \\[master\\] RFR: &quot;));
2528         }
2529     }
2530 
2531     @Test
2532     void repoPrefix(TestInfo testInfo) throws IOException {
2533         try (var credentials = new HostCredentials(testInfo);
2534              var tempFolder = new TemporaryDirectory();
2535              var archiveFolder = new TemporaryDirectory();
2536              var listServer = new TestMailmanServer();
2537              var webrevServer = new TestWebrevServer()) {
2538             var author = credentials.getHostedRepository();
2539             var archive = credentials.getHostedRepository();
2540             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
2541             var censusBuilder = credentials.getCensusBuilder()
2542                                            .addAuthor(author.forge().currentUser().id());
2543             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
2544             var mlBot = MailingListBridgeBot.newBuilder()
2545                                             .from(from)
2546                                             .repo(author)
2547                                             .archive(archive)
2548                                             .censusRepo(censusBuilder.build())
2549                                             .list(listAddress)
2550                                             .listArchive(listServer.getArchive())
2551                                             .smtpServer(listServer.getSMTP())
2552                                             .webrevStorageRepository(archive)
2553                                             .webrevStorageRef(&quot;webrev&quot;)
2554                                             .webrevStorageBase(Path.of(&quot;test&quot;))
2555                                             .webrevStorageBaseUri(webrevServer.uri())
2556                                             .issueTracker(URIBuilder.base(&quot;http://issues.test/browse/&quot;).build())
2557                                             .repoInSubject(true)
2558                                             .build();
2559 
2560             // Populate the projects repository
2561             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType());
2562             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
2563             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
2564             localRepo.push(masterHash, archive.url(), &quot;webrev&quot;, true);
2565 
2566             // Make a change with a corresponding PR
2567             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;A simple change&quot;,
2568                                                                &quot;Change msg\n\nWith several lines&quot;);
2569             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
2570             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;1234: This is a pull request&quot;);
2571             pr.setBody(&quot;This is a PR&quot;);
2572 
2573             // Run an archive pass
2574             TestBotRunner.runPeriodicItems(mlBot);
2575             listServer.processIncoming();
2576 
2577             pr.addComment(&quot;Looks good!&quot;);
2578             TestBotRunner.runPeriodicItems(mlBot);
2579             listServer.processIncoming();
2580 
2581             // Check the archive
2582             Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);
2583             assertTrue(archiveContains(archiveFolder.path(), &quot;Subject: \\[&quot; + pr.repository().name() + &quot;\\] RFR: &quot;));
2584             assertTrue(archiveContains(archiveFolder.path(), &quot;Subject: Re: \\[&quot; + pr.repository().name() + &quot;\\] RFR: &quot;));
2585         }
2586     }
2587 
2588     @Test
2589     void repoAndBranchPrefix(TestInfo testInfo) throws IOException {
2590         try (var credentials = new HostCredentials(testInfo);
2591              var tempFolder = new TemporaryDirectory();
2592              var archiveFolder = new TemporaryDirectory();
2593              var listServer = new TestMailmanServer();
2594              var webrevServer = new TestWebrevServer()) {
2595             var author = credentials.getHostedRepository();
2596             var archive = credentials.getHostedRepository();
2597             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
2598             var censusBuilder = credentials.getCensusBuilder()
2599                                            .addAuthor(author.forge().currentUser().id());
2600             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
2601             var mlBot = MailingListBridgeBot.newBuilder()
2602                                             .from(from)
2603                                             .repo(author)
2604                                             .archive(archive)
2605                                             .censusRepo(censusBuilder.build())
2606                                             .list(listAddress)
2607                                             .listArchive(listServer.getArchive())
2608                                             .smtpServer(listServer.getSMTP())
2609                                             .webrevStorageRepository(archive)
2610                                             .webrevStorageRef(&quot;webrev&quot;)
2611                                             .webrevStorageBase(Path.of(&quot;test&quot;))
2612                                             .webrevStorageBaseUri(webrevServer.uri())
2613                                             .issueTracker(URIBuilder.base(&quot;http://issues.test/browse/&quot;).build())
2614                                             .repoInSubject(true)
2615                                             .branchInSubject(Pattern.compile(&quot;.*&quot;))
2616                                             .build();
2617 
2618             // Populate the projects repository
2619             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType());
2620             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
2621             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
2622             localRepo.push(masterHash, archive.url(), &quot;webrev&quot;, true);
2623 
2624             // Make a change with a corresponding PR
2625             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;A simple change&quot;,
2626                                                                &quot;Change msg\n\nWith several lines&quot;);
2627             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
2628             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;1234: This is a pull request&quot;);
2629             pr.setBody(&quot;This is a PR&quot;);
2630 
2631             // Run an archive pass
2632             TestBotRunner.runPeriodicItems(mlBot);
2633             listServer.processIncoming();
2634 
2635             pr.addComment(&quot;Looks good!&quot;);
2636             TestBotRunner.runPeriodicItems(mlBot);
2637             listServer.processIncoming();
2638 
2639             // Check the archive
2640             Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);
2641             assertTrue(archiveContains(archiveFolder.path(), &quot;Subject: \\[&quot; + pr.repository().name() + &quot;:master\\] RFR: &quot;));
2642             assertTrue(archiveContains(archiveFolder.path(), &quot;Subject: Re: \\[&quot; + pr.repository().name() + &quot;:master\\] RFR: &quot;));
2643         }
2644     }
2645 
2646     @Test
2647     void retryNewRevisionAfterCooldown(TestInfo testInfo) throws IOException, InterruptedException {
2648         try (var credentials = new HostCredentials(testInfo);
2649              var tempFolder = new TemporaryDirectory();
2650              var archiveFolder = new TemporaryDirectory();
2651              var listServer = new TestMailmanServer();
2652              var webrevServer = new TestWebrevServer()) {
2653             var bot = credentials.getHostedRepository();
2654             var author = credentials.getHostedRepository();
2655             var archive = credentials.getHostedRepository();
2656             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
2657             var censusBuilder = credentials.getCensusBuilder()
2658                                            .addAuthor(author.forge().currentUser().id());
2659             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
2660             var cooldown = Duration.ofMillis(500);
2661             var mlBotBuilder = MailingListBridgeBot.newBuilder()
2662                                                    .from(from)
2663                                                    .repo(bot)
2664                                                    .ignoredUsers(Set.of(bot.forge().currentUser().userName()))
2665                                                    .archive(archive)
2666                                                    .censusRepo(censusBuilder.build())
2667                                                    .list(listAddress)
2668                                                    .listArchive(listServer.getArchive())
2669                                                    .smtpServer(listServer.getSMTP())
2670                                                    .webrevStorageRepository(archive)
2671                                                    .webrevStorageRef(&quot;webrev&quot;)
2672                                                    .webrevStorageBase(Path.of(&quot;test&quot;))
2673                                                    .webrevStorageBaseUri(webrevServer.uri())
2674                                                    .issueTracker(URIBuilder.base(&quot;http://issues.test/browse/&quot;).build());
2675 
2676             // Populate the projects repository
2677             var reviewFile = Path.of(&quot;reviewfile.txt&quot;);
2678             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType(), reviewFile);
2679             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
2680             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
2681             localRepo.push(masterHash, archive.url(), &quot;webrev&quot;, true);
2682 
2683             // Make a change with a corresponding PR
2684             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;Line 1\nLine 2\nLine 3\nLine 4&quot;);
2685             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
2686             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
2687             pr.setBody(&quot;This is now ready&quot;);
2688 
2689             var mlBot = mlBotBuilder.cooldown(cooldown).build();
2690             Thread.sleep(cooldown.toMillis());
2691             TestBotRunner.runPeriodicItems(mlBot);
2692             listServer.processIncoming();
2693 
2694             // Make a new revision and run the check within the cooldown period
2695             int counter;
2696             boolean noMailReceived = false;
2697             for (counter = 1; counter &lt; 10; ++counter) {
2698                 var start = Instant.now();
2699                 var revHash = CheckableRepository.appendAndCommit(localRepo, &quot;more stuff&quot;, &quot;Update number - &quot; + counter + &quot; -&quot;);
2700                 localRepo.push(revHash, author.url(), &quot;edit&quot;);
2701 
2702                 // The bot should not bridge the new revision due to cooldown
2703                 TestBotRunner.runPeriodicItems(mlBot);
2704                 try {
2705                     noMailReceived = false;
2706                     listServer.processIncoming(Duration.ofMillis(1));
2707                 } catch (RuntimeException e) {
2708                     noMailReceived = true;
2709                 }
2710                 var elapsed = Duration.between(start, Instant.now());
2711                 if (elapsed.compareTo(cooldown) &lt; 0) {
2712                     break;
2713                 } else {
2714                     log.info(&quot;Didn&#39;t do the test in time - retrying (elapsed: &quot; + elapsed + &quot; required: &quot; + cooldown + &quot;)&quot;);
2715                     // Ensure that the cooldown expires
2716                     Thread.sleep(cooldown.toMillis());
2717                     // If no mail was received, we have to flush it out
2718                     if (noMailReceived) {
2719                         TestBotRunner.runPeriodicItems(mlBot);
2720                         listServer.processIncoming();
2721                     }
2722                     cooldown = cooldown.multipliedBy(2);
2723                     mlBot = mlBotBuilder.cooldown(cooldown).build();
2724                 }
2725             }
2726             assertTrue(noMailReceived);
2727 
2728             // But after the cooldown period has passed, it should
2729             Thread.sleep(cooldown.toMillis());
2730             TestBotRunner.runPeriodicItems(mlBot);
2731             listServer.processIncoming();
2732 
2733             // Check the archive
2734             Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);
2735             assertTrue(archiveContains(archiveFolder.path(), &quot;Update number - &quot; + counter + &quot; -&quot;));
2736         }
2737     }
2738 }
    </pre>
  </body>
</html>