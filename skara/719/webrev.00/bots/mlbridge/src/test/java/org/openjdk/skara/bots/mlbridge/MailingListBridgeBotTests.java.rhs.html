<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Frames bots/mlbridge/src/test/java/org/openjdk/skara/bots/mlbridge/MailingListBridgeBotTests.java</title>
    <link rel="stylesheet" href="../../../../../../../../../../style.css" />
    <script type="text/javascript" src="../../../../../../../../../../navigation.js"></script>
  </head>
<body onkeypress="keypress(event);">
<a name="0"></a>
<hr />
<pre>   1 /*
   2  * Copyright (c) 2019, Oracle and/or its affiliates. All rights reserved.
   3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   4  *
   5  * This code is free software; you can redistribute it and/or modify it
   6  * under the terms of the GNU General Public License version 2 only, as
   7  * published by the Free Software Foundation.
   8  *
   9  * This code is distributed in the hope that it will be useful, but WITHOUT
  10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
  11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
  12  * version 2 for more details (a copy is included in the LICENSE file that
  13  * accompanied this code).
  14  *
  15  * You should have received a copy of the GNU General Public License version
  16  * 2 along with this work; if not, write to the Free Software Foundation,
  17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
  18  *
  19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
  20  * or visit www.oracle.com if you need additional information or have any
  21  * questions.
  22  */
  23 package org.openjdk.skara.bots.mlbridge;
  24 
  25 import org.openjdk.skara.email.EmailAddress;
  26 import org.openjdk.skara.forge.*;
  27 import org.openjdk.skara.issuetracker.Issue;
  28 import org.openjdk.skara.network.URIBuilder;
  29 import org.openjdk.skara.mailinglist.MailingListServerFactory;
  30 import org.openjdk.skara.test.*;
  31 import org.openjdk.skara.vcs.Repository;
<a name="1" id="anc1"></a><span class="line-added">  32 import org.openjdk.skara.json.JSON;</span>
  33 
  34 import org.junit.jupiter.api.*;
  35 
  36 import java.io.IOException;
  37 import java.nio.charset.StandardCharsets;
  38 import java.nio.file.*;
  39 import java.time.*;
  40 import java.util.*;
  41 import java.util.logging.Logger;
  42 import java.util.regex.Pattern;
  43 import java.util.stream.Collectors;
  44 
  45 import static org.junit.jupiter.api.Assertions.*;
  46 
  47 class MailingListBridgeBotTests {
  48     private final Logger log = Logger.getLogger(&quot;org.openjdk.skara.bots.mlbridge.test&quot;);
  49 
  50     private Optional&lt;String&gt; archiveContents(Path archive) {
  51         try {
  52             var mbox = Files.find(archive, 50, (path, attrs) -&gt; path.toString().endsWith(&quot;.mbox&quot;)).findAny();
  53             if (mbox.isEmpty()) {
  54                 return Optional.empty();
  55             }
  56             return Optional.of(Files.readString(mbox.get(), StandardCharsets.UTF_8));
  57         } catch (IOException e) {
  58             return Optional.empty();
  59         }
  60 
  61     }
  62 
  63     private boolean archiveContains(Path archive, String text) {
  64         return archiveContainsCount(archive, text) &gt; 0;
  65     }
  66 
  67     private int archiveContainsCount(Path archive, String text) {
  68         var lines = archiveContents(archive);
  69         if (lines.isEmpty()) {
  70             return 0;
  71         }
  72         var pattern = Pattern.compile(text);
  73         int count = 0;
  74         for (var line : lines.get().split(&quot;\\R&quot;)) {
  75             var matcher = pattern.matcher(line);
  76             if (matcher.find()) {
  77                 count++;
  78             }
  79         }
  80         return count;
  81     }
  82 
  83     private boolean webrevContains(Path webrev, String text) {
  84         try {
  85             var index = Files.find(webrev, 5, (path, attrs) -&gt; path.toString().endsWith(&quot;index.html&quot;)).findAny();
  86             if (index.isEmpty()) {
  87                 return false;
  88             }
  89             var lines = Files.readString(index.get(), StandardCharsets.UTF_8);
  90             return lines.contains(text);
  91         } catch (IOException e) {
  92             return false;
  93         }
  94     }
  95 
  96     private long countSubstrings(String string, String substring) {
  97         return Pattern.compile(substring).matcher(string).results().count();
  98     }
  99 
 100     private String noreplyAddress(HostedRepository repository) {
 101         return &quot;test+&quot; + repository.forge().currentUser().id() + &quot;+&quot; +
 102                 repository.forge().currentUser().userName() +
 103                 &quot;@openjdk.java.net&quot;;
 104     }
 105 
 106     @Test
 107     void simpleArchive(TestInfo testInfo) throws IOException {
 108         try (var credentials = new HostCredentials(testInfo);
 109              var tempFolder = new TemporaryDirectory();
 110              var archiveFolder = new TemporaryDirectory();
 111              var webrevFolder = new TemporaryDirectory();
 112              var listServer = new TestMailmanServer();
 113              var webrevServer = new TestWebrevServer()) {
 114             var author = credentials.getHostedRepository();
 115             var archive = credentials.getHostedRepository();
 116             var ignored = credentials.getHostedRepository();
 117             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
 118             var censusBuilder = credentials.getCensusBuilder()
 119                                            .addAuthor(author.forge().currentUser().id());
 120             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
 121             var mlBot = MailingListBridgeBot.newBuilder()
 122                                             .from(from)
 123                                             .repo(author)
 124                                             .archive(archive)
 125                                             .censusRepo(censusBuilder.build())
 126                                             .lists(List.of(new MailingListConfiguration(listAddress, Set.of())))
 127                                             .ignoredUsers(Set.of(ignored.forge().currentUser().userName()))
 128                                             .ignoredComments(Set.of())
 129                                             .listArchive(listServer.getArchive())
 130                                             .smtpServer(listServer.getSMTP())
<a name="2" id="anc2"></a><span class="line-modified"> 131                                             .webrevStorageHTMLRepository(archive)</span>
 132                                             .webrevStorageRef(&quot;webrev&quot;)
 133                                             .webrevStorageBase(Path.of(&quot;test&quot;))
 134                                             .webrevStorageBaseUri(webrevServer.uri())
 135                                             .readyLabels(Set.of(&quot;rfr&quot;))
 136                                             .readyComments(Map.of(ignored.forge().currentUser().userName(), Pattern.compile(&quot;ready&quot;)))
 137                                             .issueTracker(URIBuilder.base(&quot;http://issues.test/browse/&quot;).build())
 138                                             .headers(Map.of(&quot;Extra1&quot;, &quot;val1&quot;, &quot;Extra2&quot;, &quot;val2&quot;))
 139                                             .sendInterval(Duration.ZERO)
 140                                             .build();
 141 
 142             // Populate the projects repository
 143             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType());
 144             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
 145             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
 146             localRepo.push(masterHash, archive.url(), &quot;webrev&quot;, true);
 147 
 148             // Make a change with a corresponding PR
 149             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;A simple change&quot;,
 150                                                                &quot;Change msg\n\nWith several lines&quot;);
 151             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
 152             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;1234: This is a pull request&quot;);
 153             pr.setBody(&quot;This should not be ready&quot;);
 154 
 155             // Run an archive pass
 156             TestBotRunner.runPeriodicItems(mlBot);
 157 
 158             // A PR that isn&#39;t ready for review should not be archived
 159             Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);
 160             assertFalse(archiveContains(archiveFolder.path(), &quot;This is a pull request&quot;));
 161 
 162             // Flag it as ready for review
 163             pr.setBody(&quot;This should now be ready&quot;);
 164             pr.addLabel(&quot;rfr&quot;);
 165 
 166             // Run another archive pass
 167             TestBotRunner.runPeriodicItems(mlBot);
 168 
 169             // But it should still not be archived
 170             Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);
 171             assertFalse(archiveContains(archiveFolder.path(), &quot;This is a pull request&quot;));
 172 
 173             // Now post a general comment - not a ready marker
 174             var ignoredPr = ignored.pullRequest(pr.id());
 175             ignoredPr.addComment(&quot;hello there&quot;);
 176 
 177             // Run another archive pass
 178             TestBotRunner.runPeriodicItems(mlBot);
 179 
 180             // It should still not be archived
 181             Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);
 182             assertFalse(archiveContains(archiveFolder.path(), &quot;This is a pull request&quot;));
 183 
 184             // Now post a ready comment
 185             ignoredPr.addComment(&quot;ready&quot;);
 186 
 187             // Run another archive pass
 188             TestBotRunner.runPeriodicItems(mlBot);
 189 
 190             // The archive should now contain an entry
 191             Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);
 192             assertTrue(archiveContains(archiveFolder.path(), &quot;This is a pull request&quot;));
 193             assertTrue(archiveContains(archiveFolder.path(), &quot;This should now be ready&quot;));
 194             assertTrue(archiveContains(archiveFolder.path(), &quot;Patch:&quot;));
 195             assertTrue(archiveContains(archiveFolder.path(), &quot;Changes:&quot;));
 196             assertTrue(archiveContains(archiveFolder.path(), &quot;Webrev:&quot;));
 197             assertTrue(archiveContains(archiveFolder.path(), webrevServer.uri().toString()));
 198             assertTrue(archiveContains(archiveFolder.path(), pr.id() + &quot;/00&quot;));
 199             assertTrue(archiveContains(archiveFolder.path(), &quot;Issue:&quot;));
 200             assertTrue(archiveContains(archiveFolder.path(), &quot;http://issues.test/browse/TSTPRJ-1234&quot;));
 201             assertTrue(archiveContains(archiveFolder.path(), &quot;Fetch:&quot;));
 202             assertTrue(archiveContains(archiveFolder.path(), &quot;^ - Change msg&quot;));
 203             assertFalse(archiveContains(archiveFolder.path(), &quot;With several lines&quot;));
 204 
 205             // The mailing list as well
 206             listServer.processIncoming();
 207             var mailmanServer = MailingListServerFactory.createMailmanServer(listServer.getArchive(), listServer.getSMTP(), Duration.ZERO);
 208             var mailmanList = mailmanServer.getList(listAddress.address());
 209             var conversations = mailmanList.conversations(Duration.ofDays(1));
 210             assertEquals(1, conversations.size());
 211             var mail = conversations.get(0).first();
 212             assertEquals(&quot;RFR: 1234: This is a pull request&quot;, mail.subject());
 213             assertEquals(pr.author().fullName(), mail.author().fullName().orElseThrow());
 214             assertEquals(noreplyAddress(archive), mail.author().address());
 215             assertEquals(listAddress, mail.sender());
 216             assertEquals(&quot;val1&quot;, mail.headerValue(&quot;Extra1&quot;));
 217             assertEquals(&quot;val2&quot;, mail.headerValue(&quot;Extra2&quot;));
 218 
 219             // And there should be a webrev
 220             Repository.materialize(webrevFolder.path(), archive.url(), &quot;webrev&quot;);
 221             assertTrue(webrevContains(webrevFolder.path(), &quot;1 lines changed&quot;));
 222             var comments = pr.comments();
 223             var webrevComments = comments.stream()
 224                                          .filter(comment -&gt; comment.author().equals(author.forge().currentUser()))
 225                                          .filter(comment -&gt; comment.body().contains(&quot;webrev&quot;))
 226                                          .filter(comment -&gt; comment.body().contains(editHash.hex()))
 227                                          .collect(Collectors.toList());
 228             assertEquals(1, webrevComments.size());
 229 
 230             // Add a comment
 231             pr.addComment(&quot;This is a comment :smile:&quot;);
 232 
 233             // Add a comment from an ignored user as well
 234             ignoredPr.addComment(&quot;Don&#39;t mind me&quot;);
 235 
 236             // Run another archive pass
 237             TestBotRunner.runPeriodicItems(mlBot);
 238 
 239             // The archive should now contain the comment, but not the ignored one
 240             Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);
 241             assertTrue(archiveContains(archiveFolder.path(), &quot;This is a comment&quot;));
 242             assertTrue(archiveContains(archiveFolder.path(), &quot;&gt; This should now be ready&quot;));
 243             assertFalse(archiveContains(archiveFolder.path(), &quot;Don&#39;t mind me&quot;));
 244 
 245             listServer.processIncoming();
 246             conversations = mailmanList.conversations(Duration.ofDays(1));
 247             assertEquals(1, conversations.size());
 248             assertEquals(2, conversations.get(0).allMessages().size());
 249 
 250             // Remove the rfr flag and post another comment
 251             pr.addLabel(&quot;rfr&quot;);
 252             pr.addComment(&quot;This is another comment&quot;);
 253 
 254             // Run another archive pass
 255             TestBotRunner.runPeriodicItems(mlBot);
 256 
 257             // The archive should contain the additional comment
 258             Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);
 259             assertTrue(archiveContains(archiveFolder.path(), &quot;This is another comment&quot;));
 260             assertTrue(archiveContains(archiveFolder.path(), &quot;&gt;&gt; This should now be ready&quot;));
 261 
 262             listServer.processIncoming();
 263             conversations = mailmanList.conversations(Duration.ofDays(1));
 264             assertEquals(1, conversations.size());
 265             assertEquals(3, conversations.get(0).allMessages().size());
 266             for (var newMail : conversations.get(0).allMessages()) {
 267                 assertEquals(noreplyAddress(archive), newMail.author().address());
 268                 assertEquals(listAddress, newMail.sender());
 269             }
 270             assertTrue(conversations.get(0).allMessages().get(2).body().contains(&quot;This is a comment ðŸ˜„&quot;));
 271         }
 272     }
 273 
 274     @Test
 275     void archiveIntegrated(TestInfo testInfo) throws IOException {
 276         try (var credentials = new HostCredentials(testInfo);
 277              var tempFolder = new TemporaryDirectory();
 278              var archiveFolder = new TemporaryDirectory();
 279              var webrevFolder = new TemporaryDirectory();
 280              var listServer = new TestMailmanServer();
 281              var webrevServer = new TestWebrevServer()) {
 282             var author = credentials.getHostedRepository();
 283             var archive = credentials.getHostedRepository();
 284             var ignored = credentials.getHostedRepository();
 285             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
 286             var censusBuilder = credentials.getCensusBuilder()
 287                                            .addAuthor(author.forge().currentUser().id());
 288             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
 289             var mlBot = MailingListBridgeBot.newBuilder()
 290                                             .from(from)
 291                                             .repo(author)
 292                                             .archive(archive)
 293                                             .censusRepo(censusBuilder.build())
 294                                             .lists(List.of(new MailingListConfiguration(listAddress, Set.of())))
 295                                             .ignoredUsers(Set.of(ignored.forge().currentUser().userName()))
 296                                             .listArchive(listServer.getArchive())
 297                                             .smtpServer(listServer.getSMTP())
<a name="3" id="anc3"></a><span class="line-modified"> 298                                             .webrevStorageHTMLRepository(archive)</span>
 299                                             .webrevStorageRef(&quot;webrev&quot;)
 300                                             .webrevStorageBase(Path.of(&quot;test&quot;))
 301                                             .webrevStorageBaseUri(webrevServer.uri())
 302                                             .issueTracker(URIBuilder.base(&quot;http://issues.test/browse/&quot;).build())
 303                                             .build();
 304 
 305             // Populate the projects repository
 306             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType());
 307             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
 308             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
 309             localRepo.push(masterHash, archive.url(), &quot;webrev&quot;, true);
 310 
 311             // Make a change with a corresponding PR
 312             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;A simple change&quot;,
 313                                                                &quot;Change msg\n\nWith several lines&quot;);
 314             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
 315             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;1234: This is a pull request&quot;);
 316             pr.setBody(&quot;This is now ready&quot;);
 317             pr.addLabel(&quot;rfr&quot;);
 318 
 319             // Run an archive pass
 320             TestBotRunner.runPeriodicItems(mlBot);
 321             TestBotRunner.runPeriodicItems(mlBot);
 322 
 323             // There should be an RFR thread
 324             Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);
 325             assertTrue(archiveContains(archiveFolder.path(), &quot;Subject: RFR: 1234: This is a pull request&quot;));
 326 
 327             // Add a comment quickly before integration - it should not be combined with the integration message
 328             pr.addComment(&quot;I will now integrate this PR&quot;);
 329 
 330             // Now it has been integrated
 331             var ignoredPr = ignored.pullRequest(pr.id());
 332             ignoredPr.setBody(&quot;This has been integrated&quot;);
 333             ignoredPr.addLabel(&quot;integrated&quot;);
 334             ignoredPr.addComment(&quot;Pushed as commit &quot; + editHash + &quot;.&quot;);
 335             ignoredPr.setState(Issue.State.CLOSED);
 336 
 337             // Run another archive pass
 338             TestBotRunner.runPeriodicItems(mlBot);
 339 
 340             // The archive should now contain another entry
 341             Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);
 342             assertTrue(archiveContains(archiveFolder.path(), &quot;Subject: Re: RFR: 1234: This is a pull request&quot;));
 343             assertTrue(archiveContains(archiveFolder.path(), &quot;Subject: Integrated: 1234: This is a pull request&quot;));
 344             assertFalse(archiveContains(archiveFolder.path(), &quot;\\[Closed\\]&quot;));
 345         }
 346     }
 347 
 348     @Test
 349     void archiveLegacyIntegrated(TestInfo testInfo) throws IOException {
 350         try (var credentials = new HostCredentials(testInfo);
 351              var tempFolder = new TemporaryDirectory();
 352              var archiveFolder = new TemporaryDirectory();
 353              var webrevFolder = new TemporaryDirectory();
 354              var listServer = new TestMailmanServer();
 355              var webrevServer = new TestWebrevServer()) {
 356             var author = credentials.getHostedRepository();
 357             var archive = credentials.getHostedRepository();
 358             var ignored = credentials.getHostedRepository();
 359             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
 360             var censusBuilder = credentials.getCensusBuilder()
 361                     .addAuthor(author.forge().currentUser().id());
 362             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
 363             var mlBot = MailingListBridgeBot.newBuilder()
 364                                             .from(from)
 365                                             .repo(author)
 366                                             .archive(archive)
 367                                             .censusRepo(censusBuilder.build())
 368                                             .lists(List.of(new MailingListConfiguration(listAddress, Set.of())))
 369                                             .ignoredUsers(Set.of(ignored.forge().currentUser().userName()))
 370                                             .listArchive(listServer.getArchive())
 371                                             .smtpServer(listServer.getSMTP())
<a name="4" id="anc4"></a><span class="line-modified"> 372                                             .webrevStorageHTMLRepository(archive)</span>
 373                                             .webrevStorageRef(&quot;webrev&quot;)
 374                                             .webrevStorageBase(Path.of(&quot;test&quot;))
 375                                             .webrevStorageBaseUri(webrevServer.uri())
 376                                             .issueTracker(URIBuilder.base(&quot;http://issues.test/browse/&quot;).build())
 377                                             .build();
 378 
 379             // Populate the projects repository
 380             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType());
 381             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
 382             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
 383             localRepo.push(masterHash, archive.url(), &quot;webrev&quot;, true);
 384 
 385             // Make a change with a corresponding PR with a date in the past
 386             var editFile = tempFolder.path().resolve(&quot;change.txt&quot;);
 387             Files.writeString(editFile, &quot;A simple change&quot;);
 388             localRepo.add(editFile);
 389             var commitDate = ZonedDateTime.of(2020, 3, 12, 0, 0, 0, 0, ZoneId.of(&quot;UTC&quot;));
 390             var editHash = localRepo.commit(&quot;An old change&quot;, &quot;duke&quot;, &quot;duke@openjdk.org&quot;, commitDate,
 391                              &quot;duke&quot;, &quot;duke@openjdk.org&quot;, commitDate);
 392             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
 393             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;1234: This is a pull request&quot;);
 394             pr.setBody(&quot;This is now ready&quot;);
 395             pr.addLabel(&quot;rfr&quot;);
 396 
 397             // Run an archive pass
 398             TestBotRunner.runPeriodicItems(mlBot);
 399             TestBotRunner.runPeriodicItems(mlBot);
 400 
 401             // There should be an RFR thread
 402             Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);
 403             assertTrue(archiveContains(archiveFolder.path(), &quot;Subject: RFR: 1234: This is a pull request&quot;));
 404 
 405             // Now it has been integrated
 406             var ignoredPr = ignored.pullRequest(pr.id());
 407             ignoredPr.setBody(&quot;This has been integrated&quot;);
 408             ignoredPr.addLabel(&quot;integrated&quot;);
 409             ignoredPr.addComment(&quot;Pushed as commit &quot; + editHash + &quot;.&quot;);
 410             ignoredPr.setState(Issue.State.CLOSED);
 411 
 412             // Run another archive pass
 413             TestBotRunner.runPeriodicItems(mlBot);
 414 
 415             // The archive should not contain another entry
 416             Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);
 417             assertFalse(archiveContains(archiveFolder.path(), &quot;\\[Integrated\\]&quot;));
 418             assertFalse(archiveContains(archiveFolder.path(), &quot;\\[Closed\\]&quot;));
 419         }
 420     }
 421 
 422     @Test
 423     void archiveDirectToIntegrated(TestInfo testInfo) throws IOException {
 424         try (var credentials = new HostCredentials(testInfo);
 425              var tempFolder = new TemporaryDirectory();
 426              var archiveFolder = new TemporaryDirectory();
 427              var webrevFolder = new TemporaryDirectory();
 428              var listServer = new TestMailmanServer();
 429              var webrevServer = new TestWebrevServer()) {
 430             var author = credentials.getHostedRepository();
 431             var archive = credentials.getHostedRepository();
 432             var ignored = credentials.getHostedRepository();
 433             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
 434             var censusBuilder = credentials.getCensusBuilder()
 435                                            .addAuthor(author.forge().currentUser().id());
 436             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
 437             var mlBot = MailingListBridgeBot.newBuilder()
 438                                             .from(from)
 439                                             .repo(author)
 440                                             .archive(archive)
 441                                             .censusRepo(censusBuilder.build())
 442                                             .lists(List.of(new MailingListConfiguration(listAddress, Set.of())))
 443                                             .ignoredUsers(Set.of(ignored.forge().currentUser().userName()))
 444                                             .listArchive(listServer.getArchive())
 445                                             .smtpServer(listServer.getSMTP())
<a name="5" id="anc5"></a><span class="line-modified"> 446                                             .webrevStorageHTMLRepository(archive)</span>
 447                                             .webrevStorageRef(&quot;webrev&quot;)
 448                                             .webrevStorageBase(Path.of(&quot;test&quot;))
 449                                             .webrevStorageBaseUri(webrevServer.uri())
 450                                             .issueTracker(URIBuilder.base(&quot;http://issues.test/browse/&quot;).build())
 451                                             .build();
 452 
 453             // Populate the projects repository
 454             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType());
 455             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
 456             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
 457             localRepo.push(masterHash, archive.url(), &quot;webrev&quot;, true);
 458 
 459             // Make a change with a corresponding PR
 460             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;A simple change&quot;,
 461                                                                &quot;Change msg\n\nWith several lines&quot;);
 462             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
 463             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;1234: This is a pull request&quot;);
 464             pr.setBody(&quot;This should not be ready&quot;);
 465             pr.setState(Issue.State.CLOSED);
 466 
 467             // Run an archive pass
 468             TestBotRunner.runPeriodicItems(mlBot);
 469             TestBotRunner.runPeriodicItems(mlBot);
 470 
 471             // A PR that isn&#39;t ready for review should not be archived
 472             Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);
 473             assertFalse(archiveContains(archiveFolder.path(), &quot;This is a pull request&quot;));
 474 
 475             // Now it has been integrated
 476             var ignoredPr = ignored.pullRequest(pr.id());
 477             ignoredPr.setBody(&quot;This has already been integrated&quot;);
 478             ignoredPr.addLabel(&quot;integrated&quot;);
 479             ignoredPr.addComment(&quot;Pushed as commit &quot; + editHash + &quot;.&quot;);
 480 
 481             // Run another archive pass
 482             TestBotRunner.runPeriodicItems(mlBot);
 483 
 484             // The archive should now contain an entry
 485             Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);
 486             assertTrue(archiveContains(archiveFolder.path(), &quot;Subject: Integrated: 1234: This is a pull request&quot;));
 487 
 488             var updatedHash = CheckableRepository.appendAndCommit(localRepo, &quot;Another change&quot;);
 489             localRepo.push(updatedHash, author.url(), &quot;edit&quot;);
 490 
 491             // Run another archive pass
 492             TestBotRunner.runPeriodicItems(mlBot);
 493 
 494             // The archive should now contain another entry
 495             Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);
 496             assertTrue(archiveContains(archiveFolder.path(), &quot;Subject: Re: Integrated: 1234: This is a pull request \\[v2\\]&quot;));
 497             assertFalse(archiveContains(archiveFolder.path(), &quot;Withdrawn&quot;));
 498         }
 499     }
 500 
 501     @Test
 502     void archiveIntegratedRetainPrefix(TestInfo testInfo) throws IOException {
 503         try (var credentials = new HostCredentials(testInfo);
 504              var tempFolder = new TemporaryDirectory();
 505              var archiveFolder = new TemporaryDirectory();
 506              var webrevFolder = new TemporaryDirectory();
 507              var listServer = new TestMailmanServer();
 508              var webrevServer = new TestWebrevServer()) {
 509             var author = credentials.getHostedRepository();
 510             var archive = credentials.getHostedRepository();
 511             var ignored = credentials.getHostedRepository();
 512             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
 513             var censusBuilder = credentials.getCensusBuilder()
 514                                            .addAuthor(author.forge().currentUser().id());
 515             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
 516             var mlBot = MailingListBridgeBot.newBuilder()
 517                                             .from(from)
 518                                             .repo(author)
 519                                             .archive(archive)
 520                                             .censusRepo(censusBuilder.build())
 521                                             .lists(List.of(new MailingListConfiguration(listAddress, Set.of())))
 522                                             .ignoredUsers(Set.of(ignored.forge().currentUser().userName()))
 523                                             .listArchive(listServer.getArchive())
 524                                             .smtpServer(listServer.getSMTP())
<a name="6" id="anc6"></a><span class="line-modified"> 525                                             .webrevStorageHTMLRepository(archive)</span>
 526                                             .webrevStorageRef(&quot;webrev&quot;)
 527                                             .webrevStorageBase(Path.of(&quot;test&quot;))
 528                                             .webrevStorageBaseUri(webrevServer.uri())
 529                                             .readyLabels(Set.of(&quot;rfr&quot;))
 530                                             .issueTracker(URIBuilder.base(&quot;http://issues.test/browse/&quot;).build())
 531                                             .build();
 532 
 533             // Populate the projects repository
 534             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType());
 535             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
 536             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
 537             localRepo.push(masterHash, archive.url(), &quot;webrev&quot;, true);
 538 
 539             // Make a change with a corresponding PR
 540             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;A simple change&quot;,
 541                                                                &quot;Change msg\n\nWith several lines&quot;);
 542             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
 543             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;1234: This is a pull request&quot;);
 544             pr.setBody(&quot;This should be ready&quot;);
 545 
 546             // Run an archive pass
 547             TestBotRunner.runPeriodicItems(mlBot);
 548             TestBotRunner.runPeriodicItems(mlBot);
 549 
 550             // A PR that isn&#39;t ready for review should not be archived
 551             Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);
 552             assertFalse(archiveContains(archiveFolder.path(), &quot;This is a pull request&quot;));
 553 
 554             // Flag it as ready for review
 555             pr.addLabel(&quot;rfr&quot;);
 556 
 557             // Run another archive pass
 558             TestBotRunner.runPeriodicItems(mlBot);
 559 
 560             // The archive should now contain an entry
 561             Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);
 562             assertTrue(archiveContains(archiveFolder.path(), &quot;Subject: RFR: 1234: This is a pull request&quot;));
 563 
 564             // Close it and then push another change
 565             pr.setState(Issue.State.CLOSED);
 566             var updatedHash = CheckableRepository.appendAndCommit(localRepo, &quot;Another change&quot;);
 567             localRepo.push(updatedHash, author.url(), &quot;edit&quot;);
 568 
 569             // Run another archive pass
 570             TestBotRunner.runPeriodicItems(mlBot);
 571 
 572             // The archive should now contain another entry - should retain the RFR thread prefix
 573             Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);
 574             assertTrue(archiveContains(archiveFolder.path(), &quot;Subject: Re: RFR: 1234: This is a pull request \\[v2\\]&quot;));
 575         }
 576     }
 577 
 578     @Test
 579     void archiveClosed(TestInfo testInfo) throws IOException {
 580         try (var credentials = new HostCredentials(testInfo);
 581              var tempFolder = new TemporaryDirectory();
 582              var archiveFolder = new TemporaryDirectory();
 583              var webrevFolder = new TemporaryDirectory();
 584              var listServer = new TestMailmanServer();
 585              var webrevServer = new TestWebrevServer()) {
 586             var author = credentials.getHostedRepository();
 587             var archive = credentials.getHostedRepository();
 588             var ignored = credentials.getHostedRepository();
 589             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
 590             var censusBuilder = credentials.getCensusBuilder()
 591                                            .addAuthor(author.forge().currentUser().id());
 592             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
 593             var mlBot = MailingListBridgeBot.newBuilder()
 594                                             .from(from)
 595                                             .repo(author)
 596                                             .archive(archive)
 597                                             .censusRepo(censusBuilder.build())
 598                                             .lists(List.of(new MailingListConfiguration(listAddress, Set.of())))
 599                                             .ignoredUsers(Set.of(ignored.forge().currentUser().userName()))
 600                                             .listArchive(listServer.getArchive())
 601                                             .smtpServer(listServer.getSMTP())
<a name="7" id="anc7"></a><span class="line-modified"> 602                                             .webrevStorageHTMLRepository(archive)</span>
 603                                             .webrevStorageRef(&quot;webrev&quot;)
 604                                             .webrevStorageBase(Path.of(&quot;test&quot;))
 605                                             .webrevStorageBaseUri(webrevServer.uri())
 606                                             .readyLabels(Set.of(&quot;rfr&quot;))
 607                                             .issueTracker(URIBuilder.base(&quot;http://issues.test/browse/&quot;).build())
 608                                             .build();
 609 
 610             // Populate the projects repository
 611             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType());
 612             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
 613             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
 614             localRepo.push(masterHash, archive.url(), &quot;webrev&quot;, true);
 615 
 616             // Make a change with a corresponding PR
 617             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;A simple change&quot;,
 618                                                                &quot;Change msg\n\nWith several lines&quot;);
 619             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
 620             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;1234: This is a pull request&quot;);
 621             pr.setBody(&quot;This should be ready&quot;);
 622 
 623             // Run an archive pass
 624             TestBotRunner.runPeriodicItems(mlBot);
 625             TestBotRunner.runPeriodicItems(mlBot);
 626 
 627             // A PR that isn&#39;t ready for review should not be archived
 628             Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);
 629             assertFalse(archiveContains(archiveFolder.path(), &quot;This is a pull request&quot;));
 630 
 631             // Flag it as ready for review
 632             pr.addLabel(&quot;rfr&quot;);
 633 
 634             // Run another archive pass
 635             TestBotRunner.runPeriodicItems(mlBot);
 636 
 637             // The archive should now contain an entry
 638             Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);
 639             assertTrue(archiveContains(archiveFolder.path(), &quot;Subject: RFR: 1234: This is a pull request&quot;));
 640 
 641             // Close it
 642             pr.setState(Issue.State.CLOSED);
 643 
 644             // Run another archive pass
 645             TestBotRunner.runPeriodicItems(mlBot);
 646 
 647             // The archive should now contain another entry - should say that it is closed
 648             Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);
 649             assertEquals(1, archiveContainsCount(archiveFolder.path(), &quot;Subject: Withdrawn: 1234: This is a pull request&quot;));
 650 
 651             pr.addComment(&quot;Fair enough&quot;);
 652 
 653             // Run another archive pass - only a single close notice should have been posted
 654             TestBotRunner.runPeriodicItems(mlBot);
 655             Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);
 656             assertEquals(1, archiveContainsCount(archiveFolder.path(), &quot;Subject: Withdrawn: 1234: This is a pull request&quot;));
 657             assertEquals(1, archiveContainsCount(archiveFolder.path(), &quot;Subject: Re: RFR: 1234: This is a pull request&quot;));
 658         }
 659     }
 660 
 661     @Test
 662     void archiveFailedAutoMerge(TestInfo testInfo) throws IOException {
 663         try (var credentials = new HostCredentials(testInfo);
 664              var tempFolder = new TemporaryDirectory();
 665              var archiveFolder = new TemporaryDirectory();
 666              var webrevFolder = new TemporaryDirectory();
 667              var listServer = new TestMailmanServer();
 668              var webrevServer = new TestWebrevServer()) {
 669             var author = credentials.getHostedRepository();
 670             var archive = credentials.getHostedRepository();
 671             var ignored = credentials.getHostedRepository();
 672             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
 673             var censusBuilder = credentials.getCensusBuilder()
 674                                            .addAuthor(author.forge().currentUser().id());
 675             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
 676             var mlBot = MailingListBridgeBot.newBuilder()
 677                                             .from(from)
 678                                             .repo(author)
 679                                             .archive(archive)
 680                                             .censusRepo(censusBuilder.build())
 681                                             .lists(List.of(new MailingListConfiguration(listAddress, Set.of())))
 682                                             .ignoredUsers(Set.of(ignored.forge().currentUser().userName()))
 683                                             .listArchive(listServer.getArchive())
 684                                             .smtpServer(listServer.getSMTP())
<a name="8" id="anc8"></a><span class="line-modified"> 685                                             .webrevStorageHTMLRepository(archive)</span>
 686                                             .webrevStorageRef(&quot;webrev&quot;)
 687                                             .webrevStorageBase(Path.of(&quot;test&quot;))
 688                                             .webrevStorageBaseUri(webrevServer.uri())
 689                                             .issueTracker(URIBuilder.base(&quot;http://issues.test/browse/&quot;).build())
 690                                             .build();
 691 
 692             // Populate the projects repository
 693             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType());
 694             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
 695             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
 696             localRepo.push(masterHash, archive.url(), &quot;webrev&quot;, true);
 697 
 698             // Make a change with a corresponding PR
 699             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;A simple change&quot;,
 700                                                                &quot;Change msg\n\nWith several lines&quot;);
 701             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
 702             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;Cannot automatically merge&quot;);
 703             pr.setBody(&quot;This is an automated merge PR&quot;);
 704             pr.addLabel(&quot;failed-auto-merge&quot;);
 705 
 706             // Run an archive pass
 707             TestBotRunner.runPeriodicItems(mlBot);
 708             TestBotRunner.runPeriodicItems(mlBot);
 709 
 710             // The archive should contain an entry
 711             Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);
 712             assertTrue(archiveContains(archiveFolder.path(), &quot;Subject: RFR: Cannot automatically merge&quot;));
 713         }
 714     }
 715 
 716     @Test
 717     void reviewComment(TestInfo testInfo) throws IOException {
 718         try (var credentials = new HostCredentials(testInfo);
 719              var tempFolder = new TemporaryDirectory();
 720              var archiveFolder = new TemporaryDirectory();
 721              var listServer = new TestMailmanServer();
 722              var webrevServer = new TestWebrevServer()) {
 723             var author = credentials.getHostedRepository();
 724             var archive = credentials.getHostedRepository();
 725             var ignored = credentials.getHostedRepository();
 726             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
 727             var censusBuilder = credentials.getCensusBuilder()
 728                                            .addAuthor(author.forge().currentUser().id());
 729             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
 730             var mlBot = MailingListBridgeBot.newBuilder()
 731                                             .from(from)
 732                                             .repo(author)
 733                                             .archive(archive)
 734                                             .censusRepo(censusBuilder.build())
 735                                             .lists(List.of(new MailingListConfiguration(listAddress, Set.of())))
 736                                             .ignoredUsers(Set.of(ignored.forge().currentUser().userName()))
 737                                             .listArchive(listServer.getArchive())
 738                                             .smtpServer(listServer.getSMTP())
<a name="9" id="anc9"></a><span class="line-modified"> 739                                             .webrevStorageHTMLRepository(archive)</span>
 740                                             .webrevStorageRef(&quot;webrev&quot;)
 741                                             .webrevStorageBase(Path.of(&quot;test&quot;))
 742                                             .webrevStorageBaseUri(webrevServer.uri())
 743                                             .issueTracker(URIBuilder.base(&quot;http://issues.test/browse/&quot;).build())
 744                                             .build();
 745 
 746             // Populate the projects repository
 747             var reviewFile = Path.of(&quot;reviewfile.txt&quot;);
 748             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType(), reviewFile);
 749             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
 750             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
 751             localRepo.push(masterHash, archive.url(), &quot;webrev&quot;, true);
 752 
 753             // Make a change with a corresponding PR
 754             var editHash = CheckableRepository.appendAndCommit(localRepo);
 755             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
 756             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
 757             pr.setBody(&quot;This is now ready&quot;);
 758             TestBotRunner.runPeriodicItems(mlBot);
 759             listServer.processIncoming();
 760 
 761             // And make a file specific comment
 762             var currentMaster = localRepo.resolve(&quot;master&quot;).orElseThrow();
 763             var comment = pr.addReviewComment(masterHash, editHash, reviewFile.toString(), 2, &quot;Review comment&quot;);
 764 
 765             // Add one from an ignored user as well
 766             var ignoredPr = ignored.pullRequest(pr.id());
 767             ignoredPr.addReviewComment(masterHash, editHash, reviewFile.toString(), 2, &quot;Don&#39;t mind me&quot;);
 768 
 769             // Process comments
 770             TestBotRunner.runPeriodicItems(mlBot);
 771             listServer.processIncoming();
 772 
 773             // The archive should now contain an entry
 774             Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);
 775             assertTrue(archiveContains(archiveFolder.path(), &quot;This is a pull request&quot;));
 776             assertTrue(archiveContains(archiveFolder.path(), &quot;This is now ready&quot;));
 777             assertTrue(archiveContains(archiveFolder.path(), &quot;Review comment&quot;));
 778             assertTrue(archiveContains(archiveFolder.path(), &quot;&gt; This is now ready&quot;));
 779             assertTrue(archiveContains(archiveFolder.path(), reviewFile.toString()));
 780             assertFalse(archiveContains(archiveFolder.path(), &quot;Don&#39;t mind me&quot;));
 781 
 782             // The mailing list as well
 783             var mailmanServer = MailingListServerFactory.createMailmanServer(listServer.getArchive(), listServer.getSMTP(), Duration.ZERO);
 784             var mailmanList = mailmanServer.getList(listAddress.address());
 785             var conversations = mailmanList.conversations(Duration.ofDays(1));
 786             assertEquals(1, conversations.size());
 787             var mail = conversations.get(0).first();
 788             assertEquals(&quot;RFR: This is a pull request&quot;, mail.subject());
 789 
 790             // Comment on the comment
 791             pr.addReviewCommentReply(comment, &quot;This is a review reply&quot;);
 792             TestBotRunner.runPeriodicItems(mlBot);
 793             listServer.processIncoming();
 794 
 795             // The archive should contain the additional comment (but no quoted footers)
 796             Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);
 797             assertTrue(archiveContains(archiveFolder.path(), &quot;This is a review reply&quot;));
 798             assertTrue(archiveContains(archiveFolder.path(), &quot;&gt;&gt; This is now ready&quot;));
 799             assertFalse(archiveContains(archiveFolder.path(), &quot;^&gt; PR:&quot;));
 800 
 801             // As well as the mailing list
 802             conversations = mailmanList.conversations(Duration.ofDays(1));
 803             assertEquals(1, conversations.size());
 804             assertEquals(3, conversations.get(0).allMessages().size());
 805             for (var newMail : conversations.get(0).allMessages()) {
 806                 assertEquals(noreplyAddress(archive), newMail.author().address());
 807                 assertEquals(listAddress, newMail.sender());
 808             }
 809         }
 810     }
 811 
 812     @Test
 813     void combineComments(TestInfo testInfo) throws IOException {
 814         try (var credentials = new HostCredentials(testInfo);
 815              var tempFolder = new TemporaryDirectory();
 816              var archiveFolder = new TemporaryDirectory();
 817              var listServer = new TestMailmanServer();
 818              var webrevServer = new TestWebrevServer()) {
 819             var author = credentials.getHostedRepository();
 820             var archive = credentials.getHostedRepository();
 821             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
 822             var censusBuilder = credentials.getCensusBuilder()
 823                                            .addAuthor(author.forge().currentUser().id());
 824             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
 825             var mlBot = MailingListBridgeBot.newBuilder()
 826                                             .from(from)
 827                                             .repo(author)
 828                                             .archive(archive)
 829                                             .censusRepo(censusBuilder.build())
 830                                             .lists(List.of(new MailingListConfiguration(listAddress, Set.of())))
 831                                             .listArchive(listServer.getArchive())
 832                                             .smtpServer(listServer.getSMTP())
<a name="10" id="anc10"></a><span class="line-modified"> 833                                             .webrevStorageHTMLRepository(archive)</span>
 834                                             .webrevStorageRef(&quot;webrev&quot;)
 835                                             .webrevStorageBase(Path.of(&quot;test&quot;))
 836                                             .webrevStorageBaseUri(webrevServer.uri())
 837                                             .issueTracker(URIBuilder.base(&quot;http://issues.test/browse/&quot;).build())
 838                                             .build();
 839 
 840             // Populate the projects repository
 841             var reviewFile = Path.of(&quot;reviewfile.txt&quot;);
 842             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType(), reviewFile);
 843             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
 844             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
 845             localRepo.push(masterHash, archive.url(), &quot;webrev&quot;, true);
 846 
 847             // Make a change with a corresponding PR
 848             var editHash = CheckableRepository.appendAndCommit(localRepo);
 849             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
 850             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
 851             pr.setBody(&quot;This is now ready&quot;);
 852             pr.addComment(&quot;Avoid combining&quot;);
 853 
 854             TestBotRunner.runPeriodicItems(mlBot);
 855             listServer.processIncoming();
 856             listServer.processIncoming();
 857 
 858             // Make several file specific comments
 859             var first = pr.addReviewComment(masterHash, editHash, reviewFile.toString(), 2, &quot;Review comment&quot;);
 860             var second = pr.addReviewComment(masterHash, editHash, reviewFile.toString(), 2, &quot;Another review comment&quot;);
 861             pr.addReviewComment(masterHash, editHash, reviewFile.toString(), 2, &quot;Further review comment&quot;);
 862             pr.addReviewComment(masterHash, editHash, reviewFile.toString(), 2, &quot;Final review comment&quot;);
 863             TestBotRunner.runPeriodicItems(mlBot);
 864             listServer.processIncoming();
 865 
 866             // The archive should contain a combined entry
 867             Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);
 868             assertEquals(2, archiveContainsCount(archiveFolder.path(), &quot;^On.*wrote:&quot;));
 869 
 870             // As well as the mailing list
 871             var mailmanServer = MailingListServerFactory.createMailmanServer(listServer.getArchive(), listServer.getSMTP(), Duration.ZERO);
 872             var mailmanList = mailmanServer.getList(listAddress.address());
 873             var conversations = mailmanList.conversations(Duration.ofDays(1));
 874             assertEquals(1, conversations.size());
 875             var mail = conversations.get(0).first();
 876             assertEquals(&quot;RFR: This is a pull request&quot;, mail.subject());
 877             assertEquals(3, conversations.get(0).allMessages().size());
 878 
 879             var commentReply = conversations.get(0).replies(mail).get(0);
 880             assertEquals(2, commentReply.body().split(&quot;^On.*wrote:&quot;).length);
 881             assertTrue(commentReply.body().contains(&quot;Avoid combining\n\n&quot;), commentReply.body());
 882 
 883             var reviewReply = conversations.get(0).replies(mail).get(1);
 884             assertEquals(2, reviewReply.body().split(&quot;^On.*wrote:&quot;).length);
 885             assertEquals(2, reviewReply.body().split(&quot;&gt; This is now ready&quot;).length, reviewReply.body());
 886             assertEquals(&quot;RFR: This is a pull request&quot;, reviewReply.subject());
 887             assertTrue(reviewReply.body().contains(&quot;Review comment\n\n&quot;), reviewReply.body());
 888             assertTrue(reviewReply.body().contains(&quot;Another review comment&quot;), reviewReply.body());
 889 
 890             // Now reply to the first and second (collapsed) comment
 891             pr.addReviewCommentReply(first, &quot;I agree&quot;);
 892             pr.addReviewCommentReply(second, &quot;Not with this one though&quot;);
 893             TestBotRunner.runPeriodicItems(mlBot);
 894             listServer.processIncoming();
 895 
 896             // The archive should contain a new entry
 897             Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);
 898             assertEquals(3, archiveContainsCount(archiveFolder.path(), &quot;^On.*wrote:&quot;));
 899 
 900             // The combined review comments should only appear unquoted once
 901             assertEquals(1, archiveContainsCount(archiveFolder.path(), &quot;^Another review comment&quot;));
 902         }
 903     }
 904 
 905     @Test
 906     void commentThreading(TestInfo testInfo) throws IOException {
 907         try (var credentials = new HostCredentials(testInfo);
 908              var tempFolder = new TemporaryDirectory();
 909              var archiveFolder = new TemporaryDirectory();
 910              var listServer = new TestMailmanServer();
 911              var webrevServer = new TestWebrevServer()) {
 912             var author = credentials.getHostedRepository();
 913             var reviewer = credentials.getHostedRepository();
 914             var archive = credentials.getHostedRepository();
 915             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
 916             var censusBuilder = credentials.getCensusBuilder()
 917                                            .addReviewer(reviewer.forge().currentUser().id())
 918                                            .addAuthor(author.forge().currentUser().id());
 919             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
 920             var mlBot = MailingListBridgeBot.newBuilder()
 921                                             .from(from)
 922                                             .repo(author)
 923                                             .archive(archive)
 924                                             .censusRepo(censusBuilder.build())
 925                                             .lists(List.of(new MailingListConfiguration(listAddress, Set.of())))
 926                                             .listArchive(listServer.getArchive())
 927                                             .smtpServer(listServer.getSMTP())
<a name="11" id="anc11"></a><span class="line-modified"> 928                                             .webrevStorageHTMLRepository(archive)</span>
 929                                             .webrevStorageRef(&quot;webrev&quot;)
 930                                             .webrevStorageBase(Path.of(&quot;test&quot;))
 931                                             .webrevStorageBaseUri(webrevServer.uri())
 932                                             .issueTracker(URIBuilder.base(&quot;http://issues.test/browse/&quot;).build())
 933                                             .build();
 934 
 935             // Populate the projects repository
 936             var reviewFile = Path.of(&quot;reviewfile.txt&quot;);
 937             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType(), reviewFile);
 938             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
 939             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
 940             localRepo.push(masterHash, archive.url(), &quot;webrev&quot;, true);
 941 
 942             // Make a change with a corresponding PR
 943             var editHash = CheckableRepository.appendAndCommit(localRepo);
 944             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
 945             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
 946             pr.setBody(&quot;This is now ready&quot;);
 947             TestBotRunner.runPeriodicItems(mlBot);
 948             listServer.processIncoming();
 949 
 950             // Make a file specific comment
 951             var reviewPr = reviewer.pullRequest(pr.id());
 952             var comment1 = reviewPr.addReviewComment(masterHash, editHash, reviewFile.toString(), 2, &quot;Review comment&quot;);
 953             pr.addReviewCommentReply(comment1, &quot;I agree&quot;);
 954             reviewPr.addReviewCommentReply(comment1, &quot;Great&quot;);
 955             TestBotRunner.runPeriodicItems(mlBot);
 956             listServer.processIncoming();
 957             listServer.processIncoming();
 958             listServer.processIncoming();
 959 
 960             // And a second one by ourselves
 961             var comment2 = pr.addReviewComment(masterHash, editHash, reviewFile.toString(), 2, &quot;Another review comment&quot;);
 962             reviewPr.addReviewCommentReply(comment2, &quot;Sounds good&quot;);
 963             pr.addReviewCommentReply(comment2, &quot;Thanks&quot;);
 964             TestBotRunner.runPeriodicItems(mlBot);
 965             listServer.processIncoming();
 966             listServer.processIncoming();
 967             listServer.processIncoming();
 968 
 969             // Finally some approvals and another comment
 970             pr.addReview(Review.Verdict.APPROVED, &quot;Nice&quot;);
 971             reviewPr.addReviewComment(masterHash, editHash, reviewFile.toString(), 2, &quot;The final review comment&quot;);
 972             reviewPr.addReview(Review.Verdict.APPROVED, &quot;Looks fine&quot;);
 973             reviewPr.addReviewCommentReply(comment2, &quot;You are welcome&quot;);
 974             TestBotRunner.runPeriodicItems(mlBot);
 975             listServer.processIncoming();
 976             listServer.processIncoming();
 977             listServer.processIncoming();
 978 
 979             // Sanity check the archive
 980             Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);
 981             assertEquals(9, archiveContainsCount(archiveFolder.path(), &quot;^On.*wrote:&quot;));
 982 
 983             // File specific comments should appear after the approval
 984             var archiveText = archiveContents(archiveFolder.path()).orElseThrow();
 985             assertTrue(archiveText.indexOf(&quot;Looks fine&quot;) &lt; archiveText.indexOf(&quot;The final review comment&quot;));
 986 
 987             // Check the mailing list
 988             var mailmanServer = MailingListServerFactory.createMailmanServer(listServer.getArchive(), listServer.getSMTP(), Duration.ZERO);
 989             var mailmanList = mailmanServer.getList(listAddress.address());
 990             var conversations = mailmanList.conversations(Duration.ofDays(1));
 991             assertEquals(1, conversations.size());
 992             var mail = conversations.get(0).first();
 993             assertEquals(&quot;RFR: This is a pull request&quot;, mail.subject());
 994             assertEquals(10, conversations.get(0).allMessages().size());
 995 
 996             // There should be four separate threads
 997             var thread1 = conversations.get(0).replies(mail).get(0);
 998             assertEquals(2, thread1.body().split(&quot;^On.*wrote:&quot;).length);
 999             assertEquals(2, thread1.body().split(&quot;&gt; This is now ready&quot;).length, thread1.body());
1000             assertEquals(&quot;RFR: This is a pull request&quot;, thread1.subject());
1001             assertTrue(thread1.body().contains(&quot;Review comment\n\n&quot;), thread1.body());
1002             assertFalse(thread1.body().contains(&quot;Another review comment&quot;), thread1.body());
1003             var thread1reply1 = conversations.get(0).replies(thread1).get(0);
1004             assertTrue(thread1reply1.body().contains(&quot;I agree&quot;));
1005             assertEquals(noreplyAddress(archive), thread1reply1.author().address());
1006             assertEquals(archive.forge().currentUser().fullName(), thread1reply1.author().fullName().orElseThrow());
1007             var thread1reply2 = conversations.get(0).replies(thread1reply1).get(0);
1008             assertTrue(thread1reply2.body().contains(&quot;Great&quot;));
1009             assertEquals(&quot;integrationreviewer1@openjdk.java.net&quot;, thread1reply2.author().address());
1010             assertEquals(&quot;Generated Reviewer 1&quot;, thread1reply2.author().fullName().orElseThrow());
1011 
1012             var thread2 = conversations.get(0).replies(mail).get(1);
1013             assertEquals(2, thread2.body().split(&quot;^On.*wrote:&quot;).length);
1014             assertEquals(2, thread2.body().split(&quot;&gt; This is now ready&quot;).length, thread2.body());
1015             assertEquals(&quot;RFR: This is a pull request&quot;, thread2.subject());
1016             assertFalse(thread2.body().contains(&quot;Review comment\n\n&quot;), thread2.body());
1017             assertTrue(thread2.body().contains(&quot;Another review comment&quot;), thread2.body());
1018             var thread2reply1 = conversations.get(0).replies(thread2).get(0);
1019             assertTrue(thread2reply1.body().contains(&quot;Sounds good&quot;));
1020             var thread2reply2 = conversations.get(0).replies(thread2reply1).get(0);
1021             assertTrue(thread2reply2.body().contains(&quot;Thanks&quot;));
1022 
1023             var replies = conversations.get(0).replies(mail);
1024             var thread3 = replies.get(2);
1025             assertEquals(&quot;RFR: This is a pull request&quot;, thread3.subject());
1026             var thread4 = replies.get(3);
1027             assertEquals(&quot;RFR: This is a pull request&quot;, thread4.subject());
1028             assertTrue(thread4.body().contains(&quot;Looks fine&quot;));
1029             assertTrue(thread4.body().contains(&quot;The final review comment&quot;));
1030             assertTrue(thread4.body().contains(&quot;Marked as reviewed by integrationreviewer1 (Reviewer)&quot;));
1031         }
1032     }
1033 
1034     @Test
1035     void commentThreadingSeparated(TestInfo testInfo) throws IOException {
1036         try (var credentials = new HostCredentials(testInfo);
1037              var tempFolder = new TemporaryDirectory();
1038              var archiveFolder = new TemporaryDirectory();
1039              var listServer = new TestMailmanServer();
1040              var webrevServer = new TestWebrevServer()) {
1041             var author = credentials.getHostedRepository();
1042             var reviewer = credentials.getHostedRepository();
1043             var archive = credentials.getHostedRepository();
1044             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
1045             var censusBuilder = credentials.getCensusBuilder()
1046                                            .addReviewer(reviewer.forge().currentUser().id())
1047                                            .addAuthor(author.forge().currentUser().id());
1048             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
1049             var mlBot = MailingListBridgeBot.newBuilder()
1050                                             .from(from)
1051                                             .repo(author)
1052                                             .archive(archive)
1053                                             .censusRepo(censusBuilder.build())
1054                                             .lists(List.of(new MailingListConfiguration(listAddress, Set.of())))
1055                                             .listArchive(listServer.getArchive())
1056                                             .smtpServer(listServer.getSMTP())
<a name="12" id="anc12"></a><span class="line-modified">1057                                             .webrevStorageHTMLRepository(archive)</span>
1058                                             .webrevStorageRef(&quot;webrev&quot;)
1059                                             .webrevStorageBase(Path.of(&quot;test&quot;))
1060                                             .webrevStorageBaseUri(webrevServer.uri())
1061                                             .issueTracker(URIBuilder.base(&quot;http://issues.test/browse/&quot;).build())
1062                                             .build();
1063 
1064             // Populate the projects repository
1065             var reviewFile = Path.of(&quot;reviewfile.txt&quot;);
1066             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType(), reviewFile);
1067             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
1068             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
1069             localRepo.push(masterHash, archive.url(), &quot;webrev&quot;, true);
1070 
1071             // Make a change with a corresponding PR
1072             var editHash = CheckableRepository.appendAndCommit(localRepo);
1073             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
1074             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
1075             pr.setBody(&quot;This is now ready&quot;);
1076             TestBotRunner.runPeriodicItems(mlBot);
1077             listServer.processIncoming();
1078 
1079             // Make two file specific comments
1080             var reviewPr = reviewer.pullRequest(pr.id());
1081             var comment1 = reviewPr.addReviewComment(masterHash, editHash, reviewFile.toString(), 2, &quot;Review comment&quot;);
1082             var comment2 = reviewPr.addReviewComment(masterHash, editHash, reviewFile.toString(), 2, &quot;Another review comment&quot;);
1083             TestBotRunner.runPeriodicItems(mlBot);
1084             listServer.processIncoming();
1085 
1086             pr.addReviewCommentReply(comment1, &quot;I agree&quot;);
1087             pr.addReviewCommentReply(comment2, &quot;I don&#39;t agree&quot;);
1088             TestBotRunner.runPeriodicItems(mlBot);
1089             listServer.processIncoming();
1090 
1091             // Sanity check the archive
1092             Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);
1093             assertEquals(2, archiveContainsCount(archiveFolder.path(), &quot;^On.*wrote:&quot;));
1094         }
1095     }
1096 
1097     @Test
1098     void commentWithMention(TestInfo testInfo) throws IOException {
1099         try (var credentials = new HostCredentials(testInfo);
1100              var tempFolder = new TemporaryDirectory();
1101              var archiveFolder = new TemporaryDirectory();
1102              var listServer = new TestMailmanServer();
1103              var webrevServer = new TestWebrevServer()) {
1104             var author = credentials.getHostedRepository();
1105             var reviewer = credentials.getHostedRepository();
1106             var archive = credentials.getHostedRepository();
1107             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
1108             var censusBuilder = credentials.getCensusBuilder()
1109                                            .addReviewer(reviewer.forge().currentUser().id())
1110                                            .addAuthor(author.forge().currentUser().id());
1111             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
1112             var mlBot = MailingListBridgeBot.newBuilder()
1113                                             .from(from)
1114                                             .repo(author)
1115                                             .archive(archive)
1116                                             .censusRepo(censusBuilder.build())
1117                                             .lists(List.of(new MailingListConfiguration(listAddress, Set.of())))
1118                                             .listArchive(listServer.getArchive())
1119                                             .smtpServer(listServer.getSMTP())
<a name="13" id="anc13"></a><span class="line-modified">1120                                             .webrevStorageHTMLRepository(archive)</span>
1121                                             .webrevStorageRef(&quot;webrev&quot;)
1122                                             .webrevStorageBase(Path.of(&quot;test&quot;))
1123                                             .webrevStorageBaseUri(webrevServer.uri())
1124                                             .issueTracker(URIBuilder.base(&quot;http://issues.test/browse/&quot;).build())
1125                                             .build();
1126 
1127             // Populate the projects repository
1128             var reviewFile = Path.of(&quot;reviewfile.txt&quot;);
1129             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType(), reviewFile);
1130             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
1131             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
1132             localRepo.push(masterHash, archive.url(), &quot;webrev&quot;, true);
1133 
1134             // Make a change with a corresponding PR
1135             var editHash = CheckableRepository.appendAndCommit(localRepo);
1136             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
1137             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
1138             pr.setBody(&quot;This is now ready&quot;);
1139             TestBotRunner.runPeriodicItems(mlBot);
1140             listServer.processIncoming();
1141 
1142             // Make two comments from different authors
1143             var reviewPr = reviewer.pullRequest(pr.id());
1144             reviewPr.addComment(&quot;First comment&quot;);
1145             pr.addComment(&quot;Second comment&quot;);
1146 
1147             TestBotRunner.runPeriodicItems(mlBot);
1148             listServer.processIncoming();
1149 
1150             pr.addComment(&quot;@&quot; + reviewer.forge().currentUser().userName() + &quot; reply to first&quot;);
1151             TestBotRunner.runPeriodicItems(mlBot);
1152             listServer.processIncoming();
1153 
1154             // The first comment should be quoted more often than the second
1155             Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);
1156             assertEquals(3, archiveContainsCount(archiveFolder.path(), &quot;First comment&quot;));
1157             assertEquals(1, archiveContainsCount(archiveFolder.path(), &quot;Second comment&quot;));
1158         }
1159     }
1160 
1161     @Test
1162     void reviewCommentWithMention(TestInfo testInfo) throws IOException {
1163         try (var credentials = new HostCredentials(testInfo);
1164              var tempFolder = new TemporaryDirectory();
1165              var archiveFolder = new TemporaryDirectory();
1166              var listServer = new TestMailmanServer();
1167              var webrevServer = new TestWebrevServer()) {
1168             var author = credentials.getHostedRepository();
1169             var reviewer = credentials.getHostedRepository();
1170             var archive = credentials.getHostedRepository();
1171             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
1172             var censusBuilder = credentials.getCensusBuilder()
1173                                            .addReviewer(reviewer.forge().currentUser().id())
1174                                            .addAuthor(author.forge().currentUser().id());
1175             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
1176             var mlBot = MailingListBridgeBot.newBuilder()
1177                                             .from(from)
1178                                             .repo(author)
1179                                             .archive(archive)
1180                                             .censusRepo(censusBuilder.build())
1181                                             .lists(List.of(new MailingListConfiguration(listAddress, Set.of())))
1182                                             .listArchive(listServer.getArchive())
1183                                             .smtpServer(listServer.getSMTP())
<a name="14" id="anc14"></a><span class="line-modified">1184                                             .webrevStorageHTMLRepository(archive)</span>
1185                                             .webrevStorageRef(&quot;webrev&quot;)
1186                                             .webrevStorageBase(Path.of(&quot;test&quot;))
1187                                             .webrevStorageBaseUri(webrevServer.uri())
1188                                             .issueTracker(URIBuilder.base(&quot;http://issues.test/browse/&quot;).build())
1189                                             .build();
1190 
1191             // Populate the projects repository
1192             var reviewFile = Path.of(&quot;reviewfile.txt&quot;);
1193             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType(), reviewFile);
1194             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
1195             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
1196             localRepo.push(masterHash, archive.url(), &quot;webrev&quot;, true);
1197 
1198             // Make a change with a corresponding PR
1199             var editHash = CheckableRepository.appendAndCommit(localRepo);
1200             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
1201             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
1202             pr.setBody(&quot;This is now ready&quot;);
1203             TestBotRunner.runPeriodicItems(mlBot);
1204             listServer.processIncoming();
1205 
1206             // Make two review comments from different authors
1207             var reviewPr = reviewer.pullRequest(pr.id());
1208             var comment = reviewPr.addReviewComment(masterHash, editHash, reviewFile.toString(), 2, &quot;Review comment&quot;);
1209             reviewPr.addReviewCommentReply(comment, &quot;First review comment&quot;);
1210             pr.addReviewCommentReply(comment, &quot;Second review comment&quot;);
1211 
1212             TestBotRunner.runPeriodicItems(mlBot);
1213             listServer.processIncoming();
1214 
1215             pr.addReviewCommentReply(comment, &quot;@&quot; + reviewer.forge().currentUser().userName() + &quot; reply to first&quot;);
1216             TestBotRunner.runPeriodicItems(mlBot);
1217             listServer.processIncoming();
1218 
1219             // The first comment should be quoted more often than the second
1220             Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);
1221             assertEquals(3, archiveContainsCount(archiveFolder.path(), &quot;First review comment&quot;));
1222             assertEquals(1, archiveContainsCount(archiveFolder.path(), &quot;Second review comment&quot;));
1223         }
1224     }
1225 
1226     @Test
1227     void commentWithQuote(TestInfo testInfo) throws IOException {
1228         try (var credentials = new HostCredentials(testInfo);
1229              var tempFolder = new TemporaryDirectory();
1230              var archiveFolder = new TemporaryDirectory();
1231              var listServer = new TestMailmanServer();
1232              var webrevServer = new TestWebrevServer()) {
1233             var author = credentials.getHostedRepository();
1234             var reviewer = credentials.getHostedRepository();
1235             var archive = credentials.getHostedRepository();
1236             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
1237             var censusBuilder = credentials.getCensusBuilder()
1238                                            .addReviewer(reviewer.forge().currentUser().id())
1239                                            .addAuthor(author.forge().currentUser().id());
1240             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
1241             var mlBot = MailingListBridgeBot.newBuilder()
1242                                             .from(from)
1243                                             .repo(author)
1244                                             .archive(archive)
1245                                             .censusRepo(censusBuilder.build())
1246                                             .lists(List.of(new MailingListConfiguration(listAddress, Set.of())))
1247                                             .listArchive(listServer.getArchive())
1248                                             .smtpServer(listServer.getSMTP())
<a name="15" id="anc15"></a><span class="line-modified">1249                                             .webrevStorageHTMLRepository(archive)</span>
1250                                             .webrevStorageRef(&quot;webrev&quot;)
1251                                             .webrevStorageBase(Path.of(&quot;test&quot;))
1252                                             .webrevStorageBaseUri(webrevServer.uri())
1253                                             .issueTracker(URIBuilder.base(&quot;http://issues.test/browse/&quot;).build())
1254                                             .build();
1255 
1256             // Populate the projects repository
1257             var reviewFile = Path.of(&quot;reviewfile.txt&quot;);
1258             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType(), reviewFile);
1259             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
1260             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
1261             localRepo.push(masterHash, archive.url(), &quot;webrev&quot;, true);
1262 
1263             // Make a change with a corresponding PR
1264             var editHash = CheckableRepository.appendAndCommit(localRepo);
1265             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
1266             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
1267             pr.setBody(&quot;This is now ready&quot;);
1268             TestBotRunner.runPeriodicItems(mlBot);
1269             listServer.processIncoming();
1270 
1271             // Make two comments from different authors
1272             var reviewPr = reviewer.pullRequest(pr.id());
1273             reviewPr.addComment(&quot;First comment\nsecond line&quot;);
1274             pr.addComment(&quot;Second comment\nfourth line&quot;);
1275 
1276             TestBotRunner.runPeriodicItems(mlBot);
1277             listServer.processIncoming();
1278 
1279             pr.addComment(&quot;&gt;First comm\n\nreply to first&quot;);
1280             TestBotRunner.runPeriodicItems(mlBot);
1281             listServer.processIncoming();
1282 
1283             // The first comment should be quoted more often than the second
1284             Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);
1285             assertEquals(2, archiveContainsCount(archiveFolder.path(), &quot;First comment&quot;));
1286             assertEquals(3, archiveContainsCount(archiveFolder.path(), &quot;First comm&quot;));
1287             assertEquals(1, archiveContainsCount(archiveFolder.path(), &quot;Second comment&quot;));
1288         }
1289     }
1290 
1291     @Test
1292     void reviewContext(TestInfo testInfo) throws IOException {
1293         try (var credentials = new HostCredentials(testInfo);
1294              var tempFolder = new TemporaryDirectory();
1295              var archiveFolder = new TemporaryDirectory();
1296              var listServer = new TestMailmanServer();
1297              var webrevServer = new TestWebrevServer()) {
1298             var author = credentials.getHostedRepository();
1299             var archive = credentials.getHostedRepository();
1300             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
1301             var censusBuilder = credentials.getCensusBuilder()
1302                                            .addAuthor(author.forge().currentUser().id());
1303             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
1304             var mlBot = MailingListBridgeBot.newBuilder()
1305                                             .from(from)
1306                                             .repo(author)
1307                                             .archive(archive)
1308                                             .censusRepo(censusBuilder.build())
1309                                             .lists(List.of(new MailingListConfiguration(listAddress, Set.of())))
1310                                             .listArchive(listServer.getArchive())
1311                                             .smtpServer(listServer.getSMTP())
<a name="16" id="anc16"></a><span class="line-modified">1312                                             .webrevStorageHTMLRepository(archive)</span>
1313                                             .webrevStorageRef(&quot;webrev&quot;)
1314                                             .webrevStorageBase(Path.of(&quot;test&quot;))
1315                                             .webrevStorageBaseUri(webrevServer.uri())
1316                                             .issueTracker(URIBuilder.base(&quot;http://issues.test/browse/&quot;).build())
1317                                             .build();
1318 
1319             // Populate the projects repository
1320             var reviewFile = Path.of(&quot;reviewfile.txt&quot;);
1321             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType(), reviewFile);
1322             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
1323             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
1324             localRepo.push(masterHash, archive.url(), &quot;webrev&quot;, true);
1325 
1326             // Make a change with a corresponding PR
1327             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;Line 1\nLine 2\nLine 3\nLine 4&quot;);
1328             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
1329             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
1330             pr.setBody(&quot;This is now ready&quot;);
1331             TestBotRunner.runPeriodicItems(mlBot);
1332             listServer.processIncoming();
1333 
1334             // Make a file specific comment
1335             pr.addReviewComment(masterHash, editHash, reviewFile.toString(), 2, &quot;Review comment&quot;);
1336 
1337             TestBotRunner.runPeriodicItems(mlBot);
1338             listServer.processIncoming();
1339 
1340             // The archive should only contain context around line 2
1341             Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);
1342             assertTrue(archiveContains(archiveFolder.path(), &quot;^&gt; 2: Line 1$&quot;));
1343             assertTrue(archiveContains(archiveFolder.path(), &quot;^&gt; 3: Line 2$&quot;));
1344             assertFalse(archiveContains(archiveFolder.path(), &quot;^&gt; 4: Line 3$&quot;));
1345         }
1346     }
1347 
1348     @Test
1349     void multipleReviewContexts(TestInfo testInfo) throws IOException {
1350         try (var credentials = new HostCredentials(testInfo);
1351              var tempFolder = new TemporaryDirectory();
1352              var archiveFolder = new TemporaryDirectory();
1353              var listServer = new TestMailmanServer();
1354              var webrevServer = new TestWebrevServer()) {
1355             var author = credentials.getHostedRepository();
1356             var archive = credentials.getHostedRepository();
1357             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
1358             var censusBuilder = credentials.getCensusBuilder()
1359                                            .addAuthor(author.forge().currentUser().id());
1360             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
1361             var mlBot = MailingListBridgeBot.newBuilder()
1362                                             .from(from)
1363                                             .repo(author)
1364                                             .archive(archive)
1365                                             .censusRepo(censusBuilder.build())
1366                                             .lists(List.of(new MailingListConfiguration(listAddress, Set.of())))
1367                                             .listArchive(listServer.getArchive())
1368                                             .smtpServer(listServer.getSMTP())
<a name="17" id="anc17"></a><span class="line-modified">1369                                             .webrevStorageHTMLRepository(archive)</span>
1370                                             .webrevStorageRef(&quot;webrev&quot;)
1371                                             .webrevStorageBase(Path.of(&quot;test&quot;))
1372                                             .webrevStorageBaseUri(webrevServer.uri())
1373                                             .issueTracker(URIBuilder.base(&quot;http://issues.test/browse/&quot;).build())
1374                                             .build();
1375 
1376             // Populate the projects repository
1377             var reviewFile = Path.of(&quot;reviewfile.txt&quot;);
1378             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType(), reviewFile);
1379             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
1380             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
1381             localRepo.push(masterHash, archive.url(), &quot;webrev&quot;, true);
1382             var initialHash = CheckableRepository.appendAndCommit(localRepo,
1383                                                                   &quot;Line 0.1\nLine 0.2\nLine 0.3\nLine 0.4\n&quot; +
1384                                                                           &quot;Line 1\nLine 2\nLine 3\nLine 4\n&quot; +
1385                                                                           &quot;Line 5\nLine 6\nLine 7\nLine 8\n&quot; +
1386                                                                           &quot;Line 8.1\nLine 8.2\nLine 8.3\nLine 8.4\n&quot; +
1387                                                                           &quot;Line 9\nLine 10\nLine 11\nLine 12\n&quot; +
1388                                                                           &quot;Line 13\nLine 14\nLine 15\nLine 16\n&quot;);
1389             localRepo.push(initialHash, author.url(), &quot;master&quot;);
1390 
1391             // Make a change with a corresponding PR
1392             var current = Files.readString(localRepo.root().resolve(reviewFile), StandardCharsets.UTF_8);
1393             var updated = current.replaceAll(&quot;Line 2&quot;, &quot;Line 2 edit\nLine 2.5&quot;);
1394             updated = updated.replaceAll(&quot;Line 13&quot;, &quot;Line 12.5\nLine 13 edit&quot;);
1395             Files.writeString(localRepo.root().resolve(reviewFile), updated, StandardCharsets.UTF_8);
1396             var editHash = CheckableRepository.appendAndCommit(localRepo);
1397             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
1398             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
1399             pr.setBody(&quot;This is now ready&quot;);
1400             TestBotRunner.runPeriodicItems(mlBot);
1401             listServer.processIncoming();
1402 
1403             // Make file specific comments
1404             pr.addReviewComment(masterHash, editHash, reviewFile.toString(), 7, &quot;Review comment&quot;);
1405             pr.addReviewComment(masterHash, editHash, reviewFile.toString(), 24, &quot;Another review comment&quot;);
1406 
1407             TestBotRunner.runPeriodicItems(mlBot);
1408             listServer.processIncoming();
1409 
1410             // The archive should only contain context around line 2 and 20
1411             Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);
1412             assertTrue(archiveContains(archiveFolder.path(), &quot;reviewfile.txt line 7&quot;));
1413             assertTrue(archiveContains(archiveFolder.path(), &quot;^&gt; 6: Line 1$&quot;));
1414             assertTrue(archiveContains(archiveFolder.path(), &quot;^&gt; 7: Line 2 edit$&quot;));
1415             assertFalse(archiveContains(archiveFolder.path(), &quot;Line 3&quot;));
1416 
1417             assertTrue(archiveContains(archiveFolder.path(), &quot;reviewfile.txt line 24&quot;));
1418             assertTrue(archiveContains(archiveFolder.path(), &quot;^&gt; 23: Line 12.5$&quot;));
1419             assertTrue(archiveContains(archiveFolder.path(), &quot;^&gt; 24: Line 13 edit$&quot;));
1420             assertFalse(archiveContains(archiveFolder.path(), &quot;^Line 15&quot;));
1421         }
1422     }
1423 
1424     @Test
1425     void filterComments(TestInfo testInfo) throws IOException {
1426         try (var credentials = new HostCredentials(testInfo);
1427              var tempFolder = new TemporaryDirectory();
1428              var archiveFolder = new TemporaryDirectory();
1429              var listServer = new TestMailmanServer();
1430              var webrevServer = new TestWebrevServer()) {
1431             var author = credentials.getHostedRepository();
1432             var archive = credentials.getHostedRepository();
1433             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
1434             var censusBuilder = credentials.getCensusBuilder()
1435                                            .addAuthor(author.forge().currentUser().id());
1436             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
1437             var mlBot = MailingListBridgeBot.newBuilder()
1438                                             .from(from)
1439                                             .repo(author)
1440                                             .archive(archive)
1441                                             .censusRepo(censusBuilder.build())
1442                                             .lists(List.of(new MailingListConfiguration(listAddress, Set.of())))
1443                                             .listArchive(listServer.getArchive())
1444                                             .smtpServer(listServer.getSMTP())
<a name="18" id="anc18"></a><span class="line-modified">1445                                             .webrevStorageHTMLRepository(archive)</span>
1446                                             .webrevStorageRef(&quot;webrev&quot;)
1447                                             .webrevStorageBase(Path.of(&quot;test&quot;))
1448                                             .webrevStorageBaseUri(webrevServer.uri())
1449                                             .issueTracker(URIBuilder.base(&quot;http://issues.test/browse/&quot;).build())
1450                                             .build();
1451 
1452             // Populate the projects repository
1453             var reviewFile = Path.of(&quot;reviewfile.txt&quot;);
1454             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType(), reviewFile);
1455             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
1456             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
1457             localRepo.push(masterHash, archive.url(), &quot;webrev&quot;, true);
1458 
1459             // Make a change with a corresponding PR
1460             var editHash = CheckableRepository.appendAndCommit(localRepo);
1461             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
1462             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
1463             pr.setBody(&quot;This is now ready\n&lt;!-- this is a comment --&gt;\nAnd this is not\n&quot; +
1464                                &quot;&lt;!-- Anything below this marker will be hidden --&gt;\nStatus stuff&quot;);
1465 
1466             // Make a bunch of comments
1467             pr.addComment(&quot;Plain comment\n&lt;!-- this is a comment --&gt;&quot;);
1468             pr.addReviewComment(masterHash, editHash, reviewFile.toString(), 2, &quot;Review comment &lt;!-- this is a comment --&gt;\n&quot;);
1469             pr.addComment(&quot;/integrate stuff&quot;);
1470             TestBotRunner.runPeriodicItems(mlBot);
1471 
1472             // Run an archive pass
1473             TestBotRunner.runPeriodicItems(mlBot);
1474 
1475             // The archive should not contain the comment
1476             Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);
1477             assertTrue(archiveContains(archiveFolder.path(), &quot;This is now ready&quot;));
1478             assertFalse(archiveContains(archiveFolder.path(), &quot;this is a comment&quot;));
1479             assertFalse(archiveContains(archiveFolder.path(), &quot;Status stuff&quot;));
1480             assertTrue(archiveContains(archiveFolder.path(), &quot;And this is not&quot;));
1481             assertFalse(archiveContains(archiveFolder.path(), &quot;&lt;!--&quot;));
1482             assertFalse(archiveContains(archiveFolder.path(), &quot;--&gt;&quot;));
1483             assertTrue(archiveContains(archiveFolder.path(), &quot;Plain comment&quot;));
1484             assertTrue(archiveContains(archiveFolder.path(), &quot;Review comment&quot;));
1485             assertFalse(archiveContains(archiveFolder.path(), &quot;/integrate&quot;));
1486         }
1487     }
1488 
1489     @Test
1490     void incrementalChanges(TestInfo testInfo) throws IOException {
1491         try (var credentials = new HostCredentials(testInfo);
1492              var tempFolder = new TemporaryDirectory();
1493              var archiveFolder = new TemporaryDirectory();
1494              var listServer = new TestMailmanServer();
1495              var webrevServer = new TestWebrevServer()) {
1496             var author = credentials.getHostedRepository();
1497             var archive = credentials.getHostedRepository();
1498             var commenter = credentials.getHostedRepository();
1499             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
1500             var censusBuilder = credentials.getCensusBuilder()
1501                                            .addAuthor(author.forge().currentUser().id());
1502             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
1503             var mlBot = MailingListBridgeBot.newBuilder()
1504                                             .from(from)
1505                                             .repo(author)
1506                                             .archive(archive)
1507                                             .censusRepo(censusBuilder.build())
1508                                             .lists(List.of(new MailingListConfiguration(listAddress, Set.of())))
1509                                             .listArchive(listServer.getArchive())
1510                                             .smtpServer(listServer.getSMTP())
<a name="19" id="anc19"></a><span class="line-modified">1511                                             .webrevStorageHTMLRepository(archive)</span>
1512                                             .webrevStorageRef(&quot;webrev&quot;)
1513                                             .webrevStorageBase(Path.of(&quot;test&quot;))
1514                                             .webrevStorageBaseUri(webrevServer.uri())
1515                                             .issueTracker(URIBuilder.base(&quot;http://issues.test/browse/&quot;).build())
1516                                             .build();
1517 
1518             // Populate the projects repository
1519             var reviewFile = Path.of(&quot;reviewfile.txt&quot;);
1520             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType(), reviewFile);
1521             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
1522             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
1523             localRepo.push(masterHash, archive.url(), &quot;webrev&quot;, true);
1524 
1525             // Make a change with a corresponding PR
1526             var editHash = CheckableRepository.appendAndCommit(localRepo);
1527             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
1528             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
1529             pr.setBody(&quot;This is now ready&quot;);
1530 
1531             // Run an archive pass
1532             TestBotRunner.runPeriodicItems(mlBot);
1533             listServer.processIncoming();
1534 
1535             var nextHash = CheckableRepository.appendAndCommit(localRepo, &quot;Yet one more line&quot;, &quot;Fixing&quot;);
1536             localRepo.push(nextHash, author.url(), &quot;edit&quot;);
1537 
1538             // Make sure that the push registered
1539             var lastHeadHash = pr.headHash();
1540             var refreshCount = 0;
1541             do {
1542                 pr = author.pullRequest(pr.id());
1543                 if (refreshCount++ &gt; 100) {
1544                     fail(&quot;The PR did not update after the new push&quot;);
1545                 }
1546             } while (pr.headHash().equals(lastHeadHash));
1547 
1548             // Run another archive pass
1549             TestBotRunner.runPeriodicItems(mlBot);
1550             TestBotRunner.runPeriodicItems(mlBot);
1551             TestBotRunner.runPeriodicItems(mlBot);
1552             listServer.processIncoming();
1553 
1554             // The archive should reference the updated push
1555             Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);
1556             assertTrue(archiveContains(archiveFolder.path(), &quot;has updated the pull request incrementally&quot;));
1557             assertTrue(archiveContains(archiveFolder.path(), &quot;full.*/&quot; + pr.id() + &quot;/01&quot;));
1558             assertTrue(archiveContains(archiveFolder.path(), &quot;inc.*/&quot; + pr.id() + &quot;/00-01&quot;));
1559             assertTrue(archiveContains(archiveFolder.path(), &quot;Patch&quot;));
1560             assertTrue(archiveContains(archiveFolder.path(), &quot;Fetch&quot;));
1561             assertTrue(archiveContains(archiveFolder.path(), &quot;Fixing&quot;));
1562 
1563             // The webrev comment should be updated
1564             var comments = pr.comments();
1565             var webrevComments = comments.stream()
1566                                          .filter(comment -&gt; comment.author().equals(author.forge().currentUser()))
1567                                          .filter(comment -&gt; comment.body().contains(&quot;webrev&quot;))
1568                                          .filter(comment -&gt; comment.body().contains(&quot;Full&quot;))
1569                                          .filter(comment -&gt; comment.body().contains(&quot;Incremental&quot;))
1570                                          .filter(comment -&gt; comment.body().contains(nextHash.hex()))
1571                                          .filter(comment -&gt; comment.body().contains(editHash.hex()))
1572                                          .collect(Collectors.toList());
1573             assertEquals(1, webrevComments.size());
1574 
1575             // Check that sender address is set properly
1576             var mailmanServer = MailingListServerFactory.createMailmanServer(listServer.getArchive(), listServer.getSMTP(), Duration.ZERO);
1577             var mailmanList = mailmanServer.getList(listAddress.address());
1578             var conversations = mailmanList.conversations(Duration.ofDays(1));
1579             assertEquals(1, conversations.size());
1580             for (var newMail : conversations.get(0).allMessages()) {
1581                 assertEquals(noreplyAddress(archive), newMail.author().address());
1582                 assertEquals(listAddress, newMail.sender());
1583             }
1584 
1585             // Add a comment
1586             var commenterPr = commenter.pullRequest(pr.id());
1587             commenterPr.addReviewComment(masterHash, nextHash, reviewFile.toString(), 2, &quot;Review comment&quot;);
1588             TestBotRunner.runPeriodicItems(mlBot);
1589             listServer.processIncoming();
1590 
1591             // Ensure that additional updates are only reported once
1592             for (int i = 0; i &lt; 3; ++i) {
1593                 var anotherHash = CheckableRepository.appendAndCommit(localRepo, &quot;Another line&quot;, &quot;Fixing&quot;);
1594                 localRepo.push(anotherHash, author.url(), &quot;edit&quot;);
1595 
1596                 // Make sure that the push registered
1597                 lastHeadHash = pr.headHash();
1598                 refreshCount = 0;
1599                 do {
1600                     pr = author.pullRequest(pr.id());
1601                     if (refreshCount++ &gt; 100) {
1602                         fail(&quot;The PR did not update after the new push&quot;);
1603                     }
1604                 } while (pr.headHash().equals(lastHeadHash));
1605 
1606                 TestBotRunner.runPeriodicItems(mlBot);
1607                 TestBotRunner.runPeriodicItems(mlBot);
1608                 listServer.processIncoming();
1609             }
1610             var updatedConversations = mailmanList.conversations(Duration.ofDays(1));
1611             assertEquals(1, updatedConversations.size());
1612             var conversation = updatedConversations.get(0);
1613             assertEquals(6, conversation.allMessages().size());
1614             assertEquals(&quot;RFR: This is a pull request [v2]&quot;, conversation.allMessages().get(1).subject());
1615             assertEquals(&quot;RFR: This is a pull request [v2]&quot;, conversation.allMessages().get(2).subject(), conversation.allMessages().get(2).toString());
1616             assertEquals(&quot;RFR: This is a pull request [v5]&quot;, conversation.allMessages().get(5).subject());
1617         }
1618     }
1619 
1620     @Test
1621     void rebased(TestInfo testInfo) throws IOException {
1622         try (var credentials = new HostCredentials(testInfo);
1623              var tempFolder = new TemporaryDirectory();
1624              var archiveFolder = new TemporaryDirectory();
1625              var listServer = new TestMailmanServer();
1626              var webrevServer = new TestWebrevServer()) {
1627             var author = credentials.getHostedRepository();
1628             var archive = credentials.getHostedRepository();
1629             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
1630             var censusBuilder = credentials.getCensusBuilder()
1631                                            .addAuthor(author.forge().currentUser().id());
1632             var sender = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
1633             var mlBot = MailingListBridgeBot.newBuilder()
1634                                             .from(sender)
1635                                             .repo(author)
1636                                             .archive(archive)
1637                                             .censusRepo(censusBuilder.build())
1638                                             .lists(List.of(new MailingListConfiguration(listAddress, Set.of())))
1639                                             .listArchive(listServer.getArchive())
1640                                             .smtpServer(listServer.getSMTP())
<a name="20" id="anc20"></a><span class="line-modified">1641                                             .webrevStorageHTMLRepository(archive)</span>
1642                                             .webrevStorageRef(&quot;webrev&quot;)
1643                                             .webrevStorageBase(Path.of(&quot;test&quot;))
1644                                             .webrevStorageBaseUri(webrevServer.uri())
1645                                             .issueTracker(URIBuilder.base(&quot;http://issues.test/browse/&quot;).build())
1646                                             .build();
1647 
1648             // Populate the projects repository
1649             var reviewFile = Path.of(&quot;reviewfile.txt&quot;);
1650             var localRepo = CheckableRepository.init(tempFolder.path().resolve(&quot;first&quot;), author.repositoryType(), reviewFile);
1651             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
1652             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
1653             localRepo.push(masterHash, archive.url(), &quot;webrev&quot;, true);
1654 
1655             // Make a change with a corresponding PR
1656             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;A line&quot;, &quot;Original msg&quot;);
1657             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
1658             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
1659             pr.setBody(&quot;This is now ready&quot;);
1660 
1661             // Run an archive pass
1662             TestBotRunner.runPeriodicItems(mlBot);
1663             listServer.processIncoming();
1664 
1665             var newLocalRepo = Repository.materialize(tempFolder.path().resolve(&quot;second&quot;), author.url(), &quot;master&quot;);
1666             var newEditHash = CheckableRepository.appendAndCommit(newLocalRepo, &quot;Another line&quot;, &quot;Replaced msg&quot;);
1667             newLocalRepo.push(newEditHash, author.url(), &quot;edit&quot;, true);
1668 
1669             // Make sure that the push registered
1670             var lastHeadHash = pr.headHash();
1671             var refreshCount = 0;
1672             do {
1673                 pr = author.pullRequest(pr.id());
1674                 if (refreshCount++ &gt; 100) {
1675                     fail(&quot;The PR did not update after the new push&quot;);
1676                 }
1677             } while (pr.headHash().equals(lastHeadHash));
1678 
1679             // Run another archive pass
1680             TestBotRunner.runPeriodicItems(mlBot);
1681             listServer.processIncoming();
1682 
1683             // The archive should reference the rebased push
1684             Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);
1685             assertTrue(archiveContains(archiveFolder.path(), &quot;has updated the pull request with a new target base&quot;));
1686             assertTrue(archiveContains(archiveFolder.path(), pr.id() + &quot;/01&quot;));
1687             assertFalse(archiveContains(archiveFolder.path(), &quot;Incremental&quot;));
1688             assertTrue(archiveContains(archiveFolder.path(), &quot;Patch&quot;));
1689             assertTrue(archiveContains(archiveFolder.path(), &quot;Fetch&quot;));
1690             assertTrue(archiveContains(archiveFolder.path(), &quot;Original msg&quot;));
1691             assertTrue(archiveContains(archiveFolder.path(), &quot;Replaced msg&quot;));
1692 
1693             // The webrev comment should be updated
1694             var comments = pr.comments();
1695             var webrevComments = comments.stream()
1696                                          .filter(comment -&gt; comment.author().equals(author.forge().currentUser()))
1697                                          .filter(comment -&gt; comment.body().contains(&quot;webrev&quot;))
1698                                          .filter(comment -&gt; comment.body().contains(newEditHash.hex()))
1699                                          .collect(Collectors.toList());
1700             assertEquals(1, webrevComments.size());
1701 
1702             // Check that sender address is set properly
1703             var mailmanServer = MailingListServerFactory.createMailmanServer(listServer.getArchive(), listServer.getSMTP(), Duration.ZERO);
1704             var mailmanList = mailmanServer.getList(listAddress.address());
1705             var conversations = mailmanList.conversations(Duration.ofDays(1));
1706             assertEquals(1, conversations.size());
1707             for (var newMail : conversations.get(0).allMessages()) {
1708                 assertEquals(noreplyAddress(archive), newMail.author().address());
1709                 assertEquals(listAddress, newMail.sender());
1710                 assertFalse(newMail.hasHeader(&quot;PR-Head-Hash&quot;));
1711             }
1712             assertEquals(&quot;RFR: This is a pull request [v2]&quot;, conversations.get(0).allMessages().get(1).subject());
1713         }
1714     }
1715 
1716     @Test
1717     void incrementalAfterRebase(TestInfo testInfo) throws IOException {
1718         try (var credentials = new HostCredentials(testInfo);
1719              var tempFolder = new TemporaryDirectory();
1720              var archiveFolder = new TemporaryDirectory();
1721              var listServer = new TestMailmanServer();
1722              var webrevServer = new TestWebrevServer()) {
1723             var author = credentials.getHostedRepository();
1724             var archive = credentials.getHostedRepository();
1725             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
1726             var censusBuilder = credentials.getCensusBuilder()
1727                                            .addAuthor(author.forge().currentUser().id());
1728             var sender = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
1729             var mlBot = MailingListBridgeBot.newBuilder()
1730                                             .from(sender)
1731                                             .repo(author)
1732                                             .archive(archive)
1733                                             .archiveRef(&quot;archive&quot;)
1734                                             .censusRepo(censusBuilder.build())
1735                                             .lists(List.of(new MailingListConfiguration(listAddress, Set.of())))
1736                                             .listArchive(listServer.getArchive())
1737                                             .smtpServer(listServer.getSMTP())
<a name="21" id="anc21"></a><span class="line-modified">1738                                             .webrevStorageHTMLRepository(archive)</span>
1739                                             .webrevStorageRef(&quot;webrev&quot;)
1740                                             .webrevStorageBase(Path.of(&quot;test&quot;))
1741                                             .webrevStorageBaseUri(webrevServer.uri())
1742                                             .issueTracker(URIBuilder.base(&quot;http://issues.test/browse/&quot;).build())
1743                                             .build();
1744 
1745             // Populate the projects repository
1746             var reviewFile = Path.of(&quot;reviewfile.txt&quot;);
1747             var localRepo = CheckableRepository.init(tempFolder.path().resolve(&quot;first&quot;), author.repositoryType(), reviewFile);
1748             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
1749             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
1750             localRepo.push(masterHash, archive.url(), &quot;webrev&quot;, true);
1751             localRepo.push(masterHash, archive.url(), &quot;archive&quot;, true);
1752 
1753             // Make a change with a corresponding PR
1754             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;A line&quot;, &quot;Original msg&quot;);
1755             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
1756             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
1757             pr.setBody(&quot;This is now ready&quot;);
1758 
1759             // Run an archive pass
1760             TestBotRunner.runPeriodicItems(mlBot);
1761             listServer.processIncoming();
1762 
1763             // Push more stuff to master
1764             localRepo.checkout(masterHash, true);
1765             var unrelatedFile = localRepo.root().resolve(&quot;unrelated.txt&quot;);
1766             Files.writeString(unrelatedFile, &quot;Other things happens in master&quot;);
1767             localRepo.add(unrelatedFile);
1768             var newMasterHash = localRepo.commit(&quot;Unrelated change&quot;, &quot;duke&quot;, &quot;duke@openjdk.org&quot;);
1769             localRepo.push(newMasterHash, author.url(), &quot;master&quot;);
1770 
1771             // And more stuff to the pr branch
1772             localRepo.checkout(editHash, true);
1773             CheckableRepository.appendAndCommit(localRepo, &quot;Another line&quot;, &quot;More updates&quot;);
1774 
1775             // Merge master
1776             localRepo.merge(newMasterHash);
1777             var newEditHash = localRepo.commit(&quot;Latest changes from master&quot;, &quot;duke&quot;, &quot;duke@openjdk.org&quot;);
1778             localRepo.push(newEditHash, author.url(), &quot;edit&quot;);
1779 
1780             // Make sure that the push registered
1781             var lastHeadHash = pr.headHash();
1782             var refreshCount = 0;
1783             do {
1784                 pr = author.pullRequest(pr.id());
1785                 if (refreshCount++ &gt; 100) {
1786                     fail(&quot;The PR did not update after the new push&quot;);
1787                 }
1788             } while (pr.headHash().equals(lastHeadHash));
1789 
1790             // Run another archive pass
1791             TestBotRunner.runPeriodicItems(mlBot);
1792             listServer.processIncoming();
1793 
1794             // The archive should reference the rebased push
1795             Repository.materialize(archiveFolder.path(), archive.url(), &quot;archive&quot;);
1796             assertTrue(archiveContains(archiveFolder.path(), &quot;has updated the pull request with a new target base&quot;));
1797             assertTrue(archiveContains(archiveFolder.path(), &quot;excludes&quot;));
1798             assertTrue(archiveContains(archiveFolder.path(), pr.id() + &quot;/01&quot;));
1799             assertTrue(archiveContains(archiveFolder.path(), pr.id() + &quot;/00-01&quot;));
1800             assertTrue(archiveContains(archiveFolder.path(), &quot;Original msg&quot;));
1801             assertTrue(archiveContains(archiveFolder.path(), &quot;More updates&quot;));
1802         }
1803     }
1804 
1805     @Test
1806     void mergeWebrev(TestInfo testInfo) throws IOException {
1807         try (var credentials = new HostCredentials(testInfo);
1808              var tempFolder = new TemporaryDirectory();
1809              var archiveFolder = new TemporaryDirectory();
1810              var listServer = new TestMailmanServer();
1811              var webrevServer = new TestWebrevServer()) {
1812             var author = credentials.getHostedRepository();
1813             var archive = credentials.getHostedRepository();
1814             var commenter = credentials.getHostedRepository();
1815             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
1816             var censusBuilder = credentials.getCensusBuilder()
1817                                            .addAuthor(author.forge().currentUser().id());
1818             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
1819             var mlBot = MailingListBridgeBot.newBuilder()
1820                                             .from(from)
1821                                             .repo(author)
1822                                             .archive(archive)
1823                                             .archiveRef(&quot;archive&quot;)
1824                                             .censusRepo(censusBuilder.build())
1825                                             .lists(List.of(new MailingListConfiguration(listAddress, Set.of())))
1826                                             .listArchive(listServer.getArchive())
1827                                             .smtpServer(listServer.getSMTP())
<a name="22" id="anc22"></a><span class="line-modified">1828                                             .webrevStorageHTMLRepository(archive)</span>
1829                                             .webrevStorageRef(&quot;webrev&quot;)
1830                                             .webrevStorageBase(Path.of(&quot;test&quot;))
1831                                             .webrevStorageBaseUri(webrevServer.uri())
1832                                             .issueTracker(URIBuilder.base(&quot;http://issues.test/browse/&quot;).build())
1833                                             .build();
1834 
1835             // Populate the projects repository
1836             var reviewFile = Path.of(&quot;reviewfile.txt&quot;);
1837             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType(), reviewFile);
1838             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
1839             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
1840             localRepo.push(masterHash, archive.url(), &quot;archive&quot;, true);
1841             localRepo.push(masterHash, archive.url(), &quot;webrev&quot;, true);
1842 
1843             // Create a diverging branch
1844             var editOnlyFile = Path.of(&quot;editonly.txt&quot;);
1845             Files.writeString(localRepo.root().resolve(editOnlyFile), &quot;Only added in the edit&quot;);
1846             localRepo.add(editOnlyFile);
1847             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;Edited&quot;);
1848             localRepo.push(editHash, author.url(), &quot;edit&quot;);
1849 
1850             // Make conflicting changes in the target
1851             localRepo.checkout(masterHash, true);
1852             var masterOnlyFile = Path.of(&quot;masteronly.txt&quot;);
1853             Files.writeString(localRepo.root().resolve(masterOnlyFile), &quot;Only added in master&quot;);
1854             localRepo.add(masterOnlyFile);
1855             var updatedMasterHash = CheckableRepository.appendAndCommit(localRepo, &quot;Master change&quot;);
1856             localRepo.push(updatedMasterHash, author.url(), &quot;master&quot;);
1857 
1858             // Perform the merge - resolve conflicts in our favor
1859             localRepo.merge(editHash, &quot;ours&quot;);
1860             localRepo.commit(&quot;Merged edit&quot;, &quot;duke&quot;, &quot;duke@openjdk.java.net&quot;);
1861             var mergeOnlyFile = Path.of(&quot;mergeonly.txt&quot;);
1862             Files.writeString(localRepo.root().resolve(mergeOnlyFile), &quot;Only added in the merge&quot;);
1863             localRepo.add(mergeOnlyFile);
1864             Files.writeString(localRepo.root().resolve(reviewFile), &quot;Overwriting the conflict resolution&quot;);
1865             localRepo.add(reviewFile);
1866             var appendedCommit = localRepo.amend(&quot;Updated merge commit&quot;, &quot;duke&quot;, &quot;duke@openjdk.java.net&quot;);
1867             localRepo.push(appendedCommit, author.url(), &quot;merge_of_edit&quot;, true);
1868 
1869             // Make a merge PR
1870             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;merge_of_edit&quot;, &quot;Merge edit&quot;);
1871             pr.setBody(&quot;This is now ready&quot;);
1872 
1873             // Run an archive pass
1874             TestBotRunner.runPeriodicItems(mlBot);
1875             listServer.processIncoming();
1876 
1877             // The archive should contain a merge style webrev
1878             Repository.materialize(archiveFolder.path(), archive.url(), &quot;archive&quot;);
1879             assertTrue(archiveContains(archiveFolder.path(), &quot;The webrevs contain the adjustments done while merging with regards to each parent branch:&quot;));
1880             assertTrue(archiveContains(archiveFolder.path(), pr.id() + &quot;/00.0&quot;));
1881             assertTrue(archiveContains(archiveFolder.path(), &quot;3 lines in 2 files changed: 1 ins; 1 del; 1 mod&quot;));
1882 
1883             // The PR should contain a webrev comment
1884             assertEquals(1, pr.comments().size());
1885             var webrevComment = pr.comments().get(0);
1886             assertTrue(webrevComment.body().contains(&quot;Merge target&quot;));
1887             assertTrue(webrevComment.body().contains(&quot;Merge source&quot;));
1888         }
1889     }
1890 
1891     @Test
1892     void mergeWebrevConflict(TestInfo testInfo) throws IOException {
1893         try (var credentials = new HostCredentials(testInfo);
1894              var tempFolder = new TemporaryDirectory();
1895              var archiveFolder = new TemporaryDirectory();
1896              var listServer = new TestMailmanServer();
1897              var webrevServer = new TestWebrevServer()) {
1898             var author = credentials.getHostedRepository();
1899             var archive = credentials.getHostedRepository();
1900             var commenter = credentials.getHostedRepository();
1901             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
1902             var censusBuilder = credentials.getCensusBuilder()
1903                                            .addAuthor(author.forge().currentUser().id());
1904             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
1905             var mlBot = MailingListBridgeBot.newBuilder()
1906                                             .from(from)
1907                                             .repo(author)
1908                                             .archive(archive)
1909                                             .archiveRef(&quot;archive&quot;)
1910                                             .censusRepo(censusBuilder.build())
1911                                             .lists(List.of(new MailingListConfiguration(listAddress, Set.of())))
1912                                             .listArchive(listServer.getArchive())
1913                                             .smtpServer(listServer.getSMTP())
<a name="23" id="anc23"></a><span class="line-modified">1914                                             .webrevStorageHTMLRepository(archive)</span>
1915                                             .webrevStorageRef(&quot;webrev&quot;)
1916                                             .webrevStorageBase(Path.of(&quot;test&quot;))
1917                                             .webrevStorageBaseUri(webrevServer.uri())
1918                                             .issueTracker(URIBuilder.base(&quot;http://issues.test/browse/&quot;).build())
1919                                             .build();
1920 
1921             // Populate the projects repository
1922             var reviewFile = Path.of(&quot;reviewfile.txt&quot;);
1923             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType(), reviewFile);
1924             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
1925             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
1926             localRepo.push(masterHash, archive.url(), &quot;archive&quot;, true);
1927             localRepo.push(masterHash, archive.url(), &quot;webrev&quot;, true);
1928 
1929             // Create a merge
1930             var editOnlyFile = Path.of(&quot;editonly.txt&quot;);
1931             Files.writeString(localRepo.root().resolve(editOnlyFile), &quot;Only added in the edit&quot;);
1932             localRepo.add(editOnlyFile);
1933             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;Edited&quot;);
1934             localRepo.checkout(masterHash, true);
1935             var masterOnlyFile = Path.of(&quot;masteronly.txt&quot;);
1936             Files.writeString(localRepo.root().resolve(masterOnlyFile), &quot;Only added in master&quot;);
1937             localRepo.add(masterOnlyFile);
1938             var updatedMasterHash = CheckableRepository.appendAndCommit(localRepo, &quot;Master change&quot;);
1939             localRepo.push(updatedMasterHash, author.url(), &quot;master&quot;);
1940             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
1941 
1942             // Make a merge PR
1943             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;Merge edit&quot;);
1944             pr.setBody(&quot;This is now ready&quot;);
1945 
1946             // Run an archive pass
1947             TestBotRunner.runPeriodicItems(mlBot);
1948             listServer.processIncoming();
1949 
1950             // The archive should contain a merge style webrev
1951             Repository.materialize(archiveFolder.path(), archive.url(), &quot;archive&quot;);
1952             assertTrue(archiveContains(archiveFolder.path(), &quot;The webrev contains the conflicts with master:&quot;));
1953             assertTrue(archiveContains(archiveFolder.path(), pr.id() + &quot;/00.conflicts&quot;));
1954             assertTrue(archiveContains(archiveFolder.path(), &quot;2 lines in 2 files changed: 2 ins; 0 del; 0 mod&quot;));
1955 
1956             // The PR should contain a webrev comment
1957             assertEquals(1, pr.comments().size());
1958             var webrevComment = pr.comments().get(0);
1959             assertTrue(webrevComment.body().contains(&quot;Merge conflicts&quot;));
1960         }
1961     }
1962 
1963     @Test
1964     void mergeWebrevNoConflict(TestInfo testInfo) throws IOException {
1965         try (var credentials = new HostCredentials(testInfo);
1966              var tempFolder = new TemporaryDirectory();
1967              var archiveFolder = new TemporaryDirectory();
1968              var listServer = new TestMailmanServer();
1969              var webrevServer = new TestWebrevServer()) {
1970             var author = credentials.getHostedRepository();
1971             var archive = credentials.getHostedRepository();
1972             var commenter = credentials.getHostedRepository();
1973             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
1974             var censusBuilder = credentials.getCensusBuilder()
1975                                            .addAuthor(author.forge().currentUser().id());
1976             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
1977             var mlBot = MailingListBridgeBot.newBuilder()
1978                                             .from(from)
1979                                             .repo(author)
1980                                             .archive(archive)
1981                                             .archiveRef(&quot;archive&quot;)
1982                                             .censusRepo(censusBuilder.build())
1983                                             .lists(List.of(new MailingListConfiguration(listAddress, Set.of())))
1984                                             .listArchive(listServer.getArchive())
1985                                             .smtpServer(listServer.getSMTP())
<a name="24" id="anc24"></a><span class="line-modified">1986                                             .webrevStorageHTMLRepository(archive)</span>
1987                                             .webrevStorageRef(&quot;webrev&quot;)
1988                                             .webrevStorageBase(Path.of(&quot;test&quot;))
1989                                             .webrevStorageBaseUri(webrevServer.uri())
1990                                             .issueTracker(URIBuilder.base(&quot;http://issues.test/browse/&quot;).build())
1991                                             .build();
1992 
1993             // Populate the projects repository
1994             var reviewFile = Path.of(&quot;reviewfile.txt&quot;);
1995             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType(), reviewFile);
1996             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
1997             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
1998             localRepo.push(masterHash, archive.url(), &quot;archive&quot;, true);
1999             localRepo.push(masterHash, archive.url(), &quot;webrev&quot;, true);
2000 
2001             // Create a merge
2002             var editOnlyFile = Path.of(&quot;editonly.txt&quot;);
2003             Files.writeString(localRepo.root().resolve(editOnlyFile), &quot;Only added in the edit&quot;);
2004             localRepo.add(editOnlyFile);
2005             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;Edited&quot;, &quot;Commit in edit branch&quot;);
2006             localRepo.checkout(masterHash, true);
2007             var masterOnlyFile = Path.of(&quot;masteronly.txt&quot;);
2008             Files.writeString(localRepo.root().resolve(masterOnlyFile), &quot;Only added in master&quot;);
2009             localRepo.add(masterOnlyFile);
2010             var updatedMasterHash = localRepo.commit(&quot;Only added in master&quot;, &quot;duke&quot;, &quot;duke@openjdk.java.net&quot;);
2011             localRepo.push(updatedMasterHash, author.url(), &quot;master&quot;);
2012             localRepo.merge(editHash);
2013             var mergeCommit = localRepo.commit(&quot;Merged edit&quot;, &quot;duke&quot;, &quot;duke@openjdk.java.net&quot;);
2014             localRepo.push(mergeCommit, author.url(), &quot;edit&quot;, true);
2015 
2016             // Make a merge PR
2017             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;Merge edit&quot;);
2018             pr.setBody(&quot;This is now ready&quot;);
2019 
2020             // Run an archive pass
2021             TestBotRunner.runPeriodicItems(mlBot);
2022             listServer.processIncoming();
2023 
2024             // The archive should contain a merge style webrev
2025             Repository.materialize(archiveFolder.path(), archive.url(), &quot;archive&quot;);
2026             assertTrue(archiveContains(archiveFolder.path(), &quot;so no merge-specific webrevs have been generated&quot;));
2027 
2028             // The PR should not contain a webrev comment
2029             assertEquals(0, pr.comments().size());
2030         }
2031     }
2032 
2033     @Test
2034     void skipAddingExistingWebrev(TestInfo testInfo) throws IOException {
2035         try (var credentials = new HostCredentials(testInfo);
2036              var tempFolder = new TemporaryDirectory();
2037              var archiveFolder = new TemporaryDirectory();
2038              var webrevFolder = new TemporaryDirectory();
2039              var listServer = new TestMailmanServer();
2040              var webrevServer = new TestWebrevServer()) {
2041             var author = credentials.getHostedRepository();
2042             var archive = credentials.getHostedRepository();
2043             var ignored = credentials.getHostedRepository();
2044             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
2045             var censusBuilder = credentials.getCensusBuilder()
2046                                            .addAuthor(author.forge().currentUser().id());
2047             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
2048             var mlBot = MailingListBridgeBot.newBuilder()
2049                                             .from(from)
2050                                             .repo(author)
2051                                             .archive(archive)
2052                                             .censusRepo(censusBuilder.build())
2053                                             .lists(List.of(new MailingListConfiguration(listAddress, Set.of())))
2054                                             .ignoredUsers(Set.of(ignored.forge().currentUser().userName()))
2055                                             .listArchive(listServer.getArchive())
2056                                             .smtpServer(listServer.getSMTP())
<a name="25" id="anc25"></a><span class="line-modified">2057                                             .webrevStorageHTMLRepository(archive)</span>
2058                                             .webrevStorageRef(&quot;webrev&quot;)
2059                                             .webrevStorageBase(Path.of(&quot;test&quot;))
2060                                             .webrevStorageBaseUri(webrevServer.uri())
2061                                             .issueTracker(URIBuilder.base(&quot;http://issues.test/browse/&quot;).build())
2062                                             .build();
2063 
2064             // Populate the projects repository
2065             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType());
2066             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
2067             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
2068             localRepo.push(masterHash, archive.url(), &quot;webrev&quot;, true);
2069 
2070             // Make a change with a corresponding PR
2071             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;A simple change&quot;,
2072                                                                &quot;Change msg\n\nWith several lines&quot;);
2073             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
2074             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
2075 
2076             // Flag it as ready for review
2077             pr.setBody(&quot;This should now be ready&quot;);
2078 
2079             // Run an archive pass
2080             TestBotRunner.runPeriodicItems(mlBot);
2081 
2082             // The archive should now contain an entry
2083             var archiveRepo = Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);
2084             assertTrue(archiveContains(archiveFolder.path(), editHash.abbreviate()));
2085 
2086             // And there should be a webrev comment
2087             var comments = pr.comments();
2088             var webrevComments = comments.stream()
2089                                          .filter(comment -&gt; comment.author().equals(author.forge().currentUser()))
2090                                          .filter(comment -&gt; comment.body().contains(&quot;webrev&quot;))
2091                                          .filter(comment -&gt; comment.body().contains(editHash.hex()))
2092                                          .collect(Collectors.toList());
2093             assertEquals(1, webrevComments.size());
2094             assertEquals(1, countSubstrings(webrevComments.get(0).body(), pr.id() + &quot;/00&quot;));
2095 
2096             // Pretend the archive didn&#39;t work out
2097             archiveRepo.push(masterHash, archive.url(), &quot;master&quot;, true);
2098 
2099             // Run another archive pass
2100             TestBotRunner.runPeriodicItems(mlBot);
2101 
2102             // The webrev comment should not contain duplicate entries
2103             comments = pr.comments();
2104             webrevComments = comments.stream()
2105                                      .filter(comment -&gt; comment.author().equals(author.forge().currentUser()))
2106                                      .filter(comment -&gt; comment.body().contains(&quot;webrev&quot;))
2107                                      .filter(comment -&gt; comment.body().contains(editHash.hex()))
2108                                      .collect(Collectors.toList());
2109             assertEquals(1, webrevComments.size());
2110             assertEquals(1, countSubstrings(webrevComments.get(0).body(), pr.id() + &quot;/00&quot;));
2111         }
2112     }
2113 
2114     @Test
2115     void notifyReviewVerdicts(TestInfo testInfo) throws IOException {
2116         try (var credentials = new HostCredentials(testInfo);
2117              var tempFolder = new TemporaryDirectory();
2118              var archiveFolder = new TemporaryDirectory();
2119              var listServer = new TestMailmanServer();
2120              var webrevServer = new TestWebrevServer()) {
2121             var author = credentials.getHostedRepository();
2122             var archive = credentials.getHostedRepository();
2123             var reviewer = credentials.getHostedRepository();
2124             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
2125             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
2126             var censusBuilder = credentials.getCensusBuilder()
2127                                            .addReviewer(reviewer.forge().currentUser().id())
2128                                            .addAuthor(author.forge().currentUser().id());
2129             var mlBot = MailingListBridgeBot.newBuilder()
2130                                             .from(from)
2131                                             .repo(author)
2132                                             .archive(archive)
2133                                             .censusRepo(censusBuilder.build())
2134                                             .lists(List.of(new MailingListConfiguration(listAddress, Set.of())))
2135                                             .listArchive(listServer.getArchive())
2136                                             .smtpServer(listServer.getSMTP())
<a name="26" id="anc26"></a><span class="line-modified">2137                                             .webrevStorageHTMLRepository(archive)</span>
2138                                             .webrevStorageRef(&quot;webrev&quot;)
2139                                             .webrevStorageBase(Path.of(&quot;test&quot;))
2140                                             .webrevStorageBaseUri(webrevServer.uri())
2141                                             .issueTracker(URIBuilder.base(&quot;http://issues.test/browse/&quot;).build())
2142                                             .build();
2143 
2144             // Populate the projects repository
2145             var reviewFile = Path.of(&quot;reviewfile.txt&quot;);
2146             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType(), reviewFile);
2147             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
2148             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
2149             localRepo.push(masterHash, archive.url(), &quot;webrev&quot;, true);
2150 
2151             // Make a change with a corresponding PR
2152             var editHash = CheckableRepository.appendAndCommit(localRepo);
2153             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
2154             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
2155             pr.setBody(&quot;This is now ready&quot;);
2156 
2157             // Run an archive pass
2158             TestBotRunner.runPeriodicItems(mlBot);
2159 
2160             // First unapprove it
2161             var reviewedPr = reviewer.pullRequest(pr.id());
2162             reviewedPr.addReview(Review.Verdict.DISAPPROVED, &quot;Reason 1&quot;);
2163             TestBotRunner.runPeriodicItems(mlBot);
2164             TestBotRunner.runPeriodicItems(mlBot);
2165             TestBotRunner.runPeriodicItems(mlBot);
2166 
2167             // The archive should contain a note
2168             Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);
2169             assertEquals(1, archiveContainsCount(archiveFolder.path(), &quot;Changes requested by &quot;));
2170             assertEquals(1, archiveContainsCount(archiveFolder.path(), &quot; by integrationreviewer1&quot;));
2171             if (author.forge().supportsReviewBody()) {
2172                 assertEquals(1, archiveContainsCount(archiveFolder.path(), &quot;Reason 1&quot;));
2173             }
2174 
2175             // Then approve it
2176             reviewedPr.addReview(Review.Verdict.APPROVED, &quot;Reason 2&quot;);
2177             TestBotRunner.runPeriodicItems(mlBot);
2178             TestBotRunner.runPeriodicItems(mlBot);
2179             TestBotRunner.runPeriodicItems(mlBot);
2180 
2181             // The archive should contain another note
2182             Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);
2183             assertEquals(1, archiveContainsCount(archiveFolder.path(), &quot;Marked as reviewed by &quot;));
2184             if (author.forge().supportsReviewBody()) {
2185                 assertEquals(1, archiveContainsCount(archiveFolder.path(), &quot;Reason 2&quot;));
2186             }
2187             assertEquals(2, archiveContainsCount(archiveFolder.path(), &quot;Re: RFR:&quot;));
2188 
2189             // Yet another change
2190             reviewedPr.addReview(Review.Verdict.DISAPPROVED, &quot;Reason 3&quot;);
2191             TestBotRunner.runPeriodicItems(mlBot);
2192             TestBotRunner.runPeriodicItems(mlBot);
2193             TestBotRunner.runPeriodicItems(mlBot);
2194 
2195             // The archive should contain another note
2196             Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);
2197             assertEquals(2, archiveContainsCount(archiveFolder.path(), &quot;Changes requested by &quot;));
2198             if (author.forge().supportsReviewBody()) {
2199                 assertEquals(1, archiveContainsCount(archiveFolder.path(), &quot;Reason 3&quot;));
2200             }
2201         }
2202     }
2203 
2204     @Test
2205     void ignoreComments(TestInfo testInfo) throws IOException {
2206         try (var credentials = new HostCredentials(testInfo);
2207              var tempFolder = new TemporaryDirectory();
2208              var archiveFolder = new TemporaryDirectory();
2209              var listServer = new TestMailmanServer();
2210              var webrevServer = new TestWebrevServer()) {
2211             var author = credentials.getHostedRepository();
2212             var ignored = credentials.getHostedRepository();
2213             var archive = credentials.getHostedRepository();
2214             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
2215             var censusBuilder = credentials.getCensusBuilder()
2216                                            .addAuthor(author.forge().currentUser().id());
2217             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
2218             var mlBot = MailingListBridgeBot.newBuilder()
2219                                             .from(from)
2220                                             .repo(author)
2221                                             .archive(archive)
2222                                             .censusRepo(censusBuilder.build())
2223                                             .lists(List.of(new MailingListConfiguration(listAddress, Set.of())))
2224                                             .ignoredUsers(Set.of(ignored.forge().currentUser().userName()))
2225                                             .ignoredComments(Set.of(Pattern.compile(&quot;ignore this comment&quot;, Pattern.MULTILINE | Pattern.DOTALL)))
2226                                             .listArchive(listServer.getArchive())
2227                                             .smtpServer(listServer.getSMTP())
<a name="27" id="anc27"></a><span class="line-modified">2228                                             .webrevStorageHTMLRepository(archive)</span>
2229                                             .webrevStorageRef(&quot;webrev&quot;)
2230                                             .webrevStorageBase(Path.of(&quot;test&quot;))
2231                                             .webrevStorageBaseUri(webrevServer.uri())
2232                                             .issueTracker(URIBuilder.base(&quot;http://issues.test/browse/&quot;).build())
2233                                             .build();
2234 
2235             // Populate the projects repository
2236             var reviewFile = Path.of(&quot;reviewfile.txt&quot;);
2237             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType(), reviewFile);
2238             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
2239             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
2240             localRepo.push(masterHash, archive.url(), &quot;webrev&quot;, true);
2241 
2242             // Make a change with a corresponding PR
2243             var editHash = CheckableRepository.appendAndCommit(localRepo);
2244             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
2245             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
2246             pr.setBody(&quot;This is now ready&quot;);
2247 
2248             // Make a bunch of comments
2249             pr.addComment(&quot;Plain comment&quot;);
2250             pr.addComment(&quot;ignore this comment&quot;);
2251             pr.addComment(&quot;I think it is time to\nignore this comment!&quot;);
2252             pr.addReviewComment(masterHash, editHash, reviewFile.toString(), 2, &quot;Review ignore this comment&quot;);
2253 
2254             var ignoredPR = ignored.pullRequest(pr.id());
2255             ignoredPR.addComment(&quot;Don&#39;t mind me&quot;);
2256 
2257             TestBotRunner.runPeriodicItems(mlBot);
2258             TestBotRunner.runPeriodicItems(mlBot);
2259 
2260             // The archive should not contain the ignored comments
2261             Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);
2262             assertTrue(archiveContains(archiveFolder.path(), &quot;This is now ready&quot;));
2263             assertFalse(archiveContains(archiveFolder.path(), &quot;ignore this comment&quot;));
2264             assertFalse(archiveContains(archiveFolder.path(), &quot;it is time to&quot;));
2265             assertFalse(archiveContains(archiveFolder.path(), &quot;Don&#39;t mind me&quot;));
2266             assertFalse(archiveContains(archiveFolder.path(), &quot;Review ignore&quot;));
2267         }
2268     }
2269 
2270     @Test
2271     void replyToEmptyReview(TestInfo testInfo) throws IOException {
2272         try (var credentials = new HostCredentials(testInfo);
2273              var tempFolder = new TemporaryDirectory();
2274              var archiveFolder = new TemporaryDirectory();
2275              var listServer = new TestMailmanServer();
2276              var webrevServer = new TestWebrevServer()) {
2277             var author = credentials.getHostedRepository();
2278             var reviewer = credentials.getHostedRepository();
2279             var archive = credentials.getHostedRepository();
2280             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
2281             var censusBuilder = credentials.getCensusBuilder()
2282                                            .addReviewer(reviewer.forge().currentUser().id())
2283                                            .addAuthor(author.forge().currentUser().id());
2284             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
2285             var mlBot = MailingListBridgeBot.newBuilder()
2286                                             .from(from)
2287                                             .repo(author)
2288                                             .archive(archive)
2289                                             .censusRepo(censusBuilder.build())
2290                                             .lists(List.of(new MailingListConfiguration(listAddress, Set.of())))
2291                                             .listArchive(listServer.getArchive())
2292                                             .smtpServer(listServer.getSMTP())
<a name="28" id="anc28"></a><span class="line-modified">2293                                             .webrevStorageHTMLRepository(archive)</span>
2294                                             .webrevStorageRef(&quot;webrev&quot;)
2295                                             .webrevStorageBase(Path.of(&quot;test&quot;))
2296                                             .webrevStorageBaseUri(webrevServer.uri())
2297                                             .issueTracker(URIBuilder.base(&quot;http://issues.test/browse/&quot;).build())
2298                                             .build();
2299 
2300             // Populate the projects repository
2301             var reviewFile = Path.of(&quot;reviewfile.txt&quot;);
2302             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType(), reviewFile);
2303             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
2304             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
2305             localRepo.push(masterHash, archive.url(), &quot;webrev&quot;, true);
2306 
2307             // Make a change with a corresponding PR
2308             var editHash = CheckableRepository.appendAndCommit(localRepo);
2309             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
2310             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
2311             pr.setBody(&quot;This is now ready&quot;);
2312             TestBotRunner.runPeriodicItems(mlBot);
2313             listServer.processIncoming();
2314 
2315             // Make an empty approval
2316             var reviewPr = reviewer.pullRequest(pr.id());
2317             reviewPr.addReview(Review.Verdict.APPROVED, &quot;&quot;);
2318             TestBotRunner.runPeriodicItems(mlBot);
2319             listServer.processIncoming();
2320 
2321             pr.addComment(&quot;Thanks for the review!&quot;);
2322             TestBotRunner.runPeriodicItems(mlBot);
2323             listServer.processIncoming();
2324 
2325             // The approval text should be included in the quote
2326             Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);
2327             assertEquals(1, archiveContainsCount(archiveFolder.path(), &quot;^&gt; Marked as reviewed&quot;));
2328         }
2329     }
2330 
2331     @Test
2332     void cooldown(TestInfo testInfo) throws IOException {
2333         try (var credentials = new HostCredentials(testInfo);
2334              var tempFolder = new TemporaryDirectory();
2335              var archiveFolder = new TemporaryDirectory();
2336              var listServer = new TestMailmanServer();
2337              var webrevServer = new TestWebrevServer()) {
2338             var bot = credentials.getHostedRepository();
2339             var author = credentials.getHostedRepository();
2340             var archive = credentials.getHostedRepository();
2341             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
2342             var censusBuilder = credentials.getCensusBuilder()
2343                                            .addAuthor(author.forge().currentUser().id());
2344             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
2345             var mlBotBuilder = MailingListBridgeBot.newBuilder()
2346                                                    .from(from)
2347                                                    .repo(bot)
2348                                                    .ignoredUsers(Set.of(bot.forge().currentUser().userName()))
2349                                                    .archive(archive)
2350                                                    .censusRepo(censusBuilder.build())
2351                                                    .lists(List.of(new MailingListConfiguration(listAddress, Set.of())))
2352                                                    .listArchive(listServer.getArchive())
2353                                                    .smtpServer(listServer.getSMTP())
<a name="29" id="anc29"></a><span class="line-modified">2354                                                    .webrevStorageHTMLRepository(archive)</span>
2355                                                    .webrevStorageRef(&quot;webrev&quot;)
2356                                                    .webrevStorageBase(Path.of(&quot;test&quot;))
2357                                                    .webrevStorageBaseUri(webrevServer.uri())
2358                                                    .issueTracker(URIBuilder.base(&quot;http://issues.test/browse/&quot;).build());
2359 
2360             // Populate the projects repository
2361             var reviewFile = Path.of(&quot;reviewfile.txt&quot;);
2362             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType(), reviewFile);
2363             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
2364             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
2365             localRepo.push(masterHash, archive.url(), &quot;webrev&quot;, true);
2366 
2367             // Make a change with a corresponding PR
2368             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;Line 1\nLine 2\nLine 3\nLine 4&quot;);
2369             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
2370             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
2371             pr.setBody(&quot;This is now ready&quot;);
2372 
2373             var mlBot = mlBotBuilder.build();
2374             var mlBotWithCooldown = mlBotBuilder.cooldown(Duration.ofDays(1)).build();
2375 
2376             TestBotRunner.runPeriodicItems(mlBot);
2377             listServer.processIncoming();
2378 
2379             // Make a comment
2380             pr.addComment(&quot;Looks good&quot;);
2381 
2382             // Bot with cooldown configured should not bridge the comment
2383             TestBotRunner.runPeriodicItems(mlBotWithCooldown);
2384             assertThrows(RuntimeException.class, () -&gt; listServer.processIncoming(Duration.ofMillis(1)));
2385 
2386             // But without, it should
2387             TestBotRunner.runPeriodicItems(mlBot);
2388             listServer.processIncoming();
2389 
2390             // Check the archive
2391             Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);
2392             assertTrue(archiveContains(archiveFolder.path(), &quot;Looks good&quot;));
2393         }
2394     }
2395 
2396     @Test
2397     void cooldownNewRevision(TestInfo testInfo) throws IOException {
2398         try (var credentials = new HostCredentials(testInfo);
2399              var tempFolder = new TemporaryDirectory();
2400              var archiveFolder = new TemporaryDirectory();
2401              var listServer = new TestMailmanServer();
2402              var webrevServer = new TestWebrevServer()) {
2403             var bot = credentials.getHostedRepository();
2404             var author = credentials.getHostedRepository();
2405             var archive = credentials.getHostedRepository();
2406             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
2407             var censusBuilder = credentials.getCensusBuilder()
2408                                            .addAuthor(author.forge().currentUser().id());
2409             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
2410             var mlBotBuilder = MailingListBridgeBot.newBuilder()
2411                                                    .from(from)
2412                                                    .repo(bot)
2413                                                    .ignoredUsers(Set.of(bot.forge().currentUser().userName()))
2414                                                    .archive(archive)
2415                                                    .censusRepo(censusBuilder.build())
2416                                                    .lists(List.of(new MailingListConfiguration(listAddress, Set.of())))
2417                                                    .listArchive(listServer.getArchive())
2418                                                    .smtpServer(listServer.getSMTP())
<a name="30" id="anc30"></a><span class="line-modified">2419                                                    .webrevStorageHTMLRepository(archive)</span>
2420                                                    .webrevStorageRef(&quot;webrev&quot;)
2421                                                    .webrevStorageBase(Path.of(&quot;test&quot;))
2422                                                    .webrevStorageBaseUri(webrevServer.uri())
2423                                                    .issueTracker(URIBuilder.base(&quot;http://issues.test/browse/&quot;).build());
2424 
2425             // Populate the projects repository
2426             var reviewFile = Path.of(&quot;reviewfile.txt&quot;);
2427             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType(), reviewFile);
2428             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
2429             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
2430             localRepo.push(masterHash, archive.url(), &quot;webrev&quot;, true);
2431 
2432             // Make a change with a corresponding PR
2433             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;Line 1\nLine 2\nLine 3\nLine 4&quot;);
2434             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
2435             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
2436             pr.setBody(&quot;This is now ready&quot;);
2437 
2438             var mlBot = mlBotBuilder.build();
2439             var mlBotWithCooldown = mlBotBuilder.cooldown(Duration.ofDays(1)).build();
2440 
2441             TestBotRunner.runPeriodicItems(mlBot);
2442             listServer.processIncoming();
2443 
2444             // Commit another revision
2445             var updatedHash = CheckableRepository.appendAndCommit(localRepo, &quot;More stuff&quot;);
2446             localRepo.push(updatedHash, author.url(), &quot;edit&quot;);
2447 
2448             // Bot with cooldown configured should not create a new webrev
2449             TestBotRunner.runPeriodicItems(mlBotWithCooldown);
2450             assertThrows(RuntimeException.class, () -&gt; listServer.processIncoming(Duration.ofMillis(1)));
2451 
2452             // But without, it should
2453             TestBotRunner.runPeriodicItems(mlBot);
2454             listServer.processIncoming();
2455 
2456             // Check the archive
2457             Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);
2458             assertTrue(archiveContains(archiveFolder.path(), pr.id() + &quot;/01&quot;));
2459         }
2460     }
2461 
2462     @Test
2463     void retryAfterCooldown(TestInfo testInfo) throws IOException, InterruptedException {
2464         try (var credentials = new HostCredentials(testInfo);
2465              var tempFolder = new TemporaryDirectory();
2466              var archiveFolder = new TemporaryDirectory();
2467              var listServer = new TestMailmanServer();
2468              var webrevServer = new TestWebrevServer()) {
2469             var bot = credentials.getHostedRepository();
2470             var author = credentials.getHostedRepository();
2471             var archive = credentials.getHostedRepository();
2472             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
2473             var censusBuilder = credentials.getCensusBuilder()
2474                                            .addAuthor(author.forge().currentUser().id());
2475             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
2476             var cooldown = Duration.ofMillis(500);
2477             var mlBotBuilder = MailingListBridgeBot.newBuilder()
2478                                                    .from(from)
2479                                                    .repo(bot)
2480                                                    .ignoredUsers(Set.of(bot.forge().currentUser().userName()))
2481                                                    .archive(archive)
2482                                                    .censusRepo(censusBuilder.build())
2483                                                    .lists(List.of(new MailingListConfiguration(listAddress, Set.of())))
2484                                                    .listArchive(listServer.getArchive())
2485                                                    .smtpServer(listServer.getSMTP())
<a name="31" id="anc31"></a><span class="line-modified">2486                                                    .webrevStorageHTMLRepository(archive)</span>
2487                                                    .webrevStorageRef(&quot;webrev&quot;)
2488                                                    .webrevStorageBase(Path.of(&quot;test&quot;))
2489                                                    .webrevStorageBaseUri(webrevServer.uri())
2490                                                    .issueTracker(URIBuilder.base(&quot;http://issues.test/browse/&quot;).build());
2491 
2492             // Populate the projects repository
2493             var reviewFile = Path.of(&quot;reviewfile.txt&quot;);
2494             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType(), reviewFile);
2495             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
2496             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
2497             localRepo.push(masterHash, archive.url(), &quot;webrev&quot;, true);
2498 
2499             // Make a change with a corresponding PR
2500             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;Line 1\nLine 2\nLine 3\nLine 4&quot;);
2501             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
2502             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
2503             pr.setBody(&quot;This is now ready&quot;);
2504 
2505             var mlBot = mlBotBuilder.cooldown(cooldown).build();
2506             Thread.sleep(cooldown.toMillis());
2507             TestBotRunner.runPeriodicItems(mlBot);
2508             listServer.processIncoming();
2509 
2510             // Make a comment and run the check within the cooldown period
2511             int counter;
2512             boolean noMailReceived = false;
2513             for (counter = 1; counter &lt; 10; ++counter) {
2514                 var start = Instant.now();
2515                 pr.addComment(&quot;Looks good - &quot; + counter + &quot; -&quot;);
2516 
2517                 // The bot should not bridge the comment due to cooldown
2518                 TestBotRunner.runPeriodicItems(mlBot);
2519                 try {
2520                     noMailReceived = false;
2521                     listServer.processIncoming(Duration.ofMillis(1));
2522                 } catch (RuntimeException e) {
2523                     noMailReceived = true;
2524                 }
2525                 var elapsed = Duration.between(start, Instant.now());
2526                 if (elapsed.compareTo(cooldown) &lt; 0) {
2527                     break;
2528                 } else {
2529                     log.info(&quot;Didn&#39;t do the test in time - retrying (elapsed: &quot; + elapsed + &quot; required: &quot; + cooldown + &quot;)&quot;);
2530                     // Ensure that the cooldown expires
2531                     Thread.sleep(cooldown.toMillis());
2532                     // If no mail was received, we have to flush it out
2533                     if (noMailReceived) {
2534                         TestBotRunner.runPeriodicItems(mlBot);
2535                         listServer.processIncoming();
2536                     }
2537                     cooldown = cooldown.multipliedBy(2);
2538                     mlBot = mlBotBuilder.cooldown(cooldown).build();
2539                 }
2540             }
2541             assertTrue(noMailReceived);
2542 
2543             // But after the cooldown period has passed, it should
2544             Thread.sleep(cooldown.toMillis());
2545             TestBotRunner.runPeriodicItems(mlBot);
2546             listServer.processIncoming();
2547 
2548             // Check the archive
2549             Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);
2550             assertTrue(archiveContains(archiveFolder.path(), &quot;Looks good - &quot; + counter + &quot; -&quot;));
2551         }
2552     }
2553 
2554     @Test
2555     void branchPrefix(TestInfo testInfo) throws IOException {
2556         try (var credentials = new HostCredentials(testInfo);
2557              var tempFolder = new TemporaryDirectory();
2558              var archiveFolder = new TemporaryDirectory();
2559              var listServer = new TestMailmanServer();
2560              var webrevServer = new TestWebrevServer()) {
2561             var author = credentials.getHostedRepository();
2562             var archive = credentials.getHostedRepository();
2563             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
2564             var censusBuilder = credentials.getCensusBuilder()
2565                                            .addAuthor(author.forge().currentUser().id());
2566             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
2567             var mlBot = MailingListBridgeBot.newBuilder()
2568                                             .from(from)
2569                                             .repo(author)
2570                                             .archive(archive)
2571                                             .censusRepo(censusBuilder.build())
2572                                             .lists(List.of(new MailingListConfiguration(listAddress, Set.of())))
2573                                             .listArchive(listServer.getArchive())
2574                                             .smtpServer(listServer.getSMTP())
<a name="32" id="anc32"></a><span class="line-modified">2575                                             .webrevStorageHTMLRepository(archive)</span>
2576                                             .webrevStorageRef(&quot;webrev&quot;)
2577                                             .webrevStorageBase(Path.of(&quot;test&quot;))
2578                                             .webrevStorageBaseUri(webrevServer.uri())
2579                                             .issueTracker(URIBuilder.base(&quot;http://issues.test/browse/&quot;).build())
2580                                             .branchInSubject(Pattern.compile(&quot;.*&quot;))
2581                                             .build();
2582 
2583             // Populate the projects repository
2584             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType());
2585             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
2586             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
2587             localRepo.push(masterHash, archive.url(), &quot;webrev&quot;, true);
2588 
2589             // Make a change with a corresponding PR
2590             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;A simple change&quot;,
2591                                                                &quot;Change msg\n\nWith several lines&quot;);
2592             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
2593             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;1234: This is a pull request&quot;);
2594             pr.setBody(&quot;This is a PR&quot;);
2595 
2596             // Run an archive pass
2597             TestBotRunner.runPeriodicItems(mlBot);
2598             listServer.processIncoming();
2599 
2600             pr.addComment(&quot;Looks good!&quot;);
2601             TestBotRunner.runPeriodicItems(mlBot);
2602             listServer.processIncoming();
2603 
2604             // Check the archive
2605             Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);
2606             assertTrue(archiveContains(archiveFolder.path(), &quot;Subject: \\[master\\] RFR: &quot;));
2607             assertTrue(archiveContains(archiveFolder.path(), &quot;Subject: Re: \\[master\\] RFR: &quot;));
2608         }
2609     }
2610 
2611     @Test
2612     void repoPrefix(TestInfo testInfo) throws IOException {
2613         try (var credentials = new HostCredentials(testInfo);
2614              var tempFolder = new TemporaryDirectory();
2615              var archiveFolder = new TemporaryDirectory();
2616              var listServer = new TestMailmanServer();
2617              var webrevServer = new TestWebrevServer()) {
2618             var author = credentials.getHostedRepository();
2619             var archive = credentials.getHostedRepository();
2620             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
2621             var censusBuilder = credentials.getCensusBuilder()
2622                                            .addAuthor(author.forge().currentUser().id());
2623             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
2624             var mlBot = MailingListBridgeBot.newBuilder()
2625                                             .from(from)
2626                                             .repo(author)
2627                                             .archive(archive)
2628                                             .censusRepo(censusBuilder.build())
2629                                             .lists(List.of(new MailingListConfiguration(listAddress, Set.of())))
2630                                             .listArchive(listServer.getArchive())
2631                                             .smtpServer(listServer.getSMTP())
<a name="33" id="anc33"></a><span class="line-modified">2632                                             .webrevStorageHTMLRepository(archive)</span>
2633                                             .webrevStorageRef(&quot;webrev&quot;)
2634                                             .webrevStorageBase(Path.of(&quot;test&quot;))
2635                                             .webrevStorageBaseUri(webrevServer.uri())
2636                                             .issueTracker(URIBuilder.base(&quot;http://issues.test/browse/&quot;).build())
2637                                             .repoInSubject(true)
2638                                             .build();
2639 
2640             // Populate the projects repository
2641             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType());
2642             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
2643             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
2644             localRepo.push(masterHash, archive.url(), &quot;webrev&quot;, true);
2645 
2646             // Make a change with a corresponding PR
2647             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;A simple change&quot;,
2648                                                                &quot;Change msg\n\nWith several lines&quot;);
2649             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
2650             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;1234: This is a pull request&quot;);
2651             pr.setBody(&quot;This is a PR&quot;);
2652 
2653             // Run an archive pass
2654             TestBotRunner.runPeriodicItems(mlBot);
2655             listServer.processIncoming();
2656 
2657             pr.addComment(&quot;Looks good!&quot;);
2658             TestBotRunner.runPeriodicItems(mlBot);
2659             listServer.processIncoming();
2660 
2661             // Check the archive
2662             Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);
2663             assertTrue(archiveContains(archiveFolder.path(), &quot;Subject: \\[&quot; + pr.repository().name() + &quot;\\] RFR: &quot;));
2664             assertTrue(archiveContains(archiveFolder.path(), &quot;Subject: Re: \\[&quot; + pr.repository().name() + &quot;\\] RFR: &quot;));
2665         }
2666     }
2667 
2668     @Test
2669     void repoAndBranchPrefix(TestInfo testInfo) throws IOException {
2670         try (var credentials = new HostCredentials(testInfo);
2671              var tempFolder = new TemporaryDirectory();
2672              var archiveFolder = new TemporaryDirectory();
2673              var listServer = new TestMailmanServer();
2674              var webrevServer = new TestWebrevServer()) {
2675             var author = credentials.getHostedRepository();
2676             var archive = credentials.getHostedRepository();
2677             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
2678             var censusBuilder = credentials.getCensusBuilder()
2679                                            .addAuthor(author.forge().currentUser().id());
2680             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
2681             var mlBot = MailingListBridgeBot.newBuilder()
2682                                             .from(from)
2683                                             .repo(author)
2684                                             .archive(archive)
2685                                             .censusRepo(censusBuilder.build())
2686                                             .lists(List.of(new MailingListConfiguration(listAddress, Set.of())))
2687                                             .listArchive(listServer.getArchive())
2688                                             .smtpServer(listServer.getSMTP())
<a name="34" id="anc34"></a><span class="line-modified">2689                                             .webrevStorageHTMLRepository(archive)</span>
2690                                             .webrevStorageRef(&quot;webrev&quot;)
2691                                             .webrevStorageBase(Path.of(&quot;test&quot;))
2692                                             .webrevStorageBaseUri(webrevServer.uri())
2693                                             .issueTracker(URIBuilder.base(&quot;http://issues.test/browse/&quot;).build())
2694                                             .repoInSubject(true)
2695                                             .branchInSubject(Pattern.compile(&quot;.*&quot;))
2696                                             .build();
2697 
2698             // Populate the projects repository
2699             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType());
2700             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
2701             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
2702             localRepo.push(masterHash, archive.url(), &quot;webrev&quot;, true);
2703 
2704             // Make a change with a corresponding PR
2705             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;A simple change&quot;,
2706                                                                &quot;Change msg\n\nWith several lines&quot;);
2707             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
2708             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;1234: This is a pull request&quot;);
2709             pr.setBody(&quot;This is a PR&quot;);
2710 
2711             // Run an archive pass
2712             TestBotRunner.runPeriodicItems(mlBot);
2713             listServer.processIncoming();
2714 
2715             pr.addComment(&quot;Looks good!&quot;);
2716             TestBotRunner.runPeriodicItems(mlBot);
2717             listServer.processIncoming();
2718 
2719             // Check the archive
2720             Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);
2721             assertTrue(archiveContains(archiveFolder.path(), &quot;Subject: \\[&quot; + pr.repository().name() + &quot;:master\\] RFR: &quot;));
2722             assertTrue(archiveContains(archiveFolder.path(), &quot;Subject: Re: \\[&quot; + pr.repository().name() + &quot;:master\\] RFR: &quot;));
2723         }
2724     }
2725 
2726     @Test
2727     void retryNewRevisionAfterCooldown(TestInfo testInfo) throws IOException, InterruptedException {
2728         try (var credentials = new HostCredentials(testInfo);
2729              var tempFolder = new TemporaryDirectory();
2730              var archiveFolder = new TemporaryDirectory();
2731              var listServer = new TestMailmanServer();
2732              var webrevServer = new TestWebrevServer()) {
2733             var bot = credentials.getHostedRepository();
2734             var author = credentials.getHostedRepository();
2735             var archive = credentials.getHostedRepository();
2736             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
2737             var censusBuilder = credentials.getCensusBuilder()
2738                                            .addAuthor(author.forge().currentUser().id());
2739             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
2740             var cooldown = Duration.ofMillis(500);
2741             var mlBotBuilder = MailingListBridgeBot.newBuilder()
2742                                                    .from(from)
2743                                                    .repo(bot)
2744                                                    .ignoredUsers(Set.of(bot.forge().currentUser().userName()))
2745                                                    .archive(archive)
2746                                                    .censusRepo(censusBuilder.build())
2747                                                    .lists(List.of(new MailingListConfiguration(listAddress, Set.of())))
2748                                                    .listArchive(listServer.getArchive())
2749                                                    .smtpServer(listServer.getSMTP())
<a name="35" id="anc35"></a><span class="line-modified">2750                                                    .webrevStorageHTMLRepository(archive)</span>
2751                                                    .webrevStorageRef(&quot;webrev&quot;)
2752                                                    .webrevStorageBase(Path.of(&quot;test&quot;))
2753                                                    .webrevStorageBaseUri(webrevServer.uri())
2754                                                    .issueTracker(URIBuilder.base(&quot;http://issues.test/browse/&quot;).build());
2755 
2756             // Populate the projects repository
2757             var reviewFile = Path.of(&quot;reviewfile.txt&quot;);
2758             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType(), reviewFile);
2759             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
2760             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
2761             localRepo.push(masterHash, archive.url(), &quot;webrev&quot;, true);
2762 
2763             // Make a change with a corresponding PR
2764             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;Line 1\nLine 2\nLine 3\nLine 4&quot;);
2765             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
2766             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
2767             pr.setBody(&quot;This is now ready&quot;);
2768 
2769             var mlBot = mlBotBuilder.cooldown(cooldown).build();
2770             Thread.sleep(cooldown.toMillis());
2771             TestBotRunner.runPeriodicItems(mlBot);
2772             listServer.processIncoming();
2773 
2774             // Make a new revision and run the check within the cooldown period
2775             int counter;
2776             boolean noMailReceived = false;
2777             for (counter = 1; counter &lt; 10; ++counter) {
2778                 var start = Instant.now();
2779                 var revHash = CheckableRepository.appendAndCommit(localRepo, &quot;more stuff&quot;, &quot;Update number - &quot; + counter + &quot; -&quot;);
2780                 localRepo.push(revHash, author.url(), &quot;edit&quot;);
2781 
2782                 // The bot should not bridge the new revision due to cooldown
2783                 TestBotRunner.runPeriodicItems(mlBot);
2784                 try {
2785                     noMailReceived = false;
2786                     listServer.processIncoming(Duration.ofMillis(1));
2787                 } catch (RuntimeException e) {
2788                     noMailReceived = true;
2789                 }
2790                 var elapsed = Duration.between(start, Instant.now());
2791                 if (elapsed.compareTo(cooldown) &lt; 0) {
2792                     break;
2793                 } else {
2794                     log.info(&quot;Didn&#39;t do the test in time - retrying (elapsed: &quot; + elapsed + &quot; required: &quot; + cooldown + &quot;)&quot;);
2795                     // Ensure that the cooldown expires
2796                     Thread.sleep(cooldown.toMillis());
2797                     // If no mail was received, we have to flush it out
2798                     if (noMailReceived) {
2799                         TestBotRunner.runPeriodicItems(mlBot);
2800                         listServer.processIncoming();
2801                     }
2802                     cooldown = cooldown.multipliedBy(2);
2803                     mlBot = mlBotBuilder.cooldown(cooldown).build();
2804                 }
2805             }
2806             assertTrue(noMailReceived);
2807 
2808             // But after the cooldown period has passed, it should
2809             Thread.sleep(cooldown.toMillis());
2810             TestBotRunner.runPeriodicItems(mlBot);
2811             listServer.processIncoming();
2812 
2813             // Check the archive
2814             Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);
2815             assertTrue(archiveContains(archiveFolder.path(), &quot;Update number - &quot; + counter + &quot; -&quot;));
2816         }
2817     }
2818 
2819     @Test
2820     void multipleRecipients(TestInfo testInfo) throws IOException {
2821         try (var credentials = new HostCredentials(testInfo);
2822              var tempFolder = new TemporaryDirectory();
2823              var archiveFolder = new TemporaryDirectory();
2824              var listServer = new TestMailmanServer();
2825              var webrevServer = new TestWebrevServer()) {
2826             var author = credentials.getHostedRepository();
2827             var archive = credentials.getHostedRepository();
2828             var listAddress1 = EmailAddress.parse(listServer.createList(&quot;test1&quot;));
2829             var listAddress2 = EmailAddress.parse(listServer.createList(&quot;test2&quot;));
2830             var censusBuilder = credentials.getCensusBuilder()
2831                                            .addAuthor(author.forge().currentUser().id());
2832             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
2833             var mlBot = MailingListBridgeBot.newBuilder()
2834                                             .from(from)
2835                                             .repo(author)
2836                                             .archive(archive)
2837                                             .censusRepo(censusBuilder.build())
2838                                             .lists(List.of(new MailingListConfiguration(listAddress1, Set.of(&quot;list1&quot;)),
2839                                                            new MailingListConfiguration(listAddress2, Set.of(&quot;list2&quot;))))
2840                                             .listArchive(listServer.getArchive())
2841                                             .smtpServer(listServer.getSMTP())
<a name="36" id="anc36"></a><span class="line-modified">2842                                             .webrevStorageHTMLRepository(archive)</span>
2843                                             .webrevStorageRef(&quot;webrev&quot;)
2844                                             .webrevStorageBase(Path.of(&quot;test&quot;))
2845                                             .webrevStorageBaseUri(webrevServer.uri())
2846                                             .issueTracker(URIBuilder.base(&quot;http://issues.test/browse/&quot;).build())
2847                                             .build();
2848 
2849             // Populate the projects repository
2850             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType());
2851             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
2852             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
2853             localRepo.push(masterHash, archive.url(), &quot;webrev&quot;, true);
2854 
2855             // Make a change with a corresponding PR
2856             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;A simple change&quot;,
2857                                                                &quot;Change msg\n\nWith several lines&quot;);
2858             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
2859             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;1234: This is a pull request&quot;);
2860             pr.setBody(&quot;This is a PR&quot;);
2861             pr.addLabel(&quot;list1&quot;);
2862 
2863             // Run an archive pass
2864             TestBotRunner.runPeriodicItems(mlBot);
2865             listServer.processIncoming();
2866 
2867             // The mail should have been sent to list1
2868             var mailmanServer = MailingListServerFactory.createMailmanServer(listServer.getArchive(), listServer.getSMTP(), Duration.ZERO);
2869             var mailmanList = mailmanServer.getList(listAddress1.address());
2870             var conversations = mailmanList.conversations(Duration.ofDays(1));
2871             assertEquals(1, conversations.size());
2872             var mail = conversations.get(0).first();
2873             assertEquals(&quot;RFR: 1234: This is a pull request&quot;, mail.subject());
2874             assertEquals(pr.author().fullName(), mail.author().fullName().orElseThrow());
2875             assertEquals(noreplyAddress(archive), mail.author().address());
2876             assertEquals(listAddress1, mail.sender());
2877             assertEquals(List.of(listAddress1), mail.recipients());
2878 
2879             // Add another label and comment
2880             pr.addLabel(&quot;list2&quot;);
2881             pr.addComment(&quot;Looks good!&quot;);
2882             TestBotRunner.runPeriodicItems(mlBot);
2883             listServer.processIncoming();
2884 
2885             // This one should have been sent to list1 and list2
2886             conversations = mailmanList.conversations(Duration.ofDays(1));
2887             assertEquals(1, conversations.size());
2888             var reply = conversations.get(0).replies(conversations.get(0).first()).get(0);
2889             assertEquals(&quot;RFR: 1234: This is a pull request&quot;, reply.subject());
2890             assertEquals(pr.author().fullName(), reply.author().fullName().orElseThrow());
2891             assertEquals(noreplyAddress(archive), reply.author().address());
2892             assertEquals(listAddress1, reply.sender());
2893             assertEquals(List.of(listAddress1, listAddress2), reply.recipients());
2894         }
2895     }
<a name="37" id="anc37"></a><span class="line-added">2896 </span>
<span class="line-added">2897     @Test</span>
<span class="line-added">2898     void jsonArchive(TestInfo testInfo) throws IOException {</span>
<span class="line-added">2899         try (var credentials = new HostCredentials(testInfo);</span>
<span class="line-added">2900              var tempFolder = new TemporaryDirectory();</span>
<span class="line-added">2901              var archiveFolder = new TemporaryDirectory();</span>
<span class="line-added">2902              var webrevFolder = new TemporaryDirectory(false);</span>
<span class="line-added">2903              var listServer = new TestMailmanServer();</span>
<span class="line-added">2904              var webrevServer = new TestWebrevServer()) {</span>
<span class="line-added">2905             var author = credentials.getHostedRepository();</span>
<span class="line-added">2906             var archive = credentials.getHostedRepository();</span>
<span class="line-added">2907             var ignored = credentials.getHostedRepository();</span>
<span class="line-added">2908             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));</span>
<span class="line-added">2909             var censusBuilder = credentials.getCensusBuilder()</span>
<span class="line-added">2910                                            .addAuthor(author.forge().currentUser().id());</span>
<span class="line-added">2911             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);</span>
<span class="line-added">2912             var mlBot = MailingListBridgeBot.newBuilder()</span>
<span class="line-added">2913                                             .from(from)</span>
<span class="line-added">2914                                             .repo(author)</span>
<span class="line-added">2915                                             .archive(archive)</span>
<span class="line-added">2916                                             .censusRepo(censusBuilder.build())</span>
<span class="line-added">2917                                             .lists(List.of(new MailingListConfiguration(listAddress, Set.of())))</span>
<span class="line-added">2918                                             .ignoredUsers(Set.of(ignored.forge().currentUser().userName()))</span>
<span class="line-added">2919                                             .ignoredComments(Set.of())</span>
<span class="line-added">2920                                             .listArchive(listServer.getArchive())</span>
<span class="line-added">2921                                             .smtpServer(listServer.getSMTP())</span>
<span class="line-added">2922                                             .webrevStorageJSONRepository(archive)</span>
<span class="line-added">2923                                             .webrevStorageRef(&quot;webrev&quot;)</span>
<span class="line-added">2924                                             .webrevStorageBase(Path.of(&quot;test&quot;))</span>
<span class="line-added">2925                                             .webrevStorageBaseUri(webrevServer.uri())</span>
<span class="line-added">2926                                             .webrevGenerateHTML(false)</span>
<span class="line-added">2927                                             .webrevGenerateJSON(true)</span>
<span class="line-added">2928                                             .readyLabels(Set.of(&quot;rfr&quot;))</span>
<span class="line-added">2929                                             .readyComments(Map.of(ignored.forge().currentUser().userName(), Pattern.compile(&quot;ready&quot;)))</span>
<span class="line-added">2930                                             .issueTracker(URIBuilder.base(&quot;http://issues.test/browse/&quot;).build())</span>
<span class="line-added">2931                                             .headers(Map.of(&quot;Extra1&quot;, &quot;val1&quot;, &quot;Extra2&quot;, &quot;val2&quot;))</span>
<span class="line-added">2932                                             .sendInterval(Duration.ZERO)</span>
<span class="line-added">2933                                             .build();</span>
<span class="line-added">2934 </span>
<span class="line-added">2935             // Populate the projects repository</span>
<span class="line-added">2936             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType());</span>
<span class="line-added">2937             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();</span>
<span class="line-added">2938             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);</span>
<span class="line-added">2939             localRepo.push(masterHash, archive.url(), &quot;webrev&quot;, true);</span>
<span class="line-added">2940 </span>
<span class="line-added">2941             // Make a change with a corresponding PR</span>
<span class="line-added">2942             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;A simple change&quot;,</span>
<span class="line-added">2943                                                                &quot;Change msg\n\nWith several lines&quot;);</span>
<span class="line-added">2944             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);</span>
<span class="line-added">2945             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;1234: This is a pull request&quot;);</span>
<span class="line-added">2946             pr.setBody(&quot;This should not be ready&quot;);</span>
<span class="line-added">2947 </span>
<span class="line-added">2948             // Run an archive pass</span>
<span class="line-added">2949             TestBotRunner.runPeriodicItems(mlBot);</span>
<span class="line-added">2950 </span>
<span class="line-added">2951             // A PR that isn&#39;t ready for review should not be archived</span>
<span class="line-added">2952             Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);</span>
<span class="line-added">2953             assertFalse(archiveContains(archiveFolder.path(), &quot;This is a pull request&quot;));</span>
<span class="line-added">2954 </span>
<span class="line-added">2955             // Flag it as ready for review</span>
<span class="line-added">2956             pr.setBody(&quot;This should now be ready&quot;);</span>
<span class="line-added">2957             pr.addLabel(&quot;rfr&quot;);</span>
<span class="line-added">2958 </span>
<span class="line-added">2959             // Run another archive pass</span>
<span class="line-added">2960             TestBotRunner.runPeriodicItems(mlBot);</span>
<span class="line-added">2961 </span>
<span class="line-added">2962             // But it should still not be archived</span>
<span class="line-added">2963             Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);</span>
<span class="line-added">2964             assertFalse(archiveContains(archiveFolder.path(), &quot;This is a pull request&quot;));</span>
<span class="line-added">2965 </span>
<span class="line-added">2966             // Now post a general comment - not a ready marker</span>
<span class="line-added">2967             var ignoredPr = ignored.pullRequest(pr.id());</span>
<span class="line-added">2968             ignoredPr.addComment(&quot;hello there&quot;);</span>
<span class="line-added">2969 </span>
<span class="line-added">2970             // Run another archive pass</span>
<span class="line-added">2971             TestBotRunner.runPeriodicItems(mlBot);</span>
<span class="line-added">2972 </span>
<span class="line-added">2973             // It should still not be archived</span>
<span class="line-added">2974             Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);</span>
<span class="line-added">2975             assertFalse(archiveContains(archiveFolder.path(), &quot;This is a pull request&quot;));</span>
<span class="line-added">2976 </span>
<span class="line-added">2977             // Now post a ready comment</span>
<span class="line-added">2978             ignoredPr.addComment(&quot;ready&quot;);</span>
<span class="line-added">2979 </span>
<span class="line-added">2980             // Run another archive pass</span>
<span class="line-added">2981             TestBotRunner.runPeriodicItems(mlBot);</span>
<span class="line-added">2982 </span>
<span class="line-added">2983             // The archive should now contain an entry</span>
<span class="line-added">2984             Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);</span>
<span class="line-added">2985             assertTrue(archiveContains(archiveFolder.path(), &quot;This is a pull request&quot;));</span>
<span class="line-added">2986             assertTrue(archiveContains(archiveFolder.path(), &quot;This should now be ready&quot;));</span>
<span class="line-added">2987             assertTrue(archiveContains(archiveFolder.path(), &quot;Patch:&quot;));</span>
<span class="line-added">2988             assertTrue(archiveContains(archiveFolder.path(), &quot;Changes:&quot;));</span>
<span class="line-added">2989             assertTrue(archiveContains(archiveFolder.path(), &quot;Webrev:&quot;));</span>
<span class="line-added">2990             assertTrue(archiveContains(archiveFolder.path(), webrevServer.uri().toString()));</span>
<span class="line-added">2991             assertTrue(archiveContains(archiveFolder.path(), &quot;&amp;pr=&quot; + pr.id() + &quot;&amp;range=00&quot;));</span>
<span class="line-added">2992             assertTrue(archiveContains(archiveFolder.path(), &quot;Issue:&quot;));</span>
<span class="line-added">2993             assertTrue(archiveContains(archiveFolder.path(), &quot;http://issues.test/browse/TSTPRJ-1234&quot;));</span>
<span class="line-added">2994             assertTrue(archiveContains(archiveFolder.path(), &quot;Fetch:&quot;));</span>
<span class="line-added">2995             assertTrue(archiveContains(archiveFolder.path(), &quot;^ - Change msg&quot;));</span>
<span class="line-added">2996             assertFalse(archiveContains(archiveFolder.path(), &quot;With several lines&quot;));</span>
<span class="line-added">2997 </span>
<span class="line-added">2998             // The mailing list as well</span>
<span class="line-added">2999             listServer.processIncoming();</span>
<span class="line-added">3000             var mailmanServer = MailingListServerFactory.createMailmanServer(listServer.getArchive(), listServer.getSMTP(), Duration.ZERO);</span>
<span class="line-added">3001             var mailmanList = mailmanServer.getList(listAddress.address());</span>
<span class="line-added">3002             var conversations = mailmanList.conversations(Duration.ofDays(1));</span>
<span class="line-added">3003             assertEquals(1, conversations.size());</span>
<span class="line-added">3004             var mail = conversations.get(0).first();</span>
<span class="line-added">3005             assertEquals(&quot;RFR: 1234: This is a pull request&quot;, mail.subject());</span>
<span class="line-added">3006             assertEquals(pr.author().fullName(), mail.author().fullName().orElseThrow());</span>
<span class="line-added">3007             assertEquals(noreplyAddress(archive), mail.author().address());</span>
<span class="line-added">3008             assertEquals(listAddress, mail.sender());</span>
<span class="line-added">3009             assertEquals(&quot;val1&quot;, mail.headerValue(&quot;Extra1&quot;));</span>
<span class="line-added">3010             assertEquals(&quot;val2&quot;, mail.headerValue(&quot;Extra2&quot;));</span>
<span class="line-added">3011 </span>
<span class="line-added">3012             // And there should be a JSON version of a webrev</span>
<span class="line-added">3013             Repository.materialize(webrevFolder.path(), archive.url(), &quot;webrev&quot;);</span>
<span class="line-added">3014             var jsonDir = webrevFolder.path()</span>
<span class="line-added">3015                                       .resolve(author.name())</span>
<span class="line-added">3016                                       .resolve(pr.id())</span>
<span class="line-added">3017                                       .resolve(&quot;00&quot;);</span>
<span class="line-added">3018             assertTrue(Files.exists(jsonDir));</span>
<span class="line-added">3019             assertTrue(Files.isDirectory(jsonDir));</span>
<span class="line-added">3020 </span>
<span class="line-added">3021             var commitsFile = jsonDir.resolve(&quot;commits.json&quot;);</span>
<span class="line-added">3022             assertTrue(Files.exists(commitsFile));</span>
<span class="line-added">3023             var commits = JSON.parse(Files.readString(commitsFile));</span>
<span class="line-added">3024             assertEquals(1, commits.asArray().size());</span>
<span class="line-added">3025             var commit = commits.get(0);</span>
<span class="line-added">3026             assertEquals(editHash.hex(), commit.get(&quot;sha&quot;).asString());</span>
<span class="line-added">3027             assertEquals(&quot;Change msg\n\nWith several lines&quot;, commit.get(&quot;commit&quot;).get(&quot;message&quot;).asString());</span>
<span class="line-added">3028             assertEquals(1, commit.get(&quot;files&quot;).asArray().size());</span>
<span class="line-added">3029 </span>
<span class="line-added">3030             var metadataFile = jsonDir.resolve(&quot;metadata.json&quot;);</span>
<span class="line-added">3031             assertTrue(Files.exists(metadataFile));</span>
<span class="line-added">3032             var metadata = JSON.parse(Files.readString(metadataFile));</span>
<span class="line-added">3033             assertEquals(masterHash.hex(), metadata.get(&quot;base&quot;).get(&quot;sha&quot;).asString());</span>
<span class="line-added">3034             assertEquals(editHash.hex(), metadata.get(&quot;head&quot;).get(&quot;sha&quot;).asString());</span>
<span class="line-added">3035 </span>
<span class="line-added">3036             var comparisonFile = jsonDir.resolve(&quot;comparison.json&quot;);</span>
<span class="line-added">3037             assertTrue(Files.exists(comparisonFile));</span>
<span class="line-added">3038             var comparsion = JSON.parse(Files.readString(comparisonFile));</span>
<span class="line-added">3039             assertEquals(1, comparsion.get(&quot;files&quot;).asArray().size());</span>
<span class="line-added">3040             assertEquals(&quot;modified&quot;, comparsion.get(&quot;files&quot;).get(0).get(&quot;status&quot;).asString());</span>
<span class="line-added">3041             assertTrue(comparsion.get(&quot;files&quot;).get(0).get(&quot;patch&quot;).asString().contains(&quot;A simple change&quot;));</span>
<span class="line-added">3042 </span>
<span class="line-added">3043             var comments = pr.comments();</span>
<span class="line-added">3044             var webrevComments = comments.stream()</span>
<span class="line-added">3045                                          .filter(comment -&gt; comment.author().equals(author.forge().currentUser()))</span>
<span class="line-added">3046                                          .filter(comment -&gt; comment.body().contains(&quot;webrev&quot;))</span>
<span class="line-added">3047                                          .filter(comment -&gt; comment.body().contains(editHash.hex()))</span>
<span class="line-added">3048                                          .collect(Collectors.toList());</span>
<span class="line-added">3049             assertEquals(1, webrevComments.size());</span>
<span class="line-added">3050             var comment = webrevComments.get(0);</span>
<span class="line-added">3051             assertTrue(comment.body().contains(&quot;&amp;pr=&quot; + pr.id()));</span>
<span class="line-added">3052             assertTrue(comment.body().contains(&quot;&amp;range=00&quot;));</span>
<span class="line-added">3053 </span>
<span class="line-added">3054             // Add a comment</span>
<span class="line-added">3055             pr.addComment(&quot;This is a comment :smile:&quot;);</span>
<span class="line-added">3056 </span>
<span class="line-added">3057             // Add a comment from an ignored user as well</span>
<span class="line-added">3058             ignoredPr.addComment(&quot;Don&#39;t mind me&quot;);</span>
<span class="line-added">3059 </span>
<span class="line-added">3060             // Run another archive pass</span>
<span class="line-added">3061             TestBotRunner.runPeriodicItems(mlBot);</span>
<span class="line-added">3062 </span>
<span class="line-added">3063             // The archive should now contain the comment, but not the ignored one</span>
<span class="line-added">3064             Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);</span>
<span class="line-added">3065             assertTrue(archiveContains(archiveFolder.path(), &quot;This is a comment&quot;));</span>
<span class="line-added">3066             assertTrue(archiveContains(archiveFolder.path(), &quot;&gt; This should now be ready&quot;));</span>
<span class="line-added">3067             assertFalse(archiveContains(archiveFolder.path(), &quot;Don&#39;t mind me&quot;));</span>
<span class="line-added">3068 </span>
<span class="line-added">3069             listServer.processIncoming();</span>
<span class="line-added">3070             conversations = mailmanList.conversations(Duration.ofDays(1));</span>
<span class="line-added">3071             assertEquals(1, conversations.size());</span>
<span class="line-added">3072             assertEquals(2, conversations.get(0).allMessages().size());</span>
<span class="line-added">3073 </span>
<span class="line-added">3074             // Remove the rfr flag and post another comment</span>
<span class="line-added">3075             pr.addLabel(&quot;rfr&quot;);</span>
<span class="line-added">3076             pr.addComment(&quot;This is another comment&quot;);</span>
<span class="line-added">3077 </span>
<span class="line-added">3078             // Run another archive pass</span>
<span class="line-added">3079             TestBotRunner.runPeriodicItems(mlBot);</span>
<span class="line-added">3080 </span>
<span class="line-added">3081             // The archive should contain the additional comment</span>
<span class="line-added">3082             Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);</span>
<span class="line-added">3083             assertTrue(archiveContains(archiveFolder.path(), &quot;This is another comment&quot;));</span>
<span class="line-added">3084             assertTrue(archiveContains(archiveFolder.path(), &quot;&gt;&gt; This should now be ready&quot;));</span>
<span class="line-added">3085 </span>
<span class="line-added">3086             listServer.processIncoming();</span>
<span class="line-added">3087             conversations = mailmanList.conversations(Duration.ofDays(1));</span>
<span class="line-added">3088             assertEquals(1, conversations.size());</span>
<span class="line-added">3089             assertEquals(3, conversations.get(0).allMessages().size());</span>
<span class="line-added">3090             for (var newMail : conversations.get(0).allMessages()) {</span>
<span class="line-added">3091                 assertEquals(noreplyAddress(archive), newMail.author().address());</span>
<span class="line-added">3092                 assertEquals(listAddress, newMail.sender());</span>
<span class="line-added">3093             }</span>
<span class="line-added">3094             assertTrue(conversations.get(0).allMessages().get(2).body().contains(&quot;This is a comment ðŸ˜„&quot;));</span>
<span class="line-added">3095         }</span>
<span class="line-added">3096     }</span>
3097 }
<a name="38" id="anc38"></a><b style="font-size: large; color: red">--- EOF ---</b>
















































































</pre>
<input id="eof" value="38" type="hidden" />
</body>
</html>