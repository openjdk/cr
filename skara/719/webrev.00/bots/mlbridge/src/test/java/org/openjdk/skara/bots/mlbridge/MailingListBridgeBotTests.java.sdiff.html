<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Sdiff bots/mlbridge/src/test/java/org/openjdk/skara/bots/mlbridge/MailingListBridgeBotTests.java</title>
    <link rel="stylesheet" href="../../../../../../../../../../style.css" />
  </head>
<body>
<center><a href="MailingListArchiveReaderBotTests.java.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../../index.html" target="_top">index</a> next &gt;</center>    <h2>bots/mlbridge/src/test/java/org/openjdk/skara/bots/mlbridge/MailingListBridgeBotTests.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<table>
<tr valign="top">
<td>
<hr />
<pre>
  12  * version 2 for more details (a copy is included in the LICENSE file that
  13  * accompanied this code).
  14  *
  15  * You should have received a copy of the GNU General Public License version
  16  * 2 along with this work; if not, write to the Free Software Foundation,
  17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
  18  *
  19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
  20  * or visit www.oracle.com if you need additional information or have any
  21  * questions.
  22  */
  23 package org.openjdk.skara.bots.mlbridge;
  24 
  25 import org.openjdk.skara.email.EmailAddress;
  26 import org.openjdk.skara.forge.*;
  27 import org.openjdk.skara.issuetracker.Issue;
  28 import org.openjdk.skara.network.URIBuilder;
  29 import org.openjdk.skara.mailinglist.MailingListServerFactory;
  30 import org.openjdk.skara.test.*;
  31 import org.openjdk.skara.vcs.Repository;

  32 
  33 import org.junit.jupiter.api.*;
  34 
  35 import java.io.IOException;
  36 import java.nio.charset.StandardCharsets;
  37 import java.nio.file.*;
  38 import java.time.*;
  39 import java.util.*;
  40 import java.util.logging.Logger;
  41 import java.util.regex.Pattern;
  42 import java.util.stream.Collectors;
  43 
  44 import static org.junit.jupiter.api.Assertions.*;
  45 
  46 class MailingListBridgeBotTests {
  47     private final Logger log = Logger.getLogger(&quot;org.openjdk.skara.bots.mlbridge.test&quot;);
  48 
  49     private Optional&lt;String&gt; archiveContents(Path archive) {
  50         try {
  51             var mbox = Files.find(archive, 50, (path, attrs) -&gt; path.toString().endsWith(&quot;.mbox&quot;)).findAny();
</pre>
<hr />
<pre>
 110              var webrevFolder = new TemporaryDirectory();
 111              var listServer = new TestMailmanServer();
 112              var webrevServer = new TestWebrevServer()) {
 113             var author = credentials.getHostedRepository();
 114             var archive = credentials.getHostedRepository();
 115             var ignored = credentials.getHostedRepository();
 116             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
 117             var censusBuilder = credentials.getCensusBuilder()
 118                                            .addAuthor(author.forge().currentUser().id());
 119             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
 120             var mlBot = MailingListBridgeBot.newBuilder()
 121                                             .from(from)
 122                                             .repo(author)
 123                                             .archive(archive)
 124                                             .censusRepo(censusBuilder.build())
 125                                             .lists(List.of(new MailingListConfiguration(listAddress, Set.of())))
 126                                             .ignoredUsers(Set.of(ignored.forge().currentUser().userName()))
 127                                             .ignoredComments(Set.of())
 128                                             .listArchive(listServer.getArchive())
 129                                             .smtpServer(listServer.getSMTP())
<span class="line-modified"> 130                                             .webrevStorageRepository(archive)</span>
 131                                             .webrevStorageRef(&quot;webrev&quot;)
 132                                             .webrevStorageBase(Path.of(&quot;test&quot;))
 133                                             .webrevStorageBaseUri(webrevServer.uri())
 134                                             .readyLabels(Set.of(&quot;rfr&quot;))
 135                                             .readyComments(Map.of(ignored.forge().currentUser().userName(), Pattern.compile(&quot;ready&quot;)))
 136                                             .issueTracker(URIBuilder.base(&quot;http://issues.test/browse/&quot;).build())
 137                                             .headers(Map.of(&quot;Extra1&quot;, &quot;val1&quot;, &quot;Extra2&quot;, &quot;val2&quot;))
 138                                             .sendInterval(Duration.ZERO)
 139                                             .build();
 140 
 141             // Populate the projects repository
 142             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType());
 143             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
 144             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
 145             localRepo.push(masterHash, archive.url(), &quot;webrev&quot;, true);
 146 
 147             // Make a change with a corresponding PR
 148             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;A simple change&quot;,
 149                                                                &quot;Change msg\n\nWith several lines&quot;);
 150             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
</pre>
<hr />
<pre>
 277              var archiveFolder = new TemporaryDirectory();
 278              var webrevFolder = new TemporaryDirectory();
 279              var listServer = new TestMailmanServer();
 280              var webrevServer = new TestWebrevServer()) {
 281             var author = credentials.getHostedRepository();
 282             var archive = credentials.getHostedRepository();
 283             var ignored = credentials.getHostedRepository();
 284             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
 285             var censusBuilder = credentials.getCensusBuilder()
 286                                            .addAuthor(author.forge().currentUser().id());
 287             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
 288             var mlBot = MailingListBridgeBot.newBuilder()
 289                                             .from(from)
 290                                             .repo(author)
 291                                             .archive(archive)
 292                                             .censusRepo(censusBuilder.build())
 293                                             .lists(List.of(new MailingListConfiguration(listAddress, Set.of())))
 294                                             .ignoredUsers(Set.of(ignored.forge().currentUser().userName()))
 295                                             .listArchive(listServer.getArchive())
 296                                             .smtpServer(listServer.getSMTP())
<span class="line-modified"> 297                                             .webrevStorageRepository(archive)</span>
 298                                             .webrevStorageRef(&quot;webrev&quot;)
 299                                             .webrevStorageBase(Path.of(&quot;test&quot;))
 300                                             .webrevStorageBaseUri(webrevServer.uri())
 301                                             .issueTracker(URIBuilder.base(&quot;http://issues.test/browse/&quot;).build())
 302                                             .build();
 303 
 304             // Populate the projects repository
 305             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType());
 306             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
 307             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
 308             localRepo.push(masterHash, archive.url(), &quot;webrev&quot;, true);
 309 
 310             // Make a change with a corresponding PR
 311             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;A simple change&quot;,
 312                                                                &quot;Change msg\n\nWith several lines&quot;);
 313             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
 314             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;1234: This is a pull request&quot;);
 315             pr.setBody(&quot;This is now ready&quot;);
 316             pr.addLabel(&quot;rfr&quot;);
 317 
</pre>
<hr />
<pre>
 351              var archiveFolder = new TemporaryDirectory();
 352              var webrevFolder = new TemporaryDirectory();
 353              var listServer = new TestMailmanServer();
 354              var webrevServer = new TestWebrevServer()) {
 355             var author = credentials.getHostedRepository();
 356             var archive = credentials.getHostedRepository();
 357             var ignored = credentials.getHostedRepository();
 358             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
 359             var censusBuilder = credentials.getCensusBuilder()
 360                     .addAuthor(author.forge().currentUser().id());
 361             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
 362             var mlBot = MailingListBridgeBot.newBuilder()
 363                                             .from(from)
 364                                             .repo(author)
 365                                             .archive(archive)
 366                                             .censusRepo(censusBuilder.build())
 367                                             .lists(List.of(new MailingListConfiguration(listAddress, Set.of())))
 368                                             .ignoredUsers(Set.of(ignored.forge().currentUser().userName()))
 369                                             .listArchive(listServer.getArchive())
 370                                             .smtpServer(listServer.getSMTP())
<span class="line-modified"> 371                                             .webrevStorageRepository(archive)</span>
 372                                             .webrevStorageRef(&quot;webrev&quot;)
 373                                             .webrevStorageBase(Path.of(&quot;test&quot;))
 374                                             .webrevStorageBaseUri(webrevServer.uri())
 375                                             .issueTracker(URIBuilder.base(&quot;http://issues.test/browse/&quot;).build())
 376                                             .build();
 377 
 378             // Populate the projects repository
 379             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType());
 380             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
 381             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
 382             localRepo.push(masterHash, archive.url(), &quot;webrev&quot;, true);
 383 
 384             // Make a change with a corresponding PR with a date in the past
 385             var editFile = tempFolder.path().resolve(&quot;change.txt&quot;);
 386             Files.writeString(editFile, &quot;A simple change&quot;);
 387             localRepo.add(editFile);
 388             var commitDate = ZonedDateTime.of(2020, 3, 12, 0, 0, 0, 0, ZoneId.of(&quot;UTC&quot;));
 389             var editHash = localRepo.commit(&quot;An old change&quot;, &quot;duke&quot;, &quot;duke@openjdk.org&quot;, commitDate,
 390                              &quot;duke&quot;, &quot;duke@openjdk.org&quot;, commitDate);
 391             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
</pre>
<hr />
<pre>
 425              var archiveFolder = new TemporaryDirectory();
 426              var webrevFolder = new TemporaryDirectory();
 427              var listServer = new TestMailmanServer();
 428              var webrevServer = new TestWebrevServer()) {
 429             var author = credentials.getHostedRepository();
 430             var archive = credentials.getHostedRepository();
 431             var ignored = credentials.getHostedRepository();
 432             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
 433             var censusBuilder = credentials.getCensusBuilder()
 434                                            .addAuthor(author.forge().currentUser().id());
 435             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
 436             var mlBot = MailingListBridgeBot.newBuilder()
 437                                             .from(from)
 438                                             .repo(author)
 439                                             .archive(archive)
 440                                             .censusRepo(censusBuilder.build())
 441                                             .lists(List.of(new MailingListConfiguration(listAddress, Set.of())))
 442                                             .ignoredUsers(Set.of(ignored.forge().currentUser().userName()))
 443                                             .listArchive(listServer.getArchive())
 444                                             .smtpServer(listServer.getSMTP())
<span class="line-modified"> 445                                             .webrevStorageRepository(archive)</span>
 446                                             .webrevStorageRef(&quot;webrev&quot;)
 447                                             .webrevStorageBase(Path.of(&quot;test&quot;))
 448                                             .webrevStorageBaseUri(webrevServer.uri())
 449                                             .issueTracker(URIBuilder.base(&quot;http://issues.test/browse/&quot;).build())
 450                                             .build();
 451 
 452             // Populate the projects repository
 453             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType());
 454             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
 455             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
 456             localRepo.push(masterHash, archive.url(), &quot;webrev&quot;, true);
 457 
 458             // Make a change with a corresponding PR
 459             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;A simple change&quot;,
 460                                                                &quot;Change msg\n\nWith several lines&quot;);
 461             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
 462             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;1234: This is a pull request&quot;);
 463             pr.setBody(&quot;This should not be ready&quot;);
 464             pr.setState(Issue.State.CLOSED);
 465 
</pre>
<hr />
<pre>
 504              var archiveFolder = new TemporaryDirectory();
 505              var webrevFolder = new TemporaryDirectory();
 506              var listServer = new TestMailmanServer();
 507              var webrevServer = new TestWebrevServer()) {
 508             var author = credentials.getHostedRepository();
 509             var archive = credentials.getHostedRepository();
 510             var ignored = credentials.getHostedRepository();
 511             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
 512             var censusBuilder = credentials.getCensusBuilder()
 513                                            .addAuthor(author.forge().currentUser().id());
 514             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
 515             var mlBot = MailingListBridgeBot.newBuilder()
 516                                             .from(from)
 517                                             .repo(author)
 518                                             .archive(archive)
 519                                             .censusRepo(censusBuilder.build())
 520                                             .lists(List.of(new MailingListConfiguration(listAddress, Set.of())))
 521                                             .ignoredUsers(Set.of(ignored.forge().currentUser().userName()))
 522                                             .listArchive(listServer.getArchive())
 523                                             .smtpServer(listServer.getSMTP())
<span class="line-modified"> 524                                             .webrevStorageRepository(archive)</span>
 525                                             .webrevStorageRef(&quot;webrev&quot;)
 526                                             .webrevStorageBase(Path.of(&quot;test&quot;))
 527                                             .webrevStorageBaseUri(webrevServer.uri())
 528                                             .readyLabels(Set.of(&quot;rfr&quot;))
 529                                             .issueTracker(URIBuilder.base(&quot;http://issues.test/browse/&quot;).build())
 530                                             .build();
 531 
 532             // Populate the projects repository
 533             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType());
 534             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
 535             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
 536             localRepo.push(masterHash, archive.url(), &quot;webrev&quot;, true);
 537 
 538             // Make a change with a corresponding PR
 539             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;A simple change&quot;,
 540                                                                &quot;Change msg\n\nWith several lines&quot;);
 541             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
 542             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;1234: This is a pull request&quot;);
 543             pr.setBody(&quot;This should be ready&quot;);
 544 
</pre>
<hr />
<pre>
 581              var archiveFolder = new TemporaryDirectory();
 582              var webrevFolder = new TemporaryDirectory();
 583              var listServer = new TestMailmanServer();
 584              var webrevServer = new TestWebrevServer()) {
 585             var author = credentials.getHostedRepository();
 586             var archive = credentials.getHostedRepository();
 587             var ignored = credentials.getHostedRepository();
 588             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
 589             var censusBuilder = credentials.getCensusBuilder()
 590                                            .addAuthor(author.forge().currentUser().id());
 591             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
 592             var mlBot = MailingListBridgeBot.newBuilder()
 593                                             .from(from)
 594                                             .repo(author)
 595                                             .archive(archive)
 596                                             .censusRepo(censusBuilder.build())
 597                                             .lists(List.of(new MailingListConfiguration(listAddress, Set.of())))
 598                                             .ignoredUsers(Set.of(ignored.forge().currentUser().userName()))
 599                                             .listArchive(listServer.getArchive())
 600                                             .smtpServer(listServer.getSMTP())
<span class="line-modified"> 601                                             .webrevStorageRepository(archive)</span>
 602                                             .webrevStorageRef(&quot;webrev&quot;)
 603                                             .webrevStorageBase(Path.of(&quot;test&quot;))
 604                                             .webrevStorageBaseUri(webrevServer.uri())
 605                                             .readyLabels(Set.of(&quot;rfr&quot;))
 606                                             .issueTracker(URIBuilder.base(&quot;http://issues.test/browse/&quot;).build())
 607                                             .build();
 608 
 609             // Populate the projects repository
 610             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType());
 611             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
 612             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
 613             localRepo.push(masterHash, archive.url(), &quot;webrev&quot;, true);
 614 
 615             // Make a change with a corresponding PR
 616             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;A simple change&quot;,
 617                                                                &quot;Change msg\n\nWith several lines&quot;);
 618             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
 619             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;1234: This is a pull request&quot;);
 620             pr.setBody(&quot;This should be ready&quot;);
 621 
</pre>
<hr />
<pre>
 664              var archiveFolder = new TemporaryDirectory();
 665              var webrevFolder = new TemporaryDirectory();
 666              var listServer = new TestMailmanServer();
 667              var webrevServer = new TestWebrevServer()) {
 668             var author = credentials.getHostedRepository();
 669             var archive = credentials.getHostedRepository();
 670             var ignored = credentials.getHostedRepository();
 671             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
 672             var censusBuilder = credentials.getCensusBuilder()
 673                                            .addAuthor(author.forge().currentUser().id());
 674             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
 675             var mlBot = MailingListBridgeBot.newBuilder()
 676                                             .from(from)
 677                                             .repo(author)
 678                                             .archive(archive)
 679                                             .censusRepo(censusBuilder.build())
 680                                             .lists(List.of(new MailingListConfiguration(listAddress, Set.of())))
 681                                             .ignoredUsers(Set.of(ignored.forge().currentUser().userName()))
 682                                             .listArchive(listServer.getArchive())
 683                                             .smtpServer(listServer.getSMTP())
<span class="line-modified"> 684                                             .webrevStorageRepository(archive)</span>
 685                                             .webrevStorageRef(&quot;webrev&quot;)
 686                                             .webrevStorageBase(Path.of(&quot;test&quot;))
 687                                             .webrevStorageBaseUri(webrevServer.uri())
 688                                             .issueTracker(URIBuilder.base(&quot;http://issues.test/browse/&quot;).build())
 689                                             .build();
 690 
 691             // Populate the projects repository
 692             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType());
 693             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
 694             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
 695             localRepo.push(masterHash, archive.url(), &quot;webrev&quot;, true);
 696 
 697             // Make a change with a corresponding PR
 698             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;A simple change&quot;,
 699                                                                &quot;Change msg\n\nWith several lines&quot;);
 700             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
 701             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;Cannot automatically merge&quot;);
 702             pr.setBody(&quot;This is an automated merge PR&quot;);
 703             pr.addLabel(&quot;failed-auto-merge&quot;);
 704 
</pre>
<hr />
<pre>
 718              var tempFolder = new TemporaryDirectory();
 719              var archiveFolder = new TemporaryDirectory();
 720              var listServer = new TestMailmanServer();
 721              var webrevServer = new TestWebrevServer()) {
 722             var author = credentials.getHostedRepository();
 723             var archive = credentials.getHostedRepository();
 724             var ignored = credentials.getHostedRepository();
 725             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
 726             var censusBuilder = credentials.getCensusBuilder()
 727                                            .addAuthor(author.forge().currentUser().id());
 728             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
 729             var mlBot = MailingListBridgeBot.newBuilder()
 730                                             .from(from)
 731                                             .repo(author)
 732                                             .archive(archive)
 733                                             .censusRepo(censusBuilder.build())
 734                                             .lists(List.of(new MailingListConfiguration(listAddress, Set.of())))
 735                                             .ignoredUsers(Set.of(ignored.forge().currentUser().userName()))
 736                                             .listArchive(listServer.getArchive())
 737                                             .smtpServer(listServer.getSMTP())
<span class="line-modified"> 738                                             .webrevStorageRepository(archive)</span>
 739                                             .webrevStorageRef(&quot;webrev&quot;)
 740                                             .webrevStorageBase(Path.of(&quot;test&quot;))
 741                                             .webrevStorageBaseUri(webrevServer.uri())
 742                                             .issueTracker(URIBuilder.base(&quot;http://issues.test/browse/&quot;).build())
 743                                             .build();
 744 
 745             // Populate the projects repository
 746             var reviewFile = Path.of(&quot;reviewfile.txt&quot;);
 747             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType(), reviewFile);
 748             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
 749             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
 750             localRepo.push(masterHash, archive.url(), &quot;webrev&quot;, true);
 751 
 752             // Make a change with a corresponding PR
 753             var editHash = CheckableRepository.appendAndCommit(localRepo);
 754             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
 755             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
 756             pr.setBody(&quot;This is now ready&quot;);
 757             TestBotRunner.runPeriodicItems(mlBot);
 758             listServer.processIncoming();
</pre>
<hr />
<pre>
 812     void combineComments(TestInfo testInfo) throws IOException {
 813         try (var credentials = new HostCredentials(testInfo);
 814              var tempFolder = new TemporaryDirectory();
 815              var archiveFolder = new TemporaryDirectory();
 816              var listServer = new TestMailmanServer();
 817              var webrevServer = new TestWebrevServer()) {
 818             var author = credentials.getHostedRepository();
 819             var archive = credentials.getHostedRepository();
 820             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
 821             var censusBuilder = credentials.getCensusBuilder()
 822                                            .addAuthor(author.forge().currentUser().id());
 823             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
 824             var mlBot = MailingListBridgeBot.newBuilder()
 825                                             .from(from)
 826                                             .repo(author)
 827                                             .archive(archive)
 828                                             .censusRepo(censusBuilder.build())
 829                                             .lists(List.of(new MailingListConfiguration(listAddress, Set.of())))
 830                                             .listArchive(listServer.getArchive())
 831                                             .smtpServer(listServer.getSMTP())
<span class="line-modified"> 832                                             .webrevStorageRepository(archive)</span>
 833                                             .webrevStorageRef(&quot;webrev&quot;)
 834                                             .webrevStorageBase(Path.of(&quot;test&quot;))
 835                                             .webrevStorageBaseUri(webrevServer.uri())
 836                                             .issueTracker(URIBuilder.base(&quot;http://issues.test/browse/&quot;).build())
 837                                             .build();
 838 
 839             // Populate the projects repository
 840             var reviewFile = Path.of(&quot;reviewfile.txt&quot;);
 841             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType(), reviewFile);
 842             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
 843             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
 844             localRepo.push(masterHash, archive.url(), &quot;webrev&quot;, true);
 845 
 846             // Make a change with a corresponding PR
 847             var editHash = CheckableRepository.appendAndCommit(localRepo);
 848             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
 849             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
 850             pr.setBody(&quot;This is now ready&quot;);
 851             pr.addComment(&quot;Avoid combining&quot;);
 852 
</pre>
<hr />
<pre>
 907              var tempFolder = new TemporaryDirectory();
 908              var archiveFolder = new TemporaryDirectory();
 909              var listServer = new TestMailmanServer();
 910              var webrevServer = new TestWebrevServer()) {
 911             var author = credentials.getHostedRepository();
 912             var reviewer = credentials.getHostedRepository();
 913             var archive = credentials.getHostedRepository();
 914             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
 915             var censusBuilder = credentials.getCensusBuilder()
 916                                            .addReviewer(reviewer.forge().currentUser().id())
 917                                            .addAuthor(author.forge().currentUser().id());
 918             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
 919             var mlBot = MailingListBridgeBot.newBuilder()
 920                                             .from(from)
 921                                             .repo(author)
 922                                             .archive(archive)
 923                                             .censusRepo(censusBuilder.build())
 924                                             .lists(List.of(new MailingListConfiguration(listAddress, Set.of())))
 925                                             .listArchive(listServer.getArchive())
 926                                             .smtpServer(listServer.getSMTP())
<span class="line-modified"> 927                                             .webrevStorageRepository(archive)</span>
 928                                             .webrevStorageRef(&quot;webrev&quot;)
 929                                             .webrevStorageBase(Path.of(&quot;test&quot;))
 930                                             .webrevStorageBaseUri(webrevServer.uri())
 931                                             .issueTracker(URIBuilder.base(&quot;http://issues.test/browse/&quot;).build())
 932                                             .build();
 933 
 934             // Populate the projects repository
 935             var reviewFile = Path.of(&quot;reviewfile.txt&quot;);
 936             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType(), reviewFile);
 937             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
 938             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
 939             localRepo.push(masterHash, archive.url(), &quot;webrev&quot;, true);
 940 
 941             // Make a change with a corresponding PR
 942             var editHash = CheckableRepository.appendAndCommit(localRepo);
 943             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
 944             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
 945             pr.setBody(&quot;This is now ready&quot;);
 946             TestBotRunner.runPeriodicItems(mlBot);
 947             listServer.processIncoming();
</pre>
<hr />
<pre>
1036              var tempFolder = new TemporaryDirectory();
1037              var archiveFolder = new TemporaryDirectory();
1038              var listServer = new TestMailmanServer();
1039              var webrevServer = new TestWebrevServer()) {
1040             var author = credentials.getHostedRepository();
1041             var reviewer = credentials.getHostedRepository();
1042             var archive = credentials.getHostedRepository();
1043             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
1044             var censusBuilder = credentials.getCensusBuilder()
1045                                            .addReviewer(reviewer.forge().currentUser().id())
1046                                            .addAuthor(author.forge().currentUser().id());
1047             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
1048             var mlBot = MailingListBridgeBot.newBuilder()
1049                                             .from(from)
1050                                             .repo(author)
1051                                             .archive(archive)
1052                                             .censusRepo(censusBuilder.build())
1053                                             .lists(List.of(new MailingListConfiguration(listAddress, Set.of())))
1054                                             .listArchive(listServer.getArchive())
1055                                             .smtpServer(listServer.getSMTP())
<span class="line-modified">1056                                             .webrevStorageRepository(archive)</span>
1057                                             .webrevStorageRef(&quot;webrev&quot;)
1058                                             .webrevStorageBase(Path.of(&quot;test&quot;))
1059                                             .webrevStorageBaseUri(webrevServer.uri())
1060                                             .issueTracker(URIBuilder.base(&quot;http://issues.test/browse/&quot;).build())
1061                                             .build();
1062 
1063             // Populate the projects repository
1064             var reviewFile = Path.of(&quot;reviewfile.txt&quot;);
1065             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType(), reviewFile);
1066             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
1067             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
1068             localRepo.push(masterHash, archive.url(), &quot;webrev&quot;, true);
1069 
1070             // Make a change with a corresponding PR
1071             var editHash = CheckableRepository.appendAndCommit(localRepo);
1072             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
1073             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
1074             pr.setBody(&quot;This is now ready&quot;);
1075             TestBotRunner.runPeriodicItems(mlBot);
1076             listServer.processIncoming();
</pre>
<hr />
<pre>
1099              var tempFolder = new TemporaryDirectory();
1100              var archiveFolder = new TemporaryDirectory();
1101              var listServer = new TestMailmanServer();
1102              var webrevServer = new TestWebrevServer()) {
1103             var author = credentials.getHostedRepository();
1104             var reviewer = credentials.getHostedRepository();
1105             var archive = credentials.getHostedRepository();
1106             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
1107             var censusBuilder = credentials.getCensusBuilder()
1108                                            .addReviewer(reviewer.forge().currentUser().id())
1109                                            .addAuthor(author.forge().currentUser().id());
1110             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
1111             var mlBot = MailingListBridgeBot.newBuilder()
1112                                             .from(from)
1113                                             .repo(author)
1114                                             .archive(archive)
1115                                             .censusRepo(censusBuilder.build())
1116                                             .lists(List.of(new MailingListConfiguration(listAddress, Set.of())))
1117                                             .listArchive(listServer.getArchive())
1118                                             .smtpServer(listServer.getSMTP())
<span class="line-modified">1119                                             .webrevStorageRepository(archive)</span>
1120                                             .webrevStorageRef(&quot;webrev&quot;)
1121                                             .webrevStorageBase(Path.of(&quot;test&quot;))
1122                                             .webrevStorageBaseUri(webrevServer.uri())
1123                                             .issueTracker(URIBuilder.base(&quot;http://issues.test/browse/&quot;).build())
1124                                             .build();
1125 
1126             // Populate the projects repository
1127             var reviewFile = Path.of(&quot;reviewfile.txt&quot;);
1128             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType(), reviewFile);
1129             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
1130             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
1131             localRepo.push(masterHash, archive.url(), &quot;webrev&quot;, true);
1132 
1133             // Make a change with a corresponding PR
1134             var editHash = CheckableRepository.appendAndCommit(localRepo);
1135             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
1136             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
1137             pr.setBody(&quot;This is now ready&quot;);
1138             TestBotRunner.runPeriodicItems(mlBot);
1139             listServer.processIncoming();
</pre>
<hr />
<pre>
1163              var tempFolder = new TemporaryDirectory();
1164              var archiveFolder = new TemporaryDirectory();
1165              var listServer = new TestMailmanServer();
1166              var webrevServer = new TestWebrevServer()) {
1167             var author = credentials.getHostedRepository();
1168             var reviewer = credentials.getHostedRepository();
1169             var archive = credentials.getHostedRepository();
1170             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
1171             var censusBuilder = credentials.getCensusBuilder()
1172                                            .addReviewer(reviewer.forge().currentUser().id())
1173                                            .addAuthor(author.forge().currentUser().id());
1174             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
1175             var mlBot = MailingListBridgeBot.newBuilder()
1176                                             .from(from)
1177                                             .repo(author)
1178                                             .archive(archive)
1179                                             .censusRepo(censusBuilder.build())
1180                                             .lists(List.of(new MailingListConfiguration(listAddress, Set.of())))
1181                                             .listArchive(listServer.getArchive())
1182                                             .smtpServer(listServer.getSMTP())
<span class="line-modified">1183                                             .webrevStorageRepository(archive)</span>
1184                                             .webrevStorageRef(&quot;webrev&quot;)
1185                                             .webrevStorageBase(Path.of(&quot;test&quot;))
1186                                             .webrevStorageBaseUri(webrevServer.uri())
1187                                             .issueTracker(URIBuilder.base(&quot;http://issues.test/browse/&quot;).build())
1188                                             .build();
1189 
1190             // Populate the projects repository
1191             var reviewFile = Path.of(&quot;reviewfile.txt&quot;);
1192             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType(), reviewFile);
1193             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
1194             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
1195             localRepo.push(masterHash, archive.url(), &quot;webrev&quot;, true);
1196 
1197             // Make a change with a corresponding PR
1198             var editHash = CheckableRepository.appendAndCommit(localRepo);
1199             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
1200             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
1201             pr.setBody(&quot;This is now ready&quot;);
1202             TestBotRunner.runPeriodicItems(mlBot);
1203             listServer.processIncoming();
</pre>
<hr />
<pre>
1228              var tempFolder = new TemporaryDirectory();
1229              var archiveFolder = new TemporaryDirectory();
1230              var listServer = new TestMailmanServer();
1231              var webrevServer = new TestWebrevServer()) {
1232             var author = credentials.getHostedRepository();
1233             var reviewer = credentials.getHostedRepository();
1234             var archive = credentials.getHostedRepository();
1235             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
1236             var censusBuilder = credentials.getCensusBuilder()
1237                                            .addReviewer(reviewer.forge().currentUser().id())
1238                                            .addAuthor(author.forge().currentUser().id());
1239             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
1240             var mlBot = MailingListBridgeBot.newBuilder()
1241                                             .from(from)
1242                                             .repo(author)
1243                                             .archive(archive)
1244                                             .censusRepo(censusBuilder.build())
1245                                             .lists(List.of(new MailingListConfiguration(listAddress, Set.of())))
1246                                             .listArchive(listServer.getArchive())
1247                                             .smtpServer(listServer.getSMTP())
<span class="line-modified">1248                                             .webrevStorageRepository(archive)</span>
1249                                             .webrevStorageRef(&quot;webrev&quot;)
1250                                             .webrevStorageBase(Path.of(&quot;test&quot;))
1251                                             .webrevStorageBaseUri(webrevServer.uri())
1252                                             .issueTracker(URIBuilder.base(&quot;http://issues.test/browse/&quot;).build())
1253                                             .build();
1254 
1255             // Populate the projects repository
1256             var reviewFile = Path.of(&quot;reviewfile.txt&quot;);
1257             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType(), reviewFile);
1258             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
1259             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
1260             localRepo.push(masterHash, archive.url(), &quot;webrev&quot;, true);
1261 
1262             // Make a change with a corresponding PR
1263             var editHash = CheckableRepository.appendAndCommit(localRepo);
1264             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
1265             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
1266             pr.setBody(&quot;This is now ready&quot;);
1267             TestBotRunner.runPeriodicItems(mlBot);
1268             listServer.processIncoming();
</pre>
<hr />
<pre>
1291     void reviewContext(TestInfo testInfo) throws IOException {
1292         try (var credentials = new HostCredentials(testInfo);
1293              var tempFolder = new TemporaryDirectory();
1294              var archiveFolder = new TemporaryDirectory();
1295              var listServer = new TestMailmanServer();
1296              var webrevServer = new TestWebrevServer()) {
1297             var author = credentials.getHostedRepository();
1298             var archive = credentials.getHostedRepository();
1299             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
1300             var censusBuilder = credentials.getCensusBuilder()
1301                                            .addAuthor(author.forge().currentUser().id());
1302             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
1303             var mlBot = MailingListBridgeBot.newBuilder()
1304                                             .from(from)
1305                                             .repo(author)
1306                                             .archive(archive)
1307                                             .censusRepo(censusBuilder.build())
1308                                             .lists(List.of(new MailingListConfiguration(listAddress, Set.of())))
1309                                             .listArchive(listServer.getArchive())
1310                                             .smtpServer(listServer.getSMTP())
<span class="line-modified">1311                                             .webrevStorageRepository(archive)</span>
1312                                             .webrevStorageRef(&quot;webrev&quot;)
1313                                             .webrevStorageBase(Path.of(&quot;test&quot;))
1314                                             .webrevStorageBaseUri(webrevServer.uri())
1315                                             .issueTracker(URIBuilder.base(&quot;http://issues.test/browse/&quot;).build())
1316                                             .build();
1317 
1318             // Populate the projects repository
1319             var reviewFile = Path.of(&quot;reviewfile.txt&quot;);
1320             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType(), reviewFile);
1321             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
1322             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
1323             localRepo.push(masterHash, archive.url(), &quot;webrev&quot;, true);
1324 
1325             // Make a change with a corresponding PR
1326             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;Line 1\nLine 2\nLine 3\nLine 4&quot;);
1327             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
1328             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
1329             pr.setBody(&quot;This is now ready&quot;);
1330             TestBotRunner.runPeriodicItems(mlBot);
1331             listServer.processIncoming();
</pre>
<hr />
<pre>
1348     void multipleReviewContexts(TestInfo testInfo) throws IOException {
1349         try (var credentials = new HostCredentials(testInfo);
1350              var tempFolder = new TemporaryDirectory();
1351              var archiveFolder = new TemporaryDirectory();
1352              var listServer = new TestMailmanServer();
1353              var webrevServer = new TestWebrevServer()) {
1354             var author = credentials.getHostedRepository();
1355             var archive = credentials.getHostedRepository();
1356             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
1357             var censusBuilder = credentials.getCensusBuilder()
1358                                            .addAuthor(author.forge().currentUser().id());
1359             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
1360             var mlBot = MailingListBridgeBot.newBuilder()
1361                                             .from(from)
1362                                             .repo(author)
1363                                             .archive(archive)
1364                                             .censusRepo(censusBuilder.build())
1365                                             .lists(List.of(new MailingListConfiguration(listAddress, Set.of())))
1366                                             .listArchive(listServer.getArchive())
1367                                             .smtpServer(listServer.getSMTP())
<span class="line-modified">1368                                             .webrevStorageRepository(archive)</span>
1369                                             .webrevStorageRef(&quot;webrev&quot;)
1370                                             .webrevStorageBase(Path.of(&quot;test&quot;))
1371                                             .webrevStorageBaseUri(webrevServer.uri())
1372                                             .issueTracker(URIBuilder.base(&quot;http://issues.test/browse/&quot;).build())
1373                                             .build();
1374 
1375             // Populate the projects repository
1376             var reviewFile = Path.of(&quot;reviewfile.txt&quot;);
1377             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType(), reviewFile);
1378             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
1379             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
1380             localRepo.push(masterHash, archive.url(), &quot;webrev&quot;, true);
1381             var initialHash = CheckableRepository.appendAndCommit(localRepo,
1382                                                                   &quot;Line 0.1\nLine 0.2\nLine 0.3\nLine 0.4\n&quot; +
1383                                                                           &quot;Line 1\nLine 2\nLine 3\nLine 4\n&quot; +
1384                                                                           &quot;Line 5\nLine 6\nLine 7\nLine 8\n&quot; +
1385                                                                           &quot;Line 8.1\nLine 8.2\nLine 8.3\nLine 8.4\n&quot; +
1386                                                                           &quot;Line 9\nLine 10\nLine 11\nLine 12\n&quot; +
1387                                                                           &quot;Line 13\nLine 14\nLine 15\nLine 16\n&quot;);
1388             localRepo.push(initialHash, author.url(), &quot;master&quot;);
</pre>
<hr />
<pre>
1424     void filterComments(TestInfo testInfo) throws IOException {
1425         try (var credentials = new HostCredentials(testInfo);
1426              var tempFolder = new TemporaryDirectory();
1427              var archiveFolder = new TemporaryDirectory();
1428              var listServer = new TestMailmanServer();
1429              var webrevServer = new TestWebrevServer()) {
1430             var author = credentials.getHostedRepository();
1431             var archive = credentials.getHostedRepository();
1432             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
1433             var censusBuilder = credentials.getCensusBuilder()
1434                                            .addAuthor(author.forge().currentUser().id());
1435             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
1436             var mlBot = MailingListBridgeBot.newBuilder()
1437                                             .from(from)
1438                                             .repo(author)
1439                                             .archive(archive)
1440                                             .censusRepo(censusBuilder.build())
1441                                             .lists(List.of(new MailingListConfiguration(listAddress, Set.of())))
1442                                             .listArchive(listServer.getArchive())
1443                                             .smtpServer(listServer.getSMTP())
<span class="line-modified">1444                                             .webrevStorageRepository(archive)</span>
1445                                             .webrevStorageRef(&quot;webrev&quot;)
1446                                             .webrevStorageBase(Path.of(&quot;test&quot;))
1447                                             .webrevStorageBaseUri(webrevServer.uri())
1448                                             .issueTracker(URIBuilder.base(&quot;http://issues.test/browse/&quot;).build())
1449                                             .build();
1450 
1451             // Populate the projects repository
1452             var reviewFile = Path.of(&quot;reviewfile.txt&quot;);
1453             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType(), reviewFile);
1454             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
1455             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
1456             localRepo.push(masterHash, archive.url(), &quot;webrev&quot;, true);
1457 
1458             // Make a change with a corresponding PR
1459             var editHash = CheckableRepository.appendAndCommit(localRepo);
1460             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
1461             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
1462             pr.setBody(&quot;This is now ready\n&lt;!-- this is a comment --&gt;\nAnd this is not\n&quot; +
1463                                &quot;&lt;!-- Anything below this marker will be hidden --&gt;\nStatus stuff&quot;);
1464 
</pre>
<hr />
<pre>
1490         try (var credentials = new HostCredentials(testInfo);
1491              var tempFolder = new TemporaryDirectory();
1492              var archiveFolder = new TemporaryDirectory();
1493              var listServer = new TestMailmanServer();
1494              var webrevServer = new TestWebrevServer()) {
1495             var author = credentials.getHostedRepository();
1496             var archive = credentials.getHostedRepository();
1497             var commenter = credentials.getHostedRepository();
1498             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
1499             var censusBuilder = credentials.getCensusBuilder()
1500                                            .addAuthor(author.forge().currentUser().id());
1501             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
1502             var mlBot = MailingListBridgeBot.newBuilder()
1503                                             .from(from)
1504                                             .repo(author)
1505                                             .archive(archive)
1506                                             .censusRepo(censusBuilder.build())
1507                                             .lists(List.of(new MailingListConfiguration(listAddress, Set.of())))
1508                                             .listArchive(listServer.getArchive())
1509                                             .smtpServer(listServer.getSMTP())
<span class="line-modified">1510                                             .webrevStorageRepository(archive)</span>
1511                                             .webrevStorageRef(&quot;webrev&quot;)
1512                                             .webrevStorageBase(Path.of(&quot;test&quot;))
1513                                             .webrevStorageBaseUri(webrevServer.uri())
1514                                             .issueTracker(URIBuilder.base(&quot;http://issues.test/browse/&quot;).build())
1515                                             .build();
1516 
1517             // Populate the projects repository
1518             var reviewFile = Path.of(&quot;reviewfile.txt&quot;);
1519             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType(), reviewFile);
1520             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
1521             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
1522             localRepo.push(masterHash, archive.url(), &quot;webrev&quot;, true);
1523 
1524             // Make a change with a corresponding PR
1525             var editHash = CheckableRepository.appendAndCommit(localRepo);
1526             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
1527             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
1528             pr.setBody(&quot;This is now ready&quot;);
1529 
1530             // Run an archive pass
</pre>
<hr />
<pre>
1620     void rebased(TestInfo testInfo) throws IOException {
1621         try (var credentials = new HostCredentials(testInfo);
1622              var tempFolder = new TemporaryDirectory();
1623              var archiveFolder = new TemporaryDirectory();
1624              var listServer = new TestMailmanServer();
1625              var webrevServer = new TestWebrevServer()) {
1626             var author = credentials.getHostedRepository();
1627             var archive = credentials.getHostedRepository();
1628             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
1629             var censusBuilder = credentials.getCensusBuilder()
1630                                            .addAuthor(author.forge().currentUser().id());
1631             var sender = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
1632             var mlBot = MailingListBridgeBot.newBuilder()
1633                                             .from(sender)
1634                                             .repo(author)
1635                                             .archive(archive)
1636                                             .censusRepo(censusBuilder.build())
1637                                             .lists(List.of(new MailingListConfiguration(listAddress, Set.of())))
1638                                             .listArchive(listServer.getArchive())
1639                                             .smtpServer(listServer.getSMTP())
<span class="line-modified">1640                                             .webrevStorageRepository(archive)</span>
1641                                             .webrevStorageRef(&quot;webrev&quot;)
1642                                             .webrevStorageBase(Path.of(&quot;test&quot;))
1643                                             .webrevStorageBaseUri(webrevServer.uri())
1644                                             .issueTracker(URIBuilder.base(&quot;http://issues.test/browse/&quot;).build())
1645                                             .build();
1646 
1647             // Populate the projects repository
1648             var reviewFile = Path.of(&quot;reviewfile.txt&quot;);
1649             var localRepo = CheckableRepository.init(tempFolder.path().resolve(&quot;first&quot;), author.repositoryType(), reviewFile);
1650             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
1651             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
1652             localRepo.push(masterHash, archive.url(), &quot;webrev&quot;, true);
1653 
1654             // Make a change with a corresponding PR
1655             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;A line&quot;, &quot;Original msg&quot;);
1656             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
1657             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
1658             pr.setBody(&quot;This is now ready&quot;);
1659 
1660             // Run an archive pass
</pre>
<hr />
<pre>
1717         try (var credentials = new HostCredentials(testInfo);
1718              var tempFolder = new TemporaryDirectory();
1719              var archiveFolder = new TemporaryDirectory();
1720              var listServer = new TestMailmanServer();
1721              var webrevServer = new TestWebrevServer()) {
1722             var author = credentials.getHostedRepository();
1723             var archive = credentials.getHostedRepository();
1724             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
1725             var censusBuilder = credentials.getCensusBuilder()
1726                                            .addAuthor(author.forge().currentUser().id());
1727             var sender = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
1728             var mlBot = MailingListBridgeBot.newBuilder()
1729                                             .from(sender)
1730                                             .repo(author)
1731                                             .archive(archive)
1732                                             .archiveRef(&quot;archive&quot;)
1733                                             .censusRepo(censusBuilder.build())
1734                                             .lists(List.of(new MailingListConfiguration(listAddress, Set.of())))
1735                                             .listArchive(listServer.getArchive())
1736                                             .smtpServer(listServer.getSMTP())
<span class="line-modified">1737                                             .webrevStorageRepository(archive)</span>
1738                                             .webrevStorageRef(&quot;webrev&quot;)
1739                                             .webrevStorageBase(Path.of(&quot;test&quot;))
1740                                             .webrevStorageBaseUri(webrevServer.uri())
1741                                             .issueTracker(URIBuilder.base(&quot;http://issues.test/browse/&quot;).build())
1742                                             .build();
1743 
1744             // Populate the projects repository
1745             var reviewFile = Path.of(&quot;reviewfile.txt&quot;);
1746             var localRepo = CheckableRepository.init(tempFolder.path().resolve(&quot;first&quot;), author.repositoryType(), reviewFile);
1747             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
1748             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
1749             localRepo.push(masterHash, archive.url(), &quot;webrev&quot;, true);
1750             localRepo.push(masterHash, archive.url(), &quot;archive&quot;, true);
1751 
1752             // Make a change with a corresponding PR
1753             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;A line&quot;, &quot;Original msg&quot;);
1754             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
1755             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
1756             pr.setBody(&quot;This is now ready&quot;);
1757 
</pre>
<hr />
<pre>
1807              var tempFolder = new TemporaryDirectory();
1808              var archiveFolder = new TemporaryDirectory();
1809              var listServer = new TestMailmanServer();
1810              var webrevServer = new TestWebrevServer()) {
1811             var author = credentials.getHostedRepository();
1812             var archive = credentials.getHostedRepository();
1813             var commenter = credentials.getHostedRepository();
1814             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
1815             var censusBuilder = credentials.getCensusBuilder()
1816                                            .addAuthor(author.forge().currentUser().id());
1817             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
1818             var mlBot = MailingListBridgeBot.newBuilder()
1819                                             .from(from)
1820                                             .repo(author)
1821                                             .archive(archive)
1822                                             .archiveRef(&quot;archive&quot;)
1823                                             .censusRepo(censusBuilder.build())
1824                                             .lists(List.of(new MailingListConfiguration(listAddress, Set.of())))
1825                                             .listArchive(listServer.getArchive())
1826                                             .smtpServer(listServer.getSMTP())
<span class="line-modified">1827                                             .webrevStorageRepository(archive)</span>
1828                                             .webrevStorageRef(&quot;webrev&quot;)
1829                                             .webrevStorageBase(Path.of(&quot;test&quot;))
1830                                             .webrevStorageBaseUri(webrevServer.uri())
1831                                             .issueTracker(URIBuilder.base(&quot;http://issues.test/browse/&quot;).build())
1832                                             .build();
1833 
1834             // Populate the projects repository
1835             var reviewFile = Path.of(&quot;reviewfile.txt&quot;);
1836             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType(), reviewFile);
1837             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
1838             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
1839             localRepo.push(masterHash, archive.url(), &quot;archive&quot;, true);
1840             localRepo.push(masterHash, archive.url(), &quot;webrev&quot;, true);
1841 
1842             // Create a diverging branch
1843             var editOnlyFile = Path.of(&quot;editonly.txt&quot;);
1844             Files.writeString(localRepo.root().resolve(editOnlyFile), &quot;Only added in the edit&quot;);
1845             localRepo.add(editOnlyFile);
1846             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;Edited&quot;);
1847             localRepo.push(editHash, author.url(), &quot;edit&quot;);
</pre>
<hr />
<pre>
1893              var tempFolder = new TemporaryDirectory();
1894              var archiveFolder = new TemporaryDirectory();
1895              var listServer = new TestMailmanServer();
1896              var webrevServer = new TestWebrevServer()) {
1897             var author = credentials.getHostedRepository();
1898             var archive = credentials.getHostedRepository();
1899             var commenter = credentials.getHostedRepository();
1900             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
1901             var censusBuilder = credentials.getCensusBuilder()
1902                                            .addAuthor(author.forge().currentUser().id());
1903             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
1904             var mlBot = MailingListBridgeBot.newBuilder()
1905                                             .from(from)
1906                                             .repo(author)
1907                                             .archive(archive)
1908                                             .archiveRef(&quot;archive&quot;)
1909                                             .censusRepo(censusBuilder.build())
1910                                             .lists(List.of(new MailingListConfiguration(listAddress, Set.of())))
1911                                             .listArchive(listServer.getArchive())
1912                                             .smtpServer(listServer.getSMTP())
<span class="line-modified">1913                                             .webrevStorageRepository(archive)</span>
1914                                             .webrevStorageRef(&quot;webrev&quot;)
1915                                             .webrevStorageBase(Path.of(&quot;test&quot;))
1916                                             .webrevStorageBaseUri(webrevServer.uri())
1917                                             .issueTracker(URIBuilder.base(&quot;http://issues.test/browse/&quot;).build())
1918                                             .build();
1919 
1920             // Populate the projects repository
1921             var reviewFile = Path.of(&quot;reviewfile.txt&quot;);
1922             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType(), reviewFile);
1923             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
1924             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
1925             localRepo.push(masterHash, archive.url(), &quot;archive&quot;, true);
1926             localRepo.push(masterHash, archive.url(), &quot;webrev&quot;, true);
1927 
1928             // Create a merge
1929             var editOnlyFile = Path.of(&quot;editonly.txt&quot;);
1930             Files.writeString(localRepo.root().resolve(editOnlyFile), &quot;Only added in the edit&quot;);
1931             localRepo.add(editOnlyFile);
1932             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;Edited&quot;);
1933             localRepo.checkout(masterHash, true);
</pre>
<hr />
<pre>
1965              var tempFolder = new TemporaryDirectory();
1966              var archiveFolder = new TemporaryDirectory();
1967              var listServer = new TestMailmanServer();
1968              var webrevServer = new TestWebrevServer()) {
1969             var author = credentials.getHostedRepository();
1970             var archive = credentials.getHostedRepository();
1971             var commenter = credentials.getHostedRepository();
1972             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
1973             var censusBuilder = credentials.getCensusBuilder()
1974                                            .addAuthor(author.forge().currentUser().id());
1975             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
1976             var mlBot = MailingListBridgeBot.newBuilder()
1977                                             .from(from)
1978                                             .repo(author)
1979                                             .archive(archive)
1980                                             .archiveRef(&quot;archive&quot;)
1981                                             .censusRepo(censusBuilder.build())
1982                                             .lists(List.of(new MailingListConfiguration(listAddress, Set.of())))
1983                                             .listArchive(listServer.getArchive())
1984                                             .smtpServer(listServer.getSMTP())
<span class="line-modified">1985                                             .webrevStorageRepository(archive)</span>
1986                                             .webrevStorageRef(&quot;webrev&quot;)
1987                                             .webrevStorageBase(Path.of(&quot;test&quot;))
1988                                             .webrevStorageBaseUri(webrevServer.uri())
1989                                             .issueTracker(URIBuilder.base(&quot;http://issues.test/browse/&quot;).build())
1990                                             .build();
1991 
1992             // Populate the projects repository
1993             var reviewFile = Path.of(&quot;reviewfile.txt&quot;);
1994             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType(), reviewFile);
1995             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
1996             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
1997             localRepo.push(masterHash, archive.url(), &quot;archive&quot;, true);
1998             localRepo.push(masterHash, archive.url(), &quot;webrev&quot;, true);
1999 
2000             // Create a merge
2001             var editOnlyFile = Path.of(&quot;editonly.txt&quot;);
2002             Files.writeString(localRepo.root().resolve(editOnlyFile), &quot;Only added in the edit&quot;);
2003             localRepo.add(editOnlyFile);
2004             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;Edited&quot;, &quot;Commit in edit branch&quot;);
2005             localRepo.checkout(masterHash, true);
</pre>
<hr />
<pre>
2036              var archiveFolder = new TemporaryDirectory();
2037              var webrevFolder = new TemporaryDirectory();
2038              var listServer = new TestMailmanServer();
2039              var webrevServer = new TestWebrevServer()) {
2040             var author = credentials.getHostedRepository();
2041             var archive = credentials.getHostedRepository();
2042             var ignored = credentials.getHostedRepository();
2043             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
2044             var censusBuilder = credentials.getCensusBuilder()
2045                                            .addAuthor(author.forge().currentUser().id());
2046             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
2047             var mlBot = MailingListBridgeBot.newBuilder()
2048                                             .from(from)
2049                                             .repo(author)
2050                                             .archive(archive)
2051                                             .censusRepo(censusBuilder.build())
2052                                             .lists(List.of(new MailingListConfiguration(listAddress, Set.of())))
2053                                             .ignoredUsers(Set.of(ignored.forge().currentUser().userName()))
2054                                             .listArchive(listServer.getArchive())
2055                                             .smtpServer(listServer.getSMTP())
<span class="line-modified">2056                                             .webrevStorageRepository(archive)</span>
2057                                             .webrevStorageRef(&quot;webrev&quot;)
2058                                             .webrevStorageBase(Path.of(&quot;test&quot;))
2059                                             .webrevStorageBaseUri(webrevServer.uri())
2060                                             .issueTracker(URIBuilder.base(&quot;http://issues.test/browse/&quot;).build())
2061                                             .build();
2062 
2063             // Populate the projects repository
2064             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType());
2065             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
2066             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
2067             localRepo.push(masterHash, archive.url(), &quot;webrev&quot;, true);
2068 
2069             // Make a change with a corresponding PR
2070             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;A simple change&quot;,
2071                                                                &quot;Change msg\n\nWith several lines&quot;);
2072             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
2073             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
2074 
2075             // Flag it as ready for review
2076             pr.setBody(&quot;This should now be ready&quot;);
</pre>
<hr />
<pre>
2116              var tempFolder = new TemporaryDirectory();
2117              var archiveFolder = new TemporaryDirectory();
2118              var listServer = new TestMailmanServer();
2119              var webrevServer = new TestWebrevServer()) {
2120             var author = credentials.getHostedRepository();
2121             var archive = credentials.getHostedRepository();
2122             var reviewer = credentials.getHostedRepository();
2123             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
2124             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
2125             var censusBuilder = credentials.getCensusBuilder()
2126                                            .addReviewer(reviewer.forge().currentUser().id())
2127                                            .addAuthor(author.forge().currentUser().id());
2128             var mlBot = MailingListBridgeBot.newBuilder()
2129                                             .from(from)
2130                                             .repo(author)
2131                                             .archive(archive)
2132                                             .censusRepo(censusBuilder.build())
2133                                             .lists(List.of(new MailingListConfiguration(listAddress, Set.of())))
2134                                             .listArchive(listServer.getArchive())
2135                                             .smtpServer(listServer.getSMTP())
<span class="line-modified">2136                                             .webrevStorageRepository(archive)</span>
2137                                             .webrevStorageRef(&quot;webrev&quot;)
2138                                             .webrevStorageBase(Path.of(&quot;test&quot;))
2139                                             .webrevStorageBaseUri(webrevServer.uri())
2140                                             .issueTracker(URIBuilder.base(&quot;http://issues.test/browse/&quot;).build())
2141                                             .build();
2142 
2143             // Populate the projects repository
2144             var reviewFile = Path.of(&quot;reviewfile.txt&quot;);
2145             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType(), reviewFile);
2146             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
2147             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
2148             localRepo.push(masterHash, archive.url(), &quot;webrev&quot;, true);
2149 
2150             // Make a change with a corresponding PR
2151             var editHash = CheckableRepository.appendAndCommit(localRepo);
2152             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
2153             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
2154             pr.setBody(&quot;This is now ready&quot;);
2155 
2156             // Run an archive pass
</pre>
<hr />
<pre>
2207              var archiveFolder = new TemporaryDirectory();
2208              var listServer = new TestMailmanServer();
2209              var webrevServer = new TestWebrevServer()) {
2210             var author = credentials.getHostedRepository();
2211             var ignored = credentials.getHostedRepository();
2212             var archive = credentials.getHostedRepository();
2213             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
2214             var censusBuilder = credentials.getCensusBuilder()
2215                                            .addAuthor(author.forge().currentUser().id());
2216             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
2217             var mlBot = MailingListBridgeBot.newBuilder()
2218                                             .from(from)
2219                                             .repo(author)
2220                                             .archive(archive)
2221                                             .censusRepo(censusBuilder.build())
2222                                             .lists(List.of(new MailingListConfiguration(listAddress, Set.of())))
2223                                             .ignoredUsers(Set.of(ignored.forge().currentUser().userName()))
2224                                             .ignoredComments(Set.of(Pattern.compile(&quot;ignore this comment&quot;, Pattern.MULTILINE | Pattern.DOTALL)))
2225                                             .listArchive(listServer.getArchive())
2226                                             .smtpServer(listServer.getSMTP())
<span class="line-modified">2227                                             .webrevStorageRepository(archive)</span>
2228                                             .webrevStorageRef(&quot;webrev&quot;)
2229                                             .webrevStorageBase(Path.of(&quot;test&quot;))
2230                                             .webrevStorageBaseUri(webrevServer.uri())
2231                                             .issueTracker(URIBuilder.base(&quot;http://issues.test/browse/&quot;).build())
2232                                             .build();
2233 
2234             // Populate the projects repository
2235             var reviewFile = Path.of(&quot;reviewfile.txt&quot;);
2236             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType(), reviewFile);
2237             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
2238             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
2239             localRepo.push(masterHash, archive.url(), &quot;webrev&quot;, true);
2240 
2241             // Make a change with a corresponding PR
2242             var editHash = CheckableRepository.appendAndCommit(localRepo);
2243             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
2244             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
2245             pr.setBody(&quot;This is now ready&quot;);
2246 
2247             // Make a bunch of comments
</pre>
<hr />
<pre>
2272              var tempFolder = new TemporaryDirectory();
2273              var archiveFolder = new TemporaryDirectory();
2274              var listServer = new TestMailmanServer();
2275              var webrevServer = new TestWebrevServer()) {
2276             var author = credentials.getHostedRepository();
2277             var reviewer = credentials.getHostedRepository();
2278             var archive = credentials.getHostedRepository();
2279             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
2280             var censusBuilder = credentials.getCensusBuilder()
2281                                            .addReviewer(reviewer.forge().currentUser().id())
2282                                            .addAuthor(author.forge().currentUser().id());
2283             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
2284             var mlBot = MailingListBridgeBot.newBuilder()
2285                                             .from(from)
2286                                             .repo(author)
2287                                             .archive(archive)
2288                                             .censusRepo(censusBuilder.build())
2289                                             .lists(List.of(new MailingListConfiguration(listAddress, Set.of())))
2290                                             .listArchive(listServer.getArchive())
2291                                             .smtpServer(listServer.getSMTP())
<span class="line-modified">2292                                             .webrevStorageRepository(archive)</span>
2293                                             .webrevStorageRef(&quot;webrev&quot;)
2294                                             .webrevStorageBase(Path.of(&quot;test&quot;))
2295                                             .webrevStorageBaseUri(webrevServer.uri())
2296                                             .issueTracker(URIBuilder.base(&quot;http://issues.test/browse/&quot;).build())
2297                                             .build();
2298 
2299             // Populate the projects repository
2300             var reviewFile = Path.of(&quot;reviewfile.txt&quot;);
2301             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType(), reviewFile);
2302             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
2303             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
2304             localRepo.push(masterHash, archive.url(), &quot;webrev&quot;, true);
2305 
2306             // Make a change with a corresponding PR
2307             var editHash = CheckableRepository.appendAndCommit(localRepo);
2308             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
2309             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
2310             pr.setBody(&quot;This is now ready&quot;);
2311             TestBotRunner.runPeriodicItems(mlBot);
2312             listServer.processIncoming();
</pre>
<hr />
<pre>
2333              var tempFolder = new TemporaryDirectory();
2334              var archiveFolder = new TemporaryDirectory();
2335              var listServer = new TestMailmanServer();
2336              var webrevServer = new TestWebrevServer()) {
2337             var bot = credentials.getHostedRepository();
2338             var author = credentials.getHostedRepository();
2339             var archive = credentials.getHostedRepository();
2340             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
2341             var censusBuilder = credentials.getCensusBuilder()
2342                                            .addAuthor(author.forge().currentUser().id());
2343             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
2344             var mlBotBuilder = MailingListBridgeBot.newBuilder()
2345                                                    .from(from)
2346                                                    .repo(bot)
2347                                                    .ignoredUsers(Set.of(bot.forge().currentUser().userName()))
2348                                                    .archive(archive)
2349                                                    .censusRepo(censusBuilder.build())
2350                                                    .lists(List.of(new MailingListConfiguration(listAddress, Set.of())))
2351                                                    .listArchive(listServer.getArchive())
2352                                                    .smtpServer(listServer.getSMTP())
<span class="line-modified">2353                                                    .webrevStorageRepository(archive)</span>
2354                                                    .webrevStorageRef(&quot;webrev&quot;)
2355                                                    .webrevStorageBase(Path.of(&quot;test&quot;))
2356                                                    .webrevStorageBaseUri(webrevServer.uri())
2357                                                    .issueTracker(URIBuilder.base(&quot;http://issues.test/browse/&quot;).build());
2358 
2359             // Populate the projects repository
2360             var reviewFile = Path.of(&quot;reviewfile.txt&quot;);
2361             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType(), reviewFile);
2362             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
2363             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
2364             localRepo.push(masterHash, archive.url(), &quot;webrev&quot;, true);
2365 
2366             // Make a change with a corresponding PR
2367             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;Line 1\nLine 2\nLine 3\nLine 4&quot;);
2368             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
2369             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
2370             pr.setBody(&quot;This is now ready&quot;);
2371 
2372             var mlBot = mlBotBuilder.build();
2373             var mlBotWithCooldown = mlBotBuilder.cooldown(Duration.ofDays(1)).build();
</pre>
<hr />
<pre>
2398              var tempFolder = new TemporaryDirectory();
2399              var archiveFolder = new TemporaryDirectory();
2400              var listServer = new TestMailmanServer();
2401              var webrevServer = new TestWebrevServer()) {
2402             var bot = credentials.getHostedRepository();
2403             var author = credentials.getHostedRepository();
2404             var archive = credentials.getHostedRepository();
2405             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
2406             var censusBuilder = credentials.getCensusBuilder()
2407                                            .addAuthor(author.forge().currentUser().id());
2408             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
2409             var mlBotBuilder = MailingListBridgeBot.newBuilder()
2410                                                    .from(from)
2411                                                    .repo(bot)
2412                                                    .ignoredUsers(Set.of(bot.forge().currentUser().userName()))
2413                                                    .archive(archive)
2414                                                    .censusRepo(censusBuilder.build())
2415                                                    .lists(List.of(new MailingListConfiguration(listAddress, Set.of())))
2416                                                    .listArchive(listServer.getArchive())
2417                                                    .smtpServer(listServer.getSMTP())
<span class="line-modified">2418                                                    .webrevStorageRepository(archive)</span>
2419                                                    .webrevStorageRef(&quot;webrev&quot;)
2420                                                    .webrevStorageBase(Path.of(&quot;test&quot;))
2421                                                    .webrevStorageBaseUri(webrevServer.uri())
2422                                                    .issueTracker(URIBuilder.base(&quot;http://issues.test/browse/&quot;).build());
2423 
2424             // Populate the projects repository
2425             var reviewFile = Path.of(&quot;reviewfile.txt&quot;);
2426             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType(), reviewFile);
2427             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
2428             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
2429             localRepo.push(masterHash, archive.url(), &quot;webrev&quot;, true);
2430 
2431             // Make a change with a corresponding PR
2432             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;Line 1\nLine 2\nLine 3\nLine 4&quot;);
2433             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
2434             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
2435             pr.setBody(&quot;This is now ready&quot;);
2436 
2437             var mlBot = mlBotBuilder.build();
2438             var mlBotWithCooldown = mlBotBuilder.cooldown(Duration.ofDays(1)).build();
</pre>
<hr />
<pre>
2465              var archiveFolder = new TemporaryDirectory();
2466              var listServer = new TestMailmanServer();
2467              var webrevServer = new TestWebrevServer()) {
2468             var bot = credentials.getHostedRepository();
2469             var author = credentials.getHostedRepository();
2470             var archive = credentials.getHostedRepository();
2471             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
2472             var censusBuilder = credentials.getCensusBuilder()
2473                                            .addAuthor(author.forge().currentUser().id());
2474             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
2475             var cooldown = Duration.ofMillis(500);
2476             var mlBotBuilder = MailingListBridgeBot.newBuilder()
2477                                                    .from(from)
2478                                                    .repo(bot)
2479                                                    .ignoredUsers(Set.of(bot.forge().currentUser().userName()))
2480                                                    .archive(archive)
2481                                                    .censusRepo(censusBuilder.build())
2482                                                    .lists(List.of(new MailingListConfiguration(listAddress, Set.of())))
2483                                                    .listArchive(listServer.getArchive())
2484                                                    .smtpServer(listServer.getSMTP())
<span class="line-modified">2485                                                    .webrevStorageRepository(archive)</span>
2486                                                    .webrevStorageRef(&quot;webrev&quot;)
2487                                                    .webrevStorageBase(Path.of(&quot;test&quot;))
2488                                                    .webrevStorageBaseUri(webrevServer.uri())
2489                                                    .issueTracker(URIBuilder.base(&quot;http://issues.test/browse/&quot;).build());
2490 
2491             // Populate the projects repository
2492             var reviewFile = Path.of(&quot;reviewfile.txt&quot;);
2493             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType(), reviewFile);
2494             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
2495             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
2496             localRepo.push(masterHash, archive.url(), &quot;webrev&quot;, true);
2497 
2498             // Make a change with a corresponding PR
2499             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;Line 1\nLine 2\nLine 3\nLine 4&quot;);
2500             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
2501             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
2502             pr.setBody(&quot;This is now ready&quot;);
2503 
2504             var mlBot = mlBotBuilder.cooldown(cooldown).build();
2505             Thread.sleep(cooldown.toMillis());
</pre>
<hr />
<pre>
2554     void branchPrefix(TestInfo testInfo) throws IOException {
2555         try (var credentials = new HostCredentials(testInfo);
2556              var tempFolder = new TemporaryDirectory();
2557              var archiveFolder = new TemporaryDirectory();
2558              var listServer = new TestMailmanServer();
2559              var webrevServer = new TestWebrevServer()) {
2560             var author = credentials.getHostedRepository();
2561             var archive = credentials.getHostedRepository();
2562             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
2563             var censusBuilder = credentials.getCensusBuilder()
2564                                            .addAuthor(author.forge().currentUser().id());
2565             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
2566             var mlBot = MailingListBridgeBot.newBuilder()
2567                                             .from(from)
2568                                             .repo(author)
2569                                             .archive(archive)
2570                                             .censusRepo(censusBuilder.build())
2571                                             .lists(List.of(new MailingListConfiguration(listAddress, Set.of())))
2572                                             .listArchive(listServer.getArchive())
2573                                             .smtpServer(listServer.getSMTP())
<span class="line-modified">2574                                             .webrevStorageRepository(archive)</span>
2575                                             .webrevStorageRef(&quot;webrev&quot;)
2576                                             .webrevStorageBase(Path.of(&quot;test&quot;))
2577                                             .webrevStorageBaseUri(webrevServer.uri())
2578                                             .issueTracker(URIBuilder.base(&quot;http://issues.test/browse/&quot;).build())
2579                                             .branchInSubject(Pattern.compile(&quot;.*&quot;))
2580                                             .build();
2581 
2582             // Populate the projects repository
2583             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType());
2584             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
2585             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
2586             localRepo.push(masterHash, archive.url(), &quot;webrev&quot;, true);
2587 
2588             // Make a change with a corresponding PR
2589             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;A simple change&quot;,
2590                                                                &quot;Change msg\n\nWith several lines&quot;);
2591             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
2592             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;1234: This is a pull request&quot;);
2593             pr.setBody(&quot;This is a PR&quot;);
2594 
</pre>
<hr />
<pre>
2611     void repoPrefix(TestInfo testInfo) throws IOException {
2612         try (var credentials = new HostCredentials(testInfo);
2613              var tempFolder = new TemporaryDirectory();
2614              var archiveFolder = new TemporaryDirectory();
2615              var listServer = new TestMailmanServer();
2616              var webrevServer = new TestWebrevServer()) {
2617             var author = credentials.getHostedRepository();
2618             var archive = credentials.getHostedRepository();
2619             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
2620             var censusBuilder = credentials.getCensusBuilder()
2621                                            .addAuthor(author.forge().currentUser().id());
2622             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
2623             var mlBot = MailingListBridgeBot.newBuilder()
2624                                             .from(from)
2625                                             .repo(author)
2626                                             .archive(archive)
2627                                             .censusRepo(censusBuilder.build())
2628                                             .lists(List.of(new MailingListConfiguration(listAddress, Set.of())))
2629                                             .listArchive(listServer.getArchive())
2630                                             .smtpServer(listServer.getSMTP())
<span class="line-modified">2631                                             .webrevStorageRepository(archive)</span>
2632                                             .webrevStorageRef(&quot;webrev&quot;)
2633                                             .webrevStorageBase(Path.of(&quot;test&quot;))
2634                                             .webrevStorageBaseUri(webrevServer.uri())
2635                                             .issueTracker(URIBuilder.base(&quot;http://issues.test/browse/&quot;).build())
2636                                             .repoInSubject(true)
2637                                             .build();
2638 
2639             // Populate the projects repository
2640             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType());
2641             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
2642             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
2643             localRepo.push(masterHash, archive.url(), &quot;webrev&quot;, true);
2644 
2645             // Make a change with a corresponding PR
2646             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;A simple change&quot;,
2647                                                                &quot;Change msg\n\nWith several lines&quot;);
2648             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
2649             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;1234: This is a pull request&quot;);
2650             pr.setBody(&quot;This is a PR&quot;);
2651 
</pre>
<hr />
<pre>
2668     void repoAndBranchPrefix(TestInfo testInfo) throws IOException {
2669         try (var credentials = new HostCredentials(testInfo);
2670              var tempFolder = new TemporaryDirectory();
2671              var archiveFolder = new TemporaryDirectory();
2672              var listServer = new TestMailmanServer();
2673              var webrevServer = new TestWebrevServer()) {
2674             var author = credentials.getHostedRepository();
2675             var archive = credentials.getHostedRepository();
2676             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
2677             var censusBuilder = credentials.getCensusBuilder()
2678                                            .addAuthor(author.forge().currentUser().id());
2679             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
2680             var mlBot = MailingListBridgeBot.newBuilder()
2681                                             .from(from)
2682                                             .repo(author)
2683                                             .archive(archive)
2684                                             .censusRepo(censusBuilder.build())
2685                                             .lists(List.of(new MailingListConfiguration(listAddress, Set.of())))
2686                                             .listArchive(listServer.getArchive())
2687                                             .smtpServer(listServer.getSMTP())
<span class="line-modified">2688                                             .webrevStorageRepository(archive)</span>
2689                                             .webrevStorageRef(&quot;webrev&quot;)
2690                                             .webrevStorageBase(Path.of(&quot;test&quot;))
2691                                             .webrevStorageBaseUri(webrevServer.uri())
2692                                             .issueTracker(URIBuilder.base(&quot;http://issues.test/browse/&quot;).build())
2693                                             .repoInSubject(true)
2694                                             .branchInSubject(Pattern.compile(&quot;.*&quot;))
2695                                             .build();
2696 
2697             // Populate the projects repository
2698             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType());
2699             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
2700             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
2701             localRepo.push(masterHash, archive.url(), &quot;webrev&quot;, true);
2702 
2703             // Make a change with a corresponding PR
2704             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;A simple change&quot;,
2705                                                                &quot;Change msg\n\nWith several lines&quot;);
2706             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
2707             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;1234: This is a pull request&quot;);
2708             pr.setBody(&quot;This is a PR&quot;);
</pre>
<hr />
<pre>
2729              var archiveFolder = new TemporaryDirectory();
2730              var listServer = new TestMailmanServer();
2731              var webrevServer = new TestWebrevServer()) {
2732             var bot = credentials.getHostedRepository();
2733             var author = credentials.getHostedRepository();
2734             var archive = credentials.getHostedRepository();
2735             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
2736             var censusBuilder = credentials.getCensusBuilder()
2737                                            .addAuthor(author.forge().currentUser().id());
2738             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
2739             var cooldown = Duration.ofMillis(500);
2740             var mlBotBuilder = MailingListBridgeBot.newBuilder()
2741                                                    .from(from)
2742                                                    .repo(bot)
2743                                                    .ignoredUsers(Set.of(bot.forge().currentUser().userName()))
2744                                                    .archive(archive)
2745                                                    .censusRepo(censusBuilder.build())
2746                                                    .lists(List.of(new MailingListConfiguration(listAddress, Set.of())))
2747                                                    .listArchive(listServer.getArchive())
2748                                                    .smtpServer(listServer.getSMTP())
<span class="line-modified">2749                                                    .webrevStorageRepository(archive)</span>
2750                                                    .webrevStorageRef(&quot;webrev&quot;)
2751                                                    .webrevStorageBase(Path.of(&quot;test&quot;))
2752                                                    .webrevStorageBaseUri(webrevServer.uri())
2753                                                    .issueTracker(URIBuilder.base(&quot;http://issues.test/browse/&quot;).build());
2754 
2755             // Populate the projects repository
2756             var reviewFile = Path.of(&quot;reviewfile.txt&quot;);
2757             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType(), reviewFile);
2758             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
2759             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
2760             localRepo.push(masterHash, archive.url(), &quot;webrev&quot;, true);
2761 
2762             // Make a change with a corresponding PR
2763             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;Line 1\nLine 2\nLine 3\nLine 4&quot;);
2764             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
2765             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
2766             pr.setBody(&quot;This is now ready&quot;);
2767 
2768             var mlBot = mlBotBuilder.cooldown(cooldown).build();
2769             Thread.sleep(cooldown.toMillis());
</pre>
<hr />
<pre>
2821              var tempFolder = new TemporaryDirectory();
2822              var archiveFolder = new TemporaryDirectory();
2823              var listServer = new TestMailmanServer();
2824              var webrevServer = new TestWebrevServer()) {
2825             var author = credentials.getHostedRepository();
2826             var archive = credentials.getHostedRepository();
2827             var listAddress1 = EmailAddress.parse(listServer.createList(&quot;test1&quot;));
2828             var listAddress2 = EmailAddress.parse(listServer.createList(&quot;test2&quot;));
2829             var censusBuilder = credentials.getCensusBuilder()
2830                                            .addAuthor(author.forge().currentUser().id());
2831             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
2832             var mlBot = MailingListBridgeBot.newBuilder()
2833                                             .from(from)
2834                                             .repo(author)
2835                                             .archive(archive)
2836                                             .censusRepo(censusBuilder.build())
2837                                             .lists(List.of(new MailingListConfiguration(listAddress1, Set.of(&quot;list1&quot;)),
2838                                                            new MailingListConfiguration(listAddress2, Set.of(&quot;list2&quot;))))
2839                                             .listArchive(listServer.getArchive())
2840                                             .smtpServer(listServer.getSMTP())
<span class="line-modified">2841                                             .webrevStorageRepository(archive)</span>
2842                                             .webrevStorageRef(&quot;webrev&quot;)
2843                                             .webrevStorageBase(Path.of(&quot;test&quot;))
2844                                             .webrevStorageBaseUri(webrevServer.uri())
2845                                             .issueTracker(URIBuilder.base(&quot;http://issues.test/browse/&quot;).build())
2846                                             .build();
2847 
2848             // Populate the projects repository
2849             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType());
2850             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
2851             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
2852             localRepo.push(masterHash, archive.url(), &quot;webrev&quot;, true);
2853 
2854             // Make a change with a corresponding PR
2855             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;A simple change&quot;,
2856                                                                &quot;Change msg\n\nWith several lines&quot;);
2857             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
2858             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;1234: This is a pull request&quot;);
2859             pr.setBody(&quot;This is a PR&quot;);
2860             pr.addLabel(&quot;list1&quot;);
2861 
</pre>
<hr />
<pre>
2875             assertEquals(listAddress1, mail.sender());
2876             assertEquals(List.of(listAddress1), mail.recipients());
2877 
2878             // Add another label and comment
2879             pr.addLabel(&quot;list2&quot;);
2880             pr.addComment(&quot;Looks good!&quot;);
2881             TestBotRunner.runPeriodicItems(mlBot);
2882             listServer.processIncoming();
2883 
2884             // This one should have been sent to list1 and list2
2885             conversations = mailmanList.conversations(Duration.ofDays(1));
2886             assertEquals(1, conversations.size());
2887             var reply = conversations.get(0).replies(conversations.get(0).first()).get(0);
2888             assertEquals(&quot;RFR: 1234: This is a pull request&quot;, reply.subject());
2889             assertEquals(pr.author().fullName(), reply.author().fullName().orElseThrow());
2890             assertEquals(noreplyAddress(archive), reply.author().address());
2891             assertEquals(listAddress1, reply.sender());
2892             assertEquals(List.of(listAddress1, listAddress2), reply.recipients());
2893         }
2894     }









































































































































































































2895 }
</pre>
</td>
<td>
<hr />
<pre>
  12  * version 2 for more details (a copy is included in the LICENSE file that
  13  * accompanied this code).
  14  *
  15  * You should have received a copy of the GNU General Public License version
  16  * 2 along with this work; if not, write to the Free Software Foundation,
  17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
  18  *
  19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
  20  * or visit www.oracle.com if you need additional information or have any
  21  * questions.
  22  */
  23 package org.openjdk.skara.bots.mlbridge;
  24 
  25 import org.openjdk.skara.email.EmailAddress;
  26 import org.openjdk.skara.forge.*;
  27 import org.openjdk.skara.issuetracker.Issue;
  28 import org.openjdk.skara.network.URIBuilder;
  29 import org.openjdk.skara.mailinglist.MailingListServerFactory;
  30 import org.openjdk.skara.test.*;
  31 import org.openjdk.skara.vcs.Repository;
<span class="line-added">  32 import org.openjdk.skara.json.JSON;</span>
  33 
  34 import org.junit.jupiter.api.*;
  35 
  36 import java.io.IOException;
  37 import java.nio.charset.StandardCharsets;
  38 import java.nio.file.*;
  39 import java.time.*;
  40 import java.util.*;
  41 import java.util.logging.Logger;
  42 import java.util.regex.Pattern;
  43 import java.util.stream.Collectors;
  44 
  45 import static org.junit.jupiter.api.Assertions.*;
  46 
  47 class MailingListBridgeBotTests {
  48     private final Logger log = Logger.getLogger(&quot;org.openjdk.skara.bots.mlbridge.test&quot;);
  49 
  50     private Optional&lt;String&gt; archiveContents(Path archive) {
  51         try {
  52             var mbox = Files.find(archive, 50, (path, attrs) -&gt; path.toString().endsWith(&quot;.mbox&quot;)).findAny();
</pre>
<hr />
<pre>
 111              var webrevFolder = new TemporaryDirectory();
 112              var listServer = new TestMailmanServer();
 113              var webrevServer = new TestWebrevServer()) {
 114             var author = credentials.getHostedRepository();
 115             var archive = credentials.getHostedRepository();
 116             var ignored = credentials.getHostedRepository();
 117             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
 118             var censusBuilder = credentials.getCensusBuilder()
 119                                            .addAuthor(author.forge().currentUser().id());
 120             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
 121             var mlBot = MailingListBridgeBot.newBuilder()
 122                                             .from(from)
 123                                             .repo(author)
 124                                             .archive(archive)
 125                                             .censusRepo(censusBuilder.build())
 126                                             .lists(List.of(new MailingListConfiguration(listAddress, Set.of())))
 127                                             .ignoredUsers(Set.of(ignored.forge().currentUser().userName()))
 128                                             .ignoredComments(Set.of())
 129                                             .listArchive(listServer.getArchive())
 130                                             .smtpServer(listServer.getSMTP())
<span class="line-modified"> 131                                             .webrevStorageHTMLRepository(archive)</span>
 132                                             .webrevStorageRef(&quot;webrev&quot;)
 133                                             .webrevStorageBase(Path.of(&quot;test&quot;))
 134                                             .webrevStorageBaseUri(webrevServer.uri())
 135                                             .readyLabels(Set.of(&quot;rfr&quot;))
 136                                             .readyComments(Map.of(ignored.forge().currentUser().userName(), Pattern.compile(&quot;ready&quot;)))
 137                                             .issueTracker(URIBuilder.base(&quot;http://issues.test/browse/&quot;).build())
 138                                             .headers(Map.of(&quot;Extra1&quot;, &quot;val1&quot;, &quot;Extra2&quot;, &quot;val2&quot;))
 139                                             .sendInterval(Duration.ZERO)
 140                                             .build();
 141 
 142             // Populate the projects repository
 143             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType());
 144             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
 145             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
 146             localRepo.push(masterHash, archive.url(), &quot;webrev&quot;, true);
 147 
 148             // Make a change with a corresponding PR
 149             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;A simple change&quot;,
 150                                                                &quot;Change msg\n\nWith several lines&quot;);
 151             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
</pre>
<hr />
<pre>
 278              var archiveFolder = new TemporaryDirectory();
 279              var webrevFolder = new TemporaryDirectory();
 280              var listServer = new TestMailmanServer();
 281              var webrevServer = new TestWebrevServer()) {
 282             var author = credentials.getHostedRepository();
 283             var archive = credentials.getHostedRepository();
 284             var ignored = credentials.getHostedRepository();
 285             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
 286             var censusBuilder = credentials.getCensusBuilder()
 287                                            .addAuthor(author.forge().currentUser().id());
 288             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
 289             var mlBot = MailingListBridgeBot.newBuilder()
 290                                             .from(from)
 291                                             .repo(author)
 292                                             .archive(archive)
 293                                             .censusRepo(censusBuilder.build())
 294                                             .lists(List.of(new MailingListConfiguration(listAddress, Set.of())))
 295                                             .ignoredUsers(Set.of(ignored.forge().currentUser().userName()))
 296                                             .listArchive(listServer.getArchive())
 297                                             .smtpServer(listServer.getSMTP())
<span class="line-modified"> 298                                             .webrevStorageHTMLRepository(archive)</span>
 299                                             .webrevStorageRef(&quot;webrev&quot;)
 300                                             .webrevStorageBase(Path.of(&quot;test&quot;))
 301                                             .webrevStorageBaseUri(webrevServer.uri())
 302                                             .issueTracker(URIBuilder.base(&quot;http://issues.test/browse/&quot;).build())
 303                                             .build();
 304 
 305             // Populate the projects repository
 306             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType());
 307             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
 308             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
 309             localRepo.push(masterHash, archive.url(), &quot;webrev&quot;, true);
 310 
 311             // Make a change with a corresponding PR
 312             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;A simple change&quot;,
 313                                                                &quot;Change msg\n\nWith several lines&quot;);
 314             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
 315             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;1234: This is a pull request&quot;);
 316             pr.setBody(&quot;This is now ready&quot;);
 317             pr.addLabel(&quot;rfr&quot;);
 318 
</pre>
<hr />
<pre>
 352              var archiveFolder = new TemporaryDirectory();
 353              var webrevFolder = new TemporaryDirectory();
 354              var listServer = new TestMailmanServer();
 355              var webrevServer = new TestWebrevServer()) {
 356             var author = credentials.getHostedRepository();
 357             var archive = credentials.getHostedRepository();
 358             var ignored = credentials.getHostedRepository();
 359             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
 360             var censusBuilder = credentials.getCensusBuilder()
 361                     .addAuthor(author.forge().currentUser().id());
 362             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
 363             var mlBot = MailingListBridgeBot.newBuilder()
 364                                             .from(from)
 365                                             .repo(author)
 366                                             .archive(archive)
 367                                             .censusRepo(censusBuilder.build())
 368                                             .lists(List.of(new MailingListConfiguration(listAddress, Set.of())))
 369                                             .ignoredUsers(Set.of(ignored.forge().currentUser().userName()))
 370                                             .listArchive(listServer.getArchive())
 371                                             .smtpServer(listServer.getSMTP())
<span class="line-modified"> 372                                             .webrevStorageHTMLRepository(archive)</span>
 373                                             .webrevStorageRef(&quot;webrev&quot;)
 374                                             .webrevStorageBase(Path.of(&quot;test&quot;))
 375                                             .webrevStorageBaseUri(webrevServer.uri())
 376                                             .issueTracker(URIBuilder.base(&quot;http://issues.test/browse/&quot;).build())
 377                                             .build();
 378 
 379             // Populate the projects repository
 380             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType());
 381             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
 382             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
 383             localRepo.push(masterHash, archive.url(), &quot;webrev&quot;, true);
 384 
 385             // Make a change with a corresponding PR with a date in the past
 386             var editFile = tempFolder.path().resolve(&quot;change.txt&quot;);
 387             Files.writeString(editFile, &quot;A simple change&quot;);
 388             localRepo.add(editFile);
 389             var commitDate = ZonedDateTime.of(2020, 3, 12, 0, 0, 0, 0, ZoneId.of(&quot;UTC&quot;));
 390             var editHash = localRepo.commit(&quot;An old change&quot;, &quot;duke&quot;, &quot;duke@openjdk.org&quot;, commitDate,
 391                              &quot;duke&quot;, &quot;duke@openjdk.org&quot;, commitDate);
 392             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
</pre>
<hr />
<pre>
 426              var archiveFolder = new TemporaryDirectory();
 427              var webrevFolder = new TemporaryDirectory();
 428              var listServer = new TestMailmanServer();
 429              var webrevServer = new TestWebrevServer()) {
 430             var author = credentials.getHostedRepository();
 431             var archive = credentials.getHostedRepository();
 432             var ignored = credentials.getHostedRepository();
 433             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
 434             var censusBuilder = credentials.getCensusBuilder()
 435                                            .addAuthor(author.forge().currentUser().id());
 436             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
 437             var mlBot = MailingListBridgeBot.newBuilder()
 438                                             .from(from)
 439                                             .repo(author)
 440                                             .archive(archive)
 441                                             .censusRepo(censusBuilder.build())
 442                                             .lists(List.of(new MailingListConfiguration(listAddress, Set.of())))
 443                                             .ignoredUsers(Set.of(ignored.forge().currentUser().userName()))
 444                                             .listArchive(listServer.getArchive())
 445                                             .smtpServer(listServer.getSMTP())
<span class="line-modified"> 446                                             .webrevStorageHTMLRepository(archive)</span>
 447                                             .webrevStorageRef(&quot;webrev&quot;)
 448                                             .webrevStorageBase(Path.of(&quot;test&quot;))
 449                                             .webrevStorageBaseUri(webrevServer.uri())
 450                                             .issueTracker(URIBuilder.base(&quot;http://issues.test/browse/&quot;).build())
 451                                             .build();
 452 
 453             // Populate the projects repository
 454             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType());
 455             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
 456             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
 457             localRepo.push(masterHash, archive.url(), &quot;webrev&quot;, true);
 458 
 459             // Make a change with a corresponding PR
 460             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;A simple change&quot;,
 461                                                                &quot;Change msg\n\nWith several lines&quot;);
 462             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
 463             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;1234: This is a pull request&quot;);
 464             pr.setBody(&quot;This should not be ready&quot;);
 465             pr.setState(Issue.State.CLOSED);
 466 
</pre>
<hr />
<pre>
 505              var archiveFolder = new TemporaryDirectory();
 506              var webrevFolder = new TemporaryDirectory();
 507              var listServer = new TestMailmanServer();
 508              var webrevServer = new TestWebrevServer()) {
 509             var author = credentials.getHostedRepository();
 510             var archive = credentials.getHostedRepository();
 511             var ignored = credentials.getHostedRepository();
 512             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
 513             var censusBuilder = credentials.getCensusBuilder()
 514                                            .addAuthor(author.forge().currentUser().id());
 515             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
 516             var mlBot = MailingListBridgeBot.newBuilder()
 517                                             .from(from)
 518                                             .repo(author)
 519                                             .archive(archive)
 520                                             .censusRepo(censusBuilder.build())
 521                                             .lists(List.of(new MailingListConfiguration(listAddress, Set.of())))
 522                                             .ignoredUsers(Set.of(ignored.forge().currentUser().userName()))
 523                                             .listArchive(listServer.getArchive())
 524                                             .smtpServer(listServer.getSMTP())
<span class="line-modified"> 525                                             .webrevStorageHTMLRepository(archive)</span>
 526                                             .webrevStorageRef(&quot;webrev&quot;)
 527                                             .webrevStorageBase(Path.of(&quot;test&quot;))
 528                                             .webrevStorageBaseUri(webrevServer.uri())
 529                                             .readyLabels(Set.of(&quot;rfr&quot;))
 530                                             .issueTracker(URIBuilder.base(&quot;http://issues.test/browse/&quot;).build())
 531                                             .build();
 532 
 533             // Populate the projects repository
 534             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType());
 535             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
 536             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
 537             localRepo.push(masterHash, archive.url(), &quot;webrev&quot;, true);
 538 
 539             // Make a change with a corresponding PR
 540             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;A simple change&quot;,
 541                                                                &quot;Change msg\n\nWith several lines&quot;);
 542             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
 543             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;1234: This is a pull request&quot;);
 544             pr.setBody(&quot;This should be ready&quot;);
 545 
</pre>
<hr />
<pre>
 582              var archiveFolder = new TemporaryDirectory();
 583              var webrevFolder = new TemporaryDirectory();
 584              var listServer = new TestMailmanServer();
 585              var webrevServer = new TestWebrevServer()) {
 586             var author = credentials.getHostedRepository();
 587             var archive = credentials.getHostedRepository();
 588             var ignored = credentials.getHostedRepository();
 589             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
 590             var censusBuilder = credentials.getCensusBuilder()
 591                                            .addAuthor(author.forge().currentUser().id());
 592             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
 593             var mlBot = MailingListBridgeBot.newBuilder()
 594                                             .from(from)
 595                                             .repo(author)
 596                                             .archive(archive)
 597                                             .censusRepo(censusBuilder.build())
 598                                             .lists(List.of(new MailingListConfiguration(listAddress, Set.of())))
 599                                             .ignoredUsers(Set.of(ignored.forge().currentUser().userName()))
 600                                             .listArchive(listServer.getArchive())
 601                                             .smtpServer(listServer.getSMTP())
<span class="line-modified"> 602                                             .webrevStorageHTMLRepository(archive)</span>
 603                                             .webrevStorageRef(&quot;webrev&quot;)
 604                                             .webrevStorageBase(Path.of(&quot;test&quot;))
 605                                             .webrevStorageBaseUri(webrevServer.uri())
 606                                             .readyLabels(Set.of(&quot;rfr&quot;))
 607                                             .issueTracker(URIBuilder.base(&quot;http://issues.test/browse/&quot;).build())
 608                                             .build();
 609 
 610             // Populate the projects repository
 611             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType());
 612             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
 613             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
 614             localRepo.push(masterHash, archive.url(), &quot;webrev&quot;, true);
 615 
 616             // Make a change with a corresponding PR
 617             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;A simple change&quot;,
 618                                                                &quot;Change msg\n\nWith several lines&quot;);
 619             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
 620             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;1234: This is a pull request&quot;);
 621             pr.setBody(&quot;This should be ready&quot;);
 622 
</pre>
<hr />
<pre>
 665              var archiveFolder = new TemporaryDirectory();
 666              var webrevFolder = new TemporaryDirectory();
 667              var listServer = new TestMailmanServer();
 668              var webrevServer = new TestWebrevServer()) {
 669             var author = credentials.getHostedRepository();
 670             var archive = credentials.getHostedRepository();
 671             var ignored = credentials.getHostedRepository();
 672             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
 673             var censusBuilder = credentials.getCensusBuilder()
 674                                            .addAuthor(author.forge().currentUser().id());
 675             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
 676             var mlBot = MailingListBridgeBot.newBuilder()
 677                                             .from(from)
 678                                             .repo(author)
 679                                             .archive(archive)
 680                                             .censusRepo(censusBuilder.build())
 681                                             .lists(List.of(new MailingListConfiguration(listAddress, Set.of())))
 682                                             .ignoredUsers(Set.of(ignored.forge().currentUser().userName()))
 683                                             .listArchive(listServer.getArchive())
 684                                             .smtpServer(listServer.getSMTP())
<span class="line-modified"> 685                                             .webrevStorageHTMLRepository(archive)</span>
 686                                             .webrevStorageRef(&quot;webrev&quot;)
 687                                             .webrevStorageBase(Path.of(&quot;test&quot;))
 688                                             .webrevStorageBaseUri(webrevServer.uri())
 689                                             .issueTracker(URIBuilder.base(&quot;http://issues.test/browse/&quot;).build())
 690                                             .build();
 691 
 692             // Populate the projects repository
 693             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType());
 694             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
 695             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
 696             localRepo.push(masterHash, archive.url(), &quot;webrev&quot;, true);
 697 
 698             // Make a change with a corresponding PR
 699             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;A simple change&quot;,
 700                                                                &quot;Change msg\n\nWith several lines&quot;);
 701             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
 702             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;Cannot automatically merge&quot;);
 703             pr.setBody(&quot;This is an automated merge PR&quot;);
 704             pr.addLabel(&quot;failed-auto-merge&quot;);
 705 
</pre>
<hr />
<pre>
 719              var tempFolder = new TemporaryDirectory();
 720              var archiveFolder = new TemporaryDirectory();
 721              var listServer = new TestMailmanServer();
 722              var webrevServer = new TestWebrevServer()) {
 723             var author = credentials.getHostedRepository();
 724             var archive = credentials.getHostedRepository();
 725             var ignored = credentials.getHostedRepository();
 726             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
 727             var censusBuilder = credentials.getCensusBuilder()
 728                                            .addAuthor(author.forge().currentUser().id());
 729             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
 730             var mlBot = MailingListBridgeBot.newBuilder()
 731                                             .from(from)
 732                                             .repo(author)
 733                                             .archive(archive)
 734                                             .censusRepo(censusBuilder.build())
 735                                             .lists(List.of(new MailingListConfiguration(listAddress, Set.of())))
 736                                             .ignoredUsers(Set.of(ignored.forge().currentUser().userName()))
 737                                             .listArchive(listServer.getArchive())
 738                                             .smtpServer(listServer.getSMTP())
<span class="line-modified"> 739                                             .webrevStorageHTMLRepository(archive)</span>
 740                                             .webrevStorageRef(&quot;webrev&quot;)
 741                                             .webrevStorageBase(Path.of(&quot;test&quot;))
 742                                             .webrevStorageBaseUri(webrevServer.uri())
 743                                             .issueTracker(URIBuilder.base(&quot;http://issues.test/browse/&quot;).build())
 744                                             .build();
 745 
 746             // Populate the projects repository
 747             var reviewFile = Path.of(&quot;reviewfile.txt&quot;);
 748             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType(), reviewFile);
 749             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
 750             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
 751             localRepo.push(masterHash, archive.url(), &quot;webrev&quot;, true);
 752 
 753             // Make a change with a corresponding PR
 754             var editHash = CheckableRepository.appendAndCommit(localRepo);
 755             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
 756             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
 757             pr.setBody(&quot;This is now ready&quot;);
 758             TestBotRunner.runPeriodicItems(mlBot);
 759             listServer.processIncoming();
</pre>
<hr />
<pre>
 813     void combineComments(TestInfo testInfo) throws IOException {
 814         try (var credentials = new HostCredentials(testInfo);
 815              var tempFolder = new TemporaryDirectory();
 816              var archiveFolder = new TemporaryDirectory();
 817              var listServer = new TestMailmanServer();
 818              var webrevServer = new TestWebrevServer()) {
 819             var author = credentials.getHostedRepository();
 820             var archive = credentials.getHostedRepository();
 821             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
 822             var censusBuilder = credentials.getCensusBuilder()
 823                                            .addAuthor(author.forge().currentUser().id());
 824             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
 825             var mlBot = MailingListBridgeBot.newBuilder()
 826                                             .from(from)
 827                                             .repo(author)
 828                                             .archive(archive)
 829                                             .censusRepo(censusBuilder.build())
 830                                             .lists(List.of(new MailingListConfiguration(listAddress, Set.of())))
 831                                             .listArchive(listServer.getArchive())
 832                                             .smtpServer(listServer.getSMTP())
<span class="line-modified"> 833                                             .webrevStorageHTMLRepository(archive)</span>
 834                                             .webrevStorageRef(&quot;webrev&quot;)
 835                                             .webrevStorageBase(Path.of(&quot;test&quot;))
 836                                             .webrevStorageBaseUri(webrevServer.uri())
 837                                             .issueTracker(URIBuilder.base(&quot;http://issues.test/browse/&quot;).build())
 838                                             .build();
 839 
 840             // Populate the projects repository
 841             var reviewFile = Path.of(&quot;reviewfile.txt&quot;);
 842             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType(), reviewFile);
 843             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
 844             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
 845             localRepo.push(masterHash, archive.url(), &quot;webrev&quot;, true);
 846 
 847             // Make a change with a corresponding PR
 848             var editHash = CheckableRepository.appendAndCommit(localRepo);
 849             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
 850             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
 851             pr.setBody(&quot;This is now ready&quot;);
 852             pr.addComment(&quot;Avoid combining&quot;);
 853 
</pre>
<hr />
<pre>
 908              var tempFolder = new TemporaryDirectory();
 909              var archiveFolder = new TemporaryDirectory();
 910              var listServer = new TestMailmanServer();
 911              var webrevServer = new TestWebrevServer()) {
 912             var author = credentials.getHostedRepository();
 913             var reviewer = credentials.getHostedRepository();
 914             var archive = credentials.getHostedRepository();
 915             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
 916             var censusBuilder = credentials.getCensusBuilder()
 917                                            .addReviewer(reviewer.forge().currentUser().id())
 918                                            .addAuthor(author.forge().currentUser().id());
 919             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
 920             var mlBot = MailingListBridgeBot.newBuilder()
 921                                             .from(from)
 922                                             .repo(author)
 923                                             .archive(archive)
 924                                             .censusRepo(censusBuilder.build())
 925                                             .lists(List.of(new MailingListConfiguration(listAddress, Set.of())))
 926                                             .listArchive(listServer.getArchive())
 927                                             .smtpServer(listServer.getSMTP())
<span class="line-modified"> 928                                             .webrevStorageHTMLRepository(archive)</span>
 929                                             .webrevStorageRef(&quot;webrev&quot;)
 930                                             .webrevStorageBase(Path.of(&quot;test&quot;))
 931                                             .webrevStorageBaseUri(webrevServer.uri())
 932                                             .issueTracker(URIBuilder.base(&quot;http://issues.test/browse/&quot;).build())
 933                                             .build();
 934 
 935             // Populate the projects repository
 936             var reviewFile = Path.of(&quot;reviewfile.txt&quot;);
 937             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType(), reviewFile);
 938             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
 939             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
 940             localRepo.push(masterHash, archive.url(), &quot;webrev&quot;, true);
 941 
 942             // Make a change with a corresponding PR
 943             var editHash = CheckableRepository.appendAndCommit(localRepo);
 944             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
 945             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
 946             pr.setBody(&quot;This is now ready&quot;);
 947             TestBotRunner.runPeriodicItems(mlBot);
 948             listServer.processIncoming();
</pre>
<hr />
<pre>
1037              var tempFolder = new TemporaryDirectory();
1038              var archiveFolder = new TemporaryDirectory();
1039              var listServer = new TestMailmanServer();
1040              var webrevServer = new TestWebrevServer()) {
1041             var author = credentials.getHostedRepository();
1042             var reviewer = credentials.getHostedRepository();
1043             var archive = credentials.getHostedRepository();
1044             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
1045             var censusBuilder = credentials.getCensusBuilder()
1046                                            .addReviewer(reviewer.forge().currentUser().id())
1047                                            .addAuthor(author.forge().currentUser().id());
1048             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
1049             var mlBot = MailingListBridgeBot.newBuilder()
1050                                             .from(from)
1051                                             .repo(author)
1052                                             .archive(archive)
1053                                             .censusRepo(censusBuilder.build())
1054                                             .lists(List.of(new MailingListConfiguration(listAddress, Set.of())))
1055                                             .listArchive(listServer.getArchive())
1056                                             .smtpServer(listServer.getSMTP())
<span class="line-modified">1057                                             .webrevStorageHTMLRepository(archive)</span>
1058                                             .webrevStorageRef(&quot;webrev&quot;)
1059                                             .webrevStorageBase(Path.of(&quot;test&quot;))
1060                                             .webrevStorageBaseUri(webrevServer.uri())
1061                                             .issueTracker(URIBuilder.base(&quot;http://issues.test/browse/&quot;).build())
1062                                             .build();
1063 
1064             // Populate the projects repository
1065             var reviewFile = Path.of(&quot;reviewfile.txt&quot;);
1066             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType(), reviewFile);
1067             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
1068             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
1069             localRepo.push(masterHash, archive.url(), &quot;webrev&quot;, true);
1070 
1071             // Make a change with a corresponding PR
1072             var editHash = CheckableRepository.appendAndCommit(localRepo);
1073             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
1074             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
1075             pr.setBody(&quot;This is now ready&quot;);
1076             TestBotRunner.runPeriodicItems(mlBot);
1077             listServer.processIncoming();
</pre>
<hr />
<pre>
1100              var tempFolder = new TemporaryDirectory();
1101              var archiveFolder = new TemporaryDirectory();
1102              var listServer = new TestMailmanServer();
1103              var webrevServer = new TestWebrevServer()) {
1104             var author = credentials.getHostedRepository();
1105             var reviewer = credentials.getHostedRepository();
1106             var archive = credentials.getHostedRepository();
1107             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
1108             var censusBuilder = credentials.getCensusBuilder()
1109                                            .addReviewer(reviewer.forge().currentUser().id())
1110                                            .addAuthor(author.forge().currentUser().id());
1111             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
1112             var mlBot = MailingListBridgeBot.newBuilder()
1113                                             .from(from)
1114                                             .repo(author)
1115                                             .archive(archive)
1116                                             .censusRepo(censusBuilder.build())
1117                                             .lists(List.of(new MailingListConfiguration(listAddress, Set.of())))
1118                                             .listArchive(listServer.getArchive())
1119                                             .smtpServer(listServer.getSMTP())
<span class="line-modified">1120                                             .webrevStorageHTMLRepository(archive)</span>
1121                                             .webrevStorageRef(&quot;webrev&quot;)
1122                                             .webrevStorageBase(Path.of(&quot;test&quot;))
1123                                             .webrevStorageBaseUri(webrevServer.uri())
1124                                             .issueTracker(URIBuilder.base(&quot;http://issues.test/browse/&quot;).build())
1125                                             .build();
1126 
1127             // Populate the projects repository
1128             var reviewFile = Path.of(&quot;reviewfile.txt&quot;);
1129             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType(), reviewFile);
1130             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
1131             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
1132             localRepo.push(masterHash, archive.url(), &quot;webrev&quot;, true);
1133 
1134             // Make a change with a corresponding PR
1135             var editHash = CheckableRepository.appendAndCommit(localRepo);
1136             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
1137             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
1138             pr.setBody(&quot;This is now ready&quot;);
1139             TestBotRunner.runPeriodicItems(mlBot);
1140             listServer.processIncoming();
</pre>
<hr />
<pre>
1164              var tempFolder = new TemporaryDirectory();
1165              var archiveFolder = new TemporaryDirectory();
1166              var listServer = new TestMailmanServer();
1167              var webrevServer = new TestWebrevServer()) {
1168             var author = credentials.getHostedRepository();
1169             var reviewer = credentials.getHostedRepository();
1170             var archive = credentials.getHostedRepository();
1171             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
1172             var censusBuilder = credentials.getCensusBuilder()
1173                                            .addReviewer(reviewer.forge().currentUser().id())
1174                                            .addAuthor(author.forge().currentUser().id());
1175             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
1176             var mlBot = MailingListBridgeBot.newBuilder()
1177                                             .from(from)
1178                                             .repo(author)
1179                                             .archive(archive)
1180                                             .censusRepo(censusBuilder.build())
1181                                             .lists(List.of(new MailingListConfiguration(listAddress, Set.of())))
1182                                             .listArchive(listServer.getArchive())
1183                                             .smtpServer(listServer.getSMTP())
<span class="line-modified">1184                                             .webrevStorageHTMLRepository(archive)</span>
1185                                             .webrevStorageRef(&quot;webrev&quot;)
1186                                             .webrevStorageBase(Path.of(&quot;test&quot;))
1187                                             .webrevStorageBaseUri(webrevServer.uri())
1188                                             .issueTracker(URIBuilder.base(&quot;http://issues.test/browse/&quot;).build())
1189                                             .build();
1190 
1191             // Populate the projects repository
1192             var reviewFile = Path.of(&quot;reviewfile.txt&quot;);
1193             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType(), reviewFile);
1194             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
1195             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
1196             localRepo.push(masterHash, archive.url(), &quot;webrev&quot;, true);
1197 
1198             // Make a change with a corresponding PR
1199             var editHash = CheckableRepository.appendAndCommit(localRepo);
1200             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
1201             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
1202             pr.setBody(&quot;This is now ready&quot;);
1203             TestBotRunner.runPeriodicItems(mlBot);
1204             listServer.processIncoming();
</pre>
<hr />
<pre>
1229              var tempFolder = new TemporaryDirectory();
1230              var archiveFolder = new TemporaryDirectory();
1231              var listServer = new TestMailmanServer();
1232              var webrevServer = new TestWebrevServer()) {
1233             var author = credentials.getHostedRepository();
1234             var reviewer = credentials.getHostedRepository();
1235             var archive = credentials.getHostedRepository();
1236             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
1237             var censusBuilder = credentials.getCensusBuilder()
1238                                            .addReviewer(reviewer.forge().currentUser().id())
1239                                            .addAuthor(author.forge().currentUser().id());
1240             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
1241             var mlBot = MailingListBridgeBot.newBuilder()
1242                                             .from(from)
1243                                             .repo(author)
1244                                             .archive(archive)
1245                                             .censusRepo(censusBuilder.build())
1246                                             .lists(List.of(new MailingListConfiguration(listAddress, Set.of())))
1247                                             .listArchive(listServer.getArchive())
1248                                             .smtpServer(listServer.getSMTP())
<span class="line-modified">1249                                             .webrevStorageHTMLRepository(archive)</span>
1250                                             .webrevStorageRef(&quot;webrev&quot;)
1251                                             .webrevStorageBase(Path.of(&quot;test&quot;))
1252                                             .webrevStorageBaseUri(webrevServer.uri())
1253                                             .issueTracker(URIBuilder.base(&quot;http://issues.test/browse/&quot;).build())
1254                                             .build();
1255 
1256             // Populate the projects repository
1257             var reviewFile = Path.of(&quot;reviewfile.txt&quot;);
1258             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType(), reviewFile);
1259             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
1260             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
1261             localRepo.push(masterHash, archive.url(), &quot;webrev&quot;, true);
1262 
1263             // Make a change with a corresponding PR
1264             var editHash = CheckableRepository.appendAndCommit(localRepo);
1265             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
1266             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
1267             pr.setBody(&quot;This is now ready&quot;);
1268             TestBotRunner.runPeriodicItems(mlBot);
1269             listServer.processIncoming();
</pre>
<hr />
<pre>
1292     void reviewContext(TestInfo testInfo) throws IOException {
1293         try (var credentials = new HostCredentials(testInfo);
1294              var tempFolder = new TemporaryDirectory();
1295              var archiveFolder = new TemporaryDirectory();
1296              var listServer = new TestMailmanServer();
1297              var webrevServer = new TestWebrevServer()) {
1298             var author = credentials.getHostedRepository();
1299             var archive = credentials.getHostedRepository();
1300             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
1301             var censusBuilder = credentials.getCensusBuilder()
1302                                            .addAuthor(author.forge().currentUser().id());
1303             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
1304             var mlBot = MailingListBridgeBot.newBuilder()
1305                                             .from(from)
1306                                             .repo(author)
1307                                             .archive(archive)
1308                                             .censusRepo(censusBuilder.build())
1309                                             .lists(List.of(new MailingListConfiguration(listAddress, Set.of())))
1310                                             .listArchive(listServer.getArchive())
1311                                             .smtpServer(listServer.getSMTP())
<span class="line-modified">1312                                             .webrevStorageHTMLRepository(archive)</span>
1313                                             .webrevStorageRef(&quot;webrev&quot;)
1314                                             .webrevStorageBase(Path.of(&quot;test&quot;))
1315                                             .webrevStorageBaseUri(webrevServer.uri())
1316                                             .issueTracker(URIBuilder.base(&quot;http://issues.test/browse/&quot;).build())
1317                                             .build();
1318 
1319             // Populate the projects repository
1320             var reviewFile = Path.of(&quot;reviewfile.txt&quot;);
1321             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType(), reviewFile);
1322             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
1323             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
1324             localRepo.push(masterHash, archive.url(), &quot;webrev&quot;, true);
1325 
1326             // Make a change with a corresponding PR
1327             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;Line 1\nLine 2\nLine 3\nLine 4&quot;);
1328             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
1329             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
1330             pr.setBody(&quot;This is now ready&quot;);
1331             TestBotRunner.runPeriodicItems(mlBot);
1332             listServer.processIncoming();
</pre>
<hr />
<pre>
1349     void multipleReviewContexts(TestInfo testInfo) throws IOException {
1350         try (var credentials = new HostCredentials(testInfo);
1351              var tempFolder = new TemporaryDirectory();
1352              var archiveFolder = new TemporaryDirectory();
1353              var listServer = new TestMailmanServer();
1354              var webrevServer = new TestWebrevServer()) {
1355             var author = credentials.getHostedRepository();
1356             var archive = credentials.getHostedRepository();
1357             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
1358             var censusBuilder = credentials.getCensusBuilder()
1359                                            .addAuthor(author.forge().currentUser().id());
1360             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
1361             var mlBot = MailingListBridgeBot.newBuilder()
1362                                             .from(from)
1363                                             .repo(author)
1364                                             .archive(archive)
1365                                             .censusRepo(censusBuilder.build())
1366                                             .lists(List.of(new MailingListConfiguration(listAddress, Set.of())))
1367                                             .listArchive(listServer.getArchive())
1368                                             .smtpServer(listServer.getSMTP())
<span class="line-modified">1369                                             .webrevStorageHTMLRepository(archive)</span>
1370                                             .webrevStorageRef(&quot;webrev&quot;)
1371                                             .webrevStorageBase(Path.of(&quot;test&quot;))
1372                                             .webrevStorageBaseUri(webrevServer.uri())
1373                                             .issueTracker(URIBuilder.base(&quot;http://issues.test/browse/&quot;).build())
1374                                             .build();
1375 
1376             // Populate the projects repository
1377             var reviewFile = Path.of(&quot;reviewfile.txt&quot;);
1378             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType(), reviewFile);
1379             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
1380             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
1381             localRepo.push(masterHash, archive.url(), &quot;webrev&quot;, true);
1382             var initialHash = CheckableRepository.appendAndCommit(localRepo,
1383                                                                   &quot;Line 0.1\nLine 0.2\nLine 0.3\nLine 0.4\n&quot; +
1384                                                                           &quot;Line 1\nLine 2\nLine 3\nLine 4\n&quot; +
1385                                                                           &quot;Line 5\nLine 6\nLine 7\nLine 8\n&quot; +
1386                                                                           &quot;Line 8.1\nLine 8.2\nLine 8.3\nLine 8.4\n&quot; +
1387                                                                           &quot;Line 9\nLine 10\nLine 11\nLine 12\n&quot; +
1388                                                                           &quot;Line 13\nLine 14\nLine 15\nLine 16\n&quot;);
1389             localRepo.push(initialHash, author.url(), &quot;master&quot;);
</pre>
<hr />
<pre>
1425     void filterComments(TestInfo testInfo) throws IOException {
1426         try (var credentials = new HostCredentials(testInfo);
1427              var tempFolder = new TemporaryDirectory();
1428              var archiveFolder = new TemporaryDirectory();
1429              var listServer = new TestMailmanServer();
1430              var webrevServer = new TestWebrevServer()) {
1431             var author = credentials.getHostedRepository();
1432             var archive = credentials.getHostedRepository();
1433             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
1434             var censusBuilder = credentials.getCensusBuilder()
1435                                            .addAuthor(author.forge().currentUser().id());
1436             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
1437             var mlBot = MailingListBridgeBot.newBuilder()
1438                                             .from(from)
1439                                             .repo(author)
1440                                             .archive(archive)
1441                                             .censusRepo(censusBuilder.build())
1442                                             .lists(List.of(new MailingListConfiguration(listAddress, Set.of())))
1443                                             .listArchive(listServer.getArchive())
1444                                             .smtpServer(listServer.getSMTP())
<span class="line-modified">1445                                             .webrevStorageHTMLRepository(archive)</span>
1446                                             .webrevStorageRef(&quot;webrev&quot;)
1447                                             .webrevStorageBase(Path.of(&quot;test&quot;))
1448                                             .webrevStorageBaseUri(webrevServer.uri())
1449                                             .issueTracker(URIBuilder.base(&quot;http://issues.test/browse/&quot;).build())
1450                                             .build();
1451 
1452             // Populate the projects repository
1453             var reviewFile = Path.of(&quot;reviewfile.txt&quot;);
1454             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType(), reviewFile);
1455             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
1456             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
1457             localRepo.push(masterHash, archive.url(), &quot;webrev&quot;, true);
1458 
1459             // Make a change with a corresponding PR
1460             var editHash = CheckableRepository.appendAndCommit(localRepo);
1461             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
1462             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
1463             pr.setBody(&quot;This is now ready\n&lt;!-- this is a comment --&gt;\nAnd this is not\n&quot; +
1464                                &quot;&lt;!-- Anything below this marker will be hidden --&gt;\nStatus stuff&quot;);
1465 
</pre>
<hr />
<pre>
1491         try (var credentials = new HostCredentials(testInfo);
1492              var tempFolder = new TemporaryDirectory();
1493              var archiveFolder = new TemporaryDirectory();
1494              var listServer = new TestMailmanServer();
1495              var webrevServer = new TestWebrevServer()) {
1496             var author = credentials.getHostedRepository();
1497             var archive = credentials.getHostedRepository();
1498             var commenter = credentials.getHostedRepository();
1499             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
1500             var censusBuilder = credentials.getCensusBuilder()
1501                                            .addAuthor(author.forge().currentUser().id());
1502             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
1503             var mlBot = MailingListBridgeBot.newBuilder()
1504                                             .from(from)
1505                                             .repo(author)
1506                                             .archive(archive)
1507                                             .censusRepo(censusBuilder.build())
1508                                             .lists(List.of(new MailingListConfiguration(listAddress, Set.of())))
1509                                             .listArchive(listServer.getArchive())
1510                                             .smtpServer(listServer.getSMTP())
<span class="line-modified">1511                                             .webrevStorageHTMLRepository(archive)</span>
1512                                             .webrevStorageRef(&quot;webrev&quot;)
1513                                             .webrevStorageBase(Path.of(&quot;test&quot;))
1514                                             .webrevStorageBaseUri(webrevServer.uri())
1515                                             .issueTracker(URIBuilder.base(&quot;http://issues.test/browse/&quot;).build())
1516                                             .build();
1517 
1518             // Populate the projects repository
1519             var reviewFile = Path.of(&quot;reviewfile.txt&quot;);
1520             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType(), reviewFile);
1521             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
1522             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
1523             localRepo.push(masterHash, archive.url(), &quot;webrev&quot;, true);
1524 
1525             // Make a change with a corresponding PR
1526             var editHash = CheckableRepository.appendAndCommit(localRepo);
1527             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
1528             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
1529             pr.setBody(&quot;This is now ready&quot;);
1530 
1531             // Run an archive pass
</pre>
<hr />
<pre>
1621     void rebased(TestInfo testInfo) throws IOException {
1622         try (var credentials = new HostCredentials(testInfo);
1623              var tempFolder = new TemporaryDirectory();
1624              var archiveFolder = new TemporaryDirectory();
1625              var listServer = new TestMailmanServer();
1626              var webrevServer = new TestWebrevServer()) {
1627             var author = credentials.getHostedRepository();
1628             var archive = credentials.getHostedRepository();
1629             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
1630             var censusBuilder = credentials.getCensusBuilder()
1631                                            .addAuthor(author.forge().currentUser().id());
1632             var sender = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
1633             var mlBot = MailingListBridgeBot.newBuilder()
1634                                             .from(sender)
1635                                             .repo(author)
1636                                             .archive(archive)
1637                                             .censusRepo(censusBuilder.build())
1638                                             .lists(List.of(new MailingListConfiguration(listAddress, Set.of())))
1639                                             .listArchive(listServer.getArchive())
1640                                             .smtpServer(listServer.getSMTP())
<span class="line-modified">1641                                             .webrevStorageHTMLRepository(archive)</span>
1642                                             .webrevStorageRef(&quot;webrev&quot;)
1643                                             .webrevStorageBase(Path.of(&quot;test&quot;))
1644                                             .webrevStorageBaseUri(webrevServer.uri())
1645                                             .issueTracker(URIBuilder.base(&quot;http://issues.test/browse/&quot;).build())
1646                                             .build();
1647 
1648             // Populate the projects repository
1649             var reviewFile = Path.of(&quot;reviewfile.txt&quot;);
1650             var localRepo = CheckableRepository.init(tempFolder.path().resolve(&quot;first&quot;), author.repositoryType(), reviewFile);
1651             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
1652             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
1653             localRepo.push(masterHash, archive.url(), &quot;webrev&quot;, true);
1654 
1655             // Make a change with a corresponding PR
1656             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;A line&quot;, &quot;Original msg&quot;);
1657             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
1658             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
1659             pr.setBody(&quot;This is now ready&quot;);
1660 
1661             // Run an archive pass
</pre>
<hr />
<pre>
1718         try (var credentials = new HostCredentials(testInfo);
1719              var tempFolder = new TemporaryDirectory();
1720              var archiveFolder = new TemporaryDirectory();
1721              var listServer = new TestMailmanServer();
1722              var webrevServer = new TestWebrevServer()) {
1723             var author = credentials.getHostedRepository();
1724             var archive = credentials.getHostedRepository();
1725             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
1726             var censusBuilder = credentials.getCensusBuilder()
1727                                            .addAuthor(author.forge().currentUser().id());
1728             var sender = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
1729             var mlBot = MailingListBridgeBot.newBuilder()
1730                                             .from(sender)
1731                                             .repo(author)
1732                                             .archive(archive)
1733                                             .archiveRef(&quot;archive&quot;)
1734                                             .censusRepo(censusBuilder.build())
1735                                             .lists(List.of(new MailingListConfiguration(listAddress, Set.of())))
1736                                             .listArchive(listServer.getArchive())
1737                                             .smtpServer(listServer.getSMTP())
<span class="line-modified">1738                                             .webrevStorageHTMLRepository(archive)</span>
1739                                             .webrevStorageRef(&quot;webrev&quot;)
1740                                             .webrevStorageBase(Path.of(&quot;test&quot;))
1741                                             .webrevStorageBaseUri(webrevServer.uri())
1742                                             .issueTracker(URIBuilder.base(&quot;http://issues.test/browse/&quot;).build())
1743                                             .build();
1744 
1745             // Populate the projects repository
1746             var reviewFile = Path.of(&quot;reviewfile.txt&quot;);
1747             var localRepo = CheckableRepository.init(tempFolder.path().resolve(&quot;first&quot;), author.repositoryType(), reviewFile);
1748             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
1749             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
1750             localRepo.push(masterHash, archive.url(), &quot;webrev&quot;, true);
1751             localRepo.push(masterHash, archive.url(), &quot;archive&quot;, true);
1752 
1753             // Make a change with a corresponding PR
1754             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;A line&quot;, &quot;Original msg&quot;);
1755             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
1756             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
1757             pr.setBody(&quot;This is now ready&quot;);
1758 
</pre>
<hr />
<pre>
1808              var tempFolder = new TemporaryDirectory();
1809              var archiveFolder = new TemporaryDirectory();
1810              var listServer = new TestMailmanServer();
1811              var webrevServer = new TestWebrevServer()) {
1812             var author = credentials.getHostedRepository();
1813             var archive = credentials.getHostedRepository();
1814             var commenter = credentials.getHostedRepository();
1815             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
1816             var censusBuilder = credentials.getCensusBuilder()
1817                                            .addAuthor(author.forge().currentUser().id());
1818             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
1819             var mlBot = MailingListBridgeBot.newBuilder()
1820                                             .from(from)
1821                                             .repo(author)
1822                                             .archive(archive)
1823                                             .archiveRef(&quot;archive&quot;)
1824                                             .censusRepo(censusBuilder.build())
1825                                             .lists(List.of(new MailingListConfiguration(listAddress, Set.of())))
1826                                             .listArchive(listServer.getArchive())
1827                                             .smtpServer(listServer.getSMTP())
<span class="line-modified">1828                                             .webrevStorageHTMLRepository(archive)</span>
1829                                             .webrevStorageRef(&quot;webrev&quot;)
1830                                             .webrevStorageBase(Path.of(&quot;test&quot;))
1831                                             .webrevStorageBaseUri(webrevServer.uri())
1832                                             .issueTracker(URIBuilder.base(&quot;http://issues.test/browse/&quot;).build())
1833                                             .build();
1834 
1835             // Populate the projects repository
1836             var reviewFile = Path.of(&quot;reviewfile.txt&quot;);
1837             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType(), reviewFile);
1838             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
1839             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
1840             localRepo.push(masterHash, archive.url(), &quot;archive&quot;, true);
1841             localRepo.push(masterHash, archive.url(), &quot;webrev&quot;, true);
1842 
1843             // Create a diverging branch
1844             var editOnlyFile = Path.of(&quot;editonly.txt&quot;);
1845             Files.writeString(localRepo.root().resolve(editOnlyFile), &quot;Only added in the edit&quot;);
1846             localRepo.add(editOnlyFile);
1847             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;Edited&quot;);
1848             localRepo.push(editHash, author.url(), &quot;edit&quot;);
</pre>
<hr />
<pre>
1894              var tempFolder = new TemporaryDirectory();
1895              var archiveFolder = new TemporaryDirectory();
1896              var listServer = new TestMailmanServer();
1897              var webrevServer = new TestWebrevServer()) {
1898             var author = credentials.getHostedRepository();
1899             var archive = credentials.getHostedRepository();
1900             var commenter = credentials.getHostedRepository();
1901             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
1902             var censusBuilder = credentials.getCensusBuilder()
1903                                            .addAuthor(author.forge().currentUser().id());
1904             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
1905             var mlBot = MailingListBridgeBot.newBuilder()
1906                                             .from(from)
1907                                             .repo(author)
1908                                             .archive(archive)
1909                                             .archiveRef(&quot;archive&quot;)
1910                                             .censusRepo(censusBuilder.build())
1911                                             .lists(List.of(new MailingListConfiguration(listAddress, Set.of())))
1912                                             .listArchive(listServer.getArchive())
1913                                             .smtpServer(listServer.getSMTP())
<span class="line-modified">1914                                             .webrevStorageHTMLRepository(archive)</span>
1915                                             .webrevStorageRef(&quot;webrev&quot;)
1916                                             .webrevStorageBase(Path.of(&quot;test&quot;))
1917                                             .webrevStorageBaseUri(webrevServer.uri())
1918                                             .issueTracker(URIBuilder.base(&quot;http://issues.test/browse/&quot;).build())
1919                                             .build();
1920 
1921             // Populate the projects repository
1922             var reviewFile = Path.of(&quot;reviewfile.txt&quot;);
1923             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType(), reviewFile);
1924             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
1925             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
1926             localRepo.push(masterHash, archive.url(), &quot;archive&quot;, true);
1927             localRepo.push(masterHash, archive.url(), &quot;webrev&quot;, true);
1928 
1929             // Create a merge
1930             var editOnlyFile = Path.of(&quot;editonly.txt&quot;);
1931             Files.writeString(localRepo.root().resolve(editOnlyFile), &quot;Only added in the edit&quot;);
1932             localRepo.add(editOnlyFile);
1933             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;Edited&quot;);
1934             localRepo.checkout(masterHash, true);
</pre>
<hr />
<pre>
1966              var tempFolder = new TemporaryDirectory();
1967              var archiveFolder = new TemporaryDirectory();
1968              var listServer = new TestMailmanServer();
1969              var webrevServer = new TestWebrevServer()) {
1970             var author = credentials.getHostedRepository();
1971             var archive = credentials.getHostedRepository();
1972             var commenter = credentials.getHostedRepository();
1973             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
1974             var censusBuilder = credentials.getCensusBuilder()
1975                                            .addAuthor(author.forge().currentUser().id());
1976             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
1977             var mlBot = MailingListBridgeBot.newBuilder()
1978                                             .from(from)
1979                                             .repo(author)
1980                                             .archive(archive)
1981                                             .archiveRef(&quot;archive&quot;)
1982                                             .censusRepo(censusBuilder.build())
1983                                             .lists(List.of(new MailingListConfiguration(listAddress, Set.of())))
1984                                             .listArchive(listServer.getArchive())
1985                                             .smtpServer(listServer.getSMTP())
<span class="line-modified">1986                                             .webrevStorageHTMLRepository(archive)</span>
1987                                             .webrevStorageRef(&quot;webrev&quot;)
1988                                             .webrevStorageBase(Path.of(&quot;test&quot;))
1989                                             .webrevStorageBaseUri(webrevServer.uri())
1990                                             .issueTracker(URIBuilder.base(&quot;http://issues.test/browse/&quot;).build())
1991                                             .build();
1992 
1993             // Populate the projects repository
1994             var reviewFile = Path.of(&quot;reviewfile.txt&quot;);
1995             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType(), reviewFile);
1996             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
1997             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
1998             localRepo.push(masterHash, archive.url(), &quot;archive&quot;, true);
1999             localRepo.push(masterHash, archive.url(), &quot;webrev&quot;, true);
2000 
2001             // Create a merge
2002             var editOnlyFile = Path.of(&quot;editonly.txt&quot;);
2003             Files.writeString(localRepo.root().resolve(editOnlyFile), &quot;Only added in the edit&quot;);
2004             localRepo.add(editOnlyFile);
2005             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;Edited&quot;, &quot;Commit in edit branch&quot;);
2006             localRepo.checkout(masterHash, true);
</pre>
<hr />
<pre>
2037              var archiveFolder = new TemporaryDirectory();
2038              var webrevFolder = new TemporaryDirectory();
2039              var listServer = new TestMailmanServer();
2040              var webrevServer = new TestWebrevServer()) {
2041             var author = credentials.getHostedRepository();
2042             var archive = credentials.getHostedRepository();
2043             var ignored = credentials.getHostedRepository();
2044             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
2045             var censusBuilder = credentials.getCensusBuilder()
2046                                            .addAuthor(author.forge().currentUser().id());
2047             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
2048             var mlBot = MailingListBridgeBot.newBuilder()
2049                                             .from(from)
2050                                             .repo(author)
2051                                             .archive(archive)
2052                                             .censusRepo(censusBuilder.build())
2053                                             .lists(List.of(new MailingListConfiguration(listAddress, Set.of())))
2054                                             .ignoredUsers(Set.of(ignored.forge().currentUser().userName()))
2055                                             .listArchive(listServer.getArchive())
2056                                             .smtpServer(listServer.getSMTP())
<span class="line-modified">2057                                             .webrevStorageHTMLRepository(archive)</span>
2058                                             .webrevStorageRef(&quot;webrev&quot;)
2059                                             .webrevStorageBase(Path.of(&quot;test&quot;))
2060                                             .webrevStorageBaseUri(webrevServer.uri())
2061                                             .issueTracker(URIBuilder.base(&quot;http://issues.test/browse/&quot;).build())
2062                                             .build();
2063 
2064             // Populate the projects repository
2065             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType());
2066             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
2067             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
2068             localRepo.push(masterHash, archive.url(), &quot;webrev&quot;, true);
2069 
2070             // Make a change with a corresponding PR
2071             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;A simple change&quot;,
2072                                                                &quot;Change msg\n\nWith several lines&quot;);
2073             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
2074             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
2075 
2076             // Flag it as ready for review
2077             pr.setBody(&quot;This should now be ready&quot;);
</pre>
<hr />
<pre>
2117              var tempFolder = new TemporaryDirectory();
2118              var archiveFolder = new TemporaryDirectory();
2119              var listServer = new TestMailmanServer();
2120              var webrevServer = new TestWebrevServer()) {
2121             var author = credentials.getHostedRepository();
2122             var archive = credentials.getHostedRepository();
2123             var reviewer = credentials.getHostedRepository();
2124             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
2125             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
2126             var censusBuilder = credentials.getCensusBuilder()
2127                                            .addReviewer(reviewer.forge().currentUser().id())
2128                                            .addAuthor(author.forge().currentUser().id());
2129             var mlBot = MailingListBridgeBot.newBuilder()
2130                                             .from(from)
2131                                             .repo(author)
2132                                             .archive(archive)
2133                                             .censusRepo(censusBuilder.build())
2134                                             .lists(List.of(new MailingListConfiguration(listAddress, Set.of())))
2135                                             .listArchive(listServer.getArchive())
2136                                             .smtpServer(listServer.getSMTP())
<span class="line-modified">2137                                             .webrevStorageHTMLRepository(archive)</span>
2138                                             .webrevStorageRef(&quot;webrev&quot;)
2139                                             .webrevStorageBase(Path.of(&quot;test&quot;))
2140                                             .webrevStorageBaseUri(webrevServer.uri())
2141                                             .issueTracker(URIBuilder.base(&quot;http://issues.test/browse/&quot;).build())
2142                                             .build();
2143 
2144             // Populate the projects repository
2145             var reviewFile = Path.of(&quot;reviewfile.txt&quot;);
2146             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType(), reviewFile);
2147             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
2148             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
2149             localRepo.push(masterHash, archive.url(), &quot;webrev&quot;, true);
2150 
2151             // Make a change with a corresponding PR
2152             var editHash = CheckableRepository.appendAndCommit(localRepo);
2153             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
2154             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
2155             pr.setBody(&quot;This is now ready&quot;);
2156 
2157             // Run an archive pass
</pre>
<hr />
<pre>
2208              var archiveFolder = new TemporaryDirectory();
2209              var listServer = new TestMailmanServer();
2210              var webrevServer = new TestWebrevServer()) {
2211             var author = credentials.getHostedRepository();
2212             var ignored = credentials.getHostedRepository();
2213             var archive = credentials.getHostedRepository();
2214             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
2215             var censusBuilder = credentials.getCensusBuilder()
2216                                            .addAuthor(author.forge().currentUser().id());
2217             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
2218             var mlBot = MailingListBridgeBot.newBuilder()
2219                                             .from(from)
2220                                             .repo(author)
2221                                             .archive(archive)
2222                                             .censusRepo(censusBuilder.build())
2223                                             .lists(List.of(new MailingListConfiguration(listAddress, Set.of())))
2224                                             .ignoredUsers(Set.of(ignored.forge().currentUser().userName()))
2225                                             .ignoredComments(Set.of(Pattern.compile(&quot;ignore this comment&quot;, Pattern.MULTILINE | Pattern.DOTALL)))
2226                                             .listArchive(listServer.getArchive())
2227                                             .smtpServer(listServer.getSMTP())
<span class="line-modified">2228                                             .webrevStorageHTMLRepository(archive)</span>
2229                                             .webrevStorageRef(&quot;webrev&quot;)
2230                                             .webrevStorageBase(Path.of(&quot;test&quot;))
2231                                             .webrevStorageBaseUri(webrevServer.uri())
2232                                             .issueTracker(URIBuilder.base(&quot;http://issues.test/browse/&quot;).build())
2233                                             .build();
2234 
2235             // Populate the projects repository
2236             var reviewFile = Path.of(&quot;reviewfile.txt&quot;);
2237             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType(), reviewFile);
2238             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
2239             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
2240             localRepo.push(masterHash, archive.url(), &quot;webrev&quot;, true);
2241 
2242             // Make a change with a corresponding PR
2243             var editHash = CheckableRepository.appendAndCommit(localRepo);
2244             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
2245             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
2246             pr.setBody(&quot;This is now ready&quot;);
2247 
2248             // Make a bunch of comments
</pre>
<hr />
<pre>
2273              var tempFolder = new TemporaryDirectory();
2274              var archiveFolder = new TemporaryDirectory();
2275              var listServer = new TestMailmanServer();
2276              var webrevServer = new TestWebrevServer()) {
2277             var author = credentials.getHostedRepository();
2278             var reviewer = credentials.getHostedRepository();
2279             var archive = credentials.getHostedRepository();
2280             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
2281             var censusBuilder = credentials.getCensusBuilder()
2282                                            .addReviewer(reviewer.forge().currentUser().id())
2283                                            .addAuthor(author.forge().currentUser().id());
2284             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
2285             var mlBot = MailingListBridgeBot.newBuilder()
2286                                             .from(from)
2287                                             .repo(author)
2288                                             .archive(archive)
2289                                             .censusRepo(censusBuilder.build())
2290                                             .lists(List.of(new MailingListConfiguration(listAddress, Set.of())))
2291                                             .listArchive(listServer.getArchive())
2292                                             .smtpServer(listServer.getSMTP())
<span class="line-modified">2293                                             .webrevStorageHTMLRepository(archive)</span>
2294                                             .webrevStorageRef(&quot;webrev&quot;)
2295                                             .webrevStorageBase(Path.of(&quot;test&quot;))
2296                                             .webrevStorageBaseUri(webrevServer.uri())
2297                                             .issueTracker(URIBuilder.base(&quot;http://issues.test/browse/&quot;).build())
2298                                             .build();
2299 
2300             // Populate the projects repository
2301             var reviewFile = Path.of(&quot;reviewfile.txt&quot;);
2302             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType(), reviewFile);
2303             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
2304             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
2305             localRepo.push(masterHash, archive.url(), &quot;webrev&quot;, true);
2306 
2307             // Make a change with a corresponding PR
2308             var editHash = CheckableRepository.appendAndCommit(localRepo);
2309             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
2310             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
2311             pr.setBody(&quot;This is now ready&quot;);
2312             TestBotRunner.runPeriodicItems(mlBot);
2313             listServer.processIncoming();
</pre>
<hr />
<pre>
2334              var tempFolder = new TemporaryDirectory();
2335              var archiveFolder = new TemporaryDirectory();
2336              var listServer = new TestMailmanServer();
2337              var webrevServer = new TestWebrevServer()) {
2338             var bot = credentials.getHostedRepository();
2339             var author = credentials.getHostedRepository();
2340             var archive = credentials.getHostedRepository();
2341             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
2342             var censusBuilder = credentials.getCensusBuilder()
2343                                            .addAuthor(author.forge().currentUser().id());
2344             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
2345             var mlBotBuilder = MailingListBridgeBot.newBuilder()
2346                                                    .from(from)
2347                                                    .repo(bot)
2348                                                    .ignoredUsers(Set.of(bot.forge().currentUser().userName()))
2349                                                    .archive(archive)
2350                                                    .censusRepo(censusBuilder.build())
2351                                                    .lists(List.of(new MailingListConfiguration(listAddress, Set.of())))
2352                                                    .listArchive(listServer.getArchive())
2353                                                    .smtpServer(listServer.getSMTP())
<span class="line-modified">2354                                                    .webrevStorageHTMLRepository(archive)</span>
2355                                                    .webrevStorageRef(&quot;webrev&quot;)
2356                                                    .webrevStorageBase(Path.of(&quot;test&quot;))
2357                                                    .webrevStorageBaseUri(webrevServer.uri())
2358                                                    .issueTracker(URIBuilder.base(&quot;http://issues.test/browse/&quot;).build());
2359 
2360             // Populate the projects repository
2361             var reviewFile = Path.of(&quot;reviewfile.txt&quot;);
2362             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType(), reviewFile);
2363             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
2364             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
2365             localRepo.push(masterHash, archive.url(), &quot;webrev&quot;, true);
2366 
2367             // Make a change with a corresponding PR
2368             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;Line 1\nLine 2\nLine 3\nLine 4&quot;);
2369             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
2370             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
2371             pr.setBody(&quot;This is now ready&quot;);
2372 
2373             var mlBot = mlBotBuilder.build();
2374             var mlBotWithCooldown = mlBotBuilder.cooldown(Duration.ofDays(1)).build();
</pre>
<hr />
<pre>
2399              var tempFolder = new TemporaryDirectory();
2400              var archiveFolder = new TemporaryDirectory();
2401              var listServer = new TestMailmanServer();
2402              var webrevServer = new TestWebrevServer()) {
2403             var bot = credentials.getHostedRepository();
2404             var author = credentials.getHostedRepository();
2405             var archive = credentials.getHostedRepository();
2406             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
2407             var censusBuilder = credentials.getCensusBuilder()
2408                                            .addAuthor(author.forge().currentUser().id());
2409             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
2410             var mlBotBuilder = MailingListBridgeBot.newBuilder()
2411                                                    .from(from)
2412                                                    .repo(bot)
2413                                                    .ignoredUsers(Set.of(bot.forge().currentUser().userName()))
2414                                                    .archive(archive)
2415                                                    .censusRepo(censusBuilder.build())
2416                                                    .lists(List.of(new MailingListConfiguration(listAddress, Set.of())))
2417                                                    .listArchive(listServer.getArchive())
2418                                                    .smtpServer(listServer.getSMTP())
<span class="line-modified">2419                                                    .webrevStorageHTMLRepository(archive)</span>
2420                                                    .webrevStorageRef(&quot;webrev&quot;)
2421                                                    .webrevStorageBase(Path.of(&quot;test&quot;))
2422                                                    .webrevStorageBaseUri(webrevServer.uri())
2423                                                    .issueTracker(URIBuilder.base(&quot;http://issues.test/browse/&quot;).build());
2424 
2425             // Populate the projects repository
2426             var reviewFile = Path.of(&quot;reviewfile.txt&quot;);
2427             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType(), reviewFile);
2428             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
2429             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
2430             localRepo.push(masterHash, archive.url(), &quot;webrev&quot;, true);
2431 
2432             // Make a change with a corresponding PR
2433             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;Line 1\nLine 2\nLine 3\nLine 4&quot;);
2434             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
2435             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
2436             pr.setBody(&quot;This is now ready&quot;);
2437 
2438             var mlBot = mlBotBuilder.build();
2439             var mlBotWithCooldown = mlBotBuilder.cooldown(Duration.ofDays(1)).build();
</pre>
<hr />
<pre>
2466              var archiveFolder = new TemporaryDirectory();
2467              var listServer = new TestMailmanServer();
2468              var webrevServer = new TestWebrevServer()) {
2469             var bot = credentials.getHostedRepository();
2470             var author = credentials.getHostedRepository();
2471             var archive = credentials.getHostedRepository();
2472             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
2473             var censusBuilder = credentials.getCensusBuilder()
2474                                            .addAuthor(author.forge().currentUser().id());
2475             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
2476             var cooldown = Duration.ofMillis(500);
2477             var mlBotBuilder = MailingListBridgeBot.newBuilder()
2478                                                    .from(from)
2479                                                    .repo(bot)
2480                                                    .ignoredUsers(Set.of(bot.forge().currentUser().userName()))
2481                                                    .archive(archive)
2482                                                    .censusRepo(censusBuilder.build())
2483                                                    .lists(List.of(new MailingListConfiguration(listAddress, Set.of())))
2484                                                    .listArchive(listServer.getArchive())
2485                                                    .smtpServer(listServer.getSMTP())
<span class="line-modified">2486                                                    .webrevStorageHTMLRepository(archive)</span>
2487                                                    .webrevStorageRef(&quot;webrev&quot;)
2488                                                    .webrevStorageBase(Path.of(&quot;test&quot;))
2489                                                    .webrevStorageBaseUri(webrevServer.uri())
2490                                                    .issueTracker(URIBuilder.base(&quot;http://issues.test/browse/&quot;).build());
2491 
2492             // Populate the projects repository
2493             var reviewFile = Path.of(&quot;reviewfile.txt&quot;);
2494             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType(), reviewFile);
2495             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
2496             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
2497             localRepo.push(masterHash, archive.url(), &quot;webrev&quot;, true);
2498 
2499             // Make a change with a corresponding PR
2500             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;Line 1\nLine 2\nLine 3\nLine 4&quot;);
2501             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
2502             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
2503             pr.setBody(&quot;This is now ready&quot;);
2504 
2505             var mlBot = mlBotBuilder.cooldown(cooldown).build();
2506             Thread.sleep(cooldown.toMillis());
</pre>
<hr />
<pre>
2555     void branchPrefix(TestInfo testInfo) throws IOException {
2556         try (var credentials = new HostCredentials(testInfo);
2557              var tempFolder = new TemporaryDirectory();
2558              var archiveFolder = new TemporaryDirectory();
2559              var listServer = new TestMailmanServer();
2560              var webrevServer = new TestWebrevServer()) {
2561             var author = credentials.getHostedRepository();
2562             var archive = credentials.getHostedRepository();
2563             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
2564             var censusBuilder = credentials.getCensusBuilder()
2565                                            .addAuthor(author.forge().currentUser().id());
2566             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
2567             var mlBot = MailingListBridgeBot.newBuilder()
2568                                             .from(from)
2569                                             .repo(author)
2570                                             .archive(archive)
2571                                             .censusRepo(censusBuilder.build())
2572                                             .lists(List.of(new MailingListConfiguration(listAddress, Set.of())))
2573                                             .listArchive(listServer.getArchive())
2574                                             .smtpServer(listServer.getSMTP())
<span class="line-modified">2575                                             .webrevStorageHTMLRepository(archive)</span>
2576                                             .webrevStorageRef(&quot;webrev&quot;)
2577                                             .webrevStorageBase(Path.of(&quot;test&quot;))
2578                                             .webrevStorageBaseUri(webrevServer.uri())
2579                                             .issueTracker(URIBuilder.base(&quot;http://issues.test/browse/&quot;).build())
2580                                             .branchInSubject(Pattern.compile(&quot;.*&quot;))
2581                                             .build();
2582 
2583             // Populate the projects repository
2584             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType());
2585             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
2586             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
2587             localRepo.push(masterHash, archive.url(), &quot;webrev&quot;, true);
2588 
2589             // Make a change with a corresponding PR
2590             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;A simple change&quot;,
2591                                                                &quot;Change msg\n\nWith several lines&quot;);
2592             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
2593             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;1234: This is a pull request&quot;);
2594             pr.setBody(&quot;This is a PR&quot;);
2595 
</pre>
<hr />
<pre>
2612     void repoPrefix(TestInfo testInfo) throws IOException {
2613         try (var credentials = new HostCredentials(testInfo);
2614              var tempFolder = new TemporaryDirectory();
2615              var archiveFolder = new TemporaryDirectory();
2616              var listServer = new TestMailmanServer();
2617              var webrevServer = new TestWebrevServer()) {
2618             var author = credentials.getHostedRepository();
2619             var archive = credentials.getHostedRepository();
2620             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
2621             var censusBuilder = credentials.getCensusBuilder()
2622                                            .addAuthor(author.forge().currentUser().id());
2623             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
2624             var mlBot = MailingListBridgeBot.newBuilder()
2625                                             .from(from)
2626                                             .repo(author)
2627                                             .archive(archive)
2628                                             .censusRepo(censusBuilder.build())
2629                                             .lists(List.of(new MailingListConfiguration(listAddress, Set.of())))
2630                                             .listArchive(listServer.getArchive())
2631                                             .smtpServer(listServer.getSMTP())
<span class="line-modified">2632                                             .webrevStorageHTMLRepository(archive)</span>
2633                                             .webrevStorageRef(&quot;webrev&quot;)
2634                                             .webrevStorageBase(Path.of(&quot;test&quot;))
2635                                             .webrevStorageBaseUri(webrevServer.uri())
2636                                             .issueTracker(URIBuilder.base(&quot;http://issues.test/browse/&quot;).build())
2637                                             .repoInSubject(true)
2638                                             .build();
2639 
2640             // Populate the projects repository
2641             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType());
2642             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
2643             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
2644             localRepo.push(masterHash, archive.url(), &quot;webrev&quot;, true);
2645 
2646             // Make a change with a corresponding PR
2647             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;A simple change&quot;,
2648                                                                &quot;Change msg\n\nWith several lines&quot;);
2649             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
2650             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;1234: This is a pull request&quot;);
2651             pr.setBody(&quot;This is a PR&quot;);
2652 
</pre>
<hr />
<pre>
2669     void repoAndBranchPrefix(TestInfo testInfo) throws IOException {
2670         try (var credentials = new HostCredentials(testInfo);
2671              var tempFolder = new TemporaryDirectory();
2672              var archiveFolder = new TemporaryDirectory();
2673              var listServer = new TestMailmanServer();
2674              var webrevServer = new TestWebrevServer()) {
2675             var author = credentials.getHostedRepository();
2676             var archive = credentials.getHostedRepository();
2677             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
2678             var censusBuilder = credentials.getCensusBuilder()
2679                                            .addAuthor(author.forge().currentUser().id());
2680             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
2681             var mlBot = MailingListBridgeBot.newBuilder()
2682                                             .from(from)
2683                                             .repo(author)
2684                                             .archive(archive)
2685                                             .censusRepo(censusBuilder.build())
2686                                             .lists(List.of(new MailingListConfiguration(listAddress, Set.of())))
2687                                             .listArchive(listServer.getArchive())
2688                                             .smtpServer(listServer.getSMTP())
<span class="line-modified">2689                                             .webrevStorageHTMLRepository(archive)</span>
2690                                             .webrevStorageRef(&quot;webrev&quot;)
2691                                             .webrevStorageBase(Path.of(&quot;test&quot;))
2692                                             .webrevStorageBaseUri(webrevServer.uri())
2693                                             .issueTracker(URIBuilder.base(&quot;http://issues.test/browse/&quot;).build())
2694                                             .repoInSubject(true)
2695                                             .branchInSubject(Pattern.compile(&quot;.*&quot;))
2696                                             .build();
2697 
2698             // Populate the projects repository
2699             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType());
2700             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
2701             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
2702             localRepo.push(masterHash, archive.url(), &quot;webrev&quot;, true);
2703 
2704             // Make a change with a corresponding PR
2705             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;A simple change&quot;,
2706                                                                &quot;Change msg\n\nWith several lines&quot;);
2707             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
2708             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;1234: This is a pull request&quot;);
2709             pr.setBody(&quot;This is a PR&quot;);
</pre>
<hr />
<pre>
2730              var archiveFolder = new TemporaryDirectory();
2731              var listServer = new TestMailmanServer();
2732              var webrevServer = new TestWebrevServer()) {
2733             var bot = credentials.getHostedRepository();
2734             var author = credentials.getHostedRepository();
2735             var archive = credentials.getHostedRepository();
2736             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
2737             var censusBuilder = credentials.getCensusBuilder()
2738                                            .addAuthor(author.forge().currentUser().id());
2739             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
2740             var cooldown = Duration.ofMillis(500);
2741             var mlBotBuilder = MailingListBridgeBot.newBuilder()
2742                                                    .from(from)
2743                                                    .repo(bot)
2744                                                    .ignoredUsers(Set.of(bot.forge().currentUser().userName()))
2745                                                    .archive(archive)
2746                                                    .censusRepo(censusBuilder.build())
2747                                                    .lists(List.of(new MailingListConfiguration(listAddress, Set.of())))
2748                                                    .listArchive(listServer.getArchive())
2749                                                    .smtpServer(listServer.getSMTP())
<span class="line-modified">2750                                                    .webrevStorageHTMLRepository(archive)</span>
2751                                                    .webrevStorageRef(&quot;webrev&quot;)
2752                                                    .webrevStorageBase(Path.of(&quot;test&quot;))
2753                                                    .webrevStorageBaseUri(webrevServer.uri())
2754                                                    .issueTracker(URIBuilder.base(&quot;http://issues.test/browse/&quot;).build());
2755 
2756             // Populate the projects repository
2757             var reviewFile = Path.of(&quot;reviewfile.txt&quot;);
2758             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType(), reviewFile);
2759             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
2760             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
2761             localRepo.push(masterHash, archive.url(), &quot;webrev&quot;, true);
2762 
2763             // Make a change with a corresponding PR
2764             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;Line 1\nLine 2\nLine 3\nLine 4&quot;);
2765             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
2766             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
2767             pr.setBody(&quot;This is now ready&quot;);
2768 
2769             var mlBot = mlBotBuilder.cooldown(cooldown).build();
2770             Thread.sleep(cooldown.toMillis());
</pre>
<hr />
<pre>
2822              var tempFolder = new TemporaryDirectory();
2823              var archiveFolder = new TemporaryDirectory();
2824              var listServer = new TestMailmanServer();
2825              var webrevServer = new TestWebrevServer()) {
2826             var author = credentials.getHostedRepository();
2827             var archive = credentials.getHostedRepository();
2828             var listAddress1 = EmailAddress.parse(listServer.createList(&quot;test1&quot;));
2829             var listAddress2 = EmailAddress.parse(listServer.createList(&quot;test2&quot;));
2830             var censusBuilder = credentials.getCensusBuilder()
2831                                            .addAuthor(author.forge().currentUser().id());
2832             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
2833             var mlBot = MailingListBridgeBot.newBuilder()
2834                                             .from(from)
2835                                             .repo(author)
2836                                             .archive(archive)
2837                                             .censusRepo(censusBuilder.build())
2838                                             .lists(List.of(new MailingListConfiguration(listAddress1, Set.of(&quot;list1&quot;)),
2839                                                            new MailingListConfiguration(listAddress2, Set.of(&quot;list2&quot;))))
2840                                             .listArchive(listServer.getArchive())
2841                                             .smtpServer(listServer.getSMTP())
<span class="line-modified">2842                                             .webrevStorageHTMLRepository(archive)</span>
2843                                             .webrevStorageRef(&quot;webrev&quot;)
2844                                             .webrevStorageBase(Path.of(&quot;test&quot;))
2845                                             .webrevStorageBaseUri(webrevServer.uri())
2846                                             .issueTracker(URIBuilder.base(&quot;http://issues.test/browse/&quot;).build())
2847                                             .build();
2848 
2849             // Populate the projects repository
2850             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType());
2851             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
2852             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
2853             localRepo.push(masterHash, archive.url(), &quot;webrev&quot;, true);
2854 
2855             // Make a change with a corresponding PR
2856             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;A simple change&quot;,
2857                                                                &quot;Change msg\n\nWith several lines&quot;);
2858             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
2859             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;1234: This is a pull request&quot;);
2860             pr.setBody(&quot;This is a PR&quot;);
2861             pr.addLabel(&quot;list1&quot;);
2862 
</pre>
<hr />
<pre>
2876             assertEquals(listAddress1, mail.sender());
2877             assertEquals(List.of(listAddress1), mail.recipients());
2878 
2879             // Add another label and comment
2880             pr.addLabel(&quot;list2&quot;);
2881             pr.addComment(&quot;Looks good!&quot;);
2882             TestBotRunner.runPeriodicItems(mlBot);
2883             listServer.processIncoming();
2884 
2885             // This one should have been sent to list1 and list2
2886             conversations = mailmanList.conversations(Duration.ofDays(1));
2887             assertEquals(1, conversations.size());
2888             var reply = conversations.get(0).replies(conversations.get(0).first()).get(0);
2889             assertEquals(&quot;RFR: 1234: This is a pull request&quot;, reply.subject());
2890             assertEquals(pr.author().fullName(), reply.author().fullName().orElseThrow());
2891             assertEquals(noreplyAddress(archive), reply.author().address());
2892             assertEquals(listAddress1, reply.sender());
2893             assertEquals(List.of(listAddress1, listAddress2), reply.recipients());
2894         }
2895     }
<span class="line-added">2896 </span>
<span class="line-added">2897     @Test</span>
<span class="line-added">2898     void jsonArchive(TestInfo testInfo) throws IOException {</span>
<span class="line-added">2899         try (var credentials = new HostCredentials(testInfo);</span>
<span class="line-added">2900              var tempFolder = new TemporaryDirectory();</span>
<span class="line-added">2901              var archiveFolder = new TemporaryDirectory();</span>
<span class="line-added">2902              var webrevFolder = new TemporaryDirectory(false);</span>
<span class="line-added">2903              var listServer = new TestMailmanServer();</span>
<span class="line-added">2904              var webrevServer = new TestWebrevServer()) {</span>
<span class="line-added">2905             var author = credentials.getHostedRepository();</span>
<span class="line-added">2906             var archive = credentials.getHostedRepository();</span>
<span class="line-added">2907             var ignored = credentials.getHostedRepository();</span>
<span class="line-added">2908             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));</span>
<span class="line-added">2909             var censusBuilder = credentials.getCensusBuilder()</span>
<span class="line-added">2910                                            .addAuthor(author.forge().currentUser().id());</span>
<span class="line-added">2911             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);</span>
<span class="line-added">2912             var mlBot = MailingListBridgeBot.newBuilder()</span>
<span class="line-added">2913                                             .from(from)</span>
<span class="line-added">2914                                             .repo(author)</span>
<span class="line-added">2915                                             .archive(archive)</span>
<span class="line-added">2916                                             .censusRepo(censusBuilder.build())</span>
<span class="line-added">2917                                             .lists(List.of(new MailingListConfiguration(listAddress, Set.of())))</span>
<span class="line-added">2918                                             .ignoredUsers(Set.of(ignored.forge().currentUser().userName()))</span>
<span class="line-added">2919                                             .ignoredComments(Set.of())</span>
<span class="line-added">2920                                             .listArchive(listServer.getArchive())</span>
<span class="line-added">2921                                             .smtpServer(listServer.getSMTP())</span>
<span class="line-added">2922                                             .webrevStorageJSONRepository(archive)</span>
<span class="line-added">2923                                             .webrevStorageRef(&quot;webrev&quot;)</span>
<span class="line-added">2924                                             .webrevStorageBase(Path.of(&quot;test&quot;))</span>
<span class="line-added">2925                                             .webrevStorageBaseUri(webrevServer.uri())</span>
<span class="line-added">2926                                             .webrevGenerateHTML(false)</span>
<span class="line-added">2927                                             .webrevGenerateJSON(true)</span>
<span class="line-added">2928                                             .readyLabels(Set.of(&quot;rfr&quot;))</span>
<span class="line-added">2929                                             .readyComments(Map.of(ignored.forge().currentUser().userName(), Pattern.compile(&quot;ready&quot;)))</span>
<span class="line-added">2930                                             .issueTracker(URIBuilder.base(&quot;http://issues.test/browse/&quot;).build())</span>
<span class="line-added">2931                                             .headers(Map.of(&quot;Extra1&quot;, &quot;val1&quot;, &quot;Extra2&quot;, &quot;val2&quot;))</span>
<span class="line-added">2932                                             .sendInterval(Duration.ZERO)</span>
<span class="line-added">2933                                             .build();</span>
<span class="line-added">2934 </span>
<span class="line-added">2935             // Populate the projects repository</span>
<span class="line-added">2936             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType());</span>
<span class="line-added">2937             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();</span>
<span class="line-added">2938             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);</span>
<span class="line-added">2939             localRepo.push(masterHash, archive.url(), &quot;webrev&quot;, true);</span>
<span class="line-added">2940 </span>
<span class="line-added">2941             // Make a change with a corresponding PR</span>
<span class="line-added">2942             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;A simple change&quot;,</span>
<span class="line-added">2943                                                                &quot;Change msg\n\nWith several lines&quot;);</span>
<span class="line-added">2944             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);</span>
<span class="line-added">2945             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;1234: This is a pull request&quot;);</span>
<span class="line-added">2946             pr.setBody(&quot;This should not be ready&quot;);</span>
<span class="line-added">2947 </span>
<span class="line-added">2948             // Run an archive pass</span>
<span class="line-added">2949             TestBotRunner.runPeriodicItems(mlBot);</span>
<span class="line-added">2950 </span>
<span class="line-added">2951             // A PR that isn&#39;t ready for review should not be archived</span>
<span class="line-added">2952             Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);</span>
<span class="line-added">2953             assertFalse(archiveContains(archiveFolder.path(), &quot;This is a pull request&quot;));</span>
<span class="line-added">2954 </span>
<span class="line-added">2955             // Flag it as ready for review</span>
<span class="line-added">2956             pr.setBody(&quot;This should now be ready&quot;);</span>
<span class="line-added">2957             pr.addLabel(&quot;rfr&quot;);</span>
<span class="line-added">2958 </span>
<span class="line-added">2959             // Run another archive pass</span>
<span class="line-added">2960             TestBotRunner.runPeriodicItems(mlBot);</span>
<span class="line-added">2961 </span>
<span class="line-added">2962             // But it should still not be archived</span>
<span class="line-added">2963             Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);</span>
<span class="line-added">2964             assertFalse(archiveContains(archiveFolder.path(), &quot;This is a pull request&quot;));</span>
<span class="line-added">2965 </span>
<span class="line-added">2966             // Now post a general comment - not a ready marker</span>
<span class="line-added">2967             var ignoredPr = ignored.pullRequest(pr.id());</span>
<span class="line-added">2968             ignoredPr.addComment(&quot;hello there&quot;);</span>
<span class="line-added">2969 </span>
<span class="line-added">2970             // Run another archive pass</span>
<span class="line-added">2971             TestBotRunner.runPeriodicItems(mlBot);</span>
<span class="line-added">2972 </span>
<span class="line-added">2973             // It should still not be archived</span>
<span class="line-added">2974             Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);</span>
<span class="line-added">2975             assertFalse(archiveContains(archiveFolder.path(), &quot;This is a pull request&quot;));</span>
<span class="line-added">2976 </span>
<span class="line-added">2977             // Now post a ready comment</span>
<span class="line-added">2978             ignoredPr.addComment(&quot;ready&quot;);</span>
<span class="line-added">2979 </span>
<span class="line-added">2980             // Run another archive pass</span>
<span class="line-added">2981             TestBotRunner.runPeriodicItems(mlBot);</span>
<span class="line-added">2982 </span>
<span class="line-added">2983             // The archive should now contain an entry</span>
<span class="line-added">2984             Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);</span>
<span class="line-added">2985             assertTrue(archiveContains(archiveFolder.path(), &quot;This is a pull request&quot;));</span>
<span class="line-added">2986             assertTrue(archiveContains(archiveFolder.path(), &quot;This should now be ready&quot;));</span>
<span class="line-added">2987             assertTrue(archiveContains(archiveFolder.path(), &quot;Patch:&quot;));</span>
<span class="line-added">2988             assertTrue(archiveContains(archiveFolder.path(), &quot;Changes:&quot;));</span>
<span class="line-added">2989             assertTrue(archiveContains(archiveFolder.path(), &quot;Webrev:&quot;));</span>
<span class="line-added">2990             assertTrue(archiveContains(archiveFolder.path(), webrevServer.uri().toString()));</span>
<span class="line-added">2991             assertTrue(archiveContains(archiveFolder.path(), &quot;&amp;pr=&quot; + pr.id() + &quot;&amp;range=00&quot;));</span>
<span class="line-added">2992             assertTrue(archiveContains(archiveFolder.path(), &quot;Issue:&quot;));</span>
<span class="line-added">2993             assertTrue(archiveContains(archiveFolder.path(), &quot;http://issues.test/browse/TSTPRJ-1234&quot;));</span>
<span class="line-added">2994             assertTrue(archiveContains(archiveFolder.path(), &quot;Fetch:&quot;));</span>
<span class="line-added">2995             assertTrue(archiveContains(archiveFolder.path(), &quot;^ - Change msg&quot;));</span>
<span class="line-added">2996             assertFalse(archiveContains(archiveFolder.path(), &quot;With several lines&quot;));</span>
<span class="line-added">2997 </span>
<span class="line-added">2998             // The mailing list as well</span>
<span class="line-added">2999             listServer.processIncoming();</span>
<span class="line-added">3000             var mailmanServer = MailingListServerFactory.createMailmanServer(listServer.getArchive(), listServer.getSMTP(), Duration.ZERO);</span>
<span class="line-added">3001             var mailmanList = mailmanServer.getList(listAddress.address());</span>
<span class="line-added">3002             var conversations = mailmanList.conversations(Duration.ofDays(1));</span>
<span class="line-added">3003             assertEquals(1, conversations.size());</span>
<span class="line-added">3004             var mail = conversations.get(0).first();</span>
<span class="line-added">3005             assertEquals(&quot;RFR: 1234: This is a pull request&quot;, mail.subject());</span>
<span class="line-added">3006             assertEquals(pr.author().fullName(), mail.author().fullName().orElseThrow());</span>
<span class="line-added">3007             assertEquals(noreplyAddress(archive), mail.author().address());</span>
<span class="line-added">3008             assertEquals(listAddress, mail.sender());</span>
<span class="line-added">3009             assertEquals(&quot;val1&quot;, mail.headerValue(&quot;Extra1&quot;));</span>
<span class="line-added">3010             assertEquals(&quot;val2&quot;, mail.headerValue(&quot;Extra2&quot;));</span>
<span class="line-added">3011 </span>
<span class="line-added">3012             // And there should be a JSON version of a webrev</span>
<span class="line-added">3013             Repository.materialize(webrevFolder.path(), archive.url(), &quot;webrev&quot;);</span>
<span class="line-added">3014             var jsonDir = webrevFolder.path()</span>
<span class="line-added">3015                                       .resolve(author.name())</span>
<span class="line-added">3016                                       .resolve(pr.id())</span>
<span class="line-added">3017                                       .resolve(&quot;00&quot;);</span>
<span class="line-added">3018             assertTrue(Files.exists(jsonDir));</span>
<span class="line-added">3019             assertTrue(Files.isDirectory(jsonDir));</span>
<span class="line-added">3020 </span>
<span class="line-added">3021             var commitsFile = jsonDir.resolve(&quot;commits.json&quot;);</span>
<span class="line-added">3022             assertTrue(Files.exists(commitsFile));</span>
<span class="line-added">3023             var commits = JSON.parse(Files.readString(commitsFile));</span>
<span class="line-added">3024             assertEquals(1, commits.asArray().size());</span>
<span class="line-added">3025             var commit = commits.get(0);</span>
<span class="line-added">3026             assertEquals(editHash.hex(), commit.get(&quot;sha&quot;).asString());</span>
<span class="line-added">3027             assertEquals(&quot;Change msg\n\nWith several lines&quot;, commit.get(&quot;commit&quot;).get(&quot;message&quot;).asString());</span>
<span class="line-added">3028             assertEquals(1, commit.get(&quot;files&quot;).asArray().size());</span>
<span class="line-added">3029 </span>
<span class="line-added">3030             var metadataFile = jsonDir.resolve(&quot;metadata.json&quot;);</span>
<span class="line-added">3031             assertTrue(Files.exists(metadataFile));</span>
<span class="line-added">3032             var metadata = JSON.parse(Files.readString(metadataFile));</span>
<span class="line-added">3033             assertEquals(masterHash.hex(), metadata.get(&quot;base&quot;).get(&quot;sha&quot;).asString());</span>
<span class="line-added">3034             assertEquals(editHash.hex(), metadata.get(&quot;head&quot;).get(&quot;sha&quot;).asString());</span>
<span class="line-added">3035 </span>
<span class="line-added">3036             var comparisonFile = jsonDir.resolve(&quot;comparison.json&quot;);</span>
<span class="line-added">3037             assertTrue(Files.exists(comparisonFile));</span>
<span class="line-added">3038             var comparsion = JSON.parse(Files.readString(comparisonFile));</span>
<span class="line-added">3039             assertEquals(1, comparsion.get(&quot;files&quot;).asArray().size());</span>
<span class="line-added">3040             assertEquals(&quot;modified&quot;, comparsion.get(&quot;files&quot;).get(0).get(&quot;status&quot;).asString());</span>
<span class="line-added">3041             assertTrue(comparsion.get(&quot;files&quot;).get(0).get(&quot;patch&quot;).asString().contains(&quot;A simple change&quot;));</span>
<span class="line-added">3042 </span>
<span class="line-added">3043             var comments = pr.comments();</span>
<span class="line-added">3044             var webrevComments = comments.stream()</span>
<span class="line-added">3045                                          .filter(comment -&gt; comment.author().equals(author.forge().currentUser()))</span>
<span class="line-added">3046                                          .filter(comment -&gt; comment.body().contains(&quot;webrev&quot;))</span>
<span class="line-added">3047                                          .filter(comment -&gt; comment.body().contains(editHash.hex()))</span>
<span class="line-added">3048                                          .collect(Collectors.toList());</span>
<span class="line-added">3049             assertEquals(1, webrevComments.size());</span>
<span class="line-added">3050             var comment = webrevComments.get(0);</span>
<span class="line-added">3051             assertTrue(comment.body().contains(&quot;&amp;pr=&quot; + pr.id()));</span>
<span class="line-added">3052             assertTrue(comment.body().contains(&quot;&amp;range=00&quot;));</span>
<span class="line-added">3053 </span>
<span class="line-added">3054             // Add a comment</span>
<span class="line-added">3055             pr.addComment(&quot;This is a comment :smile:&quot;);</span>
<span class="line-added">3056 </span>
<span class="line-added">3057             // Add a comment from an ignored user as well</span>
<span class="line-added">3058             ignoredPr.addComment(&quot;Don&#39;t mind me&quot;);</span>
<span class="line-added">3059 </span>
<span class="line-added">3060             // Run another archive pass</span>
<span class="line-added">3061             TestBotRunner.runPeriodicItems(mlBot);</span>
<span class="line-added">3062 </span>
<span class="line-added">3063             // The archive should now contain the comment, but not the ignored one</span>
<span class="line-added">3064             Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);</span>
<span class="line-added">3065             assertTrue(archiveContains(archiveFolder.path(), &quot;This is a comment&quot;));</span>
<span class="line-added">3066             assertTrue(archiveContains(archiveFolder.path(), &quot;&gt; This should now be ready&quot;));</span>
<span class="line-added">3067             assertFalse(archiveContains(archiveFolder.path(), &quot;Don&#39;t mind me&quot;));</span>
<span class="line-added">3068 </span>
<span class="line-added">3069             listServer.processIncoming();</span>
<span class="line-added">3070             conversations = mailmanList.conversations(Duration.ofDays(1));</span>
<span class="line-added">3071             assertEquals(1, conversations.size());</span>
<span class="line-added">3072             assertEquals(2, conversations.get(0).allMessages().size());</span>
<span class="line-added">3073 </span>
<span class="line-added">3074             // Remove the rfr flag and post another comment</span>
<span class="line-added">3075             pr.addLabel(&quot;rfr&quot;);</span>
<span class="line-added">3076             pr.addComment(&quot;This is another comment&quot;);</span>
<span class="line-added">3077 </span>
<span class="line-added">3078             // Run another archive pass</span>
<span class="line-added">3079             TestBotRunner.runPeriodicItems(mlBot);</span>
<span class="line-added">3080 </span>
<span class="line-added">3081             // The archive should contain the additional comment</span>
<span class="line-added">3082             Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);</span>
<span class="line-added">3083             assertTrue(archiveContains(archiveFolder.path(), &quot;This is another comment&quot;));</span>
<span class="line-added">3084             assertTrue(archiveContains(archiveFolder.path(), &quot;&gt;&gt; This should now be ready&quot;));</span>
<span class="line-added">3085 </span>
<span class="line-added">3086             listServer.processIncoming();</span>
<span class="line-added">3087             conversations = mailmanList.conversations(Duration.ofDays(1));</span>
<span class="line-added">3088             assertEquals(1, conversations.size());</span>
<span class="line-added">3089             assertEquals(3, conversations.get(0).allMessages().size());</span>
<span class="line-added">3090             for (var newMail : conversations.get(0).allMessages()) {</span>
<span class="line-added">3091                 assertEquals(noreplyAddress(archive), newMail.author().address());</span>
<span class="line-added">3092                 assertEquals(listAddress, newMail.sender());</span>
<span class="line-added">3093             }</span>
<span class="line-added">3094             assertTrue(conversations.get(0).allMessages().get(2).body().contains(&quot;This is a comment &quot;));</span>
<span class="line-added">3095         }</span>
<span class="line-added">3096     }</span>
3097 }
</pre>
</td>
</tr>
</table>
<center><a href="MailingListArchiveReaderBotTests.java.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../../index.html" target="_top">index</a> next &gt;</center>  </body>
</html>