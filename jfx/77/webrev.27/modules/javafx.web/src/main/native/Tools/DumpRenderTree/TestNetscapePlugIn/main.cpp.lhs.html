<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Frames modules/javafx.web/src/main/native/Tools/DumpRenderTree/TestNetscapePlugIn/main.cpp</title>
    <link rel="stylesheet" href="../../../../../../../../style.css" />
    <script type="text/javascript" src="../../../../../../../../navigation.js"></script>
  </head>
<body onkeypress="keypress(event);">
<a name="0"></a>
<hr />
<pre>  1 /*
  2  * Copyright (C) 2006, 2007 Apple Inc. All rights reserved.
  3  *
  4  * Redistribution and use in source and binary forms, with or without
  5  * modification, are permitted provided that the following conditions
  6  * are met:
  7  * 1. Redistributions of source code must retain the above copyright
  8  *    notice, this list of conditions and the following disclaimer.
  9  * 2. Redistributions in binary form must reproduce the above copyright
 10  *    notice, this list of conditions and the following disclaimer in the
 11  *    documentation and/or other materials provided with the distribution.
 12  *
 13  * THIS SOFTWARE IS PROVIDED BY APPLE INC. ``AS IS&#39;&#39; AND ANY
 14  * EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE
 15  * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR
 16  * PURPOSE ARE DISCLAIMED.  IN NO EVENT SHALL APPLE INC. OR
 17  * CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL,
 18  * EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO,
 19  * PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR
 20  * PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY
 21  * OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT
 22  * (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE
 23  * OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
 24  */
 25 
 26 #include &quot;PluginObject.h&quot;
 27 
 28 #include &quot;PluginTest.h&quot;
 29 #include &lt;cstdlib&gt;
 30 #include &lt;cstring&gt;
 31 #include &lt;string&gt;
 32 
 33 #if defined(MOZ_X11)
 34 #include &lt;X11/Xlib.h&gt;
 35 #include &lt;X11/Xutil.h&gt;
 36 #endif
 37 
<a name="1" id="anc1"></a><span class="line-removed"> 38 #if !defined(NP_NO_CARBON) &amp;&amp; defined(QD_HEADERS_ARE_PRIVATE) &amp;&amp; QD_HEADERS_ARE_PRIVATE</span>
<span class="line-removed"> 39 extern &quot;C&quot; void GlobalToLocal(Point*);</span>
<span class="line-removed"> 40 #endif</span>
<span class="line-removed"> 41 </span>
 42 using namespace std;
 43 
 44 static bool getEntryPointsWasCalled;
 45 static bool initializeWasCalled;
 46 
 47 #if defined(XP_WIN)
 48 #define STDCALL __stdcall
 49 
 50 static inline int strcasecmp(const char* s1, const char* s2)
 51 {
 52     return _stricmp(s1, s2);
 53 }
 54 
 55 #else
 56 #define STDCALL
 57 #endif
 58 
 59 extern &quot;C&quot; {
 60 NPError STDCALL NP_GetEntryPoints(NPPluginFuncs *pluginFuncs);
 61 }
 62 
 63 // Entry points
 64 extern &quot;C&quot;
 65 NPError STDCALL NP_Initialize(NPNetscapeFuncs *browserFuncs
 66 #if defined(XP_UNIX)
 67                               , NPPluginFuncs *pluginFuncs
 68 #endif
 69                               )
 70 {
 71     initializeWasCalled = true;
 72 
 73 #if defined(XP_WIN)
 74     // Simulate Flash and QuickTime&#39;s behavior of crashing when NP_Initialize is called before NP_GetEntryPoints.
 75     if (!getEntryPointsWasCalled)
 76         CRASH();
 77 #endif
 78 
 79     browser = browserFuncs;
 80 
 81 #if defined(XP_UNIX)
 82     return NP_GetEntryPoints(pluginFuncs);
 83 #else
 84     return NPERR_NO_ERROR;
 85 #endif
 86 }
 87 
 88 extern &quot;C&quot;
 89 NPError STDCALL NP_GetEntryPoints(NPPluginFuncs *pluginFuncs)
 90 {
 91     getEntryPointsWasCalled = true;
 92 
 93 #ifdef XP_MACOSX
 94     // Simulate Silverlight&#39;s behavior of crashing when NP_GetEntryPoints is called before NP_Initialize.
 95     if (!initializeWasCalled)
 96         CRASH();
 97 #endif
 98 
 99     pluginFunctions = pluginFuncs;
100 
101     pluginFuncs-&gt;version = (NP_VERSION_MAJOR &lt;&lt; 8) | NP_VERSION_MINOR;
102     pluginFuncs-&gt;size = sizeof(pluginFuncs);
103     pluginFuncs-&gt;newp = NPP_New;
104     pluginFuncs-&gt;destroy = NPP_Destroy;
105     pluginFuncs-&gt;setwindow = NPP_SetWindow;
106     pluginFuncs-&gt;newstream = NPP_NewStream;
107     pluginFuncs-&gt;destroystream = NPP_DestroyStream;
108     pluginFuncs-&gt;asfile = NPP_StreamAsFile;
109     pluginFuncs-&gt;writeready = NPP_WriteReady;
110     pluginFuncs-&gt;write = (NPP_WriteProcPtr)NPP_Write;
111     pluginFuncs-&gt;print = NPP_Print;
112     pluginFuncs-&gt;event = NPP_HandleEvent;
113     pluginFuncs-&gt;urlnotify = NPP_URLNotify;
114     pluginFuncs-&gt;urlredirectnotify = NPP_URLRedirectNotify;
115     pluginFuncs-&gt;getvalue = NPP_GetValue;
116     pluginFuncs-&gt;setvalue = NPP_SetValue;
117 
118     return NPERR_NO_ERROR;
119 }
120 
121 extern &quot;C&quot;
122 void STDCALL NP_Shutdown(void)
123 {
124     PluginTest::NP_Shutdown();
125 }
126 
127 static void executeScript(const PluginObject* obj, const char* script);
128 
129 NPError NPP_New(NPMIMEType pluginType, NPP instance, uint16_t mode, int16_t argc, char *argn[], char *argv[], NPSavedData *saved)
130 {
131 #ifdef XP_MACOSX
132     NPEventModel eventModel;
133 
134     // Always turn on the CG model
135     NPBool supportsCoreGraphics;
136     if (browser-&gt;getvalue(instance, NPNVsupportsCoreGraphicsBool, &amp;supportsCoreGraphics) != NPERR_NO_ERROR)
137         supportsCoreGraphics = false;
138 
139     if (!supportsCoreGraphics)
140         return NPERR_INCOMPATIBLE_VERSION_ERROR;
141 
142     NPDrawingModel drawingModelToUse = NPDrawingModelCoreGraphics;
143 
144     NPBool supportsCoreAnimation;
145     if (browser-&gt;getvalue(instance, NPNVsupportsCoreAnimationBool, &amp;supportsCoreAnimation) != NPERR_NO_ERROR)
146         supportsCoreAnimation = false;
147 
<a name="2" id="anc2"></a><span class="line-removed">148 #ifndef NP_NO_CARBON</span>
<span class="line-removed">149     NPBool supportsCarbon = false;</span>
<span class="line-removed">150 #endif</span>
151     NPBool supportsCocoa = false;
152 
<a name="3" id="anc3"></a><span class="line-removed">153 #ifndef NP_NO_CARBON</span>
<span class="line-removed">154     // A browser that doesn&#39;t know about NPNVsupportsCarbonBool is one that only supports Carbon event model.</span>
<span class="line-removed">155     if (browser-&gt;getvalue(instance, NPNVsupportsCarbonBool, &amp;supportsCarbon) != NPERR_NO_ERROR)</span>
<span class="line-removed">156         supportsCarbon = true;</span>
<span class="line-removed">157 #endif</span>
<span class="line-removed">158 </span>
159     if (browser-&gt;getvalue(instance, NPNVsupportsCocoaBool, &amp;supportsCocoa) != NPERR_NO_ERROR)
160         supportsCocoa = false;
161 
<a name="4" id="anc4"></a><span class="line-modified">162     if (supportsCocoa) {</span>
163         eventModel = NPEventModelCocoa;
<a name="5" id="anc5"></a><span class="line-modified">164 #ifndef NP_NO_CARBON</span>
<span class="line-removed">165     } else if (supportsCarbon) {</span>
<span class="line-removed">166         eventModel = NPEventModelCarbon;</span>
<span class="line-removed">167 #endif</span>
<span class="line-removed">168     } else {</span>
169         return NPERR_INCOMPATIBLE_VERSION_ERROR;
<a name="6" id="anc6"></a><span class="line-removed">170     }</span>
171 
172      browser-&gt;setvalue(instance, NPPVpluginEventModel, (void *)eventModel);
173 #endif // XP_MACOSX
174 
175     PluginObject* obj = (PluginObject*)browser-&gt;createobject(instance, getPluginClass());
176     instance-&gt;pdata = obj;
177 
178 #ifdef XP_MACOSX
179     obj-&gt;eventModel = eventModel;
180     obj-&gt;coreAnimationLayer = 0;
181 #endif // XP_MACOSX
182 
183     string testIdentifier;
184     const char* onNewScript = 0;
185 
186     for (int i = 0; i &lt; argc; i++) {
187         if (strcasecmp(argn[i], &quot;test&quot;) == 0)
188             testIdentifier = argv[i];
189         if (strcasecmp(argn[i], &quot;onstreamload&quot;) == 0 &amp;&amp; !obj-&gt;onStreamLoad)
190             obj-&gt;onStreamLoad = strdup(argv[i]);
191         else if (strcasecmp(argn[i], &quot;onStreamDestroy&quot;) == 0 &amp;&amp; !obj-&gt;onStreamDestroy)
192             obj-&gt;onStreamDestroy = strdup(argv[i]);
193         else if (strcasecmp(argn[i], &quot;onURLNotify&quot;) == 0 &amp;&amp; !obj-&gt;onURLNotify)
194             obj-&gt;onURLNotify = strdup(argv[i]);
195         else if (strcasecmp(argn[i], &quot;src&quot;) == 0 &amp;&amp;
196                  strcasecmp(argv[i], &quot;data:application/x-webkit-test-netscape,returnerrorfromnewstream&quot;) == 0)
197             obj-&gt;returnErrorFromNewStream = TRUE;
198         else if (strcasecmp(argn[i], &quot;src&quot;) == 0 &amp;&amp;
199                  strcasecmp(argv[i], &quot;data:application/x-webkit-test-netscape,alertwhenloaded&quot;) == 0)
200             executeScript(obj, &quot;alert(&#39;Plugin Loaded!&#39;)&quot;);
201         else if (strcasecmp(argn[i], &quot;src&quot;) == 0 &amp;&amp;
202                  strcasecmp(argv[i], &quot;data:application/x-webkit-test-netscape,logifloaded&quot;) == 0) {
203             for (int j = 0; j &lt; argc; j++) {
204               if (strcasecmp(argn[j], &quot;log&quot;) == 0) {
205                 int length = 26 + strlen(argv[j]) + 1;
206                 char* buffer = (char*) malloc(length);
207                 snprintf(buffer, length, &quot;xWebkitTestNetscapeLog(&#39;%s&#39;)&quot;, argv[j]);
208                 executeScript(obj, buffer);
209                 free(buffer);
210               }
211             }
212         } else if (strcasecmp(argn[i], &quot;onSetWindow&quot;) == 0 &amp;&amp; !obj-&gt;onSetWindow)
213             obj-&gt;onSetWindow = strdup(argv[i]);
214         else if (strcasecmp(argn[i], &quot;onNew&quot;) == 0 &amp;&amp; !onNewScript)
215             onNewScript = argv[i];
216         else if (strcasecmp(argn[i], &quot;onPaintEvent&quot;) == 0 &amp;&amp; !obj-&gt;onPaintEvent)
217             obj-&gt;onPaintEvent = strdup(argv[i]);
218         else if (strcasecmp(argn[i], &quot;logfirstsetwindow&quot;) == 0)
219             obj-&gt;logSetWindow = TRUE;
220         else if (strcasecmp(argn[i], &quot;testnpruntime&quot;) == 0)
221             testNPRuntime(instance);
222         else if (strcasecmp(argn[i], &quot;logSrc&quot;) == 0) {
223             for (int i = 0; i &lt; argc; i++)
224                 if (strcasecmp(argn[i], &quot;src&quot;) == 0)
225                     pluginLog(instance, &quot;src: %s&quot;, argv[i]);
226         } else if (strcasecmp(argn[i], &quot;cleardocumentduringnew&quot;) == 0)
227             executeScript(obj, &quot;document.body.innerHTML = &#39;&#39;&quot;);
228         else if (!strcasecmp(argn[i], &quot;ondestroy&quot;))
229             obj-&gt;onDestroy = strdup(argv[i]);
230         else if (strcasecmp(argn[i], &quot;testwindowopen&quot;) == 0)
231             obj-&gt;testWindowOpen = TRUE;
232         else if (strcasecmp(argn[i], &quot;drawingmodel&quot;) == 0) {
233 #ifdef XP_MACOSX
234             const char* value = argv[i];
235             if (strcasecmp(value, &quot;coreanimation&quot;) == 0) {
236                 if (supportsCoreAnimation)
237                     drawingModelToUse = NPDrawingModelCoreAnimation;
238                 else
239                     return NPERR_INCOMPATIBLE_VERSION_ERROR;
240              } else if (strcasecmp(value, &quot;coregraphics&quot;) == 0) {
241                 if (supportsCoreGraphics)
242                     drawingModelToUse = NPDrawingModelCoreGraphics;
243                 else
244                     return NPERR_INCOMPATIBLE_VERSION_ERROR;
245              } else
246                 return NPERR_INCOMPATIBLE_VERSION_ERROR;
247 #endif
248         } else if (strcasecmp(argn[i], &quot;testGetURLOnDestroy&quot;) == 0) {
249 #if defined(XP_WIN)
250             // FIXME: When https://bugs.webkit.org/show_bug.cgi?id=41831 is fixed, this #ifdef can be removed.
251             obj-&gt;testGetURLOnDestroy = TRUE;
252 #endif
253         } else if (!strcasecmp(argn[i], &quot;src&quot;) &amp;&amp; strstr(argv[i], &quot;plugin-document-has-focus.pl&quot;))
254             obj-&gt;testKeyboardFocusForPlugins = TRUE;
255         else if (!strcasecmp(argn[i], &quot;src&quot;) &amp;&amp; strstr(argv[i], &quot;plugin-document-alert-and-notify-done.pl&quot;))
256             executeScript(obj, &quot;alert(&#39;Plugin Loaded!&#39;); testRunner.notifyDone();&quot;);
257         else if (!strcasecmp(argn[i], &quot;evaluatescript&quot;)) {
258             char* script = argv[i];
259             if (script == strstr(script, &quot;mouse::&quot;)) {
260                 obj-&gt;mouseDownForEvaluateScript = true;
261                 obj-&gt;evaluateScriptOnMouseDownOrKeyDown = strdup(script + sizeof(&quot;mouse::&quot;) - 1);
262             } else if (script == strstr(script, &quot;key::&quot;)) {
263                 obj-&gt;evaluateScriptOnMouseDownOrKeyDown = strdup(script + sizeof(&quot;key::&quot;) - 1);
264             }
265             // When testing evaluate script on mouse-down or key-down, allow event logging to handle events.
266             if (obj-&gt;evaluateScriptOnMouseDownOrKeyDown)
267                 obj-&gt;eventLogging = true;
268         } else if (!strcasecmp(argn[i], &quot;windowedPlugin&quot;)) {
269             void* windowed = 0;
270             if (!strcasecmp(argv[i], &quot;false&quot;) || !strcasecmp(argv[i], &quot;0&quot;))
271                 windowed = 0;
272             else if (!strcasecmp(argv[i], &quot;true&quot;) || !strcasecmp(argv[i], &quot;1&quot;))
273                 windowed = reinterpret_cast&lt;void*&gt;(1);
274             else
275                 assert(false);
276             browser-&gt;setvalue(instance, NPPVpluginWindowBool, windowed);
277         }
278     }
279 
280 #ifdef XP_MACOSX
281     browser-&gt;setvalue(instance, NPPVpluginDrawingModel, (void *)drawingModelToUse);
282     if (drawingModelToUse == NPDrawingModelCoreAnimation)
283         obj-&gt;coreAnimationLayer = createCoreAnimationLayer();
284 #endif
285 
286     obj-&gt;pluginTest = PluginTest::create(instance, testIdentifier);
287 
288     if (!obj-&gt;pluginTest) {
289         pluginLog(instance, &quot;NPP_New: Could not find a test named \&quot;%s\&quot;, maybe its .cpp file wasn&#39;t added to the build system?&quot;, testIdentifier.c_str());
290         return NPERR_GENERIC_ERROR;
291     }
292 
293     if (onNewScript)
294         executeScript(obj, onNewScript);
295 
296     return obj-&gt;pluginTest-&gt;NPP_New(pluginType, mode, argc, argn, argv, saved);
297 }
298 
299 NPError NPP_Destroy(NPP instance, NPSavedData **save)
300 {
301     PluginObject* obj = static_cast&lt;PluginObject*&gt;(instance-&gt;pdata);
302     if (obj) {
303         if (obj-&gt;testGetURLOnDestroy)
304             browser-&gt;geturlnotify(obj-&gt;npp, &quot;about:blank&quot;, &quot;&quot;, 0);
305 
306         if (obj-&gt;onDestroy) {
307             executeScript(obj, obj-&gt;onDestroy);
308             free(obj-&gt;onDestroy);
309         }
310 
311         if (obj-&gt;onStreamLoad)
312             free(obj-&gt;onStreamLoad);
313 
314         if (obj-&gt;onStreamDestroy)
315             free(obj-&gt;onStreamDestroy);
316 
317         if (obj-&gt;onURLNotify)
318             free(obj-&gt;onURLNotify);
319 
320         if (obj-&gt;onSetWindow)
321             free(obj-&gt;onSetWindow);
322 
323         if (obj-&gt;onPaintEvent)
324             free(obj-&gt;onPaintEvent);
325 
326         if (obj-&gt;evaluateScriptOnMouseDownOrKeyDown)
327             free(obj-&gt;evaluateScriptOnMouseDownOrKeyDown);
328 
329         if (obj-&gt;logDestroy)
330             pluginLog(instance, &quot;NPP_Destroy&quot;);
331 
332 #ifdef XP_MACOSX
333         if (obj-&gt;coreAnimationLayer)
334             CFRelease(obj-&gt;coreAnimationLayer);
335 #endif
336 
337         if (obj-&gt;pluginTest)
338             obj-&gt;pluginTest-&gt;NPP_Destroy(save);
339 
340         browser-&gt;releaseobject(&amp;obj-&gt;header);
341     }
342     return NPERR_NO_ERROR;
343 }
344 
345 NPError NPP_SetWindow(NPP instance, NPWindow *window)
346 {
347     PluginObject* obj = static_cast&lt;PluginObject*&gt;(instance-&gt;pdata);
348 
349     if (!obj)
350         return NPERR_GENERIC_ERROR;
351 
352     obj-&gt;lastWindow = *window;
353 
354     if (obj-&gt;logSetWindow) {
355         pluginLog(instance, &quot;NPP_SetWindow: %d %d&quot;, (int)window-&gt;width, (int)window-&gt;height);
356         obj-&gt;logSetWindow = FALSE;
357         executeScript(obj, &quot;testRunner.notifyDone();&quot;);
358     }
359 
360     if (obj-&gt;onSetWindow)
361         executeScript(obj, obj-&gt;onSetWindow);
362 
363     if (obj-&gt;testWindowOpen) {
364         testWindowOpen(instance);
365         obj-&gt;testWindowOpen = FALSE;
366     }
367 
368     if (obj-&gt;testKeyboardFocusForPlugins) {
369         obj-&gt;eventLogging = true;
370         executeScript(obj, &quot;eventSender.keyDown(&#39;A&#39;);&quot;);
371     }
372 
373     return obj-&gt;pluginTest-&gt;NPP_SetWindow(window);
374 }
375 
376 static void executeScript(const PluginObject* obj, const char* script)
377 {
378     NPObject *windowScriptObject;
379     browser-&gt;getvalue(obj-&gt;npp, NPNVWindowNPObject, &amp;windowScriptObject);
380 
381     NPString npScript;
382     npScript.UTF8Characters = script;
383     npScript.UTF8Length = strlen(script);
384 
385     NPVariant browserResult;
386     browser-&gt;evaluate(obj-&gt;npp, windowScriptObject, &amp;npScript, &amp;browserResult);
387     browser-&gt;releasevariantvalue(&amp;browserResult);
388 }
389 
390 NPError NPP_NewStream(NPP instance, NPMIMEType type, NPStream *stream, NPBool seekable, uint16_t *stype)
391 {
392     PluginObject* obj = static_cast&lt;PluginObject*&gt;(instance-&gt;pdata);
393     obj-&gt;stream = stream;
394     *stype = NP_NORMAL;
395 
396     if (obj-&gt;returnErrorFromNewStream)
397         return NPERR_GENERIC_ERROR;
398 
399     if (browser-&gt;version &gt;= NPVERS_HAS_RESPONSE_HEADERS)
400         notifyStream(obj, stream-&gt;url, stream-&gt;headers);
401 
402     if (obj-&gt;onStreamLoad)
403         executeScript(obj, obj-&gt;onStreamLoad);
404 
405     return obj-&gt;pluginTest-&gt;NPP_NewStream(type, stream, seekable, stype);
406 }
407 
408 NPError NPP_DestroyStream(NPP instance, NPStream *stream, NPReason reason)
409 {
410     PluginObject* obj = (PluginObject*)instance-&gt;pdata;
411 
412     if (obj-&gt;onStreamDestroy) {
413         NPObject* windowObject = 0;
414         NPError error = browser-&gt;getvalue(instance, NPNVWindowNPObject, &amp;windowObject);
415 
416         if (error == NPERR_NO_ERROR) {
417             NPVariant onStreamDestroyVariant;
418             if (browser-&gt;getproperty(instance, windowObject, browser-&gt;getstringidentifier(obj-&gt;onStreamDestroy), &amp;onStreamDestroyVariant)) {
419                 if (NPVARIANT_IS_OBJECT(onStreamDestroyVariant)) {
420                     NPObject* onStreamDestroyFunction = NPVARIANT_TO_OBJECT(onStreamDestroyVariant);
421 
422                     NPVariant reasonVariant;
423                     INT32_TO_NPVARIANT(reason, reasonVariant);
424 
425                     NPVariant result;
426                     browser-&gt;invokeDefault(instance, onStreamDestroyFunction, &amp;reasonVariant, 1, &amp;result);
427                     browser-&gt;releasevariantvalue(&amp;result);
428                 }
429                 browser-&gt;releasevariantvalue(&amp;onStreamDestroyVariant);
430             }
431             browser-&gt;releaseobject(windowObject);
432         }
433     }
434 
435     return obj-&gt;pluginTest-&gt;NPP_DestroyStream(stream, reason);
436 }
437 
438 int32_t NPP_WriteReady(NPP instance, NPStream *stream)
439 {
440     PluginObject* obj = (PluginObject*)instance-&gt;pdata;
441     return obj-&gt;pluginTest-&gt;NPP_WriteReady(stream);
442 }
443 
444 int32_t NPP_Write(NPP instance, NPStream *stream, int32_t offset, int32_t len, void *buffer)
445 {
446     PluginObject* obj = (PluginObject*)instance-&gt;pdata;
447 
448     if (obj-&gt;returnNegativeOneFromWrite)
449         return -1;
450 
451     return obj-&gt;pluginTest-&gt;NPP_Write(stream, offset, len, buffer);
452 }
453 
454 void NPP_StreamAsFile(NPP instance, NPStream *stream, const char *fname)
455 {
456 }
457 
458 void NPP_Print(NPP instance, NPPrint *platformPrint)
459 {
460 }
461 
462 #ifdef XP_MACOSX
<a name="7" id="anc7"></a><span class="line-removed">463 #ifndef NP_NO_CARBON</span>
<span class="line-removed">464 static int16_t handleEventCarbon(NPP instance, PluginObject* obj, EventRecord* event)</span>
<span class="line-removed">465 {</span>
<span class="line-removed">466     Point pt = { event-&gt;where.v, event-&gt;where.h };</span>
<span class="line-removed">467 </span>
<span class="line-removed">468     switch (event-&gt;what) {</span>
<span class="line-removed">469         case nullEvent:</span>
<span class="line-removed">470             // these are delivered non-deterministically, don&#39;t log.</span>
<span class="line-removed">471             break;</span>
<span class="line-removed">472         case mouseDown:</span>
<span class="line-removed">473             if (obj-&gt;eventLogging) {</span>
<span class="line-removed">474                 ALLOW_DEPRECATED_DECLARATIONS_BEGIN</span>
<span class="line-removed">475                 GlobalToLocal(&amp;pt);</span>
<span class="line-removed">476                 ALLOW_DEPRECATED_DECLARATIONS_END</span>
<span class="line-removed">477                 pluginLog(instance, &quot;mouseDown at (%d, %d)&quot;, pt.h, pt.v);</span>
<span class="line-removed">478             }</span>
<span class="line-removed">479             if (obj-&gt;evaluateScriptOnMouseDownOrKeyDown &amp;&amp; obj-&gt;mouseDownForEvaluateScript)</span>
<span class="line-removed">480                 executeScript(obj, obj-&gt;evaluateScriptOnMouseDownOrKeyDown);</span>
<span class="line-removed">481             break;</span>
<span class="line-removed">482         case mouseUp:</span>
<span class="line-removed">483             if (obj-&gt;eventLogging) {</span>
<span class="line-removed">484                 ALLOW_DEPRECATED_DECLARATIONS_BEGIN</span>
<span class="line-removed">485                 GlobalToLocal(&amp;pt);</span>
<span class="line-removed">486                 ALLOW_DEPRECATED_DECLARATIONS_END</span>
<span class="line-removed">487                 pluginLog(instance, &quot;mouseUp at (%d, %d)&quot;, pt.h, pt.v);</span>
<span class="line-removed">488             }</span>
<span class="line-removed">489             break;</span>
<span class="line-removed">490         case keyDown:</span>
<span class="line-removed">491             if (obj-&gt;eventLogging)</span>
<span class="line-removed">492                 pluginLog(instance, &quot;keyDown &#39;%c&#39;&quot;, (char)(event-&gt;message &amp; 0xFF));</span>
<span class="line-removed">493             if (obj-&gt;evaluateScriptOnMouseDownOrKeyDown &amp;&amp; !obj-&gt;mouseDownForEvaluateScript)</span>
<span class="line-removed">494                 executeScript(obj, obj-&gt;evaluateScriptOnMouseDownOrKeyDown);</span>
<span class="line-removed">495             break;</span>
<span class="line-removed">496         case keyUp:</span>
<span class="line-removed">497             if (obj-&gt;eventLogging)</span>
<span class="line-removed">498                 pluginLog(instance, &quot;keyUp &#39;%c&#39;&quot;, (char)(event-&gt;message &amp; 0xFF));</span>
<span class="line-removed">499             if (obj-&gt;testKeyboardFocusForPlugins) {</span>
<span class="line-removed">500                 obj-&gt;eventLogging = false;</span>
<span class="line-removed">501                 obj-&gt;testKeyboardFocusForPlugins = FALSE;</span>
<span class="line-removed">502                 executeScript(obj, &quot;testRunner.notifyDone();&quot;);</span>
<span class="line-removed">503             }</span>
<span class="line-removed">504             break;</span>
<span class="line-removed">505         case autoKey:</span>
<span class="line-removed">506             if (obj-&gt;eventLogging)</span>
<span class="line-removed">507                 pluginLog(instance, &quot;autoKey &#39;%c&#39;&quot;, (char)(event-&gt;message &amp; 0xFF));</span>
<span class="line-removed">508             break;</span>
<span class="line-removed">509         case updateEvt:</span>
<span class="line-removed">510             if (obj-&gt;eventLogging)</span>
<span class="line-removed">511                 pluginLog(instance, &quot;updateEvt&quot;);</span>
<span class="line-removed">512             break;</span>
<span class="line-removed">513         case diskEvt:</span>
<span class="line-removed">514             if (obj-&gt;eventLogging)</span>
<span class="line-removed">515                 pluginLog(instance, &quot;diskEvt&quot;);</span>
<span class="line-removed">516             break;</span>
<span class="line-removed">517         case activateEvt:</span>
<span class="line-removed">518             if (obj-&gt;eventLogging)</span>
<span class="line-removed">519                 pluginLog(instance, &quot;activateEvt&quot;);</span>
<span class="line-removed">520             break;</span>
<span class="line-removed">521         case osEvt:</span>
<span class="line-removed">522             if (!obj-&gt;eventLogging)</span>
<span class="line-removed">523                 break;</span>
<span class="line-removed">524             printf(&quot;PLUGIN: osEvt - &quot;);</span>
<span class="line-removed">525             switch ((event-&gt;message &amp; 0xFF000000) &gt;&gt; 24) {</span>
<span class="line-removed">526                 case suspendResumeMessage:</span>
<span class="line-removed">527                     printf(&quot;%s\n&quot;, (event-&gt;message &amp; 0x1) ? &quot;resume&quot; : &quot;suspend&quot;);</span>
<span class="line-removed">528                     break;</span>
<span class="line-removed">529                 case mouseMovedMessage:</span>
<span class="line-removed">530                     printf(&quot;mouseMoved\n&quot;);</span>
<span class="line-removed">531                     break;</span>
<span class="line-removed">532                 default:</span>
<span class="line-removed">533                     printf(&quot;%08lX\n&quot;, event-&gt;message);</span>
<span class="line-removed">534             }</span>
<span class="line-removed">535             break;</span>
<span class="line-removed">536         case kHighLevelEvent:</span>
<span class="line-removed">537             if (obj-&gt;eventLogging)</span>
<span class="line-removed">538                 pluginLog(instance, &quot;kHighLevelEvent&quot;);</span>
<span class="line-removed">539             break;</span>
<span class="line-removed">540         // NPAPI events</span>
<span class="line-removed">541         case NPEventType_GetFocusEvent:</span>
<span class="line-removed">542             if (obj-&gt;eventLogging)</span>
<span class="line-removed">543                 pluginLog(instance, &quot;getFocusEvent&quot;);</span>
<span class="line-removed">544             break;</span>
<span class="line-removed">545         case NPEventType_LoseFocusEvent:</span>
<span class="line-removed">546             if (obj-&gt;eventLogging)</span>
<span class="line-removed">547                 pluginLog(instance, &quot;loseFocusEvent&quot;);</span>
<span class="line-removed">548             break;</span>
<span class="line-removed">549         case NPEventType_AdjustCursorEvent:</span>
<span class="line-removed">550             if (obj-&gt;eventLogging)</span>
<span class="line-removed">551                 pluginLog(instance, &quot;adjustCursorEvent&quot;);</span>
<span class="line-removed">552             break;</span>
<span class="line-removed">553         default:</span>
<span class="line-removed">554             if (obj-&gt;eventLogging)</span>
<span class="line-removed">555                 pluginLog(instance, &quot;event %d&quot;, event-&gt;what);</span>
<span class="line-removed">556     }</span>
<span class="line-removed">557 </span>
<span class="line-removed">558     return 0;</span>
<span class="line-removed">559 }</span>
<span class="line-removed">560 #endif</span>
<span class="line-removed">561 </span>
562 static int16_t handleEventCocoa(NPP instance, PluginObject* obj, NPCocoaEvent* event)
563 {
564     switch (event-&gt;type) {
565         case NPCocoaEventWindowFocusChanged:
566 
567         case NPCocoaEventFocusChanged:
568             if (obj-&gt;eventLogging) {
569                 if (event-&gt;data.focus.hasFocus)
570                     pluginLog(instance, &quot;getFocusEvent&quot;);
571                 else
572                     pluginLog(instance, &quot;loseFocusEvent&quot;);
573             }
574             return 1;
575 
576         case NPCocoaEventDrawRect: {
577             if (obj-&gt;onPaintEvent)
578                 executeScript(obj, obj-&gt;onPaintEvent);
579             return 1;
580         }
581 
582         case NPCocoaEventKeyDown:
583             if (obj-&gt;eventLogging &amp;&amp; event-&gt;data.key.characters)
584                 pluginLog(instance, &quot;keyDown &#39;%c&#39;&quot;, CFStringGetCharacterAtIndex(reinterpret_cast&lt;CFStringRef&gt;(event-&gt;data.key.characters), 0));
585             if (obj-&gt;evaluateScriptOnMouseDownOrKeyDown &amp;&amp; !obj-&gt;mouseDownForEvaluateScript)
586                 executeScript(obj, obj-&gt;evaluateScriptOnMouseDownOrKeyDown);
587             return 1;
588 
589         case NPCocoaEventKeyUp:
590             if (obj-&gt;eventLogging &amp;&amp; event-&gt;data.key.characters) {
591                 pluginLog(instance, &quot;keyUp &#39;%c&#39;&quot;, CFStringGetCharacterAtIndex(reinterpret_cast&lt;CFStringRef&gt;(event-&gt;data.key.characters), 0));
592                 if (obj-&gt;testKeyboardFocusForPlugins) {
593                     obj-&gt;eventLogging = false;
594                     obj-&gt;testKeyboardFocusForPlugins = FALSE;
595                     executeScript(obj, &quot;testRunner.notifyDone();&quot;);
596                 }
597             }
598             return 1;
599 
600         case NPCocoaEventFlagsChanged:
601             return 1;
602 
603         case NPCocoaEventMouseDown:
604             if (obj-&gt;eventLogging) {
605                 pluginLog(instance, &quot;mouseDown at (%d, %d)&quot;,
606                        (int)event-&gt;data.mouse.pluginX,
607                        (int)event-&gt;data.mouse.pluginY);
608             }
609             if (obj-&gt;evaluateScriptOnMouseDownOrKeyDown &amp;&amp; obj-&gt;mouseDownForEvaluateScript)
610                 executeScript(obj, obj-&gt;evaluateScriptOnMouseDownOrKeyDown);
611             return 1;
612         case NPCocoaEventMouseUp:
613             if (obj-&gt;eventLogging) {
614                 pluginLog(instance, &quot;mouseUp at (%d, %d)&quot;,
615                        (int)event-&gt;data.mouse.pluginX,
616                        (int)event-&gt;data.mouse.pluginY);
617             }
618             return 1;
619 
620         case NPCocoaEventMouseMoved:
621         case NPCocoaEventMouseEntered:
622         case NPCocoaEventMouseExited:
623         case NPCocoaEventMouseDragged:
624         case NPCocoaEventScrollWheel:
625         case NPCocoaEventTextInput:
626             return 1;
627     }
628 
629     return 0;
630 }
631 
632 #endif // XP_MACOSX
633 
634 #if defined(MOZ_X11)
635 static char keyEventToChar(XKeyEvent* event)
636 {
637     char c = &#39; &#39;;
638     XLookupString(event, &amp;c, sizeof(c), 0, 0);
639     return c;
640 }
641 
642 static int16_t handleEventX11(NPP instance, PluginObject* obj, XEvent* event)
643 {
644     switch (event-&gt;type) {
645     case ButtonPress:
646         if (obj-&gt;eventLogging)
647             pluginLog(instance, &quot;mouseDown at (%d, %d)&quot;, event-&gt;xbutton.x, event-&gt;xbutton.y);
648         if (obj-&gt;evaluateScriptOnMouseDownOrKeyDown &amp;&amp; obj-&gt;mouseDownForEvaluateScript)
649             executeScript(obj, obj-&gt;evaluateScriptOnMouseDownOrKeyDown);
650         break;
651     case ButtonRelease:
652         if (obj-&gt;eventLogging)
653             pluginLog(instance, &quot;mouseUp at (%d, %d)&quot;, event-&gt;xbutton.x, event-&gt;xbutton.y);
654         break;
655     case KeyPress:
656         // FIXME: extract key code
657         if (obj-&gt;eventLogging)
658             pluginLog(instance, &quot;keyDown &#39;%c&#39;&quot;, keyEventToChar(&amp;event-&gt;xkey));
659         if (obj-&gt;evaluateScriptOnMouseDownOrKeyDown &amp;&amp; !obj-&gt;mouseDownForEvaluateScript)
660             executeScript(obj, obj-&gt;evaluateScriptOnMouseDownOrKeyDown);
661         break;
662     case KeyRelease:
663         // FIXME: extract key code
664         if (obj-&gt;eventLogging)
665             pluginLog(instance, &quot;keyUp &#39;%c&#39;&quot;, keyEventToChar(&amp;event-&gt;xkey));
666         if (obj-&gt;testKeyboardFocusForPlugins) {
667             obj-&gt;eventLogging = false;
668             obj-&gt;testKeyboardFocusForPlugins = FALSE;
669             executeScript(obj, &quot;testRunner.notifyDone();&quot;);
670         }
671         break;
672     case GraphicsExpose:
673         if (obj-&gt;eventLogging)
674             pluginLog(instance, &quot;updateEvt&quot;);
675         if (obj-&gt;onPaintEvent)
676             executeScript(obj, obj-&gt;onPaintEvent);
677         break;
678     // NPAPI events
679     case FocusIn:
680         if (obj-&gt;eventLogging)
681             pluginLog(instance, &quot;getFocusEvent&quot;);
682         break;
683     case FocusOut:
684         if (obj-&gt;eventLogging)
685             pluginLog(instance, &quot;loseFocusEvent&quot;);
686         break;
687     case EnterNotify:
688     case LeaveNotify:
689     case MotionNotify:
690         break;
691     default:
692         if (obj-&gt;eventLogging)
693             pluginLog(instance, &quot;event %d&quot;, event-&gt;type);
694     }
695 
696     fflush(stdout);
697     return 0;
698 }
699 #endif // MOZ_X11
700 
701 #ifdef XP_WIN
702 static int16_t handleEventWin(NPP instance, PluginObject* obj, NPEvent* event)
703 {
704     switch (event-&gt;event) {
705     case WM_PAINT:
706         if (obj-&gt;onPaintEvent)
707             executeScript(obj, obj-&gt;onPaintEvent);
708         break;
709     case WM_KEYDOWN:
710         if (obj-&gt;eventLogging)
711             pluginLog(instance, &quot;keyDown &#39;%c&#39;&quot;, event-&gt;wParam);
712         if (obj-&gt;evaluateScriptOnMouseDownOrKeyDown &amp;&amp; !obj-&gt;mouseDownForEvaluateScript)
713             executeScript(obj, obj-&gt;evaluateScriptOnMouseDownOrKeyDown);
714         break;
715     case WM_CHAR:
716         break;
717     case WM_KEYUP:
718         if (obj-&gt;eventLogging)
719             pluginLog(instance, &quot;keyUp &#39;%c&#39;&quot;, event-&gt;wParam);
720         if (obj-&gt;testKeyboardFocusForPlugins) {
721             obj-&gt;eventLogging = false;
722             obj-&gt;testKeyboardFocusForPlugins = FALSE;
723             executeScript(obj, &quot;testRunner.notifyDone();&quot;);
724         }
725         break;
726     case WM_LBUTTONDOWN:
727     case WM_MBUTTONDOWN:
728     case WM_RBUTTONDOWN:
729         if (obj-&gt;eventLogging)
730             pluginLog(instance, &quot;mouseDown at (%d, %d)&quot;, LOWORD(event-&gt;lParam), HIWORD(event-&gt;lParam));
731         if (obj-&gt;evaluateScriptOnMouseDownOrKeyDown &amp;&amp; obj-&gt;mouseDownForEvaluateScript)
732             executeScript(obj, obj-&gt;evaluateScriptOnMouseDownOrKeyDown);
733         break;
734     case WM_LBUTTONUP:
735     case WM_MBUTTONUP:
736     case WM_RBUTTONUP:
737         if (obj-&gt;eventLogging)
738             pluginLog(instance, &quot;mouseUp at (%d, %d)&quot;, LOWORD(event-&gt;lParam), HIWORD(event-&gt;lParam));
739         break;
740     case WM_SETFOCUS:
741         if (obj-&gt;eventLogging)
742             pluginLog(instance, &quot;getFocusEvent&quot;);
743         break;
744     case WM_KILLFOCUS:
745         if (obj-&gt;eventLogging)
746             pluginLog(instance, &quot;loseFocusEvent&quot;);
747         break;
748     }
749     return 0;
750 }
751 #endif // XP_WIN
752 
753 int16_t NPP_HandleEvent(NPP instance, void *event)
754 {
755     PluginObject* obj = static_cast&lt;PluginObject*&gt;(instance-&gt;pdata);
756 
757     if (obj-&gt;pluginTest-&gt;NPP_HandleEvent(event) == 1)
758         return 1;
759 
760 #ifdef XP_MACOSX
<a name="8" id="anc8"></a><span class="line-removed">761 #ifndef NP_NO_CARBON</span>
<span class="line-removed">762     if (obj-&gt;eventModel == NPEventModelCarbon)</span>
<span class="line-removed">763         return handleEventCarbon(instance, obj, static_cast&lt;EventRecord*&gt;(event));</span>
<span class="line-removed">764 #endif</span>
<span class="line-removed">765 </span>
766     assert(obj-&gt;eventModel == NPEventModelCocoa);
767     return handleEventCocoa(instance, obj, static_cast&lt;NPCocoaEvent*&gt;(event));
768 #elif defined(MOZ_X11)
769     return handleEventX11(instance, obj, static_cast&lt;XEvent*&gt;(event));
770 #elif defined(XP_WIN)
771     return handleEventWin(instance, obj, static_cast&lt;NPEvent*&gt;(event));
772 #else
773     // FIXME: Implement for other platforms.
774     return 0;
775 #endif // XP_MACOSX
776 }
777 
778 void NPP_URLNotify(NPP instance, const char *url, NPReason reason, void *notifyData)
779 {
780     PluginObject* obj = static_cast&lt;PluginObject*&gt;(instance-&gt;pdata);
781     if (obj-&gt;pluginTest-&gt;NPP_URLNotify(url, reason, notifyData))
782         return;
783 
784     if (obj-&gt;onURLNotify)
785          executeScript(obj, obj-&gt;onURLNotify);
786 
787     handleCallback(obj, url, reason, notifyData);
788 }
789 
790 void NPP_URLRedirectNotify(NPP instance, const char *url, int32_t status, void *notifyData)
791 {
792     PluginObject* obj = static_cast&lt;PluginObject*&gt;(instance-&gt;pdata);
793     obj-&gt;pluginTest-&gt;NPP_URLRedirectNotify(url, status, notifyData);
794 }
795 
796 NPError NPP_GetValue(NPP instance, NPPVariable variable, void *value)
797 {
798 #if defined(XP_UNIX)
799     if (variable == NPPVpluginNameString) {
800         *((char **)value) = const_cast&lt;char*&gt;(&quot;WebKit Test PlugIn&quot;);
801         return NPERR_NO_ERROR;
802     }
803     if (variable == NPPVpluginDescriptionString) {
804         *((char **)value) = const_cast&lt;char*&gt;(&quot;Simple NetscapeÂ® plug-in that handles test content for WebKit&quot;);
805         return NPERR_NO_ERROR;
806     }
807 #endif
808 
809 #if defined(MOZ_X11)
810     if (variable == NPPVpluginNeedsXEmbed) {
811         *((NPBool *)value) = TRUE;
812         return NPERR_NO_ERROR;
813     }
814 #endif
815 
816     if (!instance)
817         return NPERR_GENERIC_ERROR;
818     PluginObject* obj = static_cast&lt;PluginObject*&gt;(instance-&gt;pdata);
819 
820     // First, check if the PluginTest object supports getting this value.
821     if (obj-&gt;pluginTest-&gt;NPP_GetValue(variable, value) == NPERR_NO_ERROR)
822         return NPERR_NO_ERROR;
823 
824     if (variable == NPPVpluginScriptableNPObject) {
825         void **v = (void **)value;
826         // Return value is expected to be retained
827         browser-&gt;retainobject((NPObject *)obj);
828         *v = obj;
829         return NPERR_NO_ERROR;
830     }
831 
832 #ifdef XP_MACOSX
833     if (variable == NPPVpluginCoreAnimationLayer) {
834         if (!obj-&gt;coreAnimationLayer)
835             return NPERR_GENERIC_ERROR;
836 
837         void **v = (void **)value;
838         *v = (void*)CFRetain(obj-&gt;coreAnimationLayer);
839         return NPERR_NO_ERROR;
840     }
841 #endif
842 
843     return NPERR_GENERIC_ERROR;
844 }
845 
846 NPError NPP_SetValue(NPP instance, NPNVariable variable, void *value)
847 {
848     PluginObject* obj = static_cast&lt;PluginObject*&gt;(instance-&gt;pdata);
849     return obj-&gt;pluginTest-&gt;NPP_SetValue(variable, value);
850 }
851 
852 #if defined(XP_UNIX)
853 extern &quot;C&quot;
854 const char* NP_GetMIMEDescription(void)
855 {
856     return &quot;application/x-webkit-test-netscape:testnetscape:test netscape content;image/png:png:PNG image&quot;;
857 }
858 
859 extern &quot;C&quot;
860 NPError NP_GetValue(NPP instance, NPPVariable variable, void* value)
861 {
862     return NPP_GetValue(instance, variable, value);
863 }
864 #endif
<a name="9" id="anc9"></a><b style="font-size: large; color: red">--- EOF ---</b>
















































































</pre>
<input id="eof" value="9" type="hidden" />
</body>
</html>