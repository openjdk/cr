<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Old src/hotspot/share/oops/method.cpp</title>
    <link rel="stylesheet" href="../../../../style.css" />
  </head>
  <body>
    <pre>
   1 /*
   2  * Copyright (c) 1997, 2019, Oracle and/or its affiliates. All rights reserved.
   3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   4  *
   5  * This code is free software; you can redistribute it and/or modify it
   6  * under the terms of the GNU General Public License version 2 only, as
   7  * published by the Free Software Foundation.
   8  *
   9  * This code is distributed in the hope that it will be useful, but WITHOUT
  10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
  11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
  12  * version 2 for more details (a copy is included in the LICENSE file that
  13  * accompanied this code).
  14  *
  15  * You should have received a copy of the GNU General Public License version
  16  * 2 along with this work; if not, write to the Free Software Foundation,
  17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
  18  *
  19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
  20  * or visit www.oracle.com if you need additional information or have any
  21  * questions.
  22  *
  23  */
  24 
  25 #include &quot;precompiled.hpp&quot;
  26 #include &quot;classfile/classLoaderDataGraph.hpp&quot;
  27 #include &quot;classfile/metadataOnStackMark.hpp&quot;
  28 #include &quot;classfile/systemDictionary.hpp&quot;
  29 #include &quot;code/codeCache.hpp&quot;
  30 #include &quot;code/debugInfoRec.hpp&quot;
  31 #include &quot;gc/shared/collectedHeap.inline.hpp&quot;
  32 #include &quot;interpreter/bytecodeStream.hpp&quot;
  33 #include &quot;interpreter/bytecodeTracer.hpp&quot;
  34 #include &quot;interpreter/bytecodes.hpp&quot;
  35 #include &quot;interpreter/interpreter.hpp&quot;
  36 #include &quot;interpreter/oopMapCache.hpp&quot;
  37 #include &quot;memory/allocation.inline.hpp&quot;
  38 #include &quot;memory/heapInspection.hpp&quot;
  39 #include &quot;memory/metadataFactory.hpp&quot;
  40 #include &quot;memory/metaspaceClosure.hpp&quot;
  41 #include &quot;memory/metaspaceShared.hpp&quot;
  42 #include &quot;memory/oopFactory.hpp&quot;
  43 #include &quot;memory/resourceArea.hpp&quot;
  44 #include &quot;oops/constMethod.hpp&quot;
  45 #include &quot;oops/constantPool.hpp&quot;
  46 #include &quot;oops/method.inline.hpp&quot;
  47 #include &quot;oops/methodData.hpp&quot;
  48 #include &quot;oops/objArrayOop.inline.hpp&quot;
  49 #include &quot;oops/oop.inline.hpp&quot;
  50 #include &quot;oops/symbol.hpp&quot;
  51 #include &quot;prims/jvmtiExport.hpp&quot;
  52 #include &quot;prims/methodHandles.hpp&quot;
  53 #include &quot;prims/nativeLookup.hpp&quot;
  54 #include &quot;runtime/arguments.hpp&quot;
  55 #include &quot;runtime/compilationPolicy.hpp&quot;
  56 #include &quot;runtime/frame.inline.hpp&quot;
  57 #include &quot;runtime/handles.inline.hpp&quot;
  58 #include &quot;runtime/init.hpp&quot;
  59 #include &quot;runtime/orderAccess.hpp&quot;
  60 #include &quot;runtime/relocator.hpp&quot;
  61 #include &quot;runtime/safepointVerifiers.hpp&quot;
  62 #include &quot;runtime/sharedRuntime.hpp&quot;
  63 #include &quot;runtime/signature.hpp&quot;
  64 #include &quot;utilities/align.hpp&quot;
  65 #include &quot;utilities/quickSort.hpp&quot;
  66 #include &quot;utilities/vmError.hpp&quot;
  67 #include &quot;utilities/xmlstream.hpp&quot;
  68 
  69 // Implementation of Method
  70 
  71 Method* Method::allocate(ClassLoaderData* loader_data,
  72                          int byte_code_size,
  73                          AccessFlags access_flags,
  74                          InlineTableSizes* sizes,
  75                          ConstMethod::MethodType method_type,
  76                          TRAPS) {
  77   assert(!access_flags.is_native() || byte_code_size == 0,
  78          &quot;native methods should not contain byte codes&quot;);
  79   ConstMethod* cm = ConstMethod::allocate(loader_data,
  80                                           byte_code_size,
  81                                           sizes,
  82                                           method_type,
  83                                           CHECK_NULL);
  84   int size = Method::size(access_flags.is_native());
  85   return new (loader_data, size, MetaspaceObj::MethodType, THREAD) Method(cm, access_flags);
  86 }
  87 
  88 Method::Method(ConstMethod* xconst, AccessFlags access_flags) {
  89   NoSafepointVerifier no_safepoint;
  90   set_constMethod(xconst);
  91   set_access_flags(access_flags);
  92   set_intrinsic_id(vmIntrinsics::_none);
  93   set_force_inline(false);
  94   set_hidden(false);
  95   set_dont_inline(false);
  96   set_has_injected_profile(false);
  97   set_method_data(NULL);
  98   clear_method_counters();
  99   set_vtable_index(Method::garbage_vtable_index);
 100 
 101   // Fix and bury in Method*
 102   set_interpreter_entry(NULL); // sets i2i entry and from_int
 103   set_adapter_entry(NULL);
 104   clear_code(false /* don&#39;t need a lock */); // from_c/from_i get set to c2i/i2i
 105 
 106   if (access_flags.is_native()) {
 107     clear_native_function();
 108     set_signature_handler(NULL);
 109   }
 110 
 111   NOT_PRODUCT(set_compiled_invocation_count(0);)
 112 }
 113 
 114 // Release Method*.  The nmethod will be gone when we get here because
 115 // we&#39;ve walked the code cache.
 116 void Method::deallocate_contents(ClassLoaderData* loader_data) {
 117   MetadataFactory::free_metadata(loader_data, constMethod());
 118   set_constMethod(NULL);
 119   MetadataFactory::free_metadata(loader_data, method_data());
 120   set_method_data(NULL);
 121   MetadataFactory::free_metadata(loader_data, method_counters());
 122   clear_method_counters();
 123   // The nmethod will be gone when we get here.
 124   if (code() != NULL) _code = NULL;
 125 }
 126 
 127 address Method::get_i2c_entry() {
 128   assert(adapter() != NULL, &quot;must have&quot;);
 129   return adapter()-&gt;get_i2c_entry();
 130 }
 131 
 132 address Method::get_c2i_entry() {
 133   assert(adapter() != NULL, &quot;must have&quot;);
 134   return adapter()-&gt;get_c2i_entry();
 135 }
 136 
 137 address Method::get_c2i_unverified_entry() {
 138   assert(adapter() != NULL, &quot;must have&quot;);
 139   return adapter()-&gt;get_c2i_unverified_entry();
 140 }
 141 
 142 char* Method::name_and_sig_as_C_string() const {
 143   return name_and_sig_as_C_string(constants()-&gt;pool_holder(), name(), signature());
 144 }
 145 
 146 char* Method::name_and_sig_as_C_string(char* buf, int size) const {
 147   return name_and_sig_as_C_string(constants()-&gt;pool_holder(), name(), signature(), buf, size);
 148 }
 149 
 150 char* Method::name_and_sig_as_C_string(Klass* klass, Symbol* method_name, Symbol* signature) {
 151   const char* klass_name = klass-&gt;external_name();
 152   int klass_name_len  = (int)strlen(klass_name);
 153   int method_name_len = method_name-&gt;utf8_length();
 154   int len             = klass_name_len + 1 + method_name_len + signature-&gt;utf8_length();
 155   char* dest          = NEW_RESOURCE_ARRAY(char, len + 1);
 156   strcpy(dest, klass_name);
 157   dest[klass_name_len] = &#39;.&#39;;
 158   strcpy(&amp;dest[klass_name_len + 1], method_name-&gt;as_C_string());
 159   strcpy(&amp;dest[klass_name_len + 1 + method_name_len], signature-&gt;as_C_string());
 160   dest[len] = 0;
 161   return dest;
 162 }
 163 
 164 char* Method::name_and_sig_as_C_string(Klass* klass, Symbol* method_name, Symbol* signature, char* buf, int size) {
 165   Symbol* klass_name = klass-&gt;name();
 166   klass_name-&gt;as_klass_external_name(buf, size);
 167   int len = (int)strlen(buf);
 168 
 169   if (len &lt; size - 1) {
 170     buf[len++] = &#39;.&#39;;
 171 
 172     method_name-&gt;as_C_string(&amp;(buf[len]), size - len);
 173     len = (int)strlen(buf);
 174 
 175     signature-&gt;as_C_string(&amp;(buf[len]), size - len);
 176   }
 177 
 178   return buf;
 179 }
 180 
 181 int Method::fast_exception_handler_bci_for(const methodHandle&amp; mh, Klass* ex_klass, int throw_bci, TRAPS) {
 182   // exception table holds quadruple entries of the form (beg_bci, end_bci, handler_bci, klass_index)
 183   // access exception table
 184   ExceptionTable table(mh());
 185   int length = table.length();
 186   // iterate through all entries sequentially
 187   constantPoolHandle pool(THREAD, mh-&gt;constants());
 188   for (int i = 0; i &lt; length; i ++) {
 189     //reacquire the table in case a GC happened
 190     ExceptionTable table(mh());
 191     int beg_bci = table.start_pc(i);
 192     int end_bci = table.end_pc(i);
 193     assert(beg_bci &lt;= end_bci, &quot;inconsistent exception table&quot;);
 194     if (beg_bci &lt;= throw_bci &amp;&amp; throw_bci &lt; end_bci) {
 195       // exception handler bci range covers throw_bci =&gt; investigate further
 196       int handler_bci = table.handler_pc(i);
 197       int klass_index = table.catch_type_index(i);
 198       if (klass_index == 0) {
 199         return handler_bci;
 200       } else if (ex_klass == NULL) {
 201         return handler_bci;
 202       } else {
 203         // we know the exception class =&gt; get the constraint class
 204         // this may require loading of the constraint class; if verification
 205         // fails or some other exception occurs, return handler_bci
 206         Klass* k = pool-&gt;klass_at(klass_index, CHECK_(handler_bci));
 207         assert(k != NULL, &quot;klass not loaded&quot;);
 208         if (ex_klass-&gt;is_subtype_of(k)) {
 209           return handler_bci;
 210         }
 211       }
 212     }
 213   }
 214 
 215   return -1;
 216 }
 217 
 218 void Method::mask_for(int bci, InterpreterOopMap* mask) {
 219   methodHandle h_this(Thread::current(), this);
 220   // Only GC uses the OopMapCache during thread stack root scanning
 221   // any other uses generate an oopmap but do not save it in the cache.
 222   if (Universe::heap()-&gt;is_gc_active()) {
 223     method_holder()-&gt;mask_for(h_this, bci, mask);
 224   } else {
 225     OopMapCache::compute_one_oop_map(h_this, bci, mask);
 226   }
 227   return;
 228 }
 229 
 230 
 231 int Method::bci_from(address bcp) const {
 232   if (is_native() &amp;&amp; bcp == 0) {
 233     return 0;
 234   }
 235 #ifdef ASSERT
 236   {
 237     ResourceMark rm;
 238     assert(is_native() &amp;&amp; bcp == code_base() || contains(bcp) || VMError::is_error_reported(),
 239            &quot;bcp doesn&#39;t belong to this method: bcp: &quot; INTPTR_FORMAT &quot;, method: %s&quot;,
 240            p2i(bcp), name_and_sig_as_C_string());
 241   }
 242 #endif
 243   return bcp - code_base();
 244 }
 245 
 246 
 247 int Method::validate_bci(int bci) const {
 248   return (bci == 0 || bci &lt; code_size()) ? bci : -1;
 249 }
 250 
 251 // Return bci if it appears to be a valid bcp
 252 // Return -1 otherwise.
 253 // Used by profiling code, when invalid data is a possibility.
 254 // The caller is responsible for validating the Method* itself.
 255 int Method::validate_bci_from_bcp(address bcp) const {
 256   // keep bci as -1 if not a valid bci
 257   int bci = -1;
 258   if (bcp == 0 || bcp == code_base()) {
 259     // code_size() may return 0 and we allow 0 here
 260     // the method may be native
 261     bci = 0;
 262   } else if (contains(bcp)) {
 263     bci = bcp - code_base();
 264   }
 265   // Assert that if we have dodged any asserts, bci is negative.
 266   assert(bci == -1 || bci == bci_from(bcp_from(bci)), &quot;sane bci if &gt;=0&quot;);
 267   return bci;
 268 }
 269 
 270 address Method::bcp_from(int bci) const {
 271   assert((is_native() &amp;&amp; bci == 0) || (!is_native() &amp;&amp; 0 &lt;= bci &amp;&amp; bci &lt; code_size()),
 272          &quot;illegal bci: %d for %s method&quot;, bci, is_native() ? &quot;native&quot; : &quot;non-native&quot;);
 273   address bcp = code_base() + bci;
 274   assert(is_native() &amp;&amp; bcp == code_base() || contains(bcp), &quot;bcp doesn&#39;t belong to this method&quot;);
 275   return bcp;
 276 }
 277 
 278 address Method::bcp_from(address bcp) const {
 279   if (is_native() &amp;&amp; bcp == NULL) {
 280     return code_base();
 281   } else {
 282     return bcp;
 283   }
 284 }
 285 
 286 int Method::size(bool is_native) {
 287   // If native, then include pointers for native_function and signature_handler
 288   int extra_bytes = (is_native) ? 2*sizeof(address*) : 0;
 289   int extra_words = align_up(extra_bytes, BytesPerWord) / BytesPerWord;
 290   return align_metadata_size(header_size() + extra_words);
 291 }
 292 
 293 
 294 Symbol* Method::klass_name() const {
 295   return method_holder()-&gt;name();
 296 }
 297 
 298 
 299 void Method::metaspace_pointers_do(MetaspaceClosure* it) {
 300   log_trace(cds)(&quot;Iter(Method): %p&quot;, this);
 301 
 302   it-&gt;push(&amp;_constMethod);
 303   it-&gt;push(&amp;_method_data);
 304   it-&gt;push(&amp;_method_counters);
 305 }
 306 
 307 // Attempt to return method oop to original state.  Clear any pointers
 308 // (to objects outside the shared spaces).  We won&#39;t be able to predict
 309 // where they should point in a new JVM.  Further initialize some
 310 // entries now in order allow them to be write protected later.
 311 
 312 void Method::remove_unshareable_info() {
 313   unlink_method();
 314 }
 315 
 316 void Method::set_vtable_index(int index) {
 317   if (is_shared() &amp;&amp; !MetaspaceShared::remapped_readwrite()) {
 318     // At runtime initialize_vtable is rerun as part of link_class_impl()
 319     // for a shared class loaded by the non-boot loader to obtain the loader
 320     // constraints based on the runtime classloaders&#39; context.
 321     return; // don&#39;t write into the shared class
 322   } else {
 323     _vtable_index = index;
 324   }
 325 }
 326 
 327 void Method::set_itable_index(int index) {
 328   if (is_shared() &amp;&amp; !MetaspaceShared::remapped_readwrite()) {
 329     // At runtime initialize_itable is rerun as part of link_class_impl()
 330     // for a shared class loaded by the non-boot loader to obtain the loader
 331     // constraints based on the runtime classloaders&#39; context. The dumptime
 332     // itable index should be the same as the runtime index.
 333     assert(_vtable_index == itable_index_max - index,
 334            &quot;archived itable index is different from runtime index&quot;);
 335     return; // donâ€™t write into the shared class
 336   } else {
 337     _vtable_index = itable_index_max - index;
 338   }
 339   assert(valid_itable_index(), &quot;&quot;);
 340 }
 341 
 342 
 343 
 344 bool Method::was_executed_more_than(int n) {
 345   // Invocation counter is reset when the Method* is compiled.
 346   // If the method has compiled code we therefore assume it has
 347   // be excuted more than n times.
 348   if (is_accessor() || is_empty_method() || (code() != NULL)) {
 349     // interpreter doesn&#39;t bump invocation counter of trivial methods
 350     // compiler does not bump invocation counter of compiled methods
 351     return true;
 352   }
 353   else if ((method_counters() != NULL &amp;&amp;
 354             method_counters()-&gt;invocation_counter()-&gt;carry()) ||
 355            (method_data() != NULL &amp;&amp;
 356             method_data()-&gt;invocation_counter()-&gt;carry())) {
 357     // The carry bit is set when the counter overflows and causes
 358     // a compilation to occur.  We don&#39;t know how many times
 359     // the counter has been reset, so we simply assume it has
 360     // been executed more than n times.
 361     return true;
 362   } else {
 363     return invocation_count() &gt; n;
 364   }
 365 }
 366 
 367 void Method::print_invocation_count() {
 368   if (is_static()) tty-&gt;print(&quot;static &quot;);
 369   if (is_final()) tty-&gt;print(&quot;final &quot;);
 370   if (is_synchronized()) tty-&gt;print(&quot;synchronized &quot;);
 371   if (is_native()) tty-&gt;print(&quot;native &quot;);
 372   tty-&gt;print(&quot;%s::&quot;, method_holder()-&gt;external_name());
 373   name()-&gt;print_symbol_on(tty);
 374   signature()-&gt;print_symbol_on(tty);
 375 
 376   if (WizardMode) {
 377     // dump the size of the byte codes
 378     tty-&gt;print(&quot; {%d}&quot;, code_size());
 379   }
 380   tty-&gt;cr();
 381 
 382   tty-&gt;print_cr (&quot;  interpreter_invocation_count: %8d &quot;, interpreter_invocation_count());
 383   tty-&gt;print_cr (&quot;  invocation_counter:           %8d &quot;, invocation_count());
 384   tty-&gt;print_cr (&quot;  backedge_counter:             %8d &quot;, backedge_count());
 385 #ifndef PRODUCT
 386   if (CountCompiledCalls) {
 387     tty-&gt;print_cr (&quot;  compiled_invocation_count: %8d &quot;, compiled_invocation_count());
 388   }
 389 #endif
 390 }
 391 
 392 // Build a MethodData* object to hold information about this method
 393 // collected in the interpreter.
 394 void Method::build_interpreter_method_data(const methodHandle&amp; method, TRAPS) {
 395   // Do not profile the method if metaspace has hit an OOM previously
 396   // allocating profiling data. Callers clear pending exception so don&#39;t
 397   // add one here.
 398   if (ClassLoaderDataGraph::has_metaspace_oom()) {
 399     return;
 400   }
 401 
 402   // Grab a lock here to prevent multiple
 403   // MethodData*s from being created.
 404   MutexLocker ml(MethodData_lock, THREAD);
 405   if (method-&gt;method_data() == NULL) {
 406     ClassLoaderData* loader_data = method-&gt;method_holder()-&gt;class_loader_data();
 407     MethodData* method_data = MethodData::allocate(loader_data, method, THREAD);
 408     if (HAS_PENDING_EXCEPTION) {
 409       CompileBroker::log_metaspace_failure();
 410       ClassLoaderDataGraph::set_metaspace_oom(true);
 411       return;   // return the exception (which is cleared)
 412     }
 413 
 414     method-&gt;set_method_data(method_data);
 415     if (PrintMethodData &amp;&amp; (Verbose || WizardMode)) {
 416       ResourceMark rm(THREAD);
 417       tty-&gt;print(&quot;build_interpreter_method_data for &quot;);
 418       method-&gt;print_name(tty);
 419       tty-&gt;cr();
 420       // At the end of the run, the MDO, full of data, will be dumped.
 421     }
 422   }
 423 }
 424 
 425 MethodCounters* Method::build_method_counters(Method* m, TRAPS) {
 426   // Do not profile the method if metaspace has hit an OOM previously
 427   if (ClassLoaderDataGraph::has_metaspace_oom()) {
 428     return NULL;
 429   }
 430 
 431   methodHandle mh(m);
 432   MethodCounters* counters = MethodCounters::allocate(mh, THREAD);
 433   if (HAS_PENDING_EXCEPTION) {
 434     CompileBroker::log_metaspace_failure();
 435     ClassLoaderDataGraph::set_metaspace_oom(true);
 436     return NULL;   // return the exception (which is cleared)
 437   }
 438   if (!mh-&gt;init_method_counters(counters)) {
 439     MetadataFactory::free_metadata(mh-&gt;method_holder()-&gt;class_loader_data(), counters);
 440   }
 441 
 442   if (LogTouchedMethods) {
 443     mh-&gt;log_touched(CHECK_NULL);
 444   }
 445 
 446   return mh-&gt;method_counters();
 447 }
 448 
 449 bool Method::init_method_counters(MethodCounters* counters) {
 450   // Try to install a pointer to MethodCounters, return true on success.
 451   return Atomic::replace_if_null(counters, &amp;_method_counters);
 452 }
 453 
 454 int Method::extra_stack_words() {
 455   // not an inline function, to avoid a header dependency on Interpreter
 456   return extra_stack_entries() * Interpreter::stackElementSize;
 457 }
 458 
 459 
 460 void Method::compute_size_of_parameters(Thread *thread) {
 461   ArgumentSizeComputer asc(signature());
 462   set_size_of_parameters(asc.size() + (is_static() ? 0 : 1));
 463 }
 464 
 465 BasicType Method::result_type() const {
 466   ResultTypeFinder rtf(signature());
 467   return rtf.type();
 468 }
 469 
 470 
 471 bool Method::is_empty_method() const {
 472   return  code_size() == 1
 473       &amp;&amp; *code_base() == Bytecodes::_return;
 474 }
 475 
 476 
 477 bool Method::is_vanilla_constructor() const {
 478   // Returns true if this method is a vanilla constructor, i.e. an &quot;&lt;init&gt;&quot; &quot;()V&quot; method
 479   // which only calls the superclass vanilla constructor and possibly does stores of
 480   // zero constants to local fields:
 481   //
 482   //   aload_0
 483   //   invokespecial
 484   //   indexbyte1
 485   //   indexbyte2
 486   //
 487   // followed by an (optional) sequence of:
 488   //
 489   //   aload_0
 490   //   aconst_null / iconst_0 / fconst_0 / dconst_0
 491   //   putfield
 492   //   indexbyte1
 493   //   indexbyte2
 494   //
 495   // followed by:
 496   //
 497   //   return
 498 
 499   assert(name() == vmSymbols::object_initializer_name(),    &quot;Should only be called for default constructors&quot;);
 500   assert(signature() == vmSymbols::void_method_signature(), &quot;Should only be called for default constructors&quot;);
 501   int size = code_size();
 502   // Check if size match
 503   if (size == 0 || size % 5 != 0) return false;
 504   address cb = code_base();
 505   int last = size - 1;
 506   if (cb[0] != Bytecodes::_aload_0 || cb[1] != Bytecodes::_invokespecial || cb[last] != Bytecodes::_return) {
 507     // Does not call superclass default constructor
 508     return false;
 509   }
 510   // Check optional sequence
 511   for (int i = 4; i &lt; last; i += 5) {
 512     if (cb[i] != Bytecodes::_aload_0) return false;
 513     if (!Bytecodes::is_zero_const(Bytecodes::cast(cb[i+1]))) return false;
 514     if (cb[i+2] != Bytecodes::_putfield) return false;
 515   }
 516   return true;
 517 }
 518 
 519 
 520 bool Method::compute_has_loops_flag() {
 521   BytecodeStream bcs(this);
 522   Bytecodes::Code bc;
 523 
 524   while ((bc = bcs.next()) &gt;= 0) {
 525     switch( bc ) {
 526       case Bytecodes::_ifeq:
 527       case Bytecodes::_ifnull:
 528       case Bytecodes::_iflt:
 529       case Bytecodes::_ifle:
 530       case Bytecodes::_ifne:
 531       case Bytecodes::_ifnonnull:
 532       case Bytecodes::_ifgt:
 533       case Bytecodes::_ifge:
 534       case Bytecodes::_if_icmpeq:
 535       case Bytecodes::_if_icmpne:
 536       case Bytecodes::_if_icmplt:
 537       case Bytecodes::_if_icmpgt:
 538       case Bytecodes::_if_icmple:
 539       case Bytecodes::_if_icmpge:
 540       case Bytecodes::_if_acmpeq:
 541       case Bytecodes::_if_acmpne:
 542       case Bytecodes::_goto:
 543       case Bytecodes::_jsr:
 544         if( bcs.dest() &lt; bcs.next_bci() ) _access_flags.set_has_loops();
 545         break;
 546 
 547       case Bytecodes::_goto_w:
 548       case Bytecodes::_jsr_w:
 549         if( bcs.dest_w() &lt; bcs.next_bci() ) _access_flags.set_has_loops();
 550         break;
 551 
 552       default:
 553         break;
 554     }
 555   }
 556   _access_flags.set_loops_flag_init();
 557   return _access_flags.has_loops();
 558 }
 559 
 560 bool Method::is_final_method(AccessFlags class_access_flags) const {
 561   // or &quot;does_not_require_vtable_entry&quot;
 562   // default method or overpass can occur, is not final (reuses vtable entry)
 563   // private methods in classes get vtable entries for backward class compatibility.
 564   if (is_overpass() || is_default_method())  return false;
 565   return is_final() || class_access_flags.is_final();
 566 }
 567 
 568 bool Method::is_final_method() const {
 569   return is_final_method(method_holder()-&gt;access_flags());
 570 }
 571 
 572 bool Method::is_default_method() const {
 573   if (method_holder() != NULL &amp;&amp;
 574       method_holder()-&gt;is_interface() &amp;&amp;
 575       !is_abstract() &amp;&amp; !is_private()) {
 576     return true;
 577   } else {
 578     return false;
 579   }
 580 }
 581 
 582 bool Method::can_be_statically_bound(AccessFlags class_access_flags) const {
 583   if (is_final_method(class_access_flags))  return true;
 584 #ifdef ASSERT
 585   ResourceMark rm;
 586   bool is_nonv = (vtable_index() == nonvirtual_vtable_index);
 587   if (class_access_flags.is_interface()) {
 588       assert(is_nonv == is_static() || is_nonv == is_private(),
 589              &quot;nonvirtual unexpected for non-static, non-private: %s&quot;,
 590              name_and_sig_as_C_string());
 591   }
 592 #endif
 593   assert(valid_vtable_index() || valid_itable_index(), &quot;method must be linked before we ask this question&quot;);
 594   return vtable_index() == nonvirtual_vtable_index;
 595 }
 596 
 597 bool Method::can_be_statically_bound() const {
 598   return can_be_statically_bound(method_holder()-&gt;access_flags());
 599 }
 600 
 601 bool Method::is_accessor() const {
 602   return is_getter() || is_setter();
 603 }
 604 
 605 bool Method::is_getter() const {
 606   if (code_size() != 5) return false;
 607   if (size_of_parameters() != 1) return false;
 608   if (java_code_at(0) != Bytecodes::_aload_0)  return false;
 609   if (java_code_at(1) != Bytecodes::_getfield) return false;
 610   switch (java_code_at(4)) {
 611     case Bytecodes::_ireturn:
 612     case Bytecodes::_lreturn:
 613     case Bytecodes::_freturn:
 614     case Bytecodes::_dreturn:
 615     case Bytecodes::_areturn:
 616       break;
 617     default:
 618       return false;
 619   }
 620   return true;
 621 }
 622 
 623 bool Method::is_setter() const {
 624   if (code_size() != 6) return false;
 625   if (java_code_at(0) != Bytecodes::_aload_0) return false;
 626   switch (java_code_at(1)) {
 627     case Bytecodes::_iload_1:
 628     case Bytecodes::_aload_1:
 629     case Bytecodes::_fload_1:
 630       if (size_of_parameters() != 2) return false;
 631       break;
 632     case Bytecodes::_dload_1:
 633     case Bytecodes::_lload_1:
 634       if (size_of_parameters() != 3) return false;
 635       break;
 636     default:
 637       return false;
 638   }
 639   if (java_code_at(2) != Bytecodes::_putfield) return false;
 640   if (java_code_at(5) != Bytecodes::_return)   return false;
 641   return true;
 642 }
 643 
 644 bool Method::is_constant_getter() const {
 645   int last_index = code_size() - 1;
 646   // Check if the first 1-3 bytecodes are a constant push
 647   // and the last bytecode is a return.
 648   return (2 &lt;= code_size() &amp;&amp; code_size() &lt;= 4 &amp;&amp;
 649           Bytecodes::is_const(java_code_at(0)) &amp;&amp;
 650           Bytecodes::length_for(java_code_at(0)) == last_index &amp;&amp;
 651           Bytecodes::is_return(java_code_at(last_index)));
 652 }
 653 
 654 bool Method::is_initializer() const {
 655   return is_object_initializer() || is_static_initializer();
 656 }
 657 
 658 bool Method::has_valid_initializer_flags() const {
 659   return (is_static() ||
 660           method_holder()-&gt;major_version() &lt; 51);
 661 }
 662 
 663 bool Method::is_static_initializer() const {
 664   // For classfiles version 51 or greater, ensure that the clinit method is
 665   // static.  Non-static methods with the name &quot;&lt;clinit&gt;&quot; are not static
 666   // initializers. (older classfiles exempted for backward compatibility)
 667   return name() == vmSymbols::class_initializer_name() &amp;&amp;
 668          has_valid_initializer_flags();
 669 }
 670 
 671 bool Method::is_object_initializer() const {
 672    return name() == vmSymbols::object_initializer_name();
 673 }
 674 
 675 objArrayHandle Method::resolved_checked_exceptions_impl(Method* method, TRAPS) {
 676   int length = method-&gt;checked_exceptions_length();
 677   if (length == 0) {  // common case
 678     return objArrayHandle(THREAD, Universe::the_empty_class_klass_array());
 679   } else {
 680     methodHandle h_this(THREAD, method);
 681     objArrayOop m_oop = oopFactory::new_objArray(SystemDictionary::Class_klass(), length, CHECK_(objArrayHandle()));
 682     objArrayHandle mirrors (THREAD, m_oop);
 683     for (int i = 0; i &lt; length; i++) {
 684       CheckedExceptionElement* table = h_this-&gt;checked_exceptions_start(); // recompute on each iteration, not gc safe
 685       Klass* k = h_this-&gt;constants()-&gt;klass_at(table[i].class_cp_index, CHECK_(objArrayHandle()));
 686       assert(k-&gt;is_subclass_of(SystemDictionary::Throwable_klass()), &quot;invalid exception class&quot;);
 687       mirrors-&gt;obj_at_put(i, k-&gt;java_mirror());
 688     }
 689     return mirrors;
 690   }
 691 };
 692 
 693 
 694 int Method::line_number_from_bci(int bci) const {
 695   int best_bci  =  0;
 696   int best_line = -1;
 697   if (bci == SynchronizationEntryBCI) bci = 0;
 698   if (0 &lt;= bci &amp;&amp; bci &lt; code_size() &amp;&amp; has_linenumber_table()) {
 699     // The line numbers are a short array of 2-tuples [start_pc, line_number].
 700     // Not necessarily sorted and not necessarily one-to-one.
 701     CompressedLineNumberReadStream stream(compressed_linenumber_table());
 702     while (stream.read_pair()) {
 703       if (stream.bci() == bci) {
 704         // perfect match
 705         return stream.line();
 706       } else {
 707         // update best_bci/line
 708         if (stream.bci() &lt; bci &amp;&amp; stream.bci() &gt;= best_bci) {
 709           best_bci  = stream.bci();
 710           best_line = stream.line();
 711         }
 712       }
 713     }
 714   }
 715   return best_line;
 716 }
 717 
 718 
 719 bool Method::is_klass_loaded_by_klass_index(int klass_index) const {
 720   if( constants()-&gt;tag_at(klass_index).is_unresolved_klass() ) {
 721     Thread *thread = Thread::current();
 722     Symbol* klass_name = constants()-&gt;klass_name_at(klass_index);
 723     Handle loader(thread, method_holder()-&gt;class_loader());
 724     Handle prot  (thread, method_holder()-&gt;protection_domain());
 725     return SystemDictionary::find(klass_name, loader, prot, thread) != NULL;
 726   } else {
 727     return true;
 728   }
 729 }
 730 
 731 
 732 bool Method::is_klass_loaded(int refinfo_index, bool must_be_resolved) const {
 733   int klass_index = constants()-&gt;klass_ref_index_at(refinfo_index);
 734   if (must_be_resolved) {
 735     // Make sure klass is resolved in constantpool.
 736     if (constants()-&gt;tag_at(klass_index).is_unresolved_klass()) return false;
 737   }
 738   return is_klass_loaded_by_klass_index(klass_index);
 739 }
 740 
 741 
 742 void Method::set_native_function(address function, bool post_event_flag) {
 743   assert(function != NULL, &quot;use clear_native_function to unregister natives&quot;);
 744   assert(!is_method_handle_intrinsic() || function == SharedRuntime::native_method_throw_unsatisfied_link_error_entry(), &quot;&quot;);
 745   address* native_function = native_function_addr();
 746 
 747   // We can see racers trying to place the same native function into place. Once
 748   // is plenty.
 749   address current = *native_function;
 750   if (current == function) return;
 751   if (post_event_flag &amp;&amp; JvmtiExport::should_post_native_method_bind() &amp;&amp;
 752       function != NULL) {
 753     // native_method_throw_unsatisfied_link_error_entry() should only
 754     // be passed when post_event_flag is false.
 755     assert(function !=
 756       SharedRuntime::native_method_throw_unsatisfied_link_error_entry(),
 757       &quot;post_event_flag mis-match&quot;);
 758 
 759     // post the bind event, and possible change the bind function
 760     JvmtiExport::post_native_method_bind(this, &amp;function);
 761   }
 762   *native_function = function;
 763   // This function can be called more than once. We must make sure that we always
 764   // use the latest registered method -&gt; check if a stub already has been generated.
 765   // If so, we have to make it not_entrant.
 766   CompiledMethod* nm = code(); // Put it into local variable to guard against concurrent updates
 767   if (nm != NULL) {
 768     nm-&gt;make_not_entrant();
 769   }
 770 }
 771 
 772 
 773 bool Method::has_native_function() const {
 774   if (is_method_handle_intrinsic())
 775     return false;  // special-cased in SharedRuntime::generate_native_wrapper
 776   address func = native_function();
 777   return (func != NULL &amp;&amp; func != SharedRuntime::native_method_throw_unsatisfied_link_error_entry());
 778 }
 779 
 780 
 781 void Method::clear_native_function() {
 782   // Note: is_method_handle_intrinsic() is allowed here.
 783   set_native_function(
 784     SharedRuntime::native_method_throw_unsatisfied_link_error_entry(),
 785     !native_bind_event_is_interesting);
 786   clear_code();
 787 }
 788 
 789 address Method::critical_native_function() {
 790   methodHandle mh(this);
 791   return NativeLookup::lookup_critical_entry(mh);
 792 }
 793 
 794 
 795 void Method::set_signature_handler(address handler) {
 796   address* signature_handler =  signature_handler_addr();
 797   *signature_handler = handler;
 798 }
 799 
 800 
 801 void Method::print_made_not_compilable(int comp_level, bool is_osr, bool report, const char* reason) {
 802   if (PrintCompilation &amp;&amp; report) {
 803     ttyLocker ttyl;
 804     tty-&gt;print(&quot;made not %scompilable on &quot;, is_osr ? &quot;OSR &quot; : &quot;&quot;);
 805     if (comp_level == CompLevel_all) {
 806       tty-&gt;print(&quot;all levels &quot;);
 807     } else {
 808       tty-&gt;print(&quot;levels &quot;);
 809       for (int i = (int)CompLevel_none; i &lt;= comp_level; i++) {
 810         tty-&gt;print(&quot;%d &quot;, i);
 811       }
 812     }
 813     this-&gt;print_short_name(tty);
 814     int size = this-&gt;code_size();
 815     if (size &gt; 0) {
 816       tty-&gt;print(&quot; (%d bytes)&quot;, size);
 817     }
 818     if (reason != NULL) {
 819       tty-&gt;print(&quot;   %s&quot;, reason);
 820     }
 821     tty-&gt;cr();
 822   }
 823   if ((TraceDeoptimization || LogCompilation) &amp;&amp; (xtty != NULL)) {
 824     ttyLocker ttyl;
 825     xtty-&gt;begin_elem(&quot;make_not_compilable thread=&#39;&quot; UINTX_FORMAT &quot;&#39; osr=&#39;%d&#39; level=&#39;%d&#39;&quot;,
 826                      os::current_thread_id(), is_osr, comp_level);
 827     if (reason != NULL) {
 828       xtty-&gt;print(&quot; reason=\&#39;%s\&#39;&quot;, reason);
 829     }
 830     xtty-&gt;method(this);
 831     xtty-&gt;stamp();
 832     xtty-&gt;end_elem();
 833   }
 834 }
 835 
 836 bool Method::is_always_compilable() const {
 837   // Generated adapters must be compiled
 838   if (is_method_handle_intrinsic() &amp;&amp; is_synthetic()) {
 839     assert(!is_not_c1_compilable(), &quot;sanity check&quot;);
 840     assert(!is_not_c2_compilable(), &quot;sanity check&quot;);
 841     return true;
 842   }
 843 
 844   return false;
 845 }
 846 
 847 bool Method::is_not_compilable(int comp_level) const {
 848   if (number_of_breakpoints() &gt; 0)
 849     return true;
 850   if (is_always_compilable())
 851     return false;
 852   if (comp_level == CompLevel_any)
 853     return is_not_c1_compilable() || is_not_c2_compilable();
 854   if (is_c1_compile(comp_level))
 855     return is_not_c1_compilable();
 856   if (is_c2_compile(comp_level))
 857     return is_not_c2_compilable();
 858   return false;
 859 }
 860 
 861 // call this when compiler finds that this method is not compilable
 862 void Method::set_not_compilable(int comp_level, bool report, const char* reason) {
 863   if (is_always_compilable()) {
 864     // Don&#39;t mark a method which should be always compilable
 865     return;
 866   }
 867   print_made_not_compilable(comp_level, /*is_osr*/ false, report, reason);
 868   if (comp_level == CompLevel_all) {
 869     set_not_c1_compilable();
 870     set_not_c2_compilable();
 871   } else {
 872     if (is_c1_compile(comp_level))
 873       set_not_c1_compilable();
 874     if (is_c2_compile(comp_level))
 875       set_not_c2_compilable();
 876   }
 877   CompilationPolicy::policy()-&gt;disable_compilation(this);
 878   assert(!CompilationPolicy::can_be_compiled(this, comp_level), &quot;sanity check&quot;);
 879 }
 880 
 881 bool Method::is_not_osr_compilable(int comp_level) const {
 882   if (is_not_compilable(comp_level))
 883     return true;
 884   if (comp_level == CompLevel_any)
 885     return is_not_c1_osr_compilable() || is_not_c2_osr_compilable();
 886   if (is_c1_compile(comp_level))
 887     return is_not_c1_osr_compilable();
 888   if (is_c2_compile(comp_level))
 889     return is_not_c2_osr_compilable();
 890   return false;
 891 }
 892 
 893 void Method::set_not_osr_compilable(int comp_level, bool report, const char* reason) {
 894   print_made_not_compilable(comp_level, /*is_osr*/ true, report, reason);
 895   if (comp_level == CompLevel_all) {
 896     set_not_c1_osr_compilable();
 897     set_not_c2_osr_compilable();
 898   } else {
 899     if (is_c1_compile(comp_level))
 900       set_not_c1_osr_compilable();
 901     if (is_c2_compile(comp_level))
 902       set_not_c2_osr_compilable();
 903   }
 904   CompilationPolicy::policy()-&gt;disable_compilation(this);
 905   assert(!CompilationPolicy::can_be_osr_compiled(this, comp_level), &quot;sanity check&quot;);
 906 }
 907 
 908 // Revert to using the interpreter and clear out the nmethod
 909 void Method::clear_code(bool acquire_lock /* = true */) {
 910   MutexLockerEx pl(acquire_lock ? Patching_lock : NULL, Mutex::_no_safepoint_check_flag);
 911   // this may be NULL if c2i adapters have not been made yet
 912   // Only should happen at allocate time.
 913   if (adapter() == NULL) {
 914     _from_compiled_entry    = NULL;
 915   } else {
 916     _from_compiled_entry    = adapter()-&gt;get_c2i_entry();
 917   }
 918   OrderAccess::storestore();
 919   _from_interpreted_entry = _i2i_entry;
 920   OrderAccess::storestore();
 921   _code = NULL;
 922 }
 923 
 924 #if INCLUDE_CDS
 925 // Called by class data sharing to remove any entry points (which are not shared)
 926 void Method::unlink_method() {
 927   _code = NULL;
 928 
 929   assert(DumpSharedSpaces, &quot;dump time only&quot;);
 930   // Set the values to what they should be at run time. Note that
 931   // this Method can no longer be executed during dump time.
 932   _i2i_entry = Interpreter::entry_for_cds_method(this);
 933   _from_interpreted_entry = _i2i_entry;
 934 
 935   if (is_native()) {
 936     *native_function_addr() = NULL;
 937     set_signature_handler(NULL);
 938   }
 939   NOT_PRODUCT(set_compiled_invocation_count(0);)
 940 
 941   CDSAdapterHandlerEntry* cds_adapter = (CDSAdapterHandlerEntry*)adapter();
 942   constMethod()-&gt;set_adapter_trampoline(cds_adapter-&gt;get_adapter_trampoline());
 943   _from_compiled_entry = cds_adapter-&gt;get_c2i_entry_trampoline();
 944   assert(*((int*)_from_compiled_entry) == 0, &quot;must be NULL during dump time, to be initialized at run time&quot;);
 945 
 946   set_method_data(NULL);
 947   clear_method_counters();
 948 }
 949 #endif
 950 
 951 /****************************************************************************
 952 // The following illustrates how the entries work for CDS shared Methods:
 953 //
 954 // Our goal is to delay writing into a shared Method until it&#39;s compiled.
 955 // Hence, we want to determine the initial values for _i2i_entry,
 956 // _from_interpreted_entry and _from_compiled_entry during CDS dump time.
 957 //
 958 // In this example, both Methods A and B have the _i2i_entry of &quot;zero_locals&quot;.
 959 // They also have similar signatures so that they will share the same
 960 // AdapterHandlerEntry.
 961 //
 962 // _adapter_trampoline points to a fixed location in the RW section of
 963 // the CDS archive. This location initially contains a NULL pointer. When the
 964 // first of method A or B is linked, an AdapterHandlerEntry is allocated
 965 // dynamically, and its c2i/i2c entries are generated.
 966 //
 967 // _i2i_entry and _from_interpreted_entry initially points to the same
 968 // (fixed) location in the CODE section of the CDS archive. This contains
 969 // an unconditional branch to the actual entry for &quot;zero_locals&quot;, which is
 970 // generated at run time and may be on an arbitrary address. Thus, the
 971 // unconditional branch is also generated at run time to jump to the correct
 972 // address.
 973 //
 974 // Similarly, _from_compiled_entry points to a fixed address in the CODE
 975 // section. This address has enough space for an unconditional branch
 976 // instruction, and is initially zero-filled. After the AdapterHandlerEntry is
 977 // initialized, and the address for the actual c2i_entry is known, we emit a
 978 // branch instruction here to branch to the actual c2i_entry.
 979 //
 980 // The effect of the extra branch on the i2i and c2i entries is negligible.
 981 //
 982 // The reason for putting _adapter_trampoline in RO is many shared Methods
 983 // share the same AdapterHandlerEntry, so we can save space in the RW section
 984 // by having the extra indirection.
 985 
 986 
 987 [Method A: RW]
 988   _constMethod ----&gt; [ConstMethod: RO]
 989                        _adapter_trampoline -----------+
 990                                                       |
 991   _i2i_entry              (same value as method B)    |
 992   _from_interpreted_entry (same value as method B)    |
 993   _from_compiled_entry    (same value as method B)    |
 994                                                       |
 995                                                       |
 996 [Method B: RW]                               +--------+
 997   _constMethod ----&gt; [ConstMethod: RO]       |
 998                        _adapter_trampoline --+---&gt;(AdapterHandlerEntry* ptr: RW)-+
 999                                                                                  |
1000                                                  +-------------------------------+
1001                                                  |
1002                                                  +----&gt; [AdapterHandlerEntry] (allocated at run time)
1003                                                               _fingerprint
1004                                                               _c2i_entry ---------------------------------+-&gt;[c2i entry..]
1005  _i2i_entry  -------------+                                   _i2c_entry ---------------+-&gt; [i2c entry..] |
1006  _from_interpreted_entry  |                                   _c2i_unverified_entry     |                 |
1007          |                |                                                             |                 |
1008          |                |  (_cds_entry_table: CODE)                                   |                 |
1009          |                +-&gt;[0]: jmp _entry_table[0] --&gt; (i2i_entry_for &quot;zero_locals&quot;) |                 |
1010          |                |                               (allocated at run time)       |                 |
1011          |                |  ...                           [asm code ...]               |                 |
1012          +-[not compiled]-+  [n]: jmp _entry_table[n]                                   |                 |
1013          |                                                                              |                 |
1014          |                                                                              |                 |
1015          +-[compiled]-------------------------------------------------------------------+                 |
1016                                                                                                           |
1017  _from_compiled_entry------------&gt;  (_c2i_entry_trampoline: CODE)                                         |
1018                                     [jmp c2i_entry] ------------------------------------------------------+
1019 
1020 ***/
1021 
1022 // Called when the method_holder is getting linked. Setup entrypoints so the method
1023 // is ready to be called from interpreter, compiler, and vtables.
1024 void Method::link_method(const methodHandle&amp; h_method, TRAPS) {
1025   // If the code cache is full, we may reenter this function for the
1026   // leftover methods that weren&#39;t linked.
1027   if (is_shared()) {
1028     address entry = Interpreter::entry_for_cds_method(h_method);
1029     assert(entry != NULL &amp;&amp; entry == _i2i_entry,
1030            &quot;should be correctly set during dump time&quot;);
1031     if (adapter() != NULL) {
1032       return;
1033     }
1034     assert(entry == _from_interpreted_entry,
1035            &quot;should be correctly set during dump time&quot;);
1036   } else if (_i2i_entry != NULL) {
1037     return;
1038   }
1039   assert( _code == NULL, &quot;nothing compiled yet&quot; );
1040 
1041   // Setup interpreter entrypoint
1042   assert(this == h_method(), &quot;wrong h_method()&quot; );
1043 
1044   if (!is_shared()) {
1045     assert(adapter() == NULL, &quot;init&#39;d to NULL&quot;);
1046     address entry = Interpreter::entry_for_method(h_method);
1047     assert(entry != NULL, &quot;interpreter entry must be non-null&quot;);
1048     // Sets both _i2i_entry and _from_interpreted_entry
1049     set_interpreter_entry(entry);
1050   }
1051 
1052   // Don&#39;t overwrite already registered native entries.
1053   if (is_native() &amp;&amp; !has_native_function()) {
1054     set_native_function(
1055       SharedRuntime::native_method_throw_unsatisfied_link_error_entry(),
1056       !native_bind_event_is_interesting);
1057   }
1058 
1059   // Setup compiler entrypoint.  This is made eagerly, so we do not need
1060   // special handling of vtables.  An alternative is to make adapters more
1061   // lazily by calling make_adapter() from from_compiled_entry() for the
1062   // normal calls.  For vtable calls life gets more complicated.  When a
1063   // call-site goes mega-morphic we need adapters in all methods which can be
1064   // called from the vtable.  We need adapters on such methods that get loaded
1065   // later.  Ditto for mega-morphic itable calls.  If this proves to be a
1066   // problem we&#39;ll make these lazily later.
1067   (void) make_adapters(h_method, CHECK);
1068 
1069   // ONLY USE the h_method now as make_adapter may have blocked
1070 
1071 }
1072 
1073 address Method::make_adapters(const methodHandle&amp; mh, TRAPS) {
1074   // Adapters for compiled code are made eagerly here.  They are fairly
1075   // small (generally &lt; 100 bytes) and quick to make (and cached and shared)
1076   // so making them eagerly shouldn&#39;t be too expensive.
1077   AdapterHandlerEntry* adapter = AdapterHandlerLibrary::get_adapter(mh);
1078   if (adapter == NULL ) {
1079     if (!is_init_completed()) {
1080       // Don&#39;t throw exceptions during VM initialization because java.lang.* classes
1081       // might not have been initialized, causing problems when constructing the
1082       // Java exception object.
1083       vm_exit_during_initialization(&quot;Out of space in CodeCache for adapters&quot;);
1084     } else {
1085       THROW_MSG_NULL(vmSymbols::java_lang_VirtualMachineError(), &quot;Out of space in CodeCache for adapters&quot;);
1086     }
1087   }
1088 
1089   if (mh-&gt;is_shared()) {
1090     assert(mh-&gt;adapter() == adapter, &quot;must be&quot;);
1091     assert(mh-&gt;_from_compiled_entry != NULL, &quot;must be&quot;);
1092   } else {
1093     mh-&gt;set_adapter_entry(adapter);
1094     mh-&gt;_from_compiled_entry = adapter-&gt;get_c2i_entry();
1095   }
1096   return adapter-&gt;get_c2i_entry();
1097 }
1098 
1099 void Method::restore_unshareable_info(TRAPS) {
1100   assert(is_method() &amp;&amp; is_valid_method(this), &quot;ensure C++ vtable is restored&quot;);
1101 
1102   // Since restore_unshareable_info can be called more than once for a method, don&#39;t
1103   // redo any work.
1104   if (adapter() == NULL) {
1105     methodHandle mh(THREAD, this);
1106     link_method(mh, CHECK);
1107   }
1108 }
1109 
1110 address Method::from_compiled_entry_no_trampoline() const {
1111   CompiledMethod *code = OrderAccess::load_acquire(&amp;_code);
1112   if (code) {
1113     return code-&gt;verified_entry_point();
1114   } else {
1115     return adapter()-&gt;get_c2i_entry();
1116   }
1117 }
1118 
1119 // The verified_code_entry() must be called when a invoke is resolved
1120 // on this method.
1121 
1122 // It returns the compiled code entry point, after asserting not null.
1123 // This function is called after potential safepoints so that nmethod
1124 // or adapter that it points to is still live and valid.
1125 // This function must not hit a safepoint!
1126 address Method::verified_code_entry() {
1127   debug_only(NoSafepointVerifier nsv;)
1128   assert(_from_compiled_entry != NULL, &quot;must be set&quot;);
1129   return _from_compiled_entry;
1130 }
1131 
1132 // Check that if an nmethod ref exists, it has a backlink to this or no backlink at all
1133 // (could be racing a deopt).
1134 // Not inline to avoid circular ref.
1135 bool Method::check_code() const {
1136   // cached in a register or local.  There&#39;s a race on the value of the field.
1137   CompiledMethod *code = OrderAccess::load_acquire(&amp;_code);
1138   return code == NULL || (code-&gt;method() == NULL) || (code-&gt;method() == (Method*)this &amp;&amp; !code-&gt;is_osr_method());
1139 }
1140 
1141 // Install compiled code.  Instantly it can execute.
1142 void Method::set_code(const methodHandle&amp; mh, CompiledMethod *code) {
1143   MutexLockerEx pl(Patching_lock, Mutex::_no_safepoint_check_flag);
1144   assert( code, &quot;use clear_code to remove code&quot; );
1145   assert( mh-&gt;check_code(), &quot;&quot; );
1146 
1147   guarantee(mh-&gt;adapter() != NULL, &quot;Adapter blob must already exist!&quot;);
1148 
1149   // These writes must happen in this order, because the interpreter will
1150   // directly jump to from_interpreted_entry which jumps to an i2c adapter
1151   // which jumps to _from_compiled_entry.
1152   mh-&gt;_code = code;             // Assign before allowing compiled code to exec
1153 
1154   int comp_level = code-&gt;comp_level();
1155   // In theory there could be a race here. In practice it is unlikely
1156   // and not worth worrying about.
1157   if (comp_level &gt; mh-&gt;highest_comp_level()) {
1158     mh-&gt;set_highest_comp_level(comp_level);
1159   }
1160 
1161   OrderAccess::storestore();
1162   mh-&gt;_from_compiled_entry = code-&gt;verified_entry_point();
1163   OrderAccess::storestore();
1164   // Instantly compiled code can execute.
1165   if (!mh-&gt;is_method_handle_intrinsic())
1166     mh-&gt;_from_interpreted_entry = mh-&gt;get_i2c_entry();
1167 }
1168 
1169 
1170 bool Method::is_overridden_in(Klass* k) const {
1171   InstanceKlass* ik = InstanceKlass::cast(k);
1172 
1173   if (ik-&gt;is_interface()) return false;
1174 
1175   // If method is an interface, we skip it - except if it
1176   // is a miranda method
1177   if (method_holder()-&gt;is_interface()) {
1178     // Check that method is not a miranda method
1179     if (ik-&gt;lookup_method(name(), signature()) == NULL) {
1180       // No implementation exist - so miranda method
1181       return false;
1182     }
1183     return true;
1184   }
1185 
1186   assert(ik-&gt;is_subclass_of(method_holder()), &quot;should be subklass&quot;);
1187   if (!has_vtable_index()) {
1188     return false;
1189   } else {
1190     Method* vt_m = ik-&gt;method_at_vtable(vtable_index());
1191     return vt_m != this;
1192   }
1193 }
1194 
1195 
1196 // give advice about whether this Method* should be cached or not
1197 bool Method::should_not_be_cached() const {
1198   if (is_old()) {
1199     // This method has been redefined. It is either EMCP or obsolete
1200     // and we don&#39;t want to cache it because that would pin the method
1201     // down and prevent it from being collectible if and when it
1202     // finishes executing.
1203     return true;
1204   }
1205 
1206   // caching this method should be just fine
1207   return false;
1208 }
1209 
1210 
1211 /**
1212  *  Returns true if this is one of the specially treated methods for
1213  *  security related stack walks (like Reflection.getCallerClass).
1214  */
1215 bool Method::is_ignored_by_security_stack_walk() const {
1216   if (intrinsic_id() == vmIntrinsics::_invoke) {
1217     // This is Method.invoke() -- ignore it
1218     return true;
1219   }
1220   if (method_holder()-&gt;is_subclass_of(SystemDictionary::reflect_MethodAccessorImpl_klass())) {
1221     // This is an auxilary frame -- ignore it
1222     return true;
1223   }
1224   if (is_method_handle_intrinsic() || is_compiled_lambda_form()) {
1225     // This is an internal adapter frame for method handles -- ignore it
1226     return true;
1227   }
1228   return false;
1229 }
1230 
1231 
1232 // Constant pool structure for invoke methods:
1233 enum {
1234   _imcp_invoke_name = 1,        // utf8: &#39;invokeExact&#39;, etc.
1235   _imcp_invoke_signature,       // utf8: (variable Symbol*)
1236   _imcp_limit
1237 };
1238 
1239 // Test if this method is an MH adapter frame generated by Java code.
1240 // Cf. java/lang/invoke/InvokerBytecodeGenerator
1241 bool Method::is_compiled_lambda_form() const {
1242   return intrinsic_id() == vmIntrinsics::_compiledLambdaForm;
1243 }
1244 
1245 // Test if this method is an internal MH primitive method.
1246 bool Method::is_method_handle_intrinsic() const {
1247   vmIntrinsics::ID iid = intrinsic_id();
1248   return (MethodHandles::is_signature_polymorphic(iid) &amp;&amp;
1249           MethodHandles::is_signature_polymorphic_intrinsic(iid));
1250 }
1251 
1252 bool Method::has_member_arg() const {
1253   vmIntrinsics::ID iid = intrinsic_id();
1254   return (MethodHandles::is_signature_polymorphic(iid) &amp;&amp;
1255           MethodHandles::has_member_arg(iid));
1256 }
1257 
1258 // Make an instance of a signature-polymorphic internal MH primitive.
1259 methodHandle Method::make_method_handle_intrinsic(vmIntrinsics::ID iid,
1260                                                          Symbol* signature,
1261                                                          TRAPS) {
1262   ResourceMark rm;
1263   methodHandle empty;
1264 
1265   InstanceKlass* holder = SystemDictionary::MethodHandle_klass();
1266   Symbol* name = MethodHandles::signature_polymorphic_intrinsic_name(iid);
1267   assert(iid == MethodHandles::signature_polymorphic_name_id(name), &quot;&quot;);
1268   if (TraceMethodHandles) {
1269     tty-&gt;print_cr(&quot;make_method_handle_intrinsic MH.%s%s&quot;, name-&gt;as_C_string(), signature-&gt;as_C_string());
1270   }
1271 
1272   // invariant:   cp-&gt;symbol_at_put is preceded by a refcount increment (more usually a lookup)
1273   name-&gt;increment_refcount();
1274   signature-&gt;increment_refcount();
1275 
1276   int cp_length = _imcp_limit;
1277   ClassLoaderData* loader_data = holder-&gt;class_loader_data();
1278   constantPoolHandle cp;
1279   {
1280     ConstantPool* cp_oop = ConstantPool::allocate(loader_data, cp_length, CHECK_(empty));
1281     cp = constantPoolHandle(THREAD, cp_oop);
1282   }
1283   cp-&gt;set_pool_holder(holder);
1284   cp-&gt;symbol_at_put(_imcp_invoke_name,       name);
1285   cp-&gt;symbol_at_put(_imcp_invoke_signature,  signature);
1286   cp-&gt;set_has_preresolution();
1287 
1288   // decide on access bits:  public or not?
1289   int flags_bits = (JVM_ACC_NATIVE | JVM_ACC_SYNTHETIC | JVM_ACC_FINAL);
1290   bool must_be_static = MethodHandles::is_signature_polymorphic_static(iid);
1291   if (must_be_static)  flags_bits |= JVM_ACC_STATIC;
1292   assert((flags_bits &amp; JVM_ACC_PUBLIC) == 0, &quot;do not expose these methods&quot;);
1293 
1294   methodHandle m;
1295   {
1296     InlineTableSizes sizes;
1297     Method* m_oop = Method::allocate(loader_data, 0,
1298                                      accessFlags_from(flags_bits), &amp;sizes,
1299                                      ConstMethod::NORMAL, CHECK_(empty));
1300     m = methodHandle(THREAD, m_oop);
1301   }
1302   m-&gt;set_constants(cp());
1303   m-&gt;set_name_index(_imcp_invoke_name);
1304   m-&gt;set_signature_index(_imcp_invoke_signature);
1305   assert(MethodHandles::is_signature_polymorphic_name(m-&gt;name()), &quot;&quot;);
1306   assert(m-&gt;signature() == signature, &quot;&quot;);
1307   ResultTypeFinder rtf(signature);
1308   m-&gt;constMethod()-&gt;set_result_type(rtf.type());
1309   m-&gt;compute_size_of_parameters(THREAD);
1310   m-&gt;init_intrinsic_id();
1311   assert(m-&gt;is_method_handle_intrinsic(), &quot;&quot;);
1312 #ifdef ASSERT
1313   if (!MethodHandles::is_signature_polymorphic(m-&gt;intrinsic_id()))  m-&gt;print();
1314   assert(MethodHandles::is_signature_polymorphic(m-&gt;intrinsic_id()), &quot;must be an invoker&quot;);
1315   assert(m-&gt;intrinsic_id() == iid, &quot;correctly predicted iid&quot;);
1316 #endif //ASSERT
1317 
1318   // Finally, set up its entry points.
1319   assert(m-&gt;can_be_statically_bound(), &quot;&quot;);
1320   m-&gt;set_vtable_index(Method::nonvirtual_vtable_index);
1321   m-&gt;link_method(m, CHECK_(empty));
1322 
1323   if (TraceMethodHandles &amp;&amp; (Verbose || WizardMode)) {
1324     ttyLocker ttyl;
1325     m-&gt;print_on(tty);
1326   }
1327 
1328   return m;
1329 }
1330 
1331 Klass* Method::check_non_bcp_klass(Klass* klass) {
1332   if (klass != NULL &amp;&amp; klass-&gt;class_loader() != NULL) {
1333     if (klass-&gt;is_objArray_klass())
1334       klass = ObjArrayKlass::cast(klass)-&gt;bottom_klass();
1335     return klass;
1336   }
1337   return NULL;
1338 }
1339 
1340 
1341 methodHandle Method::clone_with_new_data(const methodHandle&amp; m, u_char* new_code, int new_code_length,
1342                                                 u_char* new_compressed_linenumber_table, int new_compressed_linenumber_size, TRAPS) {
1343   // Code below does not work for native methods - they should never get rewritten anyway
1344   assert(!m-&gt;is_native(), &quot;cannot rewrite native methods&quot;);
1345   // Allocate new Method*
1346   AccessFlags flags = m-&gt;access_flags();
1347 
1348   ConstMethod* cm = m-&gt;constMethod();
1349   int checked_exceptions_len = cm-&gt;checked_exceptions_length();
1350   int localvariable_len = cm-&gt;localvariable_table_length();
1351   int exception_table_len = cm-&gt;exception_table_length();
1352   int method_parameters_len = cm-&gt;method_parameters_length();
1353   int method_annotations_len = cm-&gt;method_annotations_length();
1354   int parameter_annotations_len = cm-&gt;parameter_annotations_length();
1355   int type_annotations_len = cm-&gt;type_annotations_length();
1356   int default_annotations_len = cm-&gt;default_annotations_length();
1357 
1358   InlineTableSizes sizes(
1359       localvariable_len,
1360       new_compressed_linenumber_size,
1361       exception_table_len,
1362       checked_exceptions_len,
1363       method_parameters_len,
1364       cm-&gt;generic_signature_index(),
1365       method_annotations_len,
1366       parameter_annotations_len,
1367       type_annotations_len,
1368       default_annotations_len,
1369       0);
1370 
1371   ClassLoaderData* loader_data = m-&gt;method_holder()-&gt;class_loader_data();
1372   Method* newm_oop = Method::allocate(loader_data,
1373                                       new_code_length,
1374                                       flags,
1375                                       &amp;sizes,
1376                                       m-&gt;method_type(),
1377                                       CHECK_(methodHandle()));
1378   methodHandle newm (THREAD, newm_oop);
1379 
1380   // Create a shallow copy of Method part, but be careful to preserve the new ConstMethod*
1381   ConstMethod* newcm = newm-&gt;constMethod();
1382   int new_const_method_size = newm-&gt;constMethod()-&gt;size();
1383 
1384   // This works because the source and target are both Methods. Some compilers
1385   // (e.g., clang) complain that the target vtable pointer will be stomped,
1386   // so cast away newm()&#39;s and m()&#39;s Methodness.
1387   memcpy((void*)newm(), (void*)m(), sizeof(Method));
1388 
1389   // Create shallow copy of ConstMethod.
1390   memcpy(newcm, m-&gt;constMethod(), sizeof(ConstMethod));
1391 
1392   // Reset correct method/const method, method size, and parameter info
1393   newm-&gt;set_constMethod(newcm);
1394   newm-&gt;constMethod()-&gt;set_code_size(new_code_length);
1395   newm-&gt;constMethod()-&gt;set_constMethod_size(new_const_method_size);
1396   assert(newm-&gt;code_size() == new_code_length, &quot;check&quot;);
1397   assert(newm-&gt;method_parameters_length() == method_parameters_len, &quot;check&quot;);
1398   assert(newm-&gt;checked_exceptions_length() == checked_exceptions_len, &quot;check&quot;);
1399   assert(newm-&gt;exception_table_length() == exception_table_len, &quot;check&quot;);
1400   assert(newm-&gt;localvariable_table_length() == localvariable_len, &quot;check&quot;);
1401   // Copy new byte codes
1402   memcpy(newm-&gt;code_base(), new_code, new_code_length);
1403   // Copy line number table
1404   if (new_compressed_linenumber_size &gt; 0) {
1405     memcpy(newm-&gt;compressed_linenumber_table(),
1406            new_compressed_linenumber_table,
1407            new_compressed_linenumber_size);
1408   }
1409   // Copy method_parameters
1410   if (method_parameters_len &gt; 0) {
1411     memcpy(newm-&gt;method_parameters_start(),
1412            m-&gt;method_parameters_start(),
1413            method_parameters_len * sizeof(MethodParametersElement));
1414   }
1415   // Copy checked_exceptions
1416   if (checked_exceptions_len &gt; 0) {
1417     memcpy(newm-&gt;checked_exceptions_start(),
1418            m-&gt;checked_exceptions_start(),
1419            checked_exceptions_len * sizeof(CheckedExceptionElement));
1420   }
1421   // Copy exception table
1422   if (exception_table_len &gt; 0) {
1423     memcpy(newm-&gt;exception_table_start(),
1424            m-&gt;exception_table_start(),
1425            exception_table_len * sizeof(ExceptionTableElement));
1426   }
1427   // Copy local variable number table
1428   if (localvariable_len &gt; 0) {
1429     memcpy(newm-&gt;localvariable_table_start(),
1430            m-&gt;localvariable_table_start(),
1431            localvariable_len * sizeof(LocalVariableTableElement));
1432   }
1433   // Copy stackmap table
1434   if (m-&gt;has_stackmap_table()) {
1435     int code_attribute_length = m-&gt;stackmap_data()-&gt;length();
1436     Array&lt;u1&gt;* stackmap_data =
1437       MetadataFactory::new_array&lt;u1&gt;(loader_data, code_attribute_length, 0, CHECK_NULL);
1438     memcpy((void*)stackmap_data-&gt;adr_at(0),
1439            (void*)m-&gt;stackmap_data()-&gt;adr_at(0), code_attribute_length);
1440     newm-&gt;set_stackmap_data(stackmap_data);
1441   }
1442 
1443   // copy annotations over to new method
1444   newcm-&gt;copy_annotations_from(loader_data, cm, CHECK_NULL);
1445   return newm;
1446 }
1447 
1448 vmSymbols::SID Method::klass_id_for_intrinsics(const Klass* holder) {
1449   // if loader is not the default loader (i.e., != NULL), we can&#39;t know the intrinsics
1450   // because we are not loading from core libraries
1451   // exception: the AES intrinsics come from lib/ext/sunjce_provider.jar
1452   // which does not use the class default class loader so we check for its loader here
1453   const InstanceKlass* ik = InstanceKlass::cast(holder);
1454   if ((ik-&gt;class_loader() != NULL) &amp;&amp; !SystemDictionary::is_platform_class_loader(ik-&gt;class_loader())) {
1455     return vmSymbols::NO_SID;   // regardless of name, no intrinsics here
1456   }
1457 
1458   // see if the klass name is well-known:
1459   Symbol* klass_name = ik-&gt;name();
1460   return vmSymbols::find_sid(klass_name);
1461 }
1462 
1463 void Method::init_intrinsic_id() {
1464   assert(_intrinsic_id == vmIntrinsics::_none, &quot;do this just once&quot;);
1465   const uintptr_t max_id_uint = right_n_bits((int)(sizeof(_intrinsic_id) * BitsPerByte));
1466   assert((uintptr_t)vmIntrinsics::ID_LIMIT &lt;= max_id_uint, &quot;else fix size&quot;);
1467   assert(intrinsic_id_size_in_bytes() == sizeof(_intrinsic_id), &quot;&quot;);
1468 
1469   // the klass name is well-known:
1470   vmSymbols::SID klass_id = klass_id_for_intrinsics(method_holder());
1471   assert(klass_id != vmSymbols::NO_SID, &quot;caller responsibility&quot;);
1472 
1473   // ditto for method and signature:
1474   vmSymbols::SID  name_id = vmSymbols::find_sid(name());
1475   if (klass_id != vmSymbols::VM_SYMBOL_ENUM_NAME(java_lang_invoke_MethodHandle)
1476       &amp;&amp; klass_id != vmSymbols::VM_SYMBOL_ENUM_NAME(java_lang_invoke_VarHandle)
1477       &amp;&amp; name_id == vmSymbols::NO_SID) {
1478     return;
1479   }
1480   vmSymbols::SID   sig_id = vmSymbols::find_sid(signature());
1481   if (klass_id != vmSymbols::VM_SYMBOL_ENUM_NAME(java_lang_invoke_MethodHandle)
1482       &amp;&amp; klass_id != vmSymbols::VM_SYMBOL_ENUM_NAME(java_lang_invoke_VarHandle)
1483       &amp;&amp; sig_id == vmSymbols::NO_SID) {
1484     return;
1485   }
1486   jshort flags = access_flags().as_short();
1487 
1488   vmIntrinsics::ID id = vmIntrinsics::find_id(klass_id, name_id, sig_id, flags);
1489   if (id != vmIntrinsics::_none) {
1490     set_intrinsic_id(id);
1491     if (id == vmIntrinsics::_Class_cast) {
1492       // Even if the intrinsic is rejected, we want to inline this simple method.
1493       set_force_inline(true);
1494     }
1495     return;
1496   }
1497 
1498   // A few slightly irregular cases:
1499   switch (klass_id) {
1500   case vmSymbols::VM_SYMBOL_ENUM_NAME(java_lang_StrictMath):
1501     // Second chance: check in regular Math.
1502     switch (name_id) {
1503     case vmSymbols::VM_SYMBOL_ENUM_NAME(min_name):
1504     case vmSymbols::VM_SYMBOL_ENUM_NAME(max_name):
1505     case vmSymbols::VM_SYMBOL_ENUM_NAME(sqrt_name):
1506       // pretend it is the corresponding method in the non-strict class:
1507       klass_id = vmSymbols::VM_SYMBOL_ENUM_NAME(java_lang_Math);
1508       id = vmIntrinsics::find_id(klass_id, name_id, sig_id, flags);
1509       break;
1510     default:
1511       break;
1512     }
1513     break;
1514 
1515   // Signature-polymorphic methods: MethodHandle.invoke*, InvokeDynamic.*., VarHandle
1516   case vmSymbols::VM_SYMBOL_ENUM_NAME(java_lang_invoke_MethodHandle):
1517   case vmSymbols::VM_SYMBOL_ENUM_NAME(java_lang_invoke_VarHandle):
1518     if (!is_native())  break;
1519     id = MethodHandles::signature_polymorphic_name_id(method_holder(), name());
1520     if (is_static() != MethodHandles::is_signature_polymorphic_static(id))
1521       id = vmIntrinsics::_none;
1522     break;
1523 
1524   default:
1525     break;
1526   }
1527 
1528   if (id != vmIntrinsics::_none) {
1529     // Set up its iid.  It is an alias method.
1530     set_intrinsic_id(id);
1531     return;
1532   }
1533 }
1534 
1535 // These two methods are static since a GC may move the Method
1536 bool Method::load_signature_classes(const methodHandle&amp; m, TRAPS) {
1537   if (!THREAD-&gt;can_call_java()) {
1538     // There is nothing useful this routine can do from within the Compile thread.
1539     // Hopefully, the signature contains only well-known classes.
1540     // We could scan for this and return true/false, but the caller won&#39;t care.
1541     return false;
1542   }
1543   bool sig_is_loaded = true;
1544   Handle class_loader(THREAD, m-&gt;method_holder()-&gt;class_loader());
1545   Handle protection_domain(THREAD, m-&gt;method_holder()-&gt;protection_domain());
1546   ResourceMark rm(THREAD);
1547   Symbol*  signature = m-&gt;signature();
1548   for(SignatureStream ss(signature); !ss.is_done(); ss.next()) {
1549     if (ss.is_object()) {
1550       Symbol* sym = ss.as_symbol(CHECK_(false));
1551       Symbol*  name  = sym;
1552       Klass* klass = SystemDictionary::resolve_or_null(name, class_loader,
1553                                              protection_domain, THREAD);
1554       // We are loading classes eagerly. If a ClassNotFoundException or
1555       // a LinkageError was generated, be sure to ignore it.
1556       if (HAS_PENDING_EXCEPTION) {
1557         if (PENDING_EXCEPTION-&gt;is_a(SystemDictionary::ClassNotFoundException_klass()) ||
1558             PENDING_EXCEPTION-&gt;is_a(SystemDictionary::LinkageError_klass())) {
1559           CLEAR_PENDING_EXCEPTION;
1560         } else {
1561           return false;
1562         }
1563       }
1564       if( klass == NULL) { sig_is_loaded = false; }
1565     }
1566   }
1567   return sig_is_loaded;
1568 }
1569 
1570 bool Method::has_unloaded_classes_in_signature(const methodHandle&amp; m, TRAPS) {
1571   Handle class_loader(THREAD, m-&gt;method_holder()-&gt;class_loader());
1572   Handle protection_domain(THREAD, m-&gt;method_holder()-&gt;protection_domain());
1573   ResourceMark rm(THREAD);
1574   Symbol*  signature = m-&gt;signature();
1575   for(SignatureStream ss(signature); !ss.is_done(); ss.next()) {
1576     if (ss.type() == T_OBJECT) {
1577       Symbol* name = ss.as_symbol_or_null();
1578       if (name == NULL) return true;
1579       Klass* klass = SystemDictionary::find(name, class_loader, protection_domain, THREAD);
1580       if (klass == NULL) return true;
1581     }
1582   }
1583   return false;
1584 }
1585 
1586 // Exposed so field engineers can debug VM
1587 void Method::print_short_name(outputStream* st) {
1588   ResourceMark rm;
1589 #ifdef PRODUCT
1590   st-&gt;print(&quot; %s::&quot;, method_holder()-&gt;external_name());
1591 #else
1592   st-&gt;print(&quot; %s::&quot;, method_holder()-&gt;internal_name());
1593 #endif
1594   name()-&gt;print_symbol_on(st);
1595   if (WizardMode) signature()-&gt;print_symbol_on(st);
1596   else if (MethodHandles::is_signature_polymorphic(intrinsic_id()))
1597     MethodHandles::print_as_basic_type_signature_on(st, signature(), true);
1598 }
1599 
1600 // Comparer for sorting an object array containing
1601 // Method*s.
1602 static int method_comparator(Method* a, Method* b) {
1603   return a-&gt;name()-&gt;fast_compare(b-&gt;name());
1604 }
1605 
1606 // This is only done during class loading, so it is OK to assume method_idnum matches the methods() array
1607 // default_methods also uses this without the ordering for fast find_method
1608 void Method::sort_methods(Array&lt;Method*&gt;* methods, bool set_idnums) {
1609   int length = methods-&gt;length();
1610   if (length &gt; 1) {
1611     {
1612       NoSafepointVerifier nsv;
1613       QuickSort::sort(methods-&gt;data(), length, method_comparator, /*idempotent=*/false);
1614     }
1615     // Reset method ordering
1616     if (set_idnums) {
1617       for (int i = 0; i &lt; length; i++) {
1618         Method* m = methods-&gt;at(i);
1619         m-&gt;set_method_idnum(i);
1620         m-&gt;set_orig_method_idnum(i);
1621       }
1622     }
1623   }
1624 }
1625 
1626 //-----------------------------------------------------------------------------------
1627 // Non-product code unless JVM/TI needs it
1628 
1629 #if !defined(PRODUCT) || INCLUDE_JVMTI
1630 class SignatureTypePrinter : public SignatureTypeNames {
1631  private:
1632   outputStream* _st;
1633   bool _use_separator;
1634 
1635   void type_name(const char* name) {
1636     if (_use_separator) _st-&gt;print(&quot;, &quot;);
1637     _st-&gt;print(&quot;%s&quot;, name);
1638     _use_separator = true;
1639   }
1640 
1641  public:
1642   SignatureTypePrinter(Symbol* signature, outputStream* st) : SignatureTypeNames(signature) {
1643     _st = st;
1644     _use_separator = false;
1645   }
1646 
1647   void print_parameters()              { _use_separator = false; iterate_parameters(); }
1648   void print_returntype()              { _use_separator = false; iterate_returntype(); }
1649 };
1650 
1651 
1652 void Method::print_name(outputStream* st) {
1653   Thread *thread = Thread::current();
1654   ResourceMark rm(thread);
1655   st-&gt;print(&quot;%s &quot;, is_static() ? &quot;static&quot; : &quot;virtual&quot;);
1656   if (WizardMode) {
1657     st-&gt;print(&quot;%s.&quot;, method_holder()-&gt;internal_name());
1658     name()-&gt;print_symbol_on(st);
1659     signature()-&gt;print_symbol_on(st);
1660   } else {
1661     SignatureTypePrinter sig(signature(), st);
1662     sig.print_returntype();
1663     st-&gt;print(&quot; %s.&quot;, method_holder()-&gt;internal_name());
1664     name()-&gt;print_symbol_on(st);
1665     st-&gt;print(&quot;(&quot;);
1666     sig.print_parameters();
1667     st-&gt;print(&quot;)&quot;);
1668   }
1669 }
1670 #endif // !PRODUCT || INCLUDE_JVMTI
1671 
1672 
1673 void Method::print_codes_on(outputStream* st) const {
1674   print_codes_on(0, code_size(), st);
1675 }
1676 
1677 void Method::print_codes_on(int from, int to, outputStream* st) const {
1678   Thread *thread = Thread::current();
1679   ResourceMark rm(thread);
1680   methodHandle mh (thread, (Method*)this);
1681   BytecodeStream s(mh);
1682   s.set_interval(from, to);
1683   BytecodeTracer::set_closure(BytecodeTracer::std_closure());
1684   while (s.next() &gt;= 0) BytecodeTracer::trace(mh, s.bcp(), st);
1685 }
1686 
1687 CompressedLineNumberReadStream::CompressedLineNumberReadStream(u_char* buffer) : CompressedReadStream(buffer) {
1688   _bci = 0;
1689   _line = 0;
1690 };
1691 
1692 bool CompressedLineNumberReadStream::read_pair() {
1693   jubyte next = read_byte();
1694   // Check for terminator
1695   if (next == 0) return false;
1696   if (next == 0xFF) {
1697     // Escape character, regular compression used
1698     _bci  += read_signed_int();
1699     _line += read_signed_int();
1700   } else {
1701     // Single byte compression used
1702     _bci  += next &gt;&gt; 3;
1703     _line += next &amp; 0x7;
1704   }
1705   return true;
1706 }
1707 
1708 #if INCLUDE_JVMTI
1709 
1710 Bytecodes::Code Method::orig_bytecode_at(int bci) const {
1711   BreakpointInfo* bp = method_holder()-&gt;breakpoints();
1712   for (; bp != NULL; bp = bp-&gt;next()) {
1713     if (bp-&gt;match(this, bci)) {
1714       return bp-&gt;orig_bytecode();
1715     }
1716   }
1717   {
1718     ResourceMark rm;
1719     fatal(&quot;no original bytecode found in %s at bci %d&quot;, name_and_sig_as_C_string(), bci);
1720   }
1721   return Bytecodes::_shouldnotreachhere;
1722 }
1723 
1724 void Method::set_orig_bytecode_at(int bci, Bytecodes::Code code) {
1725   assert(code != Bytecodes::_breakpoint, &quot;cannot patch breakpoints this way&quot;);
1726   BreakpointInfo* bp = method_holder()-&gt;breakpoints();
1727   for (; bp != NULL; bp = bp-&gt;next()) {
1728     if (bp-&gt;match(this, bci)) {
1729       bp-&gt;set_orig_bytecode(code);
1730       // and continue, in case there is more than one
1731     }
1732   }
1733 }
1734 
1735 void Method::set_breakpoint(int bci) {
1736   InstanceKlass* ik = method_holder();
1737   BreakpointInfo *bp = new BreakpointInfo(this, bci);
1738   bp-&gt;set_next(ik-&gt;breakpoints());
1739   ik-&gt;set_breakpoints(bp);
1740   // do this last:
1741   bp-&gt;set(this);
1742 }
1743 
1744 static void clear_matches(Method* m, int bci) {
1745   InstanceKlass* ik = m-&gt;method_holder();
1746   BreakpointInfo* prev_bp = NULL;
1747   BreakpointInfo* next_bp;
1748   for (BreakpointInfo* bp = ik-&gt;breakpoints(); bp != NULL; bp = next_bp) {
1749     next_bp = bp-&gt;next();
1750     // bci value of -1 is used to delete all breakpoints in method m (ex: clear_all_breakpoint).
1751     if (bci &gt;= 0 ? bp-&gt;match(m, bci) : bp-&gt;match(m)) {
1752       // do this first:
1753       bp-&gt;clear(m);
1754       // unhook it
1755       if (prev_bp != NULL)
1756         prev_bp-&gt;set_next(next_bp);
1757       else
1758         ik-&gt;set_breakpoints(next_bp);
1759       delete bp;
1760       // When class is redefined JVMTI sets breakpoint in all versions of EMCP methods
1761       // at same location. So we have multiple matching (method_index and bci)
1762       // BreakpointInfo nodes in BreakpointInfo list. We should just delete one
1763       // breakpoint for clear_breakpoint request and keep all other method versions
1764       // BreakpointInfo for future clear_breakpoint request.
1765       // bcivalue of -1 is used to clear all breakpoints (see clear_all_breakpoints)
1766       // which is being called when class is unloaded. We delete all the Breakpoint
1767       // information for all versions of method. We may not correctly restore the original
1768       // bytecode in all method versions, but that is ok. Because the class is being unloaded
1769       // so these methods won&#39;t be used anymore.
1770       if (bci &gt;= 0) {
1771         break;
1772       }
1773     } else {
1774       // This one is a keeper.
1775       prev_bp = bp;
1776     }
1777   }
1778 }
1779 
1780 void Method::clear_breakpoint(int bci) {
1781   assert(bci &gt;= 0, &quot;&quot;);
1782   clear_matches(this, bci);
1783 }
1784 
1785 void Method::clear_all_breakpoints() {
1786   clear_matches(this, -1);
1787 }
1788 
1789 #endif // INCLUDE_JVMTI
1790 
1791 int Method::invocation_count() {
1792   MethodCounters *mcs = method_counters();
1793   if (TieredCompilation) {
1794     MethodData* const mdo = method_data();
1795     if (((mcs != NULL) ? mcs-&gt;invocation_counter()-&gt;carry() : false) ||
1796         ((mdo != NULL) ? mdo-&gt;invocation_counter()-&gt;carry() : false)) {
1797       return InvocationCounter::count_limit;
1798     } else {
1799       return ((mcs != NULL) ? mcs-&gt;invocation_counter()-&gt;count() : 0) +
1800              ((mdo != NULL) ? mdo-&gt;invocation_counter()-&gt;count() : 0);
1801     }
1802   } else {
1803     return (mcs == NULL) ? 0 : mcs-&gt;invocation_counter()-&gt;count();
1804   }
1805 }
1806 
1807 int Method::backedge_count() {
1808   MethodCounters *mcs = method_counters();
1809   if (TieredCompilation) {
1810     MethodData* const mdo = method_data();
1811     if (((mcs != NULL) ? mcs-&gt;backedge_counter()-&gt;carry() : false) ||
1812         ((mdo != NULL) ? mdo-&gt;backedge_counter()-&gt;carry() : false)) {
1813       return InvocationCounter::count_limit;
1814     } else {
1815       return ((mcs != NULL) ? mcs-&gt;backedge_counter()-&gt;count() : 0) +
1816              ((mdo != NULL) ? mdo-&gt;backedge_counter()-&gt;count() : 0);
1817     }
1818   } else {
1819     return (mcs == NULL) ? 0 : mcs-&gt;backedge_counter()-&gt;count();
1820   }
1821 }
1822 
1823 int Method::highest_comp_level() const {
1824   const MethodCounters* mcs = method_counters();
1825   if (mcs != NULL) {
1826     return mcs-&gt;highest_comp_level();
1827   } else {
1828     return CompLevel_none;
1829   }
1830 }
1831 
1832 int Method::highest_osr_comp_level() const {
1833   const MethodCounters* mcs = method_counters();
1834   if (mcs != NULL) {
1835     return mcs-&gt;highest_osr_comp_level();
1836   } else {
1837     return CompLevel_none;
1838   }
1839 }
1840 
1841 void Method::set_highest_comp_level(int level) {
1842   MethodCounters* mcs = method_counters();
1843   if (mcs != NULL) {
1844     mcs-&gt;set_highest_comp_level(level);
1845   }
1846 }
1847 
1848 void Method::set_highest_osr_comp_level(int level) {
1849   MethodCounters* mcs = method_counters();
1850   if (mcs != NULL) {
1851     mcs-&gt;set_highest_osr_comp_level(level);
1852   }
1853 }
1854 
1855 #if INCLUDE_JVMTI
1856 
1857 BreakpointInfo::BreakpointInfo(Method* m, int bci) {
1858   _bci = bci;
1859   _name_index = m-&gt;name_index();
1860   _signature_index = m-&gt;signature_index();
1861   _orig_bytecode = (Bytecodes::Code) *m-&gt;bcp_from(_bci);
1862   if (_orig_bytecode == Bytecodes::_breakpoint)
1863     _orig_bytecode = m-&gt;orig_bytecode_at(_bci);
1864   _next = NULL;
1865 }
1866 
1867 void BreakpointInfo::set(Method* method) {
1868 #ifdef ASSERT
1869   {
1870     Bytecodes::Code code = (Bytecodes::Code) *method-&gt;bcp_from(_bci);
1871     if (code == Bytecodes::_breakpoint)
1872       code = method-&gt;orig_bytecode_at(_bci);
1873     assert(orig_bytecode() == code, &quot;original bytecode must be the same&quot;);
1874   }
1875 #endif
1876   Thread *thread = Thread::current();
1877   *method-&gt;bcp_from(_bci) = Bytecodes::_breakpoint;
1878   method-&gt;incr_number_of_breakpoints(thread);
1879   SystemDictionary::notice_modification();
1880   {
1881     // Deoptimize all dependents on this method
1882     HandleMark hm(thread);
1883     methodHandle mh(thread, method);
1884     CodeCache::flush_dependents_on_method(mh);
1885   }
1886 }
1887 
1888 void BreakpointInfo::clear(Method* method) {
1889   *method-&gt;bcp_from(_bci) = orig_bytecode();
1890   assert(method-&gt;number_of_breakpoints() &gt; 0, &quot;must not go negative&quot;);
1891   method-&gt;decr_number_of_breakpoints(Thread::current());
1892 }
1893 
1894 #endif // INCLUDE_JVMTI
1895 
1896 // jmethodID handling
1897 
1898 // This is a block allocating object, sort of like JNIHandleBlock, only a
1899 // lot simpler.
1900 // It&#39;s allocated on the CHeap because once we allocate a jmethodID, we can
1901 // never get rid of it.
1902 
1903 static const int min_block_size = 8;
1904 
1905 class JNIMethodBlockNode : public CHeapObj&lt;mtClass&gt; {
1906   friend class JNIMethodBlock;
1907   Method**        _methods;
1908   int             _number_of_methods;
1909   int             _top;
1910   JNIMethodBlockNode* _next;
1911 
1912  public:
1913 
1914   JNIMethodBlockNode(int num_methods = min_block_size);
1915 
1916   ~JNIMethodBlockNode() { FREE_C_HEAP_ARRAY(Method*, _methods); }
1917 
1918   void ensure_methods(int num_addl_methods) {
1919     if (_top &lt; _number_of_methods) {
1920       num_addl_methods -= _number_of_methods - _top;
1921       if (num_addl_methods &lt;= 0) {
1922         return;
1923       }
1924     }
1925     if (_next == NULL) {
1926       _next = new JNIMethodBlockNode(MAX2(num_addl_methods, min_block_size));
1927     } else {
1928       _next-&gt;ensure_methods(num_addl_methods);
1929     }
1930   }
1931 };
1932 
1933 class JNIMethodBlock : public CHeapObj&lt;mtClass&gt; {
1934   JNIMethodBlockNode _head;
1935   JNIMethodBlockNode *_last_free;
1936  public:
1937   static Method* const _free_method;
1938 
1939   JNIMethodBlock(int initial_capacity = min_block_size)
1940       : _head(initial_capacity), _last_free(&amp;_head) {}
1941 
1942   void ensure_methods(int num_addl_methods) {
1943     _last_free-&gt;ensure_methods(num_addl_methods);
1944   }
1945 
1946   Method** add_method(Method* m) {
1947     for (JNIMethodBlockNode* b = _last_free; b != NULL; b = b-&gt;_next) {
1948       if (b-&gt;_top &lt; b-&gt;_number_of_methods) {
1949         // top points to the next free entry.
1950         int i = b-&gt;_top;
1951         b-&gt;_methods[i] = m;
1952         b-&gt;_top++;
1953         _last_free = b;
1954         return &amp;(b-&gt;_methods[i]);
1955       } else if (b-&gt;_top == b-&gt;_number_of_methods) {
1956         // if the next free entry ran off the block see if there&#39;s a free entry
1957         for (int i = 0; i &lt; b-&gt;_number_of_methods; i++) {
1958           if (b-&gt;_methods[i] == _free_method) {
1959             b-&gt;_methods[i] = m;
1960             _last_free = b;
1961             return &amp;(b-&gt;_methods[i]);
1962           }
1963         }
1964         // Only check each block once for frees.  They&#39;re very unlikely.
1965         // Increment top past the end of the block.
1966         b-&gt;_top++;
1967       }
1968       // need to allocate a next block.
1969       if (b-&gt;_next == NULL) {
1970         b-&gt;_next = _last_free = new JNIMethodBlockNode();
1971       }
1972     }
1973     guarantee(false, &quot;Should always allocate a free block&quot;);
1974     return NULL;
1975   }
1976 
1977   bool contains(Method** m) {
1978     if (m == NULL) return false;
1979     for (JNIMethodBlockNode* b = &amp;_head; b != NULL; b = b-&gt;_next) {
1980       if (b-&gt;_methods &lt;= m &amp;&amp; m &lt; b-&gt;_methods + b-&gt;_number_of_methods) {
1981         // This is a bit of extra checking, for two reasons.  One is
1982         // that contains() deals with pointers that are passed in by
1983         // JNI code, so making sure that the pointer is aligned
1984         // correctly is valuable.  The other is that &lt;= and &gt; are
1985         // technically not defined on pointers, so the if guard can
1986         // pass spuriously; no modern compiler is likely to make that
1987         // a problem, though (and if one did, the guard could also
1988         // fail spuriously, which would be bad).
1989         ptrdiff_t idx = m - b-&gt;_methods;
1990         if (b-&gt;_methods + idx == m) {
1991           return true;
1992         }
1993       }
1994     }
1995     return false;  // not found
1996   }
1997 
1998   // Doesn&#39;t really destroy it, just marks it as free so it can be reused.
1999   void destroy_method(Method** m) {
2000 #ifdef ASSERT
2001     assert(contains(m), &quot;should be a methodID&quot;);
2002 #endif // ASSERT
2003     *m = _free_method;
2004   }
2005 
2006   // During class unloading the methods are cleared, which is different
2007   // than freed.
2008   void clear_all_methods() {
2009     for (JNIMethodBlockNode* b = &amp;_head; b != NULL; b = b-&gt;_next) {
2010       for (int i = 0; i&lt; b-&gt;_number_of_methods; i++) {
2011         b-&gt;_methods[i] = NULL;
2012       }
2013     }
2014   }
2015 #ifndef PRODUCT
2016   int count_methods() {
2017     // count all allocated methods
2018     int count = 0;
2019     for (JNIMethodBlockNode* b = &amp;_head; b != NULL; b = b-&gt;_next) {
2020       for (int i = 0; i&lt; b-&gt;_number_of_methods; i++) {
2021         if (b-&gt;_methods[i] != _free_method) count++;
2022       }
2023     }
2024     return count;
2025   }
2026 #endif // PRODUCT
2027 };
2028 
2029 // Something that can&#39;t be mistaken for an address or a markOop
2030 Method* const JNIMethodBlock::_free_method = (Method*)55;
2031 
2032 JNIMethodBlockNode::JNIMethodBlockNode(int num_methods) : _top(0), _next(NULL) {
2033   _number_of_methods = MAX2(num_methods, min_block_size);
2034   _methods = NEW_C_HEAP_ARRAY(Method*, _number_of_methods, mtInternal);
2035   for (int i = 0; i &lt; _number_of_methods; i++) {
2036     _methods[i] = JNIMethodBlock::_free_method;
2037   }
2038 }
2039 
2040 void Method::ensure_jmethod_ids(ClassLoaderData* loader_data, int capacity) {
2041   ClassLoaderData* cld = loader_data;
2042   if (!SafepointSynchronize::is_at_safepoint()) {
2043     // Have to add jmethod_ids() to class loader data thread-safely.
2044     // Also have to add the method to the list safely, which the cld lock
2045     // protects as well.
2046     MutexLockerEx ml(cld-&gt;metaspace_lock(),  Mutex::_no_safepoint_check_flag);
2047     if (cld-&gt;jmethod_ids() == NULL) {
2048       cld-&gt;set_jmethod_ids(new JNIMethodBlock(capacity));
2049     } else {
2050       cld-&gt;jmethod_ids()-&gt;ensure_methods(capacity);
2051     }
2052   } else {
2053     // At safepoint, we are single threaded and can set this.
2054     if (cld-&gt;jmethod_ids() == NULL) {
2055       cld-&gt;set_jmethod_ids(new JNIMethodBlock(capacity));
2056     } else {
2057       cld-&gt;jmethod_ids()-&gt;ensure_methods(capacity);
2058     }
2059   }
2060 }
2061 
2062 // Add a method id to the jmethod_ids
2063 jmethodID Method::make_jmethod_id(ClassLoaderData* loader_data, Method* m) {
2064   ClassLoaderData* cld = loader_data;
2065 
2066   if (!SafepointSynchronize::is_at_safepoint()) {
2067     // Have to add jmethod_ids() to class loader data thread-safely.
2068     // Also have to add the method to the list safely, which the cld lock
2069     // protects as well.
2070     MutexLockerEx ml(cld-&gt;metaspace_lock(),  Mutex::_no_safepoint_check_flag);
2071     if (cld-&gt;jmethod_ids() == NULL) {
2072       cld-&gt;set_jmethod_ids(new JNIMethodBlock());
2073     }
2074     // jmethodID is a pointer to Method*
2075     return (jmethodID)cld-&gt;jmethod_ids()-&gt;add_method(m);
2076   } else {
2077     // At safepoint, we are single threaded and can set this.
2078     if (cld-&gt;jmethod_ids() == NULL) {
2079       cld-&gt;set_jmethod_ids(new JNIMethodBlock());
2080     }
2081     // jmethodID is a pointer to Method*
2082     return (jmethodID)cld-&gt;jmethod_ids()-&gt;add_method(m);
2083   }
2084 }
2085 
2086 // Mark a jmethodID as free.  This is called when there is a data race in
2087 // InstanceKlass while creating the jmethodID cache.
2088 void Method::destroy_jmethod_id(ClassLoaderData* loader_data, jmethodID m) {
2089   ClassLoaderData* cld = loader_data;
2090   Method** ptr = (Method**)m;
2091   assert(cld-&gt;jmethod_ids() != NULL, &quot;should have method handles&quot;);
2092   cld-&gt;jmethod_ids()-&gt;destroy_method(ptr);
2093 }
2094 
2095 void Method::change_method_associated_with_jmethod_id(jmethodID jmid, Method* new_method) {
2096   // Can&#39;t assert the method_holder is the same because the new method has the
2097   // scratch method holder.
2098   assert(resolve_jmethod_id(jmid)-&gt;method_holder()-&gt;class_loader()
2099            == new_method-&gt;method_holder()-&gt;class_loader() ||
2100            new_method-&gt;method_holder()-&gt;class_loader() == NULL, // allow Unsafe substitution
2101          &quot;changing to a different class loader&quot;);
2102   // Just change the method in place, jmethodID pointer doesn&#39;t change.
2103   *((Method**)jmid) = new_method;
2104 }
2105 
2106 bool Method::is_method_id(jmethodID mid) {
2107   Method* m = resolve_jmethod_id(mid);
2108   assert(m != NULL, &quot;should be called with non-null method&quot;);
2109   InstanceKlass* ik = m-&gt;method_holder();
2110   ClassLoaderData* cld = ik-&gt;class_loader_data();
2111   if (cld-&gt;jmethod_ids() == NULL) return false;
2112   return (cld-&gt;jmethod_ids()-&gt;contains((Method**)mid));
2113 }
2114 
2115 Method* Method::checked_resolve_jmethod_id(jmethodID mid) {
2116   if (mid == NULL) return NULL;
2117   Method* o = resolve_jmethod_id(mid);
2118   if (o == NULL || o == JNIMethodBlock::_free_method || !((Metadata*)o)-&gt;is_method()) {
2119     return NULL;
2120   }
2121   return o;
2122 };
2123 
2124 void Method::set_on_stack(const bool value) {
2125   // Set both the method itself and its constant pool.  The constant pool
2126   // on stack means some method referring to it is also on the stack.
2127   constants()-&gt;set_on_stack(value);
2128 
2129   bool already_set = on_stack();
2130   _access_flags.set_on_stack(value);
2131   if (value &amp;&amp; !already_set) {
2132     MetadataOnStackMark::record(this);
2133   }
2134   assert(!value || !is_old() || is_obsolete() || is_running_emcp(),
2135          &quot;emcp methods cannot run after emcp bit is cleared&quot;);
2136 }
2137 
2138 // Called when the class loader is unloaded to make all methods weak.
2139 void Method::clear_jmethod_ids(ClassLoaderData* loader_data) {
2140   loader_data-&gt;jmethod_ids()-&gt;clear_all_methods();
2141 }
2142 
2143 bool Method::has_method_vptr(const void* ptr) {
2144   Method m;
2145   // This assumes that the vtbl pointer is the first word of a C++ object.
2146   return dereference_vptr(&amp;m) == dereference_vptr(ptr);
2147 }
2148 
2149 // Check that this pointer is valid by checking that the vtbl pointer matches
2150 bool Method::is_valid_method(const Method* m) {
2151   if (m == NULL) {
2152     return false;
2153   } else if ((intptr_t(m) &amp; (wordSize-1)) != 0) {
2154     // Quick sanity check on pointer.
2155     return false;
2156   } else if (m-&gt;is_shared()) {
2157     return MetaspaceShared::is_valid_shared_method(m);
2158   } else if (Metaspace::contains_non_shared(m)) {
2159     return has_method_vptr((const void*)m);
2160   } else {
2161     return false;
2162   }
2163 }
2164 
2165 #ifndef PRODUCT
2166 void Method::print_jmethod_ids(const ClassLoaderData* loader_data, outputStream* out) {
2167   out-&gt;print(&quot; jni_method_id count = %d&quot;, loader_data-&gt;jmethod_ids()-&gt;count_methods());
2168 }
2169 #endif // PRODUCT
2170 
2171 
2172 // Printing
2173 
2174 #ifndef PRODUCT
2175 
2176 void Method::print_on(outputStream* st) const {
2177   ResourceMark rm;
2178   assert(is_method(), &quot;must be method&quot;);
2179   st-&gt;print_cr(&quot;%s&quot;, internal_name());
2180   st-&gt;print_cr(&quot; - this oop:          &quot; INTPTR_FORMAT, p2i(this));
2181   st-&gt;print   (&quot; - method holder:     &quot;); method_holder()-&gt;print_value_on(st); st-&gt;cr();
2182   st-&gt;print   (&quot; - constants:         &quot; INTPTR_FORMAT &quot; &quot;, p2i(constants()));
2183   constants()-&gt;print_value_on(st); st-&gt;cr();
2184   st-&gt;print   (&quot; - access:            0x%x  &quot;, access_flags().as_int()); access_flags().print_on(st); st-&gt;cr();
2185   st-&gt;print   (&quot; - name:              &quot;);    name()-&gt;print_value_on(st); st-&gt;cr();
2186   st-&gt;print   (&quot; - signature:         &quot;);    signature()-&gt;print_value_on(st); st-&gt;cr();
2187   st-&gt;print_cr(&quot; - max stack:         %d&quot;,   max_stack());
2188   st-&gt;print_cr(&quot; - max locals:        %d&quot;,   max_locals());
2189   st-&gt;print_cr(&quot; - size of params:    %d&quot;,   size_of_parameters());
2190   st-&gt;print_cr(&quot; - method size:       %d&quot;,   method_size());
2191   if (intrinsic_id() != vmIntrinsics::_none)
2192     st-&gt;print_cr(&quot; - intrinsic id:      %d %s&quot;, intrinsic_id(), vmIntrinsics::name_at(intrinsic_id()));
2193   if (highest_comp_level() != CompLevel_none)
2194     st-&gt;print_cr(&quot; - highest level:     %d&quot;, highest_comp_level());
2195   st-&gt;print_cr(&quot; - vtable index:      %d&quot;,   _vtable_index);
2196   st-&gt;print_cr(&quot; - i2i entry:         &quot; INTPTR_FORMAT, p2i(interpreter_entry()));
2197   st-&gt;print(   &quot; - adapters:          &quot;);
2198   AdapterHandlerEntry* a = ((Method*)this)-&gt;adapter();
2199   if (a == NULL)
2200     st-&gt;print_cr(INTPTR_FORMAT, p2i(a));
2201   else
2202     a-&gt;print_adapter_on(st);
2203   st-&gt;print_cr(&quot; - compiled entry     &quot; INTPTR_FORMAT, p2i(from_compiled_entry()));
2204   st-&gt;print_cr(&quot; - code size:         %d&quot;,   code_size());
2205   if (code_size() != 0) {
2206     st-&gt;print_cr(&quot; - code start:        &quot; INTPTR_FORMAT, p2i(code_base()));
2207     st-&gt;print_cr(&quot; - code end (excl):   &quot; INTPTR_FORMAT, p2i(code_base() + code_size()));
2208   }
2209   if (method_data() != NULL) {
2210     st-&gt;print_cr(&quot; - method data:       &quot; INTPTR_FORMAT, p2i(method_data()));
2211   }
2212   st-&gt;print_cr(&quot; - checked ex length: %d&quot;,   checked_exceptions_length());
2213   if (checked_exceptions_length() &gt; 0) {
2214     CheckedExceptionElement* table = checked_exceptions_start();
2215     st-&gt;print_cr(&quot; - checked ex start:  &quot; INTPTR_FORMAT, p2i(table));
2216     if (Verbose) {
2217       for (int i = 0; i &lt; checked_exceptions_length(); i++) {
2218         st-&gt;print_cr(&quot;   - throws %s&quot;, constants()-&gt;printable_name_at(table[i].class_cp_index));
2219       }
2220     }
2221   }
2222   if (has_linenumber_table()) {
2223     u_char* table = compressed_linenumber_table();
2224     st-&gt;print_cr(&quot; - linenumber start:  &quot; INTPTR_FORMAT, p2i(table));
2225     if (Verbose) {
2226       CompressedLineNumberReadStream stream(table);
2227       while (stream.read_pair()) {
2228         st-&gt;print_cr(&quot;   - line %d: %d&quot;, stream.line(), stream.bci());
2229       }
2230     }
2231   }
2232   st-&gt;print_cr(&quot; - localvar length:   %d&quot;,   localvariable_table_length());
2233   if (localvariable_table_length() &gt; 0) {
2234     LocalVariableTableElement* table = localvariable_table_start();
2235     st-&gt;print_cr(&quot; - localvar start:    &quot; INTPTR_FORMAT, p2i(table));
2236     if (Verbose) {
2237       for (int i = 0; i &lt; localvariable_table_length(); i++) {
2238         int bci = table[i].start_bci;
2239         int len = table[i].length;
2240         const char* name = constants()-&gt;printable_name_at(table[i].name_cp_index);
2241         const char* desc = constants()-&gt;printable_name_at(table[i].descriptor_cp_index);
2242         int slot = table[i].slot;
2243         st-&gt;print_cr(&quot;   - %s %s bci=%d len=%d slot=%d&quot;, desc, name, bci, len, slot);
2244       }
2245     }
2246   }
2247   if (code() != NULL) {
2248     st-&gt;print   (&quot; - compiled code: &quot;);
2249     code()-&gt;print_value_on(st);
2250   }
2251   if (is_native()) {
2252     st-&gt;print_cr(&quot; - native function:   &quot; INTPTR_FORMAT, p2i(native_function()));
2253     st-&gt;print_cr(&quot; - signature handler: &quot; INTPTR_FORMAT, p2i(signature_handler()));
2254   }
2255 }
2256 
2257 void Method::print_linkage_flags(outputStream* st) {
2258   access_flags().print_on(st);
2259   if (is_default_method()) {
2260     st-&gt;print(&quot;default &quot;);
2261   }
2262   if (is_overpass()) {
2263     st-&gt;print(&quot;overpass &quot;);
2264   }
2265 }
2266 #endif //PRODUCT
2267 
2268 void Method::print_value_on(outputStream* st) const {
2269   assert(is_method(), &quot;must be method&quot;);
2270   st-&gt;print(&quot;%s&quot;, internal_name());
2271   print_address_on(st);
2272   st-&gt;print(&quot; &quot;);
2273   name()-&gt;print_value_on(st);
2274   st-&gt;print(&quot; &quot;);
2275   signature()-&gt;print_value_on(st);
2276   st-&gt;print(&quot; in &quot;);
2277   method_holder()-&gt;print_value_on(st);
2278   if (WizardMode) st-&gt;print(&quot;#%d&quot;, _vtable_index);
2279   if (WizardMode) st-&gt;print(&quot;[%d,%d]&quot;, size_of_parameters(), max_locals());
2280   if (WizardMode &amp;&amp; code() != NULL) st-&gt;print(&quot; ((nmethod*)%p)&quot;, code());
2281 }
2282 
2283 #if INCLUDE_SERVICES
2284 // Size Statistics
2285 void Method::collect_statistics(KlassSizeStats *sz) const {
2286   int mysize = sz-&gt;count(this);
2287   sz-&gt;_method_bytes += mysize;
2288   sz-&gt;_method_all_bytes += mysize;
2289   sz-&gt;_rw_bytes += mysize;
2290 
2291   if (constMethod()) {
2292     constMethod()-&gt;collect_statistics(sz);
2293   }
2294   if (method_data()) {
2295     method_data()-&gt;collect_statistics(sz);
2296   }
2297 }
2298 #endif // INCLUDE_SERVICES
2299 
2300 // LogTouchedMethods and PrintTouchedMethods
2301 
2302 // TouchedMethodRecord -- we can&#39;t use a HashtableEntry&lt;Method*&gt; because
2303 // the Method may be garbage collected. Let&#39;s roll our own hash table.
2304 class TouchedMethodRecord : CHeapObj&lt;mtTracing&gt; {
2305 public:
2306   // It&#39;s OK to store Symbols here because they will NOT be GC&#39;ed if
2307   // LogTouchedMethods is enabled.
2308   TouchedMethodRecord* _next;
2309   Symbol* _class_name;
2310   Symbol* _method_name;
2311   Symbol* _method_signature;
2312 };
2313 
2314 static const int TOUCHED_METHOD_TABLE_SIZE = 20011;
2315 static TouchedMethodRecord** _touched_method_table = NULL;
2316 
2317 void Method::log_touched(TRAPS) {
2318 
2319   const int table_size = TOUCHED_METHOD_TABLE_SIZE;
2320   Symbol* my_class = klass_name();
2321   Symbol* my_name  = name();
2322   Symbol* my_sig   = signature();
2323 
2324   unsigned int hash = my_class-&gt;identity_hash() +
2325                       my_name-&gt;identity_hash() +
2326                       my_sig-&gt;identity_hash();
2327   juint index = juint(hash) % table_size;
2328 
2329   MutexLocker ml(TouchedMethodLog_lock, THREAD);
2330   if (_touched_method_table == NULL) {
2331     _touched_method_table = NEW_C_HEAP_ARRAY2(TouchedMethodRecord*, table_size,
2332                                               mtTracing, CURRENT_PC);
2333     memset(_touched_method_table, 0, sizeof(TouchedMethodRecord*)*table_size);
2334   }
2335 
2336   TouchedMethodRecord* ptr = _touched_method_table[index];
2337   while (ptr) {
2338     if (ptr-&gt;_class_name       == my_class &amp;&amp;
2339         ptr-&gt;_method_name      == my_name &amp;&amp;
2340         ptr-&gt;_method_signature == my_sig) {
2341       return;
2342     }
2343     if (ptr-&gt;_next == NULL) break;
2344     ptr = ptr-&gt;_next;
2345   }
2346   TouchedMethodRecord* nptr = NEW_C_HEAP_OBJ(TouchedMethodRecord, mtTracing);
2347   my_class-&gt;increment_refcount();
2348   my_name-&gt;increment_refcount();
2349   my_sig-&gt;increment_refcount();
2350   nptr-&gt;_class_name         = my_class;
2351   nptr-&gt;_method_name        = my_name;
2352   nptr-&gt;_method_signature   = my_sig;
2353   nptr-&gt;_next               = NULL;
2354 
2355   if (ptr == NULL) {
2356     // first
2357     _touched_method_table[index] = nptr;
2358   } else {
2359     ptr-&gt;_next = nptr;
2360   }
2361 }
2362 
2363 void Method::print_touched_methods(outputStream* out) {
2364   MutexLockerEx ml(Thread::current()-&gt;is_VM_thread() ? NULL : TouchedMethodLog_lock);
2365   out-&gt;print_cr(&quot;# Method::print_touched_methods version 1&quot;);
2366   if (_touched_method_table) {
2367     for (int i = 0; i &lt; TOUCHED_METHOD_TABLE_SIZE; i++) {
2368       TouchedMethodRecord* ptr = _touched_method_table[i];
2369       while(ptr) {
2370         ptr-&gt;_class_name-&gt;print_symbol_on(out);       out-&gt;print(&quot;.&quot;);
2371         ptr-&gt;_method_name-&gt;print_symbol_on(out);      out-&gt;print(&quot;:&quot;);
2372         ptr-&gt;_method_signature-&gt;print_symbol_on(out); out-&gt;cr();
2373         ptr = ptr-&gt;_next;
2374       }
2375     }
2376   }
2377 }
2378 
2379 // Verification
2380 
2381 void Method::verify_on(outputStream* st) {
2382   guarantee(is_method(), &quot;object must be method&quot;);
2383   guarantee(constants()-&gt;is_constantPool(), &quot;should be constant pool&quot;);
2384   MethodData* md = method_data();
2385   guarantee(md == NULL ||
2386       md-&gt;is_methodData(), &quot;should be method data&quot;);
2387 }
    </pre>
  </body>
</html>